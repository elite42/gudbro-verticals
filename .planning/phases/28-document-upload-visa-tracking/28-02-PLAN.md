---
phase: 28-document-upload-visa-tracking
plan: 02
type: execute
wave: 2
depends_on: ['28-01']
files_modified:
  - apps/accommodations/frontend/lib/image-utils.ts
  - apps/accommodations/frontend/types/heic2any.d.ts
  - apps/accommodations/frontend/components/stay/DocumentConsent.tsx
  - apps/accommodations/frontend/components/stay/DocumentUpload.tsx
  - apps/accommodations/frontend/components/stay/VisaExpiryAlert.tsx
  - apps/accommodations/frontend/components/stay/VisaStatusCard.tsx
  - apps/accommodations/frontend/app/stay/room/[roomCode]/page.tsx
  - apps/accommodations/frontend/app/stay/[code]/page.tsx
  - apps/accommodations/frontend/package.json
  - apps/backoffice/app/(dashboard)/accommodations/documents/page.tsx
  - apps/backoffice/app/(dashboard)/accommodations/bookings/[id]/page.tsx
autonomous: false

must_haves:
  truths:
    - "Verified guest can tap 'Upload Document' and take a photo with camera (mobile) or select from gallery"
    - 'HEIC photos from iPhone are auto-converted to JPEG before upload'
    - 'Blurry photos show a warning with retake suggestion (blur detection via Laplacian variance)'
    - 'Guest must check GDPR consent checkbox before upload button becomes active'
    - 'Guest can upload a visa page with a manually entered expiry date'
    - 'Dashboard shows dismissable visa expiry progress bar (green/yellow/red) based on uploaded visa'
    - 'When visa expires during stay, alert becomes red and non-dismissable'
    - 'Owner sees per-guest document list in booking detail page'
    - 'Owner sees urgency-sorted document dashboard with all guests approaching visa expiry'
    - "Owner can download documents via signed URL and mark them as 'Registered with authorities'"
  artifacts:
    - path: 'apps/accommodations/frontend/lib/image-utils.ts'
      provides: 'HEIC conversion + compression + blur detection pipeline'
      contains: 'processDocumentImage'
    - path: 'apps/accommodations/frontend/components/stay/DocumentConsent.tsx'
      provides: 'GDPR consent checkbox with multi-language disclaimer'
      contains: 'DocumentConsent'
    - path: 'apps/accommodations/frontend/components/stay/DocumentUpload.tsx'
      provides: 'Camera/gallery input + image processing + upload flow'
      contains: 'DocumentUpload'
    - path: 'apps/accommodations/frontend/components/stay/VisaExpiryAlert.tsx'
      provides: 'Dismissable progress bar with color progression'
      contains: 'VisaExpiryAlert'
    - path: 'apps/backoffice/app/(dashboard)/accommodations/documents/page.tsx'
      provides: 'Owner document urgency dashboard'
      contains: 'DocumentsDashboard'
  key_links:
    - from: 'apps/accommodations/frontend/components/stay/DocumentUpload.tsx'
      to: 'apps/accommodations/frontend/lib/image-utils.ts'
      via: 'processDocumentImage() called before upload'
      pattern: 'processDocumentImage'
    - from: 'apps/accommodations/frontend/components/stay/DocumentUpload.tsx'
      to: 'apps/accommodations/frontend/lib/stay-api.ts'
      via: 'requestDocumentUploadUrl + uploadToSignedUrl + confirmDocumentUpload'
      pattern: 'requestDocumentUploadUrl'
    - from: 'apps/accommodations/frontend/app/stay/room/[roomCode]/page.tsx'
      to: 'apps/accommodations/frontend/components/stay/VisaExpiryAlert.tsx'
      via: 'rendered above WiFi card when visa document exists'
      pattern: 'VisaExpiryAlert'
---

<objective>
Build the guest-facing document upload UI (camera capture, HEIC conversion, compression, blur detection, GDPR consent) and the owner backoffice document viewer with urgency dashboard.

Purpose: Complete the user-facing experience for Phase 28 — guests can upload documents from the in-stay dashboard, see visa expiry tracking, and owners can manage/download documents from the backoffice.

Output:

- Image processing utility (HEIC + compression + blur detection)
- 3 guest-facing components (DocumentConsent, DocumentUpload, VisaExpiryAlert)
- Updated room dashboard and booking dashboard pages to integrate documents
- Owner backoffice: document urgency dashboard + per-guest document section in booking detail
- heic2any and browser-image-compression installed as dependencies
  </objective>

<execution_context>
@/Users/gianfrancodagostino/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gianfrancodagostino/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/28-document-upload-visa-tracking/28-CONTEXT.md
@.planning/phases/28-document-upload-visa-tracking/28-RESEARCH.md
@.planning/phases/28-document-upload-visa-tracking/28-01-SUMMARY.md
@apps/accommodations/frontend/lib/auth.ts
@apps/accommodations/frontend/lib/stay-api.ts
@apps/accommodations/frontend/types/stay.ts
@apps/accommodations/frontend/components/stay/VisaStatusCard.tsx
@apps/accommodations/frontend/app/stay/room/[roomCode]/page.tsx
@apps/accommodations/frontend/app/stay/[code]/page.tsx
@apps/backoffice/app/(dashboard)/accommodations/bookings/[id]/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Image utils + dependencies + guest upload components</name>
  <files>
    apps/accommodations/frontend/package.json
    apps/accommodations/frontend/lib/image-utils.ts
    apps/accommodations/frontend/types/heic2any.d.ts
    apps/accommodations/frontend/components/stay/DocumentConsent.tsx
    apps/accommodations/frontend/components/stay/DocumentUpload.tsx
    apps/accommodations/frontend/components/stay/VisaExpiryAlert.tsx
    apps/accommodations/frontend/components/stay/VisaStatusCard.tsx
  </files>
  <action>
  **1. Install dependencies:**
  ```bash
  cd apps/accommodations/frontend && pnpm add browser-image-compression heic2any
  ```

**2. Create `types/heic2any.d.ts`:**
Type declaration for heic2any (no bundled types):

```typescript
declare module 'heic2any' {
  interface Options {
    blob: Blob;
    toType?: string;
    quality?: number;
    multiple?: boolean;
  }
  export default function heic2any(options: Options): Promise<Blob | Blob[]>;
}
```

**3. Create `lib/image-utils.ts`:**
Export `processDocumentImage(file: File)` that returns `Promise<{ blob: Blob; isBlurry: boolean; blurScore: number }>`:

- Step 1: HEIC detection — check `file.type === 'image/heic'` OR `file.name.toLowerCase().endsWith('.heic')` OR `.heif`. If HEIC, dynamically import heic2any and convert to JPEG at quality 0.85.
- Step 2: Compress — dynamically import browser-image-compression. Options: maxSizeMB: 0.5, maxWidthOrHeight: 2048, useWebWorker: true, preserveExif: false (strip GPS/EXIF data for privacy).
- Step 3: Blur detection — implement `detectBlur(file: Blob): Promise<number>` using canvas Laplacian variance (as in 28-RESEARCH.md). Scale image to max 300px for fast processing. Return variance score.
- Thresholds: score < 100 = blurry (warn), 100-500 = acceptable, > 500 = sharp.
- Export `hashConsentText(text: string): string` — simple hash function for GDPR consent version tracking. Returns `v1-{base36hash}`.

**4. Create `components/stay/DocumentConsent.tsx`:**
Props: `{ onConsent: (hash: string) => void; language?: string; isChecked: boolean; onCheckChange: (checked: boolean) => void }`

- Checkbox with consent text: "I consent to the processing of my passport/visa documents for temporary residence registration with local authorities."
- Below checkbox: expandable disclaimer (click "Learn more" to reveal): what data, why (legal obligation), who sees it (property owner), retention period, right to deletion
- When checkbox is checked, call onConsent with hashConsentText of the consent text
- Use accommodations design system colors: bg-white, border-[#E8E2D9], text-[#2D2016], accent-[#3D8B87]
- Consent text hardcoded in English for v1 (multi-language is a future enhancement)

**5. Create `components/stay/DocumentUpload.tsx`:**
Props: `{ bookingCode: string; token: string; onUploadComplete: () => void; existingDocuments: GuestDocument[] }`

- State: uploadStep ('idle' | 'consent' | 'capture' | 'processing' | 'preview' | 'details' | 'uploading' | 'done' | 'error')
- Flow:
  1. Show document type selector: "Passport" / "Visa" cards with icons (Passport from Phosphor, IdentificationCard for visa)
  2. If no consent given yet → show DocumentConsent component. Once consented, proceed.
  3. Camera/gallery input: mobile = camera primary + gallery fallback; desktop = file picker only. Detect mobile via userAgent.
  4. After file selected → set 'processing' state, call processDocumentImage()
  5. If blurry → show warning "Photo appears blurry. For best results, hold your phone steady and ensure good lighting." with "Retake" and "Use Anyway" buttons
  6. Show preview of processed image
  7. If visa: show date picker for visa_expiry_date (use native `<input type="date">`)
  8. "Upload" button → call requestDocumentUploadUrl, then upload to signed URL using fetch PUT, then confirmDocumentUpload
  9. Show success state with checkmark
  10. Error handling: show error message with "Try Again" button
- If guest already has a passport uploaded (from existingDocuments), show "Passport on file" with green checkmark, only allow visa upload or passport re-upload
- Use Phosphor Icons: Camera, FileImage, Check, Warning, Passport (or IdentificationBadge), ArrowCounterClockwise

**6. Create `components/stay/VisaExpiryAlert.tsx`:**
Props: `{ visaExpiryDate: string; checkOutDate: string; onDismiss?: () => void }`

- Calculate days remaining: differenceInCalendarDays(visaExpiry, today)
- Calculate total days of stay: differenceInCalendarDays(visaExpiry, checkIn) — use stay check-in as baseline
- Progress bar: width = (daysRemaining / totalDays) \* 100
- Colors: > 14d = emerald-500 (green), 7-14d = amber-500 (yellow), < 7d = red-500
- Text: "{daysRemaining} days until visa expiry" / "Visa expired" if <= 0
- Dismissable: X button in top-right that calls onDismiss. Use localStorage `dismissed-visa-alert-{date}` to persist dismissal per day
- Non-dismissable when expired: hide X button, add red border, show "Visa expired — contact your host" prominently
- Design: rounded-2xl border border-[#E8E2D9] bg-white p-4 shadow-sm (matches VisaStatusCard)

**7. Update `components/stay/VisaStatusCard.tsx`:**

- Add optional prop: `uploadedVisaExpiry?: string | null`
- When uploadedVisaExpiry is provided, use that date instead of the estimated visa-free exemption calculation
- This allows the card to switch from "estimated" to "actual" once the guest has uploaded their visa
- Keep the existing visa-free estimation as fallback when no uploaded visa exists
  </action>
  <verify>

1. Run: `cd /Users/gianfrancodagostino/Desktop/gudbro-verticals && npx tsc --noEmit -p apps/accommodations/frontend/tsconfig.json 2>&1 | head -30`
2. Verify files: `ls apps/accommodations/frontend/lib/image-utils.ts apps/accommodations/frontend/components/stay/Document*.tsx apps/accommodations/frontend/components/stay/VisaExpiryAlert.tsx`
3. Check deps installed: `grep "browser-image-compression\|heic2any" apps/accommodations/frontend/package.json`
   </verify>
   <done>
   Image processing pipeline handles HEIC → JPEG → compress → blur detect. Consent component enforces GDPR checkbox before upload. Upload component provides camera/gallery capture with quality validation. Visa expiry alert shows color-coded progress bar. VisaStatusCard supports uploaded visa data.
   </done>
   </task>

<task type="auto">
  <name>Task 2: Dashboard integration + backoffice document viewer</name>
  <files>
    apps/accommodations/frontend/app/stay/room/[roomCode]/page.tsx
    apps/accommodations/frontend/app/stay/[code]/page.tsx
    apps/backoffice/app/(dashboard)/accommodations/documents/page.tsx
    apps/backoffice/app/(dashboard)/accommodations/bookings/[id]/page.tsx
  </files>
  <action>
  **1. Update room dashboard (`app/stay/room/[roomCode]/page.tsx`):**
  - Import DocumentUpload, VisaExpiryAlert, and fetchDocuments from stay-api
  - Add state: `documents` (GuestDocument[]), `showUpload` (boolean), `alertDismissed` (boolean from localStorage)
  - On mount (when full tier + has booking): call fetchDocuments to load existing documents
  - Find latest non-superseded visa document: `documents.find(d => d.documentType === 'visa' && !d.supersededBy)`
  - If visa exists with visaExpiryDate → show VisaExpiryAlert above the WiFi card (between header and WiFi section)
  - Add "Documents" section in the dashboard (after WiFi, before Services):
    - Show uploaded document list (passport checkmark, visa with expiry)
    - "Upload Document" button opens DocumentUpload as a slide-up modal/drawer
    - Only visible when full tier (verified) AND hasActiveBooking
  - Pass document refresh callback to DocumentUpload.onUploadComplete → re-fetch documents
  - Gate document upload behind isActionGated: if owner hasn't explicitly gated it, documents are accessible to full-tier guests by default. Add 'upload_documents' to the action gating check as ungated-by-default (always available for verified guests since it's a legal requirement, not a service).

**2. Update booking dashboard (`app/stay/[code]/page.tsx`):**

- Same integration as room dashboard — this is the legacy booking-code-based dashboard
- Add VisaExpiryAlert and document section following the same pattern
- This ensures backward compatibility: guests using booking code URLs also get document upload

**3. Create backoffice document urgency dashboard (`accommodations/documents/page.tsx`):**

- Page title: "Guest Documents"
- Two tabs: "By Urgency" (default) and "By Guest"
- **By Urgency tab:**
  - Query: all non-deleted visa documents with expiry dates, ordered by visa_expiry_date ASC (most urgent first)
  - JOIN with bookings for guest name, room, check-in/out
  - Show table/card list: Guest Name | Room | Visa Expires | Days Left | Status (registered/pending) | Actions
  - Color-code rows: red (expired or < 3d), amber (3-7d), green (> 7d)
  - Actions: "View" (opens signed URL in new tab), "Download" (triggers download), "Mark Registered" toggle
- **By Guest tab:**
  - Query: all active bookings with their documents
  - Show collapsible guest cards: click to expand and see all documents for that guest
  - Each document: thumbnail (via signed URL), type badge (passport/visa), upload date, visa expiry if applicable
  - Actions same as urgency tab
- Use existing backoffice patterns: TanStack Table or simple cards, Supabase admin client
- API: Use `getSupabaseAdmin()` directly in server component or create API route `apps/backoffice/app/api/accommodations/documents/route.ts` if needed for client-side fetching
- Include badge counter: "X documents pending registration" at top

**4. Update booking detail page (`accommodations/bookings/[id]/page.tsx`):**

- Add "Documents" section at the bottom of booking detail
- List documents for this specific booking: passport (if uploaded), visa (if uploaded, with expiry)
- Show "View" and "Download" links (signed URLs)
- Show "Mark as Registered" toggle per document
- If no documents uploaded, show "No documents uploaded by guest" placeholder
  </action>
  <verify>

1. Run: `npx tsc --noEmit -p apps/accommodations/frontend/tsconfig.json 2>&1 | head -30` — accommodations compiles
2. Run: `npx tsc --noEmit -p apps/backoffice/tsconfig.json 2>&1 | head -30` — backoffice compiles
3. Verify dashboard integration: `grep -c "VisaExpiryAlert\|DocumentUpload\|fetchDocuments" apps/accommodations/frontend/app/stay/room/\[roomCode\]/page.tsx`
4. Verify backoffice page exists: `ls apps/backoffice/app/\(dashboard\)/accommodations/documents/page.tsx`
   </verify>
   <done>
   Room dashboard shows visa expiry alert and document upload section for verified guests. Legacy booking dashboard has same integration. Backoffice has urgency dashboard (by expiry date) and per-guest document viewer. Booking detail page shows per-booking document list with download and registration tracking.
   </done>
   </task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
  Complete document upload system:
  - Guest can upload passport/visa from dashboard with camera or file picker
  - HEIC photos auto-converted, compressed, blur-checked
  - GDPR consent required before upload
  - Visa expiry progress bar on dashboard (green → yellow → red)
  - Owner backoffice document urgency dashboard
  - Booking detail shows guest documents with download + registration tracking
  </what-built>
  <how-to-verify>
  1. Start accommodations dev server: `pnpm dev:accommodations` (port 3001 or configured port)
  2. Navigate to a room dashboard URL with an active booking in full-tier mode
  3. Verify: "Upload Document" section is visible below WiFi card
  4. Test upload flow: select Passport → check GDPR consent → take/select photo → verify blur warning if applicable → upload
  5. After upload: verify passport appears in document list with green checkmark
  6. Test visa upload: select Visa → enter expiry date → upload → verify visa expiry alert bar appears at top of dashboard
  7. Start backoffice dev server: `pnpm dev:backoffice`
  8. Navigate to Accommodations → Documents → verify urgency dashboard shows the uploaded documents
  9. Navigate to booking detail page → verify Documents section shows uploads
  10. Test "Mark as Registered" toggle and document download
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. TypeScript: both accommodations and backoffice compile without errors
2. Dependencies: browser-image-compression and heic2any in accommodations package.json
3. Guest flow: consent → camera/gallery → HEIC convert → compress → blur check → upload → confirm
4. Visa alert: shows when visa document exists, color-coded by days remaining, dismissable (non-dismissable when expired)
5. Backoffice: urgency dashboard sorts by expiry, per-guest view, download and registration tracking
6. Both dashboards (room and booking code) have document integration
</verification>

<success_criteria>

- Guest can photograph and upload passport from mobile dashboard (camera or gallery)
- Guest can upload visa with manual expiry date entry
- Blurry photo warning appears with retake option
- GDPR consent checkbox blocks upload until checked
- Visa expiry progress bar visible on dashboard with correct color coding
- Owner can view, download, and mark documents as registered in backoffice
- Urgency dashboard sorts guests by visa expiry date (most urgent first)
- All TypeScript compiles without errors in both apps
  </success_criteria>

<output>
After completion, create `.planning/phases/28-document-upload-visa-tracking/28-02-SUMMARY.md`
</output>
