---
phase: 36-guest-requests-concierge
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - shared/database/migrations/schema/098-concierge-sections.sql
  - apps/accommodations/frontend/components/BottomNav.tsx
  - apps/accommodations/frontend/app/stay/[code]/page.tsx
  - apps/accommodations/frontend/components/stay/ConciergeHub.tsx
  - apps/accommodations/frontend/app/api/stay/[code]/concierge/route.ts
  - apps/accommodations/frontend/types/stay.ts
  - apps/accommodations/frontend/lib/concierge-data.ts
  - apps/backoffice/app/(dashboard)/settings/layout.tsx
  - apps/backoffice/app/(dashboard)/settings/concierge/page.tsx
  - apps/backoffice/components/settings/ConciergeToggles.tsx
  - apps/backoffice/app/api/settings/concierge/route.ts
autonomous: true

must_haves:
  truths:
    - 'Center bottom nav button opens the Concierge hub overlay (not ServiceCatalog)'
    - 'Concierge hub shows 5 section cards (Discover, Emergency, Safety, Culture, Transport) plus quick links'
    - 'Merchant can toggle each section on/off from backoffice settings'
    - 'Toggled-off sections do not render in the guest PWA'
    - 'Services remain accessible via DashboardCard and ServicesCarousel'
  artifacts:
    - path: 'shared/database/migrations/schema/098-concierge-sections.sql'
      provides: 'concierge_sections JSONB column on accom_properties'
      contains: 'concierge_sections'
    - path: 'apps/accommodations/frontend/components/stay/ConciergeHub.tsx'
      provides: 'Full-screen overlay with 5 section cards'
      min_lines: 80
    - path: 'apps/accommodations/frontend/app/api/stay/[code]/concierge/route.ts'
      provides: 'GET endpoint returning section visibility + country'
      exports: ['GET']
    - path: 'apps/backoffice/components/settings/ConciergeToggles.tsx'
      provides: 'Toggle UI for 5 concierge sections'
      min_lines: 40
    - path: 'apps/backoffice/app/api/settings/concierge/route.ts'
      provides: 'GET/PUT for concierge settings'
      exports: ['GET', 'PUT']
  key_links:
    - from: 'apps/accommodations/frontend/app/stay/[code]/page.tsx'
      to: 'ConciergeHub.tsx'
      via: 'showConcierge state + overlay render'
      pattern: 'showConcierge.*ConciergeHub'
    - from: 'apps/accommodations/frontend/components/BottomNav.tsx'
      to: 'Concierge label and Compass icon'
      via: 'navItems array'
      pattern: 'Compass.*Concierge'
    - from: 'ConciergeHub.tsx'
      to: '/api/stay/[code]/concierge'
      via: 'fetch on mount'
      pattern: 'fetch.*concierge'
    - from: 'ConciergeToggles.tsx'
      to: '/api/settings/concierge'
      via: 'fetch GET + PUT'
      pattern: 'fetch.*settings/concierge'
---

<objective>
Build the Concierge hub foundation: database migration for section toggles, BottomNav center button repurposed to open the Concierge overlay, ConciergeHub component with 5 section cards and quick links, guest-facing API, and backoffice toggle settings page.

Purpose: The Concierge hub replaces ServiceCatalog as the center nav destination, becoming the central discovery point for tourist information. Services remain accessible via DashboardCard + ServicesCarousel + CartFAB.
Output: Working Concierge hub overlay with section cards (clicking sections is plan 36-02), backoffice toggle page, and guest API.
</objective>

<execution_context>
@/Users/gianfrancodagostino/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gianfrancodagostino/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/36-guest-requests-concierge/36-RESEARCH.md
@apps/accommodations/frontend/components/BottomNav.tsx
@apps/accommodations/frontend/app/stay/[code]/page.tsx
@apps/accommodations/frontend/types/stay.ts
@apps/backoffice/app/(dashboard)/settings/layout.tsx
@apps/backoffice/app/api/settings/concierge/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Database migration + types + concierge data module + APIs</name>
  <files>
    shared/database/migrations/schema/098-concierge-sections.sql
    apps/accommodations/frontend/types/stay.ts
    apps/accommodations/frontend/lib/concierge-data.ts
    apps/accommodations/frontend/app/api/stay/[code]/concierge/route.ts
    apps/backoffice/app/api/settings/concierge/route.ts
  </files>
  <action>
    1. Create migration 098-concierge-sections.sql:
       - ALTER TABLE accom_properties ADD COLUMN IF NOT EXISTS concierge_sections JSONB DEFAULT '{"discover": true, "emergency": true, "safety": true, "culture": true, "transport": true}'::jsonb
       - Add COMMENT ON COLUMN

    2. Add types to stay.ts:
       - ConciergeSection = 'discover' | 'emergency' | 'safety' | 'culture' | 'transport'
       - ConciergeSections = Record<ConciergeSection, boolean>
       - ConciergeConfig = { sections: ConciergeSections; country: string; city: string }
       - DEFAULT_CONCIERGE_SECTIONS constant with all true

    3. Create lib/concierge-data.ts with TypeScript constants:
       - SafetyTip interface: { id, title, description, howToProtect: string[], where?: string }
       - SafetyCategory interface: { id, label, icon (Phosphor component name string), tips: SafetyTip[] }
       - CulturalTip interface: { id, category: 'do' | 'dont', title, description }
       - RecommendedApp interface: { id, name, description, platform: 'ios' | 'android' | 'both' }
       - TransportTip interface: { id, type, title, description, priceRange?: string }
       - EmergencyContact interface: { id, name, number, note?: string, type: 'emergency' | 'embassy' | 'hotline' }
       - Structure all data under a country key: CONCIERGE_DATA['VN'] = { emergency, safety, culture, transport }
       - Populate from docs/features/TOURIST-SAFETY-GUIDE.md content (read it during implementation)
       - Include: emergency numbers (113, 114, 115, 112, tourist hotlines), embassies (US, UK, AU, FR, DE, KR, JP, CN at minimum)
       - Include all 7 safety categories from TOURIST-SAFETY-GUIDE.md: transport, money, food, street, hotels, tours, digital
       - Include cultural tips (dos/don'ts) and recommended apps (Grab, Be, Xanh SM, Wise, Google Translate)
       - Include transport section (Grab, metered taxis, xe om, buses)
       - Export getConciergeData(country: string) helper that returns data or null

    4. Create guest API route /api/stay/[code]/concierge/route.ts:
       - Follow exact pattern from /api/stay/[code]/useful-numbers/route.ts
       - GET handler: authenticate guest via authenticateGuest(), fetch accom_properties.concierge_sections + country + city
       - Return { data: { sections, country, city } }
       - 401 on invalid session

    5. Create backoffice API /api/settings/concierge/route.ts:
       - Follow pattern from existing backoffice settings APIs (e.g., /api/settings/charges/route.ts)
       - GET: fetch concierge_sections from accom_properties for current merchant's property
       - PUT: validate body has sections object with 5 boolean keys, update concierge_sections JSONB
       - Use validateAdminApiKey or session-based auth consistent with other settings APIs

  </action>
  <verify>
    - Migration SQL is valid: grep "concierge_sections" shared/database/migrations/schema/098-concierge-sections.sql
    - Types exported: grep "ConciergeSection\|ConciergeSections\|ConciergeConfig" apps/accommodations/frontend/types/stay.ts
    - Data module has VN data: grep "CONCIERGE_DATA" apps/accommodations/frontend/lib/concierge-data.ts
    - Guest API exists: test -f apps/accommodations/frontend/app/api/stay/[code]/concierge/route.ts
    - Backoffice API exists: test -f apps/backoffice/app/api/settings/concierge/route.ts
  </verify>
  <done>
    Migration adds concierge_sections JSONB to accom_properties with all-true default. Types define ConciergeSections shape. concierge-data.ts has Vietnam emergency contacts, 7 safety categories, cultural tips, transport info, and recommended apps. Both APIs handle GET/PUT correctly.
  </done>
</task>

<task type="auto">
  <name>Task 2: BottomNav + ConciergeHub overlay + backoffice toggles UI</name>
  <files>
    apps/accommodations/frontend/components/BottomNav.tsx
    apps/accommodations/frontend/app/stay/[code]/page.tsx
    apps/accommodations/frontend/components/stay/ConciergeHub.tsx
    apps/backoffice/app/(dashboard)/settings/layout.tsx
    apps/backoffice/app/(dashboard)/settings/concierge/page.tsx
    apps/backoffice/components/settings/ConciergeToggles.tsx
  </files>
  <action>
    1. Update BottomNav.tsx:
       - Replace CallBell import with Compass from @phosphor-icons/react
       - Change center navItem from { id: 'services', label: 'Services', Icon: CallBell, isCenter: true } to { id: 'concierge', label: 'Concierge', Icon: Compass, isCenter: true }
       - Keep same 4-tab layout, no other changes

    2. Update page.tsx (stay/[code]/page.tsx):
       - Add state: const [showConcierge, setShowConcierge] = useState(false)
       - Change handleTabChange: when tab === 'concierge', setShowConcierge(true) (instead of 'services' opening catalog)
       - Remove the old 'services' tab handling from handleTabChange (services open via DashboardCard only now)
       - Add ConciergeHub overlay render below ServiceCatalog overlay:
         {showConcierge && <ConciergeHub bookingCode={params.code} token={token!} onClose={() => { setShowConcierge(false); setActiveTab('home'); }} onOpenServices={() => { setShowConcierge(false); setShowCatalog(true); }} />}
       - Update the DashboardCard "Concierge" onClick to: () => setShowConcierge(true) (replace the empty Phase 36 placeholder)
       - Import ConciergeHub

    3. Create ConciergeHub.tsx as full-screen overlay:
       - Props: { bookingCode: string; token: string; onClose: () => void; onOpenServices: () => void }
       - On mount, fetch /api/stay/{bookingCode}/concierge to get sections visibility + country
       - Use getConciergeData(country) from concierge-data.ts to get content
       - Render full-screen overlay (fixed inset-0, z-60, bg-[#FAF8F5]) with:
         - Header: X close button, "Concierge" title, property city subtitle
         - 5 section cards (only if section is toggled ON): Discover (MapPin, amber), Emergency (Phone, red), Safety (ShieldCheck, emerald), Culture (Globe, purple), Transport (Bus, blue)
         - Each card shows: icon, label, brief description, count of items if applicable
         - Quick links row: WiFi (link to wifi-section scroll), Documents (link to documents-section scroll), Contact Host (triggers onClose + could emit event), Room Service (triggers onOpenServices)
         - Bottom note: safety disclaimer from TOURIST-SAFETY-GUIDE.md ("Vietnam is one of the safest destinations...")
       - Section cards initially just render as navigable cards. Sub-page navigation will use state: const [activeSection, setActiveSection] = useState<ConciergeSection | null>(null)
         - When a section card is tapped, setActiveSection(sectionId) -- the actual section content components (ConciergeEmergency, ConciergeSafety, etc.) will be built in plan 36-02
         - For now, tapping a section shows a "Coming soon" placeholder within the overlay, with a back button to return to the hub
       - Use Phosphor icons with weight="duotone" for section icons
       - Follow the card pattern from research: rounded-2xl border bg-white p-4 shadow-sm

    4. Update backoffice settings/layout.tsx:
       - Import Compass from lucide-react (backoffice uses lucide, not Phosphor)
       - Add to settingsTabs array: { name: 'Concierge', href: '/settings/concierge', icon: Compass }

    5. Create settings/concierge/page.tsx:
       - Simple page wrapper that renders ConciergeToggles component
       - Title: "Concierge Settings" with subtitle "Control which concierge sections are visible to your guests"

    6. Create ConciergeToggles.tsx:
       - On mount, GET /api/settings/concierge to load current toggle state
       - Render 5 toggle rows, each with: Phosphor icon (duotone), section label, description, toggle switch
       - Use the 5 sections: Discover (MapPin), Emergency (Phone), Safety Tips (Shield), Culture (Globe), Transport (Bus)
       - Toggle change calls PUT /api/settings/concierge with full sections object
       - Show toast on save success/failure (use existing toast pattern from backoffice)
       - Loading skeleton while fetching
       - Match existing backoffice settings UI patterns (gray-50 background cards, consistent spacing)

  </action>
  <verify>
    - BottomNav uses Compass: grep "Compass" apps/accommodations/frontend/components/BottomNav.tsx
    - ConciergeHub imported in page: grep "ConciergeHub" apps/accommodations/frontend/app/stay/[code]/page.tsx
    - ConciergeHub fetches API: grep "concierge" apps/accommodations/frontend/components/stay/ConciergeHub.tsx
    - Backoffice tab added: grep "Concierge" apps/backoffice/app/\(dashboard\)/settings/layout.tsx
    - Toggle page exists: test -f apps/backoffice/app/\(dashboard\)/settings/concierge/page.tsx
    - Build check: cd apps/accommodations/frontend && npx next build --no-lint 2>&1 | tail -5
  </verify>
  <done>
    BottomNav center button shows Compass icon with "Concierge" label. Tapping it opens ConciergeHub overlay with 5 section cards filtered by merchant toggles. Quick links to WiFi, Documents, Contact, Room Service are present. Backoffice has new Concierge tab in settings with 5 toggle switches that persist to database. Services remain accessible via DashboardCard "Services" on home grid and ServicesCarousel "View All".
  </done>
</task>

</tasks>

<verification>
- Center BottomNav button labeled "Concierge" with Compass icon
- Tapping center button opens ConciergeHub overlay with section cards
- Section cards filtered by merchant toggle settings
- DashboardCard "Services" still opens ServiceCatalog
- ServicesCarousel "View All" still opens ServiceCatalog
- CartFAB still visible when cart has items
- Backoffice Settings > Concierge tab shows 5 toggles
- Toggling a section off in backoffice hides it from PWA
- Migration 098 adds concierge_sections column
</verification>

<success_criteria>

1. Center bottom nav opens Concierge hub (not ServiceCatalog)
2. Hub shows up to 5 section cards based on merchant toggles
3. Quick links to WiFi, Documents, Contact, Room Service work
4. Backoffice toggle page saves and persists section visibility
5. Services remain accessible via DashboardCard and ServicesCarousel (zero regression)
   </success_criteria>

<output>
After completion, create `.planning/phases/36-guest-requests-concierge/36-01-SUMMARY.md`
</output>
