---
phase: 11-e2e-smoke-tests
plan: 02
type: execute
wave: 2
depends_on: ['11-01']
files_modified:
  - tests/e2e/verticals/coffeeshop.smoke.spec.ts
  - tests/e2e/verticals/gym.smoke.spec.ts
  - tests/e2e/verticals/tours.smoke.spec.ts
  - tests/e2e/verticals/accommodations.smoke.spec.ts
  - tests/e2e/shared/vertical-registry.ts
autonomous: true

must_haves:
  truths:
    - 'Coffeeshop and gym smoke tests cover page load, BottomNav link navigation, and responsive viewports'
    - 'Tours and accommodations smoke tests cover page load, BottomNav tab interaction (callback-based), and responsive viewports'
    - 'All 8 verticals (16 projects) pass together with zero failures across 3 consecutive runs'
  artifacts:
    - path: 'tests/e2e/verticals/coffeeshop.smoke.spec.ts'
      provides: 'Coffeeshop smoke tests'
      contains: 'Coffeeshop PWA Smoke'
    - path: 'tests/e2e/verticals/gym.smoke.spec.ts'
      provides: 'Gym smoke tests'
      contains: 'Gym PWA Smoke'
    - path: 'tests/e2e/verticals/tours.smoke.spec.ts'
      provides: 'Tours smoke tests (callback-based nav)'
      contains: 'BottomNav tabs are interactive'
    - path: 'tests/e2e/verticals/accommodations.smoke.spec.ts'
      provides: 'Accommodations smoke tests (callback-based nav)'
      contains: 'BottomNav tabs are interactive'
  key_links:
    - from: 'tests/e2e/verticals/tours.smoke.spec.ts'
      to: 'tests/e2e/shared/fixtures.ts'
      via: 'import { test, expect }'
      pattern: "from '../shared/fixtures'"
    - from: 'tests/e2e/verticals/accommodations.smoke.spec.ts'
      to: 'tests/e2e/shared/vertical-registry.ts'
      via: 'VERTICALS.accommodations'
      pattern: "VERTICALS\\.accommodations"
---

<objective>
Write smoke tests for coffeeshop, gym (link-based), tours, and accommodations (callback-based), then validate all 8 verticals pass together 3 consecutive times.

Purpose: Complete full smoke test coverage for all 8 verticals. Coffeeshop and gym are link-based but have nuances (coffeeshop hidden on `lg:` not `md:`, gym center button is `href="#"`). Tours and accommodations are callback-based (buttons, not links). Final validation ensures zero flaky failures.
Output: 4 new smoke spec files + full suite passing 3x consecutively.
</objective>

<execution_context>
@/Users/gianfrancodagostino/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gianfrancodagostino/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-e2e-smoke-tests/11-RESEARCH.md
@.planning/phases/11-e2e-smoke-tests/11-01-SUMMARY.md

@tests/e2e/shared/fixtures.ts
@tests/e2e/shared/base-pwa-page.ts
@tests/e2e/shared/vertical-registry.ts
@tests/e2e/verticals/wellness.smoke.spec.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create coffeeshop, gym, tours, and accommodations smoke specs</name>
  <files>
    tests/e2e/verticals/coffeeshop.smoke.spec.ts
    tests/e2e/verticals/gym.smoke.spec.ts
    tests/e2e/verticals/tours.smoke.spec.ts
    tests/e2e/verticals/accommodations.smoke.spec.ts
    tests/e2e/shared/vertical-registry.ts
  </files>
  <action>
**LINK-BASED VERTICALS:**

**Coffeeshop:** Create `coffeeshop.smoke.spec.ts`. Use `VERTICALS.coffeeshop`. Coffeeshop has 3 nav links (Home `/`, Menu `/menu`, Account `/account`) -- center "More" is a button. Use `nav a[href]:not([href="#"])` selector. Include: page load, title, console errors, nav visible, BottomNav link navigation (with desktop graceful skip -- `if (count === 0) return`), key routes, and 3 responsive viewport tests. NOTE: coffeeshop BottomNav uses `lg:hidden` not `md:hidden` so it is hidden at 1024px+, still visible at 768px tablet. The desktop graceful skip handles this.

**Gym:** Create `gym.smoke.spec.ts`. Use `VERTICALS.gym`. Gym has 4 nav links (Home `/`, Courses `/courses`, Shop `/shop`, Account `/account`) -- center "Day Pass" has `href="#"` which is filtered out by `a[href]:not([href="#"])`. Same full template with desktop graceful skip.

**CALLBACK-BASED VERTICALS (different navigation test):**

**Tours:** Create `tours.smoke.spec.ts`. Use `VERTICALS.tours`. Tours is a full SPA with single route `/`. Replace the BottomNav link navigation test with a **BottomNav tabs interactive** test:

```typescript
test('BottomNav tabs are interactive', async ({ page, pwaPage }) => {
  await pwaPage.goto();
  const navButtons = page.locator('nav button');
  const count = await navButtons.count();
  if (count === 0) return; // Hidden on desktop viewport
  for (let i = 0; i < count; i++) {
    await navButtons.nth(i).click();
    // Structural: nav still visible after click (no crash)
    await expect(page.locator('nav').first()).toBeVisible();
  }
});
```

Tours has only `routes: { home: '/' }` so the key routes test is trivial. Include all other standard tests (page load, title, console errors, nav visible, responsive viewports).

**Accommodations:** Create `accommodations.smoke.spec.ts`. Use `VERTICALS.accommodations`. Same callback-based pattern as tours. All nav items are buttons with `onTabChange`. Include the tab interactive test. For key routes, the registry has `home: '/'` and `stay: '/stay'`. The `/stay` route without a code will likely return a 404 or redirect since only `/stay/[code]/page.tsx` exists. **Remove `/stay` from the accommodations registry routes** to avoid a false failure: update `tests/e2e/shared/vertical-registry.ts` to change accommodations routes from `{ home: '/', stay: '/stay' }` to `{ home: '/' }`. This is the cleanest fix -- `/stay` is not a real standalone route.

**Anti-flaky rules (same as Plan 01):**

- Use `waitForLoadState('domcontentloaded')` NOT `networkidle` for navigation/viewport tests
- Use structural assertions only
- Desktop graceful skip for BottomNav tests (`if (count === 0) return`)
- For callback-based: assert nav stays visible after button click (structural, not content)
  </action>
  <verify>
  Run each spec individually on mobile:

```bash
SKIP_WEBSERVER=1 npx playwright test --project=coffeeshop-mobile tests/e2e/verticals/coffeeshop.smoke.spec.ts
SKIP_WEBSERVER=1 npx playwright test --project=gym-mobile tests/e2e/verticals/gym.smoke.spec.ts
SKIP_WEBSERVER=1 npx playwright test --project=tours-mobile tests/e2e/verticals/tours.smoke.spec.ts
SKIP_WEBSERVER=1 npx playwright test --project=accommodations-mobile tests/e2e/verticals/accommodations.smoke.spec.ts
```

Then on desktop:

```bash
SKIP_WEBSERVER=1 npx playwright test --project=coffeeshop-desktop tests/e2e/verticals/coffeeshop.smoke.spec.ts
SKIP_WEBSERVER=1 npx playwright test --project=gym-desktop tests/e2e/verticals/gym.smoke.spec.ts
SKIP_WEBSERVER=1 npx playwright test --project=tours-desktop tests/e2e/verticals/tours.smoke.spec.ts
SKIP_WEBSERVER=1 npx playwright test --project=accommodations-desktop tests/e2e/verticals/accommodations.smoke.spec.ts
```

All pass on both mobile and desktop.
</verify>
<done>
4 new smoke spec files created. Coffeeshop and gym use link-based nav pattern. Tours and accommodations use callback-based tab pattern. Accommodations registry updated to remove /stay. All 4 pass on both mobile and desktop projects.
</done>
</task>

<task type="auto">
  <name>Task 2: Full suite validation -- all 8 verticals, 3 consecutive runs</name>
  <files>
    (no new files -- validation only)
  </files>
  <action>
Run ALL 16 vertical projects (8 verticals x 2 viewports) together 3 consecutive times to prove zero flaky failures.

The Playwright project names are `{slug}-mobile` and `{slug}-desktop`. Run all vertical projects together. Two approaches to select all vertical projects:

**Option A (explicit):**

```bash
SKIP_WEBSERVER=1 npx playwright test --project=coffeeshop-mobile --project=coffeeshop-desktop --project=accommodations-mobile --project=accommodations-desktop --project=tours-mobile --project=tours-desktop --project=wellness-mobile --project=wellness-desktop --project=laundry-mobile --project=laundry-desktop --project=pharmacy-mobile --project=pharmacy-desktop --project=workshops-mobile --project=workshops-desktop --project=gym-mobile --project=gym-desktop
```

**Option B (grep):**

```bash
SKIP_WEBSERVER=1 npx playwright test --grep "PWA Smoke" tests/e2e/verticals/
```

Use whichever works. Run it 3 times. All 3 runs must pass with zero failures.

If ANY test fails on any run:

1. Identify the failing test and vertical
2. Check if it is a flaky failure (passes on retry) or a real bug
3. Fix the flaky test (adjust waitFor, add timeout, fix selector)
4. Re-run 3 consecutive times after the fix

Report total test count and pass rate for each run.
</action>
<verify>
3 consecutive runs of all 16 vertical projects with zero failures each run.

```bash
# Run 1
SKIP_WEBSERVER=1 npx playwright test tests/e2e/verticals/ --project=coffeeshop-mobile --project=coffeeshop-desktop ...
# Run 2
SKIP_WEBSERVER=1 npx playwright test tests/e2e/verticals/ --project=coffeeshop-mobile --project=coffeeshop-desktop ...
# Run 3
SKIP_WEBSERVER=1 npx playwright test tests/e2e/verticals/ --project=coffeeshop-mobile --project=coffeeshop-desktop ...
```

  </verify>
  <done>
All 8 verticals (16 projects) pass together 3 consecutive times with zero flaky failures.
Total test count: ~64+ tests (8 specs x ~8 tests each) across 16 projects.
Success criteria #4 satisfied: zero flaky failures across 3 runs.
  </done>
</task>

</tasks>

<verification>
- 8 smoke spec files exist in `tests/e2e/verticals/` (1 per vertical)
- Each spec covers page load (no JS errors), BottomNav navigation, and responsive viewports
- Link-based verticals (coffeeshop, wellness, laundry, pharmacy, workshops, gym) test `nav a[href]` clicks
- Callback-based verticals (tours, accommodations) test `nav button` clicks
- All use structural assertions (no content text assertions)
- All 16 projects pass together 3 consecutive times
</verification>

<success_criteria>
All 8 verticals have smoke tests covering page load, BottomNav navigation, and responsive viewports.
All tests pass together with zero flaky failures across 3 consecutive runs.
Phase 11 success criteria #1-5 all satisfied.
</success_criteria>

<output>
After completion, create `.planning/phases/11-e2e-smoke-tests/11-02-SUMMARY.md`
</output>
