---
phase: 08-schema-api-alignment
plan: 02
type: execute
wave: 2
depends_on: ['08-01']
files_modified:
  - shared/database/migrations/schema/078-accommodations-seed.sql
  - apps/accommodations/frontend/types/stay.ts
autonomous: true

must_haves:
  truths:
    - 'Seed data uses renamed column names and includes new columns'
    - 'TypeScript types match the database schema after migration 081'
    - 'next build succeeds for accommodations frontend'
    - 'All 7 E2E flows would work against the aligned schema'
  artifacts:
    - path: 'shared/database/migrations/schema/078-accommodations-seed.sql'
      provides: 'Updated seed data matching post-081 column names'
      contains: 'wifi_network'
    - path: 'apps/accommodations/frontend/types/stay.ts'
      provides: 'TypeScript types aligned with updated schema'
      contains: 'PropertyInfo'
  key_links:
    - from: 'shared/database/migrations/schema/078-accommodations-seed.sql'
      to: 'shared/database/migrations/schema/081-schema-api-alignment.sql'
      via: 'Seed INSERT column names match post-migration schema'
      pattern: 'contact_phone|wifi_network|sort_order|checkout_time'
    - from: 'apps/accommodations/frontend/types/stay.ts'
      to: 'apps/accommodations/frontend/app/api/stay/verify/route.ts'
      via: 'TypeScript types match API response mapping'
      pattern: 'PropertyInfo|ServiceItemResponse'
---

<objective>
Update seed data to use renamed column names and include new columns, verify TypeScript types are aligned, and confirm the accommodations frontend builds successfully.

Purpose: Migration 081 renames columns and adds new ones. The seed data (078) still uses old column names (wifi_ssid, host_phone, host_email, check_out_time, display_order, image_url) and lacks new columns (contact_whatsapp, currency, price_type, in_stock). If someone re-runs the seed, it would fail against the post-081 schema. TypeScript types must also reflect any schema additions.

Output: Updated seed SQL, verified types, and a passing `next build`.
</objective>

<execution_context>
@/Users/gianfrancodagostino/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gianfrancodagostino/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-schema-api-alignment/08-01-SUMMARY.md
@shared/database/migrations/schema/078-accommodations-seed.sql
@shared/database/migrations/schema/081-schema-api-alignment.sql
@apps/accommodations/frontend/types/stay.ts
@apps/accommodations/frontend/app/api/stay/verify/route.ts
@apps/accommodations/frontend/app/api/stay/[code]/property/route.ts
@apps/accommodations/frontend/app/api/stay/[code]/services/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update seed data for post-081 column names</name>
  <files>shared/database/migrations/schema/078-accommodations-seed.sql</files>
  <action>
Update the seed SQL file to use the new column names from migration 081. This is a find-and-replace operation on the INSERT statements:

**accom_properties INSERT (Section 1):**

- `wifi_ssid` -> `wifi_network` (column name in INSERT)
- `host_phone` -> `contact_phone` (column name in INSERT)
- `host_email` -> `contact_email` (column name in INSERT)
- `check_out_time` -> `checkout_time` (column name in INSERT)
- `country_code` -> `country` (column name in INSERT, value stays 'VN')
- `cover_image_url` is not in the current seed INSERT (no change needed)
- Add `contact_whatsapp` column with value `'+84905123456'` (same as contact_phone for demo)
- Change `house_rules` value from a plain TEXT string to a JSONB array:
  OLD: `'No smoking indoors. Quiet hours 22:00-07:00. No parties. Shoes off at entrance. Trash separation required.'`
  NEW: `'["No smoking indoors", "Quiet hours 22:00-07:00", "No parties", "Shoes off at entrance", "Trash separation required"]'::JSONB`

**accom_service_categories INSERTs (Section 4):**

- `display_order` -> `sort_order` (column name in all 3 INSERT statements)

**accom_service_items INSERTs (Section 5):**

- `display_order` -> `sort_order` (column name in all 13 INSERT statements)
- No `image_url` values in current seed (column not included in INSERTs), so no change needed for `image`
- Add `currency` column with value `'VND'` to all 13 INSERT statements
- Add `price_type` column with value `'fixed'` to all 13 INSERT statements
- Add `in_stock` column with value `true` to all 13 INSERT statements

Keep the migration header comment, section structure, and all UUIDs exactly as they are. Only change column names and add new column values.

Update the migration header comment to note it was updated for 081 alignment.
</action>
<verify>
Check the updated seed file:

1. `grep -c 'wifi_network' shared/database/migrations/schema/078-accommodations-seed.sql` returns 1
2. `grep -c 'wifi_ssid' shared/database/migrations/schema/078-accommodations-seed.sql` returns 0
3. `grep -c 'contact_phone' shared/database/migrations/schema/078-accommodations-seed.sql` returns 1
4. `grep -c 'host_phone' shared/database/migrations/schema/078-accommodations-seed.sql` returns 0 (except in comment about host)
5. `grep -c 'sort_order' shared/database/migrations/schema/078-accommodations-seed.sql` returns 16 (3 categories + 13 items)
6. `grep -c 'display_order' shared/database/migrations/schema/078-accommodations-seed.sql` returns 0
7. `grep -c 'contact_whatsapp' shared/database/migrations/schema/078-accommodations-seed.sql` returns 1
8. `grep -c 'currency' shared/database/migrations/schema/078-accommodations-seed.sql` returns at least 13 (service items) + 1 (property)
9. `grep -c 'price_type' shared/database/migrations/schema/078-accommodations-seed.sql` returns 13
10. `grep -c 'in_stock' shared/database/migrations/schema/078-accommodations-seed.sql` returns 13
11. house_rules value is a JSONB array (contains `'["No smoking`)
    </verify>
    <done>
    Seed file uses all post-081 column names, includes contact_whatsapp, currency, price_type, in_stock values, and house_rules as JSONB array. No old column names remain.
    </done>
    </task>

<task type="auto">
  <name>Task 2: Verify TypeScript types and build</name>
  <files>apps/accommodations/frontend/types/stay.ts</files>
  <action>
**Step 1: Verify TypeScript types alignment.**

Read `apps/accommodations/frontend/types/stay.ts` and confirm all types match what the API routes return from the post-081 schema. The types should already be correct since the API routes were written with these column names in mind. Specifically verify:

- `PropertyInfo.type` (string) -- matches generated column `type` from `property_type`
- `PropertyInfo.contactPhone` (string | null) -- matches `contact_phone`
- `PropertyInfo.contactWhatsapp` (string | null) -- matches `contact_whatsapp`
- `PropertyInfo.checkoutTime` (string) -- matches `checkout_time`
- `PropertyInfo.houseRules` (string[]) -- matches JSONB array `house_rules`
- `WifiInfo.network` (string | null) -- matches `wifi_network`
- `ServiceItemResponse.currency` (string) -- matches `currency`
- `ServiceItemResponse.priceType` (string) -- matches `price_type`
- `ServiceItemResponse.image` (string | null) -- matches `image`
- `ServiceItemResponse.inStock` (boolean) -- matches `in_stock`
- `ServiceCategoryWithItems.sortOrder` (number) -- matches `sort_order`

If any type field is missing or wrong, add/fix it. Based on the gap audit, the types were already written to match the API response shape, so no changes should be needed. If so, document "types already aligned, no changes needed."

**Step 2: Add PropertyInfo fields for new property columns (if missing).**

Check if PropertyInfo includes fields for:

- `description` (string) -- property route SELECTs it
- `contactEmail` (string | null) -- maps to `contact_email`

The property route returns these fields but PropertyInfo might not include them. If missing, add:

```typescript
description?: string;
contactEmail?: string | null;
```

**Step 3: Run build verification.**

Run `cd apps/accommodations/frontend && npx next build` to confirm the accommodations frontend builds with no errors.

If build fails, diagnose and fix TypeScript issues (likely minor type mismatches from property route returning fields not in PropertyInfo).
</action>
<verify>

1. `cd apps/accommodations/frontend && npx next build` exits with code 0
2. No TypeScript errors related to stay types
3. All API route files compile successfully
   </verify>
   <done>
   TypeScript types are verified aligned with post-081 schema. `next build` succeeds for accommodations frontend. All API routes compile and their SELECT column names match the database schema.
   </done>
   </task>

</tasks>

<verification>
- Seed SQL file uses post-081 column names exclusively (no old names remain)
- Seed SQL includes values for all new columns (contact_whatsapp, currency, price_type, in_stock)
- house_rules seed value is JSONB array format
- TypeScript types match the schema
- `next build` passes for accommodations frontend
- Cross-reference: every column in every API SELECT statement exists in the post-081 database schema
</verification>

<success_criteria>

- Zero old column names in seed file (wifi_ssid, host_phone, host_email, check_out_time, display_order, image_url all replaced)
- New columns present in seed INSERTs with appropriate demo values
- `next build` exits 0 for accommodations frontend
- All 10 integration gaps from milestone audit are closed by the combined 081 migration + updated seed
  </success_criteria>

<output>
After completion, create `.planning/phases/08-schema-api-alignment/08-02-SUMMARY.md`
</output>
