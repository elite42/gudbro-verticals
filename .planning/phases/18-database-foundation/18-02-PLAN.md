---
phase: 18-database-foundation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/accommodations/frontend/app/api/webhooks/stripe/route.ts
  - apps/accommodations/frontend/package.json
autonomous: true

user_setup:
  - service: stripe
    why: 'Webhook signature verification for booking payments'
    env_vars:
      - name: STRIPE_SECRET_KEY
        source: 'Stripe Dashboard -> Developers -> API keys -> Secret key'
      - name: STRIPE_ACCOM_WEBHOOK_SECRET
        source: 'Stripe Dashboard -> Developers -> Webhooks -> Add endpoint -> Signing secret (after creating endpoint for /api/webhooks/stripe)'
    dashboard_config:
      - task: 'Create webhook endpoint pointing to https://<accom-domain>/api/webhooks/stripe'
        location: 'Stripe Dashboard -> Developers -> Webhooks -> Add endpoint'

must_haves:
  truths:
    - 'Stripe webhook route exists and responds to POST requests'
    - 'Invalid signatures are rejected with 400 status'
    - 'Missing signature header or endpoint secret returns 400'
    - 'Valid events return 200 with {received: true}'
    - 'Event handlers are stubbed (checkout.session.completed, checkout.session.expired) ready for Phase 20'
  artifacts:
    - path: 'apps/accommodations/frontend/app/api/webhooks/stripe/route.ts'
      provides: 'Stripe webhook endpoint with signature verification'
      exports: ['POST']
    - path: 'apps/accommodations/frontend/package.json'
      provides: 'stripe dependency added'
      contains: 'stripe'
  key_links:
    - from: 'apps/accommodations/frontend/app/api/webhooks/stripe/route.ts'
      to: 'stripe.webhooks.constructEvent'
      via: 'Stripe SDK signature verification'
      pattern: 'constructEvent'
---

<objective>
Create the Stripe webhook endpoint for the Accommodations PWA with signature verification and stubbed event handlers.

Purpose: INFRA-08 requires the webhook infrastructure in place now so Phase 20 (Payments) can focus on payment flow logic without building webhook plumbing. The endpoint verifies signatures, handles the two key checkout events, and returns proper status codes.
Output: Working webhook route at `/api/webhooks/stripe` with `stripe` npm dependency added.
</objective>

<execution_context>
@/Users/gianfrancodagostino/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gianfrancodagostino/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-database-foundation/18-RESEARCH.md

# Existing Stripe webhook pattern to follow

@apps/backoffice/app/api/wallet/stripe/route.ts

# Accommodations package.json (needs stripe dependency)

@apps/accommodations/frontend/package.json

# Supabase admin client pattern

@apps/accommodations/frontend/lib/supabase.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add stripe dependency to accommodations package.json</name>
  <files>apps/accommodations/frontend/package.json</files>
  <action>
Add `"stripe": "^14.0.0"` to the `dependencies` section of `apps/accommodations/frontend/package.json`.

Then run `pnpm install` from the workspace root to update the lockfile.

Do NOT change any other dependencies.
</action>
<verify>

1. `grep '"stripe"' apps/accommodations/frontend/package.json` -- must show stripe dependency
2. `pnpm ls stripe --filter @gudbro/accommodations-frontend` -- must resolve
   </verify>
   <done>stripe ^14.0.0 is in accommodations package.json dependencies and pnpm lockfile is updated.</done>
   </task>

<task type="auto">
  <name>Task 2: Create Stripe webhook route with signature verification</name>
  <files>apps/accommodations/frontend/app/api/webhooks/stripe/route.ts</files>
  <action>
Create `apps/accommodations/frontend/app/api/webhooks/stripe/route.ts` following the EXACT pattern from `apps/backoffice/app/api/wallet/stripe/route.ts` for signature verification, but simplified for accommodations.

The file must:

1. Import `NextRequest`, `NextResponse` from `next/server` and `Stripe` from `stripe`
2. Initialize Stripe client with `process.env.STRIPE_SECRET_KEY` and apiVersion `'2023-10-16'`
3. Read `process.env.STRIPE_ACCOM_WEBHOOK_SECRET` for the endpoint signing secret
4. Export a single `POST` handler that:
   a. Reads raw body with `request.text()` (NOT `.json()` -- Stripe needs raw body for signature)
   b. Gets `stripe-signature` header
   c. Returns 400 if signature or endpointSecret is missing
   d. Calls `stripe.webhooks.constructEvent(body, signature, endpointSecret)` in try/catch
   e. Returns 400 on signature verification failure with console.error log
   f. Handles two event types with TODO comments for Phase 20:
   - `checkout.session.completed`: Extract `booking_id` from `session.metadata`, add TODO comment "Phase 20: Update booking payment_status to 'paid', status to 'confirmed'"
   - `checkout.session.expired`: Extract `booking_id` from `session.metadata`, add TODO comment "Phase 20: Handle expired checkout session"
     g. Returns `{ received: true }` with 200 status

Add a JSDoc comment at the top of the file:

```
/**
 * Stripe Webhook for Accommodations Booking Payments
 *
 * Handles payment lifecycle events from Stripe Checkout.
 * Signature verification ensures only legitimate Stripe events are processed.
 *
 * Event handlers are stubbed -- actual logic added in Phase 20 (Payments).
 *
 * POST /api/webhooks/stripe
 */
```

Do NOT import or use supabase-admin -- that comes in Phase 20.
Do NOT use `request.json()` -- must use `request.text()` for signature verification.
</action>
<verify>

1. `cat apps/accommodations/frontend/app/api/webhooks/stripe/route.ts` -- file exists
2. `grep "request.text()" apps/accommodations/frontend/app/api/webhooks/stripe/route.ts` -- must use raw body
3. `grep "constructEvent" apps/accommodations/frontend/app/api/webhooks/stripe/route.ts` -- must verify signature
4. `grep "STRIPE_ACCOM_WEBHOOK_SECRET" apps/accommodations/frontend/app/api/webhooks/stripe/route.ts` -- separate secret from wallet webhook
5. `grep "Phase 20" apps/accommodations/frontend/app/api/webhooks/stripe/route.ts` -- TODO stubs present
6. `grep -c "export async function POST" apps/accommodations/frontend/app/api/webhooks/stripe/route.ts` -- exactly 1 export
7. Run typecheck: `cd apps/accommodations/frontend && npx tsc --noEmit 2>&1 | head -20` -- no errors in the new file
   </verify>
   <done>
   Webhook route exists at `/api/webhooks/stripe` with: signature verification using stripe.webhooks.constructEvent, STRIPE_ACCOM_WEBHOOK_SECRET env var, raw body via request.text(), stubbed handlers for checkout.session.completed and checkout.session.expired with Phase 20 TODOs, proper error handling (400 on missing/invalid signature, 200 on success).
   </done>
   </task>

</tasks>

<verification>
1. stripe dependency in package.json and installable
2. Webhook route file exists at correct Next.js App Router path
3. Uses `request.text()` (not `.json()`) for raw body
4. Uses `constructEvent()` for signature verification
5. Uses separate `STRIPE_ACCOM_WEBHOOK_SECRET` (not the wallet secret)
6. TypeScript compiles without errors
7. Event handlers are stubbed with clear Phase 20 TODOs
</verification>

<success_criteria>

- INFRA-08: Stripe webhook endpoint path is registered (`/api/webhooks/stripe`) and signature verification logic is in place using `stripe.webhooks.constructEvent()`
  </success_criteria>

<output>
After completion, create `.planning/phases/18-database-foundation/18-02-SUMMARY.md`
</output>
