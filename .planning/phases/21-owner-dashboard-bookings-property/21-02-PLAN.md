---
phase: 21-owner-dashboard-bookings-property
plan: 02
type: execute
wave: 2
depends_on: [21-01]
files_modified:
  - apps/backoffice/app/(dashboard)/accommodations/bookings/page.tsx
  - apps/backoffice/app/(dashboard)/accommodations/bookings/[id]/page.tsx
  - apps/backoffice/components/accommodations/BookingActions.tsx
  - apps/backoffice/components/accommodations/BookingTimeline.tsx
autonomous: true

must_haves:
  truths:
    - 'Owner can view a filterable list of bookings with tab-based status filtering and search by guest name or booking code'
    - 'Owner can drill into a booking to see guest info, dates, room, price breakdown, payment status, and special requests'
    - 'Owner can confirm or decline inquiry bookings, mark guests as checked-in or checked-out, and cancel with a reason'
    - 'Owner receives a WhatsApp notification link when viewing a new booking'
  artifacts:
    - path: 'apps/backoffice/app/(dashboard)/accommodations/bookings/page.tsx'
      provides: 'Booking list page with tabs, search, and status badges'
      min_lines: 150
    - path: 'apps/backoffice/app/(dashboard)/accommodations/bookings/[id]/page.tsx'
      provides: 'Booking detail page with sections and action buttons'
      min_lines: 200
    - path: 'apps/backoffice/components/accommodations/BookingActions.tsx'
      provides: 'Contextual action buttons with confirmation dialogs'
    - path: 'apps/backoffice/components/accommodations/BookingTimeline.tsx'
      provides: 'Visual timeline of booking status changes'
  key_links:
    - from: 'apps/backoffice/app/(dashboard)/accommodations/bookings/page.tsx'
      to: '/api/accommodations/bookings'
      via: 'fetch with Authorization header'
      pattern: 'fetch.*api/accommodations/bookings'
    - from: 'apps/backoffice/components/accommodations/BookingActions.tsx'
      to: '/api/accommodations/bookings/[id]'
      via: 'PATCH request with action body'
      pattern: 'fetch.*api/accommodations/bookings.*PATCH'
    - from: 'apps/backoffice/app/(dashboard)/accommodations/bookings/[id]/page.tsx'
      to: 'buildWhatsAppUrl'
      via: 'WhatsApp deep-link for owner notification'
      pattern: 'buildWhatsAppUrl'
---

<objective>
Build the booking list and booking detail pages for the owner dashboard.

Purpose: Owners can view, filter, and manage all their accommodation bookings from the backoffice. This is the operational core — the first screen an owner opens each morning to see today's check-ins and pending inquiries.
Output: Booking list page with tabs/search, booking detail page with all info and contextual actions, reusable action and timeline components.
</objective>

<execution_context>
@/Users/gianfrancodagostino/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gianfrancodagostino/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-owner-dashboard-bookings-property/21-01-SUMMARY.md

# Reference patterns

@apps/backoffice/app/(dashboard)/partnerships/bookings/page.tsx
@apps/accommodations/frontend/app/dashboard/bookings/page.tsx
@apps/backoffice/lib/accommodations/helpers.ts
@apps/backoffice/components/accommodations/BookingStatusBadge.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Booking list page with tab filtering and search</name>
  <files>
    apps/backoffice/app/(dashboard)/accommodations/bookings/page.tsx
  </files>
  <action>
Create `apps/backoffice/app/(dashboard)/accommodations/bookings/page.tsx` as a 'use client' component.

**State:**

- `bookings: DashboardBooking[]` — fetched from API
- `activeTab: 'all' | 'pending' | 'confirmed' | 'checked_in' | 'cancelled'` — default 'all'
- `searchQuery: string` — filters by guest name or booking code
- `loading: boolean`
- `propertyId: string` — hardcoded from env or fetched (use a TODO comment for proper property lookup)

**DashboardBooking interface** (define locally or import):

```typescript
interface DashboardBooking {
  id: string;
  booking_code: string;
  guest_name: string;
  guest_last_name: string;
  guest_email: string;
  guest_phone: string;
  check_in_date: string;
  check_out_date: string;
  num_nights: number;
  num_guests: number;
  total_price: number;
  currency: string;
  status: string;
  payment_method: string | null;
  payment_status: string | null;
  deposit_amount: number | null;
  deposit_percent: number | null;
  special_requests: string | null;
  created_at: string;
  room: { id: string; room_number: string; room_type: string } | null;
}
```

**Data fetching:**

- On mount, fetch `GET /api/accommodations/bookings?propertyId={id}` with `Authorization: Bearer {ADMIN_API_KEY}` header.
- Store the ADMIN_API_KEY in a constant at top of file (read from env or hardcode with TODO for proper auth).
- For now, use `const PROPERTY_ID = process.env.NEXT_PUBLIC_ACCOM_PROPERTY_ID || ''` and show empty state if not configured.

**Tab bar:**

- Render tabs: All (count) | Pending (count) | Confirmed (count) | Checked-in (count) | Cancelled (count)
- Use `useMemo` to compute counts per status (pending includes pending + pending_payment).
- Active tab has a bottom border accent color and bold text.
- Follow the existing partnership bookings tab pattern from `apps/backoffice/app/(dashboard)/partnerships/bookings/page.tsx`.

**Search bar:**

- Text input above the table, right-aligned.
- Filters `filteredBookings` by guest_name, guest_last_name, or booking_code (case-insensitive contains).

**Table:**

- HTML table (not a component library) following existing backoffice table styling.
- Columns: Guest (full name), Room (number + type), Check-in, Check-out, Status (BookingStatusBadge), Payment (BookingStatusBadge type="payment"), Amount (formatBookingPrice), Actions (View link).
- Each row links to `/accommodations/bookings/{id}`.
- Sort by check_in_date descending (upcoming first — this is the API default).

**Empty states:**

- No property configured: Show message "No accommodation property configured. Contact support to set up your property."
- No bookings: Show "No bookings yet. Share your property link to start receiving bookings."
- No results for search/filter: Show "No bookings match your search."

**Loading state:**

- Show a simple "Loading bookings..." with Loader2 spinner while fetching.

Use Phosphor Icons (`@phosphor-icons/react`) for any icons (MagnifyingGlass for search, etc.).
</action>
<verify>
TypeScript compiles: `cd apps/backoffice && npx tsc --noEmit --pretty 2>&1 | head -30`.
Visually verify: page renders with tab bar, search, and table layout.
</verify>
<done>
Booking list page renders with 5 status tabs, search input, HTML table with all columns, status badges, and links to booking detail. Empty states and loading state handled.
</done>
</task>

<task type="auto">
  <name>Task 2: Booking detail page with actions, timeline, and WhatsApp</name>
  <files>
    apps/backoffice/app/(dashboard)/accommodations/bookings/[id]/page.tsx
    apps/backoffice/components/accommodations/BookingActions.tsx
    apps/backoffice/components/accommodations/BookingTimeline.tsx
  </files>
  <action>
Create `apps/backoffice/components/accommodations/BookingActions.tsx` as a 'use client' component:
- Props: `{ bookingId: string; currentStatus: string; onAction: (action: string, reason?: string) => Promise<void>; loading: boolean }`
- Renders contextual buttons based on currentStatus:
  - `pending` or `pending_payment`: "Confirm" (green, CheckCircle icon) + "Decline" (red, XCircle icon)
  - `confirmed`: "Check In" (blue, SignIn icon) + "Cancel" (red, XCircle icon)
  - `checked_in`: "Check Out" (gray, SignOut icon) + "Cancel" (red, XCircle icon)
  - `checked_out` or `cancelled`: No action buttons (read-only)
- For decline/cancel: Show a text input for reason (required for decline, optional for cancel) using a simple inline expandable form. When user clicks Decline/Cancel, expand a reason textarea + Confirm button below.
- Buttons use Phosphor Icons with `weight="bold"` for clarity.
- Disable all buttons while `loading` is true.

Create `apps/backoffice/components/accommodations/BookingTimeline.tsx`:

- Props: `{ booking: BookingDetail }` (uses created_at, status, actual_check_in, actual_check_out, cancellation_reason)
- Renders a vertical timeline with dots and lines:
  - "Booking created" — created_at date
  - Status-specific entries based on current status (confirmed, checked_in, checked_out, cancelled)
  - If cancelled: show cancellation_reason in red text
- Simple Tailwind styling: vertical line with colored dots.

Create `apps/backoffice/app/(dashboard)/accommodations/bookings/[id]/page.tsx` as a 'use client' component:

**Data fetching:**

- On mount, fetch `GET /api/accommodations/bookings/{id}` with auth header.
- Store full booking detail in state.

**Layout:**

- Back link to `/accommodations/bookings` at top (ArrowLeft icon + "Back to bookings").
- Page title: "Booking {booking_code}" with status badge.

**Sections (use cards with white bg, shadow-sm, rounded-lg, p-6):**

1. **Guest Info card:**
   - Name, email, phone
   - "Contact via WhatsApp" button using `buildWhatsAppUrl(guest_phone, preformattedMessage)` from helpers.
   - Pre-formatted message: "Hi {guest_name}, regarding your booking {booking_code} at {property_name}..."

2. **Stay Details card:**
   - Room number + type
   - Check-in / Check-out dates
   - Number of nights, number of guests
   - Special requests (if any, in italic)

3. **Payment card:**
   - Payment method (cash, bank_transfer, stripe_card, crypto)
   - Payment status badge
   - Total price, deposit amount, deposit percent
   - For bank_transfer with pending payment: show "Confirm Payment" / "Reject Payment" buttons (call PATCH with action 'confirm' mapped to confirmed status)

4. **Actions card:**
   - Render `<BookingActions>` component

5. **Timeline card:**
   - Render `<BookingTimeline>` component

**WhatsApp owner notification (OBOOK-06):**

- In the Guest Info card, add a prominent "Send WhatsApp to Owner" button that opens `wa.me/{ownerPhone}?text={newBookingMessage}`.
- Build the message: "New booking {booking_code}: {guest_name} from {check_in} to {check_out}, {num_nights} nights. Room: {room_type}."
- The owner phone comes from the property data. Fetch property data alongside booking, or include it in the booking detail API response. Simplest: add a separate fetch to `/api/accommodations/property?propertyId={booking.property_id}` on mount.

**Error handling:**

- If booking not found: show "Booking not found" with back link.
- If API error: show error message with retry button.
  </action>
  <verify>
  TypeScript compiles: `cd apps/backoffice && npx tsc --noEmit --pretty 2>&1 | head -30`.
  </verify>
  <done>
  Booking detail page shows all booking information in organized cards. BookingActions renders contextual buttons with status transition validation. BookingTimeline shows visual history. WhatsApp deep-link enables owner notification for new bookings. Decline/cancel actions collect a reason.
  </done>
  </task>

</tasks>

<verification>
1. Booking list page loads and shows tab bar with counts
2. Search filters bookings by name or code
3. Clicking a booking navigates to detail page
4. Detail page shows all 5 sections (guest, stay, payment, actions, timeline)
5. Action buttons change based on booking status
6. Cancel/decline shows reason input
7. WhatsApp button generates correct wa.me URL
8. TypeScript compiles: `cd apps/backoffice && npx tsc --noEmit`
</verification>

<success_criteria>

- Booking list with tab filtering, search, and table renders correctly
- Booking detail shows all booking info with contextual actions
- Status transitions fire PATCH requests with correct action/reason
- WhatsApp deep-link works for owner notification
- Zero TypeScript errors
  </success_criteria>

<output>
After completion, create `.planning/phases/21-owner-dashboard-bookings-property/21-02-SUMMARY.md`
</output>
