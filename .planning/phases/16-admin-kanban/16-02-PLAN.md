---
phase: 16-admin-kanban
plan: 02
type: execute
wave: 2
depends_on: ['16-01']
files_modified:
  - apps/backoffice/components/feedback-kanban/TaskDetailPanel.tsx
  - apps/backoffice/components/feedback-kanban/StatusChangeDialog.tsx
  - apps/backoffice/components/feedback-kanban/KanbanBoard.tsx
  - apps/backoffice/app/(dashboard)/platform/feedback-tasks/page.tsx
autonomous: true

must_haves:
  truths:
    - 'Admin can click a task card to open a detail panel showing all linked submissions with both original and translated text'
    - 'Moving a task to Done or Rejected creates notifications for every merchant who submitted a linked feedback'
    - 'Admin sees a confirmation dialog before Done/Rejected moves that explains notification will be sent'
  artifacts:
    - path: 'apps/backoffice/components/feedback-kanban/TaskDetailPanel.tsx'
      provides: 'Slide-over panel with task metadata and linked submissions'
      min_lines: 80
    - path: 'apps/backoffice/components/feedback-kanban/StatusChangeDialog.tsx'
      provides: 'Radix confirmation dialog for Done/Rejected status changes'
      min_lines: 40
  key_links:
    - from: 'apps/backoffice/components/feedback-kanban/TaskDetailPanel.tsx'
      to: '/api/feedback/tasks/[id]/submissions'
      via: 'fetch on panel open'
      pattern: 'fetch.*api/feedback/tasks.*submissions'
    - from: 'apps/backoffice/components/feedback-kanban/KanbanBoard.tsx'
      to: 'StatusChangeDialog'
      via: 'Done/Rejected drag triggers dialog instead of confirm()'
      pattern: 'StatusChangeDialog'
    - from: 'apps/backoffice/components/feedback-kanban/KanbanBoard.tsx'
      to: 'TaskDetailPanel'
      via: 'selectedTask state opens panel'
      pattern: 'TaskDetailPanel'
---

<objective>
Add task detail panel, proper status change confirmation dialog, and wire everything together in the kanban board.

Purpose: Admins need to see linked submissions with original and translated text, and receive clear confirmation before triggering merchant notifications on status changes.
Output: Slide-over detail panel showing submissions, Radix confirmation dialog for Done/Rejected moves, fully integrated kanban board.
</objective>

<execution_context>
@/Users/gianfrancodagostino/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gianfrancodagostino/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-admin-kanban/16-RESEARCH.md
@.planning/phases/16-admin-kanban/16-01-SUMMARY.md

Key prior work from 16-01:

- KanbanBoard.tsx exists with DndContext, DragOverlay, optimistic updates, task fetching
- TaskCard.tsx exists with useDraggable, priority badge, sentiment, languages
- KanbanColumn.tsx exists with useDroppable
- API routes exist: GET/PATCH /api/feedback/tasks, GET /api/feedback/tasks/[id], GET /api/feedback/tasks/[id]/submissions
- page.tsx shell exists at /platform/feedback-tasks
- Done/Rejected currently uses browser confirm() -- upgrade to Radix Dialog
- KanbanBoard accepts onTaskClick callback (not yet wired to detail panel)
- Radix Dialog component at apps/backoffice/components/ui/dialog.tsx
- Phosphor Icons preferred for new components (duotone weight)
  </context>

<tasks>

<task type="auto">
  <name>Task 1: TaskDetailPanel slide-over and StatusChangeDialog</name>
  <files>
    apps/backoffice/components/feedback-kanban/TaskDetailPanel.tsx
    apps/backoffice/components/feedback-kanban/StatusChangeDialog.tsx
  </files>
  <action>
Create the task detail slide-over panel and the confirmation dialog for terminal status changes.

**TaskDetailPanel.tsx** ('use client'):

Props: task (FeedbackTask | null), onClose (() => void), onStatusChange ((taskId: string, newStatus: string) => void)

When task is not null (panel is open):

1. Fetch submissions from GET /api/feedback/tasks/{task.id}/submissions on open (useEffect with task.id dependency)
2. Show loading state while fetching submissions

Layout (slide-over, right-side):

- Fixed overlay: backdrop div (fixed inset-0 z-40 bg-black/20, onClick={onClose})
- Panel div: fixed inset-y-0 right-0 z-50 w-full max-w-lg overflow-y-auto bg-white shadow-xl
- Animate in with transition-transform (translate-x-0 when open, translate-x-full when closed -- use a simple state or CSS class)

Panel content (p-6):

- Header row: task title (text-lg font-semibold), close button (X icon from Phosphor, onClick={onClose})
- Metadata section:
  - Type badge (same style as card)
  - Priority badge (same PriorityBadge component or inline)
  - Status badge (current status with column color)
  - Tags as pills (if task.tags.length > 0)
  - Dates: "First submitted: {relative}", "Last activity: {relative}" using formatDistanceToNow from date-fns
  - Submission count and languages
- Divider (border-t my-4)
- Status action buttons row: Show buttons for valid next statuses. For example, if status is 'new', show "Start Reviewing" button. If 'reviewing', show "Start Working" and "Reject". If 'in_progress', show "Mark Done" and "Reject". If 'done' or 'rejected', show no action buttons (or a "Reopen" button that moves back to 'reviewing'). Call onStatusChange with appropriate status.
- Divider
- "Linked Submissions" heading with count
- For each submission:
  - Card with border, rounded, p-4, mb-3
  - Header: original_title (if exists), detected_language badge, date (relative)
  - "Original:" label, then original_body in a gray background block (whitespace-pre-wrap)
  - "Translated:" label (only if translated_body differs from original_body), then translated_body in a slightly different background
  - Screenshot link/thumbnail if screenshot_url exists (simple link, not inline image)
  - Sentiment and priority indicators (small, subtle)

If task is null, render nothing.

**StatusChangeDialog.tsx** ('use client'):

Props: open (boolean), onOpenChange ((open: boolean) => void), targetStatus (string), taskTitle (string), submissionCount (number), onConfirm (() => void)

Use Radix Dialog from '@/components/ui/dialog' (Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription, DialogFooter).

Content:

- Title: "Move task to {targetStatus}?"
- Description: For Done: "This will notify {submissionCount} merchant(s) that their feedback has been resolved." For Rejected: "This will notify {submissionCount} merchant(s) that their feedback was not accepted."
- Optional textarea for resolution note (resolutionNote state, passed up via onConfirm callback -- modify onConfirm to accept optional note string)
- Footer: Cancel button (closes dialog), Confirm button (calls onConfirm with resolutionNote, styled red for Rejected, green for Done)

This dialog replaces the browser confirm() used in Plan 16-01 for Done/Rejected moves.
</action>
<verify>
TypeScript compilation passes. TaskDetailPanel renders correctly with proper imports from date-fns and Phosphor Icons. StatusChangeDialog uses Radix Dialog components from @/components/ui/dialog.
</verify>
<done>
TaskDetailPanel shows as a slide-over with task metadata, status action buttons, and a list of linked submissions with original and translated text. StatusChangeDialog shows a Radix confirmation dialog explaining that merchants will be notified, with optional resolution note textarea.
</done>
</task>

<task type="auto">
  <name>Task 2: Wire detail panel and status dialog into KanbanBoard and page</name>
  <files>
    apps/backoffice/components/feedback-kanban/KanbanBoard.tsx
    apps/backoffice/app/(dashboard)/platform/feedback-tasks/page.tsx
  </files>
  <action>
Integrate the TaskDetailPanel and StatusChangeDialog into the existing KanbanBoard from Plan 16-01.

**KanbanBoard.tsx updates:**

1. Import TaskDetailPanel and StatusChangeDialog
2. Add state:
   - selectedTask: FeedbackTask | null (for detail panel)
   - pendingMove: { taskId: string, newStatus: string } | null (for confirmation dialog)
3. Wire onTaskClick: when a card is clicked, set selectedTask to that task
4. Upgrade Done/Rejected drag handling:
   - Remove the browser confirm() call
   - Instead, when onDragEnd detects a move to 'done' or 'rejected':
     - Store the pending move in pendingMove state (do NOT apply optimistic update yet)
     - This opens the StatusChangeDialog
   - When StatusChangeDialog confirms:
     - Apply optimistic update (move card in local state)
     - Call PATCH /api/feedback/tasks with taskId, status, and optional resolutionNote
     - Clear pendingMove
     - On failure, revert and show error
   - When StatusChangeDialog cancels:
     - Clear pendingMove (card stays in original column)
5. Wire detail panel status change buttons:
   - TaskDetailPanel's onStatusChange callback should:
     - For done/rejected: trigger StatusChangeDialog (same pendingMove flow)
     - For other statuses: apply optimistic update + PATCH directly (no confirmation needed)
     - After successful status change from panel, update the task in local state so the panel reflects the new status
6. Render TaskDetailPanel and StatusChangeDialog at the bottom of the component:
   ```tsx
   <TaskDetailPanel
     task={selectedTask}
     onClose={() => setSelectedTask(null)}
     onStatusChange={handleStatusChangeFromPanel}
   />
   <StatusChangeDialog
     open={!!pendingMove}
     onOpenChange={(open) => { if (!open) setPendingMove(null); }}
     targetStatus={pendingMove?.newStatus || ''}
     taskTitle={tasks.find(t => t.id === pendingMove?.taskId)?.title || ''}
     submissionCount={tasks.find(t => t.id === pendingMove?.taskId)?.submission_count || 0}
     onConfirm={handleConfirmedStatusChange}
   />
   ```

**page.tsx updates (if needed):**

The page shell should already render KanbanBoard. If any layout adjustments are needed for the slide-over panel to work (e.g., ensuring the page has no overflow-hidden that would clip the fixed panel), make those adjustments. The panel uses fixed positioning so it should work regardless, but verify the page layout doesn't interfere.

No other page changes expected -- the KanbanBoard manages all state internally.
</action>
<verify>
TypeScript compilation passes. KanbanBoard imports and renders both TaskDetailPanel and StatusChangeDialog. The browser confirm() from 16-01 is removed and replaced with StatusChangeDialog. Clicking a card opens the detail panel. Done/Rejected moves show the Radix dialog.
</verify>
<done>
Clicking a task card opens the slide-over detail panel showing task metadata and all linked submissions with original + translated text. Dragging to Done/Rejected opens a Radix confirmation dialog with resolution note option. Status changes from the detail panel also flow through the same confirmation/optimistic-update logic. The kanban board is fully functional with all five requirements met.
</done>
</task>

</tasks>

<verification>
1. TypeScript: `cd apps/backoffice && npx tsc --noEmit` passes
2. Detail panel: clicking a card opens slide-over, shows submissions fetched from /api/feedback/tasks/[id]/submissions
3. Submissions display: each submission shows original_body and translated_body (when different)
4. Status dialog: Done/Rejected moves show Radix Dialog with notification warning and resolution note textarea
5. No browser confirm(): the confirm() from 16-01 is replaced with StatusChangeDialog
6. Panel actions: status change buttons in detail panel trigger same flow (dialog for terminal states, direct for others)
7. State sync: after status change from panel, local task state updates and panel reflects new status
</verification>

<success_criteria>

- Admin clicks a task card and sees a slide-over panel with task metadata, action buttons, and linked submissions
- Each submission shows original text and translated text (when translation exists)
- Moving task to Done or Rejected (via drag or panel button) shows Radix confirmation dialog
- Dialog explains notification impact and allows optional resolution note
- After confirmation, status updates optimistically and notifications fire server-side
- All five FBADM requirements (01-05) are satisfied
  </success_criteria>

<output>
After completion, create `.planning/phases/16-admin-kanban/16-02-SUMMARY.md`
</output>
