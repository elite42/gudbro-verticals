---
phase: 04-database-foundation
plan: 02
type: execute
wave: 2
depends_on: ['04-01']
files_modified:
  - shared/database/migrations/schema/078-accommodations-seed.sql
autonomous: true

must_haves:
  truths:
    - "One demo property 'Roots Da Nang' exists with WiFi credentials, host contact, amenities, and house rules"
    - '3 rooms exist (Studio 101, Suite 201, Deluxe 301) linked to the demo property'
    - '2 bookings exist: one current (BK-T3ST01) for testing dashboard access, one future (BK-F8TR02)'
    - '3 service categories exist: Breakfast, Minibar, Laundry with correct display order'
    - '~12 service items exist across categories with realistic VND prices'
    - '3 local partnerships exist via partner_conventions: restaurant, tour operator, airport transfer'
    - '3 minimal merchant records exist for the partner businesses (required by partner_conventions FK)'
    - "verify_booking_access('BK-T3ST01', 'Smith') returns valid result for the current booking"
  artifacts:
    - path: 'shared/database/migrations/schema/078-accommodations-seed.sql'
      provides: 'Demo data for Da Nang property with rooms, bookings, services, and partnerships'
      contains: 'Roots Da Nang'
  key_links:
    - from: 'accom_bookings.property_id'
      to: 'accom_properties.id'
      via: 'FK value match'
      pattern: 'a1b2c3d4-e5f6-7890-abcd-ef1234567890'
    - from: 'partner_conventions.partner_id'
      to: 'accom_properties.id'
      via: 'FK value match'
      pattern: 'partner_type.*accommodation'
    - from: 'partner_conventions.merchant_id'
      to: 'merchants.id'
      via: 'FK value match'
      pattern: 'INSERT INTO merchants'
---

<objective>
Seed the accommodations database with one complete demo property: "Roots Da Nang" in Vietnam, with rooms, bookings, services, and local partnership deals.

Purpose: Provides testable data for the API layer (Phase 5) and frontend integration (Phase 6). The current booking (BK-T3ST01) allows testing the full guest verification flow. The future booking tests state handling.

Output: `shared/database/migrations/schema/078-accommodations-seed.sql` with all demo data.
</objective>

<execution_context>
@/Users/gianfrancodagostino/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gianfrancodagostino/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-database-foundation/04-RESEARCH.md
@.planning/phases/04-database-foundation/04-CONTEXT.md
@.planning/phases/04-database-foundation/04-01-SUMMARY.md
@shared/database/migrations/schema/077-accommodations-schema.sql
@shared/database/migrations/schema/050-b2b-conventions.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create seed data migration</name>
  <files>shared/database/migrations/schema/078-accommodations-seed.sql</files>
  <action>
Create migration file `078-accommodations-seed.sql` with demo data. Use the same header comment pattern as other migrations. All UUID values must use only hex characters (0-9, a-f).

**Use hardcoded UUIDs for all records** so they can be referenced across inserts and in tests. Use a consistent naming pattern:

- Property: `a1b2c3d4-e5f6-7890-abcd-ef1234567890`
- Rooms: `aa..01`, `aa..02`, `aa..03` pattern
- Bookings: `bb..01`, `bb..02` pattern
- Categories: `cc..01`, `cc..02`, `cc..03` pattern
- Items: `dd..01` through `dd..12` pattern

**Section 1: Demo Property**

Insert into `accom_properties`:

- id: `a1b2c3d4-e5f6-7890-abcd-ef1234567890`
- name: 'Roots Da Nang'
- slug: 'roots-danang'
- description: 'Modern tourist apartment in the heart of Da Nang, steps from My Khe Beach. Perfect base for exploring Central Vietnam.'
- tagline: 'Your home in Da Nang'
- property_type: 'apartment'
- address: '234 Vo Nguyen Giap, Son Tra District'
- city: 'Da Nang'
- country_code: 'VN'
- timezone: 'Asia/Ho_Chi_Minh'
- host_name: 'Nguyen Van Minh'
- host_phone: '+84905123456'
- host_email: 'minh@rootsdanang.com'
- emergency_phone: '+84905999888'
- wifi_ssid: 'Roots-Guest-5G'
- wifi_password: 'welcome2danang'
- currency: 'VND'
- default_language: 'en'
- supported_languages: '{"en","vi"}'
- check_in_time: '14:00'
- check_out_time: '11:00'
- images: '[]' (placeholder)
- amenities: '["wifi", "air_conditioning", "kitchen", "washing_machine", "beach_access", "motorbike_parking", "rooftop_terrace"]'
- house_rules: 'No smoking indoors. Quiet hours 22:00-07:00. No parties. Shoes off at entrance. Trash separation required.'
- owner_id: NULL (no owner account in demo -- will be linked when backoffice is built)
- is_active: true

**Section 2: Rooms**

Insert 3 rooms into `accom_rooms`:

1. Room 101 - Studio: room_type 'studio', capacity 2, floor '1', description 'Cozy studio with city view, queen bed, and kitchenette'
2. Room 201 - Suite: room_type 'suite', capacity 4, floor '2', description 'Spacious suite with ocean view, king bed, living area, and full kitchen'
3. Room 301 - Deluxe: room_type 'deluxe', capacity 2, floor '3', description 'Premium room with panoramic beach view, king bed, and balcony'

Use deterministic UUIDs for each room.

**Section 3: Bookings**

Insert 2 bookings into `accom_bookings`:

1. **Current booking** (for testing dashboard):
   - booking_code: 'BK-T3ST01' (hardcoded, not auto-generated)
   - guest_name: 'John Smith'
   - guest_last_name: 'Smith'
   - guest_email: 'john.smith@example.com'
   - guest_phone: '+1555123456'
   - guest_count: 2
   - check_in_date: CURRENT_DATE - INTERVAL '2 days' (already checked in)
   - check_out_date: CURRENT_DATE + INTERVAL '5 days' (still active)
   - status: 'checked_in'
   - room_id: Room 201 (Suite)
   - booking_source: 'airbnb'
   - special_requests: 'Late check-in, extra towels please'

2. **Future booking** (for testing states):
   - booking_code: 'BK-F8TR02' (hardcoded)
   - guest_name: 'Maria Garcia'
   - guest_last_name: 'Garcia'
   - guest_email: 'maria.garcia@example.com'
   - guest_phone: '+34612345678'
   - guest_count: 1
   - check_in_date: CURRENT_DATE + INTERVAL '14 days'
   - check_out_date: CURRENT_DATE + INTERVAL '21 days'
   - status: 'confirmed'
   - room_id: Room 301 (Deluxe)
   - booking_source: 'direct'

**Section 4: Service Categories**

Insert 3 categories into `accom_service_categories`:

1. Breakfast: slug 'breakfast', icon 'CookingPot', display_order 1
2. Minibar: slug 'minibar', icon 'Wine', display_order 2
3. Laundry: slug 'laundry', icon 'TShirt', display_order 3

All linked to the demo property.

**Section 5: Service Items**

Insert into `accom_service_items`. Prices in VND (whole units, no cents -- VND has no subunits).

Breakfast items (category: breakfast):

1. 'Vietnamese Pho' - 'Traditional beef noodle soup with herbs' - 65000 VND
2. 'Banh Mi Sandwich' - 'Classic Vietnamese baguette with pork and pickled vegetables' - 35000 VND
3. 'Fresh Fruit Plate' - 'Seasonal tropical fruits: mango, dragon fruit, pineapple' - 45000 VND
4. 'Egg and Toast Set' - 'Two eggs any style with toast, butter, and jam' - 40000 VND

- available_from: '07:00', available_until: '10:30', is_always_available: false

Minibar items (category: minibar, is_always_available: true):

1. 'Local Beer (333)' - 'Vietnamese lager, 330ml can' - 25000 VND
2. 'Coca-Cola' - '330ml can' - 15000 VND
3. 'Bottled Water' - 'Pure spring water, 500ml' - 10000 VND
4. 'Saigon Special' - 'Premium Vietnamese beer, 330ml bottle' - 30000 VND
5. 'Fresh Coconut Water' - 'Young coconut, 500ml' - 20000 VND
6. 'Instant Coffee Sachets' - 'Vietnamese G7 coffee, pack of 3' - 12000 VND

Laundry items (category: laundry, is_always_available: true):

1. 'Wash and Fold (per kg)' - 'Standard laundry service, returned same day' - 30000 VND
2. 'Iron Only (per item)' - 'Professional pressing service' - 15000 VND
3. 'Express Wash and Fold' - 'Returned within 3 hours, per kg' - 50000 VND

**Section 6: Local Partnership Merchants**

Insert 3 minimal merchant records into `merchants` table for the partner businesses. These need to exist because `partner_conventions.merchant_id` has FK to `merchants(id)`.

Use deterministic UUIDs. Include only required columns (check the merchants table structure for NOT NULL constraints -- typically: id, name, slug, and any other NOT NULL fields). Set minimal values for required fields.

IMPORTANT: Before writing the merchants INSERTs, READ `shared/database/_system/schema/001-menu-management.sql` to find the exact merchants table structure and NOT NULL constraints. Only include required columns.

1. 'Madame Lan Restaurant' - slug: 'madame-lan-danang'
2. 'Hai Van Adventures' - slug: 'hai-van-adventures'
3. 'Da Nang Airport Transfer' - slug: 'danang-airport-transfer'

**Section 7: Partner Conventions**

Insert 3 records into `partner_conventions` linking merchants to the property.

CRITICAL -- relationship direction:

- merchant_id = the local business (restaurant, tour op, transport)
- partner_type = 'accommodation'
- partner_id = the property UUID (a1b2c3d4-e5f6-7890-abcd-ef1234567890)
- partner_name = 'Roots Da Nang'

IMPORTANT: Before writing the partner_conventions INSERTs, READ `shared/database/migrations/schema/050-b2b-conventions.sql` to find the exact column names and constraints. Match them exactly.

1. Madame Lan Restaurant deal:
   - convention_name: '10% Guest Discount'
   - description: '10% off for Roots Da Nang guests. Show your booking confirmation.'

2. Hai Van Adventures deal:
   - convention_name: 'Exclusive Hai Van Pass Tour'
   - description: 'Motorbike tour of Hai Van Pass. $45 instead of $55 for our guests.'

3. Airport Transfer deal:
   - convention_name: 'Airport Shuttle'
   - description: 'Private airport transfer 250,000 VND (regular 350,000). Book via WhatsApp.'

**Section 8: Verification comment**

Add a comment block at the end:

```sql
-- ============================================================================
-- VERIFICATION QUERIES
-- ============================================================================
-- Test booking access (current booking -- should return valid):
--   SELECT * FROM verify_booking_access('BK-T3ST01', 'Smith');
--   Expected: is_valid = true, property_id = a1b2c3d4-..., guest_name = 'John Smith'
--
-- Test booking access (future booking -- should return invalid):
--   SELECT * FROM verify_booking_access('BK-F8TR02', 'Garcia');
--   Expected: is_valid = false (future booking, check_in_date > CURRENT_DATE)
--
-- Test booking access (wrong last name -- should return invalid):
--   SELECT * FROM verify_booking_access('BK-T3ST01', 'Wrong');
--   Expected: is_valid = false (wrong last name)
--
-- Count seed data:
--   SELECT 'properties' AS entity, COUNT(*) FROM accom_properties
--   UNION ALL SELECT 'rooms', COUNT(*) FROM accom_rooms
--   UNION ALL SELECT 'bookings', COUNT(*) FROM accom_bookings
--   UNION ALL SELECT 'categories', COUNT(*) FROM accom_service_categories
--   UNION ALL SELECT 'items', COUNT(*) FROM accom_service_items;
-- ============================================================================
```

  </action>
  <verify>
Review the SQL file for:
1. Property insert with all required fields, WiFi credentials, amenities
2. 3 room inserts linked to property UUID
3. 2 booking inserts with hardcoded codes BK-T3ST01 and BK-F8TR02
4. Current booking has check_in_date in the past (CURRENT_DATE - 2 days)
5. 3 service category inserts with correct display_order
6. ~12 service item inserts with realistic VND prices (no cents)
7. 3 merchant inserts with only required columns
8. 3 partner_conventions inserts with correct relationship direction (merchant_id = business, partner_id = property)
9. All UUID values use only hex characters (0-9, a-f)
10. PostgreSQL array syntax used ('{"en","vi"}' not '["en","vi"]')
11. Foreign key values match across inserts
  </verify>
  <done>Demo property "Roots Da Nang" exists with 3 rooms, 2 bookings (one testable now), 3 service categories, ~12 items, and 3 local partnerships via conventions system. verify_booking_access('BK-T3ST01', 'Smith') returns valid result.</done>
</task>

</tasks>

<verification>
1. File `shared/database/migrations/schema/078-accommodations-seed.sql` exists
2. Property "Roots Da Nang" with all fields populated
3. 3 rooms with correct types and capacities
4. 2 bookings with booking codes BK-T3ST01 (current) and BK-F8TR02 (future)
5. 3 service categories (Breakfast, Minibar, Laundry)
6. ~12 service items with VND prices
7. 3 merchant records for partner businesses
8. 3 partner_conventions linking merchants to property
9. All UUIDs valid hex
10. All FK references match
</verification>

<success_criteria>

- 078-accommodations-seed.sql inserts complete demo data for one property
- Current booking (BK-T3ST01) is testable with verify_booking_access immediately
- Future booking (BK-F8TR02) correctly returns invalid (not yet checked in)
- Local partnerships correctly use conventions system with reversed relationship direction
- All prices in VND whole units (no cents)
- Merchant records exist for FK satisfaction
  </success_criteria>

<output>
After completion, create `.planning/phases/04-database-foundation/04-02-SUMMARY.md`
</output>
