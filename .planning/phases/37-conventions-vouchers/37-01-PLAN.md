---
phase: 37-conventions-vouchers
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - shared/database/migrations/schema/099-conventions-benefit-scope.sql
  - apps/accommodations/frontend/types/property.ts
  - apps/accommodations/frontend/lib/price-utils.ts
  - apps/accommodations/frontend/app/api/booking/validate-voucher/route.ts
  - apps/accommodations/frontend/app/api/booking/route.ts
  - apps/accommodations/frontend/components/booking/VoucherInput.tsx
  - apps/accommodations/frontend/hooks/useBookingForm.ts
  - apps/accommodations/frontend/lib/booking-api.ts
autonomous: true

must_haves:
  truths:
    - 'Guest can enter a voucher code in the booking form and see a discount preview before submitting'
    - 'Invalid/expired/used voucher codes show clear error messages'
    - 'Server re-validates voucher on booking submission so discount cannot be faked client-side'
    - 'benefit_scope column exists on partner_conventions with per_order/per_night/per_stay/flat options'
    - 'Voucher discount is applied AFTER existing weekly/monthly discounts and never exceeds subtotal'
  artifacts:
    - path: 'shared/database/migrations/schema/099-conventions-benefit-scope.sql'
      provides: 'benefit_scope column + validate_accommodation_voucher() RPC'
      contains: 'benefit_scope'
    - path: 'apps/accommodations/frontend/app/api/booking/validate-voucher/route.ts'
      provides: 'POST endpoint for client-side voucher preview validation'
      exports: ['POST']
    - path: 'apps/accommodations/frontend/components/booking/VoucherInput.tsx'
      provides: 'Voucher code input with apply/remove/loading/error states'
      min_lines: 50
    - path: 'apps/accommodations/frontend/hooks/useBookingForm.ts'
      provides: 'Voucher state (code, discount, details) integrated into booking form'
      contains: 'voucherCode'
  key_links:
    - from: 'apps/accommodations/frontend/components/booking/VoucherInput.tsx'
      to: '/api/booking/validate-voucher'
      via: 'fetch POST on apply'
      pattern: 'api/booking/validate-voucher'
    - from: 'apps/accommodations/frontend/app/api/booking/route.ts'
      to: 'validate_accommodation_voucher RPC'
      via: 'supabase.rpc server-side re-validation'
      pattern: 'validate_accommodation_voucher'
    - from: 'apps/accommodations/frontend/hooks/useBookingForm.ts'
      to: 'price-utils calculatePriceBreakdown'
      via: 'voucherDiscount subtracted from totalPrice'
      pattern: 'voucherDiscount'
---

<objective>
Add benefit_scope column to partner_conventions, create validate_accommodation_voucher() RPC, and integrate voucher code validation into the accommodations booking flow with client preview and server-authoritative re-validation.

Purpose: Enables accommodation guests to redeem convention vouchers during booking with scope-aware discount calculation (per_order, per_night, per_stay, flat).
Output: Migration 099, voucher validation API, VoucherInput component, updated booking form hook and route.
</objective>

<execution_context>
@/Users/gianfrancodagostino/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gianfrancodagostino/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/37-conventions-vouchers/37-RESEARCH.md

Key source files:
@shared/database/migrations/schema/050-b2b-conventions.sql
@apps/accommodations/frontend/hooks/useBookingForm.ts
@apps/accommodations/frontend/app/api/booking/route.ts
@apps/accommodations/frontend/lib/price-utils.ts
@apps/accommodations/frontend/lib/booking-api.ts
@apps/accommodations/frontend/types/property.ts
@apps/coffeeshop/frontend/components/v2/VoucherInput.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migration 099 - benefit_scope column + validate_accommodation_voucher() RPC</name>
  <files>shared/database/migrations/schema/099-conventions-benefit-scope.sql</files>
  <action>
Create migration 099 with:

1. ALTER TABLE partner_conventions ADD COLUMN benefit_scope:
   - Type: TEXT DEFAULT 'per_order'
   - CHECK constraint: benefit_scope IN ('per_order', 'per_night', 'per_stay', 'flat')
   - Add COMMENT explaining each scope value

2. CREATE OR REPLACE FUNCTION validate_accommodation_voucher() that:
   - Accepts: p_voucher_code TEXT, p_property_id UUID, p_num_nights INTEGER DEFAULT 1, p_subtotal INTEGER DEFAULT 0
   - Returns TABLE with: is_valid BOOLEAN, error_message TEXT, convention_id UUID, voucher_id UUID, benefit_type TEXT, benefit_value DECIMAL, benefit_scope TEXT, discount_amount INTEGER, partner_name TEXT, convention_name TEXT
   - Looks up voucher from convention_vouchers by code
   - Validates: voucher is_active, not expired (valid_until), usage limit (times_used < max_uses)
   - Looks up convention from partner_conventions by voucher.convention_id
   - Validates: convention is_active, partner_type = 'accommodation', partner_id = p_property_id
   - Validates: valid_from <= CURRENT_DATE AND (valid_until IS NULL OR valid_until >= CURRENT_DATE)
   - Calculates discount_amount based on benefit_scope:
     - For benefit_type = 'percentage_discount':
       - per_order: (p_subtotal \* benefit_value / 100)::INTEGER
       - per_night: (p_subtotal \* benefit_value / 100)::INTEGER (same as per_order for percentage)
       - per_stay: (p_subtotal \* benefit_value / 100)::INTEGER
       - flat: (p_subtotal \* benefit_value / 100)::INTEGER
     - For benefit_type = 'fixed_discount':
       - per_order: benefit_value::INTEGER (single flat amount)
       - per_night: (benefit_value \* p_num_nights)::INTEGER (multiplied by nights)
       - per_stay: benefit_value::INTEGER (single amount for entire stay)
       - flat: benefit_value::INTEGER (same as per_order)
   - Cap discount_amount to never exceed p_subtotal
   - Returns error rows with is_valid=false and descriptive error_message for each failure case
   - SECURITY DEFINER, LANGUAGE plpgsql
   - GRANT EXECUTE to authenticated

Do NOT modify the existing validate_voucher() function -- keep backward compatibility for coffeeshop.

Note: benefit_value in the DB is stored in DECIMAL(10,2). For fixed_discount types, the value represents the amount in the property's minor currency units (e.g., 500000 for 500,000 VND or 4500 for $45.00 USD). The RPC returns discount_amount as INTEGER minor units matching the subtotal format.
</action>
<verify>
Review SQL syntax: UUIDs are hex only, CHECK constraints use valid values, function signature matches return table, SECURITY DEFINER is set, GRANT is present. No ENUMs used (TEXT + CHECK pattern per project convention).
</verify>
<done>
Migration file exists at 099-conventions-benefit-scope.sql with benefit_scope column and validate_accommodation_voucher() RPC function. Existing validate_voucher() is untouched.
</done>
</task>

<task type="auto">
  <name>Task 2: Voucher validation API + booking flow integration + VoucherInput component</name>
  <files>
    apps/accommodations/frontend/types/property.ts
    apps/accommodations/frontend/lib/price-utils.ts
    apps/accommodations/frontend/app/api/booking/validate-voucher/route.ts
    apps/accommodations/frontend/app/api/booking/route.ts
    apps/accommodations/frontend/components/booking/VoucherInput.tsx
    apps/accommodations/frontend/hooks/useBookingForm.ts
    apps/accommodations/frontend/lib/booking-api.ts
  </files>
  <action>
**Types (property.ts):**
- Add `voucherCode?: string` to BookingSubmission interface
- Add `voucherDiscount?: number` and `voucherLabel?: string | null` to PriceBreakdown interface
- Add new interface `ValidatedVoucher`:
  ```ts
  export interface ValidatedVoucher {
    code: string;
    conventionId: string;
    voucherId: string;
    benefitType: string;
    benefitValue: number;
    benefitScope: string;
    discountAmount: number;
    partnerName: string;
    conventionName: string;
  }
  ```

**Price utils (price-utils.ts):**

- Add optional `voucherDiscount?: number` parameter to calculatePriceBreakdown
- Apply voucherDiscount AFTER existing discounts: `totalPrice = subtotal + cleaningFee - discountAmount - (voucherDiscount || 0)`
- Ensure totalPrice never goes below 0: `Math.max(0, totalPrice)`
- Add voucherDiscount and voucherLabel to returned PriceBreakdown

**Validate voucher API (validate-voucher/route.ts):**

- POST endpoint accepting `{ voucherCode: string, propertyId: string, numNights: number, subtotal: number }`
- Uses getSupabaseAdmin() to call RPC `validate_accommodation_voucher` with the parameters
- Returns { data: ValidatedVoucher } on success or { error: string } on failure
- No auth required (public endpoint for booking flow -- property page is public)

**Booking route (route.ts):**

- After price calculation, if body.voucherCode is present:
  - Call validate_accommodation_voucher RPC with (voucherCode, property.id, nights, priceBreakdown.subtotal)
  - If valid: subtract discount_amount from totalPrice (ensure >= 0), add voucherDiscount to booking insert
  - If invalid: return 400 with error 'invalid_voucher'
  - After successful insert, record redemption in convention_redemptions (voucher_id, convention_id, merchant_id from convention, order_id = booking.id, original_amount = subtotal, discount_amount, final_amount = totalPrice, verification_method = 'link', verification_code = voucherCode)
- Update the booking insert to include discount_amount that sums existing discount + voucher discount

**VoucherInput component (booking/VoucherInput.tsx):**

- Adapt from coffeeshop VoucherInput.tsx (same structure, same CSS variable pattern)
- Props: `{ propertyId: string, numNights: number, subtotal: number, onVoucherApplied: (voucher: ValidatedVoucher | null) => void, appliedVoucher: ValidatedVoucher | null, formatPrice: (amount: number) => string, disabled?: boolean }`
- On apply: POST to /api/booking/validate-voucher with code, propertyId, numNights, subtotal
- On success: call onVoucherApplied with result
- On remove: call onVoucherApplied(null)
- Use same visual pattern as coffeeshop: Phosphor icons (Ticket, Check, X, SpinnerGap, Tag, Percent), CSS variables, framer-motion animations
- Show applied state with discount amount and partner name

**useBookingForm hook:**

- Add state: `voucherDetails: ValidatedVoucher | null`, `voucherDiscount: number`
- Add `setVoucherDetails` function that updates both voucherDetails and voucherDiscount
- Update priceBreakdown useMemo to pass voucherDiscount to calculatePriceBreakdown
- Update handleSubmit to include voucherCode in submitBooking call
- Export voucherDetails, setVoucherDetails from hook return

**booking-api.ts:**

- submitBooking already sends BookingSubmission -- voucherCode will be included automatically from the updated type

IMPORTANT: The validate-voucher endpoint does NOT require auth because the property page (booking flow) is public. The property.id is passed in the body. The server-side re-validation in POST /api/booking uses the same admin client pattern.
</action>
<verify>
Run `cd /Users/gianfrancodagostino/Desktop/gudbro-verticals && npx tsc --noEmit -p apps/accommodations/frontend/tsconfig.json` to verify TypeScript compilation. Check that VoucherInput imports exist, API route exports POST, and useBookingForm returns voucher state.
</verify>
<done>
Voucher code can be entered in booking form, validated via API preview, discount shown in price breakdown, and server re-validates on submission. Invalid codes show error. Applied voucher shows green success state with discount amount and partner name.
</done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors for accommodations frontend
2. Migration 099 has valid SQL syntax (benefit_scope column + RPC function)
3. VoucherInput component renders with input field, apply button, loading/error/applied states
4. POST /api/booking/validate-voucher returns ValidatedVoucher on valid code, error on invalid
5. POST /api/booking re-validates voucher server-side and applies discount to total
6. PriceBreakdown includes voucherDiscount field
7. Voucher discount cannot make totalPrice negative
</verification>

<success_criteria>

- benefit_scope column added to partner_conventions schema
- validate_accommodation_voucher() RPC calculates scope-aware discounts
- Guest can enter voucher code in booking form and see preview discount
- Server re-validates voucher on booking submission (not client-trusted)
- Convention redemption is recorded after successful booking
- Existing validate_voucher() function unchanged (coffeeshop backward compat)
  </success_criteria>

<output>
After completion, create `.planning/phases/37-conventions-vouchers/37-01-SUMMARY.md`
</output>
