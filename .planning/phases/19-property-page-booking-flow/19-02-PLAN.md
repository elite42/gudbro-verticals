---
phase: 19-property-page-booking-flow
plan: 02
type: execute
wave: 2
depends_on: [19-01]
files_modified:
  - apps/accommodations/frontend/components/booking/PropertyGallery.tsx
  - apps/accommodations/frontend/components/booking/PropertyHeader.tsx
  - apps/accommodations/frontend/components/booking/PropertyDescription.tsx
  - apps/accommodations/frontend/components/booking/AmenityGrid.tsx
  - apps/accommodations/frontend/components/booking/HouseRules.tsx
  - apps/accommodations/frontend/components/booking/HostInfoCard.tsx
  - apps/accommodations/frontend/components/booking/LocationSection.tsx
  - apps/accommodations/frontend/components/booking/RoomSelector.tsx
  - apps/accommodations/frontend/components/booking/BookingCalendar.tsx
  - apps/accommodations/frontend/components/booking/PriceBreakdown.tsx
  - apps/accommodations/frontend/components/booking/BookingForm.tsx
  - apps/accommodations/frontend/components/booking/BookingConfirmation.tsx
  - apps/accommodations/frontend/hooks/useBookingForm.ts
autonomous: true

must_haves:
  truths:
    - 'Photo gallery is swipeable on mobile with touch gestures and has desktop arrow navigation'
    - 'Gallery supports tap-to-fullscreen via Radix Dialog with body scroll lock'
    - 'Photo counter shows current position (e.g., "3/12")'
    - 'Calendar shows unavailable dates as grayed out and non-selectable'
    - 'Calendar handles half-open date range: checkout day of existing booking is selectable for new check-in'
    - 'Price breakdown updates when dates are selected, showing per-night x nights + fees - discounts = total'
    - 'Booking form captures name, email, phone (with country code), guest count, and special requests'
    - 'Submit button text reflects booking mode: "Book Now" for instant, "Request to Book" for inquiry'
    - 'Confirmation screen shows booking code, summary, WhatsApp deep-link CTA, and email notice'
    - 'Multi-room properties show room selector cards; single-room properties auto-select'
  artifacts:
    - path: 'apps/accommodations/frontend/components/booking/PropertyGallery.tsx'
      provides: 'Embla Carousel gallery with fullscreen support'
    - path: 'apps/accommodations/frontend/components/booking/BookingCalendar.tsx'
      provides: 'React DayPicker inline calendar with booked date blocking'
    - path: 'apps/accommodations/frontend/components/booking/BookingForm.tsx'
      provides: 'Guest booking form with react-international-phone'
    - path: 'apps/accommodations/frontend/components/booking/BookingConfirmation.tsx'
      provides: 'Post-booking confirmation with WhatsApp CTA'
    - path: 'apps/accommodations/frontend/hooks/useBookingForm.ts'
      provides: 'Form state management, validation, and submission logic'
  key_links:
    - from: 'useBookingForm.ts'
      to: 'lib/property-api.ts fetchAvailability'
      via: 'Hook fetches booked ranges when selectedRoom changes, stores in state, passed to BookingCalendar as prop'
      pattern: 'fetchAvailability'
    - from: 'useBookingForm.ts'
      to: 'lib/booking-api.ts submitBooking'
      via: 'Form submission'
      pattern: 'submitBooking'
    - from: 'PriceBreakdown.tsx'
      to: 'lib/price-utils.ts calculatePriceBreakdown'
      via: 'Client-side price preview'
      pattern: 'calculatePriceBreakdown'
---

<objective>
Create all client-side React components for the property page and booking flow: photo gallery, property information sections, date calendar, price breakdown, booking form, and confirmation screen.

Purpose: These are the interactive "islands" that render inside the server-rendered property page. Each component is a self-contained 'use client' module that handles its own state and interactions. Plan 19-03 will compose them into the final page.
Output: 12 client components + 1 custom hook.
</objective>

<execution_context>
@/Users/gianfrancodagostino/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gianfrancodagostino/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-property-page-booking-flow/19-RESEARCH.md
@.planning/phases/19-property-page-booking-flow/19-CONTEXT.md

# Types created in Plan 19-01

@apps/accommodations/frontend/types/property.ts

# Lib utilities created in Plan 19-01

@apps/accommodations/frontend/lib/price-utils.ts
@apps/accommodations/frontend/lib/property-api.ts
@apps/accommodations/frontend/lib/booking-api.ts

# Existing component patterns

@apps/accommodations/frontend/components/stay/WifiCard.tsx
@apps/accommodations/frontend/components/stay/ServicesCarousel.tsx

# Design system (Tailwind config, CSS variables)

@apps/accommodations/frontend/tailwind.config.ts
@apps/accommodations/frontend/styles/globals.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PropertyGallery component</name>
  <files>apps/accommodations/frontend/components/booking/PropertyGallery.tsx</files>
  <action>
Create `apps/accommodations/frontend/components/booking/PropertyGallery.tsx` -- the hero swipeable photo gallery.

Requirements:

- `'use client';` directive
- Uses `embla-carousel-react` for swipeable carousel
- Loop enabled for continuous swiping
- Photo counter indicator (e.g., "3/12") bottom-right with semi-transparent background
- Desktop navigation arrows (hidden on mobile via `hidden md:block`)
- Tap on image opens fullscreen overlay using Radix Dialog (`@radix-ui/react-dialog`)
- Fullscreen overlay: same Embla carousel instance, larger images, close button
- Radix Dialog handles body scroll lock automatically
- First image loaded eagerly, rest lazy
- Images use `object-cover` with responsive heights: `h-64 sm:h-80 md:h-96`
- Uses Phosphor Icons for arrows (CaretLeft, CaretRight) and close (X)
- Handles edge case: single image (no counter, no arrows)
- Handles edge case: no images (show placeholder with House icon)

Follow the code example from 19-RESEARCH.md (Embla Carousel Gallery Component) but add the fullscreen Radix Dialog overlay.

Props:

```typescript
interface PropertyGalleryProps {
  images: string[];
  propertyName: string;
}
```

</action>
<verify>
1. `cat apps/accommodations/frontend/components/booking/PropertyGallery.tsx` -- file exists
2. `grep "use client" apps/accommodations/frontend/components/booking/PropertyGallery.tsx` -- client component
3. `grep "useEmblaCarousel\|embla-carousel" apps/accommodations/frontend/components/booking/PropertyGallery.tsx` -- uses Embla
4. `grep "Dialog" apps/accommodations/frontend/components/booking/PropertyGallery.tsx` -- uses Radix Dialog for fullscreen
5. `grep "CaretLeft\|CaretRight" apps/accommodations/frontend/components/booking/PropertyGallery.tsx` -- Phosphor icons
6. `grep "currentIndex.*images.length\|images.length" apps/accommodations/frontend/components/booking/PropertyGallery.tsx` -- counter logic
</verify>
<done>PropertyGallery component created with Embla Carousel, fullscreen via Radix Dialog, photo counter, desktop arrows, lazy loading, and edge case handling.</done>
</task>

<task type="auto">
  <name>Task 2: Create property information components</name>
  <files>
    apps/accommodations/frontend/components/booking/PropertyHeader.tsx
    apps/accommodations/frontend/components/booking/PropertyDescription.tsx
    apps/accommodations/frontend/components/booking/AmenityGrid.tsx
    apps/accommodations/frontend/components/booking/HouseRules.tsx
    apps/accommodations/frontend/components/booking/HostInfoCard.tsx
    apps/accommodations/frontend/components/booking/LocationSection.tsx
  </files>
  <action>
Create 6 property information components. These are simpler display components.

**PropertyHeader.tsx** (`'use client'` not needed -- can be server-compatible):

- Props: `name: string, city: string | null, countryCode: string, type: string, rooms: PropertyRoom[]`
- Display: property name (Playfair Display font via `font-display`), location (city, country), key stats (max guests from rooms, bedroom count, bathroom count placeholder)
- Compact horizontal layout with small icons (Phosphor: MapPin, Users, Bed, Bathtub)

**PropertyDescription.tsx** (`'use client'`):

- Props: `description: string | null`
- "Read more" truncation for long text (>200 chars)
- Toggle state to expand/collapse
- Smooth transition on expand

**AmenityGrid.tsx**:

- Props: `amenities: string[]`
- Display amenities as icon + text grid (2 columns on mobile, 3 on desktop)
- Map common amenity names to Phosphor Icons (wifi -> WifiHigh, parking -> Car, pool -> SwimmingPool, kitchen -> CookingPot, ac -> Fan, tv -> Television, washer -> WashingMachine, etc.)
- Fallback: CheckCircle icon for unknown amenities
- Section title "Amenities"

**HouseRules.tsx**:

- Props: `houseRules: Record<string, unknown>`
- Display rules as a list with icons
- The `house_rules` column is JSONB. Expected shape: `{ rules: string[] }` or flat array
- Handle both formats gracefully
- Section title "House Rules"
- Icons: Phosphor (Prohibit for negative rules, Check for positive)

**HostInfoCard.tsx**:

- Props: `hostName: string | null, hostPhoto: string | null, hostLanguages: string[], contactWhatsapp: string | null, contactPhone: string | null`
- Card with host photo (or initials avatar), name, languages badge list
- WhatsApp CTA button: `https://wa.me/{phone}` deep-link
- Uses Phosphor WhatsappLogo icon
- Section title "Your Host"

**LocationSection.tsx**:

- Props: `address: string | null, city: string | null, latitude: number | null, longitude: number | null`
- Static map image: use OpenStreetMap tile URL or simple placeholder
- "Open in Google Maps" link: `https://www.google.com/maps/search/?api=1&query={lat},{lng}`
- Address text below
- Section title "Location"
- Uses Phosphor MapPin, NavigationArrow icons

All components should:

- Use Tailwind with the existing design tokens (primary, foreground, etc.)
- Be mobile-first with responsive adjustments
- Have TypeScript props interfaces
- Handle null/empty data gracefully (hide section or show "Not available")
  </action>
  <verify>

1. `ls apps/accommodations/frontend/components/booking/` -- all 6 files exist
2. `grep "PropertyHeader\|export" apps/accommodations/frontend/components/booking/PropertyHeader.tsx` -- exports component
3. `grep "Read more\|readMore\|expanded" apps/accommodations/frontend/components/booking/PropertyDescription.tsx` -- has truncation
4. `grep "WifiHigh\|SwimmingPool\|CookingPot" apps/accommodations/frontend/components/booking/AmenityGrid.tsx` -- maps amenity icons
5. `grep "wa.me\|WhatsappLogo" apps/accommodations/frontend/components/booking/HostInfoCard.tsx` -- WhatsApp deep-link
6. `grep "google.com/maps" apps/accommodations/frontend/components/booking/LocationSection.tsx` -- Google Maps link
   </verify>
   <done>Six property information components created: PropertyHeader (name, stats), PropertyDescription (read more truncation), AmenityGrid (icon mapping), HouseRules (rules list), HostInfoCard (WhatsApp CTA), LocationSection (Google Maps link).</done>
   </task>

<task type="auto">
  <name>Task 3: Create RoomSelector, BookingCalendar, and PriceBreakdown components</name>
  <files>
    apps/accommodations/frontend/components/booking/RoomSelector.tsx
    apps/accommodations/frontend/components/booking/BookingCalendar.tsx
    apps/accommodations/frontend/components/booking/PriceBreakdown.tsx
  </files>
  <action>
Create the three booking interaction components.

**RoomSelector.tsx** (`'use client'`):

- Props: `rooms: PropertyRoom[], selectedRoomId: string | null, onSelectRoom: (roomId: string) => void`
- Only rendered when `rooms.length > 1` (parent handles this)
- Room cards in a vertical stack, each showing:
  - Room type and number
  - Capacity (guests icon + number)
  - Bed configuration from beds JSONB array
  - Price per night (formatted with `formatPrice`)
  - "Select" button / selected indicator
- Selected room has accent border highlight
- Uses Phosphor icons (Bed, Users)

**BookingCalendar.tsx** (`'use client'`):

- Follow the EXACT code from 19-RESEARCH.md (React DayPicker Booking Calendar) with these additions:
- Props: `bookedRanges: BookedRange[], minNights: number, onDateChange: (range: DateRange | undefined) => void`
- Import and use react-day-picker v9 with `mode="range"`
- Convert bookedRanges to disabled dates using `eachDayOfInterval` + `subDays` for half-open [) handling
- Disable past dates with `{ before: new Date() }`
- `excludeDisabled` prop to prevent selecting into disabled ranges
- `min` prop set to minNights
- Single month on mobile, two months on desktop (responsive via window.innerWidth check in useState)
- Show 12 months ahead max
- Custom CSS: import `react-day-picker/style.css` and add custom class overrides for accent color
- The calendar container should have a section title "Select Dates"

**PriceBreakdown.tsx** (`'use client'`):

- Props: `priceBreakdown: PriceBreakdown | null`
- Only renders when priceBreakdown is not null (dates selected)
- Displays:
  - `{formatPrice(pricePerNight)} x {nights} nights` = subtotal
  - Cleaning fee (if > 0)
  - Discount line with badge (if applicable, e.g., "10% weekly discount" with green badge)
  - Divider line
  - **Total** in bold/large
- Uses `formatPrice` from `@/lib/price-utils`
- Subtle "Price shown is an estimate" disclaimer text
- Uses Tailwind classes: `text-foreground`, `text-foreground-muted`, `bg-primary/10` for discount badge
  </action>
  <verify>

1. `cat apps/accommodations/frontend/components/booking/RoomSelector.tsx` -- file exists
2. `cat apps/accommodations/frontend/components/booking/BookingCalendar.tsx` -- file exists
3. `cat apps/accommodations/frontend/components/booking/PriceBreakdown.tsx` -- file exists
4. `grep "DayPicker\|react-day-picker" apps/accommodations/frontend/components/booking/BookingCalendar.tsx` -- uses DayPicker
5. `grep "subDays\|eachDayOfInterval" apps/accommodations/frontend/components/booking/BookingCalendar.tsx` -- half-open range handling
6. `grep "excludeDisabled" apps/accommodations/frontend/components/booking/BookingCalendar.tsx` -- prevents invalid selection
7. `grep "formatPrice" apps/accommodations/frontend/components/booking/PriceBreakdown.tsx` -- uses price formatter
8. `grep "formatPrice" apps/accommodations/frontend/components/booking/RoomSelector.tsx` -- shows room prices
   </verify>
   <done>RoomSelector (room cards with price), BookingCalendar (DayPicker with half-open disabled dates), and PriceBreakdown (formatted breakdown with discount badge) components created.</done>
   </task>

<task type="auto">
  <name>Task 4: Create BookingForm, BookingConfirmation, and useBookingForm hook</name>
  <files>
    apps/accommodations/frontend/hooks/useBookingForm.ts
    apps/accommodations/frontend/components/booking/BookingForm.tsx
    apps/accommodations/frontend/components/booking/BookingConfirmation.tsx
  </files>
  <action>
Create the booking form, its state management hook, and the confirmation screen.

**useBookingForm.ts** (`'use client'` context):

Custom hook managing the entire booking form lifecycle:

```typescript
interface UseBookingFormProps {
  propertySlug: string;
  rooms: PropertyRoom[];
  bookingMode: 'instant' | 'inquiry' | 'disabled';
  cleaningFee: number;
  weeklyDiscountPercent: number;
  monthlyDiscountPercent: number;
  minNights: number;
}

interface UseBookingFormReturn {
  // Room selection
  selectedRoom: PropertyRoom | null;
  selectRoom: (roomId: string) => void;

  // Date selection
  dateRange: DateRange | undefined;
  setDateRange: (range: DateRange | undefined) => void;
  bookedRanges: BookedRange[];
  isLoadingAvailability: boolean;

  // Price
  priceBreakdown: PriceBreakdown | null;

  // Form fields
  firstName: string;
  setFirstName: (v: string) => void;
  lastName: string;
  setLastName: (v: string) => void;
  email: string;
  setEmail: (v: string) => void;
  phone: string;
  setPhone: (v: string) => void;
  guestCount: number;
  setGuestCount: (v: number) => void;
  specialRequests: string;
  setSpecialRequests: (v: string) => void;

  // Submission
  isSubmitting: boolean;
  submitError: string | null;
  bookingResult: BookingResponse | null;
  handleSubmit: () => Promise<void>;

  // Validation
  isFormValid: boolean;
}
```

Logic:

- Auto-select room if rooms.length === 1
- **Availability wiring (critical):** When `selectedRoom` changes (via `selectRoom`), the hook calls `fetchAvailability(propertySlug, selectedRoom.id)` from `@/lib/property-api.ts`, stores the result in a `bookedRanges: BookedRange[]` state, and sets `isLoadingAvailability` during the fetch. The `bookedRanges` array is returned by the hook and passed to `BookingCalendar` as a prop by the parent (`PropertyPageClient`). **BookingCalendar is a controlled/presentational component -- it does NOT fetch its own data.** It receives `bookedRanges` and converts them to disabled dates.
- When dates change, recalculate price preview via `calculatePriceBreakdown`
- `handleSubmit` calls `submitBooking` from booking-api.ts
- On success, stores JWT token in localStorage (key: `gudbro_booking_token`)
- On success, sets `bookingResult`
- Form validation: all required fields filled, dates selected, room selected, guest count within capacity
- `submitError` maps API errors to human-readable messages

**BookingForm.tsx** (`'use client'`):

- Props: receives values from useBookingForm (controlled form)
- Props: `firstName, setFirstName, lastName, setLastName, email, setEmail, phone, setPhone, guestCount, setGuestCount, maxGuests: number, specialRequests, setSpecialRequests, bookingMode, isSubmitting, submitError, isFormValid, onSubmit`
- Uses `react-international-phone` for phone input with `defaultCountry="vn"`
- Import `'react-international-phone/style.css'`
- Guest count as a select/dropdown limited to room capacity
- Submit button: "Book Now" for instant, "Request to Book" for inquiry
- Loading state on submit button (spinner + disabled)
- Inline validation errors
- Section title "Guest Details"

**BookingConfirmation.tsx** (`'use client'`):

- Props: `bookingResult: BookingResponse`
- Shown after successful booking submission (replaces the form)
- Displays:
  - Success icon (Phosphor CheckCircle, green)
  - Booking code prominently: "BK-XXXXXX"
  - Status message: "Booking Confirmed!" or "Booking Request Sent - Waiting for host confirmation"
  - For inquiry: "The host has {X} hours to respond" with expires_at info
  - Price summary from priceBreakdown
  - Two CTAs:
    1. WhatsApp Host button: deep-link `https://wa.me/{hostWhatsapp}?text={encoded_message}`
       Message template: `Hi! I just booked ${bookingCode} at ${propertyName}. Looking forward to my stay!`
    2. "Check your email" info text (placeholder for future email integration)
  - Small note: "Save your booking code: {code}" with copy-to-clipboard
- Uses Phosphor icons (CheckCircle, WhatsappLogo, EnvelopeSimple, Copy)
  </action>
  <verify>

1. `cat apps/accommodations/frontend/hooks/useBookingForm.ts` -- file exists
2. `cat apps/accommodations/frontend/components/booking/BookingForm.tsx` -- file exists
3. `cat apps/accommodations/frontend/components/booking/BookingConfirmation.tsx` -- file exists
4. `grep "fetchAvailability" apps/accommodations/frontend/hooks/useBookingForm.ts` -- fetches availability on room change
5. `grep "calculatePriceBreakdown" apps/accommodations/frontend/hooks/useBookingForm.ts` -- calculates price preview
6. `grep "submitBooking" apps/accommodations/frontend/hooks/useBookingForm.ts` -- calls booking API
7. `grep "localStorage" apps/accommodations/frontend/hooks/useBookingForm.ts` -- stores JWT
8. `grep "PhoneInput\|react-international-phone" apps/accommodations/frontend/components/booking/BookingForm.tsx` -- phone input
9. `grep "Request to Book\|Book Now" apps/accommodations/frontend/components/booking/BookingForm.tsx` -- hybrid CTA text
10. `grep "wa.me\|WhatsappLogo" apps/accommodations/frontend/components/booking/BookingConfirmation.tsx` -- WhatsApp CTA
11. `grep "BK-\|bookingCode\|booking_code" apps/accommodations/frontend/components/booking/BookingConfirmation.tsx` -- shows booking code
12. `cd apps/accommodations/frontend && npx tsc --noEmit 2>&1 | head -30` -- TypeScript compiles
    </verify>
    <done>useBookingForm hook (room selection, availability fetching, price calculation, form state, submission, JWT storage), BookingForm (phone input, validation, hybrid CTA), and BookingConfirmation (booking code, WhatsApp deep-link, copy-to-clipboard) created.</done>
    </task>

</tasks>

<verification>
1. All 12 component files exist in components/booking/
2. Hook file exists in hooks/useBookingForm.ts
3. All components have 'use client' where needed
4. Gallery uses Embla Carousel with Radix Dialog fullscreen
5. Calendar uses React DayPicker with half-open disabled dates
6. Form uses react-international-phone
7. Confirmation has WhatsApp deep-link
8. Price breakdown uses formatPrice from price-utils
9. useBookingForm fetches availability, calculates price, handles submission
10. TypeScript compiles: `cd apps/accommodations/frontend && npx tsc --noEmit`
</verification>

<success_criteria>

- PROP-01: Photo gallery is swipeable with fullscreen support
- PROP-02: Property description, amenities, house rules, and host info displayed
- PROP-03: Calendar shows availability with disabled dates
- PROP-04: Price breakdown shows per-night x nights + fees - discounts = total
- PROP-05: Location section with Google Maps link
- BOOK-01 (partial): Booking form captures all required fields
- BOOK-04 (partial): WhatsApp deep-link CTA on confirmation screen
  </success_criteria>

<output>
After completion, create `.planning/phases/19-property-page-booking-flow/19-02-SUMMARY.md`
</output>
