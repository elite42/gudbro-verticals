---
phase: 06-in-stay-dashboard
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/accommodations/frontend/hooks/useStaySession.ts
  - apps/accommodations/frontend/lib/stay-api.ts
  - apps/accommodations/frontend/app/page.tsx
autonomous: true

must_haves:
  truths:
    - 'Verification page accepts last name + booking code and redirects to dashboard on success'
    - 'JWT token is saved in localStorage after successful verification'
    - 'Returning guest with valid token auto-redirects to dashboard without re-verifying'
    - 'Expired or invalid token redirects back to verification screen'
    - 'Error messages shown for wrong credentials without revealing booking code existence'
  artifacts:
    - path: 'apps/accommodations/frontend/hooks/useStaySession.ts'
      provides: 'Session management hook with JWT lifecycle'
      contains: 'useStaySession'
    - path: 'apps/accommodations/frontend/lib/stay-api.ts'
      provides: 'Typed fetch wrappers for all stay API routes'
      contains: 'fetchServices'
    - path: 'apps/accommodations/frontend/app/page.tsx'
      provides: 'Booking verification landing page'
      contains: 'VerificationForm'
  key_links:
    - from: 'apps/accommodations/frontend/hooks/useStaySession.ts'
      to: '/api/stay/verify'
      via: 'fetch POST'
      pattern: 'api/stay/verify'
    - from: 'apps/accommodations/frontend/lib/stay-api.ts'
      to: 'Phase 5 + Phase 6 API routes'
      via: 'typed fetch wrappers'
      pattern: 'fetchStayAPI'
    - from: 'apps/accommodations/frontend/app/page.tsx'
      to: 'hooks/useStaySession.ts'
      via: 'useStaySession hook'
      pattern: 'useStaySession'
---

<objective>
Create the frontend foundation for the dashboard: session management hook (JWT lifecycle + localStorage), typed API fetch wrappers for all stay routes, and the verification landing page that replaces the current mock property listing.

Purpose: Before wiring real data into the dashboard, we need the session layer (authentication + token persistence) and API access layer (typed fetch functions). The verification page is the entry point for the entire guest experience.
Output: useStaySession hook, stay-api.ts fetch wrappers, and rewritten app/page.tsx as a clean verification screen.
</objective>

<execution_context>
@/Users/gianfrancodagostino/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gianfrancodagostino/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-in-stay-dashboard/06-RESEARCH.md
@.planning/phases/06-in-stay-dashboard/06-CONTEXT.md
@.planning/phases/05-api-layer/05-01-SUMMARY.md

Key source files:
@apps/accommodations/frontend/app/page.tsx
@apps/accommodations/frontend/types/stay.ts
@apps/accommodations/frontend/lib/auth.ts
@apps/accommodations/frontend/app/api/stay/verify/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Session hook and typed API wrappers</name>
  <files>
    apps/accommodations/frontend/hooks/useStaySession.ts
    apps/accommodations/frontend/lib/stay-api.ts
  </files>
  <action>
1. Create hooks/useStaySession.ts:
   - 'use client' directive
   - Manages JWT token lifecycle: store after verify, retrieve on mount, clear on expire
   - localStorage keys: 'gudbro_stay_token' and 'gudbro_stay_data'
   - On mount (useEffect with empty deps): check localStorage for existing token, decode JWT payload via atob(token.split('.')[1]) to check exp claim against Date.now(). If valid, restore session. If expired, clear localStorage.
   - verify(bookingCode, lastName) async function: POST to /api/stay/verify, on success save token + stay data to localStorage + state, return { success: true }. On error, return { success: false, error: string }.
   - logout() function: clear localStorage + state
   - Return: { token, stay, isLoading, isAuthenticated, verify, logout }
   - Types: StaySession interface, import StayData from types/stay.ts
   - IMPORTANT: isLoading starts as true, becomes false after localStorage check. This prevents redirect loops.
   - Do NOT import jose on client side. Use atob for JWT decode (no verification needed client-side).

2. Create lib/stay-api.ts:
   - Generic fetchStayAPI<T>(path, token) function that:
     - Sends GET with Authorization: Bearer token header
     - Returns { data: T | null, error: string | null }
     - Catches network errors gracefully
   - Typed wrappers for each route:
     - fetchServices(code, token) -> ServiceCategoryResponse (categories with items)
     - fetchDeals(code, token) -> DealResponse[]
     - fetchProperty(code, token) -> { property: PropertyInfo, wifi: WifiInfo }
     - fetchUsefulNumbers(code, token) -> UsefulNumbersResponse
   - Import types from @/types/stay
   - Use plain fetch (no SWR/react-query, matches coffeeshop PWA pattern)
     </action>
     <verify>
     Run `cd /Users/gianfrancodagostino/Desktop/gudbro-verticals && pnpm --filter accommodations-frontend build` and confirm build passes with no TypeScript errors.
     </verify>
     <done>useStaySession hook manages JWT lifecycle with localStorage persistence. stay-api.ts provides typed fetch wrappers for all 6 API routes. Both compile without errors.</done>
     </task>

<task type="auto">
  <name>Task 2: Verification landing page rewrite</name>
  <files>apps/accommodations/frontend/app/page.tsx</files>
  <action>
Replace the current mock property listing page with a clean booking verification screen.

The page must:

- 'use client' directive
- Use useStaySession hook for auth state and verify function
- Auto-redirect: if isAuthenticated and stay exists, router.push to /stay/{code}
- Show loading state while session check is in progress (isLoading = true)
- Form with two fields: booking code (placeholder: "BK-XXXXXX") and last name
- "Access your stay" submit button, disabled while submitting
- Error handling: show user-friendly message for verification_failed ("We couldn't find your booking. Please check your code and last name.") and generic error for server issues
- Clean design matching accommodations branding:
  - Centered vertically on mobile
  - Property-agnostic (no specific property branding on verification screen since we don't know which property yet)
  - Accommodations brand color from CSS variables (--color-primary)
  - Clean, minimal layout: logo/brand at top, form in center, "Need help?" link at bottom
- Booking code input should auto-uppercase and accept with or without "BK-" prefix
- Use Tailwind for styling

Do NOT:

- Show property listings, reviews, gallery, or marketing content
- Use SWR or react-query
- Import jose on client side

Reference 06-RESEARCH.md Example 1 for the pattern, but design it properly (not skeleton code).
</action>
<verify>
Run `cd /Users/gianfrancodagostino/Desktop/gudbro-verticals && pnpm --filter accommodations-frontend build` and confirm:

- Build passes
- / route renders the verification form (not the old property listing)
  </verify>
  <done>Verification page accepts last name + booking code, calls verify API, saves JWT to localStorage, and redirects to /stay/{code} on success. Auto-redirects returning guests. Error states handled gracefully.</done>
  </task>

</tasks>

<verification>
- hooks/useStaySession.ts exists with full JWT lifecycle management
- lib/stay-api.ts exists with typed wrappers for services, deals, property, useful-numbers
- app/page.tsx is a verification form (not property listing)
- `pnpm --filter accommodations-frontend build` succeeds
- No client-side jose imports
</verification>

<success_criteria>

- Session hook handles: initial load from localStorage, verify flow, auto-redirect, token expiry detection, logout
- API wrappers cover all Phase 5 + Phase 6 routes with proper typing
- Verification page is the sole entry point, redirecting authenticated guests automatically
- All code compiles without TypeScript errors
  </success_criteria>

<output>
After completion, create `.planning/phases/06-in-stay-dashboard/06-02-SUMMARY.md`
</output>
