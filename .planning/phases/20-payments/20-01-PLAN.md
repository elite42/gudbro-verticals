---
phase: 20-payments
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - shared/database/migrations/schema/084-payment-config.sql
  - apps/accommodations/frontend/types/property.ts
  - apps/accommodations/frontend/lib/types.ts
autonomous: true

must_haves:
  truths:
    - "accom_bookings accepts 'pending_payment' and 'payment_failed' as valid status values"
    - 'accom_properties has deposit_percent, bank_transfer_info, crypto_wallets, and cancellation config columns'
    - 'TypeScript types include AccomPaymentMethod, deposit/cancellation fields on PropertyPageData, and payment_method on BookingSubmission'
  artifacts:
    - path: 'shared/database/migrations/schema/084-payment-config.sql'
      provides: 'Schema extension for payment configuration and booking status'
      contains: 'pending_payment'
    - path: 'apps/accommodations/frontend/types/property.ts'
      provides: 'Updated PropertyPageData, BookingSubmission, BookingResponse with payment fields'
      contains: 'AccomPaymentMethod'
    - path: 'apps/accommodations/frontend/lib/types.ts'
      provides: 'Updated BookingStatus type with pending_payment and payment_failed'
      contains: 'pending_payment'
  key_links:
    - from: 'shared/database/migrations/schema/084-payment-config.sql'
      to: 'accom_bookings.status CHECK constraint'
      via: 'DROP + ADD CONSTRAINT'
      pattern: 'pending_payment'
    - from: 'apps/accommodations/frontend/types/property.ts'
      to: 'PropertyPageData'
      via: 'deposit_percent field addition'
      pattern: 'deposit_percent'
---

<objective>
Extend database schema and TypeScript types for the payment system.

Purpose: All subsequent payment plans depend on having the correct DB constraints and TypeScript types in place. This creates the foundation.
Output: SQL migration 084, updated TypeScript types for property/booking with payment fields.
</objective>

<execution_context>
@/Users/gianfrancodagostino/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gianfrancodagostino/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-payments/20-RESEARCH.md

# Existing schema reference

@shared/database/migrations/schema/083-accommodations-v2-foundation.sql
@apps/accommodations/frontend/types/property.ts
@apps/accommodations/frontend/lib/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SQL migration 084 for payment config</name>
  <files>shared/database/migrations/schema/084-payment-config.sql</files>
  <action>
Create migration `084-payment-config.sql` with these changes:

1. **Extend accom_bookings status CHECK constraint:**
   - DROP the existing `accom_bookings_status_check` constraint
   - ADD new constraint allowing: 'pending', 'pending_payment', 'confirmed', 'checked_in', 'checked_out', 'cancelled', 'no_show', 'payment_failed'

2. **Add deposit tracking columns to accom_bookings:**
   - `deposit_amount INTEGER DEFAULT 0` -- deposit amount in minor currency units
   - `deposit_percent INTEGER DEFAULT 100` -- deposit percentage applied
   - `payment_method TEXT DEFAULT NULL` -- 'cash', 'bank_transfer', 'card', 'crypto'
   - ADD CHECK constraint: `payment_method IN ('cash', 'bank_transfer', 'card', 'crypto')` (allow NULL for legacy bookings)

3. **Add payment config columns to accom_properties:**
   - `deposit_percent INTEGER NOT NULL DEFAULT 100 CHECK (deposit_percent BETWEEN 1 AND 100)` -- owner-configured deposit %
   - `bank_transfer_info JSONB DEFAULT NULL` -- {bank_name, account_number, account_holder, swift_code, notes}
   - `crypto_wallets JSONB DEFAULT NULL` -- {btc: "address", eth: "address", ...}
   - `cancellation_window_hours INTEGER NOT NULL DEFAULT 48` -- free cancellation window
   - `cancellation_penalty_percent INTEGER NOT NULL DEFAULT 100 CHECK (cancellation_penalty_percent BETWEEN 0 AND 100)` -- penalty as % of deposit

Use `ADD COLUMN IF NOT EXISTS` for safety. Include header comment explaining the migration purpose.

**IMPORTANT:** accom_properties already has `accepted_payment_methods TEXT[]` and `stripe_account_id TEXT` from migration 083. Do NOT re-add those.
</action>
<verify>
Check SQL syntax by reviewing the file for:

- Correct CHECK constraint syntax (DROP then ADD)
- IF NOT EXISTS on all ADD COLUMN
- Proper INTEGER types for financial amounts
- No duplicate columns with migration 083
  </verify>
  <done>Migration 084 exists with all required schema changes. Status CHECK includes pending_payment and payment_failed. Payment config columns added to accom_properties and accom_bookings.</done>
  </task>

<task type="auto">
  <name>Task 2: Update TypeScript types for payment flow</name>
  <files>apps/accommodations/frontend/types/property.ts, apps/accommodations/frontend/lib/types.ts</files>
  <action>
**In `types/property.ts`:**

1. Add `AccomPaymentMethod` type: `'cash' | 'bank_transfer' | 'card' | 'crypto'`

2. Add `PAYMENT_METHOD_CONFIG` constant (Record of AccomPaymentMethod to label/description/icon/color):
   - cash: label "Cash", description "Pay at check-in", icon "Money", color "bg-emerald-500"
   - bank_transfer: label "Bank Transfer", description "Transfer before arrival", icon "Bank", color "bg-blue-500"
   - card: label "Credit/Debit Card", description "Secure payment via Stripe", icon "CreditCard", color "bg-indigo-600"
   - crypto: label "Cryptocurrency", description "BTC, ETH, USDC & more", icon "CurrencyBtc", color "bg-orange-500"

3. Extend `PropertyPageData` interface:
   - Add `deposit_percent: number;`
   - Add `bank_transfer_info: BankTransferInfo | null;`
   - Add `crypto_wallets: Record<string, string> | null;`
   - Add `cancellation_window_hours: number;`
   - Add `cancellation_penalty_percent: number;`
   - `accepted_payment_methods` is already `string[]` -- keep as is

4. Add `BankTransferInfo` interface:
   - bank_name: string
   - account_number: string
   - account_holder: string
   - swift_code?: string
   - notes?: string

5. Extend `BookingSubmission` interface:
   - Add `paymentMethod?: AccomPaymentMethod;` (optional for backward compat)

6. Extend `BookingResponse` interface:
   - Add `paymentMethod?: AccomPaymentMethod;`
   - Add `depositAmount?: number;`
   - Add `depositPercent?: number;`
   - Add `stripeCheckoutUrl?: string | null;` (for card payments, the redirect URL)
   - Add `bankTransferInfo?: BankTransferInfo | null;` (for bank transfer)
   - Add `cryptoWallets?: Record<string, string> | null;` (for crypto)
   - Extend status union: `'confirmed' | 'pending' | 'pending_payment'`

7. Add `PropertyApiError` values: `'payment_method_not_accepted'` | `'stripe_checkout_failed'`

**In `lib/types.ts`:**

8. Extend `BookingStatus` type to include `'pending_payment'` and `'payment_failed'`

9. Extend `PaymentStatus` type to add `'pending'` if not already present (check first)

Both files must compile without TypeScript errors.
</action>
<verify>Run `cd /Users/gianfrancodagostino/Desktop/gudbro-verticals/apps/accommodations/frontend && npx tsc --noEmit --pretty 2>&1 | head -30` to check for type errors.</verify>
<done>TypeScript types include AccomPaymentMethod, PAYMENT_METHOD_CONFIG, extended PropertyPageData with deposit/cancellation fields, BookingSubmission with paymentMethod, BookingResponse with payment details and stripeCheckoutUrl, and BookingStatus includes pending_payment/payment_failed.</done>
</task>

</tasks>

<verification>
1. SQL migration 084 exists in shared/database/migrations/schema/
2. Migration handles CHECK constraint safely (DROP + ADD)
3. TypeScript compilation passes for accommodations frontend
4. AccomPaymentMethod type is exported
5. PropertyPageData includes deposit_percent and related fields
6. BookingSubmission includes optional paymentMethod
7. BookingResponse includes stripeCheckoutUrl
</verification>

<success_criteria>

- Migration 084 creates all payment columns and extends booking status constraint
- TypeScript types compile cleanly and cover all payment method scenarios
- Types are backward compatible (new fields optional where needed for existing data)
  </success_criteria>

<output>
After completion, create `.planning/phases/20-payments/20-01-SUMMARY.md`
</output>
