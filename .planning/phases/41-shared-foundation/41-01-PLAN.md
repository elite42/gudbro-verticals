---
phase: 41-shared-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - shared/hooks/package.json
  - shared/hooks/tsconfig.json
  - shared/hooks/index.ts
  - shared/hooks/use-price-format.ts
  - shared/utils/currency-converter.ts
  - shared/utils/currency-preferences.ts
  - shared/utils/index.ts
  - shared/utils/package.json
  - package.json
autonomous: true

must_haves:
  truths:
    - '@gudbro/hooks package exists and exports usePriceFormat hook'
    - '@gudbro/utils exports createCurrencyPreferencesStore and currency converter functions'
    - 'usePriceFormat accepts a config object (store, formatConvertedPrice, getBaseCurrency) and returns { formatPrice, formatPriceCompact, currencyPrefs, baseCurrency }'
    - 'currency-preferences creates per-app stores with configurable storageKeyPrefix to avoid localStorage collision'
    - "currency-converter supports VND 'k'/'M' format, optional Supabase fetch, and all existing currency codes"
  artifacts:
    - path: 'shared/hooks/use-price-format.ts'
      provides: 'Consolidated usePriceFormat hook'
      contains: 'export function usePriceFormat'
    - path: 'shared/hooks/package.json'
      provides: '@gudbro/hooks package definition'
      contains: '@gudbro/hooks'
    - path: 'shared/utils/currency-converter.ts'
      provides: 'Consolidated currency converter'
      contains: 'formatConvertedPrice'
    - path: 'shared/utils/currency-preferences.ts'
      provides: 'Configurable currency preferences store factory'
      contains: 'createCurrencyPreferencesStore'
  key_links:
    - from: 'shared/hooks/use-price-format.ts'
      to: '@gudbro/utils'
      via: 'import type { CurrencyPreferencesStore }'
      pattern: 'import.*from.*@gudbro/utils'
    - from: 'shared/utils/currency-preferences.ts'
      to: 'localStorage'
      via: 'storageKeyPrefix parameter'
      pattern: 'storageKeyPrefix'
---

<objective>
Create the @gudbro/hooks package and add consolidated currency utilities to @gudbro/utils.

Purpose: Establish the shared hook and utility modules that all PWAs will import instead of their local duplicates. The usePriceFormat hook exists in 5 apps (coffeeshop, gym, laundry, pharmacy, workshops), currency-converter in 5 apps, and currency-preferences in 5 apps. This plan creates the single source of truth for all three.

Output: @gudbro/hooks package with usePriceFormat, @gudbro/utils extended with currency-converter.ts and currency-preferences.ts
</objective>

<execution_context>
@/Users/gianfrancodagostino/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gianfrancodagostino/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/41-shared-foundation/41-RESEARCH.md

# Reference implementations (read these to understand current patterns):

@apps/coffeeshop/frontend/lib/hooks/usePriceFormat.ts
@apps/coffeeshop/frontend/lib/currency-converter.ts
@apps/coffeeshop/frontend/lib/currency-preferences.ts
@apps/gym/frontend/lib/hooks/usePriceFormat.ts
@apps/gym/frontend/lib/currency-converter.ts
@apps/workshops/frontend/lib/hooks/usePriceFormat.ts
@apps/workshops/frontend/lib/currency-preferences.ts

# Existing shared packages (follow these patterns):

@shared/utils/package.json
@shared/utils/index.ts
@shared/utils/tsconfig.json
@shared/ui/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create currency-converter and currency-preferences in @gudbro/utils</name>
  <files>
    shared/utils/currency-converter.ts
    shared/utils/currency-preferences.ts
    shared/utils/index.ts
    shared/utils/package.json
  </files>
  <action>
    **currency-preferences.ts:**
    Create a configurable store factory based on the coffeeshop/gym/laundry/pharmacy pattern (NOT the workshops functional API). Key design:
    - Export `CurrencyPreferences` interface: `{ enabled: boolean; selectedCurrency: string; baseCurrency: string }`
    - Export `CurrencyPreferencesConfig` interface: `{ storageKeyPrefix: string; baseCurrency: string }`
    - Export `createCurrencyPreferencesStore(config)` factory that returns `{ get(), set(), clear(), getCurrencyInfo() }`
    - Storage key format: `${config.storageKeyPrefix}-currency-preferences`
    - Default preferences: `{ enabled: false, selectedCurrency: config.baseCurrency, baseCurrency: config.baseCurrency }`
    - The store must dispatch `currency-preferences-updated` CustomEvent on `window` when preferences change (matching the existing event name used by 4/5 apps)
    - Export the `CurrencyPreferencesStore` type (return type of the factory) for use by @gudbro/hooks
    - Include the CURRENCIES map with code, symbol, name, flag, and decimalDigits for all currencies currently supported (VND, USD, EUR, GBP, JPY, KRW, AUD, THB, CNY, etc.)
    - Reference: coffeeshop's currency-preferences.ts is the most complete version

    **currency-converter.ts:**
    Create the consolidated converter based on coffeeshop (most complete) with gym's "M" format addition. Key design:
    - Export `ExchangeRates` type and `ConversionConfig` interface
    - Export `createCurrencyConverter(config)` factory that accepts: `{ baseCurrency: string; fallbackRates: ExchangeRates; fetchRates?: () => Promise<ExchangeRates> }`
    - The factory returns: `{ convert(amount, toCurrency), formatConvertedPrice(amount, toCurrency), getRate(toCurrency), refreshRates() }`
    - VND formatting: use "k" for thousands (e.g., "150k"), "M" for millions (from gym's implementation)
    - JPY/KRW: zero decimal places
    - Other currencies: 2 decimal places with proper Intl.NumberFormat
    - The `fetchRates` parameter is optional -- if not provided, uses only fallbackRates (this avoids forcing Supabase dependency on all apps)
    - Include hardcoded fallback rates matching coffeeshop's current values
    - Reference: coffeeshop's currency-converter.ts for the core logic, gym's for the "M" format

    **index.ts:** Add barrel exports for both new modules (append to existing exports, do NOT remove existing ones)
    **package.json:** Add `"@gudbro/types": "workspace:*"` to dependencies if not already present

  </action>
  <verify>
    Run `cd /Users/gianfrancodagostino/Desktop/gudbro-verticals && pnpm --filter @gudbro/utils build` -- must succeed with no errors.
    Verify exports: `grep -c "export" shared/utils/currency-converter.ts shared/utils/currency-preferences.ts` -- both files should have multiple exports.
  </verify>
  <done>
    @gudbro/utils builds successfully and exports createCurrencyPreferencesStore, createCurrencyConverter, CurrencyPreferences, CurrencyPreferencesStore, ExchangeRates, and ConversionConfig types.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create @gudbro/hooks package with usePriceFormat</name>
  <files>
    shared/hooks/package.json
    shared/hooks/tsconfig.json
    shared/hooks/index.ts
    shared/hooks/use-price-format.ts
    package.json
  </files>
  <action>
    **Create the shared/hooks/ directory and package:**

    **package.json:** Model after shared/utils/package.json. Key fields:
    - `"name": "@gudbro/hooks"`
    - `"main": "./index.ts"` (or match the pattern used by @gudbro/utils for build output)
    - `"dependencies": { "@gudbro/utils": "workspace:*" }`
    - `"peerDependencies": { "react": "^18.0.0" }`

    **tsconfig.json:** Model after shared/utils/tsconfig.json. Must extend from root tsconfig.base.json and include jsx support (`"jsx": "react-jsx"` or `"preserve"`).

    **use-price-format.ts:** Create the consolidated hook based on the coffeeshop/gym/laundry/pharmacy API. Key design:
    - `'use client'` directive at the top (CRITICAL for Next.js -- shared UI/hooks that use React hooks MUST have this)
    - Import `useState, useEffect, useCallback` from React
    - Import types from `@gudbro/utils` (CurrencyPreferencesStore)
    - Export `UsePriceFormatOptions` interface: `{ store: CurrencyPreferencesStore; formatConvertedPrice: (price: number, currency: string) => string; getBaseCurrency: () => string }`
    - Export `usePriceFormat(options)` hook that returns `{ formatPrice, formatPriceCompact, currencyPrefs, baseCurrency }`
    - Listen for `currency-preferences-updated` event on window (matching the event from currency-preferences store)
    - `formatPrice(price: number): string` -- formats with conversion if enabled
    - `formatPriceCompact(price: number): string` -- same as formatPrice (compact variant for future differentiation)
    - Handle SSR safety: check `typeof window !== 'undefined'` before addEventListener
    - Reference: coffeeshop's usePriceFormat.ts is the canonical implementation

    **index.ts:** Barrel export: `export { usePriceFormat, type UsePriceFormatOptions } from './use-price-format'`

    **Root package.json:** Add `"@gudbro/hooks": "workspace:*"` to the pnpm workspace if needed. Run `pnpm install` to link the new package.

    Also register the package in turbo.json if needed (check if @gudbro/utils is registered there and follow same pattern for @gudbro/hooks).

  </action>
  <verify>
    Run `cd /Users/gianfrancodagostino/Desktop/gudbro-verticals && pnpm install && pnpm --filter @gudbro/hooks build` -- must succeed.
    Run `pnpm --filter @gudbro/utils build` -- still succeeds (no regressions).
    Verify the hook file has 'use client' directive: `head -1 shared/hooks/use-price-format.ts` should output `'use client'`
  </verify>
  <done>
    @gudbro/hooks package exists, is linked via pnpm workspaces, builds successfully, and exports usePriceFormat hook with the standard API shape ({ formatPrice, formatPriceCompact, currencyPrefs, baseCurrency }).
  </done>
</task>

</tasks>

<verification>
1. `pnpm --filter @gudbro/utils build` passes
2. `pnpm --filter @gudbro/hooks build` passes
3. `shared/utils/currency-converter.ts` exports createCurrencyConverter
4. `shared/utils/currency-preferences.ts` exports createCurrencyPreferencesStore
5. `shared/hooks/use-price-format.ts` has 'use client' directive and exports usePriceFormat
6. No circular dependencies: hooks depends on utils, NOT the reverse
</verification>

<success_criteria>

- @gudbro/hooks is a new pnpm workspace package that builds and exports usePriceFormat
- @gudbro/utils has two new modules: currency-converter.ts and currency-preferences.ts
- Both packages build successfully with `pnpm build`
- The hook uses the same API shape as coffeeshop/gym/laundry/pharmacy (formatPrice, formatPriceCompact, currencyPrefs, baseCurrency)
- currency-preferences uses configurable storageKeyPrefix (no hardcoded keys)
- currency-converter supports optional fetchRates for Supabase integration
  </success_criteria>

<output>
After completion, create `.planning/phases/41-shared-foundation/41-01-SUMMARY.md`
</output>
