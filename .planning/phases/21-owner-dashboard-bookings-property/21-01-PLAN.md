---
phase: 21-owner-dashboard-bookings-property
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/backoffice/app/api/accommodations/bookings/route.ts
  - apps/backoffice/app/api/accommodations/bookings/[id]/route.ts
  - apps/backoffice/app/api/accommodations/rooms/route.ts
  - apps/backoffice/app/api/accommodations/property/route.ts
  - apps/backoffice/components/accommodations/BookingStatusBadge.tsx
  - apps/backoffice/lib/accommodations/helpers.ts
autonomous: true

must_haves:
  truths:
    - 'GET /api/accommodations/bookings?propertyId=X returns bookings with room join ordered by check-in date descending'
    - 'PATCH /api/accommodations/bookings/[id] validates status transitions and rejects invalid ones with 400'
    - 'GET/POST/PUT /api/accommodations/rooms?propertyId=X supports full CRUD for rooms with soft-delete via is_active'
    - 'GET/PUT /api/accommodations/property?propertyId=X retrieves and updates property settings'
    - 'All API routes authenticate via ADMIN_API_KEY header and return 401 on mismatch'
  artifacts:
    - path: 'apps/backoffice/app/api/accommodations/bookings/route.ts'
      provides: 'Booking list endpoint with status filtering'
      exports: ['GET']
    - path: 'apps/backoffice/app/api/accommodations/bookings/[id]/route.ts'
      provides: 'Booking detail + status action endpoint'
      exports: ['GET', 'PATCH']
    - path: 'apps/backoffice/app/api/accommodations/rooms/route.ts'
      provides: 'Room CRUD endpoint'
      exports: ['GET', 'POST', 'PUT']
    - path: 'apps/backoffice/app/api/accommodations/property/route.ts'
      provides: 'Property settings endpoint'
      exports: ['GET', 'PUT']
    - path: 'apps/backoffice/components/accommodations/BookingStatusBadge.tsx'
      provides: 'Reusable status badge component'
    - path: 'apps/backoffice/lib/accommodations/helpers.ts'
      provides: 'Shared helpers: auth validation, property lookup, price formatting, WhatsApp URL builder'
  key_links:
    - from: 'apps/backoffice/app/api/accommodations/bookings/route.ts'
      to: 'supabase accom_bookings + accom_rooms'
      via: 'Supabase admin client join query'
      pattern: "from\\('accom_bookings'\\)"
    - from: 'apps/backoffice/app/api/accommodations/bookings/[id]/route.ts'
      to: 'VALID_TRANSITIONS state machine'
      via: 'Status validation before update'
      pattern: "VALID_TRANSITIONS\\[currentStatus\\]"
---

<objective>
Create all API routes and shared utilities for Phase 21's Owner Dashboard.

Purpose: Foundation layer that all frontend pages will consume. Establishes auth pattern, data access, status transition validation, and reusable components.
Output: 4 API route files, 1 shared helper module, 1 reusable BookingStatusBadge component.
</objective>

<execution_context>
@/Users/gianfrancodagostino/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gianfrancodagostino/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Reference patterns

@apps/accommodations/frontend/app/api/dashboard/bookings/route.ts
@apps/accommodations/frontend/app/dashboard/bookings/page.tsx
@apps/accommodations/frontend/types/property.ts
@apps/accommodations/frontend/lib/price-utils.ts
@apps/accommodations/frontend/components/booking/BookingConfirmation.tsx
@apps/backoffice/components/settings/ChargesManager.tsx
@apps/backoffice/lib/qr/qr-generator.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Shared helpers and BookingStatusBadge</name>
  <files>
    apps/backoffice/lib/accommodations/helpers.ts
    apps/backoffice/components/accommodations/BookingStatusBadge.tsx
  </files>
  <action>
Create `apps/backoffice/lib/accommodations/helpers.ts` with:

1. **`validateAdminApiKey(request: NextRequest)`** — Extracts `Authorization: Bearer {key}` header, compares against `process.env.ADMIN_API_KEY`. Returns `{ valid: true }` or `{ valid: false, response: NextResponse }` (401 JSON).

2. **`VALID_TRANSITIONS`** — State machine map:

   ```
   pending -> [confirmed, cancelled]
   pending_payment -> [confirmed, cancelled]
   confirmed -> [checked_in, cancelled]
   checked_in -> [checked_out, cancelled]
   ```

3. **`ACTION_TO_STATUS`** — Maps action strings to booking statuses:

   ```
   confirm -> confirmed
   decline -> cancelled
   checkin -> checked_in
   checkout -> checked_out
   cancel -> cancelled
   ```

4. **`BOOKING_STATUS_COLORS`** and **`PAYMENT_STATUS_COLORS`** — Color maps (reuse exact values from `apps/accommodations/frontend/app/dashboard/bookings/page.tsx`).

5. **`buildWhatsAppUrl(phone: string, message: string)`** — Strips non-digits from phone, encodes message, returns `https://wa.me/${digits}?text=${encoded}`.

6. **`formatBookingPrice(amount: number, currency: string)`** — Formats minor currency units to display string (amount / 100 with 2 decimals + currency).

Create `apps/backoffice/components/accommodations/BookingStatusBadge.tsx` as a 'use client' component:

- Props: `{ status: string; type?: 'booking' | 'payment' }` (default 'booking')
- Renders a `<span>` with rounded pill styling, picking colors from BOOKING_STATUS_COLORS or PAYMENT_STATUS_COLORS.
- Displays status text with first letter capitalized, underscores replaced by spaces.
  </action>
  <verify>
  TypeScript compiles: `cd apps/backoffice && npx tsc --noEmit --pretty 2>&1 | head -30` (no errors in new files).
  </verify>
  <done>
  helpers.ts exports validateAdminApiKey, VALID_TRANSITIONS, ACTION_TO_STATUS, BOOKING_STATUS_COLORS, PAYMENT_STATUS_COLORS, buildWhatsAppUrl, formatBookingPrice. BookingStatusBadge renders color-coded pills for both booking and payment statuses.
  </done>
  </task>

<task type="auto">
  <name>Task 2: Bookings API routes (list + detail + actions)</name>
  <files>
    apps/backoffice/app/api/accommodations/bookings/route.ts
    apps/backoffice/app/api/accommodations/bookings/[id]/route.ts
  </files>
  <action>
Create `apps/backoffice/app/api/accommodations/bookings/route.ts`:

**GET handler:**

- Call `validateAdminApiKey(request)` — return 401 if invalid.
- Extract `propertyId` and optional `status` from searchParams.
- If no propertyId, return 400.
- Query Supabase admin client:
  ```sql
  SELECT id, booking_code, guest_name, guest_last_name, guest_email, guest_phone,
         check_in_date, check_out_date, num_nights, num_guests, total_price, currency,
         status, payment_method, payment_status, deposit_amount, deposit_percent,
         special_requests, created_at,
         room:accom_rooms(id, room_number, room_type)
  FROM accom_bookings
  WHERE property_id = $propertyId
  ORDER BY check_in_date DESC
  LIMIT 200
  ```
- If status param provided and not 'all', add `.eq('status', status)`.
- Return JSON `{ bookings: data }`.

Create `apps/backoffice/app/api/accommodations/bookings/[id]/route.ts`:

**GET handler:**

- Auth check.
- Query single booking by id with full fields including `internal_notes`, `booking_source`, `cancellation_reason`, plus room join.
- Return `{ booking: data }`.

**PATCH handler:**

- Auth check.
- Parse body: `{ action: string, reason?: string }`.
- Validate `action` is in ACTION_TO_STATUS keys.
- Fetch current booking status.
- Validate transition using VALID_TRANSITIONS — if invalid, return 400 `{ error: 'Invalid status transition', current: currentStatus, attempted: newStatus }`.
- Build update object: `{ status: newStatus }`.
- If action is 'cancel' or 'decline', also set `cancellation_reason: reason || null`.
- If action is 'checkin', set `actual_check_in: new Date().toISOString()`.
- If action is 'checkout', set `actual_check_out: new Date().toISOString()`.
- Execute `.update()` on `accom_bookings` where `id = params.id`.
- Return `{ booking: updatedData }`.

Use `import { createClient } from '@supabase/supabase-js'` with `process.env.NEXT_PUBLIC_SUPABASE_URL` and `process.env.SUPABASE_SERVICE_ROLE_KEY` for admin client. Create a small helper `getSupabaseAdmin()` in the helpers file if one doesn't already exist in backoffice, or reuse existing pattern from `apps/backoffice/lib/supabase.ts`.
</action>
<verify>
TypeScript compiles: `cd apps/backoffice && npx tsc --noEmit --pretty 2>&1 | head -30` (no errors in new API files).
</verify>
<done>
GET /api/accommodations/bookings returns paginated booking list with room join. GET /api/accommodations/bookings/[id] returns full booking detail. PATCH /api/accommodations/bookings/[id] validates transitions and updates status with optional reason.
</done>
</task>

<task type="auto">
  <name>Task 3: Rooms and Property API routes</name>
  <files>
    apps/backoffice/app/api/accommodations/rooms/route.ts
    apps/backoffice/app/api/accommodations/property/route.ts
  </files>
  <action>
Create `apps/backoffice/app/api/accommodations/rooms/route.ts`:

**GET handler:**

- Auth check via validateAdminApiKey.
- Extract `propertyId` from searchParams.
- Query `accom_rooms` where `property_id = propertyId`, ordered by `sort_order ASC, room_number ASC`.
- Select: `id, room_number, room_type, capacity, description, base_price_per_night, currency, images, beds, amenities, is_active, sort_order`.
- Return `{ rooms: data }`.

**POST handler:**

- Auth check.
- Parse body with room fields: `propertyId, room_number, room_type, capacity, description, base_price_per_night, currency, images (string[]), beds (jsonb), amenities (string[]), sort_order`.
- Set `is_active: true` by default.
- Insert into `accom_rooms`.
- Return 201 `{ room: data }`.

**PUT handler:**

- Auth check.
- Parse body with `id` + updatable fields (same as POST minus propertyId).
- Update `accom_rooms` where `id = body.id`.
- To deactivate: set `is_active: false` (soft delete).
- Return `{ room: data }`.

Create `apps/backoffice/app/api/accommodations/property/route.ts`:

**GET handler:**

- Auth check.
- Extract `propertyId` from searchParams.
- Query `accom_properties` by id.
- Select: `id, name, slug, description, address, city, country, latitude, longitude, property_type, booking_mode, check_in_time, check_out_time, house_rules, cancellation_policy, amenities, images, host_name, host_phone, host_whatsapp, host_email, contact_email, deposit_percent, cancellation_penalty_percent, accepted_payment_methods, bank_transfer_info, crypto_wallet_addresses, is_active`.
- Return `{ property: data }`.

**PUT handler:**

- Auth check.
- Parse body with `id` + updatable fields (booking_mode, check_in_time, check_out_time, house_rules, cancellation_policy, deposit_percent, cancellation_penalty_percent, accepted_payment_methods, bank_transfer_info, host_phone, host_whatsapp, host_email, contact_email).
- Update `accom_properties` where `id = body.id`.
- Return `{ property: data }`.
  </action>
  <verify>
  TypeScript compiles: `cd apps/backoffice && npx tsc --noEmit --pretty 2>&1 | head -30`.
  </verify>
  <done>
  Rooms API supports GET list, POST create, PUT update/deactivate. Property API supports GET settings and PUT update. All routes authenticated via ADMIN_API_KEY.
  </done>
  </task>

</tasks>

<verification>
1. All 4 API route files exist and export correct HTTP methods
2. TypeScript compiles without errors: `cd apps/backoffice && npx tsc --noEmit`
3. helpers.ts exports all expected functions and constants
4. BookingStatusBadge renders without errors
5. VALID_TRANSITIONS covers all 4 source statuses with correct target statuses
</verification>

<success_criteria>

- 4 API route files created with proper auth, validation, and Supabase queries
- Shared helpers module with auth, status machine, formatting, WhatsApp URL builder
- BookingStatusBadge reusable component
- Zero TypeScript errors in new files
  </success_criteria>

<output>
After completion, create `.planning/phases/21-owner-dashboard-bookings-property/21-01-SUMMARY.md`
</output>
