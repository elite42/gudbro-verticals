---
phase: 22-owner-dashboard-calendar-pricing
plan: 02
type: execute
wave: 2
depends_on: [22-01]
files_modified:
  - apps/backoffice/app/(dashboard)/accommodations/calendar/page.tsx
  - apps/backoffice/components/accommodations/AvailabilityCalendar.tsx
  - apps/backoffice/components/accommodations/CalendarDetailPanel.tsx
  - apps/backoffice/components/accommodations/SeasonalPricingManager.tsx
  - apps/backoffice/components/accommodations/DiscountSettings.tsx
  - apps/backoffice/components/layout/Sidebar.tsx
autonomous: true

must_haves:
  truths:
    - 'Owner can view a monthly calendar with color-coded dates showing booked, available, and blocked status'
    - 'Owner can block and unblock date ranges for maintenance or personal use'
    - 'Owner can set base price per room type and override prices for specific date ranges (seasonal pricing)'
    - 'Owner can set weekly and monthly discount percentages that automatically apply to qualifying bookings'
    - 'Calendar page is accessible from the sidebar navigation under Accommodations'
  artifacts:
    - path: 'apps/backoffice/app/(dashboard)/accommodations/calendar/page.tsx'
      provides: 'Calendar & Pricing page orchestrating all components'
      min_lines: 80
    - path: 'apps/backoffice/components/accommodations/AvailabilityCalendar.tsx'
      provides: 'Custom month grid with color-coded cells showing status and prices'
      min_lines: 100
    - path: 'apps/backoffice/components/accommodations/CalendarDetailPanel.tsx'
      provides: 'Sidebar/panel showing details for selected date with block/unblock actions'
      min_lines: 60
    - path: 'apps/backoffice/components/accommodations/SeasonalPricingManager.tsx'
      provides: 'List of seasonal pricing overrides with add/edit/delete'
      min_lines: 80
    - path: 'apps/backoffice/components/accommodations/DiscountSettings.tsx'
      provides: 'Weekly and monthly discount sliders with preview calculation'
      min_lines: 50
  key_links:
    - from: 'apps/backoffice/app/(dashboard)/accommodations/calendar/page.tsx'
      to: '/api/accommodations/calendar'
      via: 'fetch on mount and month/room change'
      pattern: 'api/accommodations/calendar'
    - from: 'apps/backoffice/components/accommodations/CalendarDetailPanel.tsx'
      to: '/api/accommodations/room-blocks'
      via: 'POST to create block, DELETE to remove block'
      pattern: 'api/accommodations/room-blocks'
    - from: 'apps/backoffice/components/accommodations/SeasonalPricingManager.tsx'
      to: '/api/accommodations/seasonal-pricing'
      via: 'GET/POST/PUT/DELETE for pricing CRUD'
      pattern: 'api/accommodations/seasonal-pricing'
    - from: 'apps/backoffice/components/accommodations/DiscountSettings.tsx'
      to: '/api/accommodations/property'
      via: 'PUT to save discount percentages'
      pattern: 'api/accommodations/property'
---

<objective>
Build the Calendar & Pricing page with all UI components: monthly calendar grid, detail panel, seasonal pricing manager, discount settings, and sidebar navigation.

Purpose: Owners need a visual interface to manage availability and pricing. This plan creates the complete frontend that consumes the APIs from Plan 22-01.
Output: 5 new component files + 1 new page + sidebar nav update.
</objective>

<execution_context>
@/Users/gianfrancodagostino/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gianfrancodagostino/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-owner-dashboard-calendar-pricing/22-RESEARCH.md
@.planning/phases/22-owner-dashboard-calendar-pricing/22-01-SUMMARY.md

# Existing page patterns to follow:

@apps/backoffice/app/(dashboard)/accommodations/bookings/page.tsx
@apps/backoffice/app/(dashboard)/accommodations/settings/page.tsx

# Existing component patterns:

@apps/backoffice/components/accommodations/RoomManager.tsx

# Calendar grid patterns (existing):

@apps/backoffice/components/reservations/MonthView.tsx

# Helpers (formatBookingPrice, validateAdminApiKey):

@apps/backoffice/lib/accommodations/helpers.ts

# Sidebar nav:

@apps/backoffice/components/layout/Sidebar.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: AvailabilityCalendar component + CalendarDetailPanel</name>
  <files>
    apps/backoffice/components/accommodations/AvailabilityCalendar.tsx
    apps/backoffice/components/accommodations/CalendarDetailPanel.tsx
  </files>
  <action>
**AvailabilityCalendar.tsx** — Custom month grid component (NOT react-day-picker):

Props interface:

```typescript
interface CalendarDay {
  date: Date;
  dateStr: string; // yyyy-MM-dd
  isCurrentMonth: boolean;
  isToday: boolean;
  status: 'available' | 'booked' | 'blocked' | 'partial';
  pricePerNight: number | null; // override price, or null for base price
  priceLabel: string | null; // seasonal pricing label
  bookings: Array<{
    id: string;
    guest_name: string;
    status: string;
    room_id: string;
  }>;
  blocks: Array<{ id: string; reason: string; notes: string | null }>;
}

interface AvailabilityCalendarProps {
  currentMonth: Date;
  onMonthChange: (date: Date) => void;
  days: CalendarDay[];
  selectedDate: string | null; // yyyy-MM-dd
  onDateClick: (dateStr: string) => void;
  rangeStart: string | null;
  rangeEnd: string | null;
  onRangeSelect: (start: string, end: string | null) => void;
  basePricePerNight: number;
  currency: string;
}
```

Implementation:

1. Use date-fns: format, addMonths, subMonths, isToday, isSameDay, startOfWeek, endOfWeek, startOfMonth, endOfMonth, eachDayOfInterval, parseISO
2. Header: left arrow + "January 2026" + right arrow (using Phosphor CaretLeft, CaretRight icons)
3. Day-of-week header row: Mon Tue Wed Thu Fri Sat Sun
4. Grid: 6 rows x 7 columns. Each cell ~h-20 (desktop) / h-16 (mobile)
5. Cell rendering per day:
   - Day number (top-left, dimmed if not current month)
   - Status background color:
     - available: bg-white hover:bg-green-50
     - booked: bg-blue-50 border-blue-200
     - blocked: bg-gray-100 with diagonal stripe CSS (use bg-[repeating-linear-gradient(45deg,transparent,transparent_5px,rgba(0,0,0,0.05)_5px,rgba(0,0,0,0.05)_10px)])
     - partial: bg-amber-50 border-amber-200
   - Today: ring-2 ring-accent (or border-accent)
   - Price label (bottom of cell, text-[10px]): show override price if set, else base price. Use formatBookingPrice from helpers.ts
   - Selected date: ring-2 ring-indigo-500
   - Range selection highlight: bg-indigo-100/50 for dates between rangeStart and rangeEnd
6. Click handler:
   - Single click sets selectedDate
   - For range selection: first click sets rangeStart, second click sets rangeEnd (must be after rangeStart). If rangeStart already set and user clicks before it, reset and use as new rangeStart.
7. Color legend below calendar: 4 small colored squares with labels (Available, Booked, Blocked, Partial)
8. Mobile responsive: cells smaller, price text hidden on very small screens

**CalendarDetailPanel.tsx** — Selected date detail panel:

Props:

```typescript
interface CalendarDetailPanelProps {
  selectedDate: string; // yyyy-MM-dd
  day: CalendarDay;
  rangeStart: string | null;
  rangeEnd: string | null;
  onBlock: (
    dateFrom: string,
    dateTo: string,
    reason: string,
    notes: string
  ) => Promise<void>;
  onUnblock: (blockId: string) => Promise<void>;
  loading: boolean;
  currency: string;
  basePricePerNight: number;
}
```

Implementation:

1. Show date formatted nicely: "Friday, January 15, 2026"
2. Status section: colored badge (same as calendar) with status text
3. If booked: show booking info (guest name, check-in/out dates, status badge using BookingStatusBadge)
4. If blocked: show block reason and notes, with "Remove Block" button (calls onUnblock with block id)
5. Block action section (when available or when range selected):
   - Show date range: rangeStart to rangeEnd (or just selectedDate if no range)
   - Reason dropdown: Maintenance, Personal Use, Other (using <select>)
   - Notes textarea (optional)
   - "Block Dates" button (calls onBlock)
   - Loading state on button during API call
6. Price info: current price for this date (base or override), with override label if applicable
7. Use Phosphor icons: CalendarBlank, Lock, LockOpen, Bed, User
   </action>
   <verify>
   Files exist and have the expected component exports:

- grep "export.\*AvailabilityCalendar" apps/backoffice/components/accommodations/AvailabilityCalendar.tsx
- grep "export.\*CalendarDetailPanel" apps/backoffice/components/accommodations/CalendarDetailPanel.tsx
- grep "formatBookingPrice" apps/backoffice/components/accommodations/AvailabilityCalendar.tsx (confirms price formatting is used)
  </verify>
  <done>AvailabilityCalendar renders a custom month grid with color-coded cells, price labels, range selection, and legend. CalendarDetailPanel shows date details with block/unblock actions.</done>
  </task>

<task type="auto">
  <name>Task 2: SeasonalPricingManager + DiscountSettings + Calendar page + Sidebar nav</name>
  <files>
    apps/backoffice/components/accommodations/SeasonalPricingManager.tsx
    apps/backoffice/components/accommodations/DiscountSettings.tsx
    apps/backoffice/app/(dashboard)/accommodations/calendar/page.tsx
    apps/backoffice/components/layout/Sidebar.tsx
  </files>
  <action>
**SeasonalPricingManager.tsx** — Seasonal pricing CRUD list:

Props:

```typescript
interface SeasonalPricingManagerProps {
  propertyId: string;
  roomId: string | null; // null = show all rooms
  currency: string;
  onRefresh: () => void; // trigger calendar data refresh
}
```

Implementation:

1. Fetch pricing overrides from GET /api/accommodations/seasonal-pricing?propertyId=X&roomId=Y on mount and when roomId changes
2. Display as a list of cards/rows, each showing: label, date range (formatted), price per night (in major units using formatBookingPrice), edit/delete buttons
3. "Add Override" button opens inline form (NOT modal):
   - Date from (input type="date")
   - Date to (input type="date")
   - Price per night (number input, in major currency units -- convert to minor on submit: value _ 100 for non-VND, value _ 1 for VND)
   - Label (text input, optional)
   - Save / Cancel buttons
4. Edit: same inline form, pre-populated. PUT to API with id.
5. Delete: confirm with window.confirm(), then DELETE to API.
6. Handle 409 overlap errors: show error message inline (red text below form)
7. After any mutation, call onRefresh() to update calendar
8. Use AUTH_HEADERS pattern: `const ADMIN_API_KEY = process.env.NEXT_PUBLIC_ADMIN_API_KEY || ''; const AUTH_HEADERS = { Authorization: \`Bearer ${ADMIN_API_KEY}\` };`
9. Use Phosphor icons: PencilSimple, Trash, Plus, CurrencyCircleDollar

**DiscountSettings.tsx** — Weekly/monthly discount controls:

Props:

```typescript
interface DiscountSettingsProps {
  propertyId: string;
  weeklyDiscount: number; // 0-50
  monthlyDiscount: number; // 0-50
  basePricePerNight: number; // for preview calculation
  currency: string;
  onSave: (weekly: number, monthly: number) => Promise<void>;
}
```

Implementation:

1. Two discount controls, each with:
   - Label: "Weekly Discount (7+ nights)" / "Monthly Discount (28+ nights)"
   - Range slider: min=0 max=50 step=1
   - Number input next to slider (synced)
   - Percentage display: "{value}%"
2. Preview calculation (useMemo):
   - Weekly: "7 nights: {formatPrice(base\*7)} - {weekly}% = {formatPrice(total)}"
   - Monthly: "28 nights: {formatPrice(base\*28)} - {monthly}% = {formatPrice(total)}"
   - Only show preview if discount > 0
3. "Save Discounts" button at bottom, calls onSave(weekly, monthly)
4. Saving state indicator
5. Use internal state, initialize from props. Track isDirty to enable/disable save button.

**Calendar page (page.tsx)** — Page orchestrator:

Follow the exact pattern from bookings/page.tsx:

```typescript
'use client';

const ADMIN_API_KEY = process.env.NEXT_PUBLIC_ADMIN_API_KEY || '';
const PROPERTY_ID = process.env.NEXT_PUBLIC_ACCOM_PROPERTY_ID || '';
const AUTH_HEADERS = { Authorization: `Bearer ${ADMIN_API_KEY}` };
```

Implementation:

1. State: currentMonth (Date), selectedDate (string|null), rangeStart/rangeEnd (string|null), selectedRoomId (string|null), rooms (array), calendarData (bookings/blocks/pricing), property (for discounts + currency), loading states
2. On mount: fetch rooms from /api/accommodations/rooms, fetch property from /api/accommodations/property
3. On month change or room change: fetch from /api/accommodations/calendar?propertyId=X&roomId=Y&month=YYYY-MM
4. **Data processing** (useMemo): Transform raw calendar data into CalendarDay[] array:
   - Use eachDayOfInterval to generate grid days (startOfWeek(startOfMonth) to endOfWeek(endOfMonth))
   - For each day, determine status:
     - Check if any booking covers this date (check_in_date <= date < check_out_date, half-open)
     - Check if any block covers this date (date_from <= date < date_to, half-open)
     - Check if any seasonal pricing covers this date
     - Status priority: blocked > booked > partial > available
     - "partial" when viewing all rooms and some rooms are booked but not all
   - Attach bookings, blocks, price info to each day
5. Room filter dropdown at top: "All Rooms" + individual rooms from rooms list
6. Layout:
   - Desktop: 2-column grid. Left: calendar + legend. Right: detail panel (if date selected)
   - Below: SeasonalPricingManager section
   - Below: DiscountSettings section
   - Mobile: single column, detail panel below calendar
7. Block handler: POST to /api/accommodations/room-blocks, then refetch calendar data
8. Unblock handler: DELETE to /api/accommodations/room-blocks, then refetch
9. Discount save handler: PUT to /api/accommodations/property with weekly_discount_percent and monthly_discount_percent, then refetch property
10. Page title: "Calendar & Pricing" with CalendarDots Phosphor icon
11. Loading skeleton during initial fetch

**Sidebar.tsx** — Add calendar nav item:

Find the Accommodations children array in Sidebar.tsx. Add a new entry:

```typescript
{ name: 'Calendar & Pricing', href: '/accommodations/calendar' },
```

Insert it after 'Bookings' and before 'Rooms' (calendar is a primary management tool).

The Accommodations children should become:

```typescript
[
  { name: 'Bookings', href: '/accommodations/bookings' },
  { name: 'Calendar & Pricing', href: '/accommodations/calendar' },
  { name: 'Rooms', href: '/accommodations/rooms' },
  { name: 'Settings', href: '/accommodations/settings' },
  { name: 'QR Codes', href: '/accommodations/qr-codes' },
];
```

  </action>
  <verify>
1. Sidebar has calendar link: grep "calendar" apps/backoffice/components/layout/Sidebar.tsx
2. Page exists: ls apps/backoffice/app/(dashboard)/accommodations/calendar/page.tsx
3. All components exist: ls apps/backoffice/components/accommodations/{SeasonalPricingManager,DiscountSettings,AvailabilityCalendar,CalendarDetailPanel}.tsx
4. TypeScript compilation: npx tsc --noEmit -p apps/backoffice/tsconfig.json (should pass or show only pre-existing errors)
  </verify>
  <done>Calendar & Pricing page is fully wired: room filter, month navigation, color-coded calendar, detail panel with block/unblock, seasonal pricing CRUD, discount sliders with preview, sidebar nav link added.</done>
</task>

</tasks>

<verification>
1. Sidebar shows "Calendar & Pricing" under Accommodations section
2. Calendar page loads with month grid showing color-coded days
3. Clicking a date shows detail panel with status, booking info, and block actions
4. Selecting a range and blocking dates calls POST /api/accommodations/room-blocks
5. Removing a block calls DELETE /api/accommodations/room-blocks
6. SeasonalPricingManager shows list of overrides with add/edit/delete functionality
7. DiscountSettings shows sliders with preview calculations
8. Saving discounts calls PUT /api/accommodations/property
9. Room dropdown filters calendar data by room
10. TypeScript compiles without new errors
</verification>

<success_criteria>
All 5 phase requirements (OCAL-01 through OCAL-05) are met:

- OCAL-01: Monthly calendar with color-coded booking status (available, booked, blocked, partial)
- OCAL-02: Block/unblock date ranges with reason (maintenance, personal use, other)
- OCAL-03: Base price displayed per room (from accom_rooms.base_price_per_night)
- OCAL-04: Seasonal price overrides with date range, price, and label
- OCAL-05: Weekly and monthly discount percentages with slider controls and preview
  </success_criteria>

<output>
After completion, create `.planning/phases/22-owner-dashboard-calendar-pricing/22-02-SUMMARY.md`
</output>
