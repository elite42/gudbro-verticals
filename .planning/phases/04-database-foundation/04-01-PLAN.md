---
phase: 04-database-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - shared/database/migrations/schema/077-accommodations-schema.sql
autonomous: true

must_haves:
  truths:
    - 'accom_properties table exists with name, slug, WiFi, contact, images, amenities, house_rules, timezone, currency, owner_id'
    - 'accom_rooms table exists with room_number, room_type, capacity, floor linked to properties'
    - 'accom_bookings table exists with booking_code (BK-XXXXXX), guest info, check-in/out dates, status, room assignment'
    - 'accom_service_categories table exists with dynamic per-property categories'
    - 'accom_service_items table exists with price (INTEGER), availability times, linked to categories'
    - 'accom_service_translations table exists for multi-language service names'
    - 'generate_booking_code() function creates BK-XXXXXX codes excluding ambiguous characters'
    - 'verify_booking_access() SECURITY DEFINER function validates booking code + last name'
    - 'RLS policies allow owner CRUD, anon SELECT on public tables, service_role bypass'
    - 'All tables use TEXT+CHECK (no ENUMs), UUID PKs, TIMESTAMPTZ, update_updated_at_column() triggers'
  artifacts:
    - path: 'shared/database/migrations/schema/077-accommodations-schema.sql'
      provides: 'Complete accommodations database schema with tables, indexes, triggers, functions, RLS policies, and grants'
      contains: 'accom_properties'
  key_links:
    - from: 'accom_bookings.property_id'
      to: 'accom_properties.id'
      via: 'FOREIGN KEY'
      pattern: 'REFERENCES accom_properties'
    - from: 'accom_bookings.room_id'
      to: 'accom_rooms.id'
      via: 'FOREIGN KEY'
      pattern: 'REFERENCES accom_rooms'
    - from: 'accom_service_items.category_id'
      to: 'accom_service_categories.id'
      via: 'FOREIGN KEY'
      pattern: 'REFERENCES accom_service_categories'
    - from: 'accom_properties.owner_id'
      to: 'accounts.id'
      via: 'FOREIGN KEY'
      pattern: 'REFERENCES accounts'
    - from: 'verify_booking_access'
      to: 'accom_bookings'
      via: 'SECURITY DEFINER query'
      pattern: 'FROM accom_bookings'
---

<objective>
Create the complete accommodations database schema in a single migration file: 6 tables, 2 functions, triggers, indexes, RLS policies, and role grants.

Purpose: This is the data foundation for the entire In-Stay Dashboard. Every subsequent phase (API, frontend, F&B integration) depends on these tables existing with correct structure, constraints, and security policies.

Output: `shared/database/migrations/schema/077-accommodations-schema.sql` containing all tables, functions, triggers, indexes, RLS policies, and grants.
</objective>

<execution_context>
@/Users/gianfrancodagostino/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gianfrancodagostino/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-database-foundation/04-RESEARCH.md
@.planning/phases/04-database-foundation/04-CONTEXT.md
@shared/database/migrations/schema/073-useful-numbers.sql
@shared/database/migrations/schema/068-site-customization.sql
@shared/database/migrations/schema/050-b2b-conventions.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create tables, functions, and triggers</name>
  <files>shared/database/migrations/schema/077-accommodations-schema.sql</files>
  <action>
Create migration file `077-accommodations-schema.sql` with clearly labeled sections. Follow the exact formatting pattern from migrations 068 and 073 (header comment block, section separators with `-- ====` lines).

**Tables to create (in order for FK dependencies):**

1. **accom_properties** — Property identity, location, contact, WiFi, settings, images, amenities, house rules, owner.
   - Columns from RESEARCH.md Pattern: id (UUID PK), name, slug (UNIQUE), description, tagline, property_type (TEXT+CHECK: apartment/hotel/hostel/villa/guesthouse/resort/other), address, city, country_code (default 'VN'), latitude, longitude, timezone (default 'Asia/Ho_Chi_Minh'), host_name, host_phone, host_email, emergency_phone, wifi_ssid, wifi_password, currency (default 'VND'), default_language (default 'en'), supported_languages (TEXT[] default '{"en"}'), check_in_time (TIME default '14:00'), check_out_time (TIME default '11:00'), images (JSONB default '[]'), cover_image_url, amenities (JSONB default '[]'), house_rules (TEXT), owner_id (UUID REFERENCES accounts(id)), is_active (BOOLEAN default true), created_at, updated_at
   - Index on slug, owner_id

2. **accom_rooms** — Rooms within a property.
   - Columns: id, property_id (FK accom_properties ON DELETE CASCADE), room_number (TEXT NOT NULL), room_type (TEXT+CHECK: studio/single/double/twin/suite/deluxe/dormitory/other), capacity (INTEGER default 2), floor (TEXT), description, is_active (BOOLEAN default true), created_at, updated_at
   - UNIQUE(property_id, room_number)
   - Index on property_id

3. **accom_bookings** — Guest bookings with verification codes.
   - Columns: id, property_id (FK), room_id (FK), booking_code (TEXT NOT NULL UNIQUE), guest_name, guest_last_name, guest_email, guest_phone, guest_count (INTEGER default 1), check_in_date (DATE), check_out_date (DATE), status (TEXT+CHECK: pending/confirmed/checked_in/checked_out/cancelled/no_show, default 'confirmed'), special_requests, internal_notes, booking_source (TEXT+CHECK: direct/booking_com/airbnb/expedia/walk_in/phone/other, default 'direct'), created_at, updated_at
   - CHECK(check_out_date > check_in_date)
   - Index on property_id, booking_code, (property_id, check_in_date, check_out_date)

4. **accom_service_categories** — Dynamic service categories per property.
   - Columns: id, property_id (FK), name, slug, description, icon, display_order (INTEGER default 0), is_active (BOOLEAN default true), created_at, updated_at
   - UNIQUE(property_id, slug)

5. **accom_service_items** — Items within service categories.
   - Columns: id, category_id (FK accom_service_categories ON DELETE CASCADE), property_id (FK), name, description, price (INTEGER default 0), image_url, is_always_available (BOOLEAN default true), available_from (TIME), available_until (TIME), display_order (INTEGER default 0), is_active (BOOLEAN default true), created_at, updated_at

6. **accom_service_translations** — Multi-language for service categories and items.
   - Columns: id, entity_type (TEXT+CHECK: 'category'/'item'), entity_id (UUID NOT NULL), language_code (VARCHAR(5) NOT NULL), name (TEXT NOT NULL), description (TEXT), is_machine_translated (BOOLEAN default false), created_at, updated_at
   - UNIQUE(entity_type, entity_id, language_code)
   - Note: Use a single translations table with entity_type discriminator instead of two separate tables. This is simpler for a small number of translatable entities.

**Functions to create (BEFORE bookings table for trigger dependency):**

1. **generate_booking_code()** — Returns TEXT. SECURITY DEFINER, SET search_path = public. Uses chars 'ABCDEFGHJKMNPQRSTUVWXYZ23456789' (excludes 0/O, 1/I/L). LOOP generates 'BK-' + 6 random chars, checks uniqueness against accom_bookings, exits when unique.

2. **set_booking_code()** — Trigger function. SECURITY DEFINER, SET search_path = public. On BEFORE INSERT, if NEW.booking_code IS NULL, sets it to generate_booking_code(). Returns NEW.

3. **verify_booking_access(p_booking_code TEXT, p_last_name TEXT)** — Returns TABLE(is_valid BOOLEAN, property_id UUID, booking_id UUID, room_id UUID, guest_name TEXT, check_in DATE, check_out DATE). SECURITY DEFINER, SET search_path = public. Queries accom_bookings WHERE booking_code matches AND LOWER(guest_last_name) = LOWER(p_last_name) AND check_in_date <= CURRENT_DATE AND check_out_date + INTERVAL '24 hours' >= NOW() AND status IN ('confirmed', 'checked_in'). If NOT FOUND, return row with is_valid = false and NULLs.

**Triggers:**

- `accom_bookings_set_code` BEFORE INSERT on accom_bookings -> set_booking_code()
- `update_updated_at_column()` trigger on ALL 6 tables (use existing function, just CREATE TRIGGER)

**IMPORTANT implementation notes:**

- Create generate_booking_code() and set_booking_code() BEFORE the accom_bookings table, since the trigger references them. OR create them after the table but before the trigger — the key point is that the trigger creation must come after both the table and the function exist.
- Use `CREATE TABLE IF NOT EXISTS` for all tables
- Use `CREATE OR REPLACE FUNCTION` for all functions
- All CHECK constraints must use TEXT (NEVER CREATE TYPE ... AS ENUM)
- UUID values in seed data must use only hex characters (0-9, a-f)
- PostgreSQL array syntax: `'{"en"}'` not `'["en"]'`
  </action>
  <verify>
  Review the SQL file for:

1. All 6 tables present (accom_properties, accom_rooms, accom_bookings, accom_service_categories, accom_service_items, accom_service_translations)
2. All 3 functions present (generate_booking_code, set_booking_code, verify_booking_access)
3. All functions have SECURITY DEFINER and SET search_path = public
4. All TEXT+CHECK constraints (no ENUMs)
5. All tables have created_at/updated_at TIMESTAMPTZ
6. Trigger for update_updated_at_column on all 6 tables
7. Trigger accom_bookings_set_code on accom_bookings
8. FK relationships correct (rooms->properties, bookings->properties+rooms, service_items->categories+properties)
9. UNIQUE constraints on slug fields and booking_code
   </verify>
   <done>Migration file exists with 6 tables, 3 functions, 8 triggers (6 updated_at + 1 booking code + 1 booking code trigger = 8), correct FK relationships, and TEXT+CHECK constraints throughout</done>
   </task>

<task type="auto">
  <name>Task 2: Add RLS policies, indexes, and role grants</name>
  <files>shared/database/migrations/schema/077-accommodations-schema.sql</files>
  <action>
In the SAME migration file (077-accommodations-schema.sql), add sections for RLS and grants AFTER all table and function definitions.

**Enable RLS on all 6 tables:**

```sql
ALTER TABLE accom_properties ENABLE ROW LEVEL SECURITY;
-- (repeat for all 6)
```

**RLS Policies:**

For **accom_properties**:

- `accom_properties_anon_read`: FOR SELECT TO anon USING (is_active = true)
- `accom_properties_owner_manage`: FOR ALL TO authenticated USING (owner_id IN (SELECT id FROM accounts WHERE auth_id = auth.uid()))

For **accom_rooms**:

- `accom_rooms_anon_read`: FOR SELECT TO anon USING (is_active = true)
- `accom_rooms_owner_manage`: FOR ALL TO authenticated USING (property_id IN (SELECT id FROM accom_properties WHERE owner_id IN (SELECT id FROM accounts WHERE auth_id = auth.uid())))

For **accom_bookings**:

- `accom_bookings_owner_manage`: FOR ALL TO authenticated USING (property_id IN (SELECT id FROM accom_properties WHERE owner_id IN (SELECT id FROM accounts WHERE auth_id = auth.uid())))
- NO anon policy — guest access goes through verify_booking_access() SECURITY DEFINER function, not RLS

For **accom_service_categories**:

- `accom_service_categories_anon_read`: FOR SELECT TO anon USING (is_active = true)
- `accom_service_categories_owner_manage`: FOR ALL TO authenticated USING (property_id IN (SELECT id FROM accom_properties WHERE owner_id IN (SELECT id FROM accounts WHERE auth_id = auth.uid())))

For **accom_service_items**:

- `accom_service_items_anon_read`: FOR SELECT TO anon USING (is_active = true)
- `accom_service_items_owner_manage`: FOR ALL TO authenticated USING (property_id IN (SELECT id FROM accom_properties WHERE owner_id IN (SELECT id FROM accounts WHERE auth_id = auth.uid())))

For **accom_service_translations**:

- `accom_service_translations_anon_read`: FOR SELECT TO anon USING (true) — translations are always public
- `accom_service_translations_owner_manage`: FOR ALL TO authenticated USING (true) — simplified, owner check happens at parent level

**Role Grants (CRITICAL for guest access):**

```sql
-- Anon needs SELECT on public-facing tables
GRANT SELECT ON accom_properties TO anon;
GRANT SELECT ON accom_rooms TO anon;
GRANT SELECT ON accom_service_categories TO anon;
GRANT SELECT ON accom_service_items TO anon;
GRANT SELECT ON accom_service_translations TO anon;

-- Anon needs EXECUTE on verification function
GRANT EXECUTE ON FUNCTION verify_booking_access(TEXT, TEXT) TO anon;

-- Authenticated gets full access (RLS controls row-level)
GRANT ALL ON accom_properties TO authenticated;
GRANT ALL ON accom_rooms TO authenticated;
GRANT ALL ON accom_bookings TO authenticated;
GRANT ALL ON accom_service_categories TO authenticated;
GRANT ALL ON accom_service_items TO authenticated;
GRANT ALL ON accom_service_translations TO authenticated;
```

**Indexes (for query performance):**

- `idx_accom_properties_slug` ON accom_properties(slug)
- `idx_accom_properties_owner` ON accom_properties(owner_id)
- `idx_accom_rooms_property` ON accom_rooms(property_id)
- `idx_accom_bookings_property` ON accom_bookings(property_id)
- `idx_accom_bookings_code` ON accom_bookings(booking_code)
- `idx_accom_bookings_dates` ON accom_bookings(property_id, check_in_date, check_out_date)
- `idx_accom_service_categories_property` ON accom_service_categories(property_id)
- `idx_accom_service_items_category` ON accom_service_items(category_id)
- `idx_accom_service_items_property` ON accom_service_items(property_id)
- `idx_accom_service_translations_entity` ON accom_service_translations(entity_type, entity_id)

Use `CREATE INDEX IF NOT EXISTS` for all indexes.
</action>
<verify>
Review the SQL file for:

1. RLS enabled on all 6 tables
2. anon SELECT policies on properties, rooms, service_categories, service_items, translations
3. Owner CRUD policies on all 6 tables using accounts.auth_id = auth.uid() pattern
4. NO anon policy on accom_bookings (guest access via function only)
5. GRANT SELECT TO anon on 5 public tables
6. GRANT EXECUTE on verify_booking_access TO anon
7. GRANT ALL TO authenticated on all 6 tables
8. 10 indexes created
9. No USING(true) for write policies on untrusted roles
   </verify>
   <done>RLS policies enforce owner CRUD via auth.uid(), anon read on public tables, no direct anon access to bookings, verify_booking_access executable by anon, all indexes created</done>
   </task>

</tasks>

<verification>
1. File `shared/database/migrations/schema/077-accommodations-schema.sql` exists
2. Contains CREATE TABLE for all 6 accom_* tables
3. Contains CREATE OR REPLACE FUNCTION for generate_booking_code, set_booking_code, verify_booking_access
4. All functions have SECURITY DEFINER and SET search_path = public
5. All tables have UUID PK with gen_random_uuid()
6. All tables have created_at/updated_at TIMESTAMPTZ
7. All type columns use TEXT + CHECK (zero ENUMs)
8. RLS enabled on all 6 tables
9. GRANT SELECT TO anon on public tables
10. GRANT EXECUTE ON verify_booking_access TO anon
11. No syntax errors in SQL (proper semicolons, matching parentheses)
</verification>

<success_criteria>

- 077-accommodations-schema.sql contains the complete schema: 6 tables, 3 functions, triggers, indexes, RLS policies, and grants
- All GUDBRO database standards followed: TEXT+CHECK, UUID PKs, gen_random_uuid(), TIMESTAMPTZ, update_updated_at_column() triggers
- Guest access pattern uses SECURITY DEFINER function (not RLS-based booking code verification)
- Owner access uses P5 accounts pattern (accounts.auth_id = auth.uid())
- Anon role has SELECT grants on public-facing tables
  </success_criteria>

<output>
After completion, create `.planning/phases/04-database-foundation/04-01-SUMMARY.md`
</output>
