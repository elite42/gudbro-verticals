---
phase: 26-progressive-authentication
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - shared/database/migrations/schema/089-progressive-auth.sql
  - apps/accommodations/frontend/lib/auth.ts
  - apps/accommodations/frontend/app/api/stay/room/[roomCode]/verify/route.ts
  - apps/accommodations/frontend/app/api/stay/room/[roomCode]/route.ts
  - apps/accommodations/frontend/app/api/stay/[code]/orders/route.ts
  - apps/accommodations/frontend/types/stay.ts
autonomous: true

must_haves:
  truths:
    - 'POST /api/stay/room/[roomCode]/verify with correct last name returns a full-tier JWT'
    - 'POST /api/stay/room/[roomCode]/verify with correct PIN returns a full-tier JWT'
    - 'POST /api/stay/room/[roomCode]/verify with wrong credentials returns 401'
    - 'POST /api/stay/[code]/orders rejects browse-tier tokens with 403'
    - 'Existing /stay/[code] booking flow tokens (no accessTier claim) still work as full tier'
    - 'GET /api/stay/room/[roomCode] response includes verificationMethod field'
  artifacts:
    - path: 'shared/database/migrations/schema/089-progressive-auth.sql'
      provides: 'verification_pin column on accom_bookings, guest_verification_method on accom_properties, updated resolve_room_access'
      contains: 'verification_pin'
    - path: 'apps/accommodations/frontend/app/api/stay/room/[roomCode]/verify/route.ts'
      provides: 'Verification endpoint for room-based session upgrade'
      exports: ['POST']
    - path: 'apps/accommodations/frontend/lib/auth.ts'
      provides: 'requireFullAccess guard function'
      exports: ['requireFullAccess']
  key_links:
    - from: 'apps/accommodations/frontend/app/api/stay/room/[roomCode]/verify/route.ts'
      to: "supabase.rpc('resolve_room_access')"
      via: 'Room code resolution before verification'
      pattern: 'resolve_room_access'
    - from: 'apps/accommodations/frontend/app/api/stay/[code]/orders/route.ts'
      to: 'lib/auth.ts requireFullAccess'
      via: 'Access tier guard on write endpoint'
      pattern: 'requireFullAccess'
---

<objective>
Backend infrastructure for progressive authentication: database migration (PIN column, verification method config), verify API endpoint for room-based session upgrade, access tier guard on write endpoints, and updated room resolve response.

Purpose: Enable the frontend (Plan 26-02) to upgrade browse-tier sessions to full-tier via inline verification, and gate paid actions behind full-tier access.
Output: Migration SQL, verify endpoint, requireFullAccess guard, updated room resolve response with verificationMethod.
</objective>

<execution_context>
@/Users/gianfrancodagostino/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gianfrancodagostino/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/26-progressive-authentication/26-CONTEXT.md
@.planning/phases/26-progressive-authentication/26-RESEARCH.md
@.planning/phases/25-room-code-foundation/25-01-SUMMARY.md
@.planning/phases/25-room-code-foundation/25-02-SUMMARY.md

Key source files to read before implementing:
@apps/accommodations/frontend/lib/auth.ts
@apps/accommodations/frontend/app/api/stay/room/[roomCode]/route.ts
@apps/accommodations/frontend/app/api/stay/verify/route.ts
@apps/accommodations/frontend/app/api/stay/[code]/orders/route.ts
@apps/accommodations/frontend/types/stay.ts
@shared/database/migrations/schema/088-room-codes.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Database migration + verify endpoint + requireFullAccess guard</name>
  <files>
    shared/database/migrations/schema/089-progressive-auth.sql
    apps/accommodations/frontend/app/api/stay/room/[roomCode]/verify/route.ts
    apps/accommodations/frontend/lib/auth.ts
    apps/accommodations/frontend/types/stay.ts
  </files>
  <action>
**1. Migration 089-progressive-auth.sql:**
- Add `verification_pin TEXT` column to `accom_bookings` (nullable, only set when owner uses PIN method)
- Add `guest_verification_method TEXT DEFAULT 'last_name'` to `accom_properties` with CHECK IN ('last_name', 'pin')
- Update `resolve_room_access` function to ALSO return `guest_verification_method` from the joined `accom_properties` row (add it to the RETURNS TABLE definition and SELECT). This is needed so the frontend knows which verification input to show.
- Add COMMENT ON COLUMN for both new columns

**2. lib/auth.ts — Add requireFullAccess helper:**

```typescript
export function requireFullAccess(guest: GuestTokenPayload): boolean {
  return (guest.accessTier || 'full') === 'full';
}
```

This treats missing accessTier as 'full' for backward compatibility with existing booking-flow tokens.

**3. types/stay.ts — Add verification types:**

- Add `VerificationMethod` type: `'last_name' | 'pin'`
- Add `VerifyRequest` type: `{ method: VerificationMethod; value: string }`
- Add `VerifyResponse` type: `{ token: string; stay: StayData }` (reuse existing StayData)
- Add `verification_method` field to `RoomResolveResponse` type
- Add `'verification_required'` to error types

**4. POST /api/stay/room/[roomCode]/verify endpoint:**

- Accepts `{ method: 'lastName' | 'pin', value: string }` in request body
- Step 1: Validate roomCode format with existing regex `/^RM-[A-HJ-NP-Z2-9]{8}$/`
- Step 2: Call `supabase.rpc('resolve_room_access', { p_room_code: roomCode })`
- Step 3: If no active booking, return 404 `{ error: 'no_active_booking' }`
- Step 4: Fetch the booking row from accom_bookings using the resolved booking_id. Need guest_last_name (for name method) and verification_pin (for PIN method)
- Step 5: Verify based on method:
  - **lastName**: Normalize both input and stored name using `String.normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase().trim()`. Input must be >= 3 chars. Stored name must START WITH the normalized input (partial match).
  - **pin**: Exact match of value against booking.verification_pin. If no PIN set on booking, return 401.
- Step 6: On verification failure, return 401 `{ error: 'verification_failed' }`
- Step 7: On success, fetch full stay data for the booking (property info, services, dates — same shape as existing /api/stay/verify response)
- Step 8: Sign new full-tier JWT using `signGuestToken({ bookingId, propertyId, checkoutDate, accessTier: 'full', roomCode })`
- Step 9: Return 200 `{ data: { token, stay: fullStayData } }`

Use `createClient` from `@supabase/supabase-js` with `SUPABASE_URL` + `SUPABASE_SERVICE_ROLE_KEY` (same pattern as existing verify route). Follow the existing `/api/stay/verify/route.ts` as a template for stay data assembly.

**CRITICAL — backward compat:** The existing `/api/stay/verify` endpoint must NOT be modified. It continues to issue tokens without explicit accessTier (which default to 'full').

**Rate limiting (lightweight):** Implement server-side rate limiting using an in-memory Map keyed by roomCode. Track attempts per room code with timestamps. After 5 failed attempts within 5 minutes, return 429 `{ error: 'too_many_attempts', retryAfter: remainingCooldownSeconds }`. Clear entries older than 5 minutes on each check. This is sufficient for Phase 26 — hardened rate limiting comes in Phase 27.
</action>
<verify>

- `npx tsc --noEmit` passes in apps/accommodations/frontend
- Migration SQL is valid (no syntax errors — check with a quick review)
- The verify route file exports POST
- auth.ts exports requireFullAccess
- types/stay.ts includes VerificationMethod, VerifyRequest, VerifyResponse types
  </verify>
  <done>
- Migration 089 adds verification_pin to accom_bookings and guest_verification_method to accom_properties
- resolve_room_access returns guest_verification_method
- POST /api/stay/room/[roomCode]/verify validates credentials and returns full-tier JWT + stay data
- requireFullAccess helper exists in auth.ts
- Rate limiting blocks after 5 failed attempts per room code
  </done>
  </task>

<task type="auto">
  <name>Task 2: Access tier gating on write endpoints + room resolve response update</name>
  <files>
    apps/accommodations/frontend/app/api/stay/[code]/orders/route.ts
    apps/accommodations/frontend/app/api/stay/room/[roomCode]/route.ts
  </files>
  <action>
**1. Gate POST /api/stay/[code]/orders with requireFullAccess:**
- Read the existing orders route.ts
- Find the POST handler where `authenticateGuest` is called
- After the existing auth check, add tier check:
  ```typescript
  import { requireFullAccess } from '@/lib/auth';
  // ... after authenticateGuest
  if (!requireFullAccess(guest)) {
    return NextResponse.json({ error: 'verification_required' }, { status: 403 });
  }
  ```
- The GET handler (if exists) should NOT be gated — order history viewing could be browse-tier, but since browse users have no orders, it's moot. Leave GET as-is for now.
- **IMPORTANT:** Tokens without accessTier (from existing /stay/[code] flow) default to 'full' in verifyGuestToken, so requireFullAccess returns true for them. Zero regression.

**2. Update GET /api/stay/room/[roomCode] response:**

- The resolve_room_access RPC will now return `guest_verification_method` (after migration 089)
- Add `verificationMethod` to the response JSON when there's an active booking:
  ```typescript
  // In the active booking branch of the response
  verificationMethod: result.guest_verification_method || 'last_name';
  ```
- Update the response type in the route to include this field
- When no active booking, do NOT include verificationMethod (no need to verify)

**Do NOT modify any other endpoints.** Phase 27 will add gating to additional write endpoints. For now, only the orders POST endpoint needs gating (it's the only write endpoint guests use from the dashboard).
</action>
<verify>

- `npx tsc --noEmit` passes in apps/accommodations/frontend
- `pnpm build --filter=accommodations-frontend` succeeds (or `next build` in the accommodations frontend dir)
- The orders POST route imports and uses requireFullAccess
- The room resolve route returns verificationMethod in active-booking responses
  </verify>
  <done>
- POST /api/stay/[code]/orders returns 403 for browse-tier tokens
- Existing full-tier tokens (from /stay/[code] flow) continue to work for ordering
- GET /api/stay/room/[roomCode] response includes verificationMethod when active booking exists
- Zero regressions on existing booking flow
  </done>
  </task>

</tasks>

<verification>
- TypeScript compiles without errors
- Build succeeds
- Migration SQL is syntactically valid
- Existing /api/stay/verify endpoint is UNTOUCHED
- Existing /stay/[code] dashboard flow is unaffected (tokens without accessTier still work as full)
</verification>

<success_criteria>

1. Migration 089 exists with verification_pin and guest_verification_method columns
2. POST /api/stay/room/[roomCode]/verify endpoint handles both lastName and pin verification, returns full-tier JWT
3. requireFullAccess guard exists and is applied to orders POST endpoint
4. Room resolve response includes verificationMethod for active bookings
5. All backward compatibility preserved — no regressions on existing flows
   </success_criteria>

<output>
After completion, create `.planning/phases/26-progressive-authentication/26-01-SUMMARY.md`
</output>
