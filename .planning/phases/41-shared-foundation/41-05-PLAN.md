---
phase: 41-shared-foundation
plan: 05
type: execute
wave: 2
depends_on: ['41-01', '41-03']
files_modified:
  - apps/pharmacy/frontend/lib/currency.ts
  - apps/pharmacy/frontend/package.json
  - apps/workshops/frontend/lib/currency.ts
  - apps/workshops/frontend/package.json
  - apps/pharmacy/frontend/hooks/usePriceFormat.ts
  - apps/pharmacy/frontend/lib/currency-converter.ts
  - apps/pharmacy/frontend/lib/currency-preferences.ts
  - apps/workshops/frontend/hooks/usePriceFormat.ts
  - apps/workshops/frontend/lib/currency-converter.ts
  - apps/workshops/frontend/lib/currency-preferences.ts
  - apps/gym/frontend/components/BottomNav.tsx
  - apps/laundry/frontend/components/BottomNav.tsx
  - apps/pharmacy/frontend/components/BottomNav.tsx
  - apps/workshops/frontend/components/BottomNav.tsx
autonomous: true

must_haves:
  truths:
    - 'pharmacy and workshops import usePriceFormat from @gudbro/hooks instead of local copies'
    - 'pharmacy and workshops import currency utilities from @gudbro/utils via lib/currency.ts'
    - 'workshops consumers updated to use standard API (formatPrice instead of format, formatPriceCompact instead of formatDual)'
    - 'gym, laundry, pharmacy, workshops all import BottomNav from @gudbro/ui instead of local copies'
    - 'All local duplicates (usePriceFormat, currency-converter, currency-preferences, BottomNav) are deleted from these apps'
  artifacts:
    - path: 'apps/pharmacy/frontend/lib/currency.ts'
      provides: 'App-specific currency instances'
      contains: 'createCurrencyPreferencesStore'
    - path: 'apps/workshops/frontend/lib/currency.ts'
      provides: 'App-specific currency instances'
      contains: 'createCurrencyPreferencesStore'
  key_links:
    - from: 'apps/workshops/frontend'
      to: '@gudbro/hooks'
      via: "import { usePriceFormat } from '@gudbro/hooks'"
      pattern: 'from.*@gudbro/hooks'
    - from: 'apps/pharmacy/frontend'
      to: '@gudbro/ui'
      via: "import { BottomNav } from '@gudbro/ui'"
      pattern: 'from.*@gudbro/ui'
---

<objective>
Migrate pharmacy and workshops to shared hooks/utils (with workshops API adaptation), and migrate all 4 BottomNav apps (gym, laundry, pharmacy, workshops) to use @gudbro/ui BottomNav. Delete all remaining duplicates.

Purpose: Pharmacy follows the standard pattern (like coffeeshop/gym/laundry). Workshops is the divergent case -- it uses different function names (format/formatDual vs formatPrice/formatPriceCompact) and a functional currency-preferences API. This plan handles the workshops adaptation carefully. It also completes the BottomNav migration for all 4 apps.

Output: pharmacy + workshops migrated to shared packages, 4 BottomNav local copies deleted, 6 currency duplicate files deleted
</objective>

<execution_context>
@/Users/gianfrancodagostino/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gianfrancodagostino/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/41-shared-foundation/41-RESEARCH.md
@.planning/phases/41-shared-foundation/41-01-SUMMARY.md
@.planning/phases/41-shared-foundation/41-03-SUMMARY.md

# Workshops divergent implementations (study these carefully):

@apps/workshops/frontend/hooks/usePriceFormat.ts
@apps/workshops/frontend/lib/currency-converter.ts
@apps/workshops/frontend/lib/currency-preferences.ts

# Pharmacy standard implementations:

@apps/pharmacy/frontend/hooks/usePriceFormat.ts
@apps/pharmacy/frontend/lib/currency-converter.ts
@apps/pharmacy/frontend/lib/currency-preferences.ts

# BottomNav implementations to migrate:

@apps/gym/frontend/components/BottomNav.tsx
@apps/laundry/frontend/components/BottomNav.tsx
@apps/pharmacy/frontend/components/BottomNav.tsx
@apps/workshops/frontend/components/BottomNav.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate pharmacy and workshops currency to shared packages</name>
  <files>
    apps/pharmacy/frontend/lib/currency.ts
    apps/pharmacy/frontend/package.json
    apps/workshops/frontend/lib/currency.ts
    apps/workshops/frontend/package.json
    apps/pharmacy/frontend/hooks/usePriceFormat.ts (DELETE)
    apps/pharmacy/frontend/lib/currency-converter.ts (DELETE)
    apps/pharmacy/frontend/lib/currency-preferences.ts (DELETE)
    apps/workshops/frontend/hooks/usePriceFormat.ts (DELETE)
    apps/workshops/frontend/lib/currency-converter.ts (DELETE)
    apps/workshops/frontend/lib/currency-preferences.ts (DELETE)
  </files>
  <action>
    **Pharmacy (standard migration -- same as coffeeshop/gym/laundry):**
    1. Add @gudbro/* workspace dependencies to package.json
    2. Create lib/currency.ts setup file with app-specific config (storageKeyPrefix: 'gudbro-pharmacy')
    3. Update all imports: `@/hooks/usePriceFormat` -> `@gudbro/hooks`, `@/lib/currency-*` -> `@/lib/currency`
    4. Delete local duplicates

    **Workshops (divergent -- needs careful handling):**
    1. Add @gudbro/* workspace dependencies to package.json
    2. Create lib/currency.ts setup file. Workshops uses a different pattern:
       - Old: functional API (getCurrencyPreference/setCurrencyPreference/onCurrencyChange)
       - New: store-based API (currencyPreferencesStore.get()/set())
       - Old event: `gudbro-currency-change`
       - New event: `currency-preferences-updated`
       Read workshops' currency-preferences.ts carefully to identify the storageKeyPrefix it uses.
    3. Update workshops consumers of usePriceFormat:
       - Old API: `{ currency, format, formatDual, formatVND }`
       - New API: `{ formatPrice, formatPriceCompact, currencyPrefs, baseCurrency }`
       - Find every file that uses `format(price)` or `formatDual(price)` and update to `formatPrice(price)` / `formatPriceCompact(price)`
       - Find every file that uses `getCurrencyPreference()` / `setCurrencyPreference()` / `onCurrencyChange()` and update to store-based API
    4. Delete local duplicates

    Run `pnpm install` after package.json updates.

    CRITICAL for workshops: Search thoroughly for ALL consumers of the old API. Missing even one will cause build failures. Use grep across the entire workshops/frontend directory.

  </action>
  <verify>
    Run `pnpm --filter pharmacy build && pnpm --filter workshops build` -- both must succeed.
    Run `grep -r "from.*@/hooks/usePriceFormat" apps/pharmacy/ apps/workshops/` -- must return ZERO.
    Run `grep -r "from.*@/lib/currency-converter" apps/pharmacy/ apps/workshops/` -- must return ZERO.
    Run `grep -r "from.*@/lib/currency-preferences" apps/pharmacy/ apps/workshops/` -- must return ZERO.
    Run `grep -r "getCurrencyPreference\|setCurrencyPreference\|onCurrencyChange" apps/workshops/frontend/ --include="*.ts" --include="*.tsx"` -- must return ZERO (old API fully replaced).
    Run `ls apps/pharmacy/frontend/hooks/usePriceFormat.ts apps/workshops/frontend/hooks/usePriceFormat.ts 2>/dev/null` -- must return no files.
  </verify>
  <done>
    pharmacy and workshops import from @gudbro/hooks and @gudbro/utils. Workshops consumers updated from format/formatDual to formatPrice/formatPriceCompact and from functional to store-based currency-preferences API. All 6 local duplicate files deleted. Both apps build successfully.
  </done>
</task>

<task type="auto">
  <name>Task 2: Migrate BottomNav for gym, laundry, pharmacy, workshops to @gudbro/ui</name>
  <files>
    apps/gym/frontend/components/BottomNav.tsx (DELETE)
    apps/laundry/frontend/components/BottomNav.tsx (DELETE)
    apps/pharmacy/frontend/components/BottomNav.tsx (DELETE)
    apps/workshops/frontend/components/BottomNav.tsx (DELETE)
  </files>
  <action>
    For each of the 4 apps (gym, laundry, pharmacy, workshops):

    **Step 1: Read the current BottomNav to understand nav items and config**
    Each app defines different nav items (Home, Menu/Classes/Services, Orders/Cart, Profile, etc.), different activeColor CSS variables, and different center button behavior. Document these per app before migrating.

    **Step 2: Update consumers**
    Find every file that imports from `@/components/BottomNav` (or similar path). Replace with:
    ```typescript
    import { BottomNav, type NavItem } from '@gudbro/ui';
    ```
    Each consumer must define a local `NavItem[]` array and pass it to the shared `<BottomNav>`:
    ```typescript
    const navItems: NavItem[] = [
      { label: 'Home', href: '/', icon: (active) => <House weight={active ? 'fill' : 'regular'} size={24} /> },
      // ... app-specific items from current BottomNav
    ];
    <BottomNav items={navItems} activeColor="var(--orange-hex)" />
    ```

    For gym/laundry (center button pattern): Pass `onCenterClick` and optionally `centerBadge`.
    For pharmacy/workshops (center link pattern): Just include the center item in the items array with `isCenter: true`.

    **Step 3: Ensure @gudbro/ui dependency in package.json** (should already be present from Task 1 or Plan 41-04, but verify)

    **Step 4: Delete local BottomNav files**
    ```
    rm apps/gym/frontend/components/BottomNav.tsx
    rm apps/laundry/frontend/components/BottomNav.tsx
    rm apps/pharmacy/frontend/components/BottomNav.tsx
    rm apps/workshops/frontend/components/BottomNav.tsx
    ```

    IMPORTANT: Do NOT touch coffeeshop's BottomNav -- it is at a different path (components/v2/BottomNav.tsx) and may have a different architecture. Do NOT touch accommodations, tours, wellness, or waiter BottomNavs -- they are out of scope for this phase.

  </action>
  <verify>
    Run `pnpm --filter gym build && pnpm --filter laundry build && pnpm --filter pharmacy build && pnpm --filter workshops build` -- all must succeed.
    Run `ls apps/gym/frontend/components/BottomNav.tsx apps/laundry/frontend/components/BottomNav.tsx apps/pharmacy/frontend/components/BottomNav.tsx apps/workshops/frontend/components/BottomNav.tsx 2>/dev/null` -- must return no files.
    Run `grep -r "from.*@gudbro/ui" apps/gym/frontend/ apps/laundry/frontend/ apps/pharmacy/frontend/ apps/workshops/frontend/ | grep -i bottomnav` -- should show shared imports.
  </verify>
  <done>
    gym, laundry, pharmacy, workshops all import BottomNav from @gudbro/ui. All 4 local BottomNav files deleted. Each app passes its own NavItem[] and activeColor. All apps build successfully.
  </done>
</task>

</tasks>

<verification>
1. `pnpm --filter pharmacy build && pnpm --filter workshops build` passes
2. `pnpm --filter gym build && pnpm --filter laundry build` passes
3. Zero local usePriceFormat copies in pharmacy/workshops
4. Zero local currency-converter/currency-preferences copies in pharmacy/workshops
5. Zero local BottomNav in gym/laundry/pharmacy/workshops
6. Workshops consumers use formatPrice/formatPriceCompact (not old format/formatDual)
7. All apps import from @gudbro/hooks, @gudbro/utils, @gudbro/ui
</verification>

<success_criteria>

- pharmacy + workshops use @gudbro/hooks for usePriceFormat and @gudbro/utils for currency
- workshops consumers fully migrated from divergent API to standard API
- 4 BottomNav local copies deleted (gym, laundry, pharmacy, workshops)
- 6 currency duplicate files deleted (3 per app for pharmacy + workshops)
- All 4 apps build successfully
- No behavioral changes -- same nav items, same colors, same storage keys
  </success_criteria>

<output>
After completion, create `.planning/phases/41-shared-foundation/41-05-SUMMARY.md`
</output>
