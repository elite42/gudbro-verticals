---
phase: 32-owner-dashboard-enhancements
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - shared/database/migrations/schema/093-owner-dashboard-enhancements.sql
  - apps/backoffice/app/api/accommodations/bookings/route.ts
  - apps/backoffice/app/api/accommodations/rooms/route.ts
  - apps/backoffice/components/accommodations/RoomManager.tsx
  - apps/backoffice/components/accommodations/GanttCalendar.tsx
  - apps/backoffice/components/accommodations/GanttBookingBar.tsx
  - apps/backoffice/app/(dashboard)/accommodations/calendar/page.tsx
  - apps/backoffice/app/(dashboard)/accommodations/bookings/page.tsx
autonomous: true

must_haves:
  truths:
    - 'Owner sees a rooms-by-dates timeline grid with color-coded booking bars'
    - 'Clicking a booking bar navigates to booking detail page'
    - 'Gantt view scrolls horizontally on mobile with sticky room labels'
    - 'Bookings page has a History tab showing checked_out and cancelled bookings'
    - 'Room form includes floor/level field that persists on save'
  artifacts:
    - path: 'shared/database/migrations/schema/093-owner-dashboard-enhancements.sql'
      provides: 'floor exposed in API (column already exists in DB from migration 077)'
      contains: '-- Migration 093'
    - path: 'apps/backoffice/components/accommodations/GanttCalendar.tsx'
      provides: 'CSS Grid rooms-by-dates timeline component'
      min_lines: 100
    - path: 'apps/backoffice/components/accommodations/GanttBookingBar.tsx'
      provides: 'Color-coded booking bar with click-to-navigate'
      min_lines: 30
  key_links:
    - from: 'apps/backoffice/app/(dashboard)/accommodations/calendar/page.tsx'
      to: 'GanttCalendar component'
      via: 'view toggle (Monthly/Timeline)'
      pattern: 'GanttCalendar'
    - from: 'GanttCalendar.tsx'
      to: '/api/accommodations/bookings'
      via: 'fetch with dateFrom/dateTo params'
      pattern: 'dateFrom.*dateTo'
    - from: 'apps/backoffice/app/api/accommodations/rooms/route.ts'
      to: 'accom_rooms.floor'
      via: 'allowedFields includes floor'
      pattern: "'floor'"
---

<objective>
Build the Gantt calendar view, booking history tab, and room floor/level field for the owner dashboard.

Purpose: Property owners with multiple rooms need a timeline view to see all bookings at a glance. The history tab lets them review past stays. Floor field helps organize rooms in multi-story properties.
Output: GanttCalendar component with CSS Grid, bookings API with date range filtering, history tab on bookings page, floor field in room CRUD.
</objective>

<execution_context>
@/Users/gianfrancodagostino/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gianfrancodagostino/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/32-owner-dashboard-enhancements/32-RESEARCH.md

Key existing files:
@apps/backoffice/app/(dashboard)/accommodations/calendar/page.tsx
@apps/backoffice/app/(dashboard)/accommodations/bookings/page.tsx
@apps/backoffice/app/api/accommodations/bookings/route.ts
@apps/backoffice/app/api/accommodations/rooms/route.ts
@apps/backoffice/components/accommodations/RoomManager.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Bookings API date range + rooms API floor field + migration</name>
  <files>
    shared/database/migrations/schema/093-owner-dashboard-enhancements.sql
    apps/backoffice/app/api/accommodations/bookings/route.ts
    apps/backoffice/app/api/accommodations/rooms/route.ts
    apps/backoffice/components/accommodations/RoomManager.tsx
  </files>
  <action>
    1. Create migration 093-owner-dashboard-enhancements.sql:
       - The `floor` column already exists on `accom_rooms` from migration 077 -- NO ALTER TABLE needed for floor.
       - This migration is a placeholder comment documenting that floor is now exposed via API (Phase 32).
       - Add any future columns needed here if discovered during implementation.

    2. Modify bookings API route (apps/backoffice/app/api/accommodations/bookings/route.ts):
       - Add optional `dateFrom` and `dateTo` query params to the GET handler.
       - When both are present, filter bookings with overlap logic: `check_in_date` <= dateTo AND `check_out_date` >= dateFrom (this finds all bookings that overlap the date range).
       - Use `.lte('check_in_date', dateTo).gte('check_out_date', dateFrom)` Supabase syntax.
       - When dateFrom/dateTo are NOT present, keep existing behavior (all bookings, limit 200).
       - When dateFrom/dateTo ARE present, remove the limit(200) to get all bookings in range.
       - Also add optional `includeHistory` param. When `includeHistory=true`, include `checked_out` and `cancelled` status bookings. Currently the route returns all statuses already, so this is about the frontend filtering -- no API change needed for history.

    3. Modify rooms API route (apps/backoffice/app/api/accommodations/rooms/route.ts):
       - GET: Add `floor` to the select string (after `room_code`).
       - POST: Add `floor` to the destructured body fields and include `floor: floor || null` in the insert object.
       - PUT: Add `'floor'` to the `allowedFields` array.

    4. Modify RoomManager.tsx:
       - Add `floor` to the Room interface (type: `string | null`).
       - Add `floor` to RoomFormData interface (type: `string`).
       - Add `floor: ''` to DEFAULT_FORM.
       - Add a text input for "Floor / Level" in the room form, between room_type and capacity fields. Placeholder: "e.g. Ground, 1st, 2nd, Rooftop". Use same styling as other form inputs.
       - Include `floor` in the save payload for both create and update operations.
       - Display floor in the room card/list if it has a value (show as small badge like "Floor: 2nd").

  </action>
  <verify>
    - `npx tsc --noEmit -p apps/backoffice/tsconfig.json` passes without errors
    - Room form shows Floor/Level input field
    - Bookings API accepts dateFrom/dateTo query parameters
    - Rooms API PUT allowedFields includes 'floor'
  </verify>
  <done>
    - Bookings API supports optional dateFrom/dateTo overlap query for Gantt data fetching
    - Rooms GET returns floor field, POST accepts floor, PUT allows floor updates
    - RoomManager form has floor/level input that saves correctly
  </done>
</task>

<task type="auto">
  <name>Task 2: Gantt calendar component + calendar page toggle + booking history tab</name>
  <files>
    apps/backoffice/components/accommodations/GanttCalendar.tsx
    apps/backoffice/components/accommodations/GanttBookingBar.tsx
    apps/backoffice/app/(dashboard)/accommodations/calendar/page.tsx
    apps/backoffice/app/(dashboard)/accommodations/bookings/page.tsx
  </files>
  <action>
    1. Create GanttBookingBar.tsx:
       - Props: booking (id, guest_name, guest_last_name, status, check_in_date, check_out_date), gridRow (number), startCol (number), endCol (number).
       - Color-coded by status: confirmed=blue (bg-blue-100 border-l-4 border-blue-500), checked_in=green (bg-green-100 border-l-4 border-green-500), pending/pending_payment=amber (bg-amber-100 border-l-4 border-amber-500), cancelled=gray (bg-gray-100 text-gray-400 line-through), checked_out=slate (bg-slate-100 border-l-4 border-slate-400).
       - Renders as a div with style={{ gridRow, gridColumn: `${startCol} / ${endCol}` }}.
       - Shows truncated guest name inside the bar. Cursor pointer.
       - onClick navigates to `/accommodations/bookings/${booking.id}` using next/navigation useRouter.
       - Tooltip on hover showing full guest name + dates (use native title attribute, no library).

    2. Create GanttCalendar.tsx:
       - Props: rooms (array with id, room_number, room_type, floor), bookings (array with id, guest_name, guest_last_name, status, check_in_date, check_out_date, room_id), loading (boolean).
       - Internal state: startDate (initialized to startOfWeek(new Date(), { weekStartsOn: 1 })).
       - Use `numDays = 14` for desktop. On mobile (check window.innerWidth < 768 via useState+useEffect, NOT useMediaQuery), use `numDays = 7`.
       - Generate dates array using date-fns eachDayOfInterval.
       - Navigation: prev/next buttons that shift startDate by 7 days. "Today" button resets to current week.
       - CSS Grid layout:
         - `gridTemplateColumns: 120px repeat(numDays, minmax(40px, 1fr))` (80px on mobile for room label column)
         - `gridTemplateRows: 48px repeat(rooms.length, 56px)`
       - Header row: corner cell (sticky left-0 z-20 bg-white) + date cells showing day number and abbreviated weekday. Today's date highlighted with blue background.
       - Weekend columns (Sat/Sun) get a subtle bg-gray-50 stripe.
       - Room rows: sticky room label (left-0 z-10 bg-white border-r) showing room_number and floor if present. Then booking bars positioned via GanttBookingBar.
       - Helper function `dateToCol(dateStr)`: finds index in dates array, returns idx+2 (column 1 is room labels). Returns -1 if date is outside visible range.
       - For each room, filter bookings by room_id. For each booking, calculate startCol and endCol. Clamp to visible range (if booking starts before startDate, clamp startCol to 2; if ends after last date, clamp endCol to numDays+2).
       - Outer container: `overflow-x-auto` with `min-w-[600px]` inner grid.
       - Empty state: if no rooms, show "Add rooms to see timeline".
       - Loading state: skeleton with pulse animation.

    3. Modify calendar page (apps/backoffice/app/(dashboard)/accommodations/calendar/page.tsx):
       - Add a view toggle at the top: "Monthly" | "Timeline" buttons (similar style to tab buttons on bookings page).
       - New state: `const [view, setView] = useState<'monthly' | 'timeline'>('monthly')`.
       - When view is 'timeline':
         - Fetch bookings using the dateFrom/dateTo params from bookings API (use startDate and startDate+numDays as range).
         - Render GanttCalendar component instead of AvailabilityCalendar.
         - Hide the room filter dropdown (Gantt shows ALL rooms).
         - Hide the detail panel, seasonal pricing, and discount sections (not relevant for timeline view).
       - When view is 'monthly': render existing calendar (no changes to current behavior).
       - Import GanttCalendar. Add necessary state for Gantt bookings fetching.

    4. Modify bookings page (apps/backoffice/app/(dashboard)/accommodations/bookings/page.tsx):
       - Add 'history' to TabKey type: `type TabKey = 'all' | 'pending' | 'confirmed' | 'checked_in' | 'cancelled' | 'history'`.
       - Add history tab to tabs config: `{ key: 'history', label: 'History' }`.
       - History filter: `result.filter(b => b.status === 'checked_out' || b.status === 'cancelled')`.
       - Add history count to counts calculation: count bookings where status is 'checked_out' or 'cancelled'.
       - The existing API already returns all statuses including checked_out, so no API change needed.

  </action>
  <verify>
    - `npx tsc --noEmit -p apps/backoffice/tsconfig.json` passes without errors
    - Calendar page shows Monthly/Timeline toggle
    - Timeline view renders CSS Grid with room labels and date columns
    - Bookings page shows History tab that filters to checked_out/cancelled bookings
  </verify>
  <done>
    - GanttCalendar renders rooms-by-dates CSS Grid with color-coded booking bars
    - Clicking a booking bar navigates to booking detail page
    - Calendar page has Monthly/Timeline toggle; Timeline view fetches date-range bookings
    - Mobile: 7-day view with 80px room labels, horizontal scroll, sticky labels
    - Bookings page has History tab showing past stays (checked_out + cancelled)
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation: `npx tsc --noEmit -p apps/backoffice/tsconfig.json` -- zero errors
2. Build check: `cd apps/backoffice && npx next build` -- successful build
3. Visual: Calendar page shows Monthly/Timeline toggle, Timeline renders Gantt grid
4. Visual: Bookings page shows History tab with past bookings
5. Visual: Room form shows Floor/Level input
6. Functional: Clicking booking bar in Gantt navigates to booking detail
</verification>

<success_criteria>

- Owner can toggle between Monthly and Timeline views on the calendar page
- Timeline view shows all rooms as rows and 14 days (7 on mobile) as columns
- Booking bars are color-coded by status and clickable
- History tab on bookings page shows checked_out and cancelled bookings
- Room CRUD supports floor/level field (display, create, edit)
  </success_criteria>

<output>
After completion, create `.planning/phases/32-owner-dashboard-enhancements/32-01-SUMMARY.md`
</output>
