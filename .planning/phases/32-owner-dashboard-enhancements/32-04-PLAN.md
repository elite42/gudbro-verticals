---
phase: 32-owner-dashboard-enhancements
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/backoffice/app/(dashboard)/accommodations/settings/page.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - 'Owner can select house rules from checkboxes and add custom rules'
    - 'Owner can choose cancellation policy from dropdown'
    - 'Owner can save social links, Google Maps URL, communication methods, hours, and languages'
  artifacts:
    - path: 'apps/backoffice/app/(dashboard)/accommodations/settings/page.tsx'
      provides: 'StructuredPolicies and PropertyDataForm integration'
      contains: 'StructuredPolicies'
  key_links:
    - from: 'settings/page.tsx'
      to: 'StructuredPolicies.tsx'
      via: 'import + render in Policies section'
      pattern: 'import.*StructuredPolicies'
    - from: 'settings/page.tsx'
      to: 'PropertyDataForm.tsx'
      via: 'import + new Property Information section'
      pattern: 'import.*PropertyDataForm'
---

<objective>
Wire StructuredPolicies and PropertyDataForm into the settings page.

Purpose: Close gaps 4, 5, 6 from verification — StructuredPolicies (174 lines) and PropertyDataForm (383 lines) exist but are orphaned. Settings page still uses old textareas for policies and lacks property data management entirely.
Output: Settings page with structured policies (checkbox house rules, dropdown cancellation) and complete property data form (social links, maps, hours, languages).
</objective>

<execution_context>
@/Users/gianfrancodagostino/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gianfrancodagostino/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/32-owner-dashboard-enhancements/32-VERIFICATION.md

Key files (read these FIRST — read settings page IN FULL, it's the only file you modify):
@apps/backoffice/app/(dashboard)/accommodations/settings/page.tsx
@apps/backoffice/components/accommodations/StructuredPolicies.tsx
@apps/backoffice/components/accommodations/PropertyDataForm.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace policy textareas with StructuredPolicies component</name>
  <files>apps/backoffice/app/(dashboard)/accommodations/settings/page.tsx</files>
  <action>
    Read the full settings page and StructuredPolicies component first to understand both interfaces.

    1. Add import: `import StructuredPolicies from '@/components/accommodations/StructuredPolicies';`
    2. Read the StructuredPolicies props interface carefully. It likely expects:
       - houseRules: string[] (array of selected rule keys/labels)
       - cancellationPolicy: string (one of 'flexible' | 'moderate' | 'strict' | 'non_refundable')
       - onChange callback for updates
    3. Add state for structured data:
       - `const [houseRules, setHouseRules] = useState<string[]>([]);`
       - If cancellation policy already has state, reuse it. If it's just a text field, add proper state.
    4. In the data loading useEffect, parse the property's existing house_rules. If it comes as a string (old textarea format), convert: if it looks like a JSON array parse it, otherwise split by newlines. Load cancellation_policy as-is.
    5. Replace the house rules textarea (verification says lines ~588-595) with `<StructuredPolicies ... />`. Match the exact props interface from the component.
    6. Replace the cancellation policy textarea (verification says lines ~597-608) with the StructuredPolicies component handling (the component handles both house rules AND cancellation policy — read it to confirm if it's one component or separate).
    7. In handleSave, serialize houseRules as JSON array string (or however the API expects it based on POLICY-01 decision: "stores house_rules as string[]"). Include cancellation_policy in the save payload.

    IMPORTANT: Do NOT modify StructuredPolicies.tsx. Only modify settings/page.tsx. Read the component's props to wire correctly.

  </action>
  <verify>
    - `grep -n "StructuredPolicies" apps/backoffice/app/\(dashboard\)/accommodations/settings/page.tsx` shows import and usage
    - `grep -n "houseRules" apps/backoffice/app/\(dashboard\)/accommodations/settings/page.tsx` shows state management
    - No textarea elements remain for house rules or cancellation policy sections
  </verify>
  <done>Settings page uses StructuredPolicies component for house rules (checkboxes + custom) and cancellation policy (dropdown). Old textareas removed. Data loads from API and saves correctly.</done>
</task>

<task type="auto">
  <name>Task 2: Wire PropertyDataForm into settings page</name>
  <files>apps/backoffice/app/(dashboard)/accommodations/settings/page.tsx</files>
  <action>
    Read PropertyDataForm.tsx first to understand its props interface.

    1. Add import: `import PropertyDataForm from '@/components/accommodations/PropertyDataForm';`
    2. Read the PropertyDataForm props interface. It likely expects some combination of:
       - socialLinks, googleMapsUrl, communicationMethods, operatingHours, staffLanguages
       - onChange callbacks or a single onChange with all data
    3. Add state for the new property data fields (match whatever PropertyDataForm expects).
    4. In the data loading useEffect, populate these new states from the property API response. The property API already returns these fields (verified: "Property API supports all new fields").
    5. Add a new section in the settings page layout — place it AFTER the Policies section and BEFORE the Contact section (or at the end, wherever makes logical sense). Use the same section heading pattern as other sections (e.g., `<h2>` or `<h3>` with similar styling).
    6. Render `<PropertyDataForm ... />` with the correct props.
    7. In handleSave, include all new fields in the PUT request payload. Read the existing handleSave to understand the save pattern (likely a fetch PUT to /api/accommodations/property).

    IMPORTANT: Do NOT modify PropertyDataForm.tsx. Only modify settings/page.tsx. The component is 383 lines and fully built — just wire it.

  </action>
  <verify>
    - `grep -n "PropertyDataForm" apps/backoffice/app/\(dashboard\)/accommodations/settings/page.tsx` shows import and usage
    - `grep -n "socialLinks\|googleMapsUrl\|communicationMethods\|operatingHours\|staffLanguages" apps/backoffice/app/\(dashboard\)/accommodations/settings/page.tsx` shows state for new fields
    - `pnpm --filter backoffice exec tsc --noEmit` passes (or no NEW type errors in settings/page.tsx)
  </verify>
  <done>Settings page has a "Property Information" section rendering PropertyDataForm. New fields load from API and save with the existing save handler. All existing settings sections remain unchanged.</done>
</task>

</tasks>

<verification>
- Settings page: StructuredPolicies replaces old policy textareas
- Settings page: PropertyDataForm renders in new section
- Save flow: All new fields included in handleSave payload
- No regressions: All existing settings (name, description, WiFi, contact, etc.) still work
- TypeScript: No new type errors introduced
</verification>

<success_criteria>

- House rules section shows checkboxes (not a textarea)
- Cancellation policy shows a dropdown (not a textarea)
- Property Information section is visible with social links, maps, hours, languages fields
- Saving settings persists all new data
- Zero modifications to StructuredPolicies.tsx or PropertyDataForm.tsx
  </success_criteria>

<output>
After completion, create `.planning/phases/32-owner-dashboard-enhancements/32-04-SUMMARY.md`
</output>
