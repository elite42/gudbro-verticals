---
phase: 06-in-stay-dashboard
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - shared/database/migrations/schema/079-accommodations-phase6-extensions.sql
  - apps/accommodations/frontend/app/api/stay/[code]/useful-numbers/route.ts
  - apps/accommodations/frontend/app/api/stay/[code]/route.ts
  - apps/accommodations/frontend/types/stay.ts
autonomous: true

must_haves:
  truths:
    - 'Useful numbers API returns emergency and city numbers for the property location'
    - 'Properties have quick_actions, return_banner_text, return_banner_url columns'
    - 'Bookings have guest_country column for visa info'
    - 'Demo property has quick actions and return banner seed data'
    - 'Da Nang city useful numbers are seeded'
    - 'Lookup route returns guest_name correctly (bug fixed)'
  artifacts:
    - path: 'shared/database/migrations/schema/079-accommodations-phase6-extensions.sql'
      provides: 'Schema extensions and seed data for Phase 6'
      contains: 'quick_actions'
    - path: 'apps/accommodations/frontend/app/api/stay/[code]/useful-numbers/route.ts'
      provides: 'Useful numbers API route'
      exports: ['GET']
    - path: 'apps/accommodations/frontend/types/stay.ts'
      provides: 'Extended types for new endpoints'
      contains: 'UsefulNumbersResponse'
  key_links:
    - from: 'apps/accommodations/frontend/app/api/stay/[code]/useful-numbers/route.ts'
      to: 'emergency_numbers, city_useful_numbers tables'
      via: 'Supabase service role client'
      pattern: "from\\('emergency_numbers'\\)"
    - from: 'apps/accommodations/frontend/app/api/stay/[code]/route.ts'
      to: 'accom_bookings.guest_name'
      via: 'Supabase select'
      pattern: 'guest_name'
---

<objective>
Extend the backend for Phase 6 dashboard sections that Phase 5 did not cover: useful numbers, quick actions, return guest banner, and guest country for visa info. Create the DB migration with seed data, add the useful-numbers API route, extend types, and fix the lookup route bug.

Purpose: The existing Phase 5 routes serve WiFi, stay info, services, and deals. But the dashboard also has useful numbers, quick actions, visa status, and return guest sections that need backend data. This plan fills those gaps.
Output: One migration SQL file, one new API route, extended types, and a bug fix in the lookup route.
</objective>

<execution_context>
@/Users/gianfrancodagostino/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gianfrancodagostino/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-in-stay-dashboard/06-RESEARCH.md
@.planning/phases/05-api-layer/05-01-SUMMARY.md
@.planning/phases/05-api-layer/05-02-SUMMARY.md

Key source files:
@apps/accommodations/frontend/app/api/stay/[code]/route.ts
@apps/accommodations/frontend/app/api/stay/[code]/property/route.ts
@apps/accommodations/frontend/types/stay.ts
@apps/accommodations/frontend/lib/supabase.ts
@apps/accommodations/frontend/lib/auth.ts
@shared/database/migrations/schema/077-accommodations-schema.sql
@shared/database/migrations/schema/078-accommodations-seed.sql
@shared/database/migrations/schema/073-useful-numbers.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Database migration for Phase 6 extensions</name>
  <files>shared/database/migrations/schema/079-accommodations-phase6-extensions.sql</files>
  <action>
Create migration 079 with these changes:

1. Add columns to accom_properties:
   - `quick_actions JSONB DEFAULT '[]'::jsonb` -- Array of {id, name, icon, whatsapp_message} objects
   - `return_banner_text TEXT` -- Nullable, if null banner is hidden
   - `return_banner_url TEXT` -- Nullable, URL or WhatsApp link

2. Add column to accom_bookings:
   - `guest_country TEXT` -- ISO country code for visa info

3. Seed Da Nang city useful numbers into city_useful_numbers table:
   - Police: 113
   - Ambulance: 115
   - Fire: 114
   - Tourist Police: 0236 3811 113 (Da Nang specific)
   - Immigration Office: 0236 3821 487
   - Da Nang General Hospital: 0236 3822 480
   - Taxi (Vinasun): 0236 3 68 68 68
   - Taxi (Mai Linh): 0236 3 56 56 56
     Use country_code='VN', city_name='Da Nang', is_active=true, appropriate category values, sequential sort_order.
     Use ON CONFLICT DO NOTHING for idempotent re-runs.

4. Seed quick_actions for demo property (UUID aaaaaaaa-...):

   ```json
   [
     {
       "id": "room-service",
       "name": "Room Service",
       "icon": "ForkKnife",
       "whatsapp_message": "Room Service request"
     },
     {
       "id": "concierge",
       "name": "Concierge",
       "icon": "Compass",
       "whatsapp_message": "Concierge assistance"
     },
     {
       "id": "housekeeping",
       "name": "Housekeeping",
       "icon": "Broom",
       "whatsapp_message": "Housekeeping request"
     },
     {
       "id": "report-issue",
       "name": "Report Issue",
       "icon": "Warning",
       "whatsapp_message": "Issue report"
     }
   ]
   ```

5. Seed return_banner_text and return_banner_url for demo property:
   - return_banner_text: 'Loved your stay? Book again and get 10% off!'
   - return_banner_url: 'https://wa.me/84905123456?text=I%20would%20like%20to%20book%20again'

6. Update demo booking to set guest_country = 'US' (John Smith).

Follow GUDBRO DB standards: TEXT + CHECK, English column names. Use INSERT ON CONFLICT DO NOTHING for all seed data.
</action>
<verify>
Read the migration file and confirm:

- All ALTER TABLE statements are valid SQL
- All INSERT statements use ON CONFLICT DO NOTHING
- UUID for demo property matches seed data pattern (aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa)
  </verify>
  <done>Migration file exists with schema extensions (3 new columns on properties, 1 on bookings) and seed data (Da Nang useful numbers, demo property quick actions + return banner, demo booking guest country)</done>
  </task>

<task type="auto">
  <name>Task 2: Useful numbers API route + types + lookup bug fix</name>
  <files>
    apps/accommodations/frontend/app/api/stay/[code]/useful-numbers/route.ts
    apps/accommodations/frontend/types/stay.ts
    apps/accommodations/frontend/app/api/stay/[code]/route.ts
  </files>
  <action>
1. Create GET /api/stay/[code]/useful-numbers route:
   - Follow the same JWT auth guard pattern from Phase 5 protected routes (inline authenticateGuest function)
   - Extract propertyId from JWT token payload
   - Query accom_properties for country_code and city (single row by id)
   - Parallel fetch emergency_numbers (by country_code) and city_useful_numbers (by country_code + city_name, is_active=true, ordered by sort_order)
   - Also include property contact as a "property" section: host_name, host_phone, emergency_phone
   - Return { data: { emergency: [...], city: [...], property: { name, phone } } }
   - Use export const dynamic = 'force-dynamic'
   - Use consistent { data, error } response shape

2. Extend types/stay.ts with new types:
   - UsefulNumbersResponse: { emergency: EmergencyNumber[], city: CityNumber[], property: { name: string, phone: string } }
   - EmergencyNumber: { serviceType: string, phoneNumber: string }
   - CityNumber: { label: string, phoneNumber: string, category: string, sortOrder: number }
   - QuickAction: { id: string, name: string, icon: string, whatsappMessage: string }
   - Add quick_actions, return_banner_text, return_banner_url to the PropertyInfo type (or create PropertyExtended)
   - Add guest_country to the BookingInfo or StayData type

3. Fix the lookup route bug:
   - In app/api/stay/[code]/route.ts, find where it selects `guest_first_name` and change to `guest_name`
   - The schema has `guest_name TEXT NOT NULL` (not guest_first_name)
   - This was identified in 06-RESEARCH.md Pitfall 3

All routes use getSupabaseAdmin() from lib/supabase.ts and verifyGuestToken from lib/auth.ts.
</action>
<verify>
Run `cd /Users/gianfrancodagostino/Desktop/gudbro-verticals && pnpm --filter accommodations-frontend build` and confirm:

- Build succeeds with no TypeScript errors
- New route appears as dynamic (f) route in build output: /api/stay/[code]/useful-numbers
- No type errors in modified files
  </verify>
  <done>Useful numbers API route serves emergency + city numbers for property location. Types extended with UsefulNumbersResponse, QuickAction, and guest_country. Lookup route bug fixed (guest_first_name -> guest_name). Build passes.</done>
  </task>

</tasks>

<verification>
- Migration file exists at shared/database/migrations/schema/079-accommodations-phase6-extensions.sql
- New API route exists at apps/accommodations/frontend/app/api/stay/[code]/useful-numbers/route.ts
- Types file extended with new response types
- Lookup route uses guest_name (not guest_first_name)
- `pnpm --filter accommodations-frontend build` succeeds
</verification>

<success_criteria>

- Backend gaps filled: useful numbers route exists, properties have quick_actions/return_banner columns, bookings have guest_country
- All existing Phase 5 routes still build successfully
- New useful-numbers route follows same auth guard pattern as services/deals/property routes
- Migration is idempotent (ON CONFLICT DO NOTHING for all seeds)
  </success_criteria>

<output>
After completion, create `.planning/phases/06-in-stay-dashboard/06-01-SUMMARY.md`
</output>
