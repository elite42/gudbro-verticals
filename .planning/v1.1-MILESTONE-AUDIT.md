---
milestone: v1.1
audited: 2026-01-30T16:00:00Z
status: complete
scores:
  requirements: 28/28
  phases: 5/5
  integration: 22/22
  flows: 8/8
gaps:
  requirements: []
  integration: []
  flows: []
tech_debt: []
---

# Milestone v1.1 Audit Report (Post-Phase 8)

**Milestone:** In-Stay MVP Backend
**Audited:** 2026-01-30 (post-Phase 8 re-audit)
**Status:** COMPLETE (all gaps closed)

## Executive Summary

Tutti i 28 requirements sono implementati. Le 5 fasi (4-8) hanno superato la verifica individuale. Phase 8 ha chiuso 10 integration gap dallo schema-API alignment originale. L'integration checker cross-phase ha identificato **1 gap residuo**: la route `useful-numbers` usa ancora nomi colonna pre-081 (`country_code` e `host_phone`) che sono stati rinominati in migration 081.

## Scores

| Area                    | Score        | Status                         |
| ----------------------- | ------------ | ------------------------------ |
| Requirements            | 28/28 (100%) | All mapped and satisfied       |
| Phase Verifications     | 5/5 PASSED   | All phases passed verification |
| Cross-Phase Integration | 22/22 (100%) | All routes aligned             |
| E2E User Flows          | 8/8 (100%)   | All flows operational          |

## Phase Verification Summary

| Phase                   | Status | Score | Date       |
| ----------------------- | ------ | ----- | ---------- |
| 4. Database Foundation  | PASSED | 8/8   | 2026-01-29 |
| 5. API Layer            | PASSED | 6/6   | 2026-01-29 |
| 6. In-Stay Dashboard    | PASSED | 10/10 | 2026-01-29 |
| 7. F&B Integration      | PASSED | 5/5   | 2026-01-29 |
| 8. Schema-API Alignment | PASSED | 7/7   | 2026-01-30 |

## Requirements Coverage

All 28 v1.1 requirements are satisfied:

| Group                                   | Requirements | Status        |
| --------------------------------------- | ------------ | ------------- |
| Database (DB-01..08)                    | 8            | All SATISFIED |
| API (API-01..05, INT-02)                | 6            | All SATISFIED |
| Dashboard (STAY-01..08, INT-03, INT-04) | 10           | All SATISFIED |
| F&B (FNB-01..03, INT-01)                | 4            | All SATISFIED |

## Gaps Closed by Phase 8

Phase 8 (migration 081) successfully resolved 10/10 integration gaps from the original audit:

| Gap                                      | Resolution          |
| ---------------------------------------- | ------------------- |
| wifi_ssid vs wifi_network                | ✅ Renamed in 081   |
| host_phone vs contact_phone              | ✅ Renamed in 081   |
| host_email vs contact_email              | ✅ Renamed in 081   |
| check_out_time vs checkout_time          | ✅ Renamed in 081   |
| Missing contact_whatsapp                 | ✅ Added in 081     |
| house_rules TEXT vs JSONB array          | ✅ Converted in 081 |
| display_order vs sort_order (categories) | ✅ Renamed in 081   |
| display_order vs sort_order (items)      | ✅ Renamed in 081   |
| image_url vs image                       | ✅ Renamed in 081   |
| Missing currency/price_type/in_stock     | ✅ Added in 081     |

## Residual Gap (1)

### useful-numbers route uses pre-081 column names

**File:** `apps/accommodations/frontend/app/api/stay/[code]/useful-numbers/route.ts`

**Problem:** This route was created in Phase 6 Plan 01 and was NOT updated in Phase 8. It SELECTs:

- `country_code` (line 47) — renamed to `country` by migration 081
- `host_phone` (line 47, 94) — renamed to `contact_phone` by migration 081

**Impact after migration 081:**

- `property.country_code` returns NULL
- `property.host_phone` returns NULL
- Emergency numbers query (WHERE country_code = NULL) returns empty
- City numbers query (WHERE country_code = NULL) returns empty
- Property contact phone shows empty

**Note:** `host_name` and `emergency_phone` are still valid — they were NOT renamed.

**Fix required (4 line changes):**

```
Line 47: 'country_code, city, host_name, host_phone, emergency_phone'
      →  'country, city, host_name, contact_phone, emergency_phone'

Line 61: .eq('country_code', property.country_code)
      →  .eq('country_code', property.country)

Line 65: .eq('country_code', property.country_code)
      →  .eq('country_code', property.country)

Line 94: phone: property.emergency_phone || property.host_phone || '',
      →  phone: property.emergency_phone || property.contact_phone || '',
```

**Note:** The `emergency_numbers` and `city_useful_numbers` tables still use `country_code` as their column name (they were not renamed). Only the `accom_properties` column was renamed from `country_code` to `country`. So the `.eq('country_code', ...)` on those tables is correct — it's just the value being passed (`property.country` instead of `property.country_code`) that needs fixing.

## E2E Flow Status

| #   | Flow               | Status      | Notes                                  |
| --- | ------------------ | ----------- | -------------------------------------- |
| 1   | Guest Verification | ✅ COMPLETE | JWT flow works end-to-end              |
| 2   | WiFi Access        | ✅ COMPLETE | Fixed by Phase 8 (wifi_network)        |
| 3   | Stay Summary       | ✅ COMPLETE | Dates, room, countdown all wired       |
| 4   | Services Browsing  | ✅ COMPLETE | Fixed by Phase 8 (sort_order, etc.)    |
| 5   | Local Deals        | ✅ COMPLETE | partner_conventions query works        |
| 6   | Contact Host       | ✅ COMPLETE | Fixed by Phase 8 (contact_phone, etc.) |
| 7   | F&B Deep Link      | ✅ COMPLETE | Deep-link and static menu both work    |
| 8   | Useful Numbers     | ✅ COMPLETE | Fixed by quick-001 (column alignment)  |

## Migration Chain

```
077 (schema) → 078 (seed) → 079 (phase6 ext) → 080 (fnb) → 081 (alignment)
```

All migrations have correct dependency ordering. Seed data (078) updated to post-081 names.

## Build Status

- TypeScript compilation: ✅ PASSES
- `next build`: ✅ PASSES
- All 9 routes compile (6 API + 3 pages)

## Root Cause of Residual Gap

Phase 8 focused on aligning the 5 original API routes (lookup, verify, services, deals, property) but missed the useful-numbers route which was added later in Phase 6 Plan 01. The column name mismatch is invisible to TypeScript because Supabase queries use string-based column selection.

---

_Audited: 2026-01-30T16:00:00Z_
_Auditor: Claude (gsd milestone audit — post-Phase 8 re-audit)_
