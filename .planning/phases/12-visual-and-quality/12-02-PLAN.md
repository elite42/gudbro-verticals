---
phase: 12-visual-and-quality
plan: 02
type: execute
wave: 2
depends_on: ['12-01']
files_modified:
  - tests/e2e/verticals/coffeeshop.smoke.spec.ts
  - tests/e2e/verticals/wellness.smoke.spec.ts
  - tests/e2e/verticals/laundry.smoke.spec.ts
  - tests/e2e/verticals/pharmacy.smoke.spec.ts
  - tests/e2e/verticals/workshops.smoke.spec.ts
  - tests/e2e/verticals/gym.smoke.spec.ts
  - tests/e2e/verticals/tours.smoke.spec.ts
  - tests/e2e/verticals/accommodations.smoke.spec.ts
autonomous: true

must_haves:
  truths:
    - 'Visual regression baselines are committed for every vertical at mobile and desktop viewports'
    - "Every vertical's PWA manifest is validated for required fields"
    - 'Visual regression tests pass with <5% false positive rate'
    - 'Manifest validation tests catch missing name, short_name, icons, or theme_color'
  artifacts:
    - path: 'tests/e2e/verticals/coffeeshop.smoke.spec.ts'
      provides: 'Visual regression + manifest tests for coffeeshop'
      contains: 'toHaveScreenshot'
    - path: 'tests/e2e/verticals/wellness.smoke.spec.ts'
      provides: 'Visual regression + manifest tests for wellness'
      contains: 'toHaveScreenshot'
    - path: 'tests/e2e/verticals/laundry.smoke.spec.ts'
      provides: 'Visual regression + manifest tests for laundry'
      contains: 'manifest.json'
    - path: 'tests/e2e/verticals/pharmacy.smoke.spec.ts'
      provides: 'Visual regression + manifest tests for pharmacy'
      contains: 'manifest.json'
    - path: 'tests/e2e/verticals/workshops.smoke.spec.ts'
      provides: 'Visual regression + manifest tests for workshops'
      contains: 'toHaveScreenshot'
    - path: 'tests/e2e/verticals/gym.smoke.spec.ts'
      provides: 'Visual regression + manifest tests for gym'
      contains: 'toHaveScreenshot'
    - path: 'tests/e2e/verticals/tours.smoke.spec.ts'
      provides: 'Visual regression + manifest tests for tours'
      contains: 'toHaveScreenshot'
    - path: 'tests/e2e/verticals/accommodations.smoke.spec.ts'
      provides: 'Visual regression + manifest tests for accommodations'
      contains: 'toHaveScreenshot'
  key_links:
    - from: 'smoke spec files'
      to: 'tests/e2e/shared/screenshot-stable.css'
      via: 'stylePath option in toHaveScreenshot()'
      pattern: "screenshot-stable\\.css"
    - from: 'smoke spec files'
      to: 'manifest.json files'
      via: "page.request.get('/manifest.json')"
      pattern: "manifest\\.json"
    - from: 'smoke spec files'
      to: 'tests/e2e/shared/vertical-registry.ts'
      via: 'VERTICALS import for routes'
      pattern: 'VERTICALS'
---

<objective>
Add visual regression screenshot tests and PWA manifest validation tests to all 8 existing vertical smoke spec files.

Purpose: Satisfies VISQ-01 (visual regression baselines) and VISQ-02 (manifest validation). Uses screenshot-stable.css and manifest.json files created in Plan 01.
Output: All 8 smoke specs extended with visual regression + manifest test blocks. Baseline screenshots committed on first run.
</objective>

<execution_context>
@/Users/gianfrancodagostino/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gianfrancodagostino/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-visual-and-quality/12-RESEARCH.md
@.planning/phases/12-visual-and-quality/12-01-SUMMARY.md

Key infrastructure:

- 8 smoke spec files in tests/e2e/verticals/\*.smoke.spec.ts
- Shared fixtures in tests/e2e/shared/fixtures.ts (exports test, expect)
- Vertical registry in tests/e2e/shared/vertical-registry.ts (VERTICALS object with routes)
- Screenshot CSS at tests/e2e/shared/screenshot-stable.css (from Plan 01)
- Playwright projects: 16 projects (8 verticals x mobile + desktop), named e.g. "smoke-wellness-mobile", "smoke-wellness-desktop"
- Viewports: Pixel 5 (393x851) for mobile, Desktop Chrome (1280x720) for desktop

Vertical routes (from registry):

- coffeeshop: home only
- wellness: home, /services, /staff
- laundry: home, /services
- pharmacy: home, /products, /search
- workshops: home, /workshops
- gym: home, /courses, /passes
- tours: home only
- accommodations: home only

For verticals with only home route (coffeeshop, tours, accommodations), capture only 1 screenshot per viewport.
For verticals with internal pages, capture home + first non-home route = 2 screenshots per viewport.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add visual regression + manifest tests to all 8 smoke specs</name>
  <files>
    tests/e2e/verticals/coffeeshop.smoke.spec.ts
    tests/e2e/verticals/wellness.smoke.spec.ts
    tests/e2e/verticals/laundry.smoke.spec.ts
    tests/e2e/verticals/pharmacy.smoke.spec.ts
    tests/e2e/verticals/workshops.smoke.spec.ts
    tests/e2e/verticals/gym.smoke.spec.ts
    tests/e2e/verticals/tours.smoke.spec.ts
    tests/e2e/verticals/accommodations.smoke.spec.ts
  </files>
  <action>
    For each of the 8 smoke spec files, add TWO new test.describe blocks AFTER the existing smoke tests:

    1. **Visual Regression block** — add at the end of the existing test.describe or as a new describe:

    ```typescript
    import path from 'path';

    const SCREENSHOT_CSS = path.join(__dirname, '../shared/screenshot-stable.css');

    test.describe(`${vertical.name} Visual Regression`, () => {
      test('homepage visual baseline', async ({ page, pwaPage }) => {
        await pwaPage.goto();
        await page.waitForLoadState('networkidle');
        await expect(page).toHaveScreenshot(`${vertical.slug}-home.png`, {
          maxDiffPixelRatio: 0.01,
          threshold: 0.2,
          animations: 'disabled',
          stylePath: SCREENSHOT_CSS,
        });
      });

      // ONLY for verticals with additional routes (wellness, laundry, pharmacy, workshops, gym):
      test('key page visual baseline', async ({ page }) => {
        const nonHomeRoutes = Object.entries(vertical.routes).filter(([k]) => k !== 'home');
        if (nonHomeRoutes.length === 0) {
          test.skip();
          return;
        }
        const [routeName, routePath] = nonHomeRoutes[0];
        await page.goto(routePath);
        await page.waitForLoadState('networkidle');
        await expect(page).toHaveScreenshot(`${vertical.slug}-${routeName}.png`, {
          maxDiffPixelRatio: 0.01,
          threshold: 0.2,
          animations: 'disabled',
          stylePath: SCREENSHOT_CSS,
        });
      });
    });
    ```

    For coffeeshop, tours, and accommodations (home-only verticals), still include the "key page" test but it will self-skip via the nonHomeRoutes.length === 0 check. This keeps the pattern consistent across all specs.

    2. **PWA Manifest Validation block:**

    ```typescript
    test.describe(`${vertical.name} PWA Manifest`, () => {
      test('manifest.json has required fields', async ({ page }) => {
        const response = await page.request.get('/manifest.json');
        expect(response.ok(), 'manifest.json should be accessible').toBeTruthy();

        const manifest = await response.json();

        // Required string fields
        expect(manifest.name, 'name must be non-empty').toBeTruthy();
        expect(manifest.short_name, 'short_name must be non-empty').toBeTruthy();
        expect(manifest.theme_color, 'theme_color must be non-empty').toBeTruthy();
        expect(manifest.display, 'display must be set').toBeTruthy();
        expect(manifest.start_url, 'start_url must be set').toBeTruthy();

        // Icon validation
        const icons: Array<{ sizes?: string }> = manifest.icons || [];
        expect(icons.length, 'must have at least 2 icons').toBeGreaterThanOrEqual(2);

        const sizes = icons.map((i) => i.sizes || '');
        const has192 = sizes.some((s) => s.includes('192'));
        const has512 = sizes.some((s) => s.includes('512'));
        expect(has192, 'must include 192x192 icon').toBeTruthy();
        expect(has512, 'must include 512x512 icon').toBeTruthy();
      });
    });
    ```

    IMPORTANT implementation notes:
    - Import `path` at the top of each file (add `import path from 'path';`)
    - Define SCREENSHOT_CSS constant before the test.describe blocks
    - Keep all existing smoke tests UNCHANGED — only append new describe blocks
    - The `test` and `expect` imports already exist from '../shared/fixtures' — do NOT add duplicate imports
    - The `vertical` constant already exists at the top of each file — reuse it
    - Manifest test uses `page.request.get()` which sends the request to the baseURL configured in the Playwright project
    - Do NOT use full URL in manifest test — relative `/manifest.json` path is correct because baseURL is set per project

    After adding tests to ALL 8 files, run the tests with --update-snapshots to generate baselines:
    ```bash
    SKIP_WEBSERVER=1 npx playwright test --project="smoke-*" --update-snapshots
    ```

    This will:
    - Create baseline screenshot PNGs in *.spec.ts-snapshots/ directories
    - The first run always generates baselines (no comparison yet)
    - Subsequent runs compare against these baselines

    Then run WITHOUT --update-snapshots to verify tests pass against the new baselines:
    ```bash
    SKIP_WEBSERVER=1 npx playwright test --project="smoke-*"
    ```

    If any visual tests fail on the second run (false positives), investigate:
    - Dynamic content not masked by screenshot-stable.css? Add more CSS rules
    - Network-dependent content? Increase wait or mask
    - Adjust thresholds if needed (but stay within <5% false positive target)

    Run 3 times total to confirm stability (matching Phase 11 validation pattern).

  </action>
  <verify>
    1. All 8 smoke spec files contain `toHaveScreenshot` calls
    2. All 8 smoke spec files contain `manifest.json` validation
    3. Run: SKIP_WEBSERVER=1 npx playwright test --project="smoke-*" (all pass)
    4. Snapshot directories exist next to spec files with baseline PNGs
    5. Run 3x consecutive to confirm zero flaky failures
  </verify>
  <done>
    All 8 verticals have visual regression baselines committed. All 8 verticals have manifest validation tests. Tests pass 3x consecutive with zero flaky failures. VISQ-01 and VISQ-02 satisfied.
  </done>
</task>

</tasks>

<verification>
1. All 8 smoke specs have Visual Regression and PWA Manifest test blocks
2. Baseline screenshots exist in spec-snapshots directories for all verticals
3. SKIP_WEBSERVER=1 npx playwright test --project="smoke-*" passes 3x consecutive
4. Screenshot count matches expectation: ~26 baselines (5 verticals with 2 pages x 2 viewports + 3 home-only verticals x 1 page x 2 viewports = 26, plus the self-skipped "key page" tests for home-only verticals don't create snapshots)
5. Manifest tests validate name, short_name, theme_color, display, start_url, icons (192+512) for all 8 verticals
</verification>

<success_criteria>

- Visual regression baselines committed for every vertical at mobile + desktop viewports (VISQ-01)
- PWA manifest validated for every vertical: name, short_name, icons (192+512), theme_color present (VISQ-02)
- Tests pass 3x consecutive with zero flaky failures
- False positive rate <5% (no tests fail without code changes)
  </success_criteria>

<output>
After completion, create `.planning/phases/12-visual-and-quality/12-02-SUMMARY.md`
</output>
