---
phase: 33-guest-dashboard-redesign
plan: 02
type: execute
wave: 2
depends_on: ['33-01']
files_modified:
  - apps/accommodations/frontend/components/stay/HouseRulesSheet.tsx
  - apps/accommodations/frontend/components/stay/ProfileView.tsx
  - apps/accommodations/frontend/components/stay/CheckoutInfo.tsx
  - apps/accommodations/frontend/components/stay/DashboardHeader.tsx
  - apps/accommodations/frontend/components/stay/ContactSheet.tsx
  - apps/accommodations/frontend/components/BottomNav.tsx
  - apps/accommodations/frontend/app/stay/[code]/page.tsx
autonomous: true

must_haves:
  truths:
    - 'Check-in/out times appear inside House Rules sheet, not as a separate homepage section'
    - 'Contact Host is accessible from the header (not prominent on homepage)'
    - 'Profile page shows personal data, uploaded documents, order history, and preferences'
    - 'Bottom nav tabs work correctly with updated navigation structure'
  artifacts:
    - path: 'apps/accommodations/frontend/components/stay/HouseRulesSheet.tsx'
      provides: 'Bottom sheet showing house rules + check-in/out times'
      min_lines: 40
    - path: 'apps/accommodations/frontend/components/stay/ProfileView.tsx'
      provides: 'Profile tab content with guest data, documents, orders, preferences'
      min_lines: 60
    - path: 'apps/accommodations/frontend/components/stay/DashboardHeader.tsx'
      provides: 'Header with Contact Host button added'
    - path: 'apps/accommodations/frontend/app/stay/[code]/page.tsx'
      provides: 'Wired HouseRulesSheet, ProfileView, Contact Host in header'
  key_links:
    - from: 'page.tsx'
      to: 'HouseRulesSheet.tsx'
      via: 'House Rules card onClick opens sheet'
      pattern: 'HouseRulesSheet|showHouseRules'
    - from: 'page.tsx'
      to: 'ProfileView.tsx'
      via: 'profile tab renders ProfileView'
      pattern: 'ProfileView'
    - from: 'DashboardHeader.tsx'
      to: 'ContactSheet.tsx'
      via: 'header button triggers contact sheet open'
      pattern: 'ChatCircleDots|onContactHost'
---

<objective>
Restructure navigation (check-in/out into house rules, contact host to header) and build the Profile page with guest data assembly.

Purpose: NAV-04 (check-in/out in house rules), NAV-05 (contact host in header), NAV-08 (profile page) -- completing the navigation hierarchy redesign.
Output: HouseRulesSheet.tsx, ProfileView.tsx + modified DashboardHeader, CheckoutInfo, ContactSheet, BottomNav, page.tsx
</objective>

<execution_context>
@/Users/gianfrancodagostino/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gianfrancodagostino/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/33-guest-dashboard-redesign/33-RESEARCH.md
@.planning/phases/33-guest-dashboard-redesign/33-01-SUMMARY.md

Key source files (post 33-01):
@apps/accommodations/frontend/app/stay/[code]/page.tsx
@apps/accommodations/frontend/components/stay/DashboardHeader.tsx
@apps/accommodations/frontend/components/stay/CheckoutInfo.tsx
@apps/accommodations/frontend/components/stay/ContactSheet.tsx
@apps/accommodations/frontend/components/BottomNav.tsx
@apps/accommodations/frontend/components/stay/WelcomeCard.tsx
@apps/accommodations/frontend/components/stay/VisaStatusCard.tsx
@apps/accommodations/frontend/components/stay/VisaExpiryAlert.tsx
@apps/accommodations/frontend/components/stay/ActiveOrders.tsx
@apps/accommodations/frontend/components/stay/DocumentUpload.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: HouseRulesSheet + CheckoutInfo modification + Contact Host in header</name>
  <files>
    apps/accommodations/frontend/components/stay/HouseRulesSheet.tsx
    apps/accommodations/frontend/components/stay/CheckoutInfo.tsx
    apps/accommodations/frontend/components/stay/DashboardHeader.tsx
    apps/accommodations/frontend/components/stay/ContactSheet.tsx
  </files>
  <action>
**HouseRulesSheet.tsx (new):**
- A bottom sheet component (same pattern as ContactSheet.tsx -- fixed overlay with backdrop, rounded-t-3xl white panel)
- Props: `isOpen: boolean`, `onClose: () => void`, `checkInTime?: string`, `checkoutTime: string`, `checkoutProcedure?: string`, `houseRules?: string[]`
- Content layout:
  1. Drag handle bar at top (h-1 w-10 rounded-full bg-gray-300)
  2. Title: "House Rules" with BookOpen icon
  3. Check-in / Check-out times section: two side-by-side cards showing times (use the amber/teal accent colors from the design system). Check-in time displayed as "from {checkInTime}" if provided.
  4. Checkout procedure (if provided)
  5. House rules list with bullet points (reuse the existing rendering pattern from CheckoutInfo)
- Close on backdrop click or X button
- z-index: z-[60] (same as ContactSheet)
- Import BookOpen, Clock from @phosphor-icons/react

**CheckoutInfo.tsx -- Add checkInTime prop:**

- Add optional `checkInTime?: string` prop to CheckoutInfoProps interface
- This is needed so HouseRulesSheet can display both check-in and checkout times
- The component itself doesn't need to render checkInTime (HouseRulesSheet handles the combined display)
- Keep the component working as-is for backward compatibility (it's still used in the room route page.tsx for the /stay/room/[roomCode] path if applicable)

**DashboardHeader.tsx -- Add Contact Host button:**

- Add a new prop: `onContactHost?: () => void`
- Add a ChatCircleDots icon button (from @phosphor-icons/react) to the right side of the header, BEFORE the currency selector
- Button styling: `flex h-9 w-9 items-center justify-center rounded-xl bg-[#3D8B87]/10 text-[#3D8B87] transition-colors hover:bg-[#3D8B87]/20`
- Icon: ChatCircleDots size={20} weight="duotone"
- Only render the button if `onContactHost` prop is provided
- Import ChatCircleDots from @phosphor-icons/react

**ContactSheet.tsx -- Make externally controllable:**

- Currently ContactSheet manages its own `isOpen` state and renders its own trigger button
- Refactor to accept `isOpen: boolean` and `onClose: () => void` props (controlled mode)
- Remove the inline trigger button section (the `<section className="mb-5 px-4">` with the gradient button) -- the trigger is now in DashboardHeader
- Keep the bottom sheet rendering logic (the `{isOpen && ...}` block)
- The component now only renders the sheet overlay, not the trigger
  </action>
  <verify>
  TypeScript compilation: `cd apps/accommodations/frontend && npx tsc --noEmit --pretty 2>&1 | head -30`
  Verify HouseRulesSheet exists: `ls apps/accommodations/frontend/components/stay/HouseRulesSheet.tsx`
  Verify ContactSheet no longer has internal trigger button: `grep -c "section.*mb-5" apps/accommodations/frontend/components/stay/ContactSheet.tsx` should return 0
  </verify>
  <done>
  HouseRulesSheet renders a bottom sheet with check-in/out times and house rules. DashboardHeader has a Contact Host icon button. ContactSheet is externally controlled (no self-contained trigger button).
  </done>
  </task>

<task type="auto">
  <name>Task 2: ProfileView component + BottomNav update</name>
  <files>
    apps/accommodations/frontend/components/stay/ProfileView.tsx
    apps/accommodations/frontend/components/BottomNav.tsx
  </files>
  <action>
**ProfileView.tsx (new):**
- Props: `booking` (BookingInfo type from @/types/stay), `room` (RoomInfo), `property` (PropertyInfo), `documents` (GuestDocument[]), `orders` (from useOrderPolling), `activeVisa` (GuestDocument | undefined), `onUploadDocument: () => void`
- Layout sections (vertical stack with gap-4, px-4 py-4):

1. **Guest Info Card** (rounded-2xl bg-white p-4 shadow-sm):
   - Guest name (booking.guestName), nationality (booking.guestCountry), email (booking.guestEmail)
   - Room number and room type
   - Check-in / check-out dates
   - Styled with UserCircle icon header

2. **Visa Status** (if booking.guestCountry exists):
   - Import and render VisaStatusCard (moved from homepage)
   - Show VisaExpiryAlert if activeVisa has expiry date

3. **Documents** (rounded-2xl bg-white p-4 shadow-sm):
   - List of uploaded documents (same rendering as current homepage documents section)
   - "Upload Document" button that calls onUploadDocument
   - Show document count in header

4. **Order History** (rounded-2xl bg-white p-4 shadow-sm):
   - List all orders (not just active) with status badge, date, total
   - Use ClipboardText icon header
   - If no orders: "No orders yet" message
   - Each order shows: status pill (colored by status), items summary (first 2 item names + "and N more"), total amount

5. **Preferences** (rounded-2xl bg-white p-4 shadow-sm):
   - Placeholder section: "Your preferences will be saved for future stays"
   - Currency preference (show current selected currency)
   - Language preference (show browser language)
   - This is a stub for Phase 38 (returning guest detection)

Import types from @/types/stay. Import VisaStatusCard, VisaExpiryAlert from existing components.

**BottomNav.tsx -- Update nav items:**

- Remove the 'menu' tab (SquaresFour) -- it has no defined function
- Keep: home (House), map (MapPin), services (CallBell center), profile (UserCircle)
- Result: 4 tabs instead of 5 (more spacious, cleaner)
- Nav items array becomes:
  ```
  { id: 'home', label: 'Home', Icon: House },
  { id: 'map', label: 'Explore', Icon: MapPin },
  { id: 'services', label: 'Services', Icon: CallBell, isCenter: true },
  { id: 'profile', label: 'Profile', Icon: UserCircle },
  ```
- Rename "Map" label to "Explore" (aligns with Phase 36 Explore page)
- Remove the `onMenuToggle` call for the 'menu' tab (since menu tab is removed)
  </action>
  <verify>
  TypeScript compilation: `cd apps/accommodations/frontend && npx tsc --noEmit --pretty 2>&1 | head -30`
  Verify ProfileView exists: `ls apps/accommodations/frontend/components/stay/ProfileView.tsx`
  Verify BottomNav has 4 tabs: `grep -c "id:" apps/accommodations/frontend/components/BottomNav.tsx` should return 4
  </verify>
  <done>
  ProfileView renders guest data, documents, order history, visa status, and preferences stub. BottomNav has 4 tabs (Home, Explore, Services, Profile) with "Menu" removed.
  </done>
  </task>

<task type="auto">
  <name>Task 3: Wire everything into page.tsx</name>
  <files>
    apps/accommodations/frontend/app/stay/[code]/page.tsx
  </files>
  <action>
Wire all new components into the InStayDashboard page. This is the integration task.

**Add state:**

- `showHouseRules` (boolean, default false) -- controls HouseRulesSheet open/close
- `showContact` (boolean, default false) -- controls ContactSheet open/close

**Wire House Rules card onClick (from 33-01):**

- The House Rules DashboardCard onClick should now call `() => setShowHouseRules(true)`

**Wire DashboardHeader:**

- Pass `onContactHost={() => setShowContact(true)}` to DashboardHeader

**Wire ContactSheet:**

- Change ContactSheet to controlled mode: `<ContactSheet isOpen={showContact} onClose={() => setShowContact(false)} phone={hostPhone} whatsapp={property.contactWhatsapp} roomNumber={room.number} propertyName={property.name} />`
- Remove the old ContactSheet from inside the home tab content (it was commented out in 33-01)

**Wire HouseRulesSheet:**

- Render `<HouseRulesSheet isOpen={showHouseRules} onClose={() => setShowHouseRules(false)} checkInTime={property.checkInTime} checkoutTime={property.checkoutTime} checkoutProcedure={property.checkoutProcedure} houseRules={property.houseRules} />`
- Place it alongside the other overlays (CartDrawer, ServiceCatalog) near the bottom of the JSX

**Wire Profile tab:**

- In `renderTabContent()`, replace the placeholder `case 'profile'` with:
  ```tsx
  case 'profile':
    return (
      <ProfileView
        booking={booking}
        room={room}
        property={property}
        documents={documents}
        orders={orders}
        activeVisa={activeVisa}
        onUploadDocument={() => setShowUpload(true)}
      />
    );
  ```

**Clean up commented imports from 33-01:**

- Remove commented-out imports for WelcomeCard, QuickActions, VisaStatusCard, VisaExpiryAlert (these are now used inside ProfileView, not page.tsx)
- Keep CheckoutInfo import removed (now inside HouseRulesSheet)
- Keep ContactSheet import (still used, but in controlled mode)

**Update BottomNav usage:**

- The `onMenuToggle` prop can be removed or kept as no-op since BottomNav no longer has a 'menu' tab
- If BottomNav interface still requires onMenuToggle for type compat, pass `() => {}` (it's already doing this)

**Import new components:**

- Import HouseRulesSheet from '@/components/stay/HouseRulesSheet'
- Import ProfileView from '@/components/stay/ProfileView'

CRITICAL STATE CONTRACT CHECK: After all changes, verify these are still present and functional:

- useStaySession hook providing token, stay, isLoading, isAuthenticated
- useServiceCart hook at page level
- useOrderPolling with bookingCode, token, enabled
- serviceCategories state + handleCategoriesLoaded callback
- showCatalog state for ServiceCatalog overlay
- showCart state for CartDrawer overlay
- documents state + loadDocuments callback
- CartFAB with cart.itemCount
  </action>
  <verify>

1. TypeScript compilation: `cd apps/accommodations/frontend && npx tsc --noEmit --pretty 2>&1 | head -30`
2. Build check: `cd apps/accommodations/frontend && npx next build 2>&1 | tail -20`
3. State contract check: `grep -c "useServiceCart\|useOrderPolling\|useStaySession\|CartFAB\|CartDrawer\|ServiceCatalog\|HouseRulesSheet\|ProfileView\|ContactSheet" apps/accommodations/frontend/app/stay/\[code\]/page.tsx` should return 9+
4. Verify no broken imports: `grep "^import" apps/accommodations/frontend/app/stay/\[code\]/page.tsx | wc -l` -- should have reasonable count (15-20 imports)
   </verify>
   <done>
   HouseRulesSheet opens from House Rules card. Contact Host opens from header button. Profile tab renders ProfileView with guest data, documents, orders, and visa status. All state contracts preserved. TypeScript compiles. Next.js builds.
   </done>
   </task>

</tasks>

<verification>
1. `cd apps/accommodations/frontend && npx tsc --noEmit` -- zero errors
2. `cd apps/accommodations/frontend && npx next build` -- build succeeds
3. House Rules card in grid triggers bottom sheet: grep confirms `showHouseRules` state and HouseRulesSheet render
4. Contact Host button in header: grep confirms `onContactHost` prop on DashboardHeader
5. Profile tab renders ProfileView: grep confirms `case 'profile'` returns ProfileView component
6. BottomNav has 4 tabs (not 5): grep confirms 4 nav items
7. All critical state contracts preserved (cart, orders, services, documents, token, catalog)
</verification>

<success_criteria>

- House Rules bottom sheet shows check-in/out times and house rules when card is tapped
- Contact Host is a button in the dashboard header (not a full section on homepage)
- Profile tab shows guest info, documents, order history, visa status, and preferences stub
- BottomNav has 4 tabs: Home, Explore, Services, Profile
- All existing functionality (cart, orders, services, documents, catalog) works unchanged
- TypeScript compiles without errors
- Next.js build succeeds
  </success_criteria>

<output>
After completion, create `.planning/phases/33-guest-dashboard-redesign/33-02-SUMMARY.md`
</output>
