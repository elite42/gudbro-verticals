---
phase: 13-foundation-ai-pipeline
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - shared/database/migrations/schema/082-feedback-intelligence.sql
autonomous: true

must_haves:
  truths:
    - 'fb_submissions table accepts merchant feedback with original text, language, and processing state'
    - 'fb_tasks table stores aggregated tasks with denormalized metrics (submission_count, avg_sentiment, language set)'
    - 'fb_merchant_notifications table stores notification records per merchant'
    - 'find_similar_tasks() function returns ranked matches using tag overlap + trigram similarity'
    - 'RLS policies restrict merchant access to own data while allowing service role full access'
  artifacts:
    - path: 'shared/database/migrations/schema/082-feedback-intelligence.sql'
      provides: 'Complete schema for feedback intelligence system'
      contains: 'fb_submissions'
  key_links:
    - from: 'fb_submissions'
      to: 'fb_tasks'
      via: 'task_id FK'
      pattern: 'FOREIGN KEY.*task_id.*REFERENCES fb_tasks'
    - from: 'fb_submissions'
      to: 'merchants'
      via: 'merchant_id FK'
      pattern: "REFERENCES merchants\\(id\\)"
    - from: 'find_similar_tasks'
      to: 'fb_tasks'
      via: 'similarity query'
      pattern: 'FROM fb_tasks'
---

<objective>
Create the database schema for the Merchant Feedback Intelligence system: three tables (fb_submissions, fb_tasks, fb_merchant_notifications), indexes, RLS policies, and a similarity detection function.

Purpose: This is the data foundation for the entire v1.3 milestone. Phases 14-17 all build on these tables.
Output: Migration file `082-feedback-intelligence.sql` ready to apply to Supabase.
</objective>

<execution_context>
@/Users/gianfrancodagostino/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gianfrancodagostino/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-foundation-ai-pipeline/13-RESEARCH.md

Key references for patterns:
@shared/database/migrations/schema/029-ai-feedback-loop.sql
@shared/database/migrations/schema/024-merchant-followers-feedback.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create fb_submissions and fb_tasks tables with indexes and constraints</name>
  <files>shared/database/migrations/schema/082-feedback-intelligence.sql</files>
  <action>
Create migration file `082-feedback-intelligence.sql` with the following structure. Follow existing migration patterns exactly (UUID PKs, TEXT + CHECK constraints, never ENUM, TIMESTAMPTZ for dates).

**Start with:**

```sql
CREATE EXTENSION IF NOT EXISTS "pg_trgm";
```

**Table: fb_submissions**

- `id` UUID PK with gen_random_uuid()
- `merchant_id` UUID NOT NULL FK to merchants(id) ON DELETE CASCADE
- `original_title` TEXT (nullable — not all feedback has a title)
- `original_body` TEXT NOT NULL
- `source` TEXT NOT NULL DEFAULT 'manual' CHECK IN ('manual', 'chat', 'email', 'api')
- `vertical` TEXT (nullable — which app the feedback came from)
- `page_path` TEXT (nullable — which page they were on)
- AI-processed fields (all nullable, populated after processing):
  - `detected_language` TEXT (ISO 639-1)
  - `translated_title` TEXT
  - `translated_body` TEXT
  - `type` TEXT CHECK IN ('bug', 'feature_request', 'improvement', 'complaint', 'praise', 'operational')
  - `priority` INTEGER CHECK BETWEEN 1 AND 5
  - `sentiment` TEXT CHECK IN ('positive', 'neutral', 'negative')
  - `ai_confidence` DECIMAL(3,2)
  - `tags` TEXT[] DEFAULT '{}'
- `task_id` UUID (FK added after fb_tasks creation)
- Processing state: `status` TEXT NOT NULL DEFAULT 'pending' CHECK IN ('pending', 'processing', 'processed', 'failed'), `processing_attempts` INTEGER NOT NULL DEFAULT 0, `processing_error` TEXT, `processed_at` TIMESTAMPTZ
- `submitted_by_account_id` UUID REFERENCES accounts(id)
- `screenshot_url` TEXT (nullable — for Phase 14 screenshot upload)
- Standard timestamps: created_at, updated_at

**Table: fb_tasks**

- `id` UUID PK with gen_random_uuid()
- `merchant_id` UUID NOT NULL FK to merchants(id) ON DELETE CASCADE
- `title` TEXT NOT NULL
- `description` TEXT
- `type` TEXT NOT NULL CHECK (same values as submissions)
- `priority` INTEGER NOT NULL CHECK BETWEEN 1 AND 5
- `tags` TEXT[] DEFAULT '{}'
- `status` TEXT NOT NULL DEFAULT 'new' CHECK IN ('new', 'reviewing', 'in_progress', 'done', 'rejected')
- Denormalized metrics: `submission_count` INTEGER NOT NULL DEFAULT 1, `languages` TEXT[] DEFAULT '{}', `avg_sentiment` DECIMAL(3,2), `first_submitted_at` TIMESTAMPTZ, `last_submitted_at` TIMESTAMPTZ
- Resolution: `resolved_at` TIMESTAMPTZ, `resolution_note` TEXT
- Standard timestamps

**After fb_tasks is created**, add the FK constraint:

```sql
ALTER TABLE fb_submissions ADD CONSTRAINT fk_fb_submissions_task
  FOREIGN KEY (task_id) REFERENCES fb_tasks(id) ON DELETE SET NULL;
```

**Table: fb_merchant_notifications**

- `id` UUID PK
- `merchant_id` UUID NOT NULL FK to merchants(id) ON DELETE CASCADE
- `account_id` UUID NOT NULL FK to accounts(id) ON DELETE CASCADE (recipient)
- `submission_id` UUID FK to fb_submissions(id) ON DELETE CASCADE
- `task_id` UUID FK to fb_tasks(id) ON DELETE CASCADE
- `type` TEXT NOT NULL CHECK IN ('acknowledged', 'status_changed', 'resolved', 'rejected')
- `title` TEXT NOT NULL
- `body` TEXT
- `is_read` BOOLEAN NOT NULL DEFAULT false
- `read_at` TIMESTAMPTZ
- Standard timestamps

**Indexes** (create after all tables):

- fb_submissions: merchant+created_at DESC, status (partial: pending/processing), task_id (partial: NOT NULL), tags GIN, translated_body GIN gin_trgm_ops
- fb_tasks: merchant+status, merchant+created_at DESC, tags GIN
- fb_merchant_notifications: account_id+is_read+created_at DESC, merchant_id

**Comments** on each table explaining its purpose.
</action>
<verify>
Verify SQL syntax by checking: all CHECK constraints use parentheses correctly, all FKs reference existing tables (merchants, accounts), all TEXT[] arrays have DEFAULT '{}', all indexes reference existing columns. Grep for common SQL mistakes: missing semicolons, unclosed parentheses.
</verify>
<done>Three tables created with proper constraints, indexes, and foreign keys. Migration file is syntactically valid SQL.</done>
</task>

<task type="auto">
  <name>Task 2: Add RLS policies and similarity detection function</name>
  <files>shared/database/migrations/schema/082-feedback-intelligence.sql</files>
  <action>
Append to the same migration file:

**RLS — enable on all three tables:**

For each table (fb_submissions, fb_tasks, fb_merchant_notifications):

```sql
ALTER TABLE {table} ENABLE ROW LEVEL SECURITY;
```

**RLS policies pattern** (from 029-ai-feedback-loop.sql):

For fb_submissions:

- SELECT: Merchants can view own (via account_roles lookup where ar.tenant_id = fb_submissions.merchant_id AND ar.role_type = 'merchant' AND ar.is_active = true)
- INSERT: Merchants can insert own (same check on merchant_id)
- Service role: full access FOR ALL USING (auth.role() = 'service_role')

For fb_tasks:

- SELECT: Merchants can view own tasks
- Service role: full access

For fb_merchant_notifications:

- SELECT: Account can view own notifications (account_id matches auth.uid() via accounts table)
- UPDATE: Account can update own (for marking as read)
- Service role: full access

**Similarity detection function:**

Create `find_similar_tasks(p_merchant_id UUID, p_translated_body TEXT, p_tags TEXT[], p_threshold DECIMAL DEFAULT 0.5)` that:

1. Searches fb_tasks WHERE merchant_id matches AND status NOT IN ('done', 'rejected')
2. Calculates combined score: 60% tag overlap (count of matching tags / total tags in input) + 40% trigram similarity on (title || ' ' || description) vs p_translated_body
3. Returns TABLE(task_id UUID, similarity_score DECIMAL, tag_overlap INTEGER, trigram_score REAL)
4. Filters results >= p_threshold, orders by similarity_score DESC, limits to 5
5. Use LANGUAGE plpgsql, SECURITY DEFINER, SET search_path = public

Follow the exact pattern from the RESEARCH.md Example 3, but fix the HAVING clause — it should use a subquery or CTE pattern since HAVING requires GROUP BY. Use a WHERE clause with a subquery or compute the score in a CTE instead.

**Helper function: update_task_metrics**

Create `update_task_metrics(p_task_id UUID)` that recalculates denormalized fields on fb_tasks by querying linked fb_submissions:

- submission_count = COUNT(\*)
- languages = array of distinct detected_language values
- avg_sentiment = numeric average mapping positive=1, neutral=0.5, negative=0
- last_submitted_at = MAX(created_at)
  Use LANGUAGE plpgsql, SECURITY DEFINER, SET search_path = public.

**Updated_at trigger:**

Create a generic `update_updated_at_column()` trigger function (if not already exists — wrap in DO $$ block) and apply triggers to all three tables.
</action>
<verify>
Verify: all RLS policies reference correct columns and use the account_roles pattern consistently. The find_similar_tasks function uses valid SQL (no HAVING without GROUP BY). The update_task_metrics function correctly maps sentiment to numeric values. Check trigger function syntax.
</verify>
<done>RLS policies enforce tenant isolation for all three tables. find_similar_tasks returns ranked similar tasks by combined tag+trigram score. update_task_metrics recalculates denormalized fields. Updated_at triggers fire on all tables.</done>
</task>

</tasks>

<verification>
- Migration file exists at `shared/database/migrations/schema/082-feedback-intelligence.sql`
- File contains CREATE TABLE for: fb_submissions, fb_tasks, fb_merchant_notifications
- File contains CREATE INDEX statements for all specified indexes
- File contains ALTER TABLE ... ENABLE ROW LEVEL SECURITY for all three tables
- File contains CREATE POLICY statements for merchant access and service role bypass
- File contains CREATE OR REPLACE FUNCTION find_similar_tasks
- File contains CREATE OR REPLACE FUNCTION update_task_metrics
- File contains trigger setup for updated_at
- No ENUM types used (TEXT + CHECK only)
- All UUIDs use gen_random_uuid()
</verification>

<success_criteria>
Migration file `082-feedback-intelligence.sql` is complete and syntactically valid, containing all three tables, indexes, RLS policies, similarity function, metrics update function, and triggers. Ready to be applied to Supabase.
</success_criteria>

<output>
After completion, create `.planning/phases/13-foundation-ai-pipeline/13-01-SUMMARY.md`
</output>
