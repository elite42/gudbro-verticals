---
phase: 24-analytics-deals-communication
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - shared/database/migrations/schema/087-analytics-deals-communication.sql
  - apps/backoffice/app/api/accommodations/analytics/kpis/route.ts
  - apps/backoffice/app/api/accommodations/analytics/revenue-chart/route.ts
  - apps/backoffice/app/api/accommodations/analytics/occupancy-chart/route.ts
  - apps/backoffice/components/accommodations/KPICard.tsx
  - apps/backoffice/components/accommodations/AccommodationAnalytics.tsx
  - apps/backoffice/app/(dashboard)/accommodations/analytics/page.tsx
  - apps/backoffice/components/layout/Sidebar.tsx
autonomous: true

must_haves:
  truths:
    - 'Owner can view occupancy rate percentage for a selected time period'
    - 'Owner can view total revenue, revenue by room type, and ADR'
    - 'Owner can view service revenue breakdown by category'
    - 'Owner can switch between 7d, 30d, 90d, 12m time periods'
    - 'Analytics page is accessible from the sidebar under Accommodations'
  artifacts:
    - path: 'shared/database/migrations/schema/087-analytics-deals-communication.sql'
      provides: 'accom_deals, accom_deal_clicks, accom_email_logs tables'
      contains: 'CREATE TABLE accom_deals'
    - path: 'apps/backoffice/app/api/accommodations/analytics/kpis/route.ts'
      provides: 'KPI endpoint (occupancy, revenue, ADR, service revenue)'
      exports: ['GET']
    - path: 'apps/backoffice/app/api/accommodations/analytics/revenue-chart/route.ts'
      provides: 'Stacked bar chart data by month and room type'
      exports: ['GET']
    - path: 'apps/backoffice/app/api/accommodations/analytics/occupancy-chart/route.ts'
      provides: 'Daily occupancy line chart data'
      exports: ['GET']
    - path: 'apps/backoffice/app/(dashboard)/accommodations/analytics/page.tsx'
      provides: 'Analytics dashboard page'
      min_lines: 20
    - path: 'apps/backoffice/components/accommodations/AccommodationAnalytics.tsx'
      provides: 'Main analytics component with charts and KPIs'
      min_lines: 100
  key_links:
    - from: 'AccommodationAnalytics.tsx'
      to: '/api/accommodations/analytics/kpis'
      via: 'fetch with period param'
      pattern: 'fetch.*analytics/kpis'
    - from: 'AccommodationAnalytics.tsx'
      to: '/api/accommodations/analytics/revenue-chart'
      via: 'fetch with period param'
      pattern: 'fetch.*analytics/revenue'
    - from: 'Sidebar.tsx'
      to: 'accommodations/analytics'
      via: 'nav link'
      pattern: 'analytics'
---

<objective>
Create the database migration for all Phase 24 tables (deals, click tracking, email logs), build the analytics API routes with SQL aggregation queries, and implement the full analytics dashboard UI with recharts charts and KPI cards.

Purpose: Owners need visibility into property performance (occupancy, revenue, ADR, service revenue) to make informed business decisions. The migration also lays the foundation for Plans 02 and 03.
Output: Migration 087, 3 analytics API routes, analytics dashboard page with KPI cards and charts, sidebar navigation update.
</objective>

<execution_context>
@/Users/gianfrancodagostino/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gianfrancodagostino/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/24-analytics-deals-communication/24-CONTEXT.md
@.planning/phases/24-analytics-deals-communication/24-RESEARCH.md

Key references:

- @apps/backoffice/components/feedback-analytics/AnalyticsDashboard.tsx (recharts pattern to follow)
- @apps/backoffice/app/api/accommodations/bookings/route.ts (API auth pattern: validateAdminApiKey)
- @apps/backoffice/components/layout/Sidebar.tsx (sidebar nav to update)
- @shared/database/migrations/schema/086-service-automation-level.sql (previous migration)
- @shared/database/migrations/schema/083-accommodations-v2-foundation.sql (existing tables: accom_bookings, accom_rooms, accom_service_orders, accom_service_order_items, accom_service_categories, accom_service_items)
  </context>

<tasks>

<task type="auto">
  <name>Task 1: Database migration 087 + Analytics API routes</name>
  <files>
    shared/database/migrations/schema/087-analytics-deals-communication.sql
    apps/backoffice/app/api/accommodations/analytics/kpis/route.ts
    apps/backoffice/app/api/accommodations/analytics/revenue-chart/route.ts
    apps/backoffice/app/api/accommodations/analytics/occupancy-chart/route.ts
  </files>
  <action>
    1. Create migration 087 with three new tables:
       - `accom_deals` (id UUID PK, property_id FK->accom_properties CASCADE, partner_name TEXT NOT NULL, discount_description TEXT NOT NULL, description TEXT, url TEXT, image_url TEXT, is_active BOOLEAN DEFAULT true, display_order INTEGER DEFAULT 0, created_at TIMESTAMPTZ DEFAULT NOW(), updated_at TIMESTAMPTZ DEFAULT NOW())
       - `accom_deal_clicks` (id UUID PK, deal_id FK->accom_deals CASCADE, booking_id FK->accom_bookings SET NULL, clicked_at TIMESTAMPTZ DEFAULT NOW())
       - `accom_email_logs` (id UUID PK, booking_id FK->accom_bookings CASCADE, email_type TEXT CHECK IN ('booking_confirmation','pre_arrival'), recipient_email TEXT NOT NULL, status TEXT CHECK IN ('sent','failed','skipped'), provider_message_id TEXT, error_message TEXT, sent_at TIMESTAMPTZ DEFAULT NOW())
       - Add indexes: accom_deals(property_id), accom_deal_clicks(deal_id), accom_email_logs(booking_id, email_type)
       - RLS: enable on all three tables, same pattern as other accom_ tables

    2. Create GET /api/accommodations/analytics/kpis:
       - Accept query params: propertyId (required), days (7|30|90|365, default 30)
       - Use validateAdminApiKey() for auth
       - Compute 4 KPIs via SQL on accom_bookings + accom_rooms + accom_service_orders:
         a. Occupancy rate: use generate_series for date grid, LEFT JOIN bookings (confirmed/checked_in/checked_out), divide occupied rooms by active room count. COALESCE with NULLIF to handle zero rooms.
         b. Total revenue: SUM(total_price) from bookings in period
         c. ADR: total_revenue / NULLIF(total_room_nights, 0)
         d. Service revenue: SUM(total) from accom_service_orders in period (status != 'cancelled')
       - For each KPI, compute previous period value for trend comparison (e.g., if 30d selected, compare vs prior 30d)
       - Return: { occupancyRate, totalRevenue, adr, serviceRevenue } each with { value, previousValue, trend: 'up'|'down'|'flat' }

    3. Create GET /api/accommodations/analytics/revenue-chart:
       - Accept: propertyId, days
       - Return monthly revenue data grouped by room_type + services
       - Each data point: { month: 'Jan 2026', [roomType1]: amount, [roomType2]: amount, ..., services: amount }
       - Ensure ALL room types appear in every data point (even if 0) for recharts stacked bars
       - Query accom_bookings JOIN accom_rooms for room revenue, accom_service_orders for service revenue

    4. Create GET /api/accommodations/analytics/occupancy-chart:
       - Accept: propertyId, days
       - Return daily occupancy: { date: 'YYYY-MM-DD', occupancy: number (0-100) }
       - Use generate_series + LEFT JOIN pattern, same as KPIs
       - Limit to past dates only (exclude future)

  </action>
  <verify>
    - Migration SQL is valid (no syntax errors, correct FK references, proper CHECK constraints)
    - Each API route exports GET function
    - `cd apps/backoffice && npx tsc --noEmit` passes
  </verify>
  <done>Migration 087 creates 3 tables with indexes and RLS. Three analytics API endpoints return KPI data, revenue chart data, and occupancy chart data with period-based filtering and trend comparison.</done>
</task>

<task type="auto">
  <name>Task 2: Analytics dashboard UI + sidebar navigation</name>
  <files>
    apps/backoffice/components/accommodations/KPICard.tsx
    apps/backoffice/components/accommodations/AccommodationAnalytics.tsx
    apps/backoffice/app/(dashboard)/accommodations/analytics/page.tsx
    apps/backoffice/components/layout/Sidebar.tsx
  </files>
  <action>
    1. Create KPICard.tsx component:
       - Props: { title, value, previousValue, trend, format: 'percent'|'currency'|'number', currencyCode? }
       - Display: value prominently, trend arrow (up=green, down=red, flat=gray) with percentage change
       - Use Phosphor icons (TrendUp, TrendDown, Minus) for trend indicators
       - Follow existing card styling from feedback-analytics/AnalyticsDashboard.tsx

    2. Create AccommodationAnalytics.tsx:
       - Period selector: tabs/buttons for 7d, 30d, 90d, 12m (default 30d)
       - Top row: 4 KPICard components (Occupancy Rate %, Total Revenue, ADR, Service Revenue)
       - Revenue chart: recharts BarChart with stacked bars by room type + services. Use ResponsiveContainer, CartesianGrid, XAxis (month), YAxis, Tooltip, Legend. Color map for room types.
       - Occupancy chart: recharts LineChart showing daily occupancy %. ResponsiveContainer, CartesianGrid, XAxis (date), YAxis (0-100%), Tooltip.
       - Revenue breakdown table: simple HTML table with room type rows + service category rows, showing revenue and count
       - Loading states: skeleton/spinner while fetching
       - Empty state: "No data yet" message when no bookings exist (follow existing pattern)
       - Fetch from /api/accommodations/analytics/* using AUTH_HEADERS pattern (module-level const with x-admin-api-key header)
       - Refetch on period change

    3. Create analytics/page.tsx:
       - Import and render AccommodationAnalytics
       - Pass propertyId (from env or route context, same pattern as other accommodations pages)

    4. Update Sidebar.tsx:
       - Add "Analytics" nav item under Accommodations section, between "Services" and "Settings" (or after "Calendar & Pricing")
       - Add "Deals" nav item after "Analytics"
       - Use ChartBar icon for Analytics, Tag or Handshake icon for Deals (Phosphor)
       - Link to /accommodations/analytics and /accommodations/deals respectively

  </action>
  <verify>
    - `cd apps/backoffice && npx tsc --noEmit` passes
    - Analytics page renders at /accommodations/analytics
    - Sidebar shows Analytics and Deals links
    - KPI cards display with trend indicators
    - Charts render with recharts (stacked bar + line)
  </verify>
  <done>Analytics dashboard shows 4 KPI cards with trend comparison, stacked revenue bar chart by room type, occupancy line chart, and revenue breakdown table. Period selector switches between 7d/30d/90d/12m. Sidebar has Analytics and Deals navigation items.</done>
</task>

</tasks>

<verification>
- Migration 087 SQL is syntactically valid with correct FK references
- `cd apps/backoffice && npx tsc --noEmit` passes
- Analytics page accessible via sidebar navigation
- KPI cards show occupancy rate, revenue, ADR, service revenue with trends
- Revenue chart renders stacked bars by room type
- Occupancy chart renders daily line chart
- Period selector changes data across all components
</verification>

<success_criteria>

- OANA-01: Owner can view occupancy rate over time via occupancy chart and KPI card
- OANA-02: Owner can view revenue summary (total in KPI, by room type in stacked bar, by month on X axis)
- OANA-03: Owner can view ADR trend via KPI card with previous period comparison
- OANA-04: Owner can view service revenue breakdown in KPI card and revenue breakdown table
- Migration 087 creates accom_deals, accom_deal_clicks, accom_email_logs tables (foundation for Plans 02, 03)
  </success_criteria>

<output>
After completion, create `.planning/phases/24-analytics-deals-communication/24-01-SUMMARY.md`
</output>
