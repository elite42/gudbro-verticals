---
phase: 16-admin-kanban
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/backoffice/app/api/feedback/tasks/route.ts
  - apps/backoffice/app/api/feedback/tasks/[id]/route.ts
  - apps/backoffice/app/api/feedback/tasks/[id]/submissions/route.ts
  - apps/backoffice/app/(dashboard)/platform/feedback-tasks/page.tsx
  - apps/backoffice/components/feedback-kanban/KanbanBoard.tsx
  - apps/backoffice/components/feedback-kanban/KanbanColumn.tsx
  - apps/backoffice/components/feedback-kanban/TaskCard.tsx
autonomous: true

must_haves:
  truths:
    - 'Admin sees a kanban board with five columns (New, Reviewing, In Progress, Done, Rejected) populated with tasks'
    - 'Admin can drag a task card between columns and the status persists after page refresh'
    - 'Each task card shows merchant count, languages involved, sentiment indicator, and priority badge'
  artifacts:
    - path: 'apps/backoffice/app/api/feedback/tasks/route.ts'
      provides: 'GET all tasks (admin cross-merchant), PATCH task status'
      exports: ['GET', 'PATCH']
    - path: 'apps/backoffice/app/api/feedback/tasks/[id]/route.ts'
      provides: 'GET single task detail'
      exports: ['GET']
    - path: 'apps/backoffice/app/api/feedback/tasks/[id]/submissions/route.ts'
      provides: 'GET linked submissions for a task'
      exports: ['GET']
    - path: 'apps/backoffice/app/(dashboard)/platform/feedback-tasks/page.tsx'
      provides: 'Admin kanban page shell'
    - path: 'apps/backoffice/components/feedback-kanban/KanbanBoard.tsx'
      provides: 'DndContext wrapper with columns, DragOverlay, optimistic updates'
    - path: 'apps/backoffice/components/feedback-kanban/KanbanColumn.tsx'
      provides: 'useDroppable column with header and task count'
    - path: 'apps/backoffice/components/feedback-kanban/TaskCard.tsx'
      provides: 'useDraggable card with priority badge, sentiment, languages, submission count'
  key_links:
    - from: 'apps/backoffice/components/feedback-kanban/KanbanBoard.tsx'
      to: '/api/feedback/tasks'
      via: 'fetch on mount + PATCH on drag end'
      pattern: 'fetch.*api/feedback/tasks'
    - from: 'apps/backoffice/app/api/feedback/tasks/route.ts'
      to: "supabaseAdmin.from('fb_tasks')"
      via: 'admin query bypassing RLS'
      pattern: 'supabaseAdmin.*fb_tasks'
    - from: 'apps/backoffice/app/api/feedback/tasks/route.ts'
      to: 'lib/feedback/notification-utils.ts'
      via: 'notifyTaskStatusChange on PATCH'
      pattern: 'notifyTaskStatusChange'
---

<objective>
Build the admin kanban board with API routes, drag-and-drop columns, and task cards showing aggregated metrics.

Purpose: Admins need a visual board to manage feedback-derived tasks across all merchants, with five status columns and drag-and-drop to change task status.
Output: Working kanban page at /platform/feedback-tasks with functional drag-and-drop, optimistic updates, and notification triggers on status change.
</objective>

<execution_context>
@/Users/gianfrancodagostino/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gianfrancodagostino/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-admin-kanban/16-RESEARCH.md
@.planning/phases/16-admin-kanban/16-CONTEXT.md
@.planning/phases/15-merchant-notifications/15-01-SUMMARY.md

Key prior work:

- notifyTaskStatusChange(taskId, newStatus) is in apps/backoffice/lib/feedback/notification-utils.ts (fire-and-forget, queries linked submissions, creates per-submitter notifications)
- fb_tasks has denormalized metrics: submission_count, languages[], avg_sentiment, priority
- fb_tasks.status CHECK: 'new', 'reviewing', 'in_progress', 'done', 'rejected'
- supabaseAdmin in apps/backoffice/lib/supabase-admin.ts bypasses RLS for admin cross-merchant access
- @dnd-kit/core ^6.3.1 already installed, existing usage in site-builder SectionList.tsx
- Radix Dialog component exists at apps/backoffice/components/ui/dialog.tsx
  </context>

<tasks>

<task type="auto">
  <name>Task 1: API routes for feedback tasks (GET all, GET single, GET submissions, PATCH status)</name>
  <files>
    apps/backoffice/app/api/feedback/tasks/route.ts
    apps/backoffice/app/api/feedback/tasks/[id]/route.ts
    apps/backoffice/app/api/feedback/tasks/[id]/submissions/route.ts
  </files>
  <action>
Create three API route files for the admin kanban board. All routes use supabaseAdmin to bypass RLS (admin needs cross-merchant task access). All routes verify auth with createClient().auth.getUser() first.

**1. /api/feedback/tasks/route.ts (GET + PATCH)**

GET handler:

- Auth check with createClient().auth.getUser()
- Query supabaseAdmin.from('fb_tasks').select('\*').order('priority', { ascending: true }).order('last_submitted_at', { ascending: false })
- Return { tasks: Task[] }

PATCH handler:

- Auth check
- Parse body: { taskId: string, status: string, resolutionNote?: string }
- Validate status is one of: 'new', 'reviewing', 'in_progress', 'done', 'rejected'
- Build update payload: { status }. If done/rejected, add resolved_at = new Date().toISOString(). If resolutionNote provided, add resolution_note.
- Update via supabaseAdmin.from('fb_tasks').update(payload).eq('id', taskId)
- Fire-and-forget: if status is 'in_progress', 'done', or 'rejected', call notifyTaskStatusChange(taskId, status) from lib/feedback/notification-utils.ts (do NOT await it -- fire-and-forget per D-1501-1)
- Return { success: true }

**2. /api/feedback/tasks/[id]/route.ts (GET)**

- Auth check
- Query supabaseAdmin.from('fb_tasks').select('\*').eq('id', params.id).single()
- Return { task }

**3. /api/feedback/tasks/[id]/submissions/route.ts (GET)**

- Auth check
- Query supabaseAdmin.from('fb_submissions').select('id, merchant_id, original_title, original_body, translated_title, translated_body, detected_language, type, priority, sentiment, tags, screenshot_url, submitted_by_account_id, created_at').eq('task_id', params.id).order('created_at', { ascending: false })
- Return { submissions }

All routes: export const dynamic = 'force-dynamic'. Import createClient from '@/lib/supabase-server' and supabaseAdmin from '@/lib/supabase-admin'. Import notifyTaskStatusChange from '@/lib/feedback/notification-utils' in the tasks route only. Use NextRequest/NextResponse from 'next/server'. Follow the pattern from existing route apps/backoffice/app/api/feedback/history/route.ts.
</action>
<verify>
TypeScript compilation passes: cd apps/backoffice && npx tsc --noEmit (or check just the new files).
All three route files export the correct HTTP methods (GET for all, PATCH for tasks/route.ts).
</verify>
<done>
Three API routes exist: GET /api/feedback/tasks returns all tasks sorted by priority, PATCH /api/feedback/tasks updates status and fires notifications, GET /api/feedback/tasks/[id] returns single task, GET /api/feedback/tasks/[id]/submissions returns linked submissions.
</done>
</task>

<task type="auto">
  <name>Task 2: Kanban board page, KanbanBoard, KanbanColumn, and TaskCard components with drag-and-drop</name>
  <files>
    apps/backoffice/app/(dashboard)/platform/feedback-tasks/page.tsx
    apps/backoffice/components/feedback-kanban/KanbanBoard.tsx
    apps/backoffice/components/feedback-kanban/KanbanColumn.tsx
    apps/backoffice/components/feedback-kanban/TaskCard.tsx
  </files>
  <action>
Create the kanban board UI with @dnd-kit multi-column drag-and-drop.

**Types (define inline in KanbanBoard.tsx or a shared types block):**

```typescript
interface FeedbackTask {
  id: string;
  title: string;
  description: string | null;
  type: string;
  priority: number;
  tags: string[];
  status: 'new' | 'reviewing' | 'in_progress' | 'done' | 'rejected';
  submission_count: number;
  languages: string[];
  avg_sentiment: number | null;
  first_submitted_at: string;
  last_submitted_at: string;
  resolved_at: string | null;
  resolution_note: string | null;
  created_at: string;
  updated_at: string;
}

const KANBAN_COLUMNS = [
  { id: 'new', title: 'New', color: 'bg-blue-500' },
  { id: 'reviewing', title: 'Reviewing', color: 'bg-yellow-500' },
  { id: 'in_progress', title: 'In Progress', color: 'bg-purple-500' },
  { id: 'done', title: 'Done', color: 'bg-green-500' },
  { id: 'rejected', title: 'Rejected', color: 'bg-red-500' },
] as const;
```

**KanbanBoard.tsx** ('use client'):

- Fetches tasks from GET /api/feedback/tasks on mount (useEffect)
- Shows loading spinner while fetching
- Groups tasks by status into columns
- Uses DndContext from @dnd-kit/core with sensors: PointerSensor (activationConstraint: { distance: 8 }) and KeyboardSensor
- Uses closestCorners collision detection (NOT closestCenter)
- onDragStart: set activeTask state for DragOverlay
- onDragEnd: if over exists and over.id !== active task's current status, apply optimistic update (move task in local state immediately), then PATCH /api/feedback/tasks. On failure, revert to snapshot and show error via console.error (or toast if sonner is available). Clear activeTask.
- onDragCancel: clear activeTask
- DragOverlay renders a clone of the active TaskCard (with dropAnimation={null} for snappy feel)
- Renders 5 KanbanColumn components in a horizontally scrolling flex container
- Accepts onTaskClick callback prop for opening detail panel (will be wired in Plan 16-02)
- For Done/Rejected moves: show a browser confirm() dialog before proceeding ("This will notify merchants. Continue?"). If cancelled, do not proceed with the move. In Plan 16-02 this will be upgraded to a proper Radix dialog.

**KanbanColumn.tsx:**

- Props: id (status string), title, color (for dot indicator), tasks (FeedbackTask[]), onTaskClick callback
- Uses useDroppable({ id }) from @dnd-kit/core
- Shows isOver visual feedback (ring-2 ring-blue-400 bg-blue-50 when dragging over)
- Header with colored dot, title, and task count badge
- Renders TaskCard for each task in the column
- Shows empty state ("No tasks") when column is empty

**TaskCard.tsx:**

- Props: task (FeedbackTask), onClick callback
- Uses useDraggable({ id: task.id, data: { task }, disabled: task.status === 'done' || task.status === 'rejected' })
- Style with CSS.Translate.toString(transform) (NOT CSS.Transform -- no scaling)
- Shows isDragging state (opacity-50)
- Card content:
  - Title (truncated, font-medium)
  - Priority badge: P1=red, P2=orange, P3=yellow, P4=blue, P5=gray (small rounded badge with border)
  - Sentiment indicator: colored dot (green >= 0.7, yellow >= 0.4, red < 0.4, hidden if null)
  - Submission count (e.g., "3 submissions")
  - Languages as comma-separated codes (e.g., "it, th, en")
  - Type badge (bug/feature_request/improvement etc, subtle gray)
- Use Phosphor Icons for visual elements: ChatCircle for submission count, Globe for languages
- Card styling: rounded-lg border bg-white p-3 shadow-sm hover:shadow-md cursor-grab (cursor-default if disabled)
- onClick fires the callback (for detail panel in 16-02)

**page.tsx** (platform/feedback-tasks/page.tsx):

- Server component shell with page title "Feedback Tasks" and breadcrumb-style header
- Renders KanbanBoard as a client component
- Full-width layout (no max-width container -- board needs horizontal space)
  </action>
  <verify>
  TypeScript compilation passes. The page loads at /platform/feedback-tasks (verify by checking file exists at correct path). Verify @dnd-kit imports resolve correctly (package already installed).
  </verify>
  <done>
  Admin kanban page exists at /platform/feedback-tasks showing five columns populated with tasks from fb_tasks. Cards display priority badge, sentiment dot, submission count, languages, and type. Cards are draggable between columns with optimistic status updates. Done/Rejected moves show a confirmation before proceeding. DragOverlay provides visual feedback during drag.
  </done>
  </task>

</tasks>

<verification>
1. TypeScript: `cd apps/backoffice && npx tsc --noEmit` passes with no errors on new files
2. API: All three route files export correct HTTP methods and use supabaseAdmin
3. Board: KanbanBoard uses useDroppable (not useSortable) per column, useDraggable per card
4. DnD: closestCorners collision detection, DragOverlay with activeTask, PointerSensor with distance constraint
5. Optimistic: Status changes update local state before API call, revert on failure
6. Notifications: PATCH handler calls notifyTaskStatusChange for in_progress/done/rejected (fire-and-forget)
7. Disabled drag: Done/Rejected cards have useDraggable disabled
</verification>

<success_criteria>

- Admin navigates to /platform/feedback-tasks and sees 5 columns with tasks from fb_tasks
- Dragging a card to another column updates status optimistically and persists via PATCH API
- Task cards show priority badge, sentiment indicator, submission count, language codes, and type
- Moving to Done/Rejected shows confirmation prompt before proceeding
- notifyTaskStatusChange fires server-side on status changes to in_progress/done/rejected
- Done/Rejected cards are not draggable
  </success_criteria>

<output>
After completion, create `.planning/phases/16-admin-kanban/16-01-SUMMARY.md`
</output>
