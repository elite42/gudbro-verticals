/**
 * Color Generator Utility
 *
 * Generates a complete color palette from a single brand color using HSL manipulation.
 * Zero dependencies - uses pure HSL math for color transformations.
 *
 * @see https://uicolors.app/generate for visual reference
 * @see https://web.dev/patterns/theming/color-schemes for patterns
 */

/**
 * Color palette with shades from 50 (lightest) to 950 (darkest)
 */
export interface ColorPalette {
  50: string;
  100: string;
  200: string;
  300: string;
  400: string;
  500: string; // Base color
  600: string;
  700: string;
  800: string;
  900: string;
  950: string;
}

/**
 * HSL color representation
 */
interface HSL {
  h: number; // 0-360
  s: number; // 0-100
  l: number; // 0-100
}

/**
 * Convert hex color to HSL
 */
export function hexToHSL(hex: string): HSL {
  // Remove # if present
  hex = hex.replace(/^#/, '');

  // Parse hex values
  const r = parseInt(hex.slice(0, 2), 16) / 255;
  const g = parseInt(hex.slice(2, 4), 16) / 255;
  const b = parseInt(hex.slice(4, 6), 16) / 255;

  const max = Math.max(r, g, b);
  const min = Math.min(r, g, b);
  let h = 0;
  let s = 0;
  const l = (max + min) / 2;

  if (max !== min) {
    const d = max - min;
    s = l > 0.5 ? d / (2 - max - min) : d / (max + min);

    switch (max) {
      case r:
        h = ((g - b) / d + (g < b ? 6 : 0)) / 6;
        break;
      case g:
        h = ((b - r) / d + 2) / 6;
        break;
      case b:
        h = ((r - g) / d + 4) / 6;
        break;
    }
  }

  return {
    h: Math.round(h * 360),
    s: Math.round(s * 100),
    l: Math.round(l * 100),
  };
}

/**
 * Convert HSL to hex color
 */
export function hslToHex(h: number, s: number, l: number): string {
  s /= 100;
  l /= 100;

  const c = (1 - Math.abs(2 * l - 1)) * s;
  const x = c * (1 - Math.abs(((h / 60) % 2) - 1));
  const m = l - c / 2;
  let r = 0,
    g = 0,
    b = 0;

  if (0 <= h && h < 60) {
    r = c;
    g = x;
    b = 0;
  } else if (60 <= h && h < 120) {
    r = x;
    g = c;
    b = 0;
  } else if (120 <= h && h < 180) {
    r = 0;
    g = c;
    b = x;
  } else if (180 <= h && h < 240) {
    r = 0;
    g = x;
    b = c;
  } else if (240 <= h && h < 300) {
    r = x;
    g = 0;
    b = c;
  } else if (300 <= h && h < 360) {
    r = c;
    g = 0;
    b = x;
  }

  r = Math.round((r + m) * 255);
  g = Math.round((g + m) * 255);
  b = Math.round((b + m) * 255);

  return `#${r.toString(16).padStart(2, '0')}${g.toString(16).padStart(2, '0')}${b.toString(16).padStart(2, '0')}`.toUpperCase();
}

/**
 * Adjust HSL lightness while preserving hue and saturation
 */
function adjustLightness(hsl: HSL, targetLightness: number): string {
  // Adjust saturation slightly for very light/dark shades to maintain vibrancy
  let adjustedSaturation = hsl.s;

  if (targetLightness > 90) {
    // Very light shades - reduce saturation slightly
    adjustedSaturation = Math.max(hsl.s * 0.3, 10);
  } else if (targetLightness > 80) {
    adjustedSaturation = Math.max(hsl.s * 0.5, 15);
  } else if (targetLightness < 20) {
    // Very dark shades - reduce saturation slightly
    adjustedSaturation = Math.max(hsl.s * 0.7, 20);
  }

  return hslToHex(hsl.h, adjustedSaturation, targetLightness);
}

/**
 * Generate a complete color palette from a single brand color
 *
 * The input color becomes the 500 (base) shade.
 * Lighter shades (50-400) are generated by increasing lightness.
 * Darker shades (600-950) are generated by decreasing lightness.
 *
 * @param brandColor - Hex color string (e.g., "#DC2626")
 * @returns Complete color palette with all shades
 *
 * @example
 * const palette = generatePalette("#DC2626");
 * // palette.500 = "#DC2626" (original)
 * // palette.50 = "#FEF2F2" (lightest)
 * // palette.900 = "#7F1D1D" (darkest)
 */
export function generatePalette(brandColor: string): ColorPalette {
  const hsl = hexToHSL(brandColor);

  // Lightness values for each shade
  // These are tuned to match Tailwind's color system
  const lightnessMap = {
    50: 97,
    100: 94,
    200: 86,
    300: 73,
    400: 60,
    500: hsl.l, // Keep original lightness
    600: 40,
    700: 32,
    800: 24,
    900: 17,
    950: 10,
  } as const;

  const shades: (keyof ColorPalette)[] = [50, 100, 200, 300, 400, 500, 600, 700, 800, 900, 950];

  const palette = {} as ColorPalette;

  shades.forEach((shade) => {
    if (shade === 500) {
      // Use original color for 500
      palette[shade] = brandColor.toUpperCase();
    } else {
      palette[shade] = adjustLightness(hsl, lightnessMap[shade]);
    }
  });

  return palette;
}

/**
 * Generate CSS variables from a color palette
 *
 * @param palette - Color palette
 * @param prefix - CSS variable prefix (default: "--color-brand")
 * @returns Object of CSS variable names to values
 *
 * @example
 * const vars = paletteToCSSVariables(palette);
 * // { "--color-brand-50": "#FEF2F2", ... }
 */
export function paletteToCSSVariables(
  palette: ColorPalette,
  prefix: string = '--color-brand'
): Record<string, string> {
  const variables: Record<string, string> = {};

  const shades: (keyof ColorPalette)[] = [50, 100, 200, 300, 400, 500, 600, 700, 800, 900, 950];

  shades.forEach((shade) => {
    variables[`${prefix}-${shade}`] = palette[shade];
  });

  // Also add semantic aliases for common uses
  variables[`${prefix}-primary`] = palette[500];
  variables[`${prefix}-primary-hover`] = palette[600];
  variables[`${prefix}-secondary`] = palette[100];
  variables[`${prefix}-accent`] = palette[400];

  return variables;
}

/**
 * Apply brand colors to the document root
 *
 * @param brandColor - Hex color string
 */
export function applyBrandColors(brandColor: string): void {
  if (typeof document === 'undefined') return;

  const palette = generatePalette(brandColor);
  const cssVariables = paletteToCSSVariables(palette);

  const root = document.documentElement;

  Object.entries(cssVariables).forEach(([name, value]) => {
    root.style.setProperty(name, value);
  });
}

/**
 * Check if a color is light or dark
 * Useful for determining text color on colored backgrounds
 *
 * @param hex - Hex color string
 * @returns true if color is light (should use dark text)
 */
export function isLightColor(hex: string): boolean {
  const hsl = hexToHSL(hex);
  return hsl.l > 55;
}

/**
 * Get appropriate text color for a background
 *
 * @param backgroundColor - Hex color string
 * @returns "#FFFFFF" or "#000000"
 */
export function getContrastTextColor(backgroundColor: string): string {
  return isLightColor(backgroundColor) ? '#000000' : '#FFFFFF';
}
