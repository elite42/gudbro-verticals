---
phase: 37-conventions-vouchers
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/accommodations/frontend/app/api/stay/[code]/conventions/route.ts
  - apps/accommodations/frontend/components/stay/ConventionPartnerCards.tsx
  - apps/accommodations/frontend/app/stay/[code]/page.tsx
  - apps/accommodations/frontend/lib/stay-api.ts
  - apps/accommodations/frontend/types/stay.ts
  - apps/backoffice/app/(dashboard)/settings/conventions/page.tsx
autonomous: true

must_haves:
  truths:
    - 'Guest sees convention partner cards in the in-stay dashboard showing partner name, benefit description, and discount badge'
    - 'Convention cards are separate from LocalDeals and show data from partner_conventions table'
    - 'Convention cards only appear when active conventions exist for the property'
    - 'Accommodation owner can view active conventions linked to their property in backoffice settings'
  artifacts:
    - path: 'apps/accommodations/frontend/app/api/stay/[code]/conventions/route.ts'
      provides: 'GET endpoint returning active conventions for property'
      exports: ['GET']
    - path: 'apps/accommodations/frontend/components/stay/ConventionPartnerCards.tsx'
      provides: 'Convention partner card list component for guest dashboard'
      min_lines: 60
    - path: 'apps/backoffice/app/(dashboard)/settings/conventions/page.tsx'
      provides: 'Read-only conventions view for accommodation owners'
      min_lines: 40
  key_links:
    - from: 'apps/accommodations/frontend/components/stay/ConventionPartnerCards.tsx'
      to: '/api/stay/[code]/conventions'
      via: 'fetchConventions in stay-api.ts'
      pattern: 'conventions'
    - from: 'apps/accommodations/frontend/app/stay/[code]/page.tsx'
      to: 'ConventionPartnerCards'
      via: 'import and render in home tab'
      pattern: 'ConventionPartnerCards'
---

<objective>
Display convention partner cards in the guest in-stay dashboard and add a read-only conventions view in the accommodation owner backoffice.

Purpose: Guests see restaurant/partner convention offers during their stay (GXP-05), and accommodation owners can monitor which conventions are active for their property.
Output: Conventions API endpoint, ConventionPartnerCards component, backoffice settings page.
</objective>

<execution_context>
@/Users/gianfrancodagostino/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gianfrancodagostino/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/37-conventions-vouchers/37-RESEARCH.md

Key source files:
@apps/accommodations/frontend/app/stay/[code]/page.tsx
@apps/accommodations/frontend/components/stay/LocalDeals.tsx
@apps/accommodations/frontend/lib/stay-api.ts
@apps/accommodations/frontend/types/stay.ts
@shared/database/migrations/schema/050-b2b-conventions.sql
@apps/backoffice/app/(dashboard)/partnerships/conventions/active/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Convention cards API + component in guest dashboard</name>
  <files>
    apps/accommodations/frontend/types/stay.ts
    apps/accommodations/frontend/lib/stay-api.ts
    apps/accommodations/frontend/app/api/stay/[code]/conventions/route.ts
    apps/accommodations/frontend/components/stay/ConventionPartnerCards.tsx
    apps/accommodations/frontend/app/stay/[code]/page.tsx
  </files>
  <action>
**Types (stay.ts):**
- Add ConventionPartner interface:
  ```ts
  export interface ConventionPartner {
    id: string;
    partnerName: string;
    conventionName: string;
    benefitType: string;
    benefitValue: number;
    benefitScope: string;
    benefitDescription: string | null;
  }
  ```

**stay-api.ts:**

- Add fetchConventions function following the existing fetchDeals pattern:

  ```ts
  export function fetchConventions(
    bookingCode: string,
    token: string
  ): Promise<FetchResult<ConventionPartner[]>>;
  ```

  - GET /api/stay/{bookingCode}/conventions with Bearer token

**API route (stay/[code]/conventions/route.ts):**

- GET endpoint, authenticate with authenticateGuest(request)
- Use getSupabaseAdmin() to query partner_conventions:
  ```sql
  SELECT id, partner_name, convention_name, benefit_type, benefit_value, benefit_scope, benefit_description
  FROM partner_conventions
  WHERE partner_type = 'accommodation'
    AND partner_id = guest.propertyId
    AND is_active = true
    AND valid_from <= CURRENT_DATE
    AND (valid_until IS NULL OR valid_until >= CURRENT_DATE)
  ORDER BY created_at
  ```
- Map snake_case DB columns to camelCase response
- Return { data: ConventionPartner[] }
- Follow exact pattern from apps/accommodations/frontend/app/api/stay/[code]/deals/route.ts

**ConventionPartnerCards component:**

- Props: `{ bookingCode: string, token: string }`
- Fetch conventions on mount using fetchConventions (same pattern as LocalDeals)
- If loading: show skeleton (2 cards with animate-pulse, same as LocalDeals loading)
- If error or empty: return null (no section shown)
- Card design (follow LocalDeals card style with Phosphor enhancements):
  - Section header: Storefront icon (Phosphor, duotone) + "Partner Deals" heading
  - Each card: rounded-2xl border-[#E8E2D9] bg-white p-4 shadow-sm
  - Left side: partner_name (font-medium), convention_name (text-sm text-[#8B7355])
  - Right side: benefit badge showing discount value
    - percentage_discount: "-{value}%" in rounded-full pill (bg-[#E07A5F]/10 text-[#E07A5F])
    - fixed_discount: formatted amount with currency
    - free_item: "Free Item" label
    - special_price: formatted special price
  - Below: benefit_description if present (text-sm text-[#8B7355])
  - If benefit_scope is per_night, show "(per night)" suffix on the badge

**Wire into stay page (page.tsx):**

- Import ConventionPartnerCards component
- Add it in the home tab content, ABOVE the LocalDeals section (between ActiveOrders/OrderListView and LocalDeals)
- Wrap in same card container: `<div className="rounded-2xl border border-[#E8E2D9] bg-white p-4 shadow-sm">`
- Pass bookingCode={params.code} token={token!}
  </action>
  <verify>
  Run `cd /Users/gianfrancodagostino/Desktop/gudbro-verticals && npx tsc --noEmit -p apps/accommodations/frontend/tsconfig.json` to verify TypeScript compilation. Check that ConventionPartnerCards is imported and rendered in page.tsx.
  </verify>
  <done>
  Convention partner cards appear in guest dashboard above LocalDeals when active conventions exist for the property. Cards show partner name, discount badge, and benefit description. Section hidden when no conventions exist.
  </done>
  </task>

<task type="auto">
  <name>Task 2: Backoffice read-only conventions view for accommodation owners</name>
  <files>
    apps/backoffice/app/(dashboard)/settings/conventions/page.tsx
  </files>
  <action>
Create a read-only backoffice page at /settings/conventions showing active conventions linked to the accommodation owner's property.

**Page structure:**

- Page title: "Convention Partnerships" with Handshake icon (Phosphor, duotone)
- Description: "Active conventions from partner merchants offering deals to your guests"
- Query partner_conventions WHERE partner_type = 'accommodation' AND partner_id IN (select id from accom_properties where owner_id = user.id) AND is_active = true
- Use getSupabaseAdmin() with user.id from AuthContext (following pattern from CON-04 decision: user.id as merchantId)

**Table/Card display:**

- Use a simple card list (not TanStack Table -- read-only, typically few items)
- Each card shows:
  - Convention name (bold)
  - Partner name (the merchant offering the deal)
  - Benefit: type + value + scope (e.g., "10% discount per night" or "$5 off per stay")
  - Valid dates: from - until (or "No expiry")
  - Status badge: green "Active" pill
  - Total redemptions count
- Empty state: "No active conventions. Partner merchants can create conventions linked to your property."

**NOTE:** This is a READ-ONLY view. Accommodation owners cannot create/edit/delete conventions. That CRUD functionality is on the merchant (restaurant) side at /partnerships/conventions. This page just shows which conventions are active for the owner's properties.

Follow the existing backoffice page pattern:

- 'use client' directive
- useAuth() hook for user context
- Supabase client from @/lib/supabase
- Tailwind styling consistent with other settings pages
  </action>
  <verify>
  Run `cd /Users/gianfrancodagostino/Desktop/gudbro-verticals && npx tsc --noEmit -p apps/backoffice/tsconfig.json` to verify TypeScript compilation.
  </verify>
  <done>
  Accommodation owners can view active convention partnerships in backoffice settings. Page shows convention name, partner merchant, benefit details, validity dates, and redemption count. No edit controls (read-only).
  </done>
  </task>

</tasks>

<verification>
1. TypeScript compiles without errors for both accommodations frontend and backoffice
2. GET /api/stay/[code]/conventions returns convention partners for authenticated guest
3. ConventionPartnerCards renders above LocalDeals in guest dashboard
4. Convention cards show partner name, discount badge, benefit description
5. Empty conventions result in hidden section (not error)
6. Backoffice /settings/conventions shows read-only list of active conventions
</verification>

<success_criteria>

- Guest sees convention partner cards in in-stay dashboard with visual discount badges (GXP-05)
- Convention cards are separate section from LocalDeals
- Cards only show for active, date-valid conventions linked to the property
- Accommodation owner has read-only conventions view in backoffice settings
  </success_criteria>

<output>
After completion, create `.planning/phases/37-conventions-vouchers/37-02-SUMMARY.md`
</output>
