---
phase: 23-service-ordering
plan: 02
type: execute
wave: 2
depends_on: ['23-01']
files_modified:
  - apps/backoffice/app/(dashboard)/accommodations/services/page.tsx
  - apps/backoffice/app/api/accommodations/services/route.ts
  - apps/backoffice/components/accommodations/ServiceCatalogManager.tsx
autonomous: true

must_haves:
  truths:
    - 'Owner can view list of service categories with their items'
    - 'Owner can create, edit, and delete service categories with name, icon, sort_order, is_active, automation_level'
    - 'Owner can create, edit, and delete service items with name, description, price, availability hours, in_stock'
    - 'Owner enters price in major currency units and it stores as minor units (x100)'
    - 'Automation level dropdown offers auto_confirm, manual, whatsapp_notify'
  artifacts:
    - path: 'apps/backoffice/app/(dashboard)/accommodations/services/page.tsx'
      provides: 'Service catalog management page'
      min_lines: 20
    - path: 'apps/backoffice/app/api/accommodations/services/route.ts'
      provides: 'CRUD API for categories and items'
      exports: ['GET', 'POST', 'PUT', 'DELETE']
    - path: 'apps/backoffice/components/accommodations/ServiceCatalogManager.tsx'
      provides: 'Two-panel CRUD component for categories and items'
      min_lines: 100
  key_links:
    - from: 'apps/backoffice/app/api/accommodations/services/route.ts'
      to: 'validateAdminApiKey'
      via: 'ADMIN_API_KEY auth'
      pattern: 'validateAdminApiKey'
    - from: 'apps/backoffice/components/accommodations/ServiceCatalogManager.tsx'
      to: '/api/accommodations/services'
      via: 'fetch CRUD operations'
      pattern: 'fetch.*api/accommodations/services'
---

<objective>
Build the owner-facing service catalog management page in backoffice where owners can CRUD service categories and items.

Purpose: Owners need to manage what services guests can order (categories, items, pricing, availability hours, automation level).
Output: Backoffice services page with two-panel CRUD layout following ChargesManager pattern.
</objective>

<execution_context>
@/Users/gianfrancodagostino/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gianfrancodagostino/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-service-ordering/23-RESEARCH.md
@.planning/phases/23-service-ordering/23-01-SUMMARY.md

@apps/backoffice/components/settings/ChargesManager.tsx
@apps/backoffice/app/api/settings/charges/route.ts
@apps/backoffice/app/api/accommodations/bookings/route.ts
@apps/backoffice/lib/supabase-admin.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Service catalog API route (CRUD categories + items)</name>
  <files>
    apps/backoffice/app/api/accommodations/services/route.ts
  </files>
  <action>
    Create CRUD API route following the ChargesManager/charges API pattern.

    **GET handler:**
    - Call `validateAdminApiKey(request)` for auth
    - Get `propertyId` from URL search params
    - Query `accom_service_categories` WHERE property_id = propertyId, ordered by display_order
    - For each category, nested select `accom_service_items` ordered by sort_order
    - Include automation_level in category response
    - Map snake_case to camelCase
    - Return `{ categories: [...] }`

    **POST handler:**
    - validateAdminApiKey
    - Parse body: `{ type: 'category' | 'item', ...data }`
    - For type='category': INSERT into accom_service_categories (property_id, name, slug from name, icon, display_order, is_active, automation_level)
      - Auto-generate slug from name using lowercase + hyphen pattern
      - Auto-compute display_order as max(display_order) + 1 for this property
    - For type='item': INSERT into accom_service_items (category_id, property_id, name, description, price, currency, is_always_available, available_from, available_until, in_stock, sort_order, image_url)
      - Price comes in as minor units (frontend handles conversion)
      - Auto-compute sort_order as max(sort_order) + 1 for this category
    - Return created record

    **PUT handler:**
    - validateAdminApiKey
    - Parse body: `{ type: 'category' | 'item', id: string, ...fields }`
    - Allowlisted fields for category: name, icon, display_order, is_active, automation_level
    - Allowlisted fields for item: name, description, price, is_always_available, available_from, available_until, in_stock, sort_order, image_url
    - Map camelCase input to snake_case DB columns
    - Verify ownership (property_id match) before update
    - Return updated record

    **DELETE handler:**
    - validateAdminApiKey
    - Parse body: `{ type: 'category' | 'item', id: string }`
    - Verify ownership before delete
    - For category: also cascade-delete items (or rely on FK CASCADE if configured, otherwise delete items first)
    - Return `{ success: true }`

    Use `getSupabaseAdmin()` for all queries. Follow the allowlisted fields pattern from existing PUT endpoints (prevent mass-assignment).

  </action>
  <verify>
    - TypeScript compiles: `cd apps/backoffice && npx tsc --noEmit --pretty 2>&1 | head -20`
    - File exists with all 4 HTTP methods
  </verify>
  <done>
    Full CRUD API for service categories and items, with admin auth, ownership verification, and allowlisted field updates.
  </done>
</task>

<task type="auto">
  <name>Task 2: ServiceCatalogManager component + services page</name>
  <files>
    apps/backoffice/components/accommodations/ServiceCatalogManager.tsx
    apps/backoffice/app/(dashboard)/accommodations/services/page.tsx
  </files>
  <action>
    1. Create ServiceCatalogManager.tsx following ChargesManager pattern closely:

       **Component structure:**
       - 'use client' component
       - Props: `{ propertyId: string }`
       - State: categories array, selectedCategoryId, isLoading, isSaving, error, saveSuccess
       - State for category editing: editingCategoryId, editCategoryForm, isAddingCategory, newCategoryForm
       - State for item editing: editingItemId, editItemForm, isAddingItem, newItemForm

       **Layout (two-panel):**
       - Left panel (w-1/3 on desktop, full width on mobile): Category list
         - Each category: name, icon, item count, is_active toggle, automation_level badge
         - Click to select (highlights, shows items in right panel)
         - Edit button -> inline edit form (name, icon text, automation_level dropdown, is_active toggle)
         - Delete button with confirmation
         - "Add Category" button at bottom (dashed border card)
       - Right panel (w-2/3): Items for selected category
         - Each item: name, description (truncated), formatted price, availability badge, in_stock toggle
         - Edit button -> inline edit form
         - Delete button with confirmation
         - "Add Item" button at bottom

       **Category form fields:**
       - Name (text input, required)
       - Icon (text input, e.g. "coffee", "towel" -- Phosphor icon name)
       - Automation Level (select dropdown: auto_confirm/manual/whatsapp_notify, labels: "Auto-confirm", "Manual", "WhatsApp + Auto")
       - Active toggle

       **Item form fields:**
       - Name (text input, required)
       - Description (textarea, optional)
       - Price (number input in MAJOR units -- display "$12.50", convert to 1250 for API). For zero-decimal currencies (VND, JPY, KRW), no conversion needed. Use property currency from categories response to determine.
       - Availability: checkbox "Always available". If unchecked, show from/until time pickers (HTML time inputs)
       - In Stock toggle
       - Image URL (text input, optional)

       **CRUD operations:**
       - Fetch categories on mount via GET /api/accommodations/services?propertyId=X
       - Create/update/delete via POST/PUT/DELETE to same endpoint
       - Optimistic UI updates with rollback on error
       - Success/error banners (same pattern as ChargesManager)
       - Pass AUTH_HEADERS with Bearer ADMIN_API_KEY (use existing pattern from other backoffice components)

       **Price display/input:**
       - Show prices in major units in the form (divide by 100 for display, multiply by 100 for save)
       - Handle zero-decimal currencies: check if currency is in ZERO_DECIMAL set (VND, JPY, KRW, etc.) -- if so, no conversion
       - Define ZERO_DECIMAL_CURRENCIES = new Set(['VND', 'JPY', 'KRW', 'BIF', 'CLP', 'DJF', 'GNF', 'ISK', 'KMF', 'MGA', 'PYG', 'RWF', 'UGX', 'VUV', 'XAF', 'XOF', 'XPF'])

    2. Create services page:
       ```tsx
       // apps/backoffice/app/(dashboard)/accommodations/services/page.tsx
       import ServiceCatalogManager from '@/components/accommodations/ServiceCatalogManager';

       export default function ServicesPage() {
         // Get propertyId from searchParams or context (follow pattern from other accommodations pages)
         return (
           <div className="p-6">
             <h1 className="text-2xl font-semibold mb-6">Service Catalog</h1>
             <ServiceCatalogManager propertyId={propertyId} />
           </div>
         );
       }
       ```
       Follow the pattern from other accommodations pages (bookings, calendar) for getting propertyId. Check how existing pages like rooms/page.tsx or settings/page.tsx handle it.

  </action>
  <verify>
    - TypeScript compiles: `cd apps/backoffice && npx tsc --noEmit --pretty 2>&1 | head -20`
    - Build passes: `cd apps/backoffice && npx next build 2>&1 | tail -20`
  </verify>
  <done>
    Owner can view, create, edit, delete service categories and items. Two-panel layout with inline editing. Price input in major units stored as minor. Automation level configurable per category.
  </done>
</task>

</tasks>

<verification>
- Services page renders at /accommodations/services
- Categories load and display in left panel
- Items display in right panel when category selected
- CRUD operations work for both categories and items
- Price conversion: entering "12.50" stores as 1250 (for non-zero-decimal currencies)
- Automation level dropdown works with 3 options
- Build passes cleanly
</verification>

<success_criteria>

1. Owner can view all service categories with item counts
2. Owner can create category with name, icon, automation level
3. Owner can create item with name, price, availability hours
4. Owner can edit and delete both categories and items
5. Price conversion works correctly (major <-> minor units)
6. Automation level dropdown offers all 3 options
7. TypeScript compiles and build passes
   </success_criteria>

<output>
After completion, create `.planning/phases/23-service-ordering/23-02-SUMMARY.md`
</output>
