---
phase: 31-bug-fixes-image-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/accommodations/frontend/app/api/stay/verify/route.ts
  - apps/accommodations/frontend/app/api/stay/room/[roomCode]/verify/route.ts
  - apps/accommodations/frontend/app/stay/[code]/page.tsx
  - apps/accommodations/frontend/components/BottomNav.tsx
  - apps/accommodations/frontend/components/stay/DashboardHeader.tsx
  - apps/accommodations/frontend/components/stay/WifiCard.tsx
  - apps/accommodations/frontend/components/stay/ServiceItemCard.tsx
  - apps/accommodations/frontend/components/stay/ServicesCarousel.tsx
  - apps/accommodations/frontend/components/stay/ServiceCatalog.tsx
  - shared/utils/qr/index.ts
  - shared/utils/qr/wifi.ts
autonomous: true

must_haves:
  truths:
    - "Guest name displays as 'John Smith' not 'John Smith Smith' in dashboard header"
    - 'Bottom nav tabs show different content for Home, Map, Menu, Services, Profile'
    - 'Homepage sections are wrapped in visual cards with rounded corners and shadows'
    - "Service category names display as 'Breakfast' not 'CookingPot Breakfast'"
    - "Service time ranges display as '7:00 - 10:30 AM' not '07:00:00 - 10:30:00'"
    - 'Currency selector dropdown is visible in DashboardHeader and persists selection'
    - 'WiFi card shows a scannable QR code alongside the copy-password button'
  artifacts:
    - path: 'shared/utils/qr/wifi.ts'
      provides: 'generateWiFiString, escapeWiFiValue, WiFiConfig type'
      exports: ['generateWiFiString', 'escapeWiFiValue', 'WiFiConfig']
    - path: 'shared/utils/qr/index.ts'
      provides: 'Barrel export for shared QR utils'
      exports: ['generateWiFiString', 'WiFiConfig']
    - path: 'apps/accommodations/frontend/components/stay/DashboardHeader.tsx'
      provides: 'Currency selector dropdown using @shared/payment'
      contains: 'SUPPORTED_CURRENCIES'
    - path: 'apps/accommodations/frontend/components/stay/WifiCard.tsx'
      provides: 'QR code display for WiFi networks'
      contains: 'QRCode.toDataURL'
  key_links:
    - from: 'apps/accommodations/frontend/components/stay/WifiCard.tsx'
      to: 'shared/utils/qr/wifi.ts'
      via: 'import generateWiFiString'
      pattern: 'import.*generateWiFiString.*shared'
    - from: 'apps/accommodations/frontend/components/stay/DashboardHeader.tsx'
      to: 'shared/payment'
      via: 'import SUPPORTED_CURRENCIES'
      pattern: 'import.*SUPPORTED_CURRENCIES.*shared/payment'
---

<objective>
Fix 8 PWA bugs (BUG-01 through BUG-08) in the accommodations guest dashboard and extract QR WiFi string generation to shared utils (INF-02).

Purpose: The guest PWA has 8 identified bugs from manual testing that degrade the user experience. Fixing them makes the in-stay dashboard functional and visually polished.
Output: Working guest dashboard with correct name display, functional bottom nav, card-based layout, proper time formatting, currency selector, and WiFi QR codes.
</objective>

<execution_context>
@/Users/gianfrancodagostino/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gianfrancodagostino/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/31-bug-fixes-image-foundation/31-RESEARCH.md

Key source files to read before implementing:
@apps/accommodations/frontend/app/api/stay/verify/route.ts
@apps/accommodations/frontend/app/api/stay/room/[roomCode]/verify/route.ts
@apps/accommodations/frontend/app/stay/[code]/page.tsx
@apps/accommodations/frontend/components/BottomNav.tsx
@apps/accommodations/frontend/components/stay/DashboardHeader.tsx
@apps/accommodations/frontend/components/stay/WifiCard.tsx
@apps/accommodations/frontend/components/stay/ServiceItemCard.tsx
@apps/accommodations/frontend/components/stay/ServicesCarousel.tsx
@apps/accommodations/frontend/components/stay/ServiceCatalog.tsx
@apps/backoffice/lib/qr/qr-types.ts
@shared/payment/index.ts
@shared/payment/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix guest name, bottom nav, homepage cards, icon prefix, and time format (BUG-01 through BUG-05)</name>
  <files>
    apps/accommodations/frontend/app/api/stay/verify/route.ts
    apps/accommodations/frontend/app/api/stay/room/[roomCode]/verify/route.ts
    apps/accommodations/frontend/app/stay/[code]/page.tsx
    apps/accommodations/frontend/components/BottomNav.tsx
    apps/accommodations/frontend/components/stay/ServiceItemCard.tsx
    apps/accommodations/frontend/components/stay/ServicesCarousel.tsx
    apps/accommodations/frontend/components/stay/ServiceCatalog.tsx
  </files>
  <action>
    **BUG-01: Guest Name Duplication** - In both verify routes, fix the guestName construction. The `guest_name` column may already contain the full name. Use defensive logic:
    ```typescript
    const fullName = bookingData.guest_last_name && !bookingData.guest_name.includes(bookingData.guest_last_name)
      ? `${bookingData.guest_name} ${bookingData.guest_last_name}`
      : bookingData.guest_name;
    ```
    Apply to BOTH: `app/api/stay/verify/route.ts` (around line 136) AND `app/api/stay/room/[roomCode]/verify/route.ts` (around line 237).

    **BUG-02: Bottom Nav Tabs** - In `BottomNav.tsx`, replace all inline SVG icons with Phosphor icons: House (home), MapPin (map), SquaresFour (menu/services), UserCircle (profile). In `app/stay/[code]/page.tsx` (InStayDashboard), add conditional rendering based on `activeTab` state:
    - `home`: current dashboard content
    - `map`: placeholder card "Map coming soon - explore local area"
    - `menu`: trigger onMenuToggle (existing)
    - `services`: show ServiceCatalog (existing)
    - `profile`: placeholder card "Guest Profile coming soon"
    Keep tab state in React useState (fine for SPA dashboard). Ensure tab state persists through catalog/cart overlay open/close.

    **BUG-03: Homepage Cards** - In the InStayDashboard home tab content, wrap each major section (WifiCard, WelcomeCard, QuickActions, RestaurantSection, ServicesCarousel, etc.) in a card container div:
    ```tsx
    <div className="rounded-2xl border border-[#E8E2D9] bg-white p-4 shadow-sm">
      <SectionComponent />
    </div>
    ```
    Use a `flex flex-col gap-4` parent container. Follow the pattern already used for the documents section.

    **BUG-04: Icon Name Prefix** - Check the seed data in `shared/database/migrations/schema/078-accommodations-seed.sql` to see how category icons are stored. In `ServiceCatalog.tsx` and `ServicesCarousel.tsx`, create an `iconNameToEmoji` mapping for common Phosphor names:
    ```typescript
    const iconNameToEmoji: Record<string, string> = {
      'CookingPot': 'üç≥', 'Broom': 'üßπ', 'ShoppingCart': 'üõí',
      'Bed': 'üõèÔ∏è', 'Coffee': '‚òï', 'Swim': 'üèä', 'Car': 'üöó',
      'Shirt': 'üëî', 'WashingMachine': 'üß∫', 'Wine': 'üç∑',
    };
    ```
    In `getCategoryIcon()`, check if the icon string matches a key in this mapping and return the emoji. If it's already an emoji (length <= 2 or includes non-ASCII), return as-is. Ensure category names render WITHOUT the icon name prefix -- verify the `name` field is clean or strip any icon prefix.

    **BUG-05: Time Format** - In `ServiceItemCard.tsx`, add a `formatServiceTime()` helper:
    ```typescript
    function formatServiceTime(time: string): string {
      const [hours, minutes] = time.split(':').map(Number);
      const period = hours >= 12 ? 'PM' : 'AM';
      const displayHours = hours === 0 ? 12 : hours > 12 ? hours - 12 : hours;
      return `${displayHours}:${minutes.toString().padStart(2, '0')} ${period}`;
    }
    function formatTimeRange(from: string, until: string): string {
      const fromFormatted = formatServiceTime(from);
      const untilFormatted = formatServiceTime(until);
      const [fromTime, fromPeriod] = fromFormatted.split(' ');
      const [untilTime, untilPeriod] = untilFormatted.split(' ');
      if (fromPeriod === untilPeriod) return `${fromTime} - ${untilFormatted}`;
      return `${fromFormatted} - ${untilFormatted}`;
    }
    ```
    Replace any raw time rendering (around line 96) with `formatTimeRange(item.availableFrom, item.availableUntil)`.

  </action>
  <verify>
    Run `cd /Users/gianfrancodagostino/Desktop/gudbro-verticals && npx tsc --noEmit -p apps/accommodations/frontend/tsconfig.json` to verify no TypeScript errors. Visually inspect the code changes for correctness.
  </verify>
  <done>
    - Guest name construction is defensive (no duplication) in both verify routes
    - BottomNav uses Phosphor icons and all 5 tabs render distinct content
    - Homepage sections wrapped in card containers with consistent styling
    - Category icon names mapped to emoji (not rendered as text prefix)
    - Time ranges formatted as "7:00 - 10:30 AM"
  </done>
</task>

<task type="auto">
  <name>Task 2: Currency selector, WiFi QR code, and QR extraction (BUG-07, BUG-08, INF-02)</name>
  <files>
    shared/utils/qr/wifi.ts
    shared/utils/qr/index.ts
    apps/accommodations/frontend/components/stay/DashboardHeader.tsx
    apps/accommodations/frontend/components/stay/WifiCard.tsx
    apps/accommodations/frontend/components/stay/ServiceItemCard.tsx
  </files>
  <action>
    **INF-02: QR Extraction** - Create `shared/utils/qr/wifi.ts` with:
    - `WiFiConfig` type: `{ ssid: string; password: string; security?: 'WPA' | 'WEP' | 'nopass'; hidden?: boolean }`
    - `escapeWiFiValue(value: string): string` -- escapes backslash, semicolon, colon, comma
    - `generateWiFiString(config: WiFiConfig): string` -- produces `WIFI:T:WPA;S:ssid;P:password;H:false;;` format
    Create `shared/utils/qr/index.ts` as barrel export. These functions are extracted from `apps/backoffice/lib/qr/qr-types.ts` -- copy the exact logic, do NOT modify the backoffice file (it still uses its local copy; consolidation deferred per AUDIT-01).

    **BUG-07: Currency Selector** - In `DashboardHeader.tsx`:
    - Import `SUPPORTED_CURRENCIES` from `@shared/payment` (or from `shared/payment` with relative path -- check how other accom files import shared modules)
    - Replace the language placeholder button with a currency selector dropdown
    - Add a `useCurrencyPreference` hook (can be inline or a separate file): reads from `localStorage.getItem('preferred-currency')`, falls back to property currency (from booking data), persists with `localStorage.setItem()`
    - Render a small `<select>` or custom dropdown showing currency codes (USD, VND, EUR, etc.)
    - The selected currency should be passed via React context or props to price-displaying components. For now, export the selected currency from DashboardHeader and use it in ServiceItemCard. Keep it simple -- a prop drill or a small CurrencyContext is fine.
    - Per AUDIT-03: Use `@shared/payment` directly.

    **BUG-08: WiFi QR Code** - In `WifiCard.tsx`:
    - Import `generateWiFiString` from `shared/utils/qr/wifi` (use appropriate path)
    - Import `QRCode` from `qrcode` (already in accommodations package.json)
    - For each WiFi zone/network displayed, generate a QR data URL via `QRCode.toDataURL(wifiString, { width: 256, margin: 2, errorCorrectionLevel: 'M' })`
    - Store in state via useEffect. Render as `<img src={qrDataUrl} alt="WiFi QR Code" className="h-32 w-32 rounded-xl" />`
    - Position QR code below or beside the copy-password button in each WiFi zone card

    **BUG-06: Improved Placeholder** - In `ServiceItemCard.tsx`, improve the grey placeholder fallback when no image exists. Instead of a plain grey box with Package icon, use a subtle gradient or the category emoji as a larger centered icon. This is a cosmetic improvement; the real fix (image upload) comes in plan 31-02.

  </action>
  <verify>
    Run `cd /Users/gianfrancodagostino/Desktop/gudbro-verticals && npx tsc --noEmit -p apps/accommodations/frontend/tsconfig.json` to verify no TypeScript errors. Verify `shared/utils/qr/wifi.ts` exports correctly. Check that WifiCard imports from shared (not backoffice).
  </verify>
  <done>
    - `shared/utils/qr/wifi.ts` exports generateWiFiString and WiFiConfig
    - DashboardHeader has a working currency selector using SUPPORTED_CURRENCIES from @shared/payment
    - Currency preference persists in localStorage
    - WifiCard renders QR codes for each WiFi zone using qrcode library
    - Service item placeholder improved with category-aware fallback
  </done>
</task>

</tasks>

<verification>
- TypeScript compilation passes: `npx tsc --noEmit -p apps/accommodations/frontend/tsconfig.json`
- Build succeeds: `cd apps/accommodations/frontend && npx next build` (or project-level build command)
- No import errors from shared/utils/qr/ in accommodations frontend
- No import errors from @shared/payment in accommodations frontend
</verification>

<success_criteria>

1. Guest name never duplicates (defensive construction in both verify routes)
2. All 5 bottom nav tabs render distinct content with Phosphor icons
3. Homepage uses card-based layout with rounded containers
4. Category names are clean (no icon name prefix)
5. Time ranges formatted as "7:00 - 10:30 AM"
6. Currency selector in header with localStorage persistence
7. WiFi QR codes render in WifiCard for each zone
8. shared/utils/qr/ module exists with WiFi string generation
   </success_criteria>

<output>
After completion, create `.planning/phases/31-bug-fixes-image-foundation/31-01-SUMMARY.md`
</output>
