---
phase: 27-owner-security-configuration
plan: 02
type: execute
wave: 2
depends_on: [27-01]
files_modified:
  - apps/accommodations/frontend/app/api/stay/room/[roomCode]/route.ts
  - apps/accommodations/frontend/app/stay/room/[roomCode]/page.tsx
  - apps/accommodations/frontend/hooks/useRoomSession.ts
autonomous: true

must_haves:
  truths:
    - 'Room resolve endpoint returns access_settings from the database so the frontend knows which actions are gated'
    - 'InlineVerification triggers ONLY for actions that the owner has marked as requiring verification in access_settings'
    - 'Family preset property: guest can order without any verification prompt'
    - 'Structured preset property: every action triggers verification before proceeding'
    - 'Standard preset property: ordering triggers verification, but viewing info and contacting host do not'
  artifacts:
    - path: 'apps/accommodations/frontend/app/api/stay/room/[roomCode]/route.ts'
      provides: 'Room resolve endpoint returning access_settings from resolve_room_access()'
      contains: 'access_settings'
    - path: 'apps/accommodations/frontend/app/stay/room/[roomCode]/page.tsx'
      provides: 'Room dashboard using access_settings to gate actions conditionally'
      contains: 'accessSettings'
    - path: 'apps/accommodations/frontend/hooks/useRoomSession.ts'
      provides: 'RoomSession type including accessSettings'
      contains: 'accessSettings'
  key_links:
    - from: 'apps/accommodations/frontend/app/api/stay/room/[roomCode]/route.ts'
      to: 'resolve_room_access()'
      via: 'rpc call returning access_settings JSONB'
      pattern: 'access_settings'
    - from: 'apps/accommodations/frontend/app/stay/room/[roomCode]/page.tsx'
      to: 'apps/accommodations/frontend/hooks/useRoomSession.ts'
      via: 'stay.accessSettings?.actions?.order_service check before requireFullTier'
      pattern: 'accessSettings'
---

<objective>
Wire access_settings from the database through the room resolve API to the guest-facing room dashboard, so that InlineVerification only triggers for actions the owner has marked as gated.

Purpose: Completes the end-to-end security configuration flow. Without this plan, the backoffice settings would be saved but ignored — the guest experience would remain unchanged regardless of the owner's preset choice.

Output: Updated room resolve endpoint, updated room dashboard with conditional gating, updated RoomSession type.
</objective>

<execution_context>
@/Users/gianfrancodagostino/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gianfrancodagostino/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior plan in this phase (must be complete)

@.planning/phases/27-owner-security-configuration/27-01-SUMMARY.md

# Key existing files to modify

@apps/accommodations/frontend/app/api/stay/room/[roomCode]/route.ts
@apps/accommodations/frontend/app/stay/room/[roomCode]/page.tsx
@apps/accommodations/frontend/hooks/useRoomSession.ts
@apps/accommodations/frontend/components/stay/InlineVerification.tsx
@apps/accommodations/frontend/types/stay.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Room resolve endpoint returns access_settings</name>
  <files>
    apps/accommodations/frontend/app/api/stay/room/[roomCode]/route.ts
  </files>
  <action>
    Update the GET handler in `/api/stay/room/[roomCode]/route.ts` to:

    1. Read `access_settings` from the `resolve_room_access()` RPC result (already returned by migration 090).
       The RPC now returns `result.access_settings` as a JSONB value.

    2. Include `access_settings` in the `RoomStayData` response:
       ```typescript
       const stay: RoomStayData = {
         property,
         room,
         booking,
         wifi,
         hasActiveBooking: result.has_active_booking,
         accessTier: 'browse',
         accessSettings: result.access_settings || undefined,
         ...(result.has_active_booking && {
           verificationMethod: (result.guest_verification_method as VerificationMethod) || 'last_name',
         }),
       };
       ```

    3. Import `AccessSettings` from `@/types/stay` (for type awareness, though the runtime value comes from DB).

    The key behavior: when `access_settings` is null (legacy properties that haven't configured it), the frontend falls back to the current behavior (standard preset). When it exists, the frontend uses it to determine which actions are gated.

    Do NOT change the verify endpoint — it always returns full-tier tokens regardless of access_settings. Access settings only control WHEN verification is triggered, not whether verification works.

  </action>
  <verify>
    - route.ts contains `accessSettings` in the RoomStayData construction
    - route.ts reads `result.access_settings` from RPC result
    - `AccessSettings` is imported from types
    - Run: `npx tsc --noEmit -p apps/accommodations/frontend/tsconfig.json` — no new errors
  </verify>
  <done>
    Room resolve endpoint returns access_settings from database. Frontend receives it in the RoomStayData response. Legacy properties (null access_settings) get undefined, triggering standard preset fallback.
  </done>
</task>

<task type="auto">
  <name>Task 2: Room dashboard uses access_settings for conditional verification gating</name>
  <files>
    apps/accommodations/frontend/hooks/useRoomSession.ts
    apps/accommodations/frontend/app/stay/room/[roomCode]/page.tsx
  </files>
  <action>
    **Step A: Update useRoomSession to expose accessSettings**

    In `hooks/useRoomSession.ts`:
    1. Import `AccessSettings` from `@/types/stay`.
    2. Add `accessSettings: AccessSettings | undefined` to the `RoomSession` interface.
    3. Return `accessSettings: stay?.accessSettings` from the hook.
    4. In `upgradeSession`, when building the `upgradedStay: RoomStayData`, preserve `accessSettings` from the existing `stay`:
       ```typescript
       const upgradedStay: RoomStayData = {
         ...existing fields...,
         accessSettings: stay?.accessSettings, // preserve through upgrade
       };
       ```

    **Step B: Update room dashboard to conditionally gate actions**

    In `app/stay/room/[roomCode]/page.tsx`:
    1. Import `ACCESS_PRESETS` and `AccessSettings` from `@/types/stay`.
    2. Destructure `accessSettings` from `useRoomSession()`.
    3. Create a helper function `isActionGated(action: string): boolean`:
       ```typescript
       function isActionGated(action: keyof AccessSettings['actions']): boolean {
         if (accessTier === 'full') return false; // Already verified, nothing gated
         if (!accessSettings) return true; // Legacy fallback: standard behavior (gate orders)
         return accessSettings.actions[action] ?? true; // true = gated = needs verification
       }
       ```

    4. Replace the current `requireFullTier` usage in `ServicesCarousel` cart proxy:
       - Currently: always wraps `cart.addItem` in `requireFullTier()` for browse tier
       - New: only wrap if `isActionGated('order_service')` is true
       ```typescript
       cart={
         isFullTier || !isActionGated('order_service')
           ? cart
           : {
               ...cart,
               addItem: (item) => {
                 requireFullTier(() => cart.addItem(item));
               },
             }
       }
       ```

    5. Update the "Verify your booking" prompt section at the bottom:
       - Only show it if at least one action is gated AND user is browse tier
       - If Family preset (nothing gated), don't show the verify prompt at all
       ```typescript
       {!isFullTier && Object.values(accessSettings?.actions ?? ACCESS_PRESETS.standard.actions).some(v => v) && (
         <section className="mb-5 px-4">
           <button onClick={() => setShowVerification(true)} ...>
             ...
           </button>
         </section>
       )}
       ```

    6. For the ActiveOrders section, gate it based on `isActionGated('view_orders')`:
       - Currently shows only for full tier
       - New: show if full tier OR if view_orders is not gated
       ```typescript
       {(isFullTier || !isActionGated('view_orders')) && <ActiveOrders ... />}
       ```

    7. For CartFAB and CartDrawer, keep them full-tier only (they're about placing orders, which is gated by the cart proxy in step 4).

    The overall logic: `isActionGated()` returns `false` for Family preset (all actions free), `true` for gated actions in Standard/Structured, and defers to the per-action setting for custom configs. The `requireFullTier` wrapper is only applied when the specific action IS gated.

  </action>
  <verify>
    - useRoomSession.ts exports `accessSettings` in RoomSession interface
    - page.tsx contains `isActionGated` helper function
    - page.tsx conditionally wraps cart.addItem based on `isActionGated('order_service')`
    - page.tsx conditionally shows verify prompt based on whether any action is gated
    - Run: `npx tsc --noEmit -p apps/accommodations/frontend/tsconfig.json` — no new errors
  </verify>
  <done>
    Room dashboard reads access_settings from the session and conditionally gates actions. Family preset: guest orders freely with no verification prompt. Standard: orders trigger verification, info is free. Structured: everything triggers verification. Custom configs use per-action toggles. Legacy properties (no access_settings) fall back to standard behavior.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npx tsc --noEmit -p apps/accommodations/frontend/tsconfig.json`
2. Room resolve endpoint returns access_settings in RoomStayData
3. useRoomSession exposes accessSettings field
4. Room dashboard page uses isActionGated() for conditional verification
5. Family preset scenario: no verification prompts appear (all actions free)
6. Standard preset scenario: cart add triggers verification, info does not
7. Legacy property (null access_settings): behaves like standard preset (backward compat)
</verification>

<success_criteria>

- Room resolve API includes accessSettings in response
- useRoomSession hook exposes accessSettings
- isActionGated helper correctly maps preset actions to gating decisions
- Cart proxy only wraps addItem when order_service is gated
- Verify prompt only shows when at least one action is gated
- ActiveOrders shows for browse tier when view_orders is not gated
- TypeScript compiles without errors
- Backward compatibility: properties without access_settings behave like standard preset
  </success_criteria>

<output>
After completion, create `.planning/phases/27-owner-security-configuration/27-02-SUMMARY.md`
</output>
