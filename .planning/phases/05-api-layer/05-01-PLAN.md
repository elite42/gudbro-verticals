---
phase: 05-api-layer
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/accommodations/frontend/lib/supabase.ts
  - apps/accommodations/frontend/lib/auth.ts
  - apps/accommodations/frontend/types/stay.ts
  - apps/accommodations/frontend/app/api/stay/[code]/route.ts
  - apps/accommodations/frontend/app/api/stay/verify/route.ts
  - apps/accommodations/frontend/package.json
autonomous: true

must_haves:
  truths:
    - 'GET /api/stay/BK-T3ST01 returns 200 with property name, check-in/out dates'
    - 'GET /api/stay/INVALID returns 404 with booking_not_found error'
    - 'POST /api/stay/verify with correct code+lastName returns 200 with JWT token'
    - 'POST /api/stay/verify with wrong lastName returns 401 with verification_failed'
    - 'All responses use { data, error } wrapper format'
  artifacts:
    - path: 'apps/accommodations/frontend/lib/supabase.ts'
      provides: 'Supabase service role client (lazy singleton)'
    - path: 'apps/accommodations/frontend/lib/auth.ts'
      provides: 'signGuestToken and verifyGuestToken using jose'
      exports: ['signGuestToken', 'verifyGuestToken']
    - path: 'apps/accommodations/frontend/types/stay.ts'
      provides: 'API response types for all stay endpoints'
    - path: 'apps/accommodations/frontend/app/api/stay/[code]/route.ts'
      provides: 'Public booking lookup endpoint'
      exports: ['GET']
    - path: 'apps/accommodations/frontend/app/api/stay/verify/route.ts'
      provides: 'Guest verification + JWT issuance'
      exports: ['POST']
  key_links:
    - from: 'app/api/stay/verify/route.ts'
      to: "supabase.rpc('verify_booking_access')"
      via: 'Service role client RPC call'
      pattern: 'verify_booking_access'
    - from: 'app/api/stay/verify/route.ts'
      to: 'lib/auth.ts'
      via: 'signGuestToken after successful verification'
      pattern: 'signGuestToken'
    - from: 'app/api/stay/[code]/route.ts'
      to: 'supabase query on accom_bookings'
      via: 'Service role client query'
      pattern: 'accom_bookings'
---

<objective>
Create the Supabase client, JWT auth helpers, API response types, and two core stay routes: the public booking lookup (GET /api/stay/[code]) and guest verification with JWT issuance (POST /api/stay/verify).

Purpose: These are the foundation routes that enable guest identity verification and the session token that protects all other API routes in Plan 05-02.

Output: Working Supabase client, jose-based JWT helpers, TypeScript types for all API responses, and two functional API routes testable with curl against seed data (BK-T3ST01).
</objective>

<execution_context>
@/Users/gianfrancodagostino/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gianfrancodagostino/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-api-layer/05-CONTEXT.md
@.planning/phases/05-api-layer/05-RESEARCH.md
@.planning/phases/04-database-foundation/04-01-SUMMARY.md
@.planning/phases/04-database-foundation/04-02-SUMMARY.md
@apps/accommodations/frontend/lib/types.ts
@apps/accommodations/frontend/package.json
@apps/backoffice/lib/supabase-admin.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Supabase client, JWT auth helpers, and API types</name>
  <files>
    apps/accommodations/frontend/package.json
    apps/accommodations/frontend/lib/supabase.ts
    apps/accommodations/frontend/lib/auth.ts
    apps/accommodations/frontend/types/stay.ts
  </files>
  <action>
1. Add dependencies to package.json: `jose` ^6.x and `@supabase/supabase-js` (match version from monorepo root or coffeeshop). Run `pnpm install` from repo root after.

2. Create `lib/supabase.ts` — Supabase service role client following the backoffice pattern:
   - Lazy-initialized singleton via Proxy (copy pattern from `apps/backoffice/lib/supabase-admin.ts`)
   - Uses `NEXT_PUBLIC_SUPABASE_URL` and `SUPABASE_SERVICE_ROLE_KEY` env vars
   - Export `getSupabaseAdmin()` function
   - Why service role: partner_conventions table has no anon grant, and verify_booking_access is SECURITY DEFINER

3. Create `lib/auth.ts` — JWT helpers using `jose`:
   - `signGuestToken(payload: { bookingId: string, propertyId: string, checkoutDate: string })`: Signs JWT with HS256 using `GUEST_JWT_SECRET` env var. Set `exp` to checkout date + 24 hours (use date-fns `addHours`). Return the signed token string.
   - `verifyGuestToken(token: string)`: Verifies and returns payload `{ bookingId, propertyId, exp }`. Throws on invalid/expired.
   - Use `new TextEncoder().encode(secret)` for jose key format
   - Export a `GuestTokenPayload` type

4. Create `types/stay.ts` — API response types:
   - `StayLookupResponse`: { propertyName, checkIn, checkOut, guestFirstName } (public, minimal)
   - `VerifyResponse`: { token, stay: StayData }
   - `StayData`: { property: PropertyInfo, room: RoomInfo, booking: BookingInfo, wifi: WifiInfo }
   - `PropertyInfo`: { name, slug, type, contactPhone, contactWhatsapp, checkoutTime, houseRules, amenities, images }
   - `RoomInfo`: { number, name, floor }
   - `BookingInfo`: { code, guestName, guestCount, checkIn, checkOut, nights, status }
   - `WifiInfo`: { network, password }
   - `ServiceCategoryResponse`: { categories: ServiceCategoryWithItems[] }
   - `ServiceCategoryWithItems`: { id, name, icon, description, sortOrder, items: ServiceItemResponse[] }
   - `ServiceItemResponse`: { id, name, description, price, currency, priceType, image, inStock }
   - `DealResponse`: { id, merchantName, merchantSlug, discountLabel, description, validUntil, bookingAction }
   - `ApiResponse<T>`: { data?: T, error?: string }
   - `ApiError`: string union type: 'booking_not_found' | 'booking_expired' | 'verification_failed' | 'session_expired' | 'internal_error'
     </action>
     <verify>
     Run `cd apps/accommodations/frontend && npx tsc --noEmit` — zero type errors. Verify jose and @supabase/supabase-js appear in package.json dependencies.
     </verify>
     <done>
     Supabase client, JWT sign/verify helpers, and complete API response types compile without errors. jose and @supabase/supabase-js installed.
     </done>
     </task>

<task type="auto">
  <name>Task 2: Public booking lookup and guest verification routes</name>
  <files>
    apps/accommodations/frontend/app/api/stay/[code]/route.ts
    apps/accommodations/frontend/app/api/stay/verify/route.ts
  </files>
  <action>
1. Create `app/api/stay/[code]/route.ts` — GET handler (PUBLIC, no auth):
   - Extract `code` from `params` (Next.js 14 pattern: `{ params: { code: string } }`)
   - Validate code format: must match /^BK-[A-HJ-NP-Z2-9]{6}$/ (excludes 0/O/1/I/L). Return 400 if invalid.
   - Query Supabase: `supabase.from('accom_bookings').select('id, guest_first_name, check_in, check_out, accom_properties!inner(name)').eq('booking_code', code).single()`
   - If no data: return 404 `{ error: 'booking_not_found' }`
   - Check if checkout has passed (check_out < today): return 410 `{ error: 'booking_expired' }`
   - Return 200 `{ data: { propertyName, checkIn, checkOut, guestFirstName } }` — minimal public info for the verification screen
   - Wrap in try/catch, return 500 `{ error: 'internal_error' }` on unexpected errors

2. Create `app/api/stay/verify/route.ts` — POST handler:
   - Parse JSON body: `{ bookingCode: string, lastName: string }`
   - Validate both fields present, return 400 if missing
   - Call `supabase.rpc('verify_booking_access', { p_booking_code: bookingCode, p_last_name: lastName })`
   - IMPORTANT: `.rpc()` returns an array, NOT a single object. Use `data[0]` to access result.
   - If `!data || !data[0] || !data[0].is_valid`: return 401 `{ error: 'verification_failed' }` (generic — don't reveal if code exists)
   - On success, extract from data[0]: property_id, booking_id, check_out (the function returns these)
   - Query full stay data for the response: property info, room, booking details, WiFi. Use a joined query:
     ```
     supabase.from('accom_bookings')
       .select(`
         id, booking_code, guest_first_name, guest_last_name, guest_count,
         check_in, check_out, status,
         accom_rooms!inner(room_number, name, floor),
         accom_properties!inner(
           name, slug, type, contact_phone, contact_whatsapp,
           checkout_time, house_rules, amenities, images,
           wifi_network, wifi_password
         )
       `)
       .eq('id', data[0].booking_id)
       .single()
     ```
   - Sign JWT via `signGuestToken({ bookingId, propertyId, checkoutDate })`
   - Return 200 `{ data: { token, stay: { property, room, booking, wifi } } }` mapped to StayData types
   - Map property fields: houseRules and amenities come as Postgres arrays (string[])
   - Map price from integer (minor currency) — not needed here since verify doesn't return prices
   - Wrap in try/catch, return 500 on unexpected errors
     </action>
     <verify>
     Run `cd apps/accommodations/frontend && npx tsc --noEmit` — zero type errors. Run `pnpm build --filter @gudbro/accommodations-frontend` to verify routes compile in Next.js build.
     </verify>
     <done>
     GET /api/stay/[code] returns minimal booking info for valid codes, 404 for invalid, 410 for expired. POST /api/stay/verify validates guest identity via RPC, returns JWT + full stay data on success, 401 on failure. Both routes compile and build successfully.
     </done>
     </task>

</tasks>

<verification>
1. `cd apps/accommodations/frontend && npx tsc --noEmit` passes with zero errors
2. `pnpm build --filter @gudbro/accommodations-frontend` succeeds
3. All files exist: lib/supabase.ts, lib/auth.ts, types/stay.ts, app/api/stay/[code]/route.ts, app/api/stay/verify/route.ts
4. jose and @supabase/supabase-js in package.json dependencies
</verification>

<success_criteria>

- Supabase service role client initialized with lazy singleton pattern
- JWT sign/verify helpers use jose with HS256 and checkout-based expiry
- TypeScript types cover all API responses for Phase 5
- GET /api/stay/[code] returns public booking info with proper error handling
- POST /api/stay/verify calls verify_booking_access RPC and returns JWT + stay data
- All code compiles and builds without errors
  </success_criteria>

<output>
After completion, create `.planning/phases/05-api-layer/05-01-SUMMARY.md`
</output>
