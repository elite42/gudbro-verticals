---
phase: 19-property-page-booking-flow
plan: 03
type: execute
wave: 3
depends_on: [19-01, 19-02]
files_modified:
  - apps/accommodations/frontend/app/property/[slug]/page.tsx
  - apps/accommodations/frontend/app/property/[slug]/PropertyPageClient.tsx
  - apps/accommodations/frontend/app/booking/[code]/page.tsx
  - apps/accommodations/frontend/styles/globals.css
autonomous: true

must_haves:
  truths:
    - 'Property page is server-rendered with dynamic OG meta tags (property name, photo, location)'
    - 'JSON-LD structured data (LodgingBusiness) is in the initial HTML response'
    - 'Page title follows format: "[Property Name] -- [Location] | GUDBRO Stays"'
    - 'URL pattern is /property/[slug]'
    - 'Non-existent properties return Next.js 404 page'
    - 'Client page composes all components in single-scroll flow: gallery -> details -> calendar -> form -> submit'
    - 'On desktop, booking widget (calendar + price + form) is in a sticky sidebar'
    - 'Booking confirmation page at /booking/[code] shows booking details'
    - 'react-day-picker CSS is properly imported and themed with accent colors'
  artifacts:
    - path: 'apps/accommodations/frontend/app/property/[slug]/page.tsx'
      provides: 'Server component with generateMetadata, JSON-LD, and data fetching'
    - path: 'apps/accommodations/frontend/app/property/[slug]/PropertyPageClient.tsx'
      provides: 'Client orchestrator composing all booking components'
    - path: 'apps/accommodations/frontend/app/booking/[code]/page.tsx'
      provides: 'Standalone booking confirmation page'
  key_links:
    - from: 'app/property/[slug]/page.tsx'
      to: 'lib/property-api.ts fetchPropertyBySlug'
      via: 'Server-side data fetching for SSR'
      pattern: 'fetchPropertyBySlug'
    - from: 'app/property/[slug]/page.tsx'
      to: 'lib/structured-data.ts buildLodgingBusinessSchema'
      via: 'JSON-LD generation'
      pattern: 'buildLodgingBusinessSchema'
    - from: 'PropertyPageClient.tsx'
      to: 'hooks/useBookingForm.ts'
      via: 'Form state orchestration'
      pattern: 'useBookingForm'
---

<objective>
Assemble the server-rendered property page with SEO (generateMetadata + JSON-LD), create the client page orchestrator that composes all components into a single-scroll booking flow, add the standalone booking confirmation page, and add required CSS for react-day-picker theming.

Purpose: This is the final assembly plan that brings together the API layer (Plan 19-01) and the components (Plan 19-02) into working pages. After this plan, guests can discover a property via URL and complete a booking.
Output: 2 page routes, 1 client orchestrator component, CSS additions.
</objective>

<execution_context>
@/Users/gianfrancodagostino/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gianfrancodagostino/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-property-page-booking-flow/19-RESEARCH.md
@.planning/phases/19-property-page-booking-flow/19-CONTEXT.md

# Types and libs from Plan 19-01

@apps/accommodations/frontend/types/property.ts
@apps/accommodations/frontend/lib/property-api.ts
@apps/accommodations/frontend/lib/structured-data.ts
@apps/accommodations/frontend/lib/price-utils.ts

# Components from Plan 19-02

@apps/accommodations/frontend/components/booking/PropertyGallery.tsx
@apps/accommodations/frontend/components/booking/PropertyHeader.tsx
@apps/accommodations/frontend/components/booking/PropertyDescription.tsx
@apps/accommodations/frontend/components/booking/AmenityGrid.tsx
@apps/accommodations/frontend/components/booking/HouseRules.tsx
@apps/accommodations/frontend/components/booking/HostInfoCard.tsx
@apps/accommodations/frontend/components/booking/LocationSection.tsx
@apps/accommodations/frontend/components/booking/RoomSelector.tsx
@apps/accommodations/frontend/components/booking/BookingCalendar.tsx
@apps/accommodations/frontend/components/booking/PriceBreakdown.tsx
@apps/accommodations/frontend/components/booking/BookingForm.tsx
@apps/accommodations/frontend/components/booking/BookingConfirmation.tsx
@apps/accommodations/frontend/hooks/useBookingForm.ts

# Layout and styles

@apps/accommodations/frontend/app/layout.tsx
@apps/accommodations/frontend/styles/globals.css
@apps/accommodations/frontend/tailwind.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create server-rendered property page with SEO</name>
  <files>apps/accommodations/frontend/app/property/[slug]/page.tsx</files>
  <action>
Create `apps/accommodations/frontend/app/property/[slug]/page.tsx` -- the server component that handles SSR, SEO metadata, and JSON-LD.

This is a **Server Component** (no 'use client' directive). It fetches data server-side and passes it to the client component.

Follow the EXACT pattern from 19-RESEARCH.md (Pattern 1: Server Component with Client Islands).

Requirements:

1. **generateMetadata** async function:
   - Fetch property by slug using `getSupabaseAdmin()` directly (NOT via fetch API -- server component can query DB directly)
   - Return `Metadata` with:
     - title: `${property.name} -- ${property.city || ''} | GUDBRO Stays`
     - description: first 155 chars of property.description
     - openGraph: title, description, first image, type 'website', siteName 'GUDBRO Stays'
   - Return empty metadata for non-existent properties (Next.js handles 404)

2. **PropertyPage** default export:
   - Fetch full property data with rooms join (same query as API route but direct Supabase call since we're server-side)
   - Call `notFound()` from 'next/navigation' if property not found
   - Build JSON-LD using `buildLodgingBusinessSchema`
   - Render JSON-LD in a script tag with type="application/ld+json"
   - Render JSON-LD using the standard Next.js pattern: `<script type="application/ld+json" dangerouslySetInnerHTML={{ __html: JSON.stringify(jsonLd) }} />`. The data is server-controlled from our own database so `JSON.stringify` is sufficient -- no additional sanitization needed.
   - Render `<PropertyPageClient property={property} />` passing the full data

The server component fetches property data including rooms join:

```typescript
import { Metadata } from 'next';
import { notFound } from 'next/navigation';
import { getSupabaseAdmin } from '@/lib/supabase';
import { buildLodgingBusinessSchema } from '@/lib/structured-data';
import type { PropertyPageData } from '@/types/property';
import PropertyPageClient from './PropertyPageClient';

interface Props {
  params: { slug: string };
}

export async function generateMetadata({ params }: Props): Promise<Metadata> {
  const property = await fetchProperty(params.slug);
  if (!property) return {};

  return {
    title: `${property.name} -- ${property.city || ''} | GUDBRO Stays`,
    description:
      property.description?.slice(0, 155) || `Book ${property.name} directly`,
    openGraph: {
      title: property.name,
      description: property.description?.slice(0, 155),
      images: property.images?.[0] ? [{ url: property.images[0] }] : [],
      type: 'website',
      siteName: 'GUDBRO Stays',
    },
  };
}

async function fetchProperty(slug: string): Promise<PropertyPageData | null> {
  const supabase = getSupabaseAdmin();
  // Query accom_properties with rooms join, filter active, map to PropertyPageData
  // Return null if not found
}

export default async function PropertyPage({ params }: Props) {
  const property = await fetchProperty(params.slug);
  if (!property) notFound();

  const jsonLd = buildLodgingBusinessSchema(property);
  // Serialize jsonLd safely and render in script tag
  // Then render PropertyPageClient
}
```

Important: Do NOT use `!inner` join for rooms here -- use regular join so the page still loads if a property has no active rooms (we check after). The `!inner` join would cause a 404 at the PostgREST level.
</action>
<verify>

1. `cat apps/accommodations/frontend/app/property/[slug]/page.tsx` -- file exists
2. `grep "generateMetadata" apps/accommodations/frontend/app/property/[slug]/page.tsx` -- SSR metadata
3. `grep "GUDBRO Stays" apps/accommodations/frontend/app/property/[slug]/page.tsx` -- correct siteName
4. `grep "application/ld+json" apps/accommodations/frontend/app/property/[slug]/page.tsx` -- JSON-LD script
5. `grep "buildLodgingBusinessSchema" apps/accommodations/frontend/app/property/[slug]/page.tsx` -- uses structured data
6. `grep "notFound" apps/accommodations/frontend/app/property/[slug]/page.tsx` -- 404 handling
7. `grep "PropertyPageClient" apps/accommodations/frontend/app/property/[slug]/page.tsx` -- renders client component
8. `grep 'dangerouslySetInnerHTML.*JSON.stringify' apps/accommodations/frontend/app/property/[slug]/page.tsx` -- JSON-LD rendered via standard Next.js pattern
   </verify>
   <done>Server-rendered property page created with generateMetadata (OG tags, title, description), JSON-LD LodgingBusiness schema, direct Supabase query, notFound() for missing properties, and PropertyPageClient delegation.</done>
   </task>

<task type="auto">
  <name>Task 2: Create PropertyPageClient orchestrator</name>
  <files>apps/accommodations/frontend/app/property/[slug]/PropertyPageClient.tsx</files>
  <action>
Create `apps/accommodations/frontend/app/property/[slug]/PropertyPageClient.tsx` -- the client component that orchestrates all interactive sections.

This is a `'use client'` component that receives the full `PropertyPageData` from the server page and composes all booking components.

Requirements:

1. **Layout structure:**
   - Mobile: single column, full scroll
   - Desktop (md+): two-column layout
     - Left column (60%): gallery, property details
     - Right column (40%): sticky booking widget (room selector, calendar, price, form)
   - Use `md:grid md:grid-cols-5 md:gap-8` (3 + 2 columns) or similar

2. **Component composition order (mobile scroll):**

   ```
   PropertyGallery
   PropertyHeader
   PropertyDescription
   AmenityGrid
   HouseRules
   HostInfoCard
   LocationSection
   --- Booking Section ---
   RoomSelector (if rooms > 1)
   BookingCalendar
   PriceBreakdown
   BookingForm
   --- or ---
   BookingConfirmation (after successful submission)
   ```

3. **State management:**
   - Use `useBookingForm` hook for all booking state
   - Pass appropriate props to each component from the hook return values

4. **Booking section behavior:**
   - Before booking: show calendar + form
   - After booking: show BookingConfirmation (replaces calendar + form)
   - Use `bookingResult` from useBookingForm to toggle

5. **Desktop sticky sidebar:**
   - The booking widget (calendar, price, form) should be in a `sticky top-4` container on desktop
   - Wrapped in a card-like container with border and shadow

6. **Booking disabled state:**
   - If `property.booking_mode === 'disabled'`, show a "Contact host directly" message instead of the booking section
   - Still show property details, just no booking form

The component imports all 12 booking components from Plan 19-02 and the useBookingForm hook. It initializes the hook with property configuration and passes state/callbacks down to each component.

On mobile, all sections render in a single column. On desktop (md+), use a grid where property info is in the left 3 columns and the booking widget is in the right 2 columns with `md:sticky md:top-4`.
</action>
<verify>

1. `cat apps/accommodations/frontend/app/property/[slug]/PropertyPageClient.tsx` -- file exists
2. `grep "use client" apps/accommodations/frontend/app/property/[slug]/PropertyPageClient.tsx` -- client directive
3. `grep "useBookingForm" apps/accommodations/frontend/app/property/[slug]/PropertyPageClient.tsx` -- uses booking hook
4. Verify ALL 12 component imports are present:
   `for comp in PropertyGallery PropertyHeader PropertyDescription AmenityGrid HouseRules HostInfoCard LocationSection RoomSelector BookingCalendar PriceBreakdown BookingForm BookingConfirmation; do grep -q "$comp" apps/accommodations/frontend/app/property/[slug]/PropertyPageClient.tsx && echo "OK: $comp" || echo "MISSING: $comp"; done`
5. `grep "sticky" apps/accommodations/frontend/app/property/[slug]/PropertyPageClient.tsx` -- desktop sticky sidebar
6. `grep "booking_mode.*disabled" apps/accommodations/frontend/app/property/[slug]/PropertyPageClient.tsx` -- handles disabled mode
7. `grep "md:grid\|md:col-span" apps/accommodations/frontend/app/property/[slug]/PropertyPageClient.tsx` -- responsive layout
   </verify>
   <done>PropertyPageClient orchestrator created with responsive layout (single-column mobile, two-column desktop with sticky sidebar), useBookingForm integration, component composition, booking/confirmation toggle, and disabled mode handling.</done>
   </task>

<task type="auto">
  <name>Task 3: Create booking confirmation standalone page</name>
  <files>apps/accommodations/frontend/app/booking/[code]/page.tsx</files>
  <action>
Create `apps/accommodations/frontend/app/booking/[code]/page.tsx` -- a standalone page that guests can access later to view their booking details.

This is a simple server component that:

1. Extracts the booking code from the URL params
2. Looks up the booking by code in the DB (public endpoint, no auth -- the code itself is the access token)
3. Shows booking details: property name, dates, room, status, and price
4. Returns 404 if booking code not found

This page serves as a shareable link and reference point.

Requirements:

- generateMetadata with `robots: { index: false }` (don't index booking pages)
- Title: `Booking ${params.code} | GUDBRO Stays`
- Query `accom_bookings` by booking_code with property and room joins
- Display: property name, booking code, dates, nights, guests, room type, status badge, total price
- Status badges: confirmed (green), pending (yellow/amber), cancelled (red)
- WhatsApp CTA to contact host if contact_whatsapp available
- Footer note: "Manage your booking by contacting the host directly"
- Must NOT expose sensitive info (no guest email, no phone) -- only property name, dates, status, room, price

The page is a read-only summary that the guest can bookmark or share.
</action>
<verify>

1. `cat apps/accommodations/frontend/app/booking/[code]/page.tsx` -- file exists
2. `grep "generateMetadata" apps/accommodations/frontend/app/booking/[code]/page.tsx` -- has metadata
3. `grep "robots\|noindex\|index.*false" apps/accommodations/frontend/app/booking/[code]/page.tsx` -- not indexed
4. `grep "booking_code" apps/accommodations/frontend/app/booking/[code]/page.tsx` -- queries by code
5. `grep "notFound" apps/accommodations/frontend/app/booking/[code]/page.tsx` -- 404 handling
6. `grep "status\|confirmed\|pending" apps/accommodations/frontend/app/booking/[code]/page.tsx` -- shows status
   </verify>
   <done>Booking confirmation standalone page created at /booking/[code] with server-rendered booking details, status badge, noindex meta, and WhatsApp CTA. No sensitive data exposed.</done>
   </task>

<task type="auto">
  <name>Task 4: Add react-day-picker CSS theming to globals.css</name>
  <files>apps/accommodations/frontend/styles/globals.css</files>
  <action>
Add react-day-picker CSS customization to `apps/accommodations/frontend/styles/globals.css`.

React DayPicker v9 uses CSS custom properties for theming. Add overrides to match the accommodations design system.

Append the following to the END of the existing globals.css (do NOT modify existing content):

```css
/* ==============================================
   React DayPicker v9 - Custom Theme
   Matches accommodations design system colors
   ============================================== */

.rdp {
  --rdp-accent-color: hsl(var(--primary));
  --rdp-accent-background-color: hsl(var(--primary) / 0.1);
  --rdp-range-background-color: hsl(var(--primary) / 0.08);
  --rdp-disabled-opacity: 0.35;
  --rdp-day-height: 44px;
  --rdp-day-width: 44px;
  font-family: var(--font-body), system-ui, sans-serif;
}

/* Selected range endpoints */
.rdp-day_range_start .rdp-day_button,
.rdp-day_range_end .rdp-day_button {
  background-color: hsl(var(--primary));
  color: white;
  border-radius: 9999px;
}

/* Range middle days */
.rdp-day_range_middle {
  background-color: hsl(var(--primary) / 0.08);
}

/* Today indicator */
.rdp-day_today:not(.rdp-day_selected) .rdp-day_button {
  font-weight: 700;
  color: hsl(var(--primary));
}

/* Hover on non-disabled days */
.rdp-day:not(.rdp-day_disabled):not(.rdp-day_selected) .rdp-day_button:hover {
  background-color: hsl(var(--primary) / 0.06);
  border-radius: 9999px;
}

/* Disabled day styling */
.rdp-day_disabled .rdp-day_button {
  text-decoration: line-through;
  color: hsl(var(--foreground-muted));
}

/* Month caption */
.rdp-caption_label {
  font-weight: 600;
  font-size: 1rem;
}

/* Navigation buttons */
.rdp-button_previous,
.rdp-button_next {
  color: hsl(var(--foreground));
}

/* ==============================================
   react-international-phone - Custom Theme
   ============================================== */

.react-international-phone-input-container {
  width: 100%;
}

.react-international-phone-input {
  width: 100% !important;
  border-radius: 0.75rem !important;
  border-color: hsl(var(--border)) !important;
  padding: 0.75rem 1rem !important;
  font-size: 1rem !important;
  font-family: var(--font-body), system-ui, sans-serif !important;
}

.react-international-phone-input:focus {
  border-color: hsl(var(--primary)) !important;
  box-shadow: 0 0 0 2px hsl(var(--primary) / 0.2) !important;
}

.react-international-phone-country-selector-button {
  border-radius: 0.75rem 0 0 0.75rem !important;
  border-color: hsl(var(--border)) !important;
}
```

Also verify that the `react-day-picker/style.css` import in BookingCalendar.tsx will work. If not, add `@import 'react-day-picker/style.css';` to the top of globals.css as a fallback.
</action>
<verify>

1. `grep "rdp-accent-color\|rdp" apps/accommodations/frontend/styles/globals.css` -- DayPicker overrides present
2. `grep "react-international-phone" apps/accommodations/frontend/styles/globals.css` -- phone input overrides present
3. `grep "var(--primary)" apps/accommodations/frontend/styles/globals.css` -- uses design system variables
4. `cd apps/accommodations/frontend && npx tsc --noEmit 2>&1 | head -30` -- TypeScript still compiles
   </verify>
   <done>CSS theming added for react-day-picker (accent colors, range styling, disabled days, today indicator) and react-international-phone (border radius, focus ring, width) matching the accommodations design system.</done>
   </task>

</tasks>

<verification>
1. Property page renders at /property/[slug] -- server component with generateMetadata
2. OG meta tags include property name, photo, description in initial HTML
3. JSON-LD script tag with LodgingBusiness schema in initial HTML
4. PropertyPageClient composes all components in correct order
5. Desktop layout has sticky booking sidebar
6. Mobile layout is single-column scroll
7. Booking disabled mode shows "contact host" message
8. Booking confirmation page at /booking/[code] with noindex
9. CSS overrides for DayPicker and phone input are present
10. Full TypeScript compilation: `cd apps/accommodations/frontend && npx tsc --noEmit`
11. Build succeeds: `cd apps/accommodations/frontend && npx next build`
</verification>

<success_criteria>

- PROP-01: Gallery displayed on property page (via PropertyPageClient composition)
- PROP-02: All property details sections visible (description, amenities, rules, host, location)
- PROP-03: Calendar with availability visible in booking widget
- PROP-04: Price breakdown visible after date selection
- PROP-05: Location section with map link
- PROP-06: Server-rendered page with OG meta tags, JSON-LD structured data, SEO-friendly URL
- BOOK-01: Complete booking flow from form to confirmation
- BOOK-04: WhatsApp deep-link on confirmation (both inline and standalone page)
- BOOK-07: Guest books without account (JWT stored in localStorage)
  </success_criteria>

<output>
After completion, create `.planning/phases/19-property-page-booking-flow/19-03-SUMMARY.md`
</output>
