---
phase: 08-schema-api-alignment
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - shared/database/migrations/schema/081-schema-api-alignment.sql
autonomous: true

must_haves:
  truths:
    - 'All API SELECT column names exist in the database tables'
    - 'house_rules is stored as JSONB array, not plain TEXT'
    - 'Service items have currency, price_type, and in_stock columns'
    - 'Properties have contact_whatsapp column'
  artifacts:
    - path: 'shared/database/migrations/schema/081-schema-api-alignment.sql'
      provides: 'Column renames, new columns, type changes'
      contains: 'ALTER TABLE accom_properties'
  key_links:
    - from: 'shared/database/migrations/schema/081-schema-api-alignment.sql'
      to: 'apps/accommodations/frontend/app/api/stay/verify/route.ts'
      via: 'Column names in SELECT match DB columns'
      pattern: 'wifi_network|contact_phone|contact_whatsapp|checkout_time'
    - from: 'shared/database/migrations/schema/081-schema-api-alignment.sql'
      to: 'apps/accommodations/frontend/app/api/stay/[code]/services/route.ts'
      via: 'Column names in SELECT match DB columns'
      pattern: 'sort_order|image|currency|price_type|in_stock'
---

<objective>
Create migration 081 that aligns database column names with API route SELECT strings, adds missing columns, and changes house_rules from TEXT to JSONB.

Purpose: API routes SELECT columns by name (e.g., `wifi_network`, `contact_phone`, `sort_order`). The actual DB columns have different names (e.g., `wifi_ssid`, `host_phone`, `display_order`). Supabase returns NULL for mismatched names and errors for non-existent columns. This migration fixes all mismatches so the existing API routes work against real data without code changes.

Output: One migration SQL file (081) that makes the schema match what API routes expect.
</objective>

<execution_context>
@/Users/gianfrancodagostino/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gianfrancodagostino/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@shared/database/migrations/schema/077-accommodations-schema.sql
@apps/accommodations/frontend/app/api/stay/verify/route.ts
@apps/accommodations/frontend/app/api/stay/[code]/property/route.ts
@apps/accommodations/frontend/app/api/stay/[code]/services/route.ts
@apps/accommodations/frontend/types/stay.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create migration 081 — accom_properties column alignment</name>
  <files>shared/database/migrations/schema/081-schema-api-alignment.sql</files>
  <action>
Create migration file `shared/database/migrations/schema/081-schema-api-alignment.sql` with proper header (date, description, depends on 077+079+080).

**Section 1: accom_properties RENAMES** (column exists but API uses different name)

These columns exist in DB (077) but API routes SELECT them with different names:

| Current DB Column | API SELECT Name | Action                          |
| ----------------- | --------------- | ------------------------------- |
| `wifi_ssid`       | `wifi_network`  | `ALTER TABLE ... RENAME COLUMN` |
| `host_phone`      | `contact_phone` | `ALTER TABLE ... RENAME COLUMN` |
| `host_email`      | `contact_email` | `ALTER TABLE ... RENAME COLUMN` |
| `check_out_time`  | `checkout_time` | `ALTER TABLE ... RENAME COLUMN` |
| `cover_image_url` | `cover_image`   | `ALTER TABLE ... RENAME COLUMN` |
| `country_code`    | `country`       | `ALTER TABLE ... RENAME COLUMN` |

Note: Do NOT rename `property_type` to `type` because `type` is a reserved/ambiguous word in SQL. Instead, add a generated column: `ALTER TABLE accom_properties ADD COLUMN type TEXT GENERATED ALWAYS AS (property_type) STORED;`

**Section 2: accom_properties NEW COLUMNS** (API SELECTs them but they don't exist)

| Column             | Type         | Default   | Reason                                 |
| ------------------ | ------------ | --------- | -------------------------------------- |
| `contact_whatsapp` | TEXT         | NULL      | verify + property routes SELECT it     |
| `area`             | TEXT         | NULL      | property route SELECTs it              |
| `rating`           | NUMERIC(2,1) | NULL      | property route SELECTs it (future use) |
| `review_count`     | INTEGER      | DEFAULT 0 | property route SELECTs it (future use) |

Use `ALTER TABLE accom_properties ADD COLUMN IF NOT EXISTS ...` for each.

**Section 3: accom_properties TYPE CHANGE**

Change `house_rules` from TEXT to JSONB:

```sql
ALTER TABLE accom_properties
  ALTER COLUMN house_rules TYPE JSONB USING
    CASE
      WHEN house_rules IS NULL THEN '[]'::JSONB
      WHEN house_rules = '' THEN '[]'::JSONB
      ELSE to_jsonb(string_to_array(house_rules, '. '))
    END;
ALTER TABLE accom_properties
  ALTER COLUMN house_rules SET DEFAULT '[]'::JSONB;
```

This converts the existing TEXT value (a single string with sentences separated by ". ") into a JSONB array of strings, which is what the API expects (houseRules: string[]).

**Section 4: accom_service_categories RENAME**

| Current DB Column | API SELECT Name | Action                          |
| ----------------- | --------------- | ------------------------------- |
| `display_order`   | `sort_order`    | `ALTER TABLE ... RENAME COLUMN` |

**Section 5: accom_service_items RENAMES**

| Current DB Column | API SELECT Name | Action                          |
| ----------------- | --------------- | ------------------------------- |
| `display_order`   | `sort_order`    | `ALTER TABLE ... RENAME COLUMN` |
| `image_url`       | `image`         | `ALTER TABLE ... RENAME COLUMN` |

**Section 6: accom_service_items NEW COLUMNS**

| Column       | Type    | Default         | Reason                    |
| ------------ | ------- | --------------- | ------------------------- |
| `currency`   | TEXT    | DEFAULT 'VND'   | services route SELECTs it |
| `price_type` | TEXT    | DEFAULT 'fixed' | services route SELECTs it |
| `in_stock`   | BOOLEAN | DEFAULT true    | services route SELECTs it |

Use `ALTER TABLE accom_service_items ADD COLUMN IF NOT EXISTS ...` for each.

**Section 7: Update check_in_time rename**

Also rename `check_in_time` to `checkin_time` for consistency (property route SELECTs `check_in_time` so this one stays as-is — do NOT rename check_in_time, the API uses it correctly).

**Section 8: Update indexes**

Rename any indexes that reference old column names. Specifically:

- No index changes needed (indexes reference columns by table position, not name — PostgreSQL handles this automatically with RENAME COLUMN).

**Section 9: Comments**

Add COMMENT ON statements documenting the renames and new columns.

**IMPORTANT: Do NOT modify any TypeScript files, API routes, or types.** This plan only creates the SQL migration. The API routes already use the correct (new) column names.
</action>
<verify>
Verify the migration SQL is valid by checking:

1. File exists at `shared/database/migrations/schema/081-schema-api-alignment.sql`
2. Contains all 6 RENAME COLUMN statements for accom_properties
3. Contains RENAME COLUMN statements for accom_service_categories and accom_service_items
4. Contains ADD COLUMN for contact_whatsapp, area, rating, review_count
5. Contains ADD COLUMN for currency, price_type, in_stock
6. Contains ALTER COLUMN house_rules TYPE JSONB
7. Contains generated column for `type`
8. No TypeScript files modified
   </verify>
   <done>
   Migration 081 SQL file exists with all column renames (wifi_ssid->wifi_network, host_phone->contact_phone, host_email->contact_email, check_out_time->checkout_time, cover_image_url->cover_image, country_code->country, display_order->sort_order on 2 tables, image_url->image), new columns (contact_whatsapp, area, rating, review_count, currency, price_type, in_stock), type change (house_rules TEXT->JSONB), and generated column (type from property_type).
   </done>
   </task>

</tasks>

<verification>
- Migration file exists at `shared/database/migrations/schema/081-schema-api-alignment.sql`
- All column renames from the gap audit are addressed
- All missing columns are added with sensible defaults
- house_rules type change includes safe USING clause for existing data
- No API route files or TypeScript files are modified
</verification>

<success_criteria>

- Migration 081 SQL file contains all ALTER TABLE statements needed to align DB schema with API SELECT strings
- Every column name that API routes SELECT now exists in the corresponding database table
- house_rules will be JSONB (array of strings) instead of TEXT
  </success_criteria>

<output>
After completion, create `.planning/phases/08-schema-api-alignment/08-01-SUMMARY.md`
</output>
