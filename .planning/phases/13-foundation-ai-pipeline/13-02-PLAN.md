---
phase: 13-foundation-ai-pipeline
plan: 02
type: execute
wave: 2
depends_on: ['13-01']
files_modified:
  - apps/backoffice/lib/ai/feedback-intelligence-service.ts
  - apps/backoffice/app/api/feedback/process/route.ts
autonomous: true

must_haves:
  truths:
    - "A submission's original text is translated to English with detected language stored"
    - 'AI returns type, priority, and sentiment classification for any submission'
    - 'Topic tags are extracted from a canonical taxonomy and stored as an array'
    - 'Similar existing tasks are detected via tag overlap + trigram similarity'
    - 'New submissions either link to an existing task or create a new one, with denormalized metrics updated'
    - 'Failed AI calls set status to failed with error details after max retries'
  artifacts:
    - path: 'apps/backoffice/lib/ai/feedback-intelligence-service.ts'
      provides: 'AI processing pipeline for feedback submissions'
      exports: ['processSubmission']
    - path: 'apps/backoffice/app/api/feedback/process/route.ts'
      provides: 'API endpoint to trigger submission processing'
      exports: ['POST']
  key_links:
    - from: 'apps/backoffice/lib/ai/feedback-intelligence-service.ts'
      to: 'apps/backoffice/lib/ai/openai.ts'
      via: 'import getOpenAIClient'
      pattern: 'import.*getOpenAIClient.*from.*openai'
    - from: 'apps/backoffice/lib/ai/feedback-intelligence-service.ts'
      to: 'apps/backoffice/lib/supabase-admin.ts'
      via: 'import supabaseAdmin'
      pattern: 'import.*supabaseAdmin.*from.*supabase-admin'
    - from: 'apps/backoffice/lib/ai/feedback-intelligence-service.ts'
      to: 'find_similar_tasks'
      via: 'supabaseAdmin.rpc call'
      pattern: 'rpc.*find_similar_tasks'
    - from: 'apps/backoffice/app/api/feedback/process/route.ts'
      to: 'apps/backoffice/lib/ai/feedback-intelligence-service.ts'
      via: 'import processSubmission'
      pattern: 'import.*processSubmission'
---

<objective>
Build the AI processing service that takes a pending fb_submission, calls OpenAI to translate/classify/tag it in a single API call, finds similar tasks via the database function, and either links to an existing task or creates a new one. Also create the API route to trigger processing.

Purpose: This is the intelligence engine that turns raw merchant feedback into structured, actionable tasks. Without it, submissions sit unprocessed.
Output: Working `feedback-intelligence-service.ts` and `/api/feedback/process` endpoint.
</objective>

<execution_context>
@/Users/gianfrancodagostino/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gianfrancodagostino/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-foundation-ai-pipeline/13-RESEARCH.md
@.planning/phases/13-foundation-ai-pipeline/13-01-SUMMARY.md

Key references for patterns:
@apps/backoffice/lib/ai/openai.ts
@apps/backoffice/lib/ai/feedback-loop-service.ts
@apps/backoffice/lib/ai/translation-service.ts
@apps/backoffice/lib/supabase-admin.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create feedback intelligence AI service</name>
  <files>apps/backoffice/lib/ai/feedback-intelligence-service.ts</files>
  <action>
Create `feedback-intelligence-service.ts` following existing AI service patterns (see `feedback-loop-service.ts` and `translation-service.ts`).

**Imports:**

```typescript
import { getOpenAIClient, calculateCost } from './openai';
import { supabaseAdmin } from '../supabase-admin';
```

**Canonical tag taxonomy** — define as a const array (~35 tags covering hospitality verticals):
`menu, pricing, service, delivery, ambience, cleanliness, app, ordering, payment, reservation, staff, wait-time, food-quality, portion-size, allergens, hours, location, wifi, parking, accessibility, loyalty, promotions, packaging, temperature, freshness, variety, vegan-options, gluten-free, kids-menu, drinks, desserts, communication, billing, refund, noise, seating, outdoor, pet-friendly`

**ProcessingResult interface:**

```typescript
interface ProcessingResult {
  detected_language: string;
  translated_title: string | null;
  translated_body: string;
  type: string;
  priority: number;
  sentiment: string;
  confidence: number;
  tags: string[];
}
```

**Main function: `processSubmission(submissionId: string): Promise<void>`**

Flow:

1. Fetch submission from fb_submissions by ID using supabaseAdmin
2. Guard: if not found or status not 'pending', return early
3. Update status to 'processing', increment processing_attempts
4. Try:
   a. Call `callAIProcessor(submission)` — single OpenAI call
   b. Call `supabaseAdmin.rpc('find_similar_tasks', { p_merchant_id, p_translated_body, p_tags })` to find matches
   c. If similar task found (score >= 0.5): link to it, call `supabaseAdmin.rpc('update_task_metrics', { p_task_id })`
   d. If no similar task: create new fb_task with title/description/type/priority/tags from AI result, set submission_count=1, languages=[detected_language], avg_sentiment mapped value, first/last_submitted_at = now
   e. Update submission with all AI results + task_id + status='processed' + processed_at
5. Catch: set status to 'failed' if processing_attempts >= 3, otherwise back to 'pending'. Store error message in processing_error.

**Helper: `callAIProcessor(submission): Promise<ProcessingResult>`**

System prompt: "You are a feedback intelligence analyst for a hospitality platform. Given merchant feedback in any language, you must: 1) Translate to English (if not already English), 2) Classify by type, priority, and sentiment, 3) Extract topic tags from this list: [FEEDBACK_TAGS]. Respond with valid JSON only."

User prompt: provide original_title (if exists) and original_body. Request JSON with: detected_language, translated_title, translated_body, type (one of the CHECK values), priority (1-5), sentiment (positive/neutral/negative), confidence (0.0-1.0), tags (array from canonical list, max 5).

OpenAI call parameters:

- model: 'gpt-4o-mini'
- temperature: 0.3
- max_tokens: 800
- response_format: { type: 'json_object' }

Parse response using defensive JSON parsing (strip markdown code blocks, trim). Validate tags against canonical list (filter out any not in the list). Clamp priority to 1-5. Default confidence to 0.5 if missing.

**Helper: `createTask(merchantId, result, submission): Promise<string>`**

Insert into fb_tasks with fields from ProcessingResult. Return the new task ID.

**Helper: `mapSentimentToNumeric(sentiment: string): number`**

positive -> 1.0, neutral -> 0.5, negative -> 0.0

**Export** only `processSubmission` as the public API.
</action>
<verify>
TypeScript compiles: `cd apps/backoffice && npx tsc --noEmit apps/backoffice/lib/ai/feedback-intelligence-service.ts` (or run project-wide typecheck). Verify imports resolve to existing files. Verify the OpenAI call pattern matches existing services.
</verify>
<done>feedback-intelligence-service.ts exports processSubmission(). It fetches a pending submission, calls OpenAI once for translate+classify+tag, finds similar tasks via RPC, links or creates a task, and handles failures with retry logic.</done>
</task>

<task type="auto">
  <name>Task 2: Create API route for triggering submission processing</name>
  <files>apps/backoffice/app/api/feedback/process/route.ts</files>
  <action>
Create a Next.js API route at `apps/backoffice/app/api/feedback/process/route.ts`.

**POST handler:**

1. Parse request body: `{ submissionId: string }` or `{ batch: true }` for processing all pending
2. If `submissionId` provided:
   - Call `processSubmission(submissionId)`
   - Return `{ success: true, submissionId }`
3. If `batch: true`:
   - Query fb_submissions WHERE status = 'pending' AND processing_attempts < 3, ORDER BY created_at ASC, LIMIT 10
   - Process each sequentially (not parallel — avoid OpenAI rate limits)
   - Return `{ success: true, processed: count, failed: count }`
4. Error handling: catch errors, return 500 with `{ error: message }`

**Auth:** For now, require service-level auth or check that the request comes from an authenticated admin. Use the existing auth pattern from other API routes in the backoffice (check for session/token). If the backoffice uses a simple pattern, follow it. If unclear, add a TODO comment for auth and proceed without blocking.

Import `processSubmission` from `@/lib/ai/feedback-intelligence-service`.
Import `supabaseAdmin` from `@/lib/supabase-admin` for the batch query.

Follow existing API route patterns in `apps/backoffice/app/api/` for response format and error handling.
</action>
<verify>
TypeScript compiles without errors. Route file exports POST. Verify import paths are correct relative to the backoffice app structure.
</verify>
<done>POST /api/feedback/process accepts { submissionId } for single processing or { batch: true } for batch processing up to 10 pending submissions. Returns success/failure counts.</done>
</task>

</tasks>

<verification>
- `apps/backoffice/lib/ai/feedback-intelligence-service.ts` exists and exports processSubmission
- `apps/backoffice/app/api/feedback/process/route.ts` exists and exports POST
- TypeScript compiles without errors across the backoffice app
- Service imports getOpenAIClient and supabaseAdmin from correct paths
- Service uses gpt-4o-mini with response_format json_object
- Service calls find_similar_tasks RPC
- Service handles processing failures with retry (max 3 attempts)
- Canonical tag list is defined and used for validation
- API route handles both single and batch processing
</verification>

<success_criteria>
The AI processing pipeline is complete: a pending submission can be processed via API call, resulting in translated text, classification (type/priority/sentiment), tags, and automatic task linkage. Failed processing gracefully retries up to 3 times.
</success_criteria>

<output>
After completion, create `.planning/phases/13-foundation-ai-pipeline/13-02-SUMMARY.md`
</output>
