---
phase: 28-document-upload-visa-tracking
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - shared/database/migrations/schema/091-guest-documents.sql
  - apps/accommodations/frontend/types/stay.ts
  - apps/accommodations/frontend/app/api/stay/[code]/documents/route.ts
  - apps/accommodations/frontend/app/api/stay/[code]/documents/[docId]/route.ts
  - apps/accommodations/frontend/app/api/stay/[code]/documents/upload-url/route.ts
  - apps/accommodations/frontend/app/api/cron/document-lifecycle/route.ts
  - apps/accommodations/frontend/vercel.json
  - apps/accommodations/frontend/lib/stay-api.ts
autonomous: true

must_haves:
  truths:
    - 'API route creates signed upload URL for a verified guest with valid booking'
    - 'API route lists documents for a booking, returning metadata (not storage URLs)'
    - 'API route generates time-limited signed download URL for a specific document'
    - 'API route deletes a document (storage file + soft-delete in DB)'
    - 'Cron job sends visa expiry reminders at configurable intervals (7d, 3d default)'
    - 'Cron job auto-deletes documents and storage files after retention period post-checkout'
    - 'Browse-tier tokens are rejected by all document endpoints (full access required)'
  artifacts:
    - path: 'shared/database/migrations/schema/091-guest-documents.sql'
      provides: 'accom_guest_documents table + storage bucket + indexes'
      contains: 'CREATE TABLE accom_guest_documents'
    - path: 'apps/accommodations/frontend/app/api/stay/[code]/documents/route.ts'
      provides: 'GET (list) + POST (initiate upload) endpoints'
      exports: ['GET', 'POST']
    - path: 'apps/accommodations/frontend/app/api/stay/[code]/documents/[docId]/route.ts'
      provides: 'GET (signed download URL) + DELETE endpoints'
      exports: ['GET', 'DELETE']
    - path: 'apps/accommodations/frontend/app/api/stay/[code]/documents/upload-url/route.ts'
      provides: 'POST endpoint returning signed upload URL'
      exports: ['POST']
    - path: 'apps/accommodations/frontend/app/api/cron/document-lifecycle/route.ts'
      provides: 'Daily cron for reminders + GDPR auto-deletion'
      exports: ['GET']
  key_links:
    - from: 'apps/accommodations/frontend/app/api/stay/[code]/documents/upload-url/route.ts'
      to: "supabase.storage.from('guest-documents').createSignedUploadUrl()"
      via: 'service role client'
      pattern: 'createSignedUploadUrl'
    - from: 'apps/accommodations/frontend/app/api/cron/document-lifecycle/route.ts'
      to: "supabase.storage.from('guest-documents').remove()"
      via: 'service role client deletes storage then soft-deletes DB'
      pattern: 'storage.*remove'
---

<objective>
Create the database schema, Supabase Storage bucket, API routes, and cron job for the document upload and visa tracking system.

Purpose: Provide the complete backend infrastructure that the guest upload UI and owner backoffice viewer will consume. All storage access goes through API routes using service role — no client-side Supabase access.

Output:

- Migration 091 with accom_guest_documents table + private storage bucket
- 3 API route files for document CRUD (list, upload URL, download URL, delete)
- 1 cron job for visa reminders + GDPR auto-deletion
- Updated types and stay-api.ts client functions
  </objective>

<execution_context>
@/Users/gianfrancodagostino/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gianfrancodagostino/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/28-document-upload-visa-tracking/28-CONTEXT.md
@.planning/phases/28-document-upload-visa-tracking/28-RESEARCH.md
@apps/accommodations/frontend/lib/auth.ts
@apps/accommodations/frontend/lib/supabase.ts
@apps/accommodations/frontend/lib/stay-api.ts
@apps/accommodations/frontend/types/stay.ts
@apps/accommodations/frontend/app/api/stay/[code]/route.ts
@apps/accommodations/frontend/app/api/cron/pre-arrival-emails/route.ts
@apps/accommodations/frontend/vercel.json
@shared/database/migrations/schema/090-access-settings.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Database migration + storage bucket + document types</name>
  <files>
    shared/database/migrations/schema/091-guest-documents.sql
    apps/accommodations/frontend/types/stay.ts
  </files>
  <action>
  Create migration 091-guest-documents.sql:

1. Create `accom_guest_documents` table:
   - `id` UUID PRIMARY KEY DEFAULT gen_random_uuid()
   - `booking_id` UUID NOT NULL REFERENCES accom_bookings(id) ON DELETE CASCADE
   - `property_id` UUID NOT NULL REFERENCES accom_properties(id) ON DELETE CASCADE
   - `document_type` TEXT NOT NULL CHECK (document_type IN ('passport', 'visa'))
   - `storage_path` TEXT NOT NULL (path in Supabase Storage bucket)
   - `file_size_bytes` INTEGER
   - `visa_expiry_date` DATE (NULL for passport, required for visa via app logic)
   - `superseded_by` UUID REFERENCES accom_guest_documents(id) (for visa renewals)
   - `consent_given_at` TIMESTAMPTZ NOT NULL
   - `consent_text_hash` TEXT NOT NULL (version tracking hash of consent text shown)
   - `registered_with_authorities` BOOLEAN DEFAULT false
   - `registered_at` TIMESTAMPTZ
   - `reminder_sent_7d` BOOLEAN DEFAULT false
   - `reminder_sent_3d` BOOLEAN DEFAULT false
   - `deleted_at` TIMESTAMPTZ (soft-delete by cron)
   - `created_at` TIMESTAMPTZ NOT NULL DEFAULT NOW()
   - `updated_at` TIMESTAMPTZ NOT NULL DEFAULT NOW()

2. Create indexes:
   - `idx_guest_docs_booking` on (booking_id) WHERE deleted_at IS NULL
   - `idx_guest_docs_property` on (property_id) WHERE deleted_at IS NULL
   - `idx_guest_docs_visa_expiry` on (visa_expiry_date) WHERE document_type = 'visa' AND deleted_at IS NULL AND visa_expiry_date IS NOT NULL
   - `idx_guest_docs_cleanup` on (property_id, deleted_at) WHERE deleted_at IS NULL (for cron GDPR scan)

3. Add `document_retention_days` INTEGER DEFAULT 30 column to `accom_properties` table with CHECK (document_retention_days >= 7 AND document_retention_days <= 90).

4. Add `visa_reminder_days` INTEGER[] DEFAULT '{7,3}' column to `accom_properties` table (configurable reminder intervals).

5. Add `visa_extension_info` TEXT column to `accom_properties` table (optional text shown in reminders if owner has convention with visa offices).

6. Create the private storage bucket via SQL:

   ```sql
   INSERT INTO storage.buckets (id, name, public, file_size_limit, allowed_mime_types)
   VALUES (
     'guest-documents',
     'guest-documents',
     false,
     5242880,
     '{"image/jpeg","image/png","image/webp"}'
   );
   ```

7. Enable RLS on accom_guest_documents. Add policy: service_role has full access (the only accessor via API routes). No anon or authenticated policies needed since guests have no Supabase auth session.

Then update `apps/accommodations/frontend/types/stay.ts`:

- Add `GuestDocument` interface: id, documentType ('passport' | 'visa'), fileName (derived from path), fileSizeBytes, visaExpiryDate (string | null), registeredWithAuthorities, supersededBy (string | null), createdAt
- Add `DocumentUploadRequest` interface: documentType, consentTextHash, visaExpiryDate? (string)
- Add `DocumentUploadResponse` interface: docId (string), signedUrl (string), path (string), token (string)
- Add `DocumentListResponse` interface: documents (GuestDocument[])
- Add `DocumentUrlResponse` interface: signedUrl (string), expiresIn (number)
- Add 'consent_missing' | 'upload_failed' | 'document_not_found' to ApiError union

DO NOT modify existing types — only add new ones at the end of the file.
</action>
<verify>

1. Run: `cat shared/database/migrations/schema/091-guest-documents.sql` — confirm table, indexes, bucket, property columns exist
2. Run: `npx tsc --noEmit -p apps/accommodations/frontend/tsconfig.json 2>&1 | head -20` — confirm no type errors
   </verify>
   <done>
   Migration file creates accom_guest_documents table with all columns, indexes, property retention/reminder columns, private storage bucket. Types file has all document-related interfaces without breaking existing types.
   </done>
   </task>

<task type="auto">
  <name>Task 2: Document API routes + signed upload URL + cron job + stay-api client</name>
  <files>
    apps/accommodations/frontend/app/api/stay/[code]/documents/route.ts
    apps/accommodations/frontend/app/api/stay/[code]/documents/[docId]/route.ts
    apps/accommodations/frontend/app/api/stay/[code]/documents/upload-url/route.ts
    apps/accommodations/frontend/app/api/cron/document-lifecycle/route.ts
    apps/accommodations/frontend/vercel.json
    apps/accommodations/frontend/lib/stay-api.ts
  </files>
  <action>
  **All API routes follow existing patterns:** extract token from Authorization header, verify with `verifyGuestToken()` from `@/lib/auth`, use `getSupabaseAdmin()` for DB/storage, require `requireFullAccess()` for all document operations (documents are PII, browse tier must not access).

**1. POST /api/stay/[code]/documents/upload-url/route.ts**

- Verify guest token, confirm bookingId matches booking_code from URL param
- Accept body: `{ documentType: 'passport' | 'visa', consentTextHash: string, visaExpiryDate?: string }`
- Validate: documentType is valid, consentTextHash is non-empty
- If documentType is 'visa' and visaExpiryDate is missing, return 400
- Generate storage path: `{bookingId}/{documentType}/{Date.now()}.jpg`
- Create signed upload URL: `supabase.storage.from('guest-documents').createSignedUploadUrl(path)`
- Insert DB record with status fields (file_size_bytes will be updated after upload confirm)
- If documentType is 'visa', mark any existing non-superseded visa for this booking as superseded (set superseded_by = new doc id)
- Return: `{ data: { docId, signedUrl: data.signedUrl, path: data.path, token: data.token } }`

**2. GET /api/stay/[code]/documents/route.ts**

- Verify guest token, confirm booking
- Query accom_guest_documents WHERE booking_id = bookingId AND deleted_at IS NULL, ordered by created_at DESC
- Return: `{ data: { documents: GuestDocument[] } }` — map DB rows to GuestDocument interface (extract filename from storage_path)

**3. POST /api/stay/[code]/documents/route.ts** (confirm upload)

- Verify guest token
- Accept body: `{ docId: string, fileSizeBytes: number }`
- Update the document record with file_size_bytes
- Return: `{ data: { success: true } }`

**4. GET /api/stay/[code]/documents/[docId]/route.ts**

- Verify guest token, confirm booking owns the document
- Query document by id, verify booking_id matches
- Generate signed URL: `supabase.storage.from('guest-documents').createSignedUrl(doc.storage_path, 300)` (5 min expiry)
- Return: `{ data: { signedUrl, expiresIn: 300 } }`

**5. DELETE /api/stay/[code]/documents/[docId]/route.ts**

- Verify guest token, confirm booking owns the document
- Delete from storage first: `supabase.storage.from('guest-documents').remove([doc.storage_path])`
- Then soft-delete in DB: UPDATE SET deleted_at = NOW()
- Return: `{ data: { success: true } }`

**6. GET /api/cron/document-lifecycle/route.ts**

- Verify CRON_SECRET (same pattern as pre-arrival-emails)
- `export const dynamic = 'force-dynamic';`
- **Part A — Visa Reminders:**
  - Query all properties with their visa_reminder_days
  - For each reminder interval (e.g., 7 days, 3 days):
    - Find visa documents WHERE: visa_expiry_date = CURRENT_DATE + interval days, deleted_at IS NULL, superseded_by IS NULL, AND the corresponding reminder_sent flag is false
    - For each found document: mark reminder_sent flag as true in DB
    - Log count of reminders triggered (actual notification delivery is handled by frontend in-app alerts via the document list response — the cron just marks the flag so the dashboard knows to show the alert prominently)
- **Part B — GDPR Auto-Delete:**
  - Query: SELECT d._ FROM accom_guest_documents d JOIN accom_bookings b ON d.booking_id = b.id JOIN accom_properties p ON d.property_id = p.id WHERE d.deleted_at IS NULL AND b.check_out_date + COALESCE(p.document_retention_days, 30) _ INTERVAL '1 day' < CURRENT_DATE
  - For each document: delete from storage FIRST (`supabase.storage.from('guest-documents').remove([d.storage_path])`), then soft-delete in DB (SET deleted_at = NOW())
  - If storage delete fails, skip that record (retry next cron run), log error
  - Return JSON summary: `{ reminders: { sent: N }, deletions: { processed: N, deleted: N, failed: N } }`

**7. Update vercel.json:** Add second cron entry:

```json
{
  "path": "/api/cron/document-lifecycle",
  "schedule": "0 9 * * *"
}
```

**8. Update lib/stay-api.ts:** Add client functions following existing pattern:

- `requestDocumentUploadUrl(code, token, body: DocumentUploadRequest)` → POST to upload-url route
- `confirmDocumentUpload(code, token, body: { docId, fileSizeBytes })` → POST to documents route
- `fetchDocuments(code, token)` → GET documents route
- `fetchDocumentUrl(code, token, docId)` → GET documents/[docId] route
- `deleteDocument(code, token, docId)` → DELETE documents/[docId] route

Use `postStayAPI` and `fetchStayAPI` helpers already in stay-api.ts. Add a `deleteStayAPI` helper (similar to postStayAPI but with DELETE method).
</action>
<verify>

1. Run: `npx tsc --noEmit -p apps/accommodations/frontend/tsconfig.json 2>&1 | head -30` — confirm no type errors
2. Verify all route files exist: `ls apps/accommodations/frontend/app/api/stay/\[code\]/documents/ apps/accommodations/frontend/app/api/cron/document-lifecycle/`
3. Verify vercel.json has 2 cron entries: `cat apps/accommodations/frontend/vercel.json | grep -c "schedule"`
4. Verify stay-api.ts has new functions: `grep -c "document\|Document" apps/accommodations/frontend/lib/stay-api.ts`
   </verify>
   <done>
   All 5 API routes created (upload-url, list, confirm, download-url, delete). Cron job handles visa reminders + GDPR auto-deletion. Vercel cron configured. Client API functions added to stay-api.ts. Full access required on all endpoints. TypeScript compiles without errors.
   </done>
   </task>

</tasks>

<verification>
1. TypeScript compilation: `npx tsc --noEmit -p apps/accommodations/frontend/tsconfig.json` passes with 0 errors
2. Migration file: 091-guest-documents.sql has CREATE TABLE, indexes, bucket INSERT, property columns
3. All API routes: exist and export correct HTTP methods
4. Cron: vercel.json has 2 cron entries (pre-arrival-emails + document-lifecycle)
5. Types: GuestDocument, DocumentUploadRequest, DocumentUploadResponse, DocumentListResponse, DocumentUrlResponse all defined
6. Client: stay-api.ts has 5 new document functions
</verification>

<success_criteria>

- Migration 091 creates complete schema for document upload system
- API routes enforce full-access-only via requireFullAccess()
- Signed upload URL pattern bypasses Vercel 4.5MB body limit
- Cron job handles both visa reminders and GDPR deletion in single endpoint
- Storage deletion happens BEFORE DB soft-delete (fail-safe order)
- All new code compiles without TypeScript errors
  </success_criteria>

<output>
After completion, create `.planning/phases/28-document-upload-visa-tracking/28-01-SUMMARY.md`
</output>
