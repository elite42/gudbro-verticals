---
phase: 32-owner-dashboard-enhancements
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - shared/database/migrations/schema/094-property-data-onboarding.sql
  - apps/backoffice/app/api/accommodations/property/route.ts
  - apps/backoffice/app/(dashboard)/accommodations/settings/page.tsx
  - apps/backoffice/components/accommodations/StructuredPolicies.tsx
  - apps/backoffice/components/accommodations/PropertyDataForm.tsx
  - apps/backoffice/components/accommodations/OnboardingWizard.tsx
  - apps/backoffice/app/(dashboard)/accommodations/onboarding/page.tsx
  - apps/backoffice/app/(dashboard)/accommodations/page.tsx
autonomous: true

must_haves:
  truths:
    - 'Owner can select house rules from checkboxes and add custom rules'
    - 'Owner can choose cancellation policy from a dropdown (flexible/moderate/strict/non_refundable)'
    - 'Owner can save social links, Google Maps URL, communication methods, operating hours, and staff languages'
    - 'New property owners see an onboarding wizard with step-by-step setup'
    - 'Existing configured properties skip the onboarding wizard automatically'
  artifacts:
    - path: 'shared/database/migrations/schema/094-property-data-onboarding.sql'
      provides: 'New property columns: social_links, google_maps_url, communication_methods, operating_hours, staff_languages, onboarding_progress'
      contains: 'social_links'
    - path: 'apps/backoffice/components/accommodations/StructuredPolicies.tsx'
      provides: 'Checkbox house rules + dropdown cancellation policy'
      min_lines: 60
    - path: 'apps/backoffice/components/accommodations/PropertyDataForm.tsx'
      provides: 'Social links, Google Maps, communication, hours, languages form'
      min_lines: 80
    - path: 'apps/backoffice/components/accommodations/OnboardingWizard.tsx'
      provides: 'Multi-step wizard with DB-persisted progress'
      min_lines: 100
  key_links:
    - from: 'apps/backoffice/app/(dashboard)/accommodations/settings/page.tsx'
      to: 'StructuredPolicies component'
      via: 'import and render in policies section'
      pattern: 'StructuredPolicies'
    - from: 'apps/backoffice/app/(dashboard)/accommodations/settings/page.tsx'
      to: 'PropertyDataForm component'
      via: 'import and render as new section'
      pattern: 'PropertyDataForm'
    - from: 'apps/backoffice/app/api/accommodations/property/route.ts'
      to: 'new property columns'
      via: 'allowedFields whitelist updated'
      pattern: 'social_links.*google_maps_url.*communication_methods'
    - from: 'OnboardingWizard.tsx'
      to: '/api/accommodations/property'
      via: 'PATCH onboarding_progress on step completion'
      pattern: 'onboarding_progress'
---

<objective>
Build the onboarding wizard, structured policies form, and complete property data management for the owner dashboard.

Purpose: New property owners need guided setup to configure their property correctly. Structured policies (checkboxes instead of free text) produce consistent, translatable house rules. Complete property data (social links, hours, languages) makes the property listing professional and informative.
Output: OnboardingWizard component, StructuredPolicies component, PropertyDataForm component, migration for new columns, settings page restructured.
</objective>

<execution_context>
@/Users/gianfrancodagostino/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gianfrancodagostino/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/32-owner-dashboard-enhancements/32-RESEARCH.md

Key existing files:
@apps/backoffice/app/(dashboard)/accommodations/settings/page.tsx
@apps/backoffice/app/api/accommodations/property/route.ts
@apps/backoffice/components/onboarding/OnboardingChecklist.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migration + Property API + Structured Policies + Property Data Form</name>
  <files>
    shared/database/migrations/schema/094-property-data-onboarding.sql
    apps/backoffice/app/api/accommodations/property/route.ts
    apps/backoffice/components/accommodations/StructuredPolicies.tsx
    apps/backoffice/components/accommodations/PropertyDataForm.tsx
    apps/backoffice/app/(dashboard)/accommodations/settings/page.tsx
  </files>
  <action>
    1. Create migration 094-property-data-onboarding.sql:
       ```sql
       -- 094: Property data fields + onboarding progress (Phase 32)
       ALTER TABLE accom_properties
         ADD COLUMN IF NOT EXISTS social_links JSONB DEFAULT '{}',
         ADD COLUMN IF NOT EXISTS google_maps_url TEXT,
         ADD COLUMN IF NOT EXISTS communication_methods TEXT[] DEFAULT '{}',
         ADD COLUMN IF NOT EXISTS operating_hours JSONB DEFAULT '{}',
         ADD COLUMN IF NOT EXISTS staff_languages TEXT[] DEFAULT '{"en"}',
         ADD COLUMN IF NOT EXISTS onboarding_progress JSONB DEFAULT NULL;

       -- Add comments for documentation
       COMMENT ON COLUMN accom_properties.social_links IS 'JSONB: { instagram: "url", facebook: "url", tiktok: "url", website: "url" }';
       COMMENT ON COLUMN accom_properties.communication_methods IS 'TEXT[]: whatsapp, zalo, telegram, line, email, phone';
       COMMENT ON COLUMN accom_properties.operating_hours IS 'JSONB: { reception: { open: "08:00", close: "22:00" }, restaurant: { open: "07:00", close: "21:00" } }';
       COMMENT ON COLUMN accom_properties.onboarding_progress IS 'JSONB: { completed_steps: [], current_step: null, started_at: null, completed_at: null }';
       ```

    2. Update property API route (apps/backoffice/app/api/accommodations/property/route.ts):
       - GET: Add new fields to select string: `social_links, google_maps_url, communication_methods, operating_hours, staff_languages, onboarding_progress` (append after `wifi_zones`).
       - PUT: Add to allowedFields array: `'social_links', 'google_maps_url', 'communication_methods', 'operating_hours', 'staff_languages', 'onboarding_progress'`, `'name'`, `'description'`, `'address'`, `'city'`, `'host_name'`, `'amenities'`. (Also add name/description/address/city/host_name/amenities since the onboarding wizard and property data form need to save these basic fields too -- they are currently NOT in allowedFields.)

    3. Create StructuredPolicies.tsx:
       - Props: houseRules (string[]), cancellationPolicy (string | null), onChange (callback with { houseRules: string[], cancellationPolicy: string }).
       - Predefined COMMON_HOUSE_RULES array:
         'No smoking indoors', 'No pets allowed', 'Quiet hours: 22:00-08:00', 'No parties or events', 'Remove shoes indoors', 'No outside guests overnight', 'Keep common areas clean', 'Separate trash and recycling'.
       - Render each as a checkbox. Checked = included in houseRules array.
       - "Add custom rule" input + button at the bottom to add free-text rules.
       - Custom rules show as removable tags/chips below the checkboxes.
       - Cancellation policy dropdown with 4 options: flexible ("Free cancellation up to 24h before"), moderate ("Free cancellation up to 7 days before"), strict ("50% refund up to 14 days before"), non_refundable ("No refunds after booking").
       - Use native `<select>` (only 4 options, Radix overkill).
       - The component does NOT save directly -- it calls onChange so the parent (settings page) batches the save.

    4. Create PropertyDataForm.tsx:
       - Props: socialLinks (object), googleMapsUrl (string), communicationMethods (string[]), operatingHours (object), staffLanguages (string[]), onChange (callback).
       - Social links section: text inputs for Instagram, Facebook, TikTok, Website URLs. Use Phosphor icons (InstagramLogo, FacebookLogo, TiktokLogo, Globe) next to each input.
       - Google Maps URL: single text input with MapPin icon. Placeholder: "Paste Google Maps link".
       - Communication methods: checkboxes for WhatsApp, Zalo, Telegram, Line, Email, Phone. Multiple selection.
       - Operating hours: simple open/close time inputs for "Reception" and "Restaurant" (optional). Use time input type.
       - Staff languages: multi-select checkboxes for common SEA languages: English, Vietnamese, Korean, Japanese, Chinese, Thai, French, German, Spanish. Plus "Add other" text input.
       - Component calls onChange on any field change (parent batches save).

    5. Restructure settings page (apps/backoffice/app/(dashboard)/accommodations/settings/page.tsx):
       - Replace the existing Policies section (textarea-based) with the StructuredPolicies component.
       - Add a new "Property Information" section using PropertyDataForm component.
       - Add state for the new fields (socialLinks, googleMapsUrl, communicationMethods, operatingHours, staffLanguages).
       - Load new fields from property data in useEffect.
       - Include new fields in the save handler (handleSave).
       - Section order: Booking Configuration, WiFi Zones, Financial, Policies (now structured), Property Information (new), Contact.

  </action>
  <verify>
    - `npx tsc --noEmit -p apps/backoffice/tsconfig.json` passes without errors
    - Settings page shows checkbox house rules instead of textarea
    - Settings page shows cancellation policy dropdown
    - Settings page shows Property Information section with social links, maps, languages, hours
    - Property API GET returns new fields, PUT accepts new fields
  </verify>
  <done>
    - House rules use checkbox selection + custom additions (backward-compatible JSONB array)
    - Cancellation policy uses dropdown matching DB CHECK constraint values
    - Property data form covers social links, Google Maps, communication methods, hours, languages
    - All new fields persist via property API with updated allowedFields
  </done>
</task>

<task type="auto">
  <name>Task 2: Onboarding wizard with DB-persisted progress and skip logic</name>
  <files>
    apps/backoffice/components/accommodations/OnboardingWizard.tsx
    apps/backoffice/app/(dashboard)/accommodations/onboarding/page.tsx
    apps/backoffice/app/(dashboard)/accommodations/page.tsx
  </files>
  <action>
    1. Create OnboardingWizard.tsx:
       - Props: propertyId (string), property (object with name, onboarding_progress, and room_count or similar indicators).
       - WIZARD_STEPS constant array:
         { id: 'basic_info', label: 'Basic Info', icon: Buildings, required: true },
         { id: 'photos', label: 'Photos', icon: Camera, required: false },
         { id: 'rooms', label: 'Rooms', icon: Bed, required: true },
         { id: 'wifi', label: 'WiFi', icon: WifiHigh, required: false },
         { id: 'services', label: 'Services', icon: Tray, required: false },
         { id: 'contact', label: 'Contact', icon: Phone, required: true }
       - State: currentStep (string), completedSteps (string[]).
       - Initialize from property.onboarding_progress if it exists.
       - Step progress bar at top: horizontal dots/circles with labels, current step highlighted, completed steps get checkmark.
       - Each step renders a targeted form/section:
         - basic_info: name, description, address, city, property_type fields (re-use patterns from settings page)
         - photos: message linking to property images section (Phase 31 built image upload). Show "Upload photos in Property Settings" with link.
         - rooms: embed the RoomManager component (import from existing).
         - wifi: embed the WiFi zones section (extract from settings page or link to it).
         - services: message about setting up services later with link to services page.
         - contact: contact phone, whatsapp, email fields.
       - "Next" and "Back" buttons at bottom. "Skip" for optional steps.
       - On step completion (Next clicked), call property API PUT to update onboarding_progress:
         ```json
         {
           "onboarding_progress": {
             "completed_steps": ["basic_info", "rooms"],
             "current_step": "wifi",
             "started_at": "2026-02-01T10:00:00Z",
             "completed_at": null
           }
         }
         ```
       - On final step completion, set completed_at to current timestamp.
       - The wizard saves step data (name, contact info, etc.) via the same property API PUT.

    2. Create onboarding page (apps/backoffice/app/(dashboard)/accommodations/onboarding/page.tsx):
       - Full page at `/accommodations/onboarding`.
       - Fetch property data on mount.
       - Render OnboardingWizard component.
       - Back link to accommodations dashboard.
       - If property already has onboarding completed (onboarding_progress.completed_at is set), redirect to dashboard with a "Setup already complete" message.

    3. Modify accommodations dashboard page (apps/backoffice/app/(dashboard)/accommodations/page.tsx):
       - Read the existing page first to understand current structure.
       - Add shouldShowWizard logic:
         ```
         function shouldShowWizard(property): boolean {
           if (property.onboarding_progress?.completed_at) return false;
           const hasRooms = (property.room_count || 0) > 0;  // may need to check differently
           const hasName = !!property.name && property.name !== 'My Property';
           const hasContact = !!property.contact_phone || !!property.contact_email;
           return !(hasRooms && hasName && hasContact);
         }
         ```
       - If shouldShowWizard returns true, show a prominent banner at the top of the dashboard:
         "Complete your property setup" with a progress indicator (X of 6 steps done) and a "Continue Setup" button linking to `/accommodations/onboarding`.
       - The banner uses blue/indigo styling, not blocking -- owner can dismiss or ignore it.
       - For existing properties where onboarding_progress is NULL but property IS configured (has rooms, name, contact), the banner should NOT show (the shouldShowWizard logic handles this).

  </action>
  <verify>
    - `npx tsc --noEmit -p apps/backoffice/tsconfig.json` passes without errors
    - `/accommodations/onboarding` page renders the wizard with step progress bar
    - Completing a step updates onboarding_progress via API
    - Configured properties do NOT show the onboarding banner
    - Unconfigured properties show "Complete your property setup" banner on dashboard
  </verify>
  <done>
    - OnboardingWizard guides new owners through 6 steps (basic_info, photos, rooms, wifi, services, contact)
    - Progress persisted in DB via onboarding_progress JSONB column
    - Skip logic: existing configured properties never see the wizard
    - Dashboard shows setup banner for unconfigured properties only
    - Wizard saves property data on each step via existing property API
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation: `npx tsc --noEmit -p apps/backoffice/tsconfig.json` -- zero errors
2. Build check: `cd apps/backoffice && npx next build` -- successful build
3. Visual: Settings page shows structured policies (checkboxes + dropdown) instead of textareas
4. Visual: Settings page shows Property Information section
5. Visual: Onboarding wizard renders at /accommodations/onboarding with step progress
6. Functional: Saving structured house rules persists as JSONB array (backward-compatible)
7. Functional: Onboarding progress persists in DB across page refreshes
</verification>

<success_criteria>

- House rules use checkbox selection with predefined common rules + custom additions
- Cancellation policy uses dropdown (flexible/moderate/strict/non_refundable)
- Property data form allows saving social links, Google Maps, communication methods, hours, languages
- New property owners see onboarding wizard with 6-step guided setup
- Existing configured properties skip wizard automatically (no banner, no redirect)
- All property data changes save via existing property API with updated allowedFields
  </success_criteria>

<output>
After completion, create `.planning/phases/32-owner-dashboard-enhancements/32-02-SUMMARY.md`
</output>
