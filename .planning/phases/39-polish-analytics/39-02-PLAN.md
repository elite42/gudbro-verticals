---
phase: 39-polish-analytics
plan: 02
type: execute
wave: 2
depends_on: [39-01]
files_modified:
  - apps/backoffice/app/(dashboard)/accommodations/settings/page.tsx
  - apps/backoffice/app/api/accommodations/property/route.ts
  - apps/accommodations/frontend/types/stay.ts
  - apps/accommodations/frontend/app/api/stay/[code]/orders/route.ts
  - apps/accommodations/frontend/components/stay/ReceiptView.tsx
  - apps/accommodations/frontend/components/stay/OrderDetailSheet.tsx
autonomous: true

must_haves:
  truths:
    - 'Owner can toggle receipt confirmation on/off in Settings'
    - 'Guest can view and optionally confirm a receipt for delivered orders in the PWA'
    - 'Receipts auto-confirm after a configurable timeout (default 24h)'
  artifacts:
    - path: 'apps/backoffice/app/(dashboard)/accommodations/settings/page.tsx'
      provides: 'Receipt toggle and auto-confirm hours input in property settings'
      contains: 'receipt_enabled'
    - path: 'apps/accommodations/frontend/components/stay/ReceiptView.tsx'
      provides: 'Guest receipt view with itemized charges, payment method, and confirm button'
      min_lines: 60
  key_links:
    - from: 'ReceiptView.tsx'
      to: 'orders/route.ts (PATCH)'
      via: 'Guest confirms receipt via PATCH with orderId'
      pattern: 'receipt_confirmed_at|confirmReceipt'
    - from: 'settings/page.tsx'
      to: 'property/route.ts'
      via: 'Settings form saves receipt_enabled and receipt_auto_confirm_hours'
      pattern: 'receipt_enabled|receipt_auto_confirm_hours'
---

<objective>
Build guest receipt confirmation: settings toggle in backoffice, guest receipt view in PWA with confirm action, and PATCH endpoint for receipt confirmation.

Purpose: SVC-08 (guest receipt confirmation) — guests can review and confirm itemized receipts for delivered orders, with optional auto-confirm timeout.
Output: Receipt settings toggle in backoffice, PATCH endpoint for receipt confirmation, ReceiptView component in guest PWA.
</objective>

<execution_context>
@/Users/gianfrancodagostino/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gianfrancodagostino/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/39-polish-analytics/39-01-SUMMARY.md

Key source files:
@apps/backoffice/app/(dashboard)/accommodations/settings/page.tsx
@apps/backoffice/app/api/accommodations/property/route.ts
@apps/accommodations/frontend/types/stay.ts
@apps/accommodations/frontend/app/api/stay/[code]/orders/route.ts
@apps/accommodations/frontend/components/stay/OrderDetailSheet.tsx
@apps/accommodations/frontend/components/stay/OrderListView.tsx
@apps/accommodations/frontend/lib/auth.ts

Pre-explored findings:

- Migration 101 (from Plan 01) adds `receipt_enabled` and `receipt_auto_confirm_hours` columns to `accom_properties`, and `receipt_confirmed_at` and `receipt_auto_confirm_at` to `accom_service_orders`.
- Guest PWA auth: `authenticateGuest(request)` extracts Bearer JWT from Authorization header, calls `verifyGuestToken(token)` from `@/lib/auth`. Returns `GuestTokenPayload` with `{ bookingId, propertyId, checkoutDate, accessTier, roomCode }`. Full access check: `requireFullAccess(guest)`.
- Guest orders route (`apps/accommodations/frontend/app/api/stay/[code]/orders/route.ts`) has GET and POST handlers. No PATCH exists yet. The `authenticateGuest()` helper is defined at the top of the file (lines 11-23) and reusable.
- Backoffice property API: `apps/backoffice/app/api/accommodations/property/route.ts` — uses `validateAdminApiKey(request)` auth.
- Order items have `category_tag` on `accom_service_order_items` (not on orders table).
- The `mapOrder()` function in orders/route.ts builds the ServiceOrder response including items with prices.
  </context>

<tasks>

<task type="auto">
  <name>Task 1: Receipt settings toggle in backoffice + property API</name>
  <files>
    apps/backoffice/app/(dashboard)/accommodations/settings/page.tsx
    apps/backoffice/app/api/accommodations/property/route.ts
  </files>
  <action>
**property/route.ts — Add receipt columns to GET and PUT:**

Read the file first.

In GET handler, add `receipt_enabled, receipt_auto_confirm_hours` to the SELECT string.

In PUT handler (or PATCH — read to determine), add `receipt_enabled` and `receipt_auto_confirm_hours` to the list of accepted update fields.

**settings/page.tsx — Add Receipt Confirmation section:**

Read the file first. Add a new section (find appropriate location — after financial settings or at end of sections).

1. Add state variables:

```typescript
const [receiptEnabled, setReceiptEnabled] = useState(false);
const [receiptAutoConfirmHours, setReceiptAutoConfirmHours] = useState(24);
```

2. Load from property data (in the existing load/fetch function):

```typescript
setReceiptEnabled(p.receipt_enabled || false);
setReceiptAutoConfirmHours(p.receipt_auto_confirm_hours ?? 24);
```

3. Include in save payload:

```typescript
receipt_enabled: receiptEnabled,
receipt_auto_confirm_hours: receiptAutoConfirmHours,
```

4. Add the UI section:

```tsx
{
  /* Receipt Confirmation (SVC-08) */
}
<section className="rounded-xl border border-gray-200 bg-white p-6">
  <h2 className="mb-4 text-lg font-semibold text-gray-900">Guest Receipts</h2>
  <p className="mb-4 text-sm text-gray-500">
    When enabled, guests can review and confirm itemized receipts for delivered
    orders. Receipts auto-confirm after the timeout period.
  </p>

  {/* Toggle */}
  <div className="mb-4 flex items-center justify-between">
    <div>
      <p className="font-medium text-gray-900">Enable receipt confirmation</p>
      <p className="text-sm text-gray-500">
        Guests will see a "Confirm Receipt" button after delivery
      </p>
    </div>
    <button
      type="button"
      role="switch"
      aria-checked={receiptEnabled}
      onClick={() => setReceiptEnabled(!receiptEnabled)}
      className={`relative inline-flex h-6 w-11 items-center rounded-full transition-colors ${
        receiptEnabled ? 'bg-blue-600' : 'bg-gray-200'
      }`}
    >
      <span
        className={`inline-block h-4 w-4 transform rounded-full bg-white transition-transform ${
          receiptEnabled ? 'translate-x-6' : 'translate-x-1'
        }`}
      />
    </button>
  </div>

  {/* Auto-confirm timeout (only visible when enabled) */}
  {receiptEnabled && (
    <div>
      <label className="mb-1 block text-sm font-medium text-gray-700">
        Auto-confirm after (hours)
      </label>
      <input
        type="number"
        min={1}
        max={168}
        value={receiptAutoConfirmHours}
        onChange={(e) =>
          setReceiptAutoConfirmHours(parseInt(e.target.value) || 24)
        }
        className="w-32 rounded-lg border border-gray-300 px-3 py-2 focus:border-blue-500 focus:ring-2 focus:ring-blue-500"
      />
      <p className="mt-1 text-xs text-gray-500">
        If the guest doesn&apos;t confirm, the receipt auto-confirms after this
        period (1-168 hours)
      </p>
    </div>
  )}
</section>;
```

Also update the `PropertySettings` interface (or equivalent type) at the top to include:

```typescript
receipt_enabled: boolean;
receipt_auto_confirm_hours: number;
```

  </action>
  <verify>
  TypeScript compilation: `cd apps/backoffice && npx tsc --noEmit --pretty 2>&1 | head -30`
  Verify receipt toggle in settings: `grep 'receipt_enabled\|receiptEnabled\|Guest Receipts' apps/backoffice/app/\(dashboard\)/accommodations/settings/page.tsx`
  Verify property API includes receipt fields: `grep 'receipt_enabled\|receipt_auto_confirm_hours' apps/backoffice/app/api/accommodations/property/route.ts`
  </verify>
  <done>
  Receipt configuration added to property settings. Owner can toggle receipt confirmation and set auto-confirm timeout. Property API reads and writes the new fields.
  </done>
</task>

<task type="auto">
  <name>Task 2: Guest receipt view + confirm action in PWA</name>
  <files>
    apps/accommodations/frontend/types/stay.ts
    apps/accommodations/frontend/app/api/stay/[code]/orders/route.ts
    apps/accommodations/frontend/components/stay/ReceiptView.tsx
    apps/accommodations/frontend/components/stay/OrderDetailSheet.tsx
  </files>
  <action>
**types/stay.ts — Extend ServiceOrder:**

Add to the `ServiceOrder` interface:

```typescript
receiptConfirmedAt: string | null;
receiptAutoConfirmAt: string | null;
paymentMethod: string;
```

**orders/route.ts — Add receipt fields to GET + new PATCH handler:**

1. In the GET handler's SELECT string (line ~99-104), add: `receipt_confirmed_at, receipt_auto_confirm_at, payment_method`

2. In the `mapOrder()` function (lines ~49-79), add to the returned ServiceOrder object:

```typescript
receiptConfirmedAt: (row.receipt_confirmed_at as string) || null,
receiptAutoConfirmAt: (row.receipt_auto_confirm_at as string) || null,
paymentMethod: (row.payment_method as string) || 'room_charge',
```

3. Add a new PATCH handler for receipt confirmation. Auth pattern: reuse the existing `authenticateGuest()` function defined at the top of this file (lines 11-23), which extracts Bearer JWT and calls `verifyGuestToken(token)`.

```typescript
export async function PATCH(request: NextRequest) {
  try {
    const guest = await authenticateGuest(request);
    if (!guest) {
      return NextResponse.json<ApiResponse<null>>(
        { error: 'session_expired' },
        { status: 401 }
      );
    }

    // Require full-tier access
    if (!requireFullAccess(guest)) {
      return NextResponse.json<ApiResponse<null>>(
        { error: 'verification_required' },
        { status: 403 }
      );
    }

    const body = (await request.json()) as { orderId: string };
    if (!body.orderId) {
      return NextResponse.json<ApiResponse<null>>(
        { error: 'Missing orderId' },
        { status: 400 }
      );
    }

    const supabase = getSupabaseAdmin();

    // Verify order belongs to this booking and is delivered
    const { data: order, error: orderError } = await supabase
      .from('accom_service_orders')
      .select('id, status, booking_id, receipt_confirmed_at')
      .eq('id', body.orderId)
      .eq('booking_id', guest.bookingId)
      .single();

    if (orderError || !order) {
      return NextResponse.json<ApiResponse<null>>(
        { error: 'Order not found' },
        { status: 404 }
      );
    }

    if (order.status !== 'delivered') {
      return NextResponse.json<ApiResponse<null>>(
        { error: 'Only delivered orders can be confirmed' },
        { status: 400 }
      );
    }

    if (order.receipt_confirmed_at) {
      return NextResponse.json<ApiResponse<null>>(
        { error: 'Receipt already confirmed' },
        { status: 400 }
      );
    }

    // Update receipt_confirmed_at
    const { error: updateError } = await supabase
      .from('accom_service_orders')
      .update({ receipt_confirmed_at: new Date().toISOString() })
      .eq('id', body.orderId);

    if (updateError) {
      console.error(
        'PATCH /api/stay/[code]/orders receipt confirm error:',
        updateError
      );
      return NextResponse.json<ApiResponse<null>>(
        { error: 'internal_error' },
        { status: 500 }
      );
    }

    return NextResponse.json<ApiResponse<{ confirmed: true }>>({
      data: { confirmed: true },
    });
  } catch (err) {
    console.error('PATCH /api/stay/[code]/orders error:', err);
    return NextResponse.json<ApiResponse<null>>(
      { error: 'internal_error' },
      { status: 500 }
    );
  }
}
```

**ReceiptView.tsx (NEW):**

Props:

```typescript
interface ReceiptViewProps {
  order: ServiceOrder;
  currency: string;
  propertyName: string;
  onConfirm: () => void;
  isConfirming: boolean;
}
```

Layout:

- Clean receipt-like appearance with dotted/dashed separators
- Property name at top center
- "RECEIPT" label
- Order short ID + date/time
- Items listed: quantity x name, price aligned right
- Subtotal, Tax, TOTAL with currency
- Payment method label (e.g. "Room Charge")
- If `receiptConfirmedAt` is set: green CheckCircle icon "Confirmed on [date]"
- If not confirmed: "Confirm Receipt" button (teal/accent color)
- Below button: "Auto-confirms [relative time]" in muted text
- If `receiptAutoConfirmAt` has passed: treat as auto-confirmed, show "Auto-confirmed"
- Use same `formatPrice` utility (or replicate price formatting from OrderDetailSheet)
- Import `CheckCircle` from `@phosphor-icons/react`

**OrderDetailSheet.tsx — Integrate ReceiptView:**

Read the file first. For delivered orders where `receiptAutoConfirmAt` is not null (meaning receipts are enabled):

1. Add `propertyName`, `bookingCode`, `token`, and `onOrderUpdated` to `OrderDetailSheetProps`. Read OrderListView to understand how OrderDetailSheet is currently instantiated and pass these new props from the parent.

2. Add receipt confirm handler:

```typescript
const [confirmingReceipt, setConfirmingReceipt] = useState(false);

async function handleConfirmReceipt() {
  if (!order) return;
  setConfirmingReceipt(true);
  try {
    const res = await fetch(`/api/stay/${bookingCode}/orders`, {
      method: 'PATCH',
      headers: {
        'Content-Type': 'application/json',
        Authorization: `Bearer ${token}`,
      },
      body: JSON.stringify({ orderId: order.id }),
    });
    if (res.ok) {
      onOrderUpdated?.();
    }
  } finally {
    setConfirmingReceipt(false);
  }
}
```

3. Render ReceiptView at the bottom of the sheet for delivered orders with receipt enabled:

```tsx
{
  order.status === 'delivered' && order.receiptAutoConfirmAt && (
    <div className="mt-4 border-t border-gray-100 pt-4">
      <ReceiptView
        order={order}
        currency={currency}
        propertyName={propertyName}
        onConfirm={handleConfirmReceipt}
        isConfirming={confirmingReceipt}
      />
    </div>
  );
}
```

4. The `bookingCode` and `token` need to come from the parent context. Check how OrderListView renders OrderDetailSheet and update the parent to pass these through. The token is typically stored in a context or passed down from the stay page layout.
   </action>
   <verify>
   TypeScript compilation: `cd apps/accommodations/frontend && npx tsc --noEmit --pretty 2>&1 | head -40`
   Verify ReceiptView exists: `ls apps/accommodations/frontend/components/stay/ReceiptView.tsx`
   Verify receipt fields in types: `grep 'receiptConfirmedAt\|receiptAutoConfirmAt\|paymentMethod' apps/accommodations/frontend/types/stay.ts`
   Verify PATCH handler: `grep 'PATCH\|receipt_confirmed_at' apps/accommodations/frontend/app/api/stay/\[code\]/orders/route.ts`
   Verify ReceiptView in OrderDetailSheet: `grep 'ReceiptView' apps/accommodations/frontend/components/stay/OrderDetailSheet.tsx`
   State contract check: existing OrderListView and OrderDetailSheet functionality preserved (all existing props still passed, no removed UI)
   </verify>
   <done>
   Guest receipt view implemented. Delivered orders show itemized receipt with confirm button. PATCH endpoint handles receipt confirmation. Auto-confirm timing displayed from delivery timestamp + property timeout.
   </done>
   </task>

</tasks>

<verification>
1. `cd apps/backoffice && npx tsc --noEmit` -- zero errors
2. `cd apps/accommodations/frontend && npx tsc --noEmit` -- zero errors
3. Settings page has receipt toggle and auto-confirm hours input
4. Property API reads/writes receipt_enabled and receipt_auto_confirm_hours
5. Guest PWA shows receipt view for delivered orders with confirm button
6. Guest receipt confirmation PATCH updates receipt_confirmed_at
7. Auto-confirm logic: receipt_auto_confirm_at shown as countdown, treated as confirmed when passed
</verification>

<success_criteria>

- Owner can toggle receipt confirmation on/off in Settings with configurable auto-confirm timeout
- Guest can view itemized receipt for delivered orders in PWA and confirm it
- Receipt auto-confirms after owner-configured timeout (default 24h)
- TypeScript compiles for both backoffice and accommodations frontend
  </success_criteria>

<output>
After completion, create `.planning/phases/39-polish-analytics/39-02-SUMMARY.md`
</output>
