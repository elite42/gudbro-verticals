---
phase: 34-service-expansion-minibar
plan: 05
type: execute
wave: 3
depends_on: ['34-03', '34-04']
files_modified:
  - apps/accommodations/frontend/app/stay/[code]/page.tsx
  - apps/backoffice/components/accommodations/OrderManagement.tsx
  - apps/backoffice/app/api/settings/services/import-from-menu/route.ts
  - apps/backoffice/components/accommodations/ImportFromMenuDialog.tsx
autonomous: true

must_haves:
  truths:
    - 'MinibarSection is wired into the guest dashboard with DashboardCard entry'
    - 'Owner receives real-time notification when guest marks minibar consumption via Supabase Realtime'
    - 'Owner can confirm minibar consumption from the backoffice order queue'
    - 'Backoffice services page has Import from Menu button that fetches F&B products and lets owner copy them into accommodation service items (SVC-10)'
  artifacts:
    - path: 'apps/accommodations/frontend/app/stay/[code]/page.tsx'
      provides: 'MinibarSection wired into dashboard with conditional rendering and DashboardCard'
    - path: 'apps/backoffice/components/accommodations/OrderManagement.tsx'
      provides: 'Minibar badge, confirm button, and Realtime subscription for minibar orders'
    - path: 'apps/backoffice/components/accommodations/ImportFromMenuDialog.tsx'
      provides: 'Dialog to browse F&B catalog and import items into accommodation services'
      min_lines: 80
    - path: 'apps/backoffice/app/api/settings/services/import-from-menu/route.ts'
      provides: 'API endpoint to fetch F&B products for import picker'
      min_lines: 30
  key_links:
    - from: 'page.tsx'
      to: 'MinibarSection.tsx'
      via: 'Home tab renders MinibarSection for properties with minibar categories'
      pattern: 'MinibarSection'
    - from: 'ImportFromMenuDialog.tsx'
      to: 'import-from-menu/route.ts'
      via: 'Dialog fetches F&B products from API endpoint'
      pattern: 'import-from-menu|fetchProducts'
---

<objective>
Wire MinibarSection into the guest dashboard, add Realtime owner notifications and minibar confirmation in backoffice, and build the F&B catalog import picker (SVC-10) as a real backoffice feature.

Purpose: Complete minibar dashboard wiring, SVC-03 (owner confirmation + Realtime), SVC-10 (F&B catalog import picker for minibar/breakfast items)
Output: MinibarSection in page.tsx, backoffice minibar indicators + Realtime, ImportFromMenuDialog + API for cross-vertical item import
</objective>

<execution_context>
@/Users/gianfrancodagostino/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gianfrancodagostino/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/34-service-expansion-minibar/34-03-SUMMARY.md
@.planning/phases/34-service-expansion-minibar/34-04-SUMMARY.md

Key source files:
@apps/accommodations/frontend/app/stay/[code]/page.tsx
@apps/accommodations/frontend/components/stay/MinibarSection.tsx
@apps/backoffice/components/accommodations/OrderManagement.tsx
@shared/database/migrations/schema/077-accommodations-schema.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire MinibarSection into dashboard + backoffice Realtime + minibar confirmation</name>
  <files>
    apps/accommodations/frontend/app/stay/[code]/page.tsx
    apps/backoffice/components/accommodations/OrderManagement.tsx
  </files>
  <action>
**page.tsx -- Wire MinibarSection:**

1. Import MinibarSection from '@/components/stay/MinibarSection'
2. Import Wine from @phosphor-icons/react
3. Render MinibarSection in the home tab, between ServicesCarousel and orders sections:
   ```tsx
   {
     serviceCategories.some((c) => c.automationLevel === 'self_service') && (
       <div
         id="minibar-section"
         className="rounded-2xl border border-[#E8E2D9] bg-white p-4 shadow-sm"
       >
         <MinibarSection
           categories={serviceCategories}
           bookingCode={params.code}
           token={token!}
           onOrderCreated={refetchOrders}
         />
       </div>
     );
   }
   ```
4. Add Minibar DashboardCard (conditional on self_service categories):
   ```tsx
   {
     serviceCategories.some((c) => c.automationLevel === 'self_service') && (
       <DashboardCard
         icon={Wine}
         label="Minibar"
         color="#E07A5F"
         onClick={() =>
           document
             .getElementById('minibar-section')
             ?.scrollIntoView({ behavior: 'smooth' })
         }
       />
     );
   }
   ```

**OrderManagement.tsx (backoffice):**

Read the current file first, then make these additions:

1. Add visual indicator for minibar orders:
   - If order has `is_minibar_consumption = true`, show badge: `<span className="rounded-full bg-pink-100 px-2 py-0.5 text-[10px] font-medium text-pink-700">Minibar</span>`

2. Add owner confirmation buttons for minibar orders:
   - If `is_minibar_consumption = true` and `owner_confirmed = null`:
     - "Confirm" button (green) -> Supabase update: `supabase.from('accom_service_orders').update({ owner_confirmed: true }).eq('id', orderId)`

3. Add Supabase Realtime subscription for minibar order notifications:
   ```typescript
   useEffect(() => {
     const channel = supabase
       .channel('minibar-orders')
       .on(
         'postgres_changes',
         {
           event: 'INSERT',
           schema: 'public',
           table: 'accom_service_orders',
           filter: `property_id=eq.${propertyId}`,
         },
         (payload) => {
           if (payload.new.is_minibar_consumption) {
             refetch();
           }
         }
       )
       .subscribe();
     return () => {
       supabase.removeChannel(channel);
     };
   }, [propertyId, supabase]);
   ```

**CRITICAL STATE CONTRACT CHECK:**

- All existing page.tsx state preserved
- MinibarSection only renders conditionally
- No removal of existing components
  </action>
  <verify>
  TypeScript compilation for both apps:
  `cd apps/accommodations/frontend && npx tsc --noEmit --pretty 2>&1 | head -30`
  `cd apps/backoffice && npx tsc --noEmit --pretty 2>&1 | head -30`
  Verify MinibarSection wired: `grep 'MinibarSection' apps/accommodations/frontend/app/stay/\[code\]/page.tsx`
  Verify Minibar DashboardCard: `grep 'Minibar' apps/accommodations/frontend/app/stay/\[code\]/page.tsx`
  Verify Realtime subscription: `grep 'minibar-orders\|postgres_changes' apps/backoffice/components/accommodations/OrderManagement.tsx`
  State contract: `grep -c "useServiceCart\|useOrderPolling\|useStaySession\|CartFAB\|CartDrawer\|ServiceCatalog\|HouseRulesSheet\|ProfileView\|ContactSheet\|OrderListView\|MinibarSection" apps/accommodations/frontend/app/stay/\[code\]/page.tsx` should return 11+
  </verify>
  <done>
  MinibarSection wired into dashboard with DashboardCard. Backoffice has Realtime subscription for minibar orders and confirm action. All state contracts preserved.
  </done>
  </task>

<task type="auto">
  <name>Task 2: F&B catalog import picker for backoffice services (SVC-10)</name>
  <files>
    apps/backoffice/app/api/settings/services/import-from-menu/route.ts
    apps/backoffice/components/accommodations/ImportFromMenuDialog.tsx
  </files>
  <action>
**SVC-10: Import from Menu -- real implementation.**

This feature allows accommodation owners to import items from their linked F&B catalog (coffeeshop products table) into accommodation service items (minibar, breakfast, etc.).

**API endpoint: `import-from-menu/route.ts`**

GET handler -- fetches F&B products for the import picker:

1. Authenticate the request (same pattern as other backoffice API routes)
2. Get the merchant's property_id from auth context
3. Look up the merchant's linked F&B catalog:
   - Query `merchants` table to find the merchant record for this property
   - The merchant may have products in the `products` or `dishes` table (coffeeshop vertical uses `products`)
   - Query: `SELECT id, name, description, price, currency, image_url, category FROM products WHERE merchant_id = $merchantId AND is_active = true ORDER BY category, name`
   - If the merchant has no F&B products, return empty array
4. Return the products as JSON: `{ products: [...] }`

POST handler -- imports selected products as accommodation service items:

1. Authenticate the request
2. Accept body: `{ items: [{ productId, categoryId, price?, name? }] }`
   - `productId`: source F&B product ID (for reference)
   - `categoryId`: target accommodation service category ID (e.g., minibar category)
   - `price`: optional override price (defaults to F&B product price)
   - `name`: optional override name (defaults to F&B product name)
3. For each item:
   - Fetch the source product from `products` table
   - Create a new `accom_service_item` with:
     - `name`: from override or product
     - `description`: from product
     - `price`: from override or product
     - `currency`: from product
     - `image_url`: from product
     - `category_id`: target category
     - `is_available`: true
     - `sort_order`: next available
4. Return the created items

**ImportFromMenuDialog.tsx (new component):**

A dialog/modal for the backoffice services page that:

1. Opens when owner clicks "Import from Menu" button
2. Fetches F&B products from the API endpoint
3. Shows a searchable list of products grouped by F&B category
4. Each product row shows: image thumbnail, name, price, checkbox
5. Owner can select multiple products
6. Owner picks the target accommodation service category from a dropdown (e.g., "Minibar", "Breakfast")
7. "Import Selected" button calls POST endpoint to create the items
8. On success: close dialog, refresh services list, show success toast

Layout:

- Use existing backoffice dialog pattern (if one exists) or Radix Dialog
- Header: "Import from Menu" with ShoppingBag icon
- Search input at top
- Scrollable product list with checkboxes
- Bottom bar: category dropdown + "Import N items" button
- Empty state: "No F&B products found. Set up your digital menu first."

Props:

```typescript
interface ImportFromMenuDialogProps {
  open: boolean;
  onClose: () => void;
  categories: { id: string; name: string }[]; // Target accommodation categories
  onImported: () => void; // Refresh callback
}
```

**Where to add the "Import from Menu" button:**

In the backoffice services/catalog management page. Read the existing page to find where service items are managed, and add the button near the "Add Item" button. If the services page is in OrderManagement.tsx or a separate ServicesManager component, add it there.

The button should only be visible if the merchant has a linked F&B catalog (check by calling the GET endpoint -- if products array is non-empty, show the button).
</action>
<verify>
TypeScript compilation: `cd apps/backoffice && npx tsc --noEmit --pretty 2>&1 | head -40`
Verify API route exists: `ls apps/backoffice/app/api/settings/services/import-from-menu/route.ts`
Verify dialog component exists: `ls apps/backoffice/components/accommodations/ImportFromMenuDialog.tsx`
Verify import button: `grep 'Import from Menu\|ImportFromMenuDialog' apps/backoffice/components/accommodations/OrderManagement.tsx` or relevant services page
</verify>
<done>
F&B catalog import picker implemented: API endpoint fetches products from F&B catalog, ImportFromMenuDialog lets owner browse and select items, selected items are copied into accommodation service items. SVC-10 fully implemented.
</done>
</task>

</tasks>

<verification>
1. `cd apps/accommodations/frontend && npx tsc --noEmit` -- zero errors
2. `cd apps/accommodations/frontend && npx next build` -- build succeeds
3. `cd apps/backoffice && npx tsc --noEmit` -- zero errors
4. MinibarSection appears on guest dashboard for properties with self_service categories
5. Minibar DashboardCard scrolls to minibar section
6. Backoffice shows "Minibar" badge on minibar orders
7. Supabase Realtime notifies backoffice of new minibar orders
8. Owner can confirm minibar consumption
9. Import from Menu button visible in backoffice services page
10. ImportFromMenuDialog fetches F&B products and imports them as service items
11. All page.tsx state contracts preserved
</verification>

<success_criteria>

- MinibarSection wired into guest dashboard with DashboardCard entry point
- Owner receives real-time notification for minibar consumption
- Owner can confirm minibar orders from backoffice
- Import from Menu dialog works end-to-end: browse F&B products, select items, import into accommodation service catalog
- TypeScript compiles for both accommodations frontend and backoffice
- Next.js build succeeds

</success_criteria>

<output>
After completion, create `.planning/phases/34-service-expansion-minibar/34-05-SUMMARY.md`
</output>
