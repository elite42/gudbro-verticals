---
phase: 35-guest-feedback-system
plan: 02
type: execute
wave: 2
depends_on: ['35-01']
files_modified:
  - apps/accommodations/frontend/app/api/cron/post-checkout-feedback/route.ts
  - apps/accommodations/frontend/app/api/stay/[code]/feedback/post-stay/route.ts
  - apps/accommodations/frontend/app/feedback/[bookingId]/page.tsx
  - apps/accommodations/frontend/components/stay/PostStayRating.tsx
  - apps/accommodations/frontend/vercel.json
  - apps/backoffice/lib/ai/accom-feedback-service.ts
  - apps/backoffice/app/(dashboard)/accommodations/feedback/page.tsx
autonomous: true

must_haves:
  truths:
    - 'Post-stay feedback email is sent 2-24 hours after checkout'
    - 'Guest can rate 5 categories with stars and leave optional comments'
    - 'AI pipeline processes feedback with accommodations-specific tags'
    - 'Backoffice shows aggregate scores across all feedback'
    - 'Double feedback is prevented (one post-stay per booking)'
  artifacts:
    - path: 'apps/accommodations/frontend/app/api/cron/post-checkout-feedback/route.ts'
      provides: 'Cron job that finds recent checkouts and sends feedback emails'
      exports: ['GET']
    - path: 'apps/accommodations/frontend/components/stay/PostStayRating.tsx'
      provides: 'Star rating form with 5 categories'
      min_lines: 60
    - path: 'apps/backoffice/lib/ai/accom-feedback-service.ts'
      provides: 'AI tag extraction with ACCOM_FEEDBACK_TAGS taxonomy'
      contains: 'ACCOM_FEEDBACK_TAGS'
    - path: 'apps/backoffice/app/(dashboard)/accommodations/feedback/page.tsx'
      provides: 'Aggregate scores dashboard section'
      contains: 'aggregate'
  key_links:
    - from: 'cron/post-checkout-feedback/route.ts'
      to: 'accom_bookings'
      via: 'query checked_out bookings in 2-24h window'
      pattern: 'checked_out_at'
    - from: 'PostStayRating.tsx'
      to: '/api/stay/[code]/feedback/post-stay'
      via: 'fetch POST with ratings'
      pattern: 'fetch.*post-stay'
    - from: 'accom-feedback-service.ts'
      to: 'accom_guest_feedback'
      via: 'AI processes unprocessed feedback'
      pattern: 'ai_processed_at IS NULL'
---

<objective>
Add post-stay feedback: cron trigger for checked-out guests, star rating form, AI processing pipeline with accommodations taxonomy, and aggregate scores in the backoffice dashboard.

Purpose: Capture structured guest ratings after checkout to build property quality metrics and feed the AI feedback intelligence pipeline.
Output: Complete post-stay feedback loop (cron email -> rating form -> AI processing -> aggregate dashboard)
</objective>

<execution_context>
@/Users/gianfrancodagostino/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gianfrancodagostino/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/35-guest-feedback-system/35-RESEARCH.md
@.planning/phases/35-guest-feedback-system/35-01-SUMMARY.md

Key reference files (read these for patterns):
@apps/accommodations/frontend/app/api/cron/pre-arrival-emails/route.ts (cron pattern to follow exactly)
@apps/accommodations/frontend/vercel.json (add new cron entry)
@apps/backoffice/lib/ai/feedback-intelligence-service.ts (AI pipeline to fork -- read first 150 lines for structure)
@apps/backoffice/lib/ai/openai.ts (shared OpenAI helpers)
@shared/database/migrations/schema/097-accom-guest-feedback.sql (table from 35-01)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Post-checkout cron + post-stay rating form + submission API</name>
  <files>
    apps/accommodations/frontend/app/api/cron/post-checkout-feedback/route.ts
    apps/accommodations/frontend/app/api/stay/[code]/feedback/post-stay/route.ts
    apps/accommodations/frontend/app/feedback/[bookingId]/page.tsx
    apps/accommodations/frontend/components/stay/PostStayRating.tsx
    apps/accommodations/frontend/vercel.json
  </files>
  <action>
    1. Create cron route GET /api/cron/post-checkout-feedback/route.ts:
       - Follow EXACT pattern from pre-arrival-emails/route.ts (auth with CRON_SECRET header check)
       - Query: SELECT bookings WHERE status = 'checked_out' AND checked_out_at BETWEEN NOW() - INTERVAL '24 hours' AND NOW() - INTERVAL '2 hours' AND booking has guest_email AND no existing post_stay feedback (LEFT JOIN accom_guest_feedback WHERE feedback_type = 'post_stay')
       - For each qualifying booking: send email via Resend with feedback link. The link should be: `${NEXT_PUBLIC_APP_URL}/feedback/${booking.id}?token=${generateFeedbackToken(booking)}` -- generate a short-lived JWT (72h expiry) with bookingId claim for the feedback page.
       - Log each sent email in accom_email_logs with type 'post_stay_feedback' (same pattern as pre-arrival)
       - Return JSON with count of emails sent

    2. Add cron entry to vercel.json:
       - path: "/api/cron/post-checkout-feedback"
       - schedule: "0 */2 * * *" (every 2 hours)

    3. Create POST /api/stay/[code]/feedback/post-stay/route.ts:
       - Auth: Accept EITHER guest JWT token (for guests still with session) OR feedback token from email link (verify JWT with bookingId claim)
       - Body: { ratings: { cleanliness: 1-5, location: 1-5, value: 1-5, communication: 1-5, wifi: 1-5 }, overallRating: 1-5, comment?: string }
       - Validate all ratings are 1-5 integers
       - Insert into accom_guest_feedback with feedback_type='post_stay', all rating columns, message=comment, guest info from booking lookup
       - Handle UNIQUE constraint violation (booking_id + feedback_type='post_stay') gracefully: return 409 "Feedback already submitted"
       - Return 201 with feedback record

    4. Create standalone feedback page at /feedback/[bookingId]/page.tsx:
       - This is a standalone page (NOT inside the stay dashboard) accessible from the email link
       - Verify feedback token from URL query param, extract bookingId
       - Show property name and stay dates at top
       - Render PostStayRating component
       - After submission: show thank you message with confetti/checkmark

    5. Create PostStayRating.tsx component:
       - 5 rating categories rendered as rows, each with label + Phosphor icon + 5 tappable Star icons:
         - Cleanliness (Broom icon)
         - Location (MapPin icon)
         - Value for Money (CurrencyCircleDollar icon)
         - Communication (ChatCircle icon)
         - WiFi (WifiHigh icon)
       - Overall rating as a larger 5-star row at top or bottom
       - Optional comment textarea below ratings
       - Submit button (disabled until all 5 category ratings filled)
       - Star interaction: tap to set rating (filled stars = selected, outline = unselected). Use Star and StarFill from Phosphor with weight="fill" for selected.
       - Props: bookingId, onSubmit callback, propertyName, stayDates

    IMPORTANT for cron: Check accom_email_logs BEFORE sending to prevent duplicate emails on re-runs. Use the same email logging pattern as pre-arrival-emails.
    IMPORTANT for feedback token: Create a helper function generateFeedbackToken(booking) and verifyFeedbackToken(token) in lib/auth.ts using jose (already imported there). Short-lived token (72h), minimal claims: { bookingId, propertyId, type: 'feedback' }.

  </action>
  <verify>
    - Cron route returns 200 with count (test with curl and CRON_SECRET header)
    - vercel.json has new cron entry and is valid JSON
    - Post-stay API validates ratings and handles duplicate prevention
    - PostStayRating renders 5 star-rating rows
    - TypeScript compiles: cd apps/accommodations/frontend && npx tsc --noEmit
  </verify>
  <done>
    Cron job runs every 2 hours, finds bookings checked out 2-24h ago, sends feedback request email with unique link. Standalone feedback page shows star rating form with 5 categories + overall + optional comment. Submission creates post_stay feedback record. Duplicate prevention via UNIQUE constraint and email log check.
  </done>
</task>

<task type="auto">
  <name>Task 2: AI feedback pipeline fork + backoffice aggregate dashboard</name>
  <files>
    apps/backoffice/lib/ai/accom-feedback-service.ts
    apps/backoffice/app/(dashboard)/accommodations/feedback/page.tsx
  </files>
  <action>
    1. Create accom-feedback-service.ts by forking feedback-intelligence-service.ts:
       - Read the existing feedback-intelligence-service.ts FULLY first to understand the structure
       - Fork the file, replacing:
         - FEEDBACK_TAGS -> ACCOM_FEEDBACK_TAGS (accommodations taxonomy from research: maintenance, plumbing, electrical, furniture, housekeeping, cleanliness, linens, towels, noise, neighbors, construction, wifi, tv, ac-heating, check-in, check-out, key-access, amenities, kitchen, bathroom, safety, security, pest-control, location, neighborhood, communication, responsiveness, value, pricing, extra-charges, parking, laundry, pool, common-areas)
         - Table references: customer_feedback -> accom_guest_feedback
         - Context fields: merchant_id -> property_id
         - GPT prompt: Update system prompt to reference "accommodation guest feedback" instead of "restaurant/hospitality feedback"
       - Main function: processAccomFeedback() that:
         - Queries accom_guest_feedback WHERE ai_processed_at IS NULL LIMIT 10
         - For each: call GPT-4o-mini to extract tags (from ACCOM_FEEDBACK_TAGS), sentiment (positive/neutral/negative), priority (1-5)
         - Update record with ai_tags, ai_sentiment, ai_priority, ai_processed_at = NOW()
       - Reuse getOpenAIClient() and calculateCost() from './openai' (shared helpers, do NOT duplicate)
       - Export processAccomFeedback for use in a cron or manual trigger

    2. Enhance backoffice feedback page (apps/backoffice/app/(dashboard)/accommodations/feedback/page.tsx):
       - Add an aggregate section at TOP of page (above the queue list from 35-01):
         - Average ratings per category (cleanliness, location, value, communication, wifi) displayed as filled stars + numeric average (e.g. "4.2")
         - Overall average rating prominently displayed
         - Total feedback count, response rate (feedback with owner_response / total)
         - Only include post_stay feedback in averages (in_stay has no ratings)
       - Add AI tags section:
         - Show tag cloud or tag list with frequency counts from ai_tags across all feedback
         - Color-code by sentiment (green=positive, yellow=neutral, red=negative)
       - Add "Process AI" button (manual trigger for now):
         - Calls an API route that runs processAccomFeedback()
         - Shows processing status / count processed
       - Create API route for AI processing trigger:
         - apps/backoffice/app/api/accommodations/feedback/process-ai/route.ts
         - POST handler that calls processAccomFeedback() and returns count
         - Auth: standard backoffice auth (Supabase session)
       - Integrate with existing queue: Each feedback item now shows ai_tags as small badges and ai_sentiment as a colored dot

    IMPORTANT: Do NOT modify the existing F&B feedback-intelligence-service.ts. This is a FORK, not an extension. Share only the OpenAI helper functions from openai.ts.

  </action>
  <verify>
    - accom-feedback-service.ts exports processAccomFeedback
    - ACCOM_FEEDBACK_TAGS has 30+ accommodations-specific tags
    - Backoffice feedback page shows aggregate ratings section
    - AI process button exists and calls the correct API route
    - TypeScript compiles: cd apps/backoffice && npx tsc --noEmit
  </verify>
  <done>
    AI pipeline processes unprocessed feedback with accommodations-specific tag taxonomy (30+ tags). Backoffice feedback dashboard shows aggregate star ratings per category, overall average, response rate, and AI tag cloud with sentiment colors. Manual "Process AI" button triggers pipeline. Individual feedback items display AI tags and sentiment.
  </done>
</task>

</tasks>

<verification>
1. Post-stay trigger: Manually set a booking to checked_out with checked_out_at = NOW() - 3 hours. Run cron endpoint. Verify email is sent (check accom_email_logs).
2. Rating form: Open feedback page link, fill all 5 star categories + overall + comment, submit. Verify record in accom_guest_feedback with feedback_type='post_stay' and all ratings.
3. Duplicate prevention: Try submitting post-stay feedback for same booking twice. Second attempt returns 409.
4. AI processing: Click "Process AI" in backoffice. Verify feedback records get ai_tags, ai_sentiment, ai_priority populated.
5. Aggregate dashboard: With 2+ post-stay feedback records, verify averages display correctly per category.
</verification>

<success_criteria>

- Cron job identifies eligible checkouts and sends feedback emails (with dedup via email logs)
- Standalone rating page works from email link with token auth
- 5-category star ratings + overall + comment stored correctly
- AI pipeline extracts accommodations-specific tags and sentiment
- Backoffice shows aggregate scores, tag cloud, and AI-enhanced feedback items
  </success_criteria>

<output>
After completion, create `.planning/phases/35-guest-feedback-system/35-02-SUMMARY.md`
</output>
