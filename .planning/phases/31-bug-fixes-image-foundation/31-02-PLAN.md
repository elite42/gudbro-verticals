---
phase: 31-bug-fixes-image-foundation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/backoffice/app/api/upload/image/route.ts
  - apps/backoffice/components/accommodations/RoomManager.tsx
  - apps/backoffice/components/ui/image-upload.tsx
autonomous: true

must_haves:
  truths:
    - "Owner can upload room images in RoomManager (no more 'coming soon' placeholder)"
    - 'Uploaded room images are stored in Supabase Storage and URL saved to room.images JSONB'
    - 'Image upload accepts PNG, JPEG, and WebP up to 5MB'
  artifacts:
    - path: 'apps/backoffice/app/api/upload/image/route.ts'
      provides: 'room-images and service-items folder configs for upload'
      contains: 'room-images'
    - path: 'apps/backoffice/components/accommodations/RoomManager.tsx'
      provides: "ImageUpload component replacing 'coming soon' placeholder"
      contains: 'ImageUpload'
  key_links:
    - from: 'apps/backoffice/components/accommodations/RoomManager.tsx'
      to: 'apps/backoffice/components/ui/image-upload.tsx'
      via: 'import ImageUpload'
      pattern: 'import.*ImageUpload.*image-upload'
    - from: 'apps/backoffice/components/accommodations/RoomManager.tsx'
      to: 'apps/backoffice/app/api/upload/image/route.ts'
      via: 'fetch /api/upload/image with folder: room-images'
      pattern: 'room-images'
---

<objective>
Establish image upload infrastructure for accommodations (OWN-02) and fix room image upload in backoffice (BUG-09).

Purpose: Property owners need to upload room photos directly instead of pasting URLs or seeing "coming soon" placeholders. This builds the image foundation for service item images in later phases.
Output: Working room image upload in backoffice RoomManager, with folder configs ready for service item images.
</objective>

<execution_context>
@/Users/gianfrancodagostino/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gianfrancodagostino/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/31-bug-fixes-image-foundation/31-RESEARCH.md

Key source files to read before implementing:
@apps/backoffice/components/accommodations/RoomManager.tsx
@apps/backoffice/app/api/upload/image/route.ts
@apps/backoffice/components/ui/image-upload.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add accommodation folder configs to upload API and fix RoomManager image upload (BUG-09, OWN-02)</name>
  <files>
    apps/backoffice/app/api/upload/image/route.ts
    apps/backoffice/components/accommodations/RoomManager.tsx
    apps/backoffice/components/ui/image-upload.tsx
  </files>
  <action>
    **Step 1: Extend upload API folder configs** - In `apps/backoffice/app/api/upload/image/route.ts`, add two new folder configurations to the existing folder config object:
    ```typescript
    'room-images': {
      maxSize: 5 * 1024 * 1024, // 5MB
      allowedTypes: ['image/png', 'image/jpeg', 'image/webp'],
      subfolder: 'rooms',
    },
    'service-items': {
      maxSize: 5 * 1024 * 1024, // 5MB
      allowedTypes: ['image/png', 'image/jpeg', 'image/webp'],
      subfolder: 'services',
    },
    ```
    These use the EXISTING `brand-assets` Supabase Storage bucket (already configured and public). The subfolder path keeps accommodations images organized. If the route uses a different bucket structure, follow the existing pattern exactly -- just add the two folder keys.

    Also check the `ImageUploadFolder` type (may be in `image-upload.tsx` or the route). Add `'room-images' | 'service-items'` to the union type if it exists.

    **Step 2: Replace "coming soon" placeholder in RoomManager** - In `apps/backoffice/components/accommodations/RoomManager.tsx`:
    1. Read the file to find the "Image upload coming soon" placeholder (around line 482-485)
    2. Import `ImageUpload` from `@/components/ui/image-upload`
    3. Replace the placeholder with an ImageUpload component:
    ```tsx
    <ImageUpload
      value={room.images?.[0] || ''}
      onChange={(url) => handleRoomImageUpdate(room.id, url)}
      folder="room-images"
      entityId={room.id}
      label="Room Photo"
      maxSizeMB={5}
    />
    ```
    4. Add a `handleRoomImageUpdate` function that:
       - Updates the room's `images` JSONB array with the new URL
       - Calls the existing room update API/function to persist the change
       - Read existing room update logic to understand the save pattern (likely Supabase direct update or API call)
    5. Verify the `images` field is correctly typed in the Room interface (should be `string[]` per line 19)
    6. If `ImageUpload` component's props don't match (check the component for exact prop names), adapt accordingly. The component may use `onUpload`, `onImageChange`, or similar -- match the existing API.

    **Step 3: Verify ImageUpload component compatibility** - Read `apps/backoffice/components/ui/image-upload.tsx` to understand:
    - Exact prop types (the research suggests `value`, `onChange`, `folder`, `entityId`, `label`, `maxSizeMB` but verify)
    - Whether `folder` prop accepts a string or needs to be from a specific enum/type
    - If any modifications are needed to support the new folder types
    Only modify `image-upload.tsx` if the folder type is restricted and needs expanding.

  </action>
  <verify>
    Run `cd /Users/gianfrancodagostino/Desktop/gudbro-verticals && npx tsc --noEmit -p apps/backoffice/tsconfig.json` to verify no TypeScript errors. Verify that:
    1. The upload route handles 'room-images' folder correctly
    2. RoomManager imports and renders ImageUpload (no "coming soon" text)
    3. The room image update function exists and is wired to save
  </verify>
  <done>
    - Upload API route has 'room-images' and 'service-items' folder configs
    - RoomManager renders ImageUpload component instead of "coming soon" placeholder
    - Room image upload saves URL to room.images JSONB array
    - TypeScript compiles without errors
  </done>
</task>

</tasks>

<verification>
- TypeScript compilation passes: `npx tsc --noEmit -p apps/backoffice/tsconfig.json`
- Build succeeds: `cd apps/backoffice && npx next build` (or project-level build)
- RoomManager no longer contains "coming soon" text
- Upload route folder config includes 'room-images' and 'service-items'
</verification>

<success_criteria>

1. Room image upload works in backoffice RoomManager (BUG-09 fixed)
2. Upload API supports 'room-images' and 'service-items' folders (OWN-02 foundation)
3. Uploaded images stored via existing Supabase Storage pattern
4. Image URLs persisted to room.images JSONB array
   </success_criteria>

<output>
After completion, create `.planning/phases/31-bug-fixes-image-foundation/31-02-SUMMARY.md`
</output>
