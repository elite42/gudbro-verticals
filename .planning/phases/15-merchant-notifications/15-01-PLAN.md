---
phase: 15-merchant-notifications
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/backoffice/app/api/feedback/notifications/route.ts
  - apps/backoffice/lib/feedback/notification-utils.ts
  - apps/backoffice/app/api/feedback/submit/route.ts
  - apps/backoffice/lib/ai/feedback-intelligence-service.ts
autonomous: true

must_haves:
  truths:
    - 'GET /api/feedback/notifications returns notifications for a merchant with unreadCount'
    - 'PATCH /api/feedback/notifications marks single or all notifications as read'
    - 'createFeedbackNotification() inserts a record into fb_merchant_notifications'
    - 'notifyTaskStatusChange() queries linked submissions and creates notifications for each submitter (FBNOT-02)'
    - 'Submit route populates submitted_by_account_id from auth session'
    - "AI service creates an 'acknowledged' notification when linking submission to task"
  artifacts:
    - path: 'apps/backoffice/app/api/feedback/notifications/route.ts'
      provides: 'GET and PATCH handlers for notification CRUD'
      exports: ['GET', 'PATCH']
    - path: 'apps/backoffice/lib/feedback/notification-utils.ts'
      provides: 'Notification creation utilities for backend use'
      exports: ['createFeedbackNotification', 'notifyTaskStatusChange']
    - path: 'apps/backoffice/app/api/feedback/submit/route.ts'
      provides: 'Submit route with submitted_by_account_id population'
    - path: 'apps/backoffice/lib/ai/feedback-intelligence-service.ts'
      provides: 'AI pipeline that creates acknowledged notifications'
  key_links:
    - from: 'apps/backoffice/app/api/feedback/notifications/route.ts'
      to: 'fb_merchant_notifications table'
      via: 'createClient() with RLS'
      pattern: "supabase\\.from\\('fb_merchant_notifications'\\)"
    - from: 'apps/backoffice/lib/ai/feedback-intelligence-service.ts'
      to: 'apps/backoffice/lib/feedback/notification-utils.ts'
      via: 'import createFeedbackNotification'
      pattern: 'createFeedbackNotification'
    - from: 'apps/backoffice/app/api/feedback/submit/route.ts'
      to: 'fb_submissions.submitted_by_account_id'
      via: 'auth session account lookup'
      pattern: 'submitted_by_account_id'
    - from: 'apps/backoffice/lib/feedback/notification-utils.ts'
      to: 'fb_submissions table'
      via: 'supabaseAdmin query for linked submissions by task_id'
      pattern: "supabaseAdmin\\.from\\('fb_submissions'\\)"
---

<objective>
Create the notification API routes, notification creation utility (including task status change notifications), and integrate notification generation into the existing feedback pipeline.

Purpose: Provide the backend infrastructure so the frontend can fetch, display, and manage merchant notifications. Also ensure notifications are created when submissions are processed AND when linked task statuses change (FBNOT-02).
Output: API route at /api/feedback/notifications (GET + PATCH), createFeedbackNotification utility, notifyTaskStatusChange utility, and modified submit + AI service to populate account_id and generate acknowledged notifications.
</objective>

<execution_context>
@/Users/gianfrancodagostino/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gianfrancodagostino/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-merchant-notifications/15-RESEARCH.md

Key source files to reference:
@apps/backoffice/app/api/feedback/history/route.ts (API route pattern with createClient + RLS)
@apps/backoffice/app/api/feedback/submit/route.ts (submit route needing submitted_by_account_id fix)
@apps/backoffice/lib/ai/feedback-intelligence-service.ts (AI pipeline where acknowledged notification is created)
@apps/backoffice/lib/supabase-admin.ts (supabaseAdmin for service-side writes)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Notification API route and utility</name>
  <files>
    apps/backoffice/app/api/feedback/notifications/route.ts
    apps/backoffice/lib/feedback/notification-utils.ts
  </files>
  <action>
Create two files:

**1. `apps/backoffice/app/api/feedback/notifications/route.ts`**

Follow the exact pattern from `apps/backoffice/app/api/feedback/history/route.ts`:

- Import `NextRequest`, `NextResponse` from `next/server`
- Import `createClient` from `@/lib/supabase-server`
- Set `export const dynamic = 'force-dynamic'`

GET handler:

- Accepts `merchantId` query param (required, return 400 if missing)
- Queries `fb_merchant_notifications` via supabase (RLS-enforced)
- Selects: `id, type, title, body, is_read, submission_id, task_id, created_at`
- Filters by `merchant_id`, orders by `created_at` descending, limit 50
- Computes `unreadCount` from the returned data (filter `!is_read`)
- Returns `{ notifications, unreadCount }`

PATCH handler:

- Parses JSON body
- If `body.markAllRead === true` AND `body.merchantId`: update all unread notifications for that merchant, set `is_read: true` and `read_at` to current ISO timestamp
- If `body.notificationId`: update single notification, set `is_read: true` and `read_at`
- Returns `{ success: true }` on success, `{ error: ... }` on failure
- Return 400 for invalid request (neither markAllRead nor notificationId provided)

**2. `apps/backoffice/lib/feedback/notification-utils.ts`**

Create the directory `lib/feedback/` if it does not exist.

Export TWO functions:

**a) `createFeedbackNotification`** that:

- Imports `supabaseAdmin` from `../supabase-admin`
- Accepts params: `{ merchantId: string, accountId: string, submissionId?: string, taskId?: string, type: 'acknowledged' | 'status_changed' | 'resolved' | 'rejected', title: string, body?: string }`
- Inserts into `fb_merchant_notifications` using supabaseAdmin (bypasses RLS)
- Maps params to DB columns: merchant_id, account_id, submission_id (null if undefined), task_id (null if undefined), type, title, body (null if undefined)
- Logs errors but does not throw (notification creation should never block the main flow)

**b) `notifyTaskStatusChange`** that:

- Accepts params: `(taskId: string, newStatus: string)` where newStatus is one of 'in_progress', 'done', 'rejected'
- Uses `supabaseAdmin` to query `fb_submissions` where `task_id = taskId` to find all linked submissions
- Selects `id, merchant_id, submitted_by_account_id, original_title` from each submission
- For each submission that has a `submitted_by_account_id` (skip nulls), calls `createFeedbackNotification` with:
  - `merchantId`: from the submission
  - `accountId`: from `submitted_by_account_id`
  - `submissionId`: the submission id
  - `taskId`: the taskId param
  - `type`: map newStatus to notification type: 'in_progress' -> 'status_changed', 'done' -> 'resolved', 'rejected' -> 'rejected'
  - `title`: map newStatus to human-readable title: 'in_progress' -> 'Your feedback is being worked on', 'done' -> 'Your feedback has been resolved', 'rejected' -> 'Your feedback was not accepted'
  - `body`: Include the original_title, e.g. `Your submission "${original_title || 'Feedback'}" status updated.`
- Wraps everything in try/catch, logs errors but does not throw
- This function is designed to be called by Phase 16 kanban board handlers when admins change task status
  </action>
  <verify>
  TypeScript compilation check: `cd apps/backoffice && npx tsc --noEmit --pretty 2>&1 | head -30`
  Verify files exist: `ls -la apps/backoffice/app/api/feedback/notifications/route.ts apps/backoffice/lib/feedback/notification-utils.ts`
  Verify both exports: `grep -n 'export.*createFeedbackNotification\|export.*notifyTaskStatusChange' apps/backoffice/lib/feedback/notification-utils.ts`
  </verify>
  <done>
  GET /api/feedback/notifications?merchantId=X returns { notifications: [], unreadCount: 0 } shape.
  PATCH /api/feedback/notifications with { notificationId } or { markAllRead, merchantId } returns { success: true }.
  createFeedbackNotification() is exported and callable.
  notifyTaskStatusChange(taskId, newStatus) is exported and callable -- queries fb_submissions by task_id and creates notifications for all linked submitters.
  </done>
  </task>

<task type="auto">
  <name>Task 2: Wire notification creation into submit route and AI service</name>
  <files>
    apps/backoffice/app/api/feedback/submit/route.ts
    apps/backoffice/lib/ai/feedback-intelligence-service.ts
  </files>
  <action>
**1. Modify `apps/backoffice/app/api/feedback/submit/route.ts`**

Add `submitted_by_account_id` population to the submit route. After `const supabase = await createClient();`, resolve the current user's account_id:

```typescript
// Resolve account_id from auth session
const {
  data: { user },
} = await supabase.auth.getUser();
let accountId: string | null = null;
if (user) {
  const { data: account } = await supabase
    .from('accounts')
    .select('id')
    .eq('auth_id', user.id)
    .single();
  accountId = account?.id || null;
}
```

Then add `submitted_by_account_id: accountId` to the insert object (alongside existing fields like `original_title`, `original_body`, etc.).

**2. Modify `apps/backoffice/lib/ai/feedback-intelligence-service.ts`**

Import the utility at the top:

```typescript
import { createFeedbackNotification } from '../feedback/notification-utils';
```

In the `processSubmission` function, after step 7 (the final submission update with `status: 'processed'`), add notification creation. First, expand the select in step 1 to also fetch `submitted_by_account_id`:

Change the select from:
`'id, merchant_id, original_title, original_body, status, processing_attempts'`
to:
`'id, merchant_id, original_title, original_body, status, processing_attempts, submitted_by_account_id'`

Update the `Submission` interface to include `submitted_by_account_id: string | null`.

After the step 7 update (after `console.log('[FeedbackIntelligence] Processed submission:' ...)`), add:

```typescript
// Create "acknowledged" notification for the submitter
if (sub.submitted_by_account_id) {
  await createFeedbackNotification({
    merchantId: sub.merchant_id,
    accountId: sub.submitted_by_account_id,
    submissionId: submissionId,
    taskId: taskId,
    type: 'acknowledged',
    title: 'Your feedback has been received',
    body: `Your submission "${sub.original_title || 'Feedback'}" has been processed and linked to a task.`,
  });
}
```

This is fire-and-forget style -- createFeedbackNotification already handles errors internally without throwing.
</action>
<verify>
TypeScript compilation check: `cd apps/backoffice && npx tsc --noEmit --pretty 2>&1 | head -30`
Grep for the new code: `grep -n 'submitted_by_account_id' apps/backoffice/app/api/feedback/submit/route.ts`
Grep for notification creation: `grep -n 'createFeedbackNotification' apps/backoffice/lib/ai/feedback-intelligence-service.ts`
</verify>
<done>
Submit route resolves auth user to account_id and includes submitted_by_account_id in the fb_submissions insert.
AI service fetches submitted_by_account_id, and after processing creates an "acknowledged" notification via createFeedbackNotification.
TypeScript compiles without errors.
</done>
</task>

</tasks>

<verification>
- `cd apps/backoffice && npx tsc --noEmit` passes
- New API route file exists at `app/api/feedback/notifications/route.ts` with GET and PATCH exports
- New utility file exists at `lib/feedback/notification-utils.ts` with createFeedbackNotification AND notifyTaskStatusChange exports
- `submit/route.ts` includes `submitted_by_account_id` in the insert
- `feedback-intelligence-service.ts` imports and calls createFeedbackNotification after processing
- `notifyTaskStatusChange` queries fb_submissions by task_id and creates notifications per linked submitter
</verification>

<success_criteria>
Backend notification infrastructure is complete: API routes serve notification data, utility creates notifications (both for acknowledgment and task status changes), submit route captures account_id, and AI service generates "acknowledged" notifications when submissions are processed. Phase 16 kanban handlers can call notifyTaskStatusChange(taskId, newStatus) to fulfill FBNOT-02.
</success_criteria>

<output>
After completion, create `.planning/phases/15-merchant-notifications/15-01-SUMMARY.md`
</output>
