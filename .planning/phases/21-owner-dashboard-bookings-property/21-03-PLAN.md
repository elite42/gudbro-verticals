---
phase: 21-owner-dashboard-bookings-property
plan: 03
type: execute
wave: 2
depends_on: [21-01]
files_modified:
  - apps/backoffice/app/(dashboard)/accommodations/rooms/page.tsx
  - apps/backoffice/app/(dashboard)/accommodations/settings/page.tsx
  - apps/backoffice/app/(dashboard)/accommodations/qr-codes/page.tsx
  - apps/backoffice/components/accommodations/RoomManager.tsx
  - apps/backoffice/components/accommodations/AccomQRGenerator.tsx
  - apps/backoffice/components/layout/Sidebar.tsx
autonomous: true

must_haves:
  truths:
    - 'Owner can add, edit, and deactivate rooms with room number, type, capacity, description, price, and active toggle'
    - 'Owner can edit property settings including booking mode, check-in/out times, and cancellation policy'
    - 'Owner can generate and download QR codes for the property page and individual rooms'
    - 'Accommodations section appears in the backoffice sidebar with sub-pages for Bookings, Rooms, Settings, and QR Codes'
  artifacts:
    - path: 'apps/backoffice/components/accommodations/RoomManager.tsx'
      provides: 'Room CRUD component following ChargesManager pattern'
      min_lines: 200
    - path: 'apps/backoffice/app/(dashboard)/accommodations/qr-codes/page.tsx'
      provides: 'QR code generation page for property and rooms'
      min_lines: 100
    - path: 'apps/backoffice/app/(dashboard)/accommodations/settings/page.tsx'
      provides: 'Property settings form page'
      min_lines: 100
    - path: 'apps/backoffice/components/layout/Sidebar.tsx'
      provides: 'Updated sidebar with Accommodations nav section'
  key_links:
    - from: 'apps/backoffice/components/accommodations/RoomManager.tsx'
      to: '/api/accommodations/rooms'
      via: 'fetch for CRUD operations'
      pattern: 'fetch.*api/accommodations/rooms'
    - from: 'apps/backoffice/components/accommodations/AccomQRGenerator.tsx'
      to: 'lib/qr/qr-generator.ts'
      via: 'generateQRDataUrl import'
      pattern: 'generateQRDataUrl'
    - from: 'apps/backoffice/components/layout/Sidebar.tsx'
      to: '/accommodations/*'
      via: 'NavItem children array'
      pattern: 'accommodations'
---

<objective>
Build room management, property settings, QR code generation, and sidebar navigation for the owner dashboard.

Purpose: Owners can configure their property (rooms, settings) and generate QR codes for physical placement. The sidebar navigation makes all accommodation features discoverable.
Output: Room CRUD page, property settings form, QR generation page, sidebar nav update.
</objective>

<execution_context>
@/Users/gianfrancodagostino/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gianfrancodagostino/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-owner-dashboard-bookings-property/21-01-SUMMARY.md

# Reference patterns

@apps/backoffice/components/settings/ChargesManager.tsx
@apps/backoffice/components/layout/Sidebar.tsx
@apps/backoffice/lib/qr/qr-generator.ts
@apps/backoffice/lib/qr/qr-types.ts
@apps/backoffice/lib/accommodations/helpers.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: RoomManager component and Rooms page</name>
  <files>
    apps/backoffice/components/accommodations/RoomManager.tsx
    apps/backoffice/app/(dashboard)/accommodations/rooms/page.tsx
  </files>
  <action>
Create `apps/backoffice/components/accommodations/RoomManager.tsx` following the ChargesManager pattern:

**Interface:**

```typescript
interface Room {
  id: string;
  room_number: string;
  room_type: string; // single, double, twin, suite, dorm, studio, apartment
  capacity: number;
  description: string | null;
  base_price_per_night: number;
  currency: string;
  images: string[];
  beds: Array<{ type: string; count: number }>;
  amenities: string[];
  is_active: boolean;
  sort_order: number;
}

interface RoomManagerProps {
  propertyId: string;
}
```

**State:**

- `rooms: Room[]` — fetched from API
- `editingId: string | null` — ID of room being edited
- `isAdding: boolean` — whether the add form is visible
- `formData: RoomFormData` — current form state
- `loading: boolean`
- `saving: boolean`

**Room type options:** single, double, twin, suite, dorm, studio, apartment (dropdown select).

**Form fields:**

- Room number (text input, required)
- Room type (select dropdown)
- Capacity (number input, min 1)
- Base price per night (number input, in major currency units — convert to/from minor units for API)
- Currency (text, default from property or 'USD')
- Description (textarea, optional)
- Active toggle (checkbox)

**Omit for v1 (add TODO comments):**

- Image upload (show placeholder "Image upload coming soon")
- Beds configuration (use a simple text description for now)
- Amenities multi-select (defer to Phase 22)
- Drag-to-reorder sort

**CRUD operations:**

- Fetch rooms on mount: `GET /api/accommodations/rooms?propertyId={id}` with auth header.
- Add room: `POST /api/accommodations/rooms` with form data + propertyId.
- Edit room: `PUT /api/accommodations/rooms` with id + form data.
- Deactivate: `PUT /api/accommodations/rooms` with id + `is_active: false`.
- Reactivate: `PUT /api/accommodations/rooms` with id + `is_active: true`.

**UI layout (follow ChargesManager):**

- Header with "Rooms" title + "Add Room" button (Plus icon).
- List of room cards showing: room_number, room_type badge, capacity, price, active status.
- Inactive rooms shown with reduced opacity and "(Inactive)" label.
- Each room has Edit (Pencil icon) and Toggle Active (Power icon) buttons.
- Inline form appears when adding or editing (replaces the card content).
- Save (Check icon) and Cancel (X icon) buttons in form mode.

Use Phosphor Icons for all icons.

Create `apps/backoffice/app/(dashboard)/accommodations/rooms/page.tsx`:

- Simple page wrapper that renders `<RoomManager propertyId={PROPERTY_ID} />`.
- Use `const PROPERTY_ID = process.env.NEXT_PUBLIC_ACCOM_PROPERTY_ID || ''`.
- Show empty state if no property ID configured.
  </action>
  <verify>
  TypeScript compiles: `cd apps/backoffice && npx tsc --noEmit --pretty 2>&1 | head -30`.
  </verify>
  <done>
  RoomManager renders room list with add/edit/deactivate functionality. Room form collects number, type, capacity, price, description, and active status. All CRUD operations call the rooms API with proper auth.
  </done>
  </task>

<task type="auto">
  <name>Task 2: Property settings page, QR code generation, and sidebar navigation</name>
  <files>
    apps/backoffice/app/(dashboard)/accommodations/settings/page.tsx
    apps/backoffice/app/(dashboard)/accommodations/qr-codes/page.tsx
    apps/backoffice/components/accommodations/AccomQRGenerator.tsx
    apps/backoffice/components/layout/Sidebar.tsx
  </files>
  <action>
**Property Settings Page** (`apps/backoffice/app/(dashboard)/accommodations/settings/page.tsx`):

'use client' component that fetches and displays editable property settings.

- Fetch property on mount: `GET /api/accommodations/property?propertyId={id}` with auth.
- Display in a form with sections:

  **Booking Configuration:**
  - Booking mode: radio buttons for 'instant' | 'inquiry' | 'hybrid'
  - Check-in time (time input, e.g., "14:00")
  - Check-out time (time input, e.g., "11:00")

  **Financial:**
  - Deposit percent (number input, 1-100)
  - Cancellation penalty percent (number input, 0-100)

  **Policies:**
  - House rules (textarea, stored as JSONB — for v1 just use a textarea with one rule per line, split to array on save)
  - Cancellation policy (textarea)

  **Contact:**
  - Host phone, WhatsApp number, email, contact email (text inputs)

- Save button at bottom: `PUT /api/accommodations/property` with form data.
- Show success toast or inline "Saved!" message on successful update.
- Show loading skeleton while fetching.

**AccomQRGenerator component** (`apps/backoffice/components/accommodations/AccomQRGenerator.tsx`):

'use client' component.

Props: `{ propertyId: string }`

- Fetch property (for slug, name) and rooms on mount.
- Two sections:

  **Property QR:**
  - Shows QR code preview for `https://stays.gudbro.com/{property.slug}`
  - Property name displayed below QR
  - "Download PNG" button

  **Room QR Codes:**
  - For each active room, show a card with:
    - Room number + type label
    - QR code preview for `https://stays.gudbro.com/checkin/{propertyId}/{room.id}`
    - "Download PNG" button
  - If no rooms: show "Add rooms first" with link to /accommodations/rooms

**QR generation:** Use `generateQRDataUrl` from `@/lib/qr/qr-generator` with `SIZE_PRESETS.medium`. For download, create an anchor element with `download` attribute programmatically.

**Print-friendly layout:** Each QR card should have clean styling suitable for printing (no heavy backgrounds, clear labels). Add a "Print" button that calls `window.print()` — use `@media print` CSS to hide non-QR elements.

**QR Codes Page** (`apps/backoffice/app/(dashboard)/accommodations/qr-codes/page.tsx`):

- Simple page wrapper rendering `<AccomQRGenerator propertyId={PROPERTY_ID} />`.

**Sidebar Navigation Update** (`apps/backoffice/components/layout/Sidebar.tsx`):

Add a new entry to the `navigation` array (the main merchant navigation, not platformNavigation):

```typescript
{
  name: 'Accommodations',
  href: '/accommodations/bookings',
  icon: (props) => (
    // Use a building/house SVG icon consistent with existing sidebar icons
    // Since existing sidebar uses custom SVGs (not Phosphor), match that style
    <svg fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
      <path strokeLinecap="round" strokeLinejoin="round" d="M8.25 21v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21m0 0h4.5V3.545M12.75 21h7.5V10.75M2.25 21h1.5m18 0h-18M2.25 9l4.5-1.636M18.75 3l-1.5.545m0 6.205l3 1m1.5.5l-1.5-.5M6.75 7.364V3h-3v18m3-13.636l10.5-3.819" />
    </svg>
  ),
  badge: 'new' as const,
  children: [
    { name: 'Bookings', href: '/accommodations/bookings' },
    { name: 'Rooms', href: '/accommodations/rooms' },
    { name: 'Settings', href: '/accommodations/settings' },
    { name: 'QR Codes', href: '/accommodations/qr-codes' },
  ],
}
```

Place this after the "Settings" nav item (or after "Partnerships" if it exists) — find a logical position near the bottom of the main nav items. The `badge: 'new'` will show a "new" indicator to draw attention.

Important: Match the existing `NavItem` interface exactly. The sidebar already supports children arrays for sub-navigation — check how other items with children (like "Settings") are rendered and follow that pattern.
</action>
<verify>
TypeScript compiles: `cd apps/backoffice && npx tsc --noEmit --pretty 2>&1 | head -30`.
Sidebar renders with new Accommodations section and sub-pages are accessible.
</verify>
<done>
Property settings page allows editing booking mode, times, deposit, policies, and contact info. QR generator creates downloadable QR codes for property and each room. Sidebar shows Accommodations section with 4 sub-pages. All pages authenticated and functional.
</done>
</task>

</tasks>

<verification>
1. Room CRUD: add, edit, deactivate, reactivate rooms works via API
2. Property settings: save and reload preserves all field values
3. QR codes: property QR and room QR codes generate and download as PNG
4. QR URLs point to correct stays.gudbro.com paths
5. Sidebar shows Accommodations with 4 sub-pages
6. All sub-pages are reachable from sidebar navigation
7. TypeScript compiles: `cd apps/backoffice && npx tsc --noEmit`
</verification>

<success_criteria>

- RoomManager with full CRUD following ChargesManager pattern
- Property settings form with save functionality
- QR code generation for property and rooms with PNG download
- Sidebar navigation updated with Accommodations section
- Zero TypeScript errors
  </success_criteria>

<output>
After completion, create `.planning/phases/21-owner-dashboard-bookings-property/21-03-SUMMARY.md`
</output>
