---
phase: 14-merchant-submission-ui
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/backoffice/app/(dashboard)/settings/feedback/page.tsx
  - apps/backoffice/components/settings/FeedbackSubmissionManager.tsx
  - apps/backoffice/app/api/feedback/submit/route.ts
  - apps/backoffice/app/api/upload/image/route.ts
autonomous: true

must_haves:
  truths:
    - 'Merchant can open /settings/feedback and see a feedback submission form'
    - 'Merchant can select type (bug/feature/feedback), enter title and description, and submit'
    - 'Merchant can attach a screenshot (jpg/png/webp, max 5MB) that uploads and persists'
    - 'Submission auto-captures merchant_id, vertical, and page_path without merchant input'
    - 'Merchant can write in any language and submission is accepted (no language picker)'
    - 'After submission, form resets, success toast shows, and merchant stays on page'
  artifacts:
    - path: 'apps/backoffice/app/(dashboard)/settings/feedback/page.tsx'
      provides: 'Settings page shell with TenantContext'
      min_lines: 20
    - path: 'apps/backoffice/components/settings/FeedbackSubmissionManager.tsx'
      provides: 'Form with type selector, title, description, screenshot upload, submit'
      min_lines: 100
    - path: 'apps/backoffice/app/api/feedback/submit/route.ts'
      provides: 'POST endpoint inserting into fb_submissions'
      exports: ['POST']
    - path: 'apps/backoffice/app/api/upload/image/route.ts'
      provides: 'feedback-screenshots folder config added'
      contains: 'feedback-screenshots'
  key_links:
    - from: 'FeedbackSubmissionManager.tsx'
      to: '/api/feedback/submit'
      via: 'fetch POST on form submit'
      pattern: 'fetch.*api/feedback/submit'
    - from: 'FeedbackSubmissionManager.tsx'
      to: '/api/upload/image'
      via: 'FormData upload with folder feedback-screenshots'
      pattern: 'feedback-screenshots'
    - from: 'apps/backoffice/app/api/feedback/submit/route.ts'
      to: 'fb_submissions'
      via: 'supabase insert'
      pattern: 'fb_submissions'
---

<objective>
Create the feedback submission form and API route so merchants can submit feedback with type, title, description, and optional screenshot from the backoffice settings.

Purpose: This is the primary merchant-facing feature of the feedback intelligence system. Without a submission form, the entire pipeline (Phase 13) has no input.
Output: Working feedback form at /settings/feedback with POST API route and screenshot upload support.
</objective>

<execution_context>
@/Users/gianfrancodagostino/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gianfrancodagostino/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-foundation-ai-pipeline/13-01-SUMMARY.md
@.planning/phases/13-foundation-ai-pipeline/13-02-SUMMARY.md
@.planning/phases/14-merchant-submission-ui/14-RESEARCH.md

Key source patterns to follow:
@apps/backoffice/app/(dashboard)/settings/useful-numbers/page.tsx
@apps/backoffice/components/settings/UsefulNumbersManager.tsx
@apps/backoffice/app/api/settings/useful-numbers/route.ts
@apps/backoffice/app/api/upload/image/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Feedback submission API route and upload config</name>
  <files>
    apps/backoffice/app/api/feedback/submit/route.ts
    apps/backoffice/app/api/upload/image/route.ts
  </files>
  <action>
1. Add `feedback-screenshots` folder config to FOLDER_CONFIGS in `/api/upload/image/route.ts`:
   ```
   'feedback-screenshots': {
     maxSize: 5 * 1024 * 1024,
     allowedTypes: ['image/png', 'image/jpeg', 'image/webp'],
     subfolder: 'feedback',
   },
   ```

2. Create POST endpoint at `apps/backoffice/app/api/feedback/submit/route.ts`:
   - Import `createClient` from `@/lib/supabase-server` (follow useful-numbers pattern)
   - Accept JSON body: `{ original_title, original_body, type, merchant_id, vertical, page_path, screenshot_url? }`
   - Validate required fields: original_title (non-empty string), original_body (non-empty string), type (one of 'bug', 'feature_request', 'improvement'), merchant_id (non-empty string)
   - Map UI type values: 'bug' stays 'bug', 'feature_request' stays 'feature_request', 'feedback' maps to 'improvement'
   - Set `source: 'manual'`, `status: 'pending'`
   - Insert into `fb_submissions` table via supabase
   - After successful insert, fire-and-forget call to `/api/feedback/process` with the new submission ID (so AI pipeline processes it asynchronously). Use fetch with the request's origin URL. Wrap in try/catch so a process failure does not fail the submission.
   - Return 201 with `{ id, message: 'Submission created' }` on success
   - Return 400 for validation errors, 500 for DB errors
   - Use `export const dynamic = 'force-dynamic'`
     </action>
     <verify>
     TypeScript compiles: `cd apps/backoffice && npx tsc --noEmit --pretty 2>&1 | head -30`
     The folder config object contains 'feedback-screenshots' key.
     The route.ts exports a POST function.
     </verify>
     <done>POST /api/feedback/submit accepts feedback JSON, inserts into fb_submissions, triggers AI processing, returns 201. Upload route supports feedback-screenshots folder.</done>
     </task>

<task type="auto">
  <name>Task 2: Feedback settings page and submission form component</name>
  <files>
    apps/backoffice/app/(dashboard)/settings/feedback/page.tsx
    apps/backoffice/components/settings/FeedbackSubmissionManager.tsx
  </files>
  <action>
1. Create `apps/backoffice/app/(dashboard)/settings/feedback/page.tsx`:
   - Follow exact pattern from `useful-numbers/page.tsx`
   - 'use client', import useTenant, FeedbackSubmissionManager, Loader2
   - Get merchantId from `location?.id || brand?.id`
   - Loading state with Loader2 spinner
   - No-merchant-selected warning card
   - Header: title "Segnalazioni e Feedback", subtitle "Invia segnalazioni di bug, richieste di funzionalita o feedback. Scrivi in qualsiasi lingua."
   - Render `<FeedbackSubmissionManager merchantId={merchantId} />`

2. Create `apps/backoffice/components/settings/FeedbackSubmissionManager.tsx`:
   - 'use client' component accepting `{ merchantId: string }` prop
   - Use `usePathname()` from next/navigation to capture page_path
   - Hardcode `vertical: 'backoffice'` (all submissions come from backoffice)

   **Form state (useState):**
   - `type`: 'bug' | 'feature_request' | 'feedback' (default: 'feedback')
   - `title`: string (default: '')
   - `body`: string (default: '')
   - `screenshotFile`: File | null
   - `screenshotPreview`: string | null (object URL for preview)
   - `isSaving`: boolean
   - `error`: string | null

   **Type selector:**
   - Three clickable cards/buttons in a row (not a dropdown):
     - Bug (Bug icon from Phosphor, weight duotone) - red accent when selected
     - Feature Request (Lightbulb icon, weight duotone) - blue accent when selected
     - Feedback (ChatCircle icon, weight duotone) - green accent when selected
   - Selected state: colored border + bg tint + filled icon weight

   **Title field:**
   - Label "Titolo" with required asterisk
   - `<input type="text" maxLength={200} />` with Tailwind styling matching existing settings pages
   - Placeholder: "Descrivi brevemente il problema o la richiesta"

   **Description field:**
   - Label "Descrizione" with required asterisk
   - `<textarea rows={5} />` with generous height
   - Placeholder: "Fornisci tutti i dettagli utili..."

   **Screenshot upload:**
   - Label "Screenshot (opzionale)"
   - Hidden file input accepting image/png, image/jpeg, image/webp
   - Button with Camera icon (Phosphor, duotone): "Allega Screenshot"
   - Client-side validation on file select: file.size <= 5MB, valid type. Show error if invalid.
   - When file selected, show thumbnail preview (use URL.createObjectURL) with an X button to remove
   - Clean up object URL on unmount or removal (URL.revokeObjectURL)

   **Submit button:**
   - Full-width or right-aligned button: "Invia Segnalazione"
   - Disabled when: isSaving, title empty, body empty
   - Shows Loader2 spinner when isSaving

   **Submit flow (handleSubmit):**
   1. Set isSaving=true, error=null
   2. If screenshotFile exists:
      a. Create FormData with file, folder='feedback-screenshots', entityId=crypto.randomUUID()
      b. POST to /api/upload/image
      c. Get `{ url }` from response
   3. POST to /api/feedback/submit with JSON:
      `{ original_title: title, original_body: body, type: typeValue, merchant_id: merchantId, vertical: 'backoffice', page_path: pathname, screenshot_url: url || null }`
      - Map type for API: 'feedback' -> 'improvement', others pass through
   4. On success: show success toast (use useToast if available, or a green banner), reset form (all fields to default), clear screenshot preview
   5. On error: set error message, show in red banner above form
   6. Finally: set isSaving=false

   **Styling:** Match existing settings pages (rounded-xl borders, white bg cards, gray-50 sections, consistent spacing). Use Tailwind classes consistent with UsefulNumbersManager.
   </action>
   <verify>
   TypeScript compiles: `cd apps/backoffice && npx tsc --noEmit --pretty 2>&1 | head -30`
   Page file exists at correct path.
   Component imports from @phosphor-icons/react (not lucide for new icons).
   Form has three type options, title input, description textarea, screenshot upload, and submit button.
   </verify>
   <done>
   /settings/feedback page renders with FeedbackSubmissionManager. Merchant can select type, enter title/description, optionally attach screenshot, and submit. Form captures context automatically (merchantId, vertical, page_path). Form resets on success. Any language accepted.
   </done>
   </task>

</tasks>

<verification>
1. `cd apps/backoffice && npx tsc --noEmit` - TypeScript compiles
2. Manual: Navigate to /settings/feedback - form renders with type selector, title, description, screenshot upload
3. Manual: Fill form and submit - returns success, form resets
4. Check fb_submissions table has new row with correct merchant_id, vertical, page_path, type, source='manual'
</verification>

<success_criteria>

- Feedback form renders at /settings/feedback following existing settings page patterns
- Type selector shows bug/feature/feedback with visual distinction
- Title and description are required fields with validation
- Screenshot upload works with client-side validation (5MB, image types) and preview
- Submit inserts into fb_submissions with auto-captured context
- AI processing triggered asynchronously after submission
- Form resets after successful submission
- Any language text accepted in title and description
  </success_criteria>

<output>
After completion, create `.planning/phases/14-merchant-submission-ui/14-01-SUMMARY.md`
</output>
