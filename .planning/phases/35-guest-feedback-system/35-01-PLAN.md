---
phase: 35-guest-feedback-system
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - shared/database/migrations/schema/097-accom-guest-feedback.sql
  - apps/accommodations/frontend/app/api/stay/[code]/feedback/route.ts
  - apps/accommodations/frontend/app/api/stay/[code]/feedback/upload-url/route.ts
  - apps/accommodations/frontend/components/stay/FeedbackForm.tsx
  - apps/accommodations/frontend/types/stay.ts
  - apps/accommodations/frontend/lib/feedback-api.ts
  - apps/accommodations/frontend/app/stay/[code]/page.tsx
  - apps/backoffice/app/(dashboard)/accommodations/feedback/page.tsx
autonomous: true

must_haves:
  truths:
    - 'Guest can submit in-stay feedback with category selection and free text'
    - 'Guest can optionally attach a photo to feedback'
    - 'Owner sees new feedback in backoffice queue with status tracking'
    - 'Owner can acknowledge/respond to feedback items'
    - 'Feedback card appears in guest dashboard grid'
  artifacts:
    - path: 'shared/database/migrations/schema/097-accom-guest-feedback.sql'
      provides: 'accom_guest_feedback table with all columns'
      contains: 'CREATE TABLE accom_guest_feedback'
    - path: 'apps/accommodations/frontend/app/api/stay/[code]/feedback/route.ts'
      provides: 'POST in-stay feedback + GET feedback list'
      exports: ['POST', 'GET']
    - path: 'apps/accommodations/frontend/components/stay/FeedbackForm.tsx'
      provides: 'Multi-step feedback form with category, text, photo'
      min_lines: 80
    - path: 'apps/backoffice/app/(dashboard)/accommodations/feedback/page.tsx'
      provides: 'Feedback queue with status filters and response capability'
      min_lines: 60
  key_links:
    - from: 'FeedbackForm.tsx'
      to: '/api/stay/[code]/feedback'
      via: 'fetch POST with JWT auth'
      pattern: 'fetch.*feedback'
    - from: 'feedback/route.ts'
      to: 'accom_guest_feedback'
      via: 'supabaseAdmin insert'
      pattern: 'supabaseAdmin.*accom_guest_feedback'
    - from: 'feedback/route.ts'
      to: 'notification_queue'
      via: 'queue_notification RPC'
      pattern: 'queue_notification'
---

<objective>
Create the in-stay guest feedback system: database table, guest submission form with photo upload, owner notification, and backoffice feedback queue.

Purpose: Enable guests to report issues (maintenance, housekeeping, complaints) during their stay for immediate owner visibility and resolution tracking.
Output: Working feedback submission flow (guest form -> API -> database -> owner notification -> backoffice queue)
</objective>

<execution_context>
@/Users/gianfrancodagostino/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gianfrancodagostino/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/35-guest-feedback-system/35-RESEARCH.md

Key reference files (read these for patterns):
@apps/accommodations/frontend/app/api/stay/[code]/documents/upload-url/route.ts (signed URL pattern)
@apps/accommodations/frontend/components/stay/DocumentUpload.tsx (photo upload UI pattern)
@apps/accommodations/frontend/lib/auth.ts (verifyGuestToken, requireFullAccess)
@apps/accommodations/frontend/app/stay/[code]/page.tsx (dashboard with DashboardCard grid)
@apps/accommodations/frontend/components/stay/DashboardCard.tsx (card component pattern)
@apps/accommodations/frontend/types/stay.ts (existing types to extend)
@apps/backoffice/app/(dashboard)/accommodations/orders/page.tsx (backoffice queue pattern)
@shared/database/migrations/schema/096-minibar-self-service.sql (latest migration for style reference)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Database migration + API routes for in-stay feedback</name>
  <files>
    shared/database/migrations/schema/097-accom-guest-feedback.sql
    apps/accommodations/frontend/app/api/stay/[code]/feedback/route.ts
    apps/accommodations/frontend/app/api/stay/[code]/feedback/upload-url/route.ts
    apps/accommodations/frontend/types/stay.ts
    apps/accommodations/frontend/lib/feedback-api.ts
  </files>
  <action>
    1. Create migration 097-accom-guest-feedback.sql:
       - CREATE TABLE accom_guest_feedback with columns from research schema (id UUID PK, property_id, booking_id, room_id, feedback_type TEXT CHECK in_stay/post_stay, category TEXT CHECK maintenance/housekeeping/question/complaint/compliment/other, message TEXT, photo_url TEXT, rating_cleanliness/location/value/communication/wifi/overall SMALLINT CHECK 1-5, ai_tags TEXT[] DEFAULT '{}', ai_sentiment TEXT CHECK positive/neutral/negative, ai_priority INTEGER CHECK 1-5, ai_processed_at TIMESTAMPTZ, status TEXT DEFAULT 'new' CHECK new/acknowledged/in_progress/resolved/dismissed, owner_response TEXT, responded_at TIMESTAMPTZ, guest_name TEXT, guest_room_number TEXT, created_at/updated_at TIMESTAMPTZ)
       - Add indexes: property_id, booking_id, (property_id, feedback_type), (property_id, status)
       - Add UNIQUE constraint on (booking_id, feedback_type) WHERE feedback_type = 'post_stay' (prevents duplicate post-stay feedback)
       - RLS: Enable RLS, grant ALL to service_role (guest writes go through API with supabaseAdmin)
       - Add checked_out_at TIMESTAMPTZ column to accom_bookings (ALTER TABLE) for post-stay cron timing

    2. Create POST /api/stay/[code]/feedback/route.ts:
       - Auth: verifyGuestToken from authorization header, requireFullAccess (browse-tier cannot submit)
       - Body: { category: string, message: string, photoUrl?: string }
       - Insert into accom_guest_feedback with feedback_type='in_stay', property_id/booking_id/room_id from guest token, guest_name and guest_room_number denormalized from booking lookup
       - After insert: call supabase.rpc('queue_notification') with type 'in_app', payload including room number and category, priority 'high' for complaints. Look up property owner_id from accom_properties.
       - Return 201 with feedback record

    3. Create GET /api/stay/[code]/feedback/route.ts (same file):
       - Auth: verifyGuestToken, requireFullAccess
       - Query accom_guest_feedback WHERE booking_id = guest.bookingId ORDER BY created_at DESC
       - Return feedback list (so guest can see their submissions and owner responses)

    4. Create POST /api/stay/[code]/feedback/upload-url/route.ts:
       - Follow EXACT same pattern as documents/upload-url/route.ts
       - Auth: verifyGuestToken, requireFullAccess
       - Storage bucket: 'feedback-screenshots' (document this needs manual creation in Supabase dashboard OR use supabaseAdmin.storage.createBucket with public:false, upsert on conflict)
       - Path: `${propertyId}/${bookingId}/feedback/${Date.now()}.jpg`
       - Return signed upload URL

    5. Add types to types/stay.ts:
       - GuestFeedback interface matching table columns
       - FeedbackCategory type: 'maintenance' | 'housekeeping' | 'question' | 'complaint' | 'compliment' | 'other'
       - FeedbackStatus type: 'new' | 'acknowledged' | 'in_progress' | 'resolved' | 'dismissed'

    6. Create lib/feedback-api.ts with client-side fetch helpers:
       - submitFeedback(code, token, data) -> POST /api/stay/{code}/feedback
       - getFeedback(code, token) -> GET /api/stay/{code}/feedback
       - getFeedbackUploadUrl(code, token) -> POST /api/stay/{code}/feedback/upload-url

    IMPORTANT: Use supabaseAdmin (getSupabaseAdmin()) for ALL database operations in guest-facing routes. Guest JWT is NOT a Supabase session. Do NOT use auth.uid() in RLS for guest routes.

  </action>
  <verify>
    - Migration SQL is valid (no syntax errors, CHECK constraints correct)
    - TypeScript compiles: cd apps/accommodations/frontend && npx tsc --noEmit (check feedback files)
    - API route exports POST and GET
  </verify>
  <done>
    Migration 097 creates accom_guest_feedback table with all columns and indexes. POST /api/stay/[code]/feedback accepts category+message+photoUrl, inserts with supabaseAdmin, queues owner notification. GET returns guest's feedback list. Upload URL route provides signed URLs for photo attachments. Types and client helpers exist.
  </done>
</task>

<task type="auto">
  <name>Task 2: Guest feedback form + dashboard card + backoffice feedback queue</name>
  <files>
    apps/accommodations/frontend/components/stay/FeedbackForm.tsx
    apps/accommodations/frontend/app/stay/[code]/page.tsx
    apps/backoffice/app/(dashboard)/accommodations/feedback/page.tsx
  </files>
  <action>
    1. Create FeedbackForm.tsx as a bottom sheet / drawer component:
       - Multi-step flow: category -> details -> photo (optional) -> submitting -> done
       - Step 1 (Category): Grid of 4 tappable category cards with Phosphor icons:
         - Maintenance (Wrench, orange #E07A5F)
         - Housekeeping (Broom, teal #3D8B87)
         - Question (Question, indigo #6366F1)
         - Complaint (Warning, red #DC2626)
       - Step 2 (Details): textarea for message (required, min 10 chars)
       - Step 3 (Photo): Optional photo capture/upload. Reuse the image processing pattern from DocumentUpload.tsx (processDocumentImage for HEIC + compression). Call feedback upload-url API, then upload to signed URL, then include photoUrl in submission.
       - Step 4 (Submitting): Loading spinner
       - Step 5 (Done): Success message with checkmark, auto-close after 2s
       - Error state: Show error message with retry button
       - Props: isOpen, onClose, stayCode, token
       - Use Phosphor icons throughout, Tailwind for styling
       - Follow existing bottom sheet pattern from ContactSheet.tsx or HouseRulesSheet.tsx

    2. Wire FeedbackForm into dashboard page (app/stay/[code]/page.tsx):
       - Add a "Feedback" DashboardCard to the grid. Use ChatDots icon from Phosphor, color '#8B5CF6' (purple). Place it after the existing cards (after Concierge or last card in grid).
       - Card tap opens FeedbackForm bottom sheet (useState for isOpen)
       - Only show card for full-access guests (not browse-tier) -- check session tier

    3. Create backoffice feedback queue page at /accommodations/feedback/page.tsx:
       - Page title: "Guest Feedback"
       - Fetch feedback from accom_guest_feedback WHERE property_id = current property, ordered by created_at DESC
       - Filter tabs: All | New | In Progress | Resolved (count badges on each)
       - Each feedback row shows: guest_name, guest_room_number, category (with icon), message preview (truncated), photo thumbnail if exists, status badge, time ago
       - Click row expands to show full message, photo (if any), and response form
       - Owner can update status (dropdown: acknowledged, in_progress, resolved, dismissed) and write a text response (saved to owner_response + responded_at)
       - Use existing backoffice layout patterns (page header, card layout, Tailwind)
       - Add sidebar nav link: "Feedback" under Accommodations section with ChatDots icon

    IMPORTANT for FeedbackForm: Import processDocumentImage from '@/lib/image-utils' for photo processing. Do NOT build a new image pipeline. Follow DocumentUpload.tsx patterns for camera/file input and compression.

  </action>
  <verify>
    - FeedbackForm renders without errors
    - Dashboard card appears in grid
    - Backoffice page loads at /accommodations/feedback
    - TypeScript compiles: cd apps/accommodations/frontend && npx tsc --noEmit
    - cd apps/backoffice && npx tsc --noEmit
  </verify>
  <done>
    Guest sees Feedback card in dashboard grid. Tapping opens multi-step form (category -> text -> optional photo -> submit). Submission creates feedback record and notifies owner. Backoffice shows feedback queue with status filters, individual feedback detail, and owner response capability. Sidebar has Feedback nav link.
  </done>
</task>

</tasks>

<verification>
1. Guest can submit in-stay feedback: Open stay dashboard, tap Feedback card, select category, enter message, optionally attach photo, submit. Record appears in database.
2. Owner notification: After guest submits, check notification_queue table for new entry with feedback data.
3. Backoffice queue: Navigate to /accommodations/feedback in backoffice, see submitted feedback with correct category/message/status.
4. Owner response: Click feedback item, update status to 'acknowledged', write response. Check database for updated status and owner_response.
5. Photo upload: Submit feedback with photo attachment. Verify photo_url is populated and image accessible.
</verification>

<success_criteria>

- accom_guest_feedback table exists with all columns, indexes, and constraints
- Guest can submit feedback with category + message + optional photo via the dashboard
- Owner receives notification when feedback is submitted
- Backoffice feedback queue shows all feedback with filtering and status management
- Owner can respond to individual feedback items
  </success_criteria>

<output>
After completion, create `.planning/phases/35-guest-feedback-system/35-01-SUMMARY.md`
</output>
