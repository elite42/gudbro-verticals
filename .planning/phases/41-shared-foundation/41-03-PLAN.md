---
phase: 41-shared-foundation
plan: 03
type: execute
wave: 2
depends_on: ['41-01', '41-02']
files_modified:
  - shared/ui/components/bottom-nav.tsx
  - shared/ui/index.ts
  - shared/types/domain.ts
  - shared/types/index.ts
  - apps/gym/frontend/components/BottomNav.tsx
  - apps/laundry/frontend/components/BottomNav.tsx
  - apps/pharmacy/frontend/components/BottomNav.tsx
  - apps/workshops/frontend/components/BottomNav.tsx
  - apps/gym/frontend/package.json
  - apps/laundry/frontend/package.json
  - apps/pharmacy/frontend/package.json
  - apps/workshops/frontend/package.json
  - apps/coffeeshop/frontend/package.json
autonomous: true

must_haves:
  truths:
    - 'shared/ui/ exports a configurable BottomNav component that gym, laundry, pharmacy, and workshops all import'
    - 'shared/types/ exports MenuItem, Order, and MerchantCharge domain types'
    - 'All 5 PWAs with currency hooks/utils import from @gudbro/hooks and @gudbro/utils instead of local copies'
    - 'All local duplicate files (usePriceFormat, currency-converter, currency-preferences, BottomNav) are deleted from app directories'
    - 'All 8 PWAs have @gudbro/* workspace dependencies in package.json'
  artifacts:
    - path: 'shared/ui/components/bottom-nav.tsx'
      provides: 'Configurable BottomNav component'
      contains: 'export function BottomNav'
    - path: 'shared/types/domain.ts'
      provides: 'Consolidated domain types'
      contains: 'MenuItem'
  key_links:
    - from: 'apps/gym/frontend'
      to: '@gudbro/hooks'
      via: "import { usePriceFormat } from '@gudbro/hooks'"
      pattern: 'from.*@gudbro/hooks'
    - from: 'apps/gym/frontend'
      to: '@gudbro/ui'
      via: "import { BottomNav } from '@gudbro/ui'"
      pattern: 'from.*@gudbro/ui'
    - from: 'apps/gym/frontend'
      to: '@gudbro/utils'
      via: "import { createCurrencyPreferencesStore } from '@gudbro/utils'"
      pattern: 'from.*@gudbro/utils'
---

<objective>
Create shared BottomNav component and domain types, then migrate ALL PWA apps to use shared packages and delete all local duplicates.

Purpose: This is the migration plan that completes the shared foundation. Plans 01 and 02 created the shared modules and configs. This plan creates the remaining shared artifacts (BottomNav, domain types) and migrates every PWA to import from @gudbro/\* packages instead of local copies, then deletes all duplicates. After this plan, zero local copies of hooks/utils/BottomNav remain.

Output: Shared BottomNav in @gudbro/ui, domain types in @gudbro/types, all PWAs migrated, all duplicates deleted
</objective>

<execution_context>
@/Users/gianfrancodagostino/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gianfrancodagostino/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/41-shared-foundation/41-RESEARCH.md
@.planning/phases/41-shared-foundation/41-01-SUMMARY.md
@.planning/phases/41-shared-foundation/41-02-SUMMARY.md

# BottomNav reference implementations:

@apps/gym/frontend/components/BottomNav.tsx
@apps/laundry/frontend/components/BottomNav.tsx
@apps/pharmacy/frontend/components/BottomNav.tsx
@apps/workshops/frontend/components/BottomNav.tsx

# Existing shared types (check for conflicts):

@shared/types/custom.ts
@shared/types/index.ts

# Existing shared UI:

@shared/ui/index.ts
@shared/ui/components/button.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create shared BottomNav component and domain types</name>
  <files>
    shared/ui/components/bottom-nav.tsx
    shared/ui/index.ts
    shared/types/domain.ts
    shared/types/index.ts
  </files>
  <action>
    **shared/ui/components/bottom-nav.tsx:**
    Create a configurable BottomNav component that replaces 4 separate implementations. Follow the code example from 41-RESEARCH.md closely.

    Key design:
    - `'use client'` directive at top
    - Import `Link` from 'next/link', `usePathname` from 'next/navigation'
    - Export `NavItem` interface: `{ label: string; href: string; icon: (active: boolean) => ReactNode; isCenter?: boolean }`
    - Export `BottomNavProps` interface: `{ items: NavItem[]; activeColor: string; borderColor?: string; onCenterClick?: () => void; centerBadge?: number }`
    - Export `BottomNav` component that:
      - Renders a fixed-bottom nav with `pb-safe md:hidden`
      - Maps over items, determines active state by pathname matching
      - Center item: If `onCenterClick` is provided, renders as `<button>` (gym/laundry pattern). Otherwise renders as `<Link>` (pharmacy/workshops pattern)
      - Badge support on center item (laundry uses this for order count)
      - Active state: scale(1.1) transform + activeColor, matching current implementations
      - Inactive: `var(--charcoal-muted)` color
    - Follow the styling conventions of existing @gudbro/ui components (see button.tsx for reference)

    **shared/ui/index.ts:** Add `export { BottomNav, type NavItem, type BottomNavProps } from './components/bottom-nav'` to the existing barrel exports. Do NOT remove any existing exports.

    **shared/types/domain.ts:**
    Create consolidated domain types. Check what already exists in shared/types/custom.ts first -- if MenuItem is already defined there, ensure no conflict.
    - Export `MenuItem` type (with id, name, description, price, category, image, etc.)
    - Export `Order` type (with id, items, total, status, timestamps, etc.)
    - Export `MerchantCharge` type (with id, amount, currency, description, etc.)
    - Base these on the actual types used across apps -- read the existing types in apps/coffeeshop/frontend/types/, apps/gym/frontend/types/, etc. to find the real shapes
    - If shared/types/custom.ts already has MenuItem, re-export it from domain.ts or update custom.ts and export from there

    **shared/types/index.ts:** Add barrel exports for new domain types. Do NOT remove existing exports.

  </action>
  <verify>
    Run `pnpm --filter @gudbro/ui build` -- must succeed.
    Run `pnpm --filter @gudbro/types build` -- must succeed.
    Verify BottomNav export: `grep "BottomNav" shared/ui/index.ts` should show the export.
    Verify domain types: `grep -E "MenuItem|Order|MerchantCharge" shared/types/domain.ts` should match all three.
  </verify>
  <done>
    @gudbro/ui exports BottomNav, NavItem, BottomNavProps. @gudbro/types exports MenuItem, Order, MerchantCharge domain types. Both packages build successfully.
  </done>
</task>

<task type="auto">
  <name>Task 2: Migrate all PWAs to shared imports and delete duplicates</name>
  <files>
    apps/coffeeshop/frontend/package.json
    apps/gym/frontend/package.json
    apps/laundry/frontend/package.json
    apps/pharmacy/frontend/package.json
    apps/workshops/frontend/package.json
    apps/coffeeshop/frontend/lib/hooks/usePriceFormat.ts (DELETE)
    apps/coffeeshop/frontend/lib/currency-converter.ts (DELETE)
    apps/coffeeshop/frontend/lib/currency-preferences.ts (DELETE)
    apps/gym/frontend/lib/hooks/usePriceFormat.ts (DELETE)
    apps/gym/frontend/lib/currency-converter.ts (DELETE)
    apps/gym/frontend/lib/currency-preferences.ts (DELETE)
    apps/gym/frontend/components/BottomNav.tsx (DELETE)
    apps/laundry/frontend/lib/hooks/usePriceFormat.ts (DELETE)
    apps/laundry/frontend/lib/currency-converter.ts (DELETE)
    apps/laundry/frontend/lib/currency-preferences.ts (DELETE)
    apps/laundry/frontend/components/BottomNav.tsx (DELETE)
    apps/pharmacy/frontend/lib/hooks/usePriceFormat.ts (DELETE)
    apps/pharmacy/frontend/lib/currency-converter.ts (DELETE)
    apps/pharmacy/frontend/lib/currency-preferences.ts (DELETE)
    apps/pharmacy/frontend/components/BottomNav.tsx (DELETE)
    apps/workshops/frontend/lib/hooks/usePriceFormat.ts (DELETE)
    apps/workshops/frontend/lib/currency-converter.ts (DELETE)
    apps/workshops/frontend/lib/currency-preferences.ts (DELETE)
    apps/workshops/frontend/components/BottomNav.tsx (DELETE)
  </files>
  <action>
    This is the critical migration task. For EACH of the 5 PWAs with duplicates (coffeeshop, gym, laundry, pharmacy, workshops), follow this exact order per app:

    **Step 1: Update package.json dependencies**
    Add workspace dependencies (if not already present):
    ```json
    "@gudbro/hooks": "workspace:*",
    "@gudbro/utils": "workspace:*",
    "@gudbro/ui": "workspace:*",
    "@gudbro/types": "workspace:*",
    "@gudbro/config": "workspace:*"
    ```

    **Step 2: Run pnpm install** (once after all package.json updates)

    **Step 3: Create per-app currency setup file**
    Each app needs a thin setup file that creates its app-specific currency store and converter instances. Create `lib/currency.ts` (or similar) in each app:
    ```typescript
    import { createCurrencyPreferencesStore, createCurrencyConverter } from '@gudbro/utils';
    import { appConfig } from '@/config'; // or wherever the app config lives

    export const currencyPreferencesStore = createCurrencyPreferencesStore({
      storageKeyPrefix: 'gudbro-gym', // app-specific prefix
      baseCurrency: appConfig.i18n.baseCurrency || 'VND',
    });

    export const currencyConverter = createCurrencyConverter({
      baseCurrency: appConfig.i18n.baseCurrency || 'VND',
      fallbackRates: { /* use existing app's rates */ },
    });

    export const { formatConvertedPrice } = currencyConverter;
    ```
    Adapt this pattern for each app based on its existing config structure.

    **Step 4: Update all import statements**
    Find every file that imports from the local hooks/utils:
    - `@/lib/hooks/usePriceFormat` -> `@gudbro/hooks`
    - `@/lib/currency-converter` -> the new `@/lib/currency` setup file (for app-specific instances)
    - `@/lib/currency-preferences` -> the new `@/lib/currency` setup file
    - `@/components/BottomNav` -> `@gudbro/ui` (for gym, laundry, pharmacy, workshops)

    For BottomNav migration: Each app currently defines its nav items inline. After migration, each app will define its `NavItem[]` array locally and pass it to the shared `<BottomNav items={items} activeColor="var(--orange-hex)" />`.

    **Step 5: Handle workshops divergence**
    Workshops has a different usePriceFormat API (`format`/`formatDual` vs `formatPrice`/`formatPriceCompact`). Two options:
    - PREFERRED: Update workshops consumers to use the new API names (formatPrice instead of format)
    - ALTERNATIVE: Create a thin wrapper in workshops that maps old names to new

    Workshops also uses a functional currency-preferences API (getCurrencyPreference/setCurrencyPreference). Replace these calls with the store-based API from @gudbro/utils.

    **Step 6: Migrate config files** (from Plan 02's shared configs)
    For each of the 5 PWA frontend apps (coffeeshop, gym, laundry, pharmacy, workshops):
    - Update `tsconfig.json` to extend `../../shared/config/tsconfig.app.json` (for 3-level-deep apps) with minimal local overrides
    - Update `tailwind.config.ts` to use `presets: [require('../../shared/config/tailwind.preset.js')]` and remove duplicated theme tokens that are now in the preset
    - Update `next.config.js` to use `const { createNextConfig } = require('../../shared/config/next.config.base.js'); module.exports = createNextConfig({ port: XXXX });`
    Also migrate backoffice, waiter, and any other PWA apps (they may need `../shared/config/*` paths if they're 2 levels deep instead of 3).

    **Step 7: Delete all local duplicates**
    After ALL imports are updated and verified, delete the local files:
    - `rm apps/*/frontend/lib/hooks/usePriceFormat.ts` (5 files)
    - `rm apps/*/frontend/lib/currency-converter.ts` (5 files)
    - `rm apps/*/frontend/lib/currency-preferences.ts` (5 files)
    - `rm apps/*/frontend/components/BottomNav.tsx` (4 files: gym, laundry, pharmacy, workshops)

    **Step 8: Verify builds**
    Run `pnpm build` to verify ALL apps build successfully with shared imports.

    CRITICAL: Do NOT delete local files until imports are updated. The order matters: update imports FIRST, then delete files.

  </action>
  <verify>
    Run `pnpm build` -- ALL packages and apps must build successfully.
    Run `grep -r "from.*@/lib/hooks/usePriceFormat" apps/` -- must return ZERO results (all local imports replaced).
    Run `grep -r "from.*@/lib/currency-converter" apps/` -- must return ZERO results.
    Run `grep -r "from.*@/lib/currency-preferences" apps/` -- must return ZERO results.
    Run `ls apps/*/frontend/lib/hooks/usePriceFormat.ts 2>/dev/null` -- must return no files (all deleted).
    Run `ls apps/*/frontend/components/BottomNav.tsx 2>/dev/null` -- must return no files for gym/laundry/pharmacy/workshops.
    Run `grep -r "from.*@gudbro/hooks" apps/` -- should show imports in all 5 PWAs.
  </verify>
  <done>
    All 5 PWAs (coffeeshop, gym, laundry, pharmacy, workshops) import usePriceFormat from @gudbro/hooks, currency utilities from @gudbro/utils (via app-specific setup), and BottomNav from @gudbro/ui. All 8 PWAs use shared config files (tsconfig extends shared, tailwind uses preset, next.config uses factory). Zero local duplicates of hooks/utils/BottomNav remain. Full monorepo builds successfully.
  </done>
</task>

</tasks>

<verification>
1. `pnpm build` succeeds for the entire monorepo (all packages and apps)
2. Zero local copies of usePriceFormat remain: `find apps/ -name "usePriceFormat*" -not -path "*/node_modules/*"` returns nothing
3. Zero local copies of currency-converter remain: `find apps/ -name "currency-converter*" -not -path "*/node_modules/*"` returns nothing
4. Zero local copies of currency-preferences remain: `find apps/ -name "currency-preferences*" -not -path "*/node_modules/*"` returns nothing
5. BottomNav deleted from gym/laundry/pharmacy/workshops (may still exist in coffeeshop if it had a different one, and in menu-template)
6. All 5 PWAs have `@gudbro/hooks` in their package.json dependencies
7. All 8 PWAs extend shared tsconfig, use tailwind preset, and use next.config factory
8. Domain types (MenuItem, Order, MerchantCharge) exist in shared/types/ and are importable
</verification>

<success_criteria>

- shared/ui/ exports BottomNav used by 4 PWAs (gym, laundry, pharmacy, workshops)
- shared/types/ exports MenuItem, Order, MerchantCharge domain types
- All 5 PWAs with currency duplicates now import from @gudbro/hooks and @gudbro/utils
- All 8 PWAs extend shared config files (tsconfig, tailwind, next.config)
- Zero local duplicate files remain for hooks, utils, or BottomNav
- Full monorepo `pnpm build` succeeds
- Each app retains its app-specific configuration (port, storageKeyPrefix, colors) via config parameters
  </success_criteria>

<output>
After completion, create `.planning/phases/41-shared-foundation/41-03-SUMMARY.md`
</output>
