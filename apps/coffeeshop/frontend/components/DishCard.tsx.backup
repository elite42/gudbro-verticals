'use client';

import { useState, useEffect } from 'react';
import { ExtrasModal } from './ExtrasModal';
import { currencyPreferencesStore } from '../lib/currency-preferences';
import { formatConvertedPrice } from '../lib/currency-converter';
import { favoritesStore } from '../lib/favorites-store';
import { selectionsStore } from '../lib/selections-store';
import { coffeeshopConfig } from '../config/coffeeshop.config';

export interface Extra {
  id: string;
  name: string;
  price: number;
  type: 'size' | 'milk' | 'shot' | 'sweetener' | 'liquor' | 'addon';
}

export interface DishItem {
  id: string;
  name: string;
  description: string;
  image: string;
  price: number;
  category: string;
  origin?: string; // Product origin (italiano, vietnamita, giapponese, thailandese, etc.)
  availableExtras?: Extra[];
  customizations?: any[]; // Database-driven customizations (if product has them)
  suggestions?: DishItem[];
  dietary?: string[]; // 'vegan', 'gluten-free', 'dairy-free', etc.
  allergens?: string[]; // Auto-computed allergens from database
  isNew?: boolean; // Mark as new product
  newUntil?: string; // ISO date string - product will appear in "New" category until this date
  timeSlots?: ('breakfast' | 'lunch' | 'dinner' | 'aperitivo' | 'late-night' | 'all-day')[]; // When this product is available
}

interface DishCardProps {
  dish: DishItem;
  variant?: 'horizontal' | 'vertical' | 'grid' | 'compact';
  onAddToCart?: (dish: DishItem, quantity: number, selectedExtras: Extra[]) => void;
  onCardClick?: (dish: DishItem) => void;
}

// Helper function to get flag emoji from origin
const getOriginFlag = (origin: string | undefined): string => {
  if (!origin) return '';
  const flagMap: Record<string, string> = {
    'italiano': 'üáÆüáπ',
    'vietnamita': 'üáªüá≥',
    'giapponese': 'üáØüáµ',
    'thailandese': 'üáπüá≠',
    'cinese': 'üá®üá≥',
    'coreano': 'üá∞üá∑',
    'americano': 'üá∫üá∏',
    'messicano': 'üá≤üáΩ',
    'mediterraneo': 'üåä',
  };
  return flagMap[origin.toLowerCase()] || '';
};

export function DishCard({ dish, variant = 'vertical', onAddToCart, onCardClick }: DishCardProps) {
  const [quantity, setQuantity] = useState(0);
  const [showExtrasModal, setShowExtrasModal] = useState(false);
  const [isFavorite, setIsFavorite] = useState(() => favoritesStore.isFavorite(dish.id));
  const [showDietaryInfo, setShowDietaryInfo] = useState(false);
  const [currencyPrefs, setCurrencyPrefs] = useState(() => currencyPreferencesStore.get());
  const [imageError, setImageError] = useState(false);
  const [selectionQuantity, setSelectionQuantity] = useState(() => selectionsStore.getQuantity(dish.id));

  // Fallback image URL for broken images
  const fallbackImage = 'https://images.unsplash.com/photo-1495474472287-4d71bcdd2085?w=400&h=300&fit=crop';

  // Listen for currency preferences changes
  useEffect(() => {
    const handleCurrencyUpdate = () => {
      setCurrencyPrefs(currencyPreferencesStore.get());
    };

    if (typeof window !== 'undefined') {
      window.addEventListener('currency-preferences-updated', handleCurrencyUpdate);
      return () => window.removeEventListener('currency-preferences-updated', handleCurrencyUpdate);
    }
  }, []);

  // Listen for favorites changes
  useEffect(() => {
    const handleFavoritesUpdate = () => {
      setIsFavorite(favoritesStore.isFavorite(dish.id));
    };

    if (typeof window !== 'undefined') {
      window.addEventListener('favorites-updated', handleFavoritesUpdate);
      return () => window.removeEventListener('favorites-updated', handleFavoritesUpdate);
    }
  }, [dish.id]);

  // Listen for selections changes
  useEffect(() => {
    const handleSelectionsUpdate = () => {
      setSelectionQuantity(selectionsStore.getQuantity(dish.id));
    };

    if (typeof window !== 'undefined') {
      window.addEventListener('selections-updated', handleSelectionsUpdate);
      return () => window.removeEventListener('selections-updated', handleSelectionsUpdate);
    }
  }, [dish.id]);

  const handleIncrement = () => {
    // Check if product has customizations (new system) or availableExtras (old system)
    const hasCustomizations = dish.customizations && dish.customizations.length > 0;
    const hasExtras = dish.availableExtras && dish.availableExtras.length > 0;

    if (hasCustomizations || hasExtras) {
      // If has customizations or extras, trigger the card click to open bottom sheet/modal
      if (onCardClick) {
        onCardClick(dish);
      } else {
        // Fallback to old modal for backwards compatibility
        setShowExtrasModal(true);
      }
    } else {
      // Direct add without customizations
      setQuantity(quantity + 1);
      onAddToCart?.(dish, 1, []);
    }
  };

  const handleDecrement = () => {
    if (quantity > 0) {
      setQuantity(quantity - 1);
    }
  };

  const handleAddWithExtras = (selectedExtras: Extra[], qty: number) => {
    setQuantity(quantity + qty);
    onAddToCart?.(dish, qty, selectedExtras);
    setShowExtrasModal(false);
  };

  const handleToggleFavorite = () => {
    const newStatus = favoritesStore.toggle(dish.id);
    setIsFavorite(newStatus);
  };

  const formatPrice = (price: number) => {
    // Check if currency conversion is enabled
    if (currencyPrefs.enabled && currencyPrefs.selectedCurrency !== 'VND') {
      // Show only converted price (clean UI)
      return formatConvertedPrice(price, currencyPrefs.selectedCurrency);
    }

    // Default VND formatting
    return new Intl.NumberFormat('vi-VN', {
      style: 'currency',
      currency: 'VND'
    }).format(price);
  };

  // Compact price format: 35.000‚Ç´ ‚Üí 35K
  const formatPriceCompact = (price: number) => {
    // Check if currency conversion is enabled
    if (currencyPrefs.enabled && currencyPrefs.selectedCurrency !== 'VND') {
      // Use full formatting for non-VND currencies
      return formatConvertedPrice(price, currencyPrefs.selectedCurrency);
    }

    // VND compact format: divide by 1000 and add K
    const priceInK = Math.round(price / 1000);
    return `${priceInK}K`;
  };

  // Get category color
  const getCategoryColor = (category: string) => {
    const colors: Record<string, string> = {
      'coffee': 'bg-amber-100 text-amber-800',
      'tea': 'bg-green-100 text-green-800',
      'pastry': 'bg-pink-100 text-pink-800',
      'breakfast': 'bg-orange-100 text-orange-800',
      'lunch': 'bg-blue-100 text-blue-800',
      'dessert': 'bg-purple-100 text-purple-800',
      'beverage': 'bg-cyan-100 text-cyan-800'
    };
    return colors[category.toLowerCase()] || 'bg-gray-100 text-gray-800';
  };

  // Compact variant (super clean list view with K pricing - opens bottom sheet)
  if (variant === 'compact') {
    return (
      <div
        onClick={() => onCardClick?.(dish)}
        className="bg-white rounded-lg shadow-sm hover:shadow-md transition-all p-3 flex gap-3 items-center cursor-pointer active:scale-[0.98]"
      >
        {/* Image - Fixed size */}
        <img
          src={imageError ? fallbackImage : dish.image}
          alt={dish.name}
          className="w-20 h-20 rounded-lg object-cover flex-shrink-0"
          onError={() => setImageError(true)}
        />

        {/* Product info - Flexible */}
        <div className="flex-1 min-w-0">
          <div className="flex items-baseline gap-2 mb-1">
            <p className="font-bold text-xl text-amber-700 flex-shrink-0">
              {formatPriceCompact(dish.price)}
            </p>
            {isFavorite && (
              <svg className="w-4 h-4 text-red-500 flex-shrink-0" fill="currentColor" viewBox="0 0 24 24">
                <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z" />
              </svg>
            )}
          </div>
          <h3 className="font-semibold text-gray-900 line-clamp-2 leading-tight text-sm">
            {dish.name}
          </h3>
          {dish.origin && getOriginFlag(dish.origin) && (
            <span className="text-2xl mt-0.5">
              {getOriginFlag(dish.origin)}
            </span>
          )}
        </div>

        {/* Action buttons */}
        <div className="flex gap-2 flex-shrink-0">
          {selectionQuantity === 0 ? (
            /* Add to selections button */
            <button
              onClick={(e) => {
                e.stopPropagation();
                selectionsStore.increment(dish);
              }}
              className="w-12 h-12 bg-green-500 rounded-full font-bold text-white hover:bg-green-600 transition-all flex items-center justify-center text-2xl shadow-lg"
              title="Aggiungi alle selezioni"
            >
              +
            </button>
          ) : (
            /* Quantity controls - Red for remove, Green for add */
            <div className="flex items-center gap-2">
              <button
                onClick={(e) => {
                  e.stopPropagation();
                  selectionsStore.decrement(dish.id);
                }}
                className="w-12 h-12 bg-red-500 rounded-full font-bold text-white hover:bg-red-600 transition-all flex items-center justify-center text-2xl shadow-lg"
                title="Rimuovi"
              >
                ‚àí
              </button>
              <span className="font-bold text-gray-900 text-lg min-w-[24px] text-center">
                {selectionQuantity}
              </span>
              <button
                onClick={(e) => {
                  e.stopPropagation();
                  selectionsStore.increment(dish);
                }}
                className="w-12 h-12 bg-green-500 rounded-full font-bold text-white hover:bg-green-600 transition-all flex items-center justify-center text-2xl shadow-lg"
                title="Aggiungi"
              >
                +
              </button>
            </div>
          )}
        </div>
      </div>
    );
  }

  // Horizontal variant (list view)
  if (variant === 'horizontal') {
    const hasAllergens = dish.allergens && dish.allergens.length > 0;
    const hasDietary = dish.dietary && dish.dietary.length > 0;

    return (
      <>
        <div className="bg-white rounded-lg shadow-sm hover:shadow-md transition-all p-3 flex gap-3 relative">
          {/* Image with category above */}
          <div className="flex-shrink-0 flex flex-col gap-1">
            {/* Category badge - above image, not overlapping */}
            <span className="text-xs text-gray-600 px-2 py-0.5 bg-gray-100 rounded font-medium self-start">
              {dish.category}
            </span>
            <img
              src={imageError ? fallbackImage : dish.image}
              alt={dish.name}
              className="w-24 h-24 rounded-lg object-cover"
              onError={() => setImageError(true)}
            />
          </div>

          {/* Content */}
          <div className="flex-1 min-w-0">
            <div className="flex items-start justify-between gap-2 mb-1">
              <div className="flex-1">
                <h3 className="font-bold text-gray-800">{dish.name}</h3>
                {dish.origin && getOriginFlag(dish.origin) && (
                  <span className="text-2xl inline-block mt-1">
                    {getOriginFlag(dish.origin)}
                  </span>
                )}
              </div>
              {/* Favorite heart button - SVG with better contrast */}
              <button
                onClick={handleToggleFavorite}
                className="flex-shrink-0 hover:scale-110 transition-transform"
                aria-label="Add to favorites"
              >
                {isFavorite ? (
                  <svg className="w-6 h-6 text-red-500" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z" />
                  </svg>
                ) : (
                  <svg className="w-6 h-6 text-gray-400 hover:text-gray-600" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
                  </svg>
                )}
              </button>
            </div>

            <p className="text-sm text-gray-600 line-clamp-2 mb-1">{dish.description}</p>

            {/* Info button - shows dietary tags and allergens on click */}
            {(hasDietary || hasAllergens) && (
              <button
                onClick={() => setShowDietaryInfo(!showDietaryInfo)}
                className="text-xs text-blue-600 hover:text-blue-700 font-medium mb-1 flex items-center gap-1"
              >
                <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                  <path fillRule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clipRule="evenodd" />
                </svg>
                {showDietaryInfo ? 'Nascondi info' : 'Info nutrizionali'}
                {hasAllergens && !showDietaryInfo && <span className="text-red-600">‚ö†Ô∏è</span>}
              </button>
            )}

            {/* Dietary tags - shown only when expanded */}
            {showDietaryInfo && hasDietary && (
              <div className="flex flex-wrap gap-1 mt-1 mb-1">
                {dish.dietary?.map((tag) => (
                  <span key={tag} className="text-xs bg-green-500 text-white px-2 py-0.5 rounded">
                    üå± {tag}
                  </span>
                ))}
              </div>
            )}

            {/* Allergen warnings - shown only when expanded */}
            {showDietaryInfo && hasAllergens && (
              <div className="flex flex-wrap gap-1 mt-1 mb-1">
                {dish.allergens?.map((allergen) => (
                  <span key={allergen} className="text-xs bg-red-500 text-white px-2 py-0.5 rounded font-medium">
                    ‚ö†Ô∏è {allergen}
                  </span>
                ))}
              </div>
            )}

            <div className="flex items-center justify-between mt-2">
              {/* Price only - category moved above image */}
              <span className="font-bold text-lg text-amber-700">{formatPrice(dish.price)}</span>

              {/* Quantity controls - Unified UI starting from 0 */}
              <div className="flex items-center gap-2 bg-gray-100 rounded-full px-2 py-1">
                <button
                  onClick={handleDecrement}
                  className="w-8 h-8 bg-white rounded-full font-bold text-gray-700 hover:bg-gray-200 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                  disabled={quantity === 0}
                >
                  ‚àí
                </button>
                <span className="font-bold text-gray-800 min-w-[20px] text-center">{quantity}</span>
                <button
                  onClick={handleIncrement}
                  className={`w-8 h-8 rounded-full font-bold transition-colors flex items-center justify-center text-xs ${
                    !coffeeshopConfig.features.enableCart
                      ? 'bg-gray-300 text-gray-600 cursor-not-allowed'
                      : 'bg-amber-500 text-white hover:bg-amber-600'
                  }`}
                  disabled={!coffeeshopConfig.features.enableCart}
                  title={!coffeeshopConfig.features.enableCart ? 'Pre-ordering coming soon' : ((dish.customizations && dish.customizations.length > 0) || (dish.availableExtras && dish.availableExtras.length > 0) ? 'Customize order' : 'Add to cart')}
                >
                  {!coffeeshopConfig.features.enableCart ? 'üîí' : ((dish.customizations && dish.customizations.length > 0) || (dish.availableExtras && dish.availableExtras.length > 0) ? '‚öôÔ∏è' : '+')}
                </button>
              </div>
            </div>
          </div>
        </div>

        {/* Extras Modal */}
        {showExtrasModal && dish.availableExtras && (
          <ExtrasModal
            dish={dish}
            onClose={() => setShowExtrasModal(false)}
            onAddToCart={handleAddWithExtras}
          />
        )}
      </>
    );
  }

  // Vertical/Grid variant (card view)
  return (
    <>
      <div className="bg-white rounded-xl shadow-md hover:shadow-xl transition-all overflow-hidden">
        {/* Image with category badge and favorite */}
        <div className="relative">
          <img
            src={imageError ? fallbackImage : dish.image}
            alt={dish.name}
            className="w-full h-48 object-cover"
            onError={() => setImageError(true)}
          />
          <div className={`absolute top-3 left-3 px-3 py-1 rounded-full text-xs font-semibold ${getCategoryColor(dish.category)}`}>
            {dish.category}
          </div>
          <button
            onClick={handleToggleFavorite}
            className="absolute top-3 right-3 bg-white rounded-full p-2 shadow-md hover:scale-110 transition-transform"
          >
            {isFavorite ? '‚ù§Ô∏è' : 'ü§ç'}
          </button>
        </div>

        {/* Content */}
        <div className="p-4">
          <h3 className="font-bold text-lg text-gray-800 mb-1">{dish.name}</h3>
          {dish.origin && getOriginFlag(dish.origin) && (
            <span className="text-3xl inline-block mb-2">
              {getOriginFlag(dish.origin)}
            </span>
          )}
          <p className="text-sm text-gray-600 mb-3 line-clamp-2">{dish.description}</p>

          {/* Dietary tags */}
          {dish.dietary && dish.dietary.length > 0 && (
            <div className="flex flex-wrap gap-1 mb-3">
              {dish.dietary.map((tag) => (
                <span key={tag} className="text-xs bg-green-50 text-green-700 px-2 py-1 rounded-full">
                  {tag}
                </span>
              ))}
            </div>
          )}

          <div className="flex items-center justify-between">
            <span className="font-bold text-xl text-amber-700">{formatPrice(dish.price)}</span>

            {/* Quantity controls */}
            {quantity === 0 ? (
              <button
                onClick={handleIncrement}
                className={`px-4 py-2 rounded-full font-bold transition-all text-sm ${
                  !coffeeshopConfig.features.enableCart
                    ? 'bg-gray-300 text-gray-600 cursor-not-allowed'
                    : 'bg-gradient-to-r from-amber-500 to-orange-500 text-white hover:from-amber-600 hover:to-orange-600 transform hover:scale-105'
                }`}
                disabled={!coffeeshopConfig.features.enableCart}
                title={!coffeeshopConfig.features.enableCart ? 'Pre-ordering coming soon' : ((dish.customizations && dish.customizations.length > 0) || (dish.availableExtras && dish.availableExtras.length > 0) ? 'Customize order' : 'Add to cart')}
              >
                {!coffeeshopConfig.features.enableCart ? 'üîí Soon' : ((dish.customizations && dish.customizations.length > 0) || (dish.availableExtras && dish.availableExtras.length > 0) ? '‚öôÔ∏è' : '+')}
              </button>
            ) : (
              <div className="flex items-center gap-2 bg-gray-100 rounded-full px-2">
                <button
                  onClick={handleDecrement}
                  className="w-8 h-8 bg-white rounded-full font-bold text-gray-700 hover:bg-gray-200 transition-colors"
                >
                  ‚àí
                </button>
                <span className="font-bold text-gray-800">{quantity}</span>
                <button
                  onClick={handleIncrement}
                  className={`w-8 h-8 rounded-full font-bold transition-colors text-xs ${
                    !coffeeshopConfig.features.enableCart
                      ? 'bg-gray-300 text-gray-600 cursor-not-allowed'
                      : 'bg-white text-amber-600 hover:bg-gray-200'
                  }`}
                  disabled={!coffeeshopConfig.features.enableCart}
                  title={!coffeeshopConfig.features.enableCart ? 'Pre-ordering coming soon' : 'Add more'}
                >
                  {!coffeeshopConfig.features.enableCart ? 'üîí' : '+'}
                </button>
              </div>
            )}
          </div>
        </div>
      </div>

      {/* Extras Modal */}
      {showExtrasModal && dish.availableExtras && (
        <ExtrasModal
          dish={dish}
          onClose={() => setShowExtrasModal(false)}
          onAddToCart={handleAddWithExtras}
        />
      )}
    </>
  );
}
