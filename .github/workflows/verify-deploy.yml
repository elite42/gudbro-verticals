name: Verify Deployment

on:
  push:
    branches: [main]
  workflow_dispatch: # Allow manual triggering

concurrency:
  group: verify-deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  verify-backoffice:
    name: Verify Backoffice Deployment
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Verify backoffice health
        id: health
        run: |
          MAX_ATTEMPTS=10
          DELAY=30
          URL="https://gudbro-backoffice.vercel.app/api/health"

          echo "Waiting for Vercel deploy (up to $((MAX_ATTEMPTS * DELAY))s)..."

          for i in $(seq 1 $MAX_ATTEMPTS); do
            echo "Attempt $i/$MAX_ATTEMPTS..."

            RESPONSE=$(curl -s -w "\n%{http_code}" \
              --connect-timeout 10 --max-time 15 \
              "$URL" 2>/dev/null || echo -e "\n000")

            HTTP_CODE=$(echo "$RESPONSE" | tail -1)
            BODY=$(echo "$RESPONSE" | head -n -1)

            if [ "$HTTP_CODE" = "200" ]; then
              echo "✅ Health check passed (attempt $i)"
              echo "Response: $BODY"

              # Version check
              DEPLOYED_VERSION=$(echo "$BODY" | jq -r '.version // "unknown"')
              echo "Deployed version: $DEPLOYED_VERSION"
              echo "Expected SHA prefix: ${GITHUB_SHA:0:7}"

              if [ "$DEPLOYED_VERSION" = "${GITHUB_SHA:0:7}" ]; then
                echo "✅ Version matches! Deployment verified."
              elif [ "$DEPLOYED_VERSION" = "unknown" ] || [ "$DEPLOYED_VERSION" = "null" ]; then
                echo "::warning::Could not determine deployed version"
              else
                echo "::warning::Version mismatch - deployed: $DEPLOYED_VERSION, expected: ${GITHUB_SHA:0:7}"
              fi
              exit 0
            fi

            echo "  Status: $HTTP_CODE (waiting ${DELAY}s...)"
            [ $i -lt $MAX_ATTEMPTS ] && sleep $DELAY
          done

          echo "::error::Health check failed after $MAX_ATTEMPTS attempts (last status: $HTTP_CODE)"
          exit 1

      - name: Check PWA health endpoint
        id: pwa-health
        continue-on-error: true
        run: |
          MAX_ATTEMPTS=5
          DELAY=15
          URL="https://gudbro-coffeeshop-pwa.vercel.app/api/health"

          for i in $(seq 1 $MAX_ATTEMPTS); do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
              --connect-timeout 10 --max-time 15 \
              "$URL" 2>/dev/null || echo "000")

            if [ "$HTTP_CODE" = "200" ]; then
              echo "✅ PWA health check passed (attempt $i)"
              exit 0
            fi
            echo "Attempt $i/$MAX_ATTEMPTS: status $HTTP_CODE"
            [ $i -lt $MAX_ATTEMPTS ] && sleep $DELAY
          done

          echo "::warning::PWA health check failed after $MAX_ATTEMPTS attempts"

      - name: Summary
        run: |
          echo "## Deployment Verification Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Endpoint | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Backoffice | ${{ steps.health.outcome == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| PWA | ${{ steps.pwa-health.outcome == 'success' && '✅ Passed' || '⚠️ Skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Commit: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
