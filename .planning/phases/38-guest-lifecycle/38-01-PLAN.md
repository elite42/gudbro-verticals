---
phase: 38-guest-lifecycle
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - shared/database/migrations/schema/100-guest-lifecycle.sql
  - apps/backoffice/app/(dashboard)/accommodations/bookings/[id]/page.tsx
  - apps/accommodations/frontend/components/booking/BookingForm.tsx
  - apps/accommodations/frontend/hooks/useBookingForm.ts
  - apps/accommodations/frontend/app/api/booking/route.ts
  - apps/accommodations/frontend/components/stay/ProfileView.tsx
  - apps/accommodations/frontend/app/api/stay/[code]/checkout-request/route.ts
  - apps/backoffice/app/api/accommodations/checkout-requests/route.ts
autonomous: true

must_haves:
  truths:
    - "Backoffice booking detail shows 'Welcome back' badge with visit count when guest has prior bookings at same property"
    - 'Returning guest detection uses multi-signal matching (email OR full name+phone OR full name+country) and never matches on name alone'
    - 'Owner sees visa expiry warning banner in booking detail when guest visa expires during their stay'
    - 'Guest can submit early check-in or late checkout request from PWA profile page'
    - 'Owner sees pending checkout requests in booking detail with conflict detection against adjacent bookings'
    - 'Owner can approve or reject checkout requests with optional response message'
    - 'BookingForm collects guest nationality/country (optional field)'
  artifacts:
    - path: 'shared/database/migrations/schema/100-guest-lifecycle.sql'
      provides: 'Returning guest SQL function + accom_checkout_requests table'
      contains: 'find_returning_guest|accom_checkout_requests'
    - path: 'apps/backoffice/app/(dashboard)/accommodations/bookings/[id]/page.tsx'
      provides: 'Returning guest badge + visa alert + checkout request queue in booking detail'
      contains: 'ReturningGuestBadge|VisaExpiryOwnerAlert|CheckoutRequest'
    - path: 'apps/accommodations/frontend/app/api/stay/[code]/checkout-request/route.ts'
      provides: 'Guest checkout request POST endpoint'
      exports: ['POST']
    - path: 'apps/backoffice/app/api/accommodations/checkout-requests/route.ts'
      provides: 'Owner checkout request management (GET + PATCH)'
      exports: ['GET', 'PATCH']
  key_links:
    - from: 'apps/backoffice/app/(dashboard)/accommodations/bookings/[id]/page.tsx'
      to: 'find_returning_guest SQL function'
      via: 'supabase.rpc() call on booking detail load'
      pattern: 'rpc.*find_returning_guest'
    - from: 'apps/accommodations/frontend/components/stay/ProfileView.tsx'
      to: '/api/stay/[code]/checkout-request'
      via: 'fetch POST on form submit'
      pattern: 'checkout-request'
    - from: 'apps/backoffice/app/(dashboard)/accommodations/bookings/[id]/page.tsx'
      to: '/api/accommodations/checkout-requests'
      via: 'fetch for pending requests + PATCH for approve/reject'
      pattern: 'checkout-requests'
---

<objective>
Implement returning guest detection with multi-signal SQL matching and badge in backoffice booking detail, visa expiry alert for property owners, and early/late checkout request flow (guest form + owner approval queue with conflict detection).

Purpose: Enable property owners to recognize returning guests, proactively manage visa issues, and handle flexible checkout timing ‚Äî the core guest lifecycle management features.
Output: Migration 100 (SQL function + table), backoffice booking detail enhancements (badge + alert + request queue), guest PWA checkout request form, API routes for both sides.
</objective>

<execution_context>
@/Users/gianfrancodagostino/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gianfrancodagostino/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/38-guest-lifecycle/38-RESEARCH.md

Key existing files:
@apps/backoffice/app/(dashboard)/accommodations/bookings/[id]/page.tsx
@apps/accommodations/frontend/components/stay/ProfileView.tsx
@apps/accommodations/frontend/components/booking/BookingForm.tsx
@apps/accommodations/frontend/hooks/useBookingForm.ts
@apps/accommodations/frontend/app/api/booking/route.ts
@shared/database/migrations/schema/091-guest-documents.sql
@shared/database/migrations/schema/077-accommodations-schema.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Database migration ‚Äî returning guest function + checkout requests table + guest_country in booking API</name>
  <files>
    shared/database/migrations/schema/100-guest-lifecycle.sql
    apps/accommodations/frontend/components/booking/BookingForm.tsx
    apps/accommodations/frontend/hooks/useBookingForm.ts
    apps/accommodations/frontend/app/api/booking/route.ts
  </files>
  <action>
Create migration 100-guest-lifecycle.sql with:

1. **find_returning_guest() SQL function** (SECURITY DEFINER):
   - Parameters: p_property_id UUID, p_booking_id UUID, p_guest_email TEXT, p_guest_name TEXT, p_guest_last_name TEXT, p_guest_country TEXT, p_guest_phone TEXT
   - Returns: TABLE(previous_visits INTEGER, last_visit_date DATE)
   - Logic: Count previous completed bookings at same property (exclude current booking, status IN 'checked_out','confirmed','checked_in') matching ANY signal:
     - Signal 1: LOWER(guest_email) = LOWER(p_guest_email) when both non-null
     - Signal 2: LOWER(guest_name) = LOWER(p_guest_name) AND LOWER(guest_last_name) = LOWER(p_guest_last_name) AND guest_phone = p_guest_phone (when phone non-null)
     - Signal 3: LOWER(guest_name) = LOWER(p_guest_name) AND LOWER(guest_last_name) = LOWER(p_guest_last_name) AND guest_country = p_guest_country (when country non-null)
   - NEVER match on name alone (no signal without secondary identifier)
   - If no matches, return (0, NULL)

2. **accom_checkout_requests table**:

   ```sql
   CREATE TABLE accom_checkout_requests (
     id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
     booking_id UUID NOT NULL REFERENCES accom_bookings(id) ON DELETE CASCADE,
     property_id UUID NOT NULL REFERENCES accom_properties(id) ON DELETE CASCADE,
     request_type TEXT NOT NULL CHECK (request_type IN ('early_checkin', 'late_checkout')),
     requested_time TIME NOT NULL,
     reason TEXT,
     status TEXT NOT NULL DEFAULT 'pending' CHECK (status IN ('pending', 'approved', 'rejected')),
     owner_response TEXT,
     responded_at TIMESTAMPTZ,
     has_conflict BOOLEAN DEFAULT FALSE,
     conflict_booking_id UUID REFERENCES accom_bookings(id),
     created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
     updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
   );
   ```

   - Index on booking_id
   - Index on property_id + status (for owner queue)
   - Unique constraint on (booking_id, request_type) to prevent duplicate requests

3. **Add guest_country to BookingForm** (frontend):
   - In BookingForm.tsx: Add an optional country/nationality select field after phone input. Use a simple select with common SEA + Western countries (VN, TH, KR, JP, US, GB, AU, DE, FR, IT, etc. ‚Äî ~20 most common). Include "Other" option.
   - In useBookingForm.ts: Add `guestCountry` to form state, include in validation (optional), pass to submit.
   - In /api/booking/route.ts: Accept `guest_country` in POST body, INSERT into accom_bookings.guest_country column (column already exists from migration 079).

Do NOT create RLS policies (this follows existing pattern where backoffice uses service role key).
</action>
<verify> - Migration file exists at shared/database/migrations/schema/100-guest-lifecycle.sql with both the function and table - BookingForm.tsx has a country selector input - useBookingForm.ts has guestCountry in state - /api/booking/route.ts inserts guest_country - Run: `npx tsc --noEmit --project apps/accommodations/frontend/tsconfig.json 2>&1 | head -30` to check for type errors
</verify>
<done>
Migration 100 has find_returning_guest() function and accom_checkout_requests table. BookingForm collects optional guest country. Booking API inserts guest_country.
</done>
</task>

<task type="auto">
  <name>Task 2: Backoffice booking detail ‚Äî returning guest badge + visa expiry alert + checkout request queue</name>
  <files>
    apps/backoffice/app/(dashboard)/accommodations/bookings/[id]/page.tsx
    apps/backoffice/app/api/accommodations/checkout-requests/route.ts
  </files>
  <action>
Modify the backoffice booking detail page to add three new sections:

1. **Returning Guest Badge:**
   - On page load, call the find_returning_guest() RPC with the booking's guest data (email, name, last_name, country, phone)
   - If previous_visits > 0, show a small badge/pill next to the guest name: "üîÑ Returning Guest (Nth visit)" with last visit date
   - Use a subtle blue/purple badge styling consistent with existing BookingStatusBadge patterns
   - Badge component can be inline in this file (small enough)

2. **Visa Expiry Alert for Owner:**
   - Check the existing documents data (already fetched in booking detail) for a visa document where visa_expiry_date < check_out_date AND visa_expiry_date >= check_in_date AND superseded_by IS NULL
   - If found, show an amber/orange warning card at the top of the booking detail: "‚ö†Ô∏è Guest visa expires on {date} ‚Äî before checkout on {checkout_date}. Consider advising guest about visa extension."
   - Include the visa_extension_info text from property settings if available
   - If no visa document uploaded, do NOT show any alert (absence of data is not alarming)

3. **Checkout Request Queue:**
   - Create API route at /api/accommodations/checkout-requests with:
     - GET: Fetch requests for a booking (query param: booking_id). Returns requests with conflict info.
     - PATCH: Update request status (approve/reject) with owner_response. Set responded_at.
   - In booking detail page:
     - Fetch checkout requests for this booking
     - Show pending requests as cards with: request type, desired time, reason, conflict warning if has_conflict=true
     - Approve/Reject buttons that PATCH the request
     - For conflict detection on GET: query accom_bookings for same room on adjacent day. For late_checkout: check if another booking starts on check_out_date for same room. For early_checkin: check if another booking ends on check_in_date for same room. Set has_conflict and conflict_booking_id.

Follow existing patterns:

- Use Phosphor icons (ArrowClockwise for returning, Warning for visa, Clock for checkout)
- Use createClient() from @supabase/supabase-js with service role for API routes
- Error handling with try/catch and NextResponse.json
  </action>
  <verify> - Booking detail page imports and renders returning guest badge section - Booking detail page has visa expiry alert logic - Booking detail page shows checkout request cards with approve/reject - /api/accommodations/checkout-requests/route.ts exports GET and PATCH - Run: `npx tsc --noEmit --project apps/backoffice/tsconfig.json 2>&1 | head -30`
  </verify>
  <done>
  Backoffice booking detail shows returning guest badge (when applicable), visa expiry warning (when visa expires during stay), and checkout request management (view pending, approve/reject with conflict detection).
  </done>
  </task>

<task type="auto">
  <name>Task 3: Guest PWA ‚Äî checkout request form in ProfileView + API route</name>
  <files>
    apps/accommodations/frontend/components/stay/ProfileView.tsx
    apps/accommodations/frontend/app/api/stay/[code]/checkout-request/route.ts
  </files>
  <action>
1. **Guest checkout request API** at /api/stay/[code]/checkout-request/route.ts:
   - POST: Accept { request_type: 'early_checkin' | 'late_checkout', requested_time: string, reason?: string }
   - Validate guest JWT from request (use existing verifyGuestToken pattern from other stay API routes)
   - Look up booking via room code resolution (existing pattern)
   - Check no duplicate request exists (same booking_id + request_type)
   - Insert into accom_checkout_requests with booking_id, property_id, request_type, requested_time, reason
   - Return the created request
   - GET: Return existing requests for this booking (so guest can see status)

2. **ProfileView enhancement:**
   - Replace the "Preferences (stub for Phase 38)" section with a "Check-in / Checkout Requests" section
   - Show two buttons: "Request Early Check-in" and "Request Late Checkout"
   - Each button opens a simple inline form (not a modal): time picker (select with common times like 10:00, 11:00, 12:00 for early checkin; 14:00, 15:00, 16:00, 17:00, 18:00 for late checkout) + optional reason textarea
   - On submit, POST to /api/stay/{code}/checkout-request
   - After submission, show the request status (pending/approved/rejected) with owner response if available
   - Fetch existing requests on mount to show current status
   - If request already exists for a type, show status instead of form
   - Disable form if booking status is 'checked_out' or 'cancelled'

Follow existing ProfileView patterns:

- Use section cards with Phosphor icons (Clock for checkout requests)
- Match styling of existing sections (documents, orders)
- Use the same API base URL pattern as other stay routes
  </action>
  <verify> - /api/stay/[code]/checkout-request/route.ts exports POST and GET - ProfileView has checkout request section replacing the Phase 38 stub - ProfileView shows request form or status depending on existing request state - Run: `npx tsc --noEmit --project apps/accommodations/frontend/tsconfig.json 2>&1 | head -30`
  </verify>
  <done>
  Guest can request early check-in or late checkout from the ProfileView. API validates JWT, prevents duplicates, and stores requests. ProfileView shows request status (pending/approved/rejected) with owner response.
  </done>
  </task>

</tasks>

<verification>
1. Migration 100 creates find_returning_guest() function and accom_checkout_requests table
2. BookingForm has optional country selector, API inserts guest_country
3. Backoffice booking detail shows returning guest badge when previous visits > 0
4. Backoffice booking detail shows visa expiry alert when visa expires during stay
5. Backoffice shows checkout request cards with approve/reject and conflict detection
6. Guest PWA ProfileView has checkout request form with time selection
7. Guest API validates JWT, prevents duplicate requests, returns status
8. TypeScript compiles without errors in both apps
</verification>

<success_criteria>

- find_returning_guest() returns correct visit count (0 for new guests, N for returning)
- Visa expiry alert appears only when visa_expiry_date < check_out_date
- Guest can submit checkout request and see pending/approved/rejected status
- Owner can approve/reject with conflict warning for adjacent bookings
- BookingForm captures guest_country (optional)
- No TypeScript errors in either app
  </success_criteria>

<output>
After completion, create `.planning/phases/38-guest-lifecycle/38-01-SUMMARY.md`
</output>
