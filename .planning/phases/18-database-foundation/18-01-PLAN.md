---
phase: 18-database-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - shared/database/migrations/schema/083-accommodations-v2-foundation.sql
autonomous: true

must_haves:
  truths:
    - 'Double booking is impossible at database level (exclusion constraint rejects overlapping date ranges for same room)'
    - 'Cancelled/no-show bookings do not block future reservations (partial constraint)'
    - 'Back-to-back bookings work: guest A checks out Feb 5, guest B checks in Feb 5 (half-open [) range)'
    - 'Owner can configure booking mode, payment methods, pricing, cancellation policy on their property'
    - 'Rooms have base price, currency, images JSONB, and beds JSONB columns'
    - 'Bookings have full pricing breakdown, payment tracking, and Stripe IDs'
    - 'Service orders link to bookings with header + line items pattern and snapshot pricing'
    - 'RLS prevents cross-tenant data access on all new and extended tables'
    - 'Check-in/check-out are DATE type (already satisfied by migration 077)'
  artifacts:
    - path: 'shared/database/migrations/schema/083-accommodations-v2-foundation.sql'
      provides: 'All Phase 18 schema changes in a single migration'
      contains: 'CREATE EXTENSION IF NOT EXISTS btree_gist'
  key_links:
    - from: 'accom_service_orders'
      to: 'accom_bookings'
      via: 'FK booking_id'
      pattern: 'REFERENCES accom_bookings'
    - from: 'accom_service_order_items'
      to: 'accom_service_orders'
      via: 'FK order_id'
      pattern: 'REFERENCES accom_service_orders'
    - from: 'accom_service_order_items'
      to: 'accom_service_items'
      via: 'FK service_item_id'
      pattern: 'REFERENCES accom_service_items'
    - from: 'RLS policies'
      to: 'accom_properties owner chain'
      via: 'property_id IN (SELECT id FROM accom_properties WHERE owner_id IN (...))'
      pattern: "auth\\.uid\\(\\)"
---

<objective>
Create migration 083 with all database schema changes for Accommodations v2: extend accom_properties, accom_rooms, and accom_bookings with pricing/booking/payment columns; add exclusion constraint for double-booking prevention; create service order tables; apply RLS policies.

Purpose: Every subsequent v1.4 phase (19-24) depends on this schema being correct. Getting the foundation right means zero schema rework later.
Output: Single migration file `083-accommodations-v2-foundation.sql` covering INFRA-01 through INFRA-07.
</objective>

<execution_context>
@/Users/gianfrancodagostino/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gianfrancodagostino/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-database-foundation/18-RESEARCH.md

# Existing schema (the tables we're extending)

@shared/database/migrations/schema/077-accommodations-schema.sql

# Previous extensions (ALTER TABLE pattern reference)

@shared/database/migrations/schema/081-schema-api-alignment.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create migration 083 - Table extensions and exclusion constraint</name>
  <files>shared/database/migrations/schema/083-accommodations-v2-foundation.sql</files>
  <action>
Create `shared/database/migrations/schema/083-accommodations-v2-foundation.sql` with ALL of the following sections in order:

**Section 1: Enable btree_gist extension**

```sql
CREATE EXTENSION IF NOT EXISTS btree_gist;
```

This MUST be the first statement. Required for the exclusion constraint with UUID + daterange.

**Section 2: Extend accom_properties**
Add these columns using `ADD COLUMN IF NOT EXISTS`:

- `booking_mode TEXT NOT NULL DEFAULT 'inquiry' CHECK (booking_mode IN ('instant', 'inquiry', 'disabled'))` -- how guests book
- `accepted_payment_methods TEXT[] NOT NULL DEFAULT '{"cash"}'` -- array of payment method identifiers
- `min_nights INTEGER NOT NULL DEFAULT 1` -- minimum stay
- `max_nights INTEGER` -- nullable = no max
- `cleaning_fee INTEGER DEFAULT 0` -- minor currency units
- `service_fee_percent NUMERIC(4,2) DEFAULT 0`
- `weekly_discount_percent NUMERIC(4,2) DEFAULT 0`
- `monthly_discount_percent NUMERIC(4,2) DEFAULT 0`
- `cancellation_policy TEXT NOT NULL DEFAULT 'flexible' CHECK (cancellation_policy IN ('flexible', 'moderate', 'strict', 'non_refundable'))`
- `inquiry_timeout_hours INTEGER NOT NULL DEFAULT 24`
- `stripe_account_id TEXT` -- Stripe Connect account for this property

**Section 3: Extend accom_rooms**
Add these columns:

- `base_price_per_night INTEGER NOT NULL DEFAULT 0` -- minor currency units
- `currency TEXT NOT NULL DEFAULT 'VND'`
- `images JSONB NOT NULL DEFAULT '[]'` -- array of image URLs
- `beds JSONB NOT NULL DEFAULT '[]'` -- e.g. [{"type": "double", "count": 1}]

**Section 4: Extend accom_bookings**
Add these columns:

- `price_per_night INTEGER NOT NULL DEFAULT 0`
- `num_nights INTEGER NOT NULL DEFAULT 1`
- `subtotal INTEGER NOT NULL DEFAULT 0`
- `cleaning_fee INTEGER DEFAULT 0`
- `service_fee INTEGER DEFAULT 0`
- `discount_amount INTEGER DEFAULT 0`
- `total_price INTEGER NOT NULL DEFAULT 0`
- `currency TEXT NOT NULL DEFAULT 'VND'`
- `payment_method TEXT DEFAULT 'cash' CHECK (payment_method IN ('cash', 'card', 'bank_transfer', 'crypto', 'vnpay', 'momo'))`
- `payment_status TEXT NOT NULL DEFAULT 'unpaid' CHECK (payment_status IN ('unpaid', 'partial', 'paid', 'refunded'))`
- `stripe_payment_intent_id TEXT`
- `stripe_checkout_session_id TEXT`
- `confirmed_via TEXT CHECK (confirmed_via IN ('whatsapp', 'zalo', 'telegram', 'email', 'sms', 'auto'))`
- `expires_at TIMESTAMPTZ` -- for inquiry auto-expiry

**Section 5: Exclusion constraint on accom_bookings**

```sql
ALTER TABLE accom_bookings
  ADD CONSTRAINT accom_bookings_no_overlap
  EXCLUDE USING GIST (
    room_id WITH =,
    daterange(check_in_date, check_out_date, '[)') WITH &&
  )
  WHERE (status NOT IN ('cancelled', 'no_show'));
```

Critical details:

- `[)` means check-out day is free for new check-in (hotel convention)
- Partial constraint: cancelled/no_show bookings don't block
- btree_gist (Section 1) must be enabled first for UUID + daterange GIST index

**Section 6: Create accom_service_orders**

```sql
CREATE TABLE accom_service_orders (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  booking_id UUID NOT NULL REFERENCES accom_bookings(id) ON DELETE CASCADE,
  property_id UUID NOT NULL REFERENCES accom_properties(id) ON DELETE CASCADE,
  subtotal INTEGER NOT NULL DEFAULT 0,
  tax INTEGER DEFAULT 0,
  total INTEGER NOT NULL DEFAULT 0,
  currency TEXT NOT NULL DEFAULT 'VND',
  status TEXT NOT NULL DEFAULT 'pending'
    CHECK (status IN ('pending', 'confirmed', 'preparing', 'ready', 'delivered', 'cancelled')),
  requested_time TEXT,
  delivery_notes TEXT,
  payment_method TEXT NOT NULL DEFAULT 'room_charge'
    CHECK (payment_method IN ('room_charge', 'cash', 'card')),
  payment_status TEXT NOT NULL DEFAULT 'unpaid'
    CHECK (payment_status IN ('unpaid', 'paid')),
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
```

**Section 7: Create accom_service_order_items**

```sql
CREATE TABLE accom_service_order_items (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  order_id UUID NOT NULL REFERENCES accom_service_orders(id) ON DELETE CASCADE,
  service_item_id UUID NOT NULL REFERENCES accom_service_items(id),
  name TEXT NOT NULL,
  quantity INTEGER NOT NULL DEFAULT 1 CHECK (quantity > 0),
  unit_price INTEGER NOT NULL,
  total INTEGER NOT NULL,
  variant TEXT,
  notes TEXT
);
```

**Section 8: Triggers for updated_at**
Add update trigger on `accom_service_orders` using the existing `update_updated_at_column()` function (already defined in migration 077).

**Section 9: Indexes**

- `CREATE INDEX idx_accom_service_orders_booking ON accom_service_orders(booking_id);`
- `CREATE INDEX idx_accom_service_orders_property ON accom_service_orders(property_id);`
- `CREATE INDEX idx_accom_service_orders_status ON accom_service_orders(status);`
- `CREATE INDEX idx_accom_service_order_items_order ON accom_service_order_items(order_id);`

**Section 10: RLS policies**
Enable RLS on both new tables and add policies following the EXACT pattern from migration 077:

For `accom_service_orders`:

- Owner manages via property_id ownership chain (FOR ALL TO authenticated)
- NO anon access (guest uses SECURITY DEFINER functions)

For `accom_service_order_items`:

- Owner manages via order_id -> property_id chain (FOR ALL TO authenticated)
- NO anon access

**Section 11: Grants**

```sql
GRANT ALL ON accom_service_orders TO authenticated;
GRANT ALL ON accom_service_order_items TO authenticated;
```

Add a file header comment block matching the style of migration 077 (date, description, what changed).
</action>
<verify>
Verify the SQL file:

1. `cat shared/database/migrations/schema/083-accommodations-v2-foundation.sql` -- file exists and is not empty
2. Verify all sections present: `grep -c "CREATE EXTENSION\|ALTER TABLE accom_properties\|ALTER TABLE accom_rooms\|ALTER TABLE accom_bookings\|EXCLUDE USING GIST\|CREATE TABLE accom_service_orders\|CREATE TABLE accom_service_order_items\|ENABLE ROW LEVEL SECURITY\|GRANT ALL" shared/database/migrations/schema/083-accommodations-v2-foundation.sql` -- should be >= 9
3. Verify critical patterns: `grep "btree_gist" shared/database/migrations/schema/083-accommodations-v2-foundation.sql` -- must appear
4. Verify daterange bound: `grep "\[)" shared/database/migrations/schema/083-accommodations-v2-foundation.sql` -- must use half-open range
5. Verify partial constraint: `grep "cancelled.*no_show\|no_show.*cancelled" shared/database/migrations/schema/083-accommodations-v2-foundation.sql` -- exclusion excludes cancelled
6. Verify INTEGER prices: NO `NUMERIC` or `REAL` or `DECIMAL` types for price/amount columns (only for percent columns)
   </verify>
   <done>
   Migration file 083 exists with: btree_gist extension, accom_properties extended (11 columns), accom_rooms extended (4 columns), accom_bookings extended (14 columns), exclusion constraint with [) bound and partial WHERE clause, accom_service_orders table, accom_service_order_items table, updated_at trigger, indexes, RLS policies with owner-manages pattern, grants. All prices use INTEGER (minor units). No ENUM types used.
   </done>
   </task>

</tasks>

<verification>
1. Migration file exists at correct path: `ls shared/database/migrations/schema/083-accommodations-v2-foundation.sql`
2. File has proper header comment with date and description
3. btree_gist extension is the FIRST CREATE EXTENSION statement
4. All 3 ALTER TABLE statements present (properties, rooms, bookings)
5. Exclusion constraint uses `[)` bound and WHERE clause
6. Both service order tables have proper FK references
7. RLS enabled on both new tables
8. No ENUM types (all TEXT + CHECK)
9. All prices use INTEGER (not NUMERIC/REAL/DECIMAL)
10. Snapshot columns (name, unit_price) in order_items for historical accuracy
</verification>

<success_criteria>

- INFRA-01: Exclusion constraint on accom_bookings prevents double bookings (btree_gist + EXCLUDE USING GIST with daterange [) and partial WHERE)
- INFRA-02: accom_service_orders + accom_service_order_items tables created with FK chain
- INFRA-03: accom_properties extended with booking_mode, accepted_payment_methods, pricing config (11 columns)
- INFRA-04: accom_rooms extended with base_price_per_night, currency, images, beds (4 columns)
- INFRA-05: accom_bookings extended with pricing, payment, Stripe fields (14 columns)
- INFRA-06: RLS policies on both new tables following migration 077 pattern
- INFRA-07: Already satisfied (check_in_date/check_out_date are DATE type since migration 077)
  </success_criteria>

<output>
After completion, create `.planning/phases/18-database-foundation/18-01-SUMMARY.md`
</output>
