---
phase: 40-security-hardening
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/coffeeshop/frontend/package.json
  - apps/coffeeshop/frontend/lib/rate-limiter.ts
  - apps/coffeeshop/frontend/app/api/orders/route.ts
  - apps/coffeeshop/frontend/app/api/charges/route.ts
  - apps/accommodations/frontend/package.json
  - apps/accommodations/frontend/lib/rate-limiter.ts
  - apps/accommodations/frontend/app/api/booking/route.ts
  - apps/accommodations/frontend/app/api/stay/room/[roomCode]/verify/route.ts
autonomous: true

must_haves:
  truths:
    - 'Coffeeshop /api/orders POST returns 429 after exceeding 30 requests per minute from the same IP'
    - 'Coffeeshop /api/charges GET returns 429 after exceeding 60 requests per minute from the same IP'
    - 'Accommodations /api/booking POST returns 429 after exceeding 20 requests per minute from the same IP'
    - 'Accommodations room verify endpoint returns 429 after 5 attempts per IP per minute (booking code brute-force protection)'
    - 'All 429 responses include Retry-After header and structured JSON error body'
  artifacts:
    - path: 'apps/coffeeshop/frontend/lib/rate-limiter.ts'
      provides: 'Rate limiter config for coffeeshop public endpoints'
      contains: 'Ratelimit.slidingWindow'
    - path: 'apps/accommodations/frontend/lib/rate-limiter.ts'
      provides: 'Rate limiter config for accommodations endpoints including booking code throttle'
      contains: 'bookingCodeLimiter'
    - path: 'apps/coffeeshop/frontend/app/api/orders/route.ts'
      provides: 'Rate-limited orders endpoint'
      contains: 'withRateLimit'
    - path: 'apps/coffeeshop/frontend/app/api/charges/route.ts'
      provides: 'Rate-limited charges endpoint'
      contains: 'withRateLimit'
    - path: 'apps/accommodations/frontend/app/api/booking/route.ts'
      provides: 'Rate-limited booking endpoint'
      contains: 'withRateLimit'
  key_links:
    - from: 'apps/coffeeshop/frontend/lib/rate-limiter.ts'
      to: 'Upstash Redis'
      via: 'UPSTASH_REDIS_REST_URL + UPSTASH_REDIS_REST_TOKEN env vars'
      pattern: "new Redis\\("
    - from: 'apps/accommodations/frontend/app/api/stay/room/[roomCode]/verify/route.ts'
      to: 'apps/accommodations/frontend/lib/rate-limiter.ts'
      via: 'bookingCodeLimiter import'
      pattern: 'bookingCodeLimiter'
---

<objective>
Add Upstash-based rate limiting to all public API endpoints in coffeeshop and accommodations apps, and replace the in-memory rate limiter on the booking code verify endpoint with proper Upstash sliding window.

Purpose: Protect public endpoints from abuse (SEC-01) and prevent brute-force booking code guessing (SEC-05). These are the highest-risk public-facing gaps.

Output: Rate limiter modules in both apps, all public endpoints protected, booking code endpoint throttled to 5 attempts/min.
</objective>

<execution_context>
@/Users/gianfrancodagostino/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gianfrancodagostino/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/40-security-hardening/40-RESEARCH.md

# Existing rate limiter pattern to replicate:

@apps/backoffice/lib/security/rate-limiter.ts
@apps/backoffice/lib/cache/redis.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Upstash deps and create rate limiter modules</name>
  <files>
    apps/coffeeshop/frontend/package.json
    apps/coffeeshop/frontend/lib/rate-limiter.ts
    apps/accommodations/frontend/package.json
    apps/accommodations/frontend/lib/rate-limiter.ts
  </files>
  <action>
1. Install @upstash/ratelimit and @upstash/redis in both apps:
   - `cd apps/coffeeshop/frontend && pnpm add @upstash/ratelimit @upstash/redis`
   - `cd apps/accommodations/frontend && pnpm add @upstash/ratelimit @upstash/redis`

2. Create `apps/coffeeshop/frontend/lib/rate-limiter.ts`:
   - Import Ratelimit from @upstash/ratelimit and Redis from @upstash/redis
   - Create Redis client with `process.env.UPSTASH_REDIS_REST_URL` and `process.env.UPSTASH_REDIS_REST_TOKEN`
   - Create `publicApiLimiter` — slidingWindow(30, '1m'), prefix 'ratelimit:coffeeshop:orders' (for orders POST)
   - Create `chargesLimiter` — slidingWindow(60, '1m'), prefix 'ratelimit:coffeeshop:charges' (for charges GET — higher because menu browsing is frequent)
   - Export `getClientIdentifier(req: Request): string` — extract IP from x-forwarded-for header, fallback to 'anonymous'
   - Export `withRateLimit(req, limiter)` — checks rate limit, returns 429 Response with Retry-After header and JSON body if exceeded, or null if OK. Match the exact response format from `apps/backoffice/lib/security/rate-limiter.ts` (rateLimitExceededResponse pattern)
   - Wrap in try/catch — fail open (return null) on Redis errors for availability

3. Create `apps/accommodations/frontend/lib/rate-limiter.ts`:
   - Same Redis client setup as coffeeshop
   - Create `bookingLimiter` — slidingWindow(20, '1m'), prefix 'ratelimit:accom:booking'
   - Create `bookingCodeLimiter` — slidingWindow(5, '1m'), prefix 'ratelimit:accom:booking-code' (SEC-05: max 5 attempts per IP per minute)
   - Export same `getClientIdentifier` and `withRateLimit` utilities
   - For `bookingCodeLimiter`, consider failing CLOSED (return 429) on Redis errors since this is brute-force protection. Add a `withStrictRateLimit` variant that returns 429 on Redis errors instead of passing through.
     </action>
     <verify>
   - `cd /Users/gianfrancodagostino/Desktop/gudbro-verticals && pnpm exec tsc --noEmit -p apps/coffeeshop/frontend/tsconfig.json 2>&1 | head -20`
   - `cd /Users/gianfrancodagostino/Desktop/gudbro-verticals && pnpm exec tsc --noEmit -p apps/accommodations/frontend/tsconfig.json 2>&1 | head -20`
   - Verify both package.json files have @upstash/ratelimit and @upstash/redis in dependencies
     </verify>
     <done>Both rate limiter modules exist with correct limiters, both apps compile, Upstash deps installed</done>
     </task>

<task type="auto">
  <name>Task 2: Apply rate limiting to all public API endpoints</name>
  <files>
    apps/coffeeshop/frontend/app/api/orders/route.ts
    apps/coffeeshop/frontend/app/api/charges/route.ts
    apps/accommodations/frontend/app/api/booking/route.ts
    apps/accommodations/frontend/app/api/stay/room/[roomCode]/verify/route.ts
  </files>
  <action>
1. **Coffeeshop /api/orders/route.ts** — Add at the top of the POST handler:
   ```
   import { publicApiLimiter, getClientIdentifier, withRateLimit } from '@/lib/rate-limiter';
   const rateLimitResult = await withRateLimit(request, publicApiLimiter);
   if (rateLimitResult) return rateLimitResult;
   ```
   If there is also a GET handler, add rate limiting there too using publicApiLimiter.

2. **Coffeeshop /api/charges/route.ts** — Add at the top of the GET handler:

   ```
   import { chargesLimiter, getClientIdentifier, withRateLimit } from '@/lib/rate-limiter';
   const rateLimitResult = await withRateLimit(request, chargesLimiter);
   if (rateLimitResult) return rateLimitResult;
   ```

3. **Accommodations /api/booking/route.ts** — Add at the top of the POST handler:

   ```
   import { bookingLimiter, getClientIdentifier, withRateLimit } from '@/lib/rate-limiter';
   const rateLimitResult = await withRateLimit(request, bookingLimiter);
   if (rateLimitResult) return rateLimitResult;
   ```

4. **Accommodations room verify route** — Read the file first to understand the current in-memory rate limiting code. Then:
   - Remove the in-memory `Map<string, RateLimitEntry>` and related cleanup code
   - Replace with `bookingCodeLimiter` from `@/lib/rate-limiter`:
     ```
     import { bookingCodeLimiter, getClientIdentifier, withStrictRateLimit } from '@/lib/rate-limiter';
     const rateLimitResult = await withStrictRateLimit(request, bookingCodeLimiter);
     if (rateLimitResult) return rateLimitResult;
     ```
   - Use `withStrictRateLimit` (not `withRateLimit`) because this is brute-force protection that should fail closed
   - Remove the old rate-limit checking code but preserve ALL other logic in the handler

IMPORTANT: Read each file BEFORE modifying to understand the current structure. Do NOT break existing functionality. Only add rate limiting at the top of each handler function.
</action>
<verify> - `cd /Users/gianfrancodagostino/Desktop/gudbro-verticals && pnpm exec tsc --noEmit -p apps/coffeeshop/frontend/tsconfig.json 2>&1 | head -20` - `cd /Users/gianfrancodagostino/Desktop/gudbro-verticals && pnpm exec tsc --noEmit -p apps/accommodations/frontend/tsconfig.json 2>&1 | head -20` - grep -r "withRateLimit\|withStrictRateLimit" apps/coffeeshop/frontend/app/api/ apps/accommodations/frontend/app/api/ to confirm all 4 endpoints are protected - grep -rn "Map.\*RateLimitEntry" apps/accommodations/frontend/ to confirm old in-memory limiter is removed
</verify>
<done>All 4 public endpoints have Upstash rate limiting, old in-memory rate limiter is removed from room verify, both apps compile</done>
</task>

</tasks>

<verification>
1. TypeScript compiles for both coffeeshop and accommodations: `pnpm exec tsc --noEmit -p apps/coffeeshop/frontend/tsconfig.json && pnpm exec tsc --noEmit -p apps/accommodations/frontend/tsconfig.json`
2. Rate limiting imports present in all 4 route files: `grep -r "withRateLimit\|withStrictRateLimit" apps/coffeeshop/frontend/app/api/orders/ apps/coffeeshop/frontend/app/api/charges/ apps/accommodations/frontend/app/api/booking/ apps/accommodations/frontend/app/api/stay/`
3. No in-memory rate limiter remains: `grep -rn "Map.*RateLimitEntry\|new Map.*rate" apps/accommodations/frontend/` returns nothing
4. Upstash deps in both package.json: `grep "upstash" apps/coffeeshop/frontend/package.json apps/accommodations/frontend/package.json`
</verification>

<success_criteria>

- 2 rate limiter modules created (coffeeshop + accommodations)
- 4 API endpoints protected with Upstash rate limiting
- Booking code endpoint uses strict rate limiting (fail closed) at 5 req/min
- In-memory rate limiter removed from room verify route
- Both apps compile without TypeScript errors
  </success_criteria>

<output>
After completion, create `.planning/phases/40-security-hardening/40-01-SUMMARY.md`
</output>
