---
phase: 26-progressive-authentication
plan: 02
type: execute
wave: 2
depends_on: ['26-01']
files_modified:
  - apps/accommodations/frontend/components/stay/InlineVerification.tsx
  - apps/accommodations/frontend/hooks/useRoomSession.ts
  - apps/accommodations/frontend/app/stay/room/[roomCode]/page.tsx
autonomous: true

must_haves:
  truths:
    - 'Guest tapping a paid action sees a bottom sheet verification modal, not a redirect'
    - 'Guest can verify with last name (3+ chars partial match) and modal closes with success animation'
    - 'Guest can verify with PIN and modal closes with success animation'
    - 'After verification, the original paid action proceeds without page reload'
    - 'Session stays upgraded (full tier) for the rest of the stay — no re-verification on navigation'
    - 'Wrong credentials show friendly error message inside the modal'
    - 'After 5 failed attempts, cooldown message appears with countdown timer'
    - 'Room dashboard shows services carousel in browse tier (viewable but ordering gated)'
  artifacts:
    - path: 'apps/accommodations/frontend/components/stay/InlineVerification.tsx'
      provides: 'Bottom sheet verification modal with last name and PIN inputs'
      min_lines: 80
    - path: 'apps/accommodations/frontend/hooks/useRoomSession.ts'
      provides: 'upgradeSession method, accessTier state, fixed isMatchingRoomSession'
      contains: 'upgradeSession'
    - path: 'apps/accommodations/frontend/app/stay/room/[roomCode]/page.tsx'
      provides: 'Enhanced room dashboard with services in browse tier and verification trigger'
      contains: 'InlineVerification'
  key_links:
    - from: 'apps/accommodations/frontend/components/stay/InlineVerification.tsx'
      to: 'useRoomSession.upgradeSession'
      via: 'Calls upgradeSession on form submit'
      pattern: 'upgradeSession'
    - from: 'apps/accommodations/frontend/hooks/useRoomSession.ts'
      to: 'POST /api/stay/room/[roomCode]/verify'
      via: 'fetch in upgradeSession'
      pattern: 'api/stay/room.*verify'
    - from: 'apps/accommodations/frontend/app/stay/room/[roomCode]/page.tsx'
      to: 'InlineVerification'
      via: 'Renders modal when browse-tier guest taps paid action'
      pattern: 'InlineVerification'
---

<objective>
Frontend for progressive authentication: InlineVerification bottom sheet component, useRoomSession hook upgrade with session upgrade method, and room dashboard integration showing services in browse tier with verification gating on paid actions.

Purpose: Give guests a seamless, Apple-Pay-like inline verification experience that upgrades their session without leaving the page, so they can order services from their room QR dashboard.
Output: InlineVerification component, upgraded useRoomSession hook, enhanced room dashboard page.
</objective>

<execution_context>
@/Users/gianfrancodagostino/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gianfrancodagostino/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/26-progressive-authentication/26-CONTEXT.md
@.planning/phases/26-progressive-authentication/26-RESEARCH.md
@.planning/phases/26-progressive-authentication/26-01-SUMMARY.md

Key source files to read before implementing:
@apps/accommodations/frontend/hooks/useRoomSession.ts
@apps/accommodations/frontend/hooks/useStaySession.ts
@apps/accommodations/frontend/app/stay/room/[roomCode]/page.tsx
@apps/accommodations/frontend/app/stay/[code]/page.tsx
@apps/accommodations/frontend/components/stay/CartDrawer.tsx
@apps/accommodations/frontend/components/stay/ContactSheet.tsx
@apps/accommodations/frontend/components/stay/ServicesCarousel.tsx
@apps/accommodations/frontend/types/stay.ts
@apps/accommodations/frontend/lib/auth.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: InlineVerification component + useRoomSession upgrade</name>
  <files>
    apps/accommodations/frontend/components/stay/InlineVerification.tsx
    apps/accommodations/frontend/hooks/useRoomSession.ts
  </files>
  <action>
**1. Fix isMatchingRoomSession in useRoomSession.ts (CRITICAL BUG PREVENTION):**
- Read the current `isMatchingRoomSession` function
- It currently checks `accessTier === 'browse'` which would cause upgraded (full-tier) tokens to be treated as non-matching, triggering a re-resolve that OVERWRITES the full-tier token with a new browse-tier one
- Fix: Remove the accessTier check. Match only on `roomCode`:
  ```typescript
  function isMatchingRoomSession(token: string, roomCode: string): boolean {
    const payload = decodeJwtPayload(token);
    return payload?.roomCode === roomCode; // Accept both browse and full tier
  }
  ```

**2. Add upgradeSession method to useRoomSession:**

- Add `upgradeSession` callback that:
  1. Calls `POST /api/stay/room/${roomCode}/verify` with `{ method, value }`
  2. On success (200): replaces token in localStorage (`gudbro_stay_token`), replaces stay data in localStorage (`gudbro_stay_data`), updates React state (setToken, setStay)
  3. On 401: returns `{ success: false, error: 'verification_failed' }`
  4. On 429: returns `{ success: false, error: 'too_many_attempts', retryAfter: response.retryAfter }`
  5. On other errors: returns `{ success: false, error: 'unknown_error' }`
- Add `accessTier` to the hook's return value, derived from the current token payload
- Return type for upgradeSession: `Promise<{ success: boolean; error?: string; retryAfter?: number }>`

**3. Create InlineVerification.tsx bottom sheet component:**
Follow the CartDrawer.tsx pattern (fixed bottom sheet with backdrop).

Props:

```typescript
interface InlineVerificationProps {
  isOpen: boolean;
  onClose: () => void;
  onVerified: () => void; // Called after successful verification
  verificationMethod: 'last_name' | 'pin';
  upgradeSession: (
    method: string,
    value: string
  ) => Promise<{ success: boolean; error?: string; retryAfter?: number }>;
}
```

Component structure:

- **Backdrop:** Fixed overlay with `bg-black/50`, onClick closes (but only if not submitting)
- **Bottom sheet:** Fixed at bottom, `rounded-t-3xl`, white background, max-height 60vh
- **Drag handle:** Gray pill at top (matches ContactSheet pattern)
- **Title:** "Verify to continue" (friendly, not "Authentication Required")
- **Subtitle:** Explains what's needed:
  - For last_name: "Enter your last name to access services"
  - For pin: "Enter the room PIN to access services"
- **Input field:**
  - For last_name: text input, placeholder "Last name", autoCapitalize="words", autoFocus
  - For pin: numeric input, 4 chars, inputMode="numeric", pattern="[0-9]\*", autoFocus, large centered digits
- **Submit button:** Full-width CTA, "Verify" label, loading state during API call
- **Error state:** Red text below input, friendly message: "That doesn't match. Please try again."
- **Cooldown state:** When retryAfter > 0, show countdown timer replacing the input: "Too many attempts. Try again in X:XX" with live countdown
- **Success state:** Brief checkmark animation (CSS only, ~800ms), then calls onVerified and closes

State management:

- `value` (input text)
- `isSubmitting` (loading)
- `error` (string | null)
- `cooldownEnd` (timestamp | null)
- `showSuccess` (boolean for checkmark animation)
- `attempts` (number, client-side tracking for UI feedback)

Design tokens (match existing accommodations design system):

- Background: white
- Text: `#2D2016`
- Accent/CTA: `#3D8B87` (teal, same as existing buttons)
- Error: `#E07A5F` (coral, same as existing error states)
- Subtle: `#8B7355` (muted brown for subtitles)
- Rounded corners: `rounded-3xl` for sheet, `rounded-xl` for input and button

Animations:

- Sheet slides up on open (CSS transition, translate-y)
- Checkmark appears with scale animation on success
- Sheet slides down on close
  </action>
  <verify>
- `npx tsc --noEmit` passes in apps/accommodations/frontend
- InlineVerification.tsx exists and exports default
- useRoomSession.ts exports upgradeSession and accessTier in its return value
- isMatchingRoomSession no longer checks accessTier
  </verify>
  <done>
- InlineVerification bottom sheet renders with correct input type based on verificationMethod prop
- useRoomSession.upgradeSession calls verify API and updates localStorage + React state on success
- isMatchingRoomSession accepts both browse and full tier tokens with matching roomCode
- Error, cooldown, and success states all handled in component
  </done>
  </task>

<task type="auto">
  <name>Task 2: Room dashboard integration — services in browse tier + verification trigger</name>
  <files>
    apps/accommodations/frontend/app/stay/room/[roomCode]/page.tsx
  </files>
  <action>
Read the current room dashboard page and the full stay dashboard page (`/stay/[code]/page.tsx`) to understand how services are displayed.

**Enhance the room dashboard page to:**

1. **Show ServicesCarousel in browse tier:**
   - Import ServicesCarousel (from the stay dashboard)
   - Fetch services data from `GET /api/stay/[code]/services` (browse-tier accessible per research)
   - Display services in the active-booking browse-tier view (currently shows "coming soon" placeholder)
   - Remove the "coming soon" placeholder text

2. **Add verification trigger on paid actions:**
   - Add state: `showVerification` (boolean), `pendingAction` (callback | null)
   - When guest taps "Add to cart" or any ordering action while in browse tier (`accessTier === 'browse'`):
     - Store the intended action in `pendingAction`
     - Set `showVerification = true` (opens the modal)
   - Create a `requireFullTier` wrapper function:
     ```typescript
     const requireFullTier = (action: () => void) => {
       if (accessTier === 'full') {
         action(); // Already verified, proceed
       } else {
         setPendingAction(() => action);
         setShowVerification(true);
       }
     };
     ```
   - Pass this wrapper to any component that triggers paid actions

3. **Render InlineVerification:**
   - Import InlineVerification component
   - Render at page level (bottom of JSX, before closing fragment):
     ```tsx
     <InlineVerification
       isOpen={showVerification}
       onClose={() => {
         setShowVerification(false);
         setPendingAction(null);
       }}
       onVerified={() => {
         setShowVerification(false);
         // Execute the pending action after a brief delay (let animation finish)
         if (pendingAction) {
           setTimeout(() => {
             pendingAction();
             setPendingAction(null);
           }, 100);
         }
       }}
       verificationMethod={stay?.verificationMethod || 'last_name'}
       upgradeSession={upgradeSession}
     />
     ```

4. **After verification, enhance the page:**
   - When accessTier changes from 'browse' to 'full', the page should show:
     - Guest name greeting (now available in stay data)
     - Full ordering capability (cart, order placement)
     - Active orders section (if any)
   - This should NOT require a page reload — React state update triggers re-render
   - The `stay` object from useRoomSession will have full data after upgrade (guest name, booking code, etc.)

5. **Checkout invalidation (natural):**
   - After checkout, `resolve_room_access` returns `has_active_booking: false`
   - New QR scan produces browse-tier token
   - All paid actions gated behind verification
   - Verification fails because no active booking -> 404 from verify endpoint
   - No explicit code needed — this is handled by existing architecture

**IMPORTANT:** Do NOT copy the entire /stay/[code] page. The room dashboard should be its own page that progressively enhances. Import and reuse components (ServicesCarousel, CartDrawer, ActiveOrders) but keep the page structure appropriate for the room-code flow.

**verificationMethod source:** The `stay` data from useRoomSession should include `verificationMethod` (added to the room resolve response in Plan 26-01). Read it from `stay.verificationMethod`. Default to `'last_name'` if undefined.
</action>
<verify>

- `npx tsc --noEmit` passes
- `pnpm build --filter=accommodations-frontend` succeeds
- Room dashboard page imports InlineVerification and ServicesCarousel
- The "coming soon" placeholder is removed
- requireFullTier wrapper function exists in the page
  </verify>
  <done>
- Room dashboard shows services carousel in browse tier (viewable, not orderable)
- Tapping a paid action in browse tier opens InlineVerification bottom sheet
- After successful verification, the pending action executes without page reload
- Page re-renders with full-tier data (guest name, ordering capability)
- No regressions on the existing /stay/[code] dashboard
  </done>
  </task>

</tasks>

<verification>
- TypeScript compiles without errors
- Build succeeds
- Room dashboard page renders correctly in browse tier (services visible, ordering gated)
- InlineVerification component renders as bottom sheet with correct input type
- After verification, session upgrades and paid actions work
- Navigating away and back preserves full-tier session (isMatchingRoomSession fix)
- Existing /stay/[code] flow completely unaffected
</verification>

<success_criteria>

1. InlineVerification bottom sheet component exists with last name and PIN input modes
2. useRoomSession exposes upgradeSession method and accessTier state
3. isMatchingRoomSession no longer downgrades full-tier tokens
4. Room dashboard shows services in browse tier with verification gating on paid actions
5. After verification, page enhances in-place with full ordering capability
6. Client-side rate limiting shows cooldown UI after 5 failed attempts
   </success_criteria>

<output>
After completion, create `.planning/phases/26-progressive-authentication/26-02-SUMMARY.md`
</output>
