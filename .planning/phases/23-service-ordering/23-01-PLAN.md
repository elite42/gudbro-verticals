---
phase: 23-service-ordering
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - shared/database/migrations/schema/086-service-automation-level.sql
  - apps/accommodations/frontend/types/stay.ts
  - apps/accommodations/frontend/lib/stay-api.ts
  - apps/accommodations/frontend/app/api/stay/[code]/orders/route.ts
  - apps/accommodations/frontend/app/api/stay/[code]/orders/[orderId]/route.ts
  - apps/accommodations/frontend/app/api/stay/[code]/services/route.ts
  - apps/backoffice/lib/accommodations/helpers.ts
autonomous: true

must_haves:
  truths:
    - 'Migration 086 adds automation_level column to accom_service_categories'
    - 'Guest can POST an order via /api/stay/[code]/orders and receive order with status'
    - 'Guest can GET their orders via /api/stay/[code]/orders'
    - 'Guest can GET a single order status via /api/stay/[code]/orders/[orderId]'
    - 'Order items snapshot name and unit_price at creation time'
    - "Auto-confirm works for categories with automation_level='auto_confirm'"
    - 'Order state machine validates transitions server-side'
  artifacts:
    - path: 'shared/database/migrations/schema/086-service-automation-level.sql'
      provides: 'automation_level column on accom_service_categories'
      contains: 'automation_level'
    - path: 'apps/accommodations/frontend/types/stay.ts'
      provides: 'Order types (ServiceOrder, ServiceOrderItem, CartItem, etc.)'
      contains: 'ServiceOrder'
    - path: 'apps/accommodations/frontend/app/api/stay/[code]/orders/route.ts'
      provides: 'Guest order creation and listing API'
      exports: ['GET', 'POST']
    - path: 'apps/backoffice/lib/accommodations/helpers.ts'
      provides: 'Order state machine (ORDER_VALID_TRANSITIONS, ORDER_STATUS_COLORS)'
      contains: 'ORDER_VALID_TRANSITIONS'
  key_links:
    - from: 'apps/accommodations/frontend/app/api/stay/[code]/orders/route.ts'
      to: 'getSupabaseAdmin()'
      via: 'RLS bypass for guest order creation'
      pattern: 'getSupabaseAdmin'
    - from: 'apps/accommodations/frontend/app/api/stay/[code]/orders/route.ts'
      to: 'verifyGuestToken'
      via: 'JWT authentication'
      pattern: 'authenticateGuest'
---

<objective>
Build the database migration, TypeScript types, API routes, and helper utilities that form the foundation for service ordering.

Purpose: Every subsequent plan (guest UI, owner CRUD, order management) depends on these types, API routes, and state machine helpers being in place.
Output: Migration 086, extended stay types, guest order API (GET/POST), order state machine in backoffice helpers.
</objective>

<execution_context>
@/Users/gianfrancodagostino/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gianfrancodagostino/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-service-ordering/23-RESEARCH.md

@apps/accommodations/frontend/types/stay.ts
@apps/accommodations/frontend/lib/stay-api.ts
@apps/accommodations/frontend/lib/auth.ts
@apps/accommodations/frontend/app/api/stay/[code]/services/route.ts
@apps/backoffice/lib/accommodations/helpers.ts
@shared/database/migrations/schema/083-accommodations-v2-foundation.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migration 086 + TypeScript types + order state machine</name>
  <files>
    shared/database/migrations/schema/086-service-automation-level.sql
    apps/accommodations/frontend/types/stay.ts
    apps/backoffice/lib/accommodations/helpers.ts
  </files>
  <action>
    1. Create migration 086-service-automation-level.sql:
       ```sql
       ALTER TABLE accom_service_categories
         ADD COLUMN IF NOT EXISTS automation_level TEXT NOT NULL DEFAULT 'manual'
           CHECK (automation_level IN ('auto_confirm', 'manual', 'whatsapp_notify'));

       COMMENT ON COLUMN accom_service_categories.automation_level IS
         'Order handling: auto_confirm (instant), manual (owner confirms), whatsapp_notify (auto+notify)';
       ```

    2. Extend apps/accommodations/frontend/types/stay.ts with order types:
       - Add `ServiceItemResponse` fields: `isAlwaysAvailable: boolean`, `availableFrom: string | null`, `availableUntil: string | null` (availability hours)
       - Add `CartItem`: `{ serviceItemId: string; name: string; unitPrice: number; currency: string; quantity: number; notes: string; }`
       - Add `ServiceOrder`: `{ id: string; status: string; requestedTime: string | null; deliveryNotes: string | null; subtotal: number; tax: number; total: number; currency: string; items: ServiceOrderItem[]; createdAt: string; updatedAt: string; }`
       - Add `ServiceOrderItem`: `{ id: string; name: string; quantity: number; unitPrice: number; total: number; notes: string | null; }`
       - Add `CreateOrderRequest`: `{ items: { serviceItemId: string; quantity: number; notes?: string; }[]; requestedTime?: string; deliveryNotes?: string; }`
       - Add `OrdersResponse`: `{ orders: ServiceOrder[] }`
       - Add to ApiError union: `'order_not_found' | 'invalid_transition' | 'outside_hours'`

    3. Extend apps/backoffice/lib/accommodations/helpers.ts with order state machine:
       - Add `ORDER_VALID_TRANSITIONS: Record<string, string[]>`:
         pending -> ['confirmed', 'cancelled']
         confirmed -> ['preparing', 'cancelled']
         preparing -> ['ready']
         ready -> ['delivered']
       - Add `ORDER_ACTION_TO_STATUS: Record<string, string>`:
         confirm -> 'confirmed', reject -> 'cancelled', start_preparing -> 'preparing', mark_ready -> 'ready', mark_delivered -> 'delivered'
       - Add `ORDER_STATUS_COLORS: Record<string, string>`:
         pending -> 'bg-amber-100 text-amber-800'
         confirmed -> 'bg-blue-100 text-blue-800'
         preparing -> 'bg-indigo-100 text-indigo-800'
         ready -> 'bg-green-100 text-green-800'
         delivered -> 'bg-gray-100 text-gray-600'
         cancelled -> 'bg-red-100 text-red-800'
       - Add `ORDER_STATUS_LABELS: Record<string, string>`:
         pending -> 'Submitted', confirmed -> 'Confirmed', preparing -> 'Preparing', ready -> 'Ready', delivered -> 'Delivered', cancelled -> 'Cancelled'
       - Add `isValidOrderTransition(current: string, next: string): boolean` function
       - Add `buildOrderWhatsAppMessage(orderNumber: string, roomNumber: string, itemCount: number, total: number, currency: string): string` helper

  </action>
  <verify>
    - Migration SQL file exists with correct syntax
    - TypeScript types compile: `cd apps/accommodations/frontend && npx tsc --noEmit --pretty 2>&1 | head -20`
    - Backoffice compiles: `cd apps/backoffice && npx tsc --noEmit --pretty 2>&1 | head -20`
  </verify>
  <done>
    Migration 086 ready, order types exported from stay.ts, order state machine with transitions/colors/labels available in helpers.ts
  </done>
</task>

<task type="auto">
  <name>Task 2: Guest order API routes + extend stay-api + extend services endpoint</name>
  <files>
    apps/accommodations/frontend/app/api/stay/[code]/orders/route.ts
    apps/accommodations/frontend/app/api/stay/[code]/orders/[orderId]/route.ts
    apps/accommodations/frontend/app/api/stay/[code]/services/route.ts
    apps/accommodations/frontend/lib/stay-api.ts
  </files>
  <action>
    1. Extend GET /api/stay/[code]/services/route.ts:
       - Add `is_always_available`, `available_from`, `available_until` to the select query for items
       - Map to camelCase: isAlwaysAvailable, availableFrom, availableUntil
       - Add `automation_level` to category select, map to automationLevel
       - Include property timezone in response: add a `timezone` field to the response by querying accom_properties.timezone

    2. Create apps/accommodations/frontend/app/api/stay/[code]/orders/route.ts:

       **GET handler** (list orders for booking):
       - Call `authenticateGuest(request)` to get `{ bookingId, propertyId }`
       - Use `getSupabaseAdmin()` to query `accom_service_orders` WHERE booking_id = bookingId
       - Join `accom_service_order_items` for each order
       - Order by created_at DESC
       - Map snake_case to camelCase
       - Return `{ data: { orders: ServiceOrder[] } }`

       **POST handler** (create order):
       - Call `authenticateGuest(request)` to get `{ bookingId, propertyId }`
       - Parse body as `CreateOrderRequest`
       - Validate: items array non-empty, quantities 1-10
       - For each item, fetch current `accom_service_items` row (using getSupabaseAdmin):
         - Verify item belongs to this property_id
         - Verify item is in_stock
         - Check availability: if NOT is_always_available, compare current time (in property timezone from accom_properties.timezone) against available_from/available_until
         - Snapshot name and price from DB (NOT from request body)
       - Calculate subtotal (sum of quantity * unit_price), tax = 0, total = subtotal
       - Determine initial status: look up the category's automation_level for each item (if ALL items belong to auto_confirm categories, status = 'confirmed', otherwise status = 'pending')
       - Insert into accom_service_orders: booking_id, property_id, status, requested_time, delivery_notes, payment_method='room_charge', subtotal, tax, total, currency (from property)
       - Insert into accom_service_order_items: order_id, service_item_id, name (snapshot), quantity, unit_price (snapshot), total (quantity * unit_price), notes
       - Return `{ data: { order: ServiceOrder } }` with 201 status

    3. Create apps/accommodations/frontend/app/api/stay/[code]/orders/[orderId]/route.ts:

       **GET handler** (single order):
       - Call `authenticateGuest(request)` to get `{ bookingId }`
       - Query accom_service_orders WHERE id = orderId AND booking_id = bookingId (security: guest can only read own orders)
       - Join order items
       - Return `{ data: { order: ServiceOrder } }` or 404

    4. Extend apps/accommodations/frontend/lib/stay-api.ts:
       - Add `postStayAPI<T>(path: string, token: string, body: unknown): Promise<ApiResponse<T>>` function
         - Similar to fetchStayAPI but with method: 'POST', body: JSON.stringify(body), Content-Type: application/json
       - Add `fetchOrdersAPI(bookingCode: string, token: string)` convenience wrapper
       - Add `createOrderAPI(bookingCode: string, token: string, order: CreateOrderRequest)` convenience wrapper
       - Add `fetchOrderStatusAPI(bookingCode: string, token: string, orderId: string)` convenience wrapper

    Important patterns to follow:
    - Use getSupabaseAdmin() (imported from @/lib/supabase-admin) for all DB queries -- this bypasses RLS
    - authenticateGuest pattern from existing services route: extract bearer token, verify, get bookingId + propertyId
    - Map ALL snake_case DB columns to camelCase in response
    - Error responses: { error: 'message' } with appropriate HTTP status codes
    - Do NOT use request body for price data -- always snapshot from DB

  </action>
  <verify>
    - TypeScript compiles: `cd apps/accommodations/frontend && npx tsc --noEmit --pretty 2>&1 | head -20`
    - Files exist: `ls -la apps/accommodations/frontend/app/api/stay/\[code\]/orders/`
    - Build check: `cd apps/accommodations/frontend && npx next build 2>&1 | tail -20`
  </verify>
  <done>
    Guest can list orders (GET), create orders (POST with price snapshot + availability check + auto-confirm logic), and check single order status. stay-api.ts has postStayAPI helper. Services endpoint returns availability hours and automation level.
  </done>
</task>

</tasks>

<verification>
- Migration 086 SQL is valid and adds automation_level with correct CHECK constraint
- All TypeScript files compile without errors
- GET /api/stay/[code]/orders returns orders for authenticated guest
- POST /api/stay/[code]/orders creates order with snapshot prices
- Order state machine helpers exported from helpers.ts
- Services endpoint returns availability hours and timezone
</verification>

<success_criteria>

1. Migration 086 exists with automation_level column
2. Order types (ServiceOrder, CartItem, CreateOrderRequest) exported from stay.ts
3. Order state machine (transitions, colors, labels) in backoffice helpers.ts
4. Guest order API: POST creates with price snapshot + auto-confirm, GET lists, GET single
5. stay-api.ts has postStayAPI for order creation
6. Services endpoint returns availability hours and property timezone
7. All files compile cleanly
   </success_criteria>

<output>
After completion, create `.planning/phases/23-service-ordering/23-01-SUMMARY.md`
</output>
