---
phase: 34-service-expansion-minibar
plan: 03
type: execute
wave: 2
depends_on: ['34-01']
files_modified:
  - apps/accommodations/frontend/components/stay/OrderDetailSheet.tsx
  - apps/accommodations/frontend/components/stay/OrderListView.tsx
  - apps/accommodations/frontend/app/stay/[code]/page.tsx
  - apps/accommodations/frontend/components/stay/ActiveOrders.tsx
autonomous: true

must_haves:
  truths:
    - 'Order list shows category tags (food, beverage, laundry, minibar) with filtered tabs and counts'
    - 'Tapping an order reveals full item/price breakdown in a detail sheet'
    - 'No "All" tab in orders -- only category-filtered tabs'
  artifacts:
    - path: 'apps/accommodations/frontend/components/stay/OrderDetailSheet.tsx'
      provides: 'Bottom sheet with full order item/price breakdown'
      min_lines: 60
    - path: 'apps/accommodations/frontend/components/stay/OrderListView.tsx'
      provides: 'Full order list with category tabs, counts, and tap-to-detail'
      min_lines: 80
  key_links:
    - from: 'page.tsx'
      to: 'OrderListView.tsx'
      via: 'Orders card and orders-section scroll target render OrderListView'
      pattern: 'OrderListView'
    - from: 'OrderListView.tsx'
      to: 'OrderDetailSheet.tsx'
      via: 'Tapping an order opens OrderDetailSheet'
      pattern: 'OrderDetailSheet|selectedOrder'
---

<objective>
Build the order management UI: OrderDetailSheet for full order breakdown and OrderListView with category-filtered tabs. Wire into page.tsx.

Purpose: SVC-04 (order detail view), SVC-05 (order category tags), SVC-06 (remove "All" tab, show counts)
Output: New OrderDetailSheet, new OrderListView, wired into page.tsx alongside existing ActiveOrders
</objective>

<execution_context>
@/Users/gianfrancodagostino/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gianfrancodagostino/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/34-service-expansion-minibar/34-01-SUMMARY.md

Key source files:
@apps/accommodations/frontend/types/stay.ts
@apps/accommodations/frontend/components/stay/ActiveOrders.tsx
@apps/accommodations/frontend/components/stay/OrderStatusTimeline.tsx
@apps/accommodations/frontend/app/stay/[code]/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: OrderDetailSheet + OrderListView with category-filtered tabs</name>
  <files>
    apps/accommodations/frontend/components/stay/OrderDetailSheet.tsx
    apps/accommodations/frontend/components/stay/OrderListView.tsx
  </files>
  <action>
**OrderDetailSheet.tsx (new component):**

A bottom sheet that shows full order detail when tapping an order in the list.

Props:

```typescript
interface OrderDetailSheetProps {
  order: ServiceOrder | null;
  currency: string;
  onClose: () => void;
}
```

Layout (same bottom sheet pattern as ContactSheet/HouseRulesSheet):

- Fixed overlay with backdrop (bg-black/30), z-[60]
- Rounded-t-3xl white panel, max-h-[80vh], scrollable content
- Drag handle bar at top
- Only renders when `order !== null`

Content:

1. **Header**: Order status pill (reuse STATUS_BADGES from ActiveOrders) + date/time
2. **Items list**: Each item shows:
   - Name, quantity, unit price, line total
   - Notes (if any, in italic text)
   - Category tag pill (small, neutral: bg-[#FAF8F5] text-[#8B7355])
3. **Price breakdown**:
   - Subtotal
   - Tax (if > 0)
   - Divider
   - Total (bold)
4. **Delivery info** (if present):
   - Requested time
   - Delivery notes
5. **Timeline**: Reuse OrderStatusTimeline component at the bottom

Import OrderStatusTimeline from './OrderStatusTimeline'.
Import formatPrice utility (keep inline for now to avoid extra files).

**CATEGORY_TAG_CONFIG** -- shared constant used by both components:

```typescript
const CATEGORY_TAG_CONFIG: Record<
  string,
  { label: string; color: string; emoji: string }
> = {
  food: { label: 'Food', color: 'bg-orange-100 text-orange-700', emoji: 'ðŸ½ï¸' },
  beverage: {
    label: 'Drinks',
    color: 'bg-purple-100 text-purple-700',
    emoji: 'ðŸ·',
  },
  laundry: {
    label: 'Laundry',
    color: 'bg-blue-100 text-blue-700',
    emoji: 'ðŸ‘”',
  },
  minibar: {
    label: 'Minibar',
    color: 'bg-pink-100 text-pink-700',
    emoji: 'ðŸ«',
  },
  spa: { label: 'Spa', color: 'bg-teal-100 text-teal-700', emoji: 'ðŸ§–' },
  transport: {
    label: 'Transport',
    color: 'bg-amber-100 text-amber-700',
    emoji: 'ðŸš—',
  },
  activity: {
    label: 'Activity',
    color: 'bg-green-100 text-green-700',
    emoji: 'ðŸŽ¯',
  },
  general: { label: 'Other', color: 'bg-gray-100 text-gray-600', emoji: 'ðŸ“¦' },
};
```

**OrderListView.tsx (new component):**

Replaces the basic ActiveOrders rendering for a full order management view with category tabs.

Props:

```typescript
interface OrderListViewProps {
  orders: ServiceOrder[];
  currency: string;
}
```

Layout:

1. **Category tabs** (horizontal scroll, same style as ServiceCatalog tabs):
   - NO "All" tab (SVC-06 requirement)
   - Only show tabs for categories that have orders
   - Each tab shows: emoji + label + count badge
   - Default selected: first tab (most orders)
   - Tab styling: active = `bg-[#3D8B87] text-white`, inactive = `bg-[#FAF8F5] text-[#8B7355]`

2. **Filtered order list** (vertical scroll):
   - Filter orders by selected category tab (match order.categoryTag)
   - Each order card shows:
     - Category tag pill (small, in CATEGORY_TAG_CONFIG color)
     - Status pill (reuse STATUS_BADGES pattern)
     - Date (formatted: "Jan 15")
     - Items summary (first 2 item names + "and N more")
     - Total price
   - **Tap handler**: Set selectedOrder state -> opens OrderDetailSheet
   - Cards sorted by most recent first (orders already sorted from API)

3. **Empty state**: "No orders in this category" with category emoji

State:

- `selectedCategory: string` (default: computed from most common tag)
- `selectedOrder: ServiceOrder | null` (for detail sheet)

Integration note: OrderDetailSheet is rendered inside OrderListView (not in page.tsx) to keep the state co-located.

**Compute available categories:**

```typescript
const categoryGroups = useMemo(() => {
  const groups: Record<string, ServiceOrder[]> = {};
  for (const order of orders) {
    const tag = order.categoryTag || 'general';
    if (!groups[tag]) groups[tag] = [];
    groups[tag].push(order);
  }
  return groups;
}, [orders]);

const availableCategories = Object.keys(categoryGroups);
```

  </action>
  <verify>
  TypeScript compilation: `cd apps/accommodations/frontend && npx tsc --noEmit --pretty 2>&1 | head -30`
  Verify OrderDetailSheet exists: `ls apps/accommodations/frontend/components/stay/OrderDetailSheet.tsx`
  Verify OrderListView exists: `ls apps/accommodations/frontend/components/stay/OrderListView.tsx`
  Verify no "All" tab: `grep -c '"All"\|"all"' apps/accommodations/frontend/components/stay/OrderListView.tsx` should return 0
  Verify category tabs: `grep 'CATEGORY_TAG_CONFIG\|categoryGroups' apps/accommodations/frontend/components/stay/OrderListView.tsx`
  </verify>
  <done>
  OrderDetailSheet shows full order breakdown (items, prices, notes, timeline). OrderListView shows category-filtered tabs with counts, no "All" tab, and tap-to-detail navigation. Category tags displayed on each order card.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire OrderListView into page.tsx + update ActiveOrders</name>
  <files>
    apps/accommodations/frontend/app/stay/[code]/page.tsx
    apps/accommodations/frontend/components/stay/ActiveOrders.tsx
  </files>
  <action>
**page.tsx changes:**

1. **Import OrderListView** from '@/components/stay/OrderListView'
2. **Replace the orders-section content**: The orders-section div should render OrderListView for the full order history with tabs:
   ```tsx
   {
     /* Full order history with category tabs */
   }
   <div id="orders-section">
     <OrderListView orders={orders} currency={propertyCurrency} />
   </div>;
   ```
3. Keep ActiveOrders as a compact active-orders status widget above the orders section:

   ```tsx
   {
     /* Active orders quick status */
   }
   <ActiveOrders orders={orders} currency={propertyCurrency} />;

   {
     /* Full order history with category tabs */
   }
   <div id="orders-section">
     <OrderListView orders={orders} currency={propertyCurrency} />
   </div>;
   ```

**ActiveOrders.tsx -- minor update:**

- Remove redundant `className="mb-5 px-4"` from the outer section if it's inside a card wrapper with p-4
- Simplify to `<div>` with no extra margin/padding since parent handles it

**CRITICAL STATE CONTRACT CHECK after changes:**

- useStaySession, useServiceCart, useOrderPolling all still present
- showCatalog, showCart, showHouseRules, showContact states preserved
- CartFAB, CartDrawer, ServiceCatalog, HouseRulesSheet, ContactSheet still rendered
- BottomNav still at bottom
  </action>
  <verify>
  TypeScript compilation: `cd apps/accommodations/frontend && npx tsc --noEmit --pretty 2>&1 | head -30`
  Build check: `cd apps/accommodations/frontend && npx next build 2>&1 | tail -20`
  Verify OrderListView is used: `grep 'OrderListView' apps/accommodations/frontend/app/stay/\[code\]/page.tsx`
  Verify ActiveOrders still present: `grep 'ActiveOrders' apps/accommodations/frontend/app/stay/\[code\]/page.tsx`
  State contract: `grep -c "useServiceCart\|useOrderPolling\|useStaySession\|CartFAB\|CartDrawer\|ServiceCatalog\|HouseRulesSheet\|ProfileView\|ContactSheet\|OrderListView" apps/accommodations/frontend/app/stay/\[code\]/page.tsx` should return 10+
  </verify>
  <done>
  OrderListView wired into page.tsx at orders-section. ActiveOrders kept as compact status widget. All state contracts preserved. TypeScript compiles. Next.js builds.
  </done>
  </task>

</tasks>

<verification>
1. `cd apps/accommodations/frontend && npx tsc --noEmit` -- zero errors
2. `cd apps/accommodations/frontend && npx next build` -- build succeeds
3. OrderListView has category-filtered tabs (no "All" tab) with counts
4. OrderDetailSheet shows full item/price breakdown when tapping an order
5. All critical state contracts preserved (cart, orders, services, documents, token, catalog, sheets)
</verification>

<success_criteria>

- Order list shows category tags (food, beverage, laundry, minibar) with emoji pills
- No "All" tab in order list -- only category-filtered tabs with counts
- Tapping an order reveals OrderDetailSheet with full item/price breakdown and status timeline
- ActiveOrders still present as compact status widget
- TypeScript compiles without errors
- Next.js build succeeds

</success_criteria>

<output>
After completion, create `.planning/phases/34-service-expansion-minibar/34-03-SUMMARY.md`
</output>
