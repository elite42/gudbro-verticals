---
phase: 14-merchant-submission-ui
plan: 02
type: execute
wave: 2
depends_on: ['14-01']
files_modified:
  - apps/backoffice/components/settings/FeedbackSubmissionManager.tsx
  - apps/backoffice/app/api/feedback/history/route.ts
autonomous: true

must_haves:
  truths:
    - 'Merchant can view a list of their past submissions showing title, type, status, and date'
    - 'Submissions are sorted most recent first'
    - 'Merchant can click a submission to see full details (description, screenshot, status)'
    - 'New submission appears in history list immediately after submitting'
  artifacts:
    - path: 'apps/backoffice/app/api/feedback/history/route.ts'
      provides: 'GET endpoint returning merchant submissions'
      exports: ['GET']
    - path: 'apps/backoffice/components/settings/FeedbackSubmissionManager.tsx'
      provides: 'History list section below the form'
      contains: 'submissions'
  key_links:
    - from: 'FeedbackSubmissionManager.tsx'
      to: '/api/feedback/history'
      via: 'fetch GET on mount and after submit'
      pattern: 'fetch.*api/feedback/history'
    - from: 'apps/backoffice/app/api/feedback/history/route.ts'
      to: 'fb_submissions'
      via: 'supabase select query'
      pattern: 'fb_submissions'
---

<objective>
Add submission history list and detail view so merchants can see their past submissions with status, plus a GET API route for fetching submission history.

Purpose: Merchants need visibility into what they submitted and its current status. This closes the feedback loop and builds trust that submissions are being tracked.
Output: History list below the form showing all merchant submissions, with expandable detail view.
</objective>

<execution_context>
@/Users/gianfrancodagostino/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gianfrancodagostino/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-merchant-submission-ui/14-01-SUMMARY.md
@.planning/phases/14-merchant-submission-ui/14-RESEARCH.md

Key source patterns:
@apps/backoffice/app/api/settings/useful-numbers/route.ts
@apps/backoffice/components/settings/UsefulNumbersManager.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: History API route</name>
  <files>
    apps/backoffice/app/api/feedback/history/route.ts
  </files>
  <action>
Create GET endpoint at `apps/backoffice/app/api/feedback/history/route.ts`:
- Follow the useful-numbers GET route pattern exactly
- Import `createClient` from `@/lib/supabase-server`
- Accept query param: `merchantId` (required)
- Validate merchantId is present, return 400 if missing
- Query `fb_submissions` table:
  ```
  .select('id, original_title, type, status, created_at, screenshot_url, original_body')
  .eq('merchant_id', merchantId)
  .order('created_at', { ascending: false })
  ```
- Return 200 with `{ submissions: data }`
- Return 500 on DB error with `{ error: message }`
- Use `export const dynamic = 'force-dynamic'`
  </action>
  <verify>
    TypeScript compiles: `cd apps/backoffice && npx tsc --noEmit --pretty 2>&1 | head -30`
    Route exports GET function.
  </verify>
  <done>GET /api/feedback/history?merchantId=X returns merchant's submissions sorted by most recent first.</done>
</task>

<task type="auto">
  <name>Task 2: Add history list and detail view to FeedbackSubmissionManager</name>
  <files>
    apps/backoffice/components/settings/FeedbackSubmissionManager.tsx
  </files>
  <action>
Extend the existing FeedbackSubmissionManager component (created in Plan 01) to add a submission history section below the form.

**New state:**

- `submissions`: array of submission objects (from API)
- `isLoadingHistory`: boolean
- `expandedId`: string | null (which submission detail is expanded)

**Fetch history (useEffect + useCallback):**

- `fetchHistory` function: GET `/api/feedback/history?merchantId=${merchantId}`
- Call on mount and after every successful form submission
- Set isLoadingHistory during fetch

**History section (below form, separated by a divider or card boundary):**

- Section header: "Le tue segnalazioni" with count badge showing total
- If loading: Loader2 spinner
- If empty: gray italic text "Nessuna segnalazione inviata"
- If submissions exist: render a list/table of submission rows

**Each submission row:**

- Title text (truncated to 1 line if long)
- Type badge: colored pill (Bug = red, Feature = blue, Feedback/Improvement = green) using Tailwind bg + text colors
- Status badge: pill with status text. Colors:
  - pending: gray
  - processing: yellow
  - processed: blue
  - acknowledged: green
  - rejected: red
- Date: formatted as relative or short date (e.g., "30 gen 2026" using Intl.DateTimeFormat with 'it-IT' locale)
- Clickable row: toggle expandedId

**Expanded detail (when row clicked):**

- Show below the clicked row (accordion style)
- Full description text (original_body)
- Screenshot thumbnail if screenshot_url exists (clickable to open in new tab)
- Status with full label

**Type badge labels for display:**

- 'bug' -> 'Bug'
- 'feature_request' -> 'Richiesta'
- 'improvement' -> 'Feedback'
- Other -> capitalize first letter

**Status badge labels for display:**

- 'pending' -> 'In attesa'
- 'processing' -> 'In elaborazione'
- 'processed' -> 'Elaborato'
- 'acknowledged' -> 'Preso in carico'
- 'rejected' -> 'Rifiutato'
- Other -> capitalize first letter

**After successful submit (update handleSubmit from Plan 01):**

- Call fetchHistory() after form reset to refresh the list immediately

**Styling:**

- Match existing settings page card patterns (rounded-xl, border, white bg)
- History section in its own card below the form card
- Rows with hover state (bg-gray-50), pointer cursor
- Consistent spacing with rest of settings pages
  </action>
  <verify>
  TypeScript compiles: `cd apps/backoffice && npx tsc --noEmit --pretty 2>&1 | head -30`
  Component fetches from /api/feedback/history on mount.
  Submission rows display type badge, status badge, title, and date.
  Expanded view shows original_body and screenshot if present.
  </verify>
  <done>
  Merchant sees "Le tue segnalazioni" section below the form with all past submissions. Each row shows title, type badge, status badge, and date. Clicking a row expands to show full description and screenshot. List refreshes after new submission.
  </done>
  </task>

</tasks>

<verification>
1. `cd apps/backoffice && npx tsc --noEmit` - TypeScript compiles
2. Manual: Navigate to /settings/feedback after submitting feedback - history list appears below form
3. Manual: Click a submission row - detail expands showing description and screenshot
4. Manual: Submit new feedback - it appears at top of history list immediately
</verification>

<success_criteria>

- GET /api/feedback/history returns merchant's submissions sorted newest first
- History section renders below the submission form
- Each row shows title, type badge (colored), status badge (colored), and formatted date
- Clicking row expands to show full description and screenshot thumbnail
- History refreshes immediately after new submission
- Empty state shows "Nessuna segnalazione inviata"
- Italian labels for type and status badges
  </success_criteria>

<output>
After completion, create `.planning/phases/14-merchant-submission-ui/14-02-SUMMARY.md`
</output>
