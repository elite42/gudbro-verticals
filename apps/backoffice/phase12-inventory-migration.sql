-- ============================================================================
-- AI Inventory & Negotiation System - Phase 12
-- ============================================================================
-- Creates tables for inventory tracking, supplier management, purchase orders,
-- and AI-assisted negotiation drafts
--
-- Run this migration in Supabase SQL Editor
-- ============================================================================

-- ============================================================================
-- 1. INVENTORY ITEMS
-- ============================================================================

CREATE TABLE IF NOT EXISTS ai_inventory_items (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  merchant_id UUID NOT NULL REFERENCES merchants(id) ON DELETE CASCADE,
  name TEXT NOT NULL,
  category TEXT NOT NULL,
  unit TEXT NOT NULL, -- kg, liters, pieces, etc.
  current_stock NUMERIC NOT NULL DEFAULT 0,
  min_stock NUMERIC NOT NULL DEFAULT 5,
  max_stock NUMERIC NOT NULL DEFAULT 50,
  avg_daily_usage NUMERIC NOT NULL DEFAULT 0,
  last_updated TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  supplier_id UUID, -- References ai_suppliers(id), nullable
  unit_cost NUMERIC,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),

  CONSTRAINT positive_stock CHECK (current_stock >= 0),
  CONSTRAINT positive_min_stock CHECK (min_stock >= 0),
  CONSTRAINT positive_max_stock CHECK (max_stock >= 0),
  CONSTRAINT positive_usage CHECK (avg_daily_usage >= 0),
  CONSTRAINT min_less_than_max CHECK (min_stock <= max_stock)
);

CREATE INDEX IF NOT EXISTS idx_inventory_merchant ON ai_inventory_items(merchant_id);
CREATE INDEX IF NOT EXISTS idx_inventory_category ON ai_inventory_items(category);
CREATE INDEX IF NOT EXISTS idx_inventory_supplier ON ai_inventory_items(supplier_id);
CREATE INDEX IF NOT EXISTS idx_inventory_low_stock ON ai_inventory_items(merchant_id, current_stock) WHERE current_stock <= min_stock;

COMMENT ON TABLE ai_inventory_items IS 'Tracks inventory items for each merchant';
COMMENT ON COLUMN ai_inventory_items.avg_daily_usage IS 'Average daily usage for predicting when stock will run out';
COMMENT ON COLUMN ai_inventory_items.min_stock IS 'Reorder point - alert when stock drops to this level';
COMMENT ON COLUMN ai_inventory_items.max_stock IS 'Maximum storage capacity';

-- ============================================================================
-- 2. STOCK ALERTS
-- ============================================================================

CREATE TABLE IF NOT EXISTS ai_stock_alerts (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  merchant_id UUID NOT NULL REFERENCES merchants(id) ON DELETE CASCADE,
  item_id UUID NOT NULL REFERENCES ai_inventory_items(id) ON DELETE CASCADE,
  item_name TEXT NOT NULL,
  alert_type TEXT NOT NULL,
  current_level NUMERIC NOT NULL,
  threshold NUMERIC NOT NULL,
  suggested_action TEXT NOT NULL,
  priority TEXT NOT NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  resolved_at TIMESTAMPTZ,

  CONSTRAINT valid_alert_type CHECK (alert_type IN ('low_stock', 'out_of_stock', 'expiring', 'overstock')),
  CONSTRAINT valid_priority CHECK (priority IN ('low', 'medium', 'high', 'critical'))
);

CREATE INDEX IF NOT EXISTS idx_alerts_merchant ON ai_stock_alerts(merchant_id);
CREATE INDEX IF NOT EXISTS idx_alerts_item ON ai_stock_alerts(item_id);
CREATE INDEX IF NOT EXISTS idx_alerts_unresolved ON ai_stock_alerts(merchant_id, created_at) WHERE resolved_at IS NULL;
CREATE INDEX IF NOT EXISTS idx_alerts_priority ON ai_stock_alerts(priority, created_at) WHERE resolved_at IS NULL;

COMMENT ON TABLE ai_stock_alerts IS 'Stock level alerts generated by inventory analysis';
COMMENT ON COLUMN ai_stock_alerts.resolved_at IS 'Timestamp when alert was resolved (stock replenished, etc.)';

-- ============================================================================
-- 3. SUPPLIERS
-- ============================================================================

CREATE TABLE IF NOT EXISTS ai_suppliers (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  merchant_id UUID NOT NULL REFERENCES merchants(id) ON DELETE CASCADE,
  name TEXT NOT NULL,
  contact_name TEXT,
  email TEXT,
  phone TEXT,
  address TEXT,
  categories JSONB DEFAULT '[]'::jsonb, -- Array of category strings
  rating NUMERIC,
  notes TEXT,
  is_active BOOLEAN NOT NULL DEFAULT true,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),

  CONSTRAINT valid_rating CHECK (rating IS NULL OR (rating >= 1 AND rating <= 5)),
  CONSTRAINT valid_email CHECK (email IS NULL OR email ~* '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$')
);

CREATE INDEX IF NOT EXISTS idx_suppliers_merchant ON ai_suppliers(merchant_id);
CREATE INDEX IF NOT EXISTS idx_suppliers_active ON ai_suppliers(merchant_id, is_active) WHERE is_active = true;
CREATE INDEX IF NOT EXISTS idx_suppliers_categories ON ai_suppliers USING GIN(categories);

COMMENT ON TABLE ai_suppliers IS 'Supplier contacts and information for each merchant';
COMMENT ON COLUMN ai_suppliers.categories IS 'Array of product categories this supplier provides';

-- Add foreign key to inventory items after suppliers table exists
ALTER TABLE ai_inventory_items
  DROP CONSTRAINT IF EXISTS fk_inventory_supplier;

ALTER TABLE ai_inventory_items
  ADD CONSTRAINT fk_inventory_supplier
  FOREIGN KEY (supplier_id) REFERENCES ai_suppliers(id) ON DELETE SET NULL;

-- ============================================================================
-- 4. STOCK MOVEMENTS (Audit Log)
-- ============================================================================

CREATE TABLE IF NOT EXISTS ai_stock_movements (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  item_id UUID NOT NULL REFERENCES ai_inventory_items(id) ON DELETE CASCADE,
  adjustment NUMERIC NOT NULL, -- Positive = added, Negative = removed
  new_stock NUMERIC NOT NULL,
  reason TEXT NOT NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),

  CONSTRAINT valid_new_stock CHECK (new_stock >= 0)
);

CREATE INDEX IF NOT EXISTS idx_movements_item ON ai_stock_movements(item_id, created_at DESC);
CREATE INDEX IF NOT EXISTS idx_movements_date ON ai_stock_movements(created_at DESC);

COMMENT ON TABLE ai_stock_movements IS 'Audit log of all stock level changes';
COMMENT ON COLUMN ai_stock_movements.adjustment IS 'Amount added (positive) or removed (negative)';

-- ============================================================================
-- 5. PURCHASE ORDERS
-- ============================================================================

CREATE TABLE IF NOT EXISTS ai_purchase_orders (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  merchant_id UUID NOT NULL REFERENCES merchants(id) ON DELETE CASCADE,
  supplier_id UUID NOT NULL REFERENCES ai_suppliers(id) ON DELETE RESTRICT,
  supplier_name TEXT NOT NULL,
  status TEXT NOT NULL DEFAULT 'draft',
  items JSONB NOT NULL DEFAULT '[]'::jsonb, -- Array of order items
  subtotal NUMERIC NOT NULL DEFAULT 0,
  tax NUMERIC NOT NULL DEFAULT 0,
  total NUMERIC NOT NULL DEFAULT 0,
  notes TEXT,
  expected_delivery TIMESTAMPTZ,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),

  CONSTRAINT valid_status CHECK (status IN ('draft', 'sent', 'confirmed', 'delivered', 'cancelled')),
  CONSTRAINT valid_amounts CHECK (subtotal >= 0 AND tax >= 0 AND total >= 0)
);

CREATE INDEX IF NOT EXISTS idx_orders_merchant ON ai_purchase_orders(merchant_id);
CREATE INDEX IF NOT EXISTS idx_orders_supplier ON ai_purchase_orders(supplier_id);
CREATE INDEX IF NOT EXISTS idx_orders_status ON ai_purchase_orders(merchant_id, status);
CREATE INDEX IF NOT EXISTS idx_orders_date ON ai_purchase_orders(created_at DESC);

COMMENT ON TABLE ai_purchase_orders IS 'Purchase orders generated for supplier orders';
COMMENT ON COLUMN ai_purchase_orders.items IS 'Array of {itemId, itemName, quantity, unit, unitPrice, totalPrice}';

-- ============================================================================
-- 6. NEGOTIATION DRAFTS
-- ============================================================================

CREATE TABLE IF NOT EXISTS ai_negotiation_drafts (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  merchant_id UUID NOT NULL REFERENCES merchants(id) ON DELETE CASCADE,
  supplier_id UUID NOT NULL REFERENCES ai_suppliers(id) ON DELETE CASCADE,
  supplier_name TEXT NOT NULL,
  type TEXT NOT NULL,
  subject TEXT NOT NULL,
  email_draft TEXT NOT NULL,
  talking_points JSONB DEFAULT '[]'::jsonb, -- Array of talking point strings
  target_savings NUMERIC,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  used_at TIMESTAMPTZ, -- When the draft was used/sent

  CONSTRAINT valid_type CHECK (type IN ('price_reduction', 'bulk_discount', 'payment_terms', 'new_supplier'))
);

CREATE INDEX IF NOT EXISTS idx_drafts_merchant ON ai_negotiation_drafts(merchant_id);
CREATE INDEX IF NOT EXISTS idx_drafts_supplier ON ai_negotiation_drafts(supplier_id);
CREATE INDEX IF NOT EXISTS idx_drafts_date ON ai_negotiation_drafts(created_at DESC);
CREATE INDEX IF NOT EXISTS idx_drafts_unused ON ai_negotiation_drafts(merchant_id) WHERE used_at IS NULL;

COMMENT ON TABLE ai_negotiation_drafts IS 'AI-generated negotiation email drafts and talking points';
COMMENT ON COLUMN ai_negotiation_drafts.type IS 'Type of negotiation: price_reduction, bulk_discount, payment_terms, or new_supplier';
COMMENT ON COLUMN ai_negotiation_drafts.used_at IS 'Timestamp when draft was marked as used/sent';

-- ============================================================================
-- 7. ROW LEVEL SECURITY (RLS)
-- ============================================================================

-- Enable RLS on all tables
ALTER TABLE ai_inventory_items ENABLE ROW LEVEL SECURITY;
ALTER TABLE ai_stock_alerts ENABLE ROW LEVEL SECURITY;
ALTER TABLE ai_suppliers ENABLE ROW LEVEL SECURITY;
ALTER TABLE ai_stock_movements ENABLE ROW LEVEL SECURITY;
ALTER TABLE ai_purchase_orders ENABLE ROW LEVEL SECURITY;
ALTER TABLE ai_negotiation_drafts ENABLE ROW LEVEL SECURITY;

-- Drop existing policies if they exist
DROP POLICY IF EXISTS "Merchants can manage their own inventory items" ON ai_inventory_items;
DROP POLICY IF EXISTS "Merchants can view their own stock alerts" ON ai_stock_alerts;
DROP POLICY IF EXISTS "Merchants can manage their own suppliers" ON ai_suppliers;
DROP POLICY IF EXISTS "Merchants can view their own stock movements" ON ai_stock_movements;
DROP POLICY IF EXISTS "Merchants can manage their own purchase orders" ON ai_purchase_orders;
DROP POLICY IF EXISTS "Merchants can manage their own negotiation drafts" ON ai_negotiation_drafts;

-- Inventory Items Policies
CREATE POLICY "Merchants can manage their own inventory items"
  ON ai_inventory_items
  FOR ALL
  USING (
    merchant_id IN (
      SELECT merchant_id FROM account_roles
      WHERE account_id = auth.uid()
    )
  );

-- Stock Alerts Policies
CREATE POLICY "Merchants can view their own stock alerts"
  ON ai_stock_alerts
  FOR ALL
  USING (
    merchant_id IN (
      SELECT merchant_id FROM account_roles
      WHERE account_id = auth.uid()
    )
  );

-- Suppliers Policies
CREATE POLICY "Merchants can manage their own suppliers"
  ON ai_suppliers
  FOR ALL
  USING (
    merchant_id IN (
      SELECT merchant_id FROM account_roles
      WHERE account_id = auth.uid()
    )
  );

-- Stock Movements Policies
CREATE POLICY "Merchants can view their own stock movements"
  ON ai_stock_movements
  FOR SELECT
  USING (
    item_id IN (
      SELECT id FROM ai_inventory_items
      WHERE merchant_id IN (
        SELECT merchant_id FROM account_roles
        WHERE account_id = auth.uid()
      )
    )
  );

-- Purchase Orders Policies
CREATE POLICY "Merchants can manage their own purchase orders"
  ON ai_purchase_orders
  FOR ALL
  USING (
    merchant_id IN (
      SELECT merchant_id FROM account_roles
      WHERE account_id = auth.uid()
    )
  );

-- Negotiation Drafts Policies
CREATE POLICY "Merchants can manage their own negotiation drafts"
  ON ai_negotiation_drafts
  FOR ALL
  USING (
    merchant_id IN (
      SELECT merchant_id FROM account_roles
      WHERE account_id = auth.uid()
    )
  );

-- ============================================================================
-- 8. HELPER FUNCTIONS
-- ============================================================================

-- Function to automatically update updated_at timestamp
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Add trigger to suppliers table
DROP TRIGGER IF EXISTS update_suppliers_updated_at ON ai_suppliers;
CREATE TRIGGER update_suppliers_updated_at
  BEFORE UPDATE ON ai_suppliers
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();

-- Add trigger to purchase orders table
DROP TRIGGER IF EXISTS update_orders_updated_at ON ai_purchase_orders;
CREATE TRIGGER update_orders_updated_at
  BEFORE UPDATE ON ai_purchase_orders
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();

-- ============================================================================
-- 9. SAMPLE DATA (Optional - for testing)
-- ============================================================================

-- Uncomment to insert sample data for testing

/*
-- Insert sample supplier (replace merchant_id with actual UUID)
INSERT INTO ai_suppliers (merchant_id, name, email, phone, categories, rating, is_active)
VALUES (
  '00000000-0000-0000-0000-000000000001', -- Replace with actual merchant_id
  'Fresh Foods Co',
  'contact@freshfoods.com',
  '555-1234',
  '["Vegetables", "Fruits", "Dairy"]'::jsonb,
  4.5,
  true
);

-- Insert sample inventory items
INSERT INTO ai_inventory_items (merchant_id, name, category, unit, current_stock, min_stock, max_stock, avg_daily_usage)
VALUES
  ('00000000-0000-0000-0000-000000000001', 'Olive Oil', 'Cooking Oil', 'liters', 15, 5, 50, 2.5),
  ('00000000-0000-0000-0000-000000000001', 'Tomatoes', 'Vegetables', 'kg', 8, 10, 100, 5.0),
  ('00000000-0000-0000-0000-000000000001', 'Mozzarella', 'Dairy', 'kg', 3, 5, 30, 2.0);
*/

-- ============================================================================
-- MIGRATION COMPLETE
-- ============================================================================

-- Verify table creation
SELECT
  table_name,
  (SELECT COUNT(*) FROM information_schema.columns WHERE table_name = t.table_name) as column_count
FROM information_schema.tables t
WHERE table_schema = 'public'
  AND table_name LIKE 'ai_%'
ORDER BY table_name;
