---
phase: 20-payments
plan: 02
type: execute
wave: 2
depends_on: ['20-01']
files_modified:
  - apps/accommodations/frontend/components/booking/PaymentMethodSelector.tsx
  - apps/accommodations/frontend/components/booking/BankTransferInstructions.tsx
  - apps/accommodations/frontend/components/booking/CryptoPaymentOptions.tsx
  - apps/accommodations/frontend/hooks/useBookingForm.ts
  - apps/accommodations/frontend/components/booking/BookingForm.tsx
  - apps/accommodations/frontend/app/api/booking/route.ts
  - apps/accommodations/frontend/lib/booking-api.ts
  - apps/accommodations/frontend/components/booking/BookingConfirmation.tsx
  - apps/accommodations/frontend/app/api/property/[slug]/route.ts
autonomous: true

must_haves:
  truths:
    - 'Guest sees only payment methods the owner has enabled for the property'
    - 'Guest can select a payment method during booking and it is saved on the booking record'
    - 'Cash bookings are confirmed immediately (same as current instant flow)'
    - 'Bank transfer bookings show bank details after submission and stay in pending_payment'
    - 'Crypto bookings show wallet addresses and deep-links after submission and stay in pending_payment'
    - 'Booking confirmation page shows payment-specific instructions based on method chosen'
  artifacts:
    - path: 'apps/accommodations/frontend/components/booking/PaymentMethodSelector.tsx'
      provides: 'Radio-card payment method selector filtered by property config'
      min_lines: 40
    - path: 'apps/accommodations/frontend/components/booking/BankTransferInstructions.tsx'
      provides: 'Bank transfer details display for guest after booking'
      min_lines: 25
    - path: 'apps/accommodations/frontend/components/booking/CryptoPaymentOptions.tsx'
      provides: 'Crypto wallet addresses with deep-links and QR code'
      min_lines: 40
    - path: 'apps/accommodations/frontend/app/api/booking/route.ts'
      provides: 'Extended booking API that saves payment_method and handles status by method'
      contains: 'payment_method'
  key_links:
    - from: 'apps/accommodations/frontend/hooks/useBookingForm.ts'
      to: '/api/booking'
      via: 'submitBooking with paymentMethod field'
      pattern: 'paymentMethod'
    - from: 'apps/accommodations/frontend/components/booking/BookingForm.tsx'
      to: 'PaymentMethodSelector'
      via: 'import and render before submit button'
      pattern: 'PaymentMethodSelector'
    - from: 'apps/accommodations/frontend/app/api/booking/route.ts'
      to: 'accom_bookings insert'
      via: 'payment_method column in insert'
      pattern: 'payment_method.*body.paymentMethod'
---

<objective>
Build the guest-facing payment flow: payment method selection UI, booking API integration, and post-booking payment instructions.

Purpose: Guests can select a payment method during booking, and the system correctly routes them based on their choice (immediate confirmation for cash, pending_payment for bank/crypto, redirect for card).
Output: PaymentMethodSelector, BankTransferInstructions, CryptoPaymentOptions components; updated booking API and hook; enhanced confirmation page.
</objective>

<execution_context>
@/Users/gianfrancodagostino/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gianfrancodagostino/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-payments/20-RESEARCH.md
@.planning/phases/20-payments/20-01-SUMMARY.md

# Key source files to extend

@apps/accommodations/frontend/hooks/useBookingForm.ts
@apps/accommodations/frontend/components/booking/BookingForm.tsx
@apps/accommodations/frontend/app/api/booking/route.ts
@apps/accommodations/frontend/lib/booking-api.ts
@apps/accommodations/frontend/components/booking/BookingConfirmation.tsx
@apps/accommodations/frontend/types/property.ts
@apps/accommodations/frontend/app/api/property/[slug]/route.ts

# Shared payment types for crypto

@shared/payment/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create payment UI components and integrate into booking form</name>
  <files>
    apps/accommodations/frontend/components/booking/PaymentMethodSelector.tsx
    apps/accommodations/frontend/components/booking/BankTransferInstructions.tsx
    apps/accommodations/frontend/components/booking/CryptoPaymentOptions.tsx
    apps/accommodations/frontend/components/booking/BookingForm.tsx
    apps/accommodations/frontend/hooks/useBookingForm.ts
  </files>
  <action>
**PaymentMethodSelector.tsx** (new file):
- Props: `acceptedMethods: string[]`, `selectedMethod: AccomPaymentMethod | null`, `onSelect: (method: AccomPaymentMethod) => void`, `depositPercent: number`, `totalPrice: number`, `currency: string`
- Render a radio-card list of accepted payment methods using `PAYMENT_METHOD_CONFIG` from types/property.ts
- Filter to show only methods in `acceptedMethods`
- Each card shows: icon (Phosphor, e.g., Money, Bank, CreditCard, CurrencyBtc), label, description
- For "card" method, show deposit info: "Deposit: {depositPercent}% ({formatPrice(depositAmount, currency)})"
- For "cash" method, show: "Pay full amount at check-in"
- For "bank_transfer", show: "Transfer before arrival"
- For "crypto", show: "Pay with BTC, ETH, USDC & more"
- Selected card has ring-2 ring-primary styling
- Use Phosphor icons from `@phosphor-icons/react` (Money, Bank, CreditCard, CurrencyBtc)
- Import `formatPrice` from `@/lib/price-utils`

**BankTransferInstructions.tsx** (new file):

- Props: `bankInfo: BankTransferInfo`, `amount: number`, `currency: string`, `bookingCode: string`
- Display bank details in a card: bank name, account holder, account number, SWIFT code (if present), amount to transfer, reference (booking code)
- Include copy buttons for account number and amount
- Note: "Your booking is confirmed once the host verifies the transfer"
- Styled consistently with the booking confirmation card pattern

**CryptoPaymentOptions.tsx** (new file):

- Props: `wallets: Record<string, string>`, `amount: number`, `currency: string`, `bookingCode: string`
- Import `CRYPTO_CURRENCIES` from `@shared/payment` (the shared package: `import { CRYPTO_CURRENCIES } from '@shared/payment'`)
- For each wallet address, show: crypto name, icon (use @web3icons/react TokenIcon), address (truncated with copy), deep-link button
- Deep-link generation: `bitcoin:{address}?label=Booking+{code}` for BTC, `ethereum:{address}` for ETH/USDC/USDT, `solana:{address}` for SOL, `ton://transfer/{address}` for TON, `bnb:{address}` for BNB
- Note: "Your booking is confirmed once the host verifies the payment"
- Only show wallets the owner has configured (filter by keys in `wallets` object)

**Update BookingForm.tsx:**

- Add new props: `acceptedPaymentMethods: string[]`, `selectedPaymentMethod: AccomPaymentMethod | null`, `onSelectPaymentMethod: (m: AccomPaymentMethod) => void`, `depositPercent: number`, `totalPrice: number`, `currency: string`
- Render `<PaymentMethodSelector>` between the special requests field and the submit button
- Only show if `acceptedPaymentMethods.length > 0`
- If only one payment method is accepted, auto-select it and still show it (non-interactive but visible)
- Payment method must be selected for form to be valid (update submit button disabled state)
- Update submit button text: "Pay Deposit via Card" for card, "Book Now" for cash, "Request Booking" for bank_transfer/crypto

**Update useBookingForm.ts:**

- Add `selectedPaymentMethod` state (AccomPaymentMethod | null)
- Add `setSelectedPaymentMethod` function
- Add new props to UseBookingFormProps: `acceptedPaymentMethods: string[]`, `depositPercent: number`
- Update `isFormValid`: also require payment method selected (unless acceptedPaymentMethods is empty for backward compat)
- Pass `paymentMethod` in the `submitBooking()` call body
- After successful submission, if response has `stripeCheckoutUrl`, redirect via `window.location.href = stripeCheckoutUrl` (for card payments)
- Return: `selectedPaymentMethod`, `setSelectedPaymentMethod` in the hook return
  </action>
  <verify>
  Run `cd /Users/gianfrancodagostino/Desktop/gudbro-verticals/apps/accommodations/frontend && npx tsc --noEmit --pretty 2>&1 | head -40` to check TypeScript compilation.
  </verify>
  <done>PaymentMethodSelector renders filtered payment options. BankTransferInstructions shows bank details. CryptoPaymentOptions shows wallet addresses with deep-links. BookingForm integrates payment selector. useBookingForm tracks payment method selection and passes it to API. Card payments trigger Stripe redirect.</done>
  </task>

<task type="auto">
  <name>Task 2: Extend booking API and property API for payment flow</name>
  <files>
    apps/accommodations/frontend/app/api/booking/route.ts
    apps/accommodations/frontend/lib/booking-api.ts
    apps/accommodations/frontend/components/booking/BookingConfirmation.tsx
    apps/accommodations/frontend/app/api/property/[slug]/route.ts
  </files>
  <action>
**Update booking API route (`/api/booking/route.ts`):**

1. Accept `paymentMethod` from request body (optional, for backward compat)
2. After fetching property, also select: `deposit_percent, bank_transfer_info, crypto_wallets, accepted_payment_methods, stripe_account_id`
3. Validate payment method against property's accepted_payment_methods:
   - If paymentMethod provided but not in accepted list, return error `payment_method_not_accepted` (400)
   - If no paymentMethod provided and property has accepted methods, default to first in list (backward compat for old clients)
4. Determine booking status based on payment method:
   - `cash`: status follows existing logic (instant -> 'confirmed', inquiry -> 'pending')
   - `bank_transfer` or `crypto`: status = 'pending_payment' regardless of booking mode
   - `card`: status = 'pending_payment' (will be confirmed after Stripe checkout)
5. Calculate deposit: `depositAmount = Math.round(totalPrice * (depositPercent / 100))`
   - Default depositPercent to 100 if not set on property
6. Insert booking with additional columns: `payment_method`, `deposit_amount`, `deposit_percent`
7. Build response:
   - For `bank_transfer`: include `bankTransferInfo` from property in response
   - For `crypto`: include `cryptoWallets` from property in response
   - For `card`: DO NOT create Stripe session here (that's Plan 03's job). Instead include `stripeCheckoutUrl: null` and `paymentMethod: 'card'`; the frontend will call `/api/checkout` separately
   - Include `depositAmount` and `depositPercent` in response
   - Return correct status in response: 'confirmed' | 'pending' | 'pending_payment'

**Update property API route (`/api/property/[slug]/route.ts`):**

- Add `deposit_percent`, `bank_transfer_info`, `crypto_wallets`, `cancellation_window_hours`, `cancellation_penalty_percent` to the SELECT query
- Return these fields in the PropertyPageData response

**Update booking-api.ts:**

- `submitBooking` already passes the full BookingSubmission body, which now includes `paymentMethod`. No changes needed unless the types don't flow through. Verify the generic is correct.

**Update BookingConfirmation.tsx:**

- Extend props to accept full BookingResponse (already does via bookingResult)
- After the price summary section, add conditional payment instruction blocks:
  - If `bookingResult.paymentMethod === 'bank_transfer'` and `bookingResult.bankTransferInfo`: render `<BankTransferInstructions>` with bank info, total price, and booking code
  - If `bookingResult.paymentMethod === 'crypto'` and `bookingResult.cryptoWallets`: render `<CryptoPaymentOptions>` with wallets, total price, and booking code
  - If `bookingResult.paymentMethod === 'cash'`: show a green info box "Pay {formatPrice(total, currency)} at check-in"
  - If `bookingResult.status === 'pending_payment'`: update header to "Awaiting Payment" instead of "Booking Confirmed!"
- For `pending_payment` status, show amber clock icon instead of green checkmark
  </action>
  <verify>

1. `cd /Users/gianfrancodagostino/Desktop/gudbro-verticals/apps/accommodations/frontend && npx tsc --noEmit --pretty 2>&1 | head -40`
2. Visually inspect BookingConfirmation.tsx for correct conditional rendering of payment instructions
   </verify>
   <done>Booking API saves payment_method and routes to correct status. Property API returns payment config fields. BookingConfirmation shows method-specific payment instructions. Bank transfer shows bank details. Crypto shows wallet addresses with deep-links. Cash shows "pay at check-in" message.</done>
   </task>

</tasks>

<verification>
1. TypeScript compilation passes for accommodations frontend
2. PaymentMethodSelector filters by accepted_payment_methods
3. Booking API validates payment method against property's accepted list
4. Cash bookings follow existing instant/inquiry logic
5. Bank transfer and crypto bookings get status 'pending_payment'
6. BookingConfirmation shows appropriate instructions per payment method
7. Property API returns deposit_percent and payment config
</verification>

<success_criteria>

- Guest sees only enabled payment methods on the booking form
- Payment method selection is required before booking
- Booking API correctly sets status based on payment method
- Post-booking confirmation shows method-specific instructions
- Bank transfer shows bank details; crypto shows wallet addresses with deep-links
  </success_criteria>

<output>
After completion, create `.planning/phases/20-payments/20-02-SUMMARY.md`
</output>
