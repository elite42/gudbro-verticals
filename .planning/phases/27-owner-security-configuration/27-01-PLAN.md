---
phase: 27-owner-security-configuration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - shared/database/migrations/schema/090-access-settings.sql
  - apps/backoffice/app/api/accommodations/property/route.ts
  - apps/backoffice/app/(dashboard)/accommodations/security/page.tsx
  - apps/accommodations/frontend/types/stay.ts
autonomous: true

must_haves:
  truths:
    - 'Owner can select from three security presets (Family / Standard / Structured) in the backoffice security settings page'
    - 'Each preset visibly defines which guest actions require verification and which are free ‚Äî owner sees this BEFORE saving'
    - 'Owner can toggle individual action gates beyond the selected preset (custom override)'
    - 'Family preset allows all actions without verification; Structured preset requires verification for every order'
    - 'Saving persists access_settings JSONB to accom_properties and reload shows saved state'
  artifacts:
    - path: 'shared/database/migrations/schema/090-access-settings.sql'
      provides: 'access_settings JSONB column on accom_properties with default preset'
      contains: 'access_settings'
    - path: 'apps/backoffice/app/(dashboard)/accommodations/security/page.tsx'
      provides: 'Security settings page with preset selector and action toggles'
      min_lines: 100
    - path: 'apps/backoffice/app/api/accommodations/property/route.ts'
      provides: 'Updated PUT endpoint accepting access_settings and guest_verification_method'
      contains: 'access_settings'
    - path: 'apps/accommodations/frontend/types/stay.ts'
      provides: 'AccessSettings type definition used by both backoffice and frontend'
      contains: 'AccessSettings'
  key_links:
    - from: 'apps/backoffice/app/(dashboard)/accommodations/security/page.tsx'
      to: '/api/accommodations/property'
      via: 'fetch GET and PUT with access_settings payload'
      pattern: 'access_settings'
    - from: 'shared/database/migrations/schema/090-access-settings.sql'
      to: 'accom_properties'
      via: 'ALTER TABLE ADD COLUMN access_settings JSONB'
      pattern: 'access_settings.*JSONB'
---

<objective>
Add access_settings JSONB schema to accom_properties and build the backoffice security configuration page where property owners select a preset (Family/Standard/Structured) and optionally customize individual action gates.

Purpose: Owners need control over what level of guest verification their property requires. A family-run hostel wants zero friction; a structured hotel wants verification on every order. This plan delivers the database schema, API integration, and backoffice UI for this configuration.

Output: Migration 090, updated property API, and a new backoffice security settings page.
</objective>

<execution_context>
@/Users/gianfrancodagostino/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gianfrancodagostino/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase 26 summaries (provides types and patterns this builds on)

@.planning/phases/26-progressive-authentication/26-01-SUMMARY.md
@.planning/phases/26-progressive-authentication/26-02-SUMMARY.md

# Key existing files

@apps/accommodations/frontend/lib/auth.ts
@apps/accommodations/frontend/types/stay.ts
@apps/backoffice/app/(dashboard)/accommodations/settings/page.tsx
@apps/backoffice/app/api/accommodations/property/route.ts
@shared/database/migrations/schema/089-progressive-auth.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migration 090 ‚Äî access_settings JSONB column + update resolve_room_access</name>
  <files>
    shared/database/migrations/schema/090-access-settings.sql
    apps/accommodations/frontend/types/stay.ts
  </files>
  <action>
    Create migration 090 that:

    1. Adds `access_settings` JSONB column to `accom_properties` with this default value:
       ```json
       {
         "preset": "standard",
         "actions": {
           "order_service": true,
           "order_fnb": true,
           "request_checkout": false,
           "view_orders": false,
           "contact_host": false
         }
       }
       ```
       Where `true` = requires verification (gated), `false` = free for browse tier.
       The `preset` field is one of: `family`, `standard`, `structured`.

    2. Add a CHECK constraint ensuring `access_settings->>'preset'` is one of the three valid values:
       ```sql
       CHECK (access_settings->>'preset' IN ('family', 'standard', 'structured'))
       ```

    3. Update `resolve_room_access()` to include `access_settings` in its RETURNS TABLE. Add `access_settings JSONB` to the return columns. Fetch it alongside `guest_verification_method` from `accom_properties` and return it in both the active-booking and no-booking result rows.

    4. Add a COMMENT explaining the column purpose.

    Preset definitions (for reference ‚Äî encoded in frontend, not in DB):
    - **Family**: All actions `false` (no verification needed for anything)
    - **Standard**: `order_service: true, order_fnb: true`, rest `false` (verify only for orders)
    - **Structured**: All actions `true` (verify for everything)

    Then update `apps/accommodations/frontend/types/stay.ts`:
    - Add `AccessSettings` interface:
      ```typescript
      export interface AccessSettings {
        preset: 'family' | 'standard' | 'structured';
        actions: {
          order_service: boolean;
          order_fnb: boolean;
          request_checkout: boolean;
          view_orders: boolean;
          contact_host: boolean;
        };
      }
      ```
    - Add `accessSettings?: AccessSettings` to `RoomStayData` interface (optional for backward compat with existing tokens/sessions).
    - Add `ACCESS_PRESETS` constant object mapping preset names to their default action configurations:
      ```typescript
      export const ACCESS_PRESETS: Record<string, AccessSettings> = {
        family: { preset: 'family', actions: { order_service: false, order_fnb: false, request_checkout: false, view_orders: false, contact_host: false } },
        standard: { preset: 'standard', actions: { order_service: true, order_fnb: true, request_checkout: false, view_orders: false, contact_host: false } },
        structured: { preset: 'structured', actions: { order_service: true, order_fnb: true, request_checkout: true, view_orders: true, contact_host: true } },
      };
      ```

  </action>
  <verify>
    - File exists: `shared/database/migrations/schema/090-access-settings.sql`
    - File contains: ALTER TABLE, access_settings, JSONB, resolve_room_access, CHECK constraint
    - Types file contains: AccessSettings interface, ACCESS_PRESETS constant, accessSettings field on RoomStayData
    - Run: `npx tsc --noEmit -p apps/accommodations/frontend/tsconfig.json` ‚Äî no new type errors related to AccessSettings
  </verify>
  <done>
    Migration 090 adds access_settings JSONB column with standard preset default, updates resolve_room_access() to return it, and types are defined in stay.ts with ACCESS_PRESETS constant.
  </done>
</task>

<task type="auto">
  <name>Task 2: Backoffice security settings page + API update</name>
  <files>
    apps/backoffice/app/(dashboard)/accommodations/security/page.tsx
    apps/backoffice/app/api/accommodations/property/route.ts
  </files>
  <action>
    **Step A: Update property API to accept access_settings**

    In `apps/backoffice/app/api/accommodations/property/route.ts`:
    1. Add `'access_settings'` and `'guest_verification_method'` to the `allowedFields` array in the PUT handler.
    2. Add `access_settings, guest_verification_method` to the SELECT columns in the GET handler.

    **Step B: Create security settings page**

    Create `apps/backoffice/app/(dashboard)/accommodations/security/page.tsx` ‚Äî a new 'use client' page following the exact pattern of `accommodations/settings/page.tsx`:
    - Uses `PROPERTY_ID` and `ADMIN_API_KEY` env vars (same pattern)
    - Uses `authHeaders()` helper (same pattern)

    Page layout (max-w-3xl, same styling as other settings pages):

    1. **Header**: "Guest Verification" title with subtitle "Configure how guests verify their identity for services"

    2. **Verification Method Card** (rounded-xl border bg-white p-6):
       - Radio buttons for `guest_verification_method`: "Last Name" and "PIN"
       - Description text explaining each method
       - This maps to the existing `guest_verification_method` column on `accom_properties`

    3. **Security Preset Selector** (three cards in a row, similar to booking mode selector):
       - **Family** card: icon üè°, "No verification needed", subtitle "Best for small family-run properties. Guests can order freely."
       - **Standard** card: icon üè®, "Verify for orders", subtitle "Guests verify identity before placing service or F&B orders." (DEFAULT ‚Äî highlighted with blue border when selected)
       - **Structured** card: icon üè¢, "Verify for everything", subtitle "Maximum security. Guests verify before any action."
       - Selection updates both `preset` and `actions` to match the preset definition.

    4. **Action Gates** (expandable section below presets):
       - Show a list of all 5 actions with toggle switches:
         - "Order Room Service" (order_service)
         - "Order Food & Beverage" (order_fnb)
         - "Request Checkout" (request_checkout)
         - "View Order History" (view_orders)
         - "Contact Host via WhatsApp" (contact_host)
       - Each toggle is labeled with "Requires verification" on/off state
       - When user changes a toggle that differs from the current preset, show a subtle note: "Custom configuration ‚Äî differs from {preset} preset"
       - When toggles match a known preset exactly, auto-select that preset card above

    5. **Save Button** (same pattern: FloppyDisk icon, saving/saved states):
       - Sends PUT to `/api/accommodations/property` with:
         ```json
         {
           "id": PROPERTY_ID,
           "guest_verification_method": selectedMethod,
           "access_settings": { "preset": selectedPreset, "actions": { ... } }
         }
         ```

    On mount, fetch property via GET and populate:
    - `guest_verification_method` (default: 'last_name')
    - `access_settings` (default: standard preset if null/undefined)

    Use Phosphor icons for the page: `ShieldCheck` for header, `LockSimple` / `LockSimpleOpen` for toggle states.

    Import `ACCESS_PRESETS` from a local constant (duplicate the preset definitions rather than importing from accommodations frontend to avoid cross-app dependency). Define the presets inline in the component file.

    Styling: Follow existing backoffice conventions ‚Äî blue-600 primary, gray-200 borders, rounded-xl cards, Tailwind classes matching other settings pages.

  </action>
  <verify>
    - File exists: `apps/backoffice/app/(dashboard)/accommodations/security/page.tsx`
    - Property API route.ts contains 'access_settings' in allowedFields array
    - Property API GET contains 'access_settings' and 'guest_verification_method' in select
    - Security page imports from '@phosphor-icons/react'
    - Security page uses PROPERTY_ID and ADMIN_API_KEY pattern
    - Run: `npx tsc --noEmit -p apps/backoffice/tsconfig.json` ‚Äî no new type errors
  </verify>
  <done>
    Backoffice security settings page loads property access_settings, shows preset selector with three cards, displays action-level toggles that auto-detect preset match, allows custom overrides, and saves via the property API. Verification method (last_name/pin) is also configurable.
  </done>
</task>

</tasks>

<verification>
1. Migration 090 SQL is syntactically valid (no syntax errors in CREATE OR REPLACE FUNCTION)
2. TypeScript compiles: `npx tsc --noEmit -p apps/accommodations/frontend/tsconfig.json`
3. TypeScript compiles: `npx tsc --noEmit -p apps/backoffice/tsconfig.json`
4. Backoffice security page renders at `/accommodations/security` without errors
5. Property API PUT accepts `access_settings` and `guest_verification_method` fields
6. ACCESS_PRESETS constant defines all three presets with correct action defaults
</verification>

<success_criteria>

- Owner can navigate to `/accommodations/security` in backoffice
- Page shows verification method selector (last_name/pin)
- Three preset cards (Family/Standard/Structured) are visible and selectable
- Selecting a preset updates the action toggles below
- Toggling an action that differs from preset shows "custom" indicator
- Save button persists settings to database via property API
- access_settings JSONB has valid schema with preset + actions shape
- resolve_room_access() returns access_settings in its result
  </success_criteria>

<output>
After completion, create `.planning/phases/27-owner-security-configuration/27-01-SUMMARY.md`
</output>
