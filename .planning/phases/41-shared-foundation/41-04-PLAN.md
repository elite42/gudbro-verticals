---
phase: 41-shared-foundation
plan: 04
type: execute
wave: 2
depends_on: ['41-01']
files_modified:
  - apps/coffeeshop/frontend/lib/currency.ts
  - apps/coffeeshop/frontend/package.json
  - apps/gym/frontend/lib/currency.ts
  - apps/gym/frontend/package.json
  - apps/laundry/frontend/lib/currency.ts
  - apps/laundry/frontend/package.json
autonomous: true

must_haves:
  truths:
    - 'coffeeshop, gym, and laundry all import usePriceFormat from @gudbro/hooks instead of local copies'
    - 'coffeeshop, gym, and laundry all import currency utilities from @gudbro/utils via a local currency.ts setup file'
    - 'All local duplicate files (usePriceFormat, currency-converter, currency-preferences) are deleted from these 3 apps'
    - 'All 3 apps build successfully with shared imports'
  artifacts:
    - path: 'apps/coffeeshop/frontend/lib/currency.ts'
      provides: 'App-specific currency store and converter instances'
      contains: 'createCurrencyPreferencesStore'
    - path: 'apps/gym/frontend/lib/currency.ts'
      provides: 'App-specific currency store and converter instances'
      contains: 'createCurrencyPreferencesStore'
    - path: 'apps/laundry/frontend/lib/currency.ts'
      provides: 'App-specific currency store and converter instances'
      contains: 'createCurrencyPreferencesStore'
  key_links:
    - from: 'apps/coffeeshop/frontend'
      to: '@gudbro/hooks'
      via: "import { usePriceFormat } from '@gudbro/hooks'"
      pattern: 'from.*@gudbro/hooks'
    - from: 'apps/gym/frontend'
      to: '@gudbro/hooks'
      via: "import { usePriceFormat } from '@gudbro/hooks'"
      pattern: 'from.*@gudbro/hooks'
    - from: 'apps/laundry/frontend'
      to: '@gudbro/hooks'
      via: "import { usePriceFormat } from '@gudbro/hooks'"
      pattern: 'from.*@gudbro/hooks'
---

<objective>
Migrate coffeeshop, gym, and laundry to use shared @gudbro/hooks and @gudbro/utils, then delete their local duplicates.

Purpose: These 3 apps have nearly identical currency hook/util implementations (coffeeshop is the canonical version that was used as the base for the shared modules). Migration is straightforward -- update imports, create thin currency.ts setup files, delete duplicates.

Output: 3 apps migrated to shared packages, 9 local duplicate files deleted (3 usePriceFormat + 3 currency-converter + 3 currency-preferences)
</objective>

<execution_context>
@/Users/gianfrancodagostino/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gianfrancodagostino/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/41-shared-foundation/41-RESEARCH.md
@.planning/phases/41-shared-foundation/41-01-SUMMARY.md

# Current local implementations (to understand import patterns):

@apps/coffeeshop/frontend/hooks/usePriceFormat.ts
@apps/coffeeshop/frontend/lib/currency-converter.ts
@apps/coffeeshop/frontend/lib/currency-preferences.ts
@apps/gym/frontend/hooks/usePriceFormat.ts
@apps/gym/frontend/lib/currency-converter.ts
@apps/gym/frontend/lib/currency-preferences.ts
@apps/laundry/frontend/hooks/usePriceFormat.ts
@apps/laundry/frontend/lib/currency-converter.ts
@apps/laundry/frontend/lib/currency-preferences.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create currency setup files and update package.json for coffeeshop, gym, laundry</name>
  <files>
    apps/coffeeshop/frontend/lib/currency.ts
    apps/coffeeshop/frontend/package.json
    apps/gym/frontend/lib/currency.ts
    apps/gym/frontend/package.json
    apps/laundry/frontend/lib/currency.ts
    apps/laundry/frontend/package.json
  </files>
  <action>
    For each of the 3 apps (coffeeshop, gym, laundry):

    **Step 1: Update package.json dependencies**
    Add workspace dependencies (if not already present):
    ```json
    "@gudbro/hooks": "workspace:*",
    "@gudbro/utils": "workspace:*",
    "@gudbro/ui": "workspace:*",
    "@gudbro/types": "workspace:*",
    "@gudbro/config": "workspace:*"
    ```

    **Step 2: Create lib/currency.ts setup file**
    Each app needs a thin setup file that creates its app-specific currency store and converter instances:
    ```typescript
    import { createCurrencyPreferencesStore, createCurrencyConverter } from '@gudbro/utils';

    export const currencyPreferencesStore = createCurrencyPreferencesStore({
      storageKeyPrefix: 'gudbro-{appname}', // app-specific prefix matching existing key
      baseCurrency: 'VND', // or read from app config
    });

    export const currencyConverter = createCurrencyConverter({
      baseCurrency: 'VND',
      fallbackRates: { /* copy existing app's rates */ },
      // coffeeshop: include fetchRates for Supabase integration
      // gym/laundry: no fetchRates needed
    });

    export const { formatConvertedPrice } = currencyConverter;
    ```
    Read each app's existing currency-preferences.ts and currency-converter.ts to match the EXACT storage key prefix and fallback rates they currently use. Do NOT change behavior.

    **Step 3: Run pnpm install** to link new workspace dependencies.

  </action>
  <verify>
    Verify package.json has @gudbro/hooks dependency: `grep "@gudbro/hooks" apps/coffeeshop/frontend/package.json apps/gym/frontend/package.json apps/laundry/frontend/package.json`
    Verify currency.ts files exist: `ls apps/coffeeshop/frontend/lib/currency.ts apps/gym/frontend/lib/currency.ts apps/laundry/frontend/lib/currency.ts`
  </verify>
  <done>
    All 3 apps have @gudbro/* workspace dependencies in package.json. Each has a lib/currency.ts file that creates app-specific currency store and converter instances using the shared factory functions.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update imports and delete local duplicates for coffeeshop, gym, laundry</name>
  <files>
    apps/coffeeshop/frontend/hooks/usePriceFormat.ts (DELETE)
    apps/coffeeshop/frontend/lib/currency-converter.ts (DELETE)
    apps/coffeeshop/frontend/lib/currency-preferences.ts (DELETE)
    apps/gym/frontend/hooks/usePriceFormat.ts (DELETE)
    apps/gym/frontend/lib/currency-converter.ts (DELETE)
    apps/gym/frontend/lib/currency-preferences.ts (DELETE)
    apps/laundry/frontend/hooks/usePriceFormat.ts (DELETE)
    apps/laundry/frontend/lib/currency-converter.ts (DELETE)
    apps/laundry/frontend/lib/currency-preferences.ts (DELETE)
  </files>
  <action>
    For each of the 3 apps (coffeeshop, gym, laundry):

    **Step 1: Find all files that import from local hooks/utils**
    Use grep to find every file importing from:
    - `@/hooks/usePriceFormat` or `../hooks/usePriceFormat` or similar
    - `@/lib/currency-converter` or `../lib/currency-converter`
    - `@/lib/currency-preferences` or `../lib/currency-preferences`

    **Step 2: Update import statements**
    - `from '@/hooks/usePriceFormat'` -> `from '@gudbro/hooks'`
    - `from '@/lib/currency-converter'` -> `from '@/lib/currency'` (the new setup file)
    - `from '@/lib/currency-preferences'` -> `from '@/lib/currency'` (the new setup file)

    For usePriceFormat consumers: The hook API is unchanged (formatPrice, formatPriceCompact, currencyPrefs, baseCurrency). But the hook now takes an options parameter. Each consumer needs to pass { store, formatConvertedPrice, getBaseCurrency } from the lib/currency.ts setup file. Read existing usePriceFormat.ts to understand how each app currently wires these dependencies and replicate the same wiring via the options parameter.

    **Step 3: Delete local duplicates**
    After ALL imports are updated:
    - `rm apps/coffeeshop/frontend/hooks/usePriceFormat.ts`
    - `rm apps/coffeeshop/frontend/lib/currency-converter.ts`
    - `rm apps/coffeeshop/frontend/lib/currency-preferences.ts`
    - `rm apps/gym/frontend/hooks/usePriceFormat.ts`
    - `rm apps/gym/frontend/lib/currency-converter.ts`
    - `rm apps/gym/frontend/lib/currency-preferences.ts`
    - `rm apps/laundry/frontend/hooks/usePriceFormat.ts`
    - `rm apps/laundry/frontend/lib/currency-converter.ts`
    - `rm apps/laundry/frontend/lib/currency-preferences.ts`

    **Step 4: Verify builds**
    Run `pnpm --filter coffeeshop build && pnpm --filter gym build && pnpm --filter laundry build`

    CRITICAL: Do NOT delete local files until imports are updated. The order matters: update imports FIRST, then delete files.

  </action>
  <verify>
    Run `pnpm --filter coffeeshop build && pnpm --filter gym build && pnpm --filter laundry build` -- all must succeed.
    Run `grep -r "from.*@/hooks/usePriceFormat" apps/coffeeshop/ apps/gym/ apps/laundry/` -- must return ZERO results.
    Run `grep -r "from.*@/lib/currency-converter" apps/coffeeshop/ apps/gym/ apps/laundry/` -- must return ZERO results.
    Run `grep -r "from.*@/lib/currency-preferences" apps/coffeeshop/ apps/gym/ apps/laundry/` -- must return ZERO results.
    Run `ls apps/coffeeshop/frontend/hooks/usePriceFormat.ts apps/gym/frontend/hooks/usePriceFormat.ts apps/laundry/frontend/hooks/usePriceFormat.ts 2>/dev/null` -- must return no files.
  </verify>
  <done>
    coffeeshop, gym, and laundry import usePriceFormat from @gudbro/hooks and currency utilities from @gudbro/utils (via lib/currency.ts). All 9 local duplicate files are deleted. All 3 apps build successfully.
  </done>
</task>

</tasks>

<verification>
1. `pnpm --filter coffeeshop build` passes
2. `pnpm --filter gym build` passes
3. `pnpm --filter laundry build` passes
4. Zero local usePriceFormat copies in coffeeshop/gym/laundry
5. Zero local currency-converter copies in coffeeshop/gym/laundry
6. Zero local currency-preferences copies in coffeeshop/gym/laundry
7. Each app has a lib/currency.ts setup file using @gudbro/utils factories
</verification>

<success_criteria>

- coffeeshop, gym, laundry all use @gudbro/hooks for usePriceFormat
- coffeeshop, gym, laundry all use @gudbro/utils for currency via lib/currency.ts
- 9 local duplicate files deleted (3 per app)
- All 3 apps build successfully with `pnpm build`
- No behavioral change -- same storage keys, same fallback rates, same formatting
  </success_criteria>

<output>
After completion, create `.planning/phases/41-shared-foundation/41-04-SUMMARY.md`
</output>
