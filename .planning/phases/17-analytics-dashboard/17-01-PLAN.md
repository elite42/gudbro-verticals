---
phase: 17-analytics-dashboard
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/backoffice/app/api/feedback/analytics/volume/route.ts
  - apps/backoffice/app/api/feedback/analytics/summary/route.ts
autonomous: true

must_haves:
  truths:
    - 'Volume API returns daily submission counts for a configurable time range'
    - 'Summary API returns type breakdown, vertical breakdown, top features, and response time metrics'
    - 'Both APIs require authentication and return 401 for unauthenticated requests'
    - 'Days with zero submissions are filled in the volume series (no gaps)'
  artifacts:
    - path: 'apps/backoffice/app/api/feedback/analytics/volume/route.ts'
      provides: 'GET endpoint returning time-series submission volume'
      exports: ['GET']
    - path: 'apps/backoffice/app/api/feedback/analytics/summary/route.ts'
      provides: 'GET endpoint returning breakdown, top features, response times'
      exports: ['GET']
  key_links:
    - from: 'volume/route.ts'
      to: 'fb_submissions'
      via: 'supabaseAdmin query filtered by created_at'
      pattern: 'supabaseAdmin.*fb_submissions'
    - from: 'summary/route.ts'
      to: 'fb_submissions'
      via: 'supabaseAdmin query for type/vertical breakdown'
      pattern: 'supabaseAdmin.*fb_submissions'
    - from: 'summary/route.ts'
      to: 'fb_tasks'
      via: 'supabaseAdmin query for top features and resolution time'
      pattern: 'supabaseAdmin.*fb_tasks'
---

<objective>
Create the two analytics API routes that aggregate feedback data from fb_submissions and fb_tasks.

Purpose: Provide pre-aggregated data endpoints so the dashboard (Plan 02) can render charts without client-side data processing of raw rows.
Output: Two API routes — volume (time-series) and summary (breakdowns + metrics).
</objective>

<execution_context>
@/Users/gianfrancodagostino/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gianfrancodagostino/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-analytics-dashboard/17-RESEARCH.md

# Existing patterns to follow

@apps/backoffice/app/api/feedback/tasks/route.ts
@apps/backoffice/lib/supabase-admin.ts
@apps/backoffice/lib/supabase-server.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Volume API route</name>
  <files>apps/backoffice/app/api/feedback/analytics/volume/route.ts</files>
  <action>
Create GET endpoint at /api/feedback/analytics/volume that returns daily submission counts.

1. Auth check using createClient() + getUser() pattern from existing feedback/tasks/route.ts
2. Parse `days` query param (default 30). Accept 7, 30, 90, or 0 (all time).
3. Query fb_submissions via supabaseAdmin: select created_at, filter by gte(created_at, startDate) if days > 0, order by created_at ascending.
4. Aggregate in JS: group by date (format yyyy-MM-dd using date-fns format).
5. CRITICAL: Fill date gaps using date-fns eachDayOfInterval — generate full date range from startDate to today, merge with query results, set count=0 for missing days. This prevents line chart gaps (see Pitfall 5 in RESEARCH.md).
6. Return JSON: { volume: Array<{ date: string, count: number }> }
7. Add `export const dynamic = 'force-dynamic'` at top.

Use date-fns (already installed): subDays, format, eachDayOfInterval.
Use supabaseAdmin (not createClient) for the data query to bypass RLS.
</action>
<verify>Build check: `cd apps/backoffice && npx tsc --noEmit --pretty 2>&1 | tail -20` shows no errors in volume/route.ts</verify>
<done>GET /api/feedback/analytics/volume?days=30 returns { volume: [...] } with one entry per day, no gaps, authenticated</done>
</task>

<task type="auto">
  <name>Task 2: Summary API route</name>
  <files>apps/backoffice/app/api/feedback/analytics/summary/route.ts</files>
  <action>
Create GET endpoint at /api/feedback/analytics/summary that returns four metric groups in a single response.

1. Auth check (same pattern as Task 1).
2. Parse `days` query param (default 30).
3. Calculate startDate using subDays. If days=0, no date filter.
4. Run three parallel queries via Promise.all:
   a. fb_submissions: select created_at, type, vertical, processed_at, status — filtered by date range
   b. fb_tasks: select id, title, type, submission_count, priority, status, created_at, resolved_at — where type='feature_request', order by submission_count desc, limit 10
   c. fb_tasks: select created_at, resolved_at — where resolved_at is not null, filtered by date range

5. Aggregate submissions data in JS:
   - byType: group by type (COALESCE null to 'unclassified'), produce Array<{ type: string, count: number }> sorted by count desc
   - byVertical: group by vertical (COALESCE null to 'unknown'), produce Array<{ vertical: string, count: number }> sorted by count desc
   - Processing time: for submissions where processed_at exists, calculate avg hours (processed_at - created_at) in hours, round to 1 decimal
   - Total count for the period

6. From fb_tasks resolved query: calculate avg resolution hours (resolved_at - created_at), round to 1 decimal.

7. Return JSON:
   {
   totalSubmissions: number,
   byType: Array<{ type: string, count: number }>,
   byVertical: Array<{ vertical: string, count: number }>,
   topFeatures: Array<{ id, title, type, submission_count, priority, status }>,
   avgProcessingHours: number | null,
   avgResolutionHours: number | null
   }

8. Add `export const dynamic = 'force-dynamic'`.
   </action>
   <verify>Build check: `cd apps/backoffice && npx tsc --noEmit --pretty 2>&1 | tail -20` shows no errors in summary/route.ts</verify>
   <done>GET /api/feedback/analytics/summary?days=30 returns all four metric groups (byType, byVertical, topFeatures, response times) in a single response</done>
   </task>

</tasks>

<verification>
- `cd apps/backoffice && npx tsc --noEmit` passes with no errors
- Both route files export GET with dynamic = 'force-dynamic'
- Auth check present in both routes (returns 401 without auth)
- Volume route fills date gaps (no missing days in series)
- Summary route uses Promise.all for parallel queries (not sequential)
</verification>

<success_criteria>
Two analytics API routes exist and typecheck. Volume returns gap-filled daily series. Summary returns type breakdown, vertical breakdown, top 10 features, and avg response times — all from a single endpoint.
</success_criteria>

<output>
After completion, create `.planning/phases/17-analytics-dashboard/17-01-SUMMARY.md`
</output>
