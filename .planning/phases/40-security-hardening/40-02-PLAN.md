---
phase: 40-security-hardening
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/backoffice/lib/accommodations/helpers.ts
  - apps/coffeeshop/frontend/lib/supabase-admin.ts
  - apps/coffeeshop/frontend/app/api/orders/route.ts
  - apps/coffeeshop/frontend/app/api/charges/route.ts
  - apps/coffeeshop/frontend/app/api/feedback/route.ts
  - apps/coffeeshop/frontend/app/api/loyalty/points/route.ts
  - apps/coffeeshop/frontend/app/api/send-push/route.ts
  - apps/coffeeshop/frontend/app/api/push-subscription/route.ts
  - apps/coffeeshop/frontend/app/api/staff/reviews/route.ts
  - apps/backoffice/lib/contribution-admin-service.ts
  - apps/backoffice/lib/staff-service.ts
  - apps/backoffice/lib/qr/qr-service.ts
autonomous: true

must_haves:
  truths:
    - 'ADMIN_API_KEY comparison uses crypto.timingSafeEqual — no timing side-channel'
    - 'Coffeeshop API routes throw an error when SUPABASE_SERVICE_ROLE_KEY is missing instead of silently falling back to ANON key'
    - 'Backoffice service files throw an error when SUPABASE_SERVICE_ROLE_KEY is missing instead of silently falling back to ANON key'
    - 'Orders table RLS policy restricts SELECT to session_id IS NOT NULL OR authenticated merchant staff'
  artifacts:
    - path: 'apps/coffeeshop/frontend/lib/supabase-admin.ts'
      provides: 'Singleton Supabase admin client that throws on missing SERVICE_ROLE_KEY'
      contains: 'throw new Error'
      exports: ['getSupabaseAdmin']
    - path: 'apps/backoffice/lib/accommodations/helpers.ts'
      provides: 'Timing-safe ADMIN_API_KEY validation'
      contains: 'timingSafeEqual'
  key_links:
    - from: 'apps/coffeeshop/frontend/app/api/orders/route.ts'
      to: 'apps/coffeeshop/frontend/lib/supabase-admin.ts'
      via: 'getSupabaseAdmin import replacing inline createClient'
      pattern: 'getSupabaseAdmin'
    - from: 'apps/backoffice/lib/accommodations/helpers.ts'
      to: 'crypto'
      via: 'crypto.timingSafeEqual for key comparison'
      pattern: 'timingSafeEqual'
---

<objective>
Fix three security vulnerabilities: (1) Replace string comparison for ADMIN_API_KEY with crypto.timingSafeEqual, (2) Create a proper Supabase admin client for coffeeshop that throws on missing SERVICE_ROLE_KEY instead of falling back to ANON key, and (3) apply an RLS migration to restrict orders table access.

Purpose: Close timing side-channel on admin key (SEC-03), eliminate silent security degradation from ANON key fallback (SEC-04), and restrict orders data access to proper ownership (SEC-02).

Output: Timing-safe key comparison, coffeeshop supabase-admin module, 12 files migrated away from ANON fallback, orders RLS migration.
</objective>

<execution_context>
@/Users/gianfrancodagostino/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gianfrancodagostino/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/40-security-hardening/40-RESEARCH.md

# Existing patterns to follow:

@apps/backoffice/lib/accommodations/helpers.ts
@apps/backoffice/lib/supabase-admin.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Timing-safe admin key + supabase-admin client + ANON fallback removal</name>
  <files>
    apps/backoffice/lib/accommodations/helpers.ts
    apps/coffeeshop/frontend/lib/supabase-admin.ts
    apps/coffeeshop/frontend/app/api/orders/route.ts
    apps/coffeeshop/frontend/app/api/charges/route.ts
    apps/coffeeshop/frontend/app/api/feedback/route.ts
    apps/coffeeshop/frontend/app/api/loyalty/points/route.ts
    apps/coffeeshop/frontend/app/api/send-push/route.ts
    apps/coffeeshop/frontend/app/api/push-subscription/route.ts
    apps/coffeeshop/frontend/app/api/staff/reviews/route.ts
    apps/backoffice/lib/contribution-admin-service.ts
    apps/backoffice/lib/staff-service.ts
    apps/backoffice/lib/qr/qr-service.ts
  </files>
  <action>
**Part A: Timing-safe ADMIN_API_KEY (SEC-03)**

1. Read `apps/backoffice/lib/accommodations/helpers.ts`
2. Update `validateAdminApiKey` function:
   - Add `import crypto from 'crypto';` at the top of the file
   - Replace the `!apiKey || !token || token !== apiKey` check with:
     ```typescript
     if (!apiKey || !token) {
       return {
         valid: false,
         response: NextResponse.json(
           { error: 'Unauthorized' },
           { status: 401 }
         ),
       };
     }
     try {
       const isValid = crypto.timingSafeEqual(
         Buffer.from(token),
         Buffer.from(apiKey)
       );
       if (!isValid) {
         return {
           valid: false,
           response: NextResponse.json(
             { error: 'Unauthorized' },
             { status: 401 }
           ),
         };
       }
     } catch {
       // Different length buffers throw — treat as invalid
       return {
         valid: false,
         response: NextResponse.json(
           { error: 'Unauthorized' },
           { status: 401 }
         ),
       };
     }
     return { valid: true };
     ```
   - Do NOT modify any other functions in the file

**Part B: Coffeeshop supabase-admin client (SEC-04)**

3. Read `apps/backoffice/lib/supabase-admin.ts` to see the existing pattern
4. Create `apps/coffeeshop/frontend/lib/supabase-admin.ts`:
   - Import createClient and SupabaseClient from @supabase/supabase-js
   - Singleton pattern with `let _client: SupabaseClient | null = null`
   - `getSupabaseAdmin()` that:
     - Returns cached \_client if exists
     - Reads NEXT_PUBLIC_SUPABASE_URL and SUPABASE_SERVICE_ROLE_KEY from process.env
     - THROWS `new Error('Missing SUPABASE_SERVICE_ROLE_KEY — refusing to fall back to ANON key')` if either is missing
     - Creates client with `{ auth: { autoRefreshToken: false, persistSession: false } }`
     - Caches and returns

**Part C: Remove ANON fallback from coffeeshop routes (SEC-04)**

5. For EACH of these 7 coffeeshop API route files:
   - `apps/coffeeshop/frontend/app/api/orders/route.ts`
   - `apps/coffeeshop/frontend/app/api/charges/route.ts`
   - `apps/coffeeshop/frontend/app/api/feedback/route.ts`
   - `apps/coffeeshop/frontend/app/api/loyalty/points/route.ts`
   - `apps/coffeeshop/frontend/app/api/send-push/route.ts`
   - `apps/coffeeshop/frontend/app/api/push-subscription/route.ts`
   - `apps/coffeeshop/frontend/app/api/staff/reviews/route.ts`

   Read each file first. Then:
   - Remove the inline `const supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY || process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY || '';` line
   - Remove the inline `const supabase = createClient(supabaseUrl, supabaseServiceKey)` line (and any supabaseUrl declaration if only used for this)
   - Add `import { getSupabaseAdmin } from '@/lib/supabase-admin';` at the top
   - Replace usage with `const supabase = getSupabaseAdmin();` at the point where supabase client is first used
   - Remove unused `createClient` import from @supabase/supabase-js if no longer needed

**Part D: Remove ANON fallback from backoffice services (SEC-04)**

6. Read `apps/backoffice/lib/supabase-admin.ts` to find the existing admin client export name.
7. For EACH of these backoffice files:
   - `apps/backoffice/lib/contribution-admin-service.ts`
   - `apps/backoffice/lib/staff-service.ts`
   - `apps/backoffice/lib/qr/qr-service.ts`

   Read each file first. Then:
   - Remove the ANON fallback pattern
   - Import and use the existing backoffice supabase-admin client instead
   - Note: `apps/backoffice/scripts/translate-missing.ts` and `apps/backoffice/scripts/translate-only.ts` also have the pattern but they are CLI scripts that run locally — skip those for now (they need SERVICE_ROLE_KEY set in .env for local dev, not a security concern)

IMPORTANT: Read EVERY file before modifying. Preserve all existing logic. Only change how the Supabase client is obtained.
</action>
<verify> - `cd /Users/gianfrancodagostino/Desktop/gudbro-verticals && pnpm exec tsc --noEmit -p apps/coffeeshop/frontend/tsconfig.json 2>&1 | head -20` - `cd /Users/gianfrancodagostino/Desktop/gudbro-verticals && pnpm exec tsc --noEmit -p apps/backoffice/tsconfig.json 2>&1 | head -20` - `grep -rn "NEXT_PUBLIC_SUPABASE_ANON_KEY" apps/coffeeshop/frontend/app/api/` should return NO results (all fallbacks removed) - `grep -rn "timingSafeEqual" apps/backoffice/lib/accommodations/helpers.ts` should return a match - `grep -rn "getSupabaseAdmin" apps/coffeeshop/frontend/app/api/` should show all 7 route files importing it
</verify>
<done> - ADMIN_API_KEY uses crypto.timingSafeEqual with try/catch for length mismatches - coffeeshop supabase-admin.ts exists and throws on missing SERVICE_ROLE_KEY - All 7 coffeeshop API routes use getSupabaseAdmin() instead of ANON fallback - All 3 backoffice service files use existing supabase-admin instead of ANON fallback - Both apps compile without TypeScript errors
</done>
</task>

<task type="auto">
  <name>Task 2: Orders RLS migration — restrict SELECT to session owner or merchant staff</name>
  <files>
    shared/database/migrations/schema/074-fix-orders-rls-session-merchant.sql
  </files>
  <action>
1. Check the next available migration number:
   `ls shared/database/migrations/schema/ | sort -n | tail -5`
   Use the next sequential number (research says files go up to ~073, so likely 074).

2. Read the existing RLS policy on orders to confirm the current state:
   - Check `shared/database/migrations/schema/001-enable-rls-all-tables.sql` or search for `orders` in migration files to find the existing `USING (true)` policy name

3. Create the migration file (use the correct number):

```sql
-- Migration: Fix orders RLS to restrict by session and merchant
-- SEC-02: Orders table was wide open with USING(true)
--
-- IMPORTANT: DROP the old permissive policy first, then create restrictive one.
-- PostgreSQL OR-combines all policies for a given operation, so if the old
-- USING(true) policy remains, the new policy has no effect.

-- Drop the overly permissive SELECT policy
DROP POLICY IF EXISTS "Users can view own orders by session" ON public.orders;

-- Drop INSERT policy if also overly permissive
DROP POLICY IF EXISTS "Users can insert own orders by session" ON public.orders;

-- Create restrictive SELECT policy:
-- 1. Anonymous users can only read orders that have a non-null session_id
--    (Note: session_id is client-generated so this is basic isolation,
--     but prevents reading NULL session_id orders which are staff-created)
-- 2. Authenticated merchant staff can read orders for their merchant
CREATE POLICY "Orders SELECT: session owner or merchant staff"
  ON public.orders
  FOR SELECT
  USING (
    session_id IS NOT NULL
    OR
    merchant_id IN (
      SELECT mu.merchant_id FROM public.merchant_users mu
      WHERE mu.auth_provider_id = auth.uid()::text
    )
  );

-- Create restrictive INSERT policy:
-- Only allow inserting orders with a non-null session_id (anonymous ordering)
-- Service role (API routes) bypasses RLS, so admin insertions still work
CREATE POLICY "Orders INSERT: anonymous with session"
  ON public.orders
  FOR INSERT
  WITH CHECK (
    session_id IS NOT NULL
  );

-- Keep UPDATE/DELETE restricted to service role only (no policy needed —
-- RLS blocks by default, and API routes use SERVICE_ROLE_KEY which bypasses RLS)
```

4. Apply the migration using the Supabase MCP tool:
   - Use `mcp__supabase__apply_migration` with name `fix_orders_rls_session_merchant` and the SQL content

IMPORTANT:

- The migration MUST drop the old policy BEFORE creating the new one
- Use `DROP POLICY IF EXISTS` to be idempotent
- The policy names must not conflict with any existing policies
  </action>
  <verify> - Run `mcp__supabase__execute_sql` with: `SELECT policyname, cmd, qual FROM pg_policies WHERE tablename = 'orders';` to confirm old USING(true) policy is gone and new policies exist - Verify the new SELECT policy uses session_id or merchant_users check (not USING(true)) - Check `ls shared/database/migrations/schema/ | grep orders` to confirm migration file exists
  </verify>
  <done> - Old USING(true) RLS policy on orders is dropped - New SELECT policy restricts to session_id IS NOT NULL or authenticated merchant staff - New INSERT policy requires session_id IS NOT NULL for anonymous ordering - Migration file exists in shared/database/migrations/schema/ - Migration applied successfully to database
  </done>
  </task>

</tasks>

<verification>
1. TypeScript compiles for coffeeshop: `pnpm exec tsc --noEmit -p apps/coffeeshop/frontend/tsconfig.json`
2. TypeScript compiles for backoffice: `pnpm exec tsc --noEmit -p apps/backoffice/tsconfig.json`
3. No ANON fallback in coffeeshop API routes: `grep -rn "NEXT_PUBLIC_SUPABASE_ANON_KEY" apps/coffeeshop/frontend/app/api/` returns nothing
4. Timing-safe comparison in helpers.ts: `grep "timingSafeEqual" apps/backoffice/lib/accommodations/helpers.ts`
5. Orders RLS policy verified via SQL query on pg_policies
6. Migration file present: `ls shared/database/migrations/schema/*orders-rls*`
</verification>

<success_criteria>

- crypto.timingSafeEqual used for ADMIN_API_KEY comparison
- coffeeshop supabase-admin.ts throws on missing SERVICE_ROLE_KEY
- All 7 coffeeshop API routes migrated to getSupabaseAdmin()
- All 3 backoffice service files migrated to existing supabase-admin
- Orders RLS migration applied — no more USING(true) on SELECT
- Both apps compile without TypeScript errors
  </success_criteria>

<output>
After completion, create `.planning/phases/40-security-hardening/40-02-SUMMARY.md`
</output>
