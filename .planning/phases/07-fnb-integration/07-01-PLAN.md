---
phase: 07-fnb-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - shared/database/migrations/schema/080-accommodations-fnb-integration.sql
  - apps/accommodations/frontend/types/stay.ts
  - apps/accommodations/frontend/app/api/stay/[code]/property/route.ts
autonomous: true

must_haves:
  truths:
    - 'Property API returns hasLinkedFnb and linkedFnbSlug fields'
    - 'Demo property (Roots Da Nang) is linked to coffeeshop merchant slug'
    - "INT-01 is satisfied: conventions already filter by property via partner_id + partner_type='accommodation'"
  artifacts:
    - path: 'shared/database/migrations/schema/080-accommodations-fnb-integration.sql'
      provides: 'has_linked_fnb and linked_fnb_slug columns on accom_properties'
      contains: 'has_linked_fnb'
    - path: 'apps/accommodations/frontend/types/stay.ts'
      provides: 'PropertyInfo with F&B fields'
      contains: 'hasLinkedFnb'
    - path: 'apps/accommodations/frontend/app/api/stay/[code]/property/route.ts'
      provides: 'Property endpoint returning F&B config'
      contains: 'has_linked_fnb'
  key_links:
    - from: '080-accommodations-fnb-integration.sql'
      to: 'accom_properties'
      via: 'ALTER TABLE ADD COLUMN'
      pattern: 'has_linked_fnb'
    - from: 'property/route.ts'
      to: 'types/stay.ts'
      via: 'PropertyInfo type mapping'
      pattern: 'hasLinkedFnb.*has_linked_fnb'
---

<objective>
Add F&B linking configuration to accommodations backend: migration for has_linked_fnb/linked_fnb_slug columns, update property API route to return new fields, extend TypeScript types.

Purpose: FNB-02 (property config flag) and INT-01 (conventions connection) are backend prerequisites for the frontend RestaurantSection component.
Output: Migration 080, updated property route, extended PropertyInfo type. Demo property linked to coffeeshop slug.
</objective>

<execution_context>
@/Users/gianfrancodagostino/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gianfrancodagostino/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-fnb-integration/07-RESEARCH.md
@.planning/phases/07-fnb-integration/07-CONTEXT.md

Key existing files (read before modifying):
@apps/accommodations/frontend/types/stay.ts
@apps/accommodations/frontend/app/api/stay/[code]/property/route.ts
@shared/database/migrations/schema/079-accommodations-phase6-extensions.sql
@apps/accommodations/frontend/app/api/stay/[code]/deals/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Database migration and seed update for F&B linking</name>
  <files>shared/database/migrations/schema/080-accommodations-fnb-integration.sql</files>
  <action>
Create migration 080-accommodations-fnb-integration.sql with:

1. ALTER accom_properties to add:
   - `has_linked_fnb BOOLEAN NOT NULL DEFAULT false` -- whether property has linked coffeeshop PWA
   - `linked_fnb_slug TEXT` -- coffeeshop merchant slug for deep-linking (NULL when has_linked_fnb=false)

2. Add COMMENT ON COLUMN for both new columns (follow pattern from 079).

3. Seed update: SET has_linked_fnb=true, linked_fnb_slug='roots-danang' for the demo property (id='a1b2c3d4-e5f6-7890-abcd-ef1234567890' -- verify this UUID from seed in 078).

NOTE on INT-01 (conventions system connection): The deals/route.ts already queries `partner_conventions WHERE partner_id = guest.propertyId AND partner_type = 'accommodation'`. This IS the property-specific filtering. Do NOT add a redundant property_id FK to partner_conventions -- it would create data drift risk with partner_id. INT-01 is satisfied by the existing polymorphic pattern. Add a SQL COMMENT documenting this decision.

Follow existing migration patterns:

- Use IF NOT EXISTS for idempotent ALTERs
- End with informational COMMENT
  </action>
  <verify>
  Read the migration file and confirm:
- Two ALTER TABLE ADD COLUMN IF NOT EXISTS statements
- One UPDATE for demo property seed
- Comments documenting the INT-01 decision
- No redundant property_id column on partner_conventions
  </verify>
  <done>Migration 080 exists with has_linked_fnb and linked_fnb_slug columns, demo property linked to 'roots-danang'</done>
  </task>

<task type="auto">
  <name>Task 2: Extend types and property API route for F&B fields</name>
  <files>apps/accommodations/frontend/types/stay.ts, apps/accommodations/frontend/app/api/stay/[code]/property/route.ts</files>
  <action>
1. In types/stay.ts, add to PropertyInfo interface:
   - `hasLinkedFnb: boolean;`
   - `linkedFnbSlug: string | null;`

2. In property/route.ts:
   - Add `has_linked_fnb, linked_fnb_slug` to the SELECT query string (after the existing columns)
   - Map them in the PropertyInfo object: `hasLinkedFnb: data.has_linked_fnb ?? false` and `linkedFnbSlug: data.linked_fnb_slug || null`

3. In page.tsx (stay/[code]/page.tsx), update the PropertyExtended merge to also carry through F&B fields:
   - The existing spread `...data.property` will auto-include the new fields since they are on PropertyInfo
   - Verify the PropertyExtended extends PropertyInfo already includes these (it does via inheritance)

Do NOT modify stay-api.ts -- the existing fetchProperty function returns PropertyInfo which will auto-include the new fields.
</action>
<verify>
Run TypeScript check: `cd apps/accommodations/frontend && npx tsc --noEmit`
Confirm no type errors from the new fields.
Read property/route.ts and verify has_linked_fnb appears in SELECT and in the PropertyInfo mapping.
</verify>
<done>PropertyInfo type includes hasLinkedFnb and linkedFnbSlug. Property API route selects and returns both fields. TypeScript compiles clean.</done>
</task>

</tasks>

<verification>
- Migration 080 exists at shared/database/migrations/schema/080-accommodations-fnb-integration.sql
- PropertyInfo in types/stay.ts has hasLinkedFnb: boolean and linkedFnbSlug: string | null
- Property API route selects has_linked_fnb and linked_fnb_slug from accom_properties
- TypeScript compiles without errors: `cd apps/accommodations/frontend && npx tsc --noEmit`
- No redundant property_id column added to partner_conventions (INT-01 satisfied by existing pattern)
</verification>

<success_criteria>

- FNB-02 backend complete: property config includes has_linked_fnb flag and linked_fnb_slug field
- INT-01 satisfied: conventions system already connected to properties via partner_id + partner_type='accommodation'
- Demo property "Roots Da Nang" has has_linked_fnb=true and linked_fnb_slug='roots-danang'
- All existing tests/typechecks pass
  </success_criteria>

<output>
After completion, create `.planning/phases/07-fnb-integration/07-01-SUMMARY.md`
</output>
