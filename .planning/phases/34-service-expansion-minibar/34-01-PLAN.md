---
phase: 34-service-expansion-minibar
plan: 01
type: execute
wave: 1
depends_on: ['33-02']
files_modified:
  - shared/database/migrations/schema/088-service-catalog-enhancements.sql
  - apps/accommodations/frontend/types/stay.ts
  - apps/accommodations/frontend/app/api/stay/[code]/services/route.ts
  - apps/accommodations/frontend/app/api/stay/[code]/orders/route.ts
autonomous: true

must_haves:
  truths:
    - 'Services API returns includedInRate per item and categoryTag per category'
    - 'Orders API stores and returns categoryTag per order item, computes primary categoryTag per order'
    - 'Migration adds included_in_rate, category_tag columns to relevant tables'
  artifacts:
    - path: 'shared/database/migrations/schema/088-service-catalog-enhancements.sql'
      provides: 'Migration adding included_in_rate, category_tag columns'
      min_lines: 20
    - path: 'apps/accommodations/frontend/types/stay.ts'
      provides: 'Updated types with includedInRate and categoryTag fields'
  key_links:
    - from: 'services/route.ts'
      to: 'types/stay.ts'
      via: 'Maps DB columns to TypeScript interface fields'
      pattern: 'includedInRate|categoryTag'
    - from: 'orders/route.ts'
      to: 'types/stay.ts'
      via: 'Maps category_tag to ServiceOrder.categoryTag'
      pattern: 'categoryTag|primaryCategoryTag'
---

<objective>
Database migration for service catalog enhancements and API route updates to support new fields (includedInRate, categoryTag).

Purpose: SVC-01/02/05 foundation -- migration 088 adds included_in_rate and category_tag columns; API routes and types updated to expose new fields.
Output: Migration 088 applied, types updated, services and orders API routes return new fields.
</objective>

<execution_context>
@/Users/gianfrancodagostino/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gianfrancodagostino/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/33-guest-dashboard-redesign/33-02-SUMMARY.md

Key source files:
@apps/accommodations/frontend/types/stay.ts
@apps/accommodations/frontend/app/api/stay/[code]/services/route.ts
@apps/accommodations/frontend/app/api/stay/[code]/orders/route.ts
@shared/database/migrations/schema/077-accommodations-schema.sql
@shared/database/migrations/schema/081-schema-api-alignment.sql
@shared/database/migrations/schema/083-accommodations-v2-foundation.sql
@shared/database/migrations/schema/086-service-automation-level.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Database migration for service catalog enhancements</name>
  <files>
    shared/database/migrations/schema/088-service-catalog-enhancements.sql
  </files>
  <action>
Create migration 088 that adds new columns to support the service catalog redesign and order categorization.

**accom_service_items -- new columns:**

```sql
ALTER TABLE accom_service_items
  ADD COLUMN IF NOT EXISTS included_in_rate BOOLEAN NOT NULL DEFAULT false;
```

- `included_in_rate`: When true, item shows "Included" badge instead of price. Guest can still order/consume it but no charge. Used for complimentary breakfast, pool access, etc.

**accom_service_categories -- new column:**

```sql
ALTER TABLE accom_service_categories
  ADD COLUMN IF NOT EXISTS category_tag TEXT DEFAULT 'general'
    CHECK (category_tag IN ('food', 'beverage', 'laundry', 'minibar', 'spa', 'transport', 'activity', 'general'));
```

- `category_tag`: Standardized tag for grouping orders by category. Different from `name` which is freeform per property. Used for filtering in order list.

**accom_service_order_items -- new column:**

```sql
ALTER TABLE accom_service_order_items
  ADD COLUMN IF NOT EXISTS category_tag TEXT DEFAULT 'general';
```

**Add COMMENT statements** for all new columns following the project convention.

**Apply via Supabase MCP** using `mcp__supabase__apply_migration` with name `service_catalog_enhancements`.
</action>
<verify>
Verify migration applied: `mcp__supabase__execute_sql` with query `SELECT column_name FROM information_schema.columns WHERE table_name = 'accom_service_items' AND column_name = 'included_in_rate';` should return 1 row.
Verify category_tag on categories: `mcp__supabase__execute_sql` with query `SELECT column_name FROM information_schema.columns WHERE table_name = 'accom_service_categories' AND column_name = 'category_tag';` should return 1 row.
Verify category_tag on order items: `mcp__supabase__execute_sql` with query `SELECT column_name FROM information_schema.columns WHERE table_name = 'accom_service_order_items' AND column_name = 'category_tag';` should return 1 row.
</verify>
<done>
Migration 088 applied: accom_service_items has included_in_rate column, accom_service_categories has category_tag column, accom_service_order_items has category_tag column. Migration file saved to shared/database/migrations/schema/.
</done>
</task>

<task type="auto">
  <name>Task 2: Update types and API routes to support new fields</name>
  <files>
    apps/accommodations/frontend/types/stay.ts
    apps/accommodations/frontend/app/api/stay/[code]/services/route.ts
    apps/accommodations/frontend/app/api/stay/[code]/orders/route.ts
  </files>
  <action>
**types/stay.ts:**

1. Add `includedInRate: boolean` to `ServiceItemResponse` interface
2. Add `categoryTag: string` to `ServiceCategoryWithItems` interface
3. Add `categoryTag: string` to `ServiceOrder` interface (computed from items)
4. Add `categoryTag?: string` to `ServiceOrderItem` interface

**services/route.ts:**

1. Add `included_in_rate` to the Supabase SELECT on `accom_service_items`
2. Add `category_tag` to the Supabase SELECT on `accom_service_categories`
3. Map `included_in_rate` -> `includedInRate` in the item mapping
4. Map `category_tag` -> `categoryTag` in the category mapping

**orders/route.ts (GET):**

1. Add `category_tag` to the SELECT on `accom_service_order_items`
2. Map to `categoryTag` in response
3. Compute order-level categoryTag using `primaryCategoryTag` helper:

```typescript
function primaryCategoryTag(items: ServiceOrderItem[]): string {
  const counts: Record<string, number> = {};
  for (const item of items) {
    const tag = item.categoryTag || 'general';
    counts[tag] = (counts[tag] || 0) + 1;
  }
  let maxTag = 'general';
  let maxCount = 0;
  for (const [tag, count] of Object.entries(counts)) {
    if (count > maxCount) {
      maxTag = tag;
      maxCount = count;
    }
  }
  return maxTag;
}
```

**orders/route.ts (POST):**

When building order items, look up the category_tag from the item's category (extend the existing join to include `category_tag`). Store it on each order item row.
</action>
<verify>
TypeScript compilation: `cd apps/accommodations/frontend && npx tsc --noEmit --pretty 2>&1 | head -40`
Verify new fields in types: `grep 'includedInRate\|categoryTag' apps/accommodations/frontend/types/stay.ts`
Verify services route maps new fields: `grep 'includedInRate\|categoryTag' apps/accommodations/frontend/app/api/stay/\[code\]/services/route.ts`
Verify orders route maps category_tag: `grep 'category_tag\|categoryTag' apps/accommodations/frontend/app/api/stay/\[code\]/orders/route.ts`
</verify>
<done>
Types updated with includedInRate and categoryTag. Services API returns includedInRate per item and categoryTag per category. Orders API stores and returns categoryTag per order item, computes primary categoryTag per order.
</done>
</task>

</tasks>

<verification>
1. `cd apps/accommodations/frontend && npx tsc --noEmit` -- zero errors
2. Migration 088 applied: included_in_rate on accom_service_items, category_tag on accom_service_categories and accom_service_order_items
3. Services API returns includedInRate and categoryTag fields
4. Orders API stores and returns categoryTag per item, computes primary tag per order
</verification>

<success_criteria>

- Migration 088 applied successfully with all three new columns
- TypeScript types include includedInRate and categoryTag
- Services API returns new fields in response
- Orders API stores category_tag on order items and computes primary tag
- TypeScript compiles without errors

</success_criteria>

<output>
After completion, create `.planning/phases/34-service-expansion-minibar/34-01-SUMMARY.md`
</output>
