---
phase: 34-service-expansion-minibar
plan: 04
type: execute
wave: 2
depends_on: ['34-01']
files_modified:
  - shared/database/migrations/schema/089-minibar-self-service.sql
  - apps/accommodations/frontend/types/stay.ts
  - apps/accommodations/frontend/app/api/stay/[code]/orders/route.ts
  - apps/accommodations/frontend/lib/stay-api.ts
  - apps/accommodations/frontend/components/stay/MinibarSection.tsx
  - apps/accommodations/frontend/components/stay/MinibarItemRow.tsx
autonomous: true

must_haves:
  truths:
    - 'Minibar section lets guest mark consumed items via honor system (checkbox/toggle per item)'
    - 'Marking a minibar item creates a service order with automation_level self_service'
    - 'self_service automation level is a valid DB constraint value'
  artifacts:
    - path: 'apps/accommodations/frontend/components/stay/MinibarSection.tsx'
      provides: 'Minibar UI with item list, consumed toggles, and consumption summary'
      min_lines: 80
    - path: 'apps/accommodations/frontend/components/stay/MinibarItemRow.tsx'
      provides: 'Single minibar item with checkbox, name, price, quantity controls'
      min_lines: 40
    - path: 'shared/database/migrations/schema/089-minibar-self-service.sql'
      provides: 'Migration adding self_service automation level and minibar schema support'
      min_lines: 15
  key_links:
    - from: 'MinibarSection.tsx'
      to: 'stay-api.ts'
      via: 'Consumed item triggers createMinibarOrder with minibar items'
      pattern: 'createMinibarOrder|markConsumed'
---

<objective>
Build the minibar self-service system: migration for self_service automation level, minibar types and API, and guest-facing MinibarSection/MinibarItemRow components.

Purpose: SVC-03 (minibar self-service with guest marking + owner confirmation)
Output: Migration 089, updated types/API for minibar orders, MinibarSection + MinibarItemRow components
</objective>

<execution_context>
@/Users/gianfrancodagostino/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gianfrancodagostino/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/34-service-expansion-minibar/34-01-SUMMARY.md

Key source files (post 34-01):
@apps/accommodations/frontend/types/stay.ts
@apps/accommodations/frontend/app/api/stay/[code]/orders/route.ts
@apps/accommodations/frontend/lib/stay-api.ts
@apps/accommodations/frontend/hooks/useServiceCart.ts
@shared/database/migrations/schema/088-service-catalog-enhancements.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migration 089 + types + API for minibar self-service</name>
  <files>
    shared/database/migrations/schema/089-minibar-self-service.sql
    apps/accommodations/frontend/types/stay.ts
    apps/accommodations/frontend/app/api/stay/[code]/orders/route.ts
    apps/accommodations/frontend/lib/stay-api.ts
  </files>
  <action>
**Migration 089:**

Extend automation_level CHECK constraint and add minibar tracking columns.

```sql
-- Drop existing constraint and recreate with self_service option
ALTER TABLE accom_service_categories
  DROP CONSTRAINT IF EXISTS accom_service_categories_automation_level_check;

ALTER TABLE accom_service_categories
  ADD CONSTRAINT accom_service_categories_automation_level_check
  CHECK (automation_level IN ('auto_confirm', 'manual', 'whatsapp_notify', 'self_service'));

-- Minibar tracking on orders
ALTER TABLE accom_service_orders
  ADD COLUMN IF NOT EXISTS is_minibar_consumption BOOLEAN NOT NULL DEFAULT false;

ALTER TABLE accom_service_orders
  ADD COLUMN IF NOT EXISTS owner_confirmed BOOLEAN;
```

Add COMMENT statements. Apply via `mcp__supabase__apply_migration` with name `minibar_self_service`. Save locally to `shared/database/migrations/schema/089-minibar-self-service.sql`.

**types/stay.ts:**

1. Add to `ServiceOrder` interface: `isMinibarConsumption: boolean;` and `ownerConfirmed: boolean | null;`
2. Add `CreateMinibarOrderRequest` type:
   ```typescript
   export interface CreateMinibarOrderRequest {
     items: { serviceItemId: string; quantity: number }[];
   }
   ```

**orders/route.ts:**

1. POST: When order items come from `self_service` category, set `is_minibar_consumption = true`, auto-confirm status, `owner_confirmed = null`
2. GET: Add `is_minibar_consumption, owner_confirmed` to SELECT, map to camelCase in mapOrder

**stay-api.ts:**

Add `createMinibarOrder` convenience function:

```typescript
export function createMinibarOrder(
  bookingCode: string,
  token: string,
  items: { serviceItemId: string; quantity: number }[]
): Promise<FetchResult<{ order: ServiceOrder }>> {
  return postStayAPI<{ order: ServiceOrder }>(
    `/api/stay/${bookingCode}/orders`,
    token,
    { items }
  );
}
```

  </action>
  <verify>
  Verify self_service is valid: `mcp__supabase__execute_sql` with `UPDATE accom_service_categories SET automation_level = 'self_service' WHERE false;` should succeed.
  Verify is_minibar_consumption column: `mcp__supabase__execute_sql` with `SELECT column_name FROM information_schema.columns WHERE table_name = 'accom_service_orders' AND column_name = 'is_minibar_consumption';` should return 1 row.
  TypeScript compilation: `cd apps/accommodations/frontend && npx tsc --noEmit --pretty 2>&1 | head -40`
  Verify minibar fields: `grep 'isMinibarConsumption\|ownerConfirmed\|createMinibarOrder' apps/accommodations/frontend/types/stay.ts apps/accommodations/frontend/lib/stay-api.ts`
  </verify>
  <done>
  Migration 089 applied. Types extended with minibar fields. Orders API handles self_service auto-confirm. stay-api has createMinibarOrder function.
  </done>
</task>

<task type="auto">
  <name>Task 2: MinibarSection and MinibarItemRow components</name>
  <files>
    apps/accommodations/frontend/components/stay/MinibarSection.tsx
    apps/accommodations/frontend/components/stay/MinibarItemRow.tsx
  </files>
  <action>
**MinibarItemRow.tsx (new component):**

Props:

```typescript
interface MinibarItemRowProps {
  item: {
    id: string;
    name: string;
    price: number;
    currency: string;
    image: string | null;
    includedInRate: boolean;
  };
  consumed: number;
  onConsume: (quantity: number) => void;
}
```

Layout:

- Horizontal row with image (h-12 w-12 rounded-lg), name+price, and quantity controls
- If consumed === 0: Show "Mark used" button (outline, teal): `rounded-lg border border-[#3D8B87] px-3 py-1.5 text-xs font-medium text-[#3D8B87]`
- If consumed > 0: Show quantity stepper (Minus / number / Plus) + green left border: `border-l-3 border-emerald-500`
- Price shows per-unit or "Included" badge

**MinibarSection.tsx (new component):**

Props:

```typescript
interface MinibarSectionProps {
  categories: ServiceCategoryWithItems[];
  bookingCode: string;
  token: string;
  onOrderCreated: () => void;
}
```

Logic:

1. Filter minibar categories: `automationLevel === 'self_service'`. If none, return `null`.
2. Local consumption state: `Map<string, number>` tracking serviceItemId -> consumed quantity
3. Items list: Flatten all items from self_service categories, render MinibarItemRow for each
4. Submit button: "Report consumption" creates order via `createMinibarOrder(bookingCode, token, consumedItems)`. On success: clear state, call `onOrderCreated()`, show success message.

Layout:

```
Section wrapper (same card style as other dashboard sections):
  Header: "Minibar" with Wine icon (Phosphor, duotone, text-[#E07A5F])
  Description: "Mark items you've consumed. We'll add them to your room charge."
  Item list: MinibarItemRow for each item
  Footer (sticky when items consumed): Total + "Report Consumption" button
```

Design details:

- Trust message: "Items are billed on the honor system" in muted color
- Total bar: `bg-[#3D8B87]/5 rounded-xl px-3 py-2`
- Submit button: `bg-[#3D8B87] text-white rounded-xl py-3 font-semibold`
- Success state: Brief CheckCircle animation, then reset
  </action>
  <verify>
  TypeScript compilation: `cd apps/accommodations/frontend && npx tsc --noEmit --pretty 2>&1 | head -30`
  Verify MinibarSection exists: `ls apps/accommodations/frontend/components/stay/MinibarSection.tsx`
  Verify MinibarItemRow exists: `ls apps/accommodations/frontend/components/stay/MinibarItemRow.tsx`
  Verify self_service filtering: `grep 'self_service\|automationLevel' apps/accommodations/frontend/components/stay/MinibarSection.tsx`
  Verify createMinibarOrder usage: `grep 'createMinibarOrder' apps/accommodations/frontend/components/stay/MinibarSection.tsx`
  </verify>
  <done>
  MinibarSection renders minibar items with honor-system consumption tracking. MinibarItemRow shows mark-consumed UI with quantity controls. Reporting consumption creates a minibar order via API.
  </done>
  </task>

</tasks>

<verification>
1. `cd apps/accommodations/frontend && npx tsc --noEmit` -- zero errors
2. Migration 089 applied: self_service automation level, is_minibar_consumption, owner_confirmed columns
3. MinibarSection renders for self_service categories with item consumption tracking
4. Marking consumed items creates an order via createMinibarOrder API
5. Order is auto-confirmed with is_minibar_consumption=true, owner_confirmed=null
</verification>

<success_criteria>

- Minibar section lets guest mark consumed items via honor system
- "Report Consumption" creates a minibar order (auto-confirmed, flagged as minibar)
- self_service is a valid automation_level in the database
- MinibarSection returns null if no self_service categories exist
- TypeScript compiles without errors

</success_criteria>

<output>
After completion, create `.planning/phases/34-service-expansion-minibar/34-04-SUMMARY.md`
</output>
