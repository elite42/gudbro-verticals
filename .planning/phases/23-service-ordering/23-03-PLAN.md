---
phase: 23-service-ordering
plan: 03
type: execute
wave: 2
depends_on: ['23-01']
files_modified:
  - apps/accommodations/frontend/hooks/useServiceCart.ts
  - apps/accommodations/frontend/hooks/useOrderPolling.ts
  - apps/accommodations/frontend/components/stay/ServiceCatalog.tsx
  - apps/accommodations/frontend/components/stay/ServiceItemCard.tsx
  - apps/accommodations/frontend/components/stay/CartDrawer.tsx
  - apps/accommodations/frontend/components/stay/CartFAB.tsx
  - apps/accommodations/frontend/components/stay/OrderStatusTimeline.tsx
  - apps/accommodations/frontend/components/stay/ActiveOrders.tsx
  - apps/accommodations/frontend/components/stay/ServicesCarousel.tsx
  - apps/accommodations/frontend/app/stay/[code]/page.tsx
autonomous: true

must_haves:
  truths:
    - 'Guest can browse full service catalog organized by category tabs'
    - 'Guest can add items to cart with quantity stepper and optional notes'
    - 'Items outside availability hours are grayed out and not addable'
    - 'Guest can review cart and submit order with ASAP or time slot'
    - 'Guest can see active orders with live status timeline'
    - 'Cart state survives tab navigation within dashboard'
  artifacts:
    - path: 'apps/accommodations/frontend/hooks/useServiceCart.ts'
      provides: 'Cart state management (add, remove, update, clear)'
      contains: 'useServiceCart'
    - path: 'apps/accommodations/frontend/components/stay/ServiceCatalog.tsx'
      provides: 'Full-page catalog with category tabs and item grid'
      min_lines: 80
    - path: 'apps/accommodations/frontend/components/stay/CartDrawer.tsx'
      provides: 'Bottom sheet cart with checkout flow'
      min_lines: 60
    - path: 'apps/accommodations/frontend/components/stay/ActiveOrders.tsx'
      provides: 'Dashboard section showing recent orders with status'
      min_lines: 40
    - path: 'apps/accommodations/frontend/hooks/useOrderPolling.ts'
      provides: 'Polling hook for order status updates'
      contains: 'useOrderPolling'
  key_links:
    - from: 'apps/accommodations/frontend/components/stay/CartDrawer.tsx'
      to: 'createOrderAPI'
      via: 'Order submission'
      pattern: 'createOrderAPI|postStayAPI'
    - from: 'apps/accommodations/frontend/hooks/useOrderPolling.ts'
      to: 'fetchOrdersAPI'
      via: '30s polling interval'
      pattern: 'setInterval'
    - from: 'apps/accommodations/frontend/app/stay/[code]/page.tsx'
      to: 'useServiceCart'
      via: 'Cart state lifted to page level'
      pattern: 'useServiceCart'
---

<objective>
Build the guest-facing service catalog, cart, order submission, and order tracking UI in the accommodations PWA.

Purpose: Guests staying at a property need to browse services, build a cart, place orders, and track their status from the In-Stay Dashboard.
Output: Full guest ordering flow -- catalog browsing, cart management, checkout, and live order tracking.
</objective>

<execution_context>
@/Users/gianfrancodagostino/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gianfrancodagostino/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-service-ordering/23-RESEARCH.md
@.planning/phases/23-service-ordering/23-01-SUMMARY.md

@apps/accommodations/frontend/components/stay/ServicesCarousel.tsx
@apps/accommodations/frontend/app/stay/[code]/page.tsx
@apps/accommodations/frontend/components/BottomNav.tsx
@apps/accommodations/frontend/hooks/useStaySession.ts
@apps/accommodations/frontend/lib/stay-api.ts
@apps/accommodations/frontend/types/stay.ts
@apps/coffeeshop/frontend/components/StickyCartBar.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Cart hook + catalog + item card components</name>
  <files>
    apps/accommodations/frontend/hooks/useServiceCart.ts
    apps/accommodations/frontend/components/stay/ServiceCatalog.tsx
    apps/accommodations/frontend/components/stay/ServiceItemCard.tsx
    apps/accommodations/frontend/components/stay/ServicesCarousel.tsx
  </files>
  <action>
    1. Create useServiceCart.ts hook (React state only, no localStorage):
       - State: `cartItems: CartItem[]` (CartItem from types/stay.ts)
       - Methods:
         - `addItem(item: ServiceItemResponse)` -- adds with quantity 1, or increments if already in cart
         - `removeItem(serviceItemId: string)` -- removes item
         - `updateQuantity(serviceItemId: string, quantity: number)` -- clamp 1-10, remove if 0
         - `updateNotes(serviceItemId: string, notes: string)` -- update notes for item
         - `clearCart()` -- empty cart
         - `getItemCount()` -- total quantity across all items
         - `getSubtotal()` -- sum of unitPrice * quantity (minor units)
         - `getCartItem(serviceItemId: string)` -- find item in cart
       - Return: `{ items, addItem, removeItem, updateQuantity, updateNotes, clearCart, itemCount, subtotal, getCartItem }`

    2. Create ServiceItemCard.tsx:
       - 'use client' component
       - Props: `{ item: ServiceItemResponse; isAvailable: boolean; cartQuantity: number; onAdd: () => void; onRemove: () => void; currency: string; timezone: string; }`
       - Layout: card with image (if available, fallback icon), name, description (truncated 2 lines), price formatted
       - If isAvailable=false: grayed out card (opacity-50), show "Available {from} - {until}" badge, no add button
       - If in cart (cartQuantity > 0): show quantity badge and +/- stepper instead of "Add" button
       - If NOT in cart and available: "Add" button (+ icon)
       - If !inStock: show "Out of stock" badge, disable add
       - Price formatting: use minor-to-major conversion (divide by 100, or no conversion for zero-decimal currencies). Format with currency symbol.

    3. Create ServiceCatalog.tsx:
       - 'use client' component
       - Props: `{ categories: ServiceCategoryWithItems[]; cart: ReturnType<typeof useServiceCart>; timezone: string; propertyCurrency: string; onClose: () => void; }`
       - Layout: full-screen overlay or drawer (fixed inset-0, z-50, bg-white)
         - Header: "Services" title + close (X) button
         - Category tabs: horizontal scrollable row of pills/tabs (one per category, show icon + name)
         - Selected category highlights
         - Items grid: 1 col on mobile, 2 cols on tablet+
         - Each item rendered via ServiceItemCard
       - Availability logic: for each item, check if currently available:
         - If is_always_available: always available
         - Otherwise: compare current time in property timezone against availableFrom/availableUntil
         - Use `new Date().toLocaleTimeString('en-US', { hour12: false, timeZone: timezone })` to get current time in property timezone
         - Compare as HH:MM strings (simple string comparison works for 24h format)
       - Show all items (available items first, then unavailable grayed out)

    4. Modify ServicesCarousel.tsx:
       - Add "View All" button/link that triggers opening the full ServiceCatalog
       - Add onViewAll callback prop: `{ onViewAll: () => void }`
       - Add small add-to-cart (+) button on each item in the carousel for quick-add
       - Pass cart and onAddToCart props for inline cart interaction
       - Keep existing carousel layout but enhance with cart integration

  </action>
  <verify>
    - TypeScript compiles: `cd apps/accommodations/frontend && npx tsc --noEmit --pretty 2>&1 | head -20`
    - Components exist: `ls apps/accommodations/frontend/components/stay/Service*.tsx`
    - Hook exists: `ls apps/accommodations/frontend/hooks/useServiceCart.ts`
  </verify>
  <done>
    Cart hook manages state with add/remove/quantity/notes. ServiceCatalog shows full catalog with category tabs and availability checking. ServiceItemCard shows item with cart interaction. ServicesCarousel has "View All" and quick-add.
  </done>
</task>

<task type="auto">
  <name>Task 2: CartFAB + CartDrawer + order tracking + dashboard integration</name>
  <files>
    apps/accommodations/frontend/components/stay/CartFAB.tsx
    apps/accommodations/frontend/components/stay/CartDrawer.tsx
    apps/accommodations/frontend/components/stay/OrderStatusTimeline.tsx
    apps/accommodations/frontend/components/stay/ActiveOrders.tsx
    apps/accommodations/frontend/hooks/useOrderPolling.ts
    apps/accommodations/frontend/app/stay/[code]/page.tsx
  </files>
  <action>
    1. Create CartFAB.tsx (floating action button):
       - 'use client' component
       - Props: `{ itemCount: number; onClick: () => void; }`
       - Position: fixed bottom-20 right-4 (above BottomNav)
       - Appearance: round button (56px), primary color, shopping bag icon (ShoppingCart from @phosphor-icons/react)
       - Badge: red circle with itemCount (top-right corner)
       - Hidden when itemCount === 0
       - Animate in/out (scale transition)
       - z-index above content but below modals (z-40)

    2. Create CartDrawer.tsx (bottom sheet for cart + checkout):
       - 'use client' component
       - Props: `{ cart: ReturnType<typeof useServiceCart>; bookingCode: string; token: string; currency: string; timezone: string; onClose: () => void; onOrderPlaced: () => void; }`
       - Layout: fixed bottom sheet (slides up from bottom, max-h-[80vh])
         - Header: "Your Order" + close button + item count
         - Scrollable items list: each item shows name, quantity stepper, unit price, line total, notes input, remove button
         - Delivery time section:
           - Toggle: "ASAP" (default) vs "Choose time"
           - If "Choose time": time slot picker with 30-min increments within business hours
           - Use select/dropdown with time options (e.g., "10:00", "10:30", "11:00"...)
         - Optional delivery notes textarea
         - Order summary: subtotal, total (same for MVP -- no tax)
         - Submit button: "Place Order" with loading state
       - On submit:
         - Call `createOrderAPI(bookingCode, token, { items, requestedTime, deliveryNotes })`
         - On success: show success state ("Order placed!"), clear cart, call onOrderPlaced
         - On error: show error message (e.g., "Some items are no longer available")
       - Backdrop overlay (click to close)
       - Price formatting: same minor-to-major conversion as ServiceItemCard

    3. Create OrderStatusTimeline.tsx:
       - 'use client' component
       - Props: `{ status: string; createdAt: string; }`
       - Steps: Submitted > Confirmed > Preparing > Ready > Delivered
       - Visual: horizontal or vertical step indicators with dots/lines
       - Current step highlighted (colored), completed steps checkmarked, future steps gray
       - Cancelled: show red "Cancelled" badge instead of timeline
       - Use ORDER_STATUS_LABELS mapping: 'pending' displays as 'Submitted'
       - Import status labels directly (define them locally -- don't import from backoffice)

    4. Create ActiveOrders.tsx:
       - 'use client' component
       - Props: `{ orders: ServiceOrder[]; currency: string; }`
       - Show most recent non-delivered/non-cancelled order prominently with OrderStatusTimeline
       - Below that: list of other active orders (compact, status badge + item count + total)
       - Past orders (delivered/cancelled) collapsed or hidden
       - If no orders: don't render anything (invisible section)
       - Formatted timestamps: "2 min ago", "15 min ago", etc. using relative time

    5. Create useOrderPolling.ts hook:
       - Props: `{ bookingCode: string; token: string; enabled: boolean; }`
       - Fetches orders via `fetchOrdersAPI(bookingCode, token)`
       - Polls every 30 seconds when enabled (and when there are active orders)
       - Returns `{ orders: ServiceOrder[]; isLoading: boolean; refetch: () => void; }`
       - Auto-stops polling when no active orders (all delivered/cancelled)
       - Cleanup interval on unmount

    6. Integrate everything into the dashboard page (app/stay/[code]/page.tsx):
       - Import and use `useServiceCart()` at PAGE level (so cart survives tab changes)
       - State: showCatalog (boolean), showCart (boolean)
       - Use `useOrderPolling` hook for order tracking
       - When "services" tab is active in BottomNav: show ServiceCatalog overlay
       - ServicesCarousel: pass onViewAll to open catalog, pass cart for quick-add
       - CartFAB: visible when cart has items, onClick opens CartDrawer
       - CartDrawer: pass cart, on order placed trigger refetch of orders
       - ActiveOrders section: render below ServicesCarousel (only when orders exist)
       - Ensure cart state, catalog state, and order state are all managed at page level
       - Pass property timezone (from stay data or services response) to components

    **Important implementation notes:**
    - Cart state MUST be at page level (not inside ServiceCatalog) to survive tab navigation
    - Use @phosphor-icons/react (NOT /dist/ssr) since all these are client components
    - Follow existing component patterns from ServicesCarousel (loading states, error handling)
    - Price display: always format minor to major units for display
    - ServiceCatalog and CartDrawer are overlays -- they don't replace the dashboard content

  </action>
  <verify>
    - TypeScript compiles: `cd apps/accommodations/frontend && npx tsc --noEmit --pretty 2>&1 | head -20`
    - Build passes: `cd apps/accommodations/frontend && npx next build 2>&1 | tail -20`
    - All new components exist: `ls apps/accommodations/frontend/components/stay/{Cart,Order,Active}*.tsx`
    - Hook exists: `ls apps/accommodations/frontend/hooks/useOrderPolling.ts`
  </verify>
  <done>
    Guest can: see floating cart button when items added, open cart drawer to review/modify/submit order, choose ASAP or time slot delivery, see active orders with live status timeline that polls every 30s. All state managed at page level to survive tab navigation.
  </done>
</task>

</tasks>

<verification>
- Guest can browse catalog with category tabs from ServicesCarousel "View All" or BottomNav services tab
- Items outside availability hours are grayed out with time badge
- Adding items shows CartFAB with count badge
- CartDrawer shows items with quantity stepper, notes, delivery time
- Submitting order calls API and shows success state
- ActiveOrders section appears below ServicesCarousel after placing order
- Order status timeline shows current step
- Polling updates order status every 30s
- Cart survives navigating between dashboard tabs
- Build passes cleanly
</verification>

<success_criteria>

1. Full catalog browsable by category with availability checking
2. Cart with add/remove/quantity/notes working
3. CartFAB visible with item count, opens CartDrawer
4. Order submission with ASAP or time slot, success/error states
5. Active orders section with status timeline
6. Polling updates every 30s for active orders
7. Cart state persists across tab changes
8. TypeScript compiles and build passes
   </success_criteria>

<output>
After completion, create `.planning/phases/23-service-ordering/23-03-SUMMARY.md`
</output>
