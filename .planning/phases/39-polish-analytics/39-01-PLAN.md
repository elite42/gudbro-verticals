---
phase: 39-polish-analytics
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - shared/database/migrations/schema/101-order-performance-receipts.sql
  - apps/backoffice/lib/accommodations/helpers.ts
  - apps/backoffice/app/api/accommodations/orders/[id]/route.ts
  - apps/backoffice/app/api/accommodations/analytics/order-performance/route.ts
  - apps/backoffice/components/accommodations/OrderPerformancePanel.tsx
  - apps/backoffice/components/accommodations/AccommodationAnalytics.tsx
autonomous: true

must_haves:
  truths:
    - 'Order status transitions record timestamps (confirmed_at, preparing_at, ready_at, delivered_at) in the database'
    - 'Backoffice analytics shows order-to-delivery average time with counters segmented by service category'
  artifacts:
    - path: 'shared/database/migrations/schema/101-order-performance-receipts.sql'
      provides: 'Migration adding order timestamp columns and receipt settings columns'
      min_lines: 30
    - path: 'apps/backoffice/app/api/accommodations/analytics/order-performance/route.ts'
      provides: 'API endpoint returning avg fulfillment time and order counts segmented by category'
      exports: ['GET']
      min_lines: 60
    - path: 'apps/backoffice/components/accommodations/OrderPerformancePanel.tsx'
      provides: 'Counters showing avg order-to-delivery time per category (not charts)'
      min_lines: 60
  key_links:
    - from: 'orders/[id]/route.ts (PATCH)'
      to: 'helpers.ts'
      via: 'Status transition records timestamp in corresponding column'
      pattern: 'confirmed_at|preparing_at|ready_at|delivered_at'
    - from: 'OrderPerformancePanel.tsx'
      to: 'order-performance/route.ts'
      via: 'Fetches performance metrics and renders counters'
      pattern: 'avgFulfillmentTime|ordersByCategory'
---

<objective>
Build order performance tracking: migration for timestamp columns and receipt settings, timestamp recording on status transitions, and analytics API + counters panel.

Purpose: SVC-07 (order performance tracking) — track order fulfillment times and display actionable metrics segmented by category.
Output: Migration 101, timestamp recording in PATCH handler, order performance API + counters panel wired into AccommodationAnalytics.
</objective>

<execution_context>
@/Users/gianfrancodagostino/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gianfrancodagostino/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

Key source files:
@apps/backoffice/app/api/accommodations/orders/[id]/route.ts
@apps/backoffice/app/api/accommodations/analytics/kpis/route.ts
@apps/backoffice/components/accommodations/AccommodationAnalytics.tsx
@apps/backoffice/components/accommodations/KPICard.tsx
@apps/backoffice/lib/accommodations/helpers.ts
@shared/database/migrations/schema/083-accommodations-v2-foundation.sql

Pre-explored findings:

- `category_tag` is on `accom_service_order_items` table (denormalized from categories, migration 095). NOT on `accom_service_orders`.
- To get category per order, join through items: each item has `category_tag` column (values: food, beverage, laundry, minibar, spa, transport, activity, general).
- The guest PWA computes order-level `categoryTag` via majority vote of item tags (`primaryCategoryTag()` in orders/route.ts).
- Backoffice auth: `validateAdminApiKey(request)` from `@/lib/accommodations/helpers` — checks `ADMIN_API_KEY` env var against Bearer token.
- PATCH handler fetches `status` via `.select('status').eq('id', params.id).single()`, computes `newStatus` from `ORDER_ACTION_TO_STATUS[action]`, builds `update` object, calls `.update(update)`.
  </context>

<tasks>

<task type="auto">
  <name>Task 1: Migration 101 + timestamp recording on status transitions</name>
  <files>
    shared/database/migrations/schema/101-order-performance-receipts.sql
    apps/backoffice/lib/accommodations/helpers.ts
    apps/backoffice/app/api/accommodations/orders/[id]/route.ts
  </files>
  <action>
**Migration 101: Order Performance Timestamps + Receipt Settings**

Add per-status timestamp columns to `accom_service_orders` for performance tracking, and receipt configuration columns to `accom_properties` (needed by Plan 02).

```sql
-- ============================================================================
-- Migration 101: Order Performance Timestamps + Receipt Settings
-- ============================================================================
-- Date: 2026-02-02
-- Description: Adds per-status timestamps to service orders for performance
--              tracking (SVC-07) and receipt confirmation settings (SVC-08).
--
-- Changes:
--   - ALTER accom_service_orders: +4 timestamp columns (confirmed_at, preparing_at, ready_at, delivered_at)
--   - ALTER accom_service_orders: +2 receipt columns (receipt_confirmed_at, receipt_auto_confirm_at)
--   - ALTER accom_properties: +2 receipt config columns (receipt_enabled, receipt_auto_confirm_hours)
--   - Index on property_id + delivered_at for performance queries
-- ============================================================================

-- 1. Order status timestamps for performance tracking (SVC-07)
ALTER TABLE accom_service_orders
  ADD COLUMN IF NOT EXISTS confirmed_at TIMESTAMPTZ,
  ADD COLUMN IF NOT EXISTS preparing_at TIMESTAMPTZ,
  ADD COLUMN IF NOT EXISTS ready_at TIMESTAMPTZ,
  ADD COLUMN IF NOT EXISTS delivered_at TIMESTAMPTZ;

-- 2. Receipt confirmation columns (SVC-08)
ALTER TABLE accom_service_orders
  ADD COLUMN IF NOT EXISTS receipt_confirmed_at TIMESTAMPTZ,
  ADD COLUMN IF NOT EXISTS receipt_auto_confirm_at TIMESTAMPTZ;

-- 3. Property-level receipt settings (SVC-08)
ALTER TABLE accom_properties
  ADD COLUMN IF NOT EXISTS receipt_enabled BOOLEAN NOT NULL DEFAULT false,
  ADD COLUMN IF NOT EXISTS receipt_auto_confirm_hours INTEGER NOT NULL DEFAULT 24;

-- 4. Index for performance queries (filter by property + delivery window)
CREATE INDEX IF NOT EXISTS idx_accom_service_orders_perf
  ON accom_service_orders(property_id, delivered_at)
  WHERE delivered_at IS NOT NULL;

-- 5. Comments
COMMENT ON COLUMN accom_service_orders.confirmed_at IS 'Timestamp when order was confirmed by owner';
COMMENT ON COLUMN accom_service_orders.preparing_at IS 'Timestamp when order preparation started';
COMMENT ON COLUMN accom_service_orders.ready_at IS 'Timestamp when order was marked ready';
COMMENT ON COLUMN accom_service_orders.delivered_at IS 'Timestamp when order was delivered to guest';
COMMENT ON COLUMN accom_service_orders.receipt_confirmed_at IS 'Timestamp when guest confirmed receipt of order';
COMMENT ON COLUMN accom_service_orders.receipt_auto_confirm_at IS 'Scheduled auto-confirm time for receipt (delivery + timeout)';
COMMENT ON COLUMN accom_properties.receipt_enabled IS 'Whether guest receipt confirmation is enabled for this property';
COMMENT ON COLUMN accom_properties.receipt_auto_confirm_hours IS 'Hours after delivery before receipt auto-confirms (default 24)';
```

Apply via `mcp__supabase__apply_migration` with name `order_performance_receipts`. Save locally to `shared/database/migrations/schema/101-order-performance-receipts.sql`.

**helpers.ts — Add timestamp column mapping:**

After the existing `ORDER_ACTION_TO_STATUS` mapping (line ~93), add:

```typescript
/** Maps order status to the timestamp column that should be set on transition */
export const STATUS_TIMESTAMP_COLUMN: Record<string, string> = {
  confirmed: 'confirmed_at',
  preparing: 'preparing_at',
  ready: 'ready_at',
  delivered: 'delivered_at',
};
```

**orders/[id]/route.ts — Record timestamps on PATCH:**

1. Add import: `import { ..., STATUS_TIMESTAMP_COLUMN } from '@/lib/accommodations/helpers';`

2. Expand the initial fetch (currently line ~133-137) from `.select('status')` to `.select('status, property_id')`.

3. After the `update` object is built (line ~159-162), add timestamp recording:

```typescript
const timestampCol = STATUS_TIMESTAMP_COLUMN[newStatus];
if (timestampCol) {
  update[timestampCol] = new Date().toISOString();
}
```

4. When status becomes 'delivered', also set `receipt_auto_confirm_at` if property has receipts enabled. Add this block after the timestamp recording:

```typescript
if (newStatus === 'delivered') {
  const { data: propData } = await supabaseAdmin
    .from('accom_properties')
    .select('receipt_enabled, receipt_auto_confirm_hours')
    .eq('id', current.property_id)
    .single();

  if (propData?.receipt_enabled) {
    const autoConfirmAt = new Date();
    autoConfirmAt.setHours(
      autoConfirmAt.getHours() + (propData.receipt_auto_confirm_hours || 24)
    );
    update.receipt_auto_confirm_at = autoConfirmAt.toISOString();
  }
}
```

5. In the GET handler, add new timestamp columns to the SELECT string (currently line ~22-31):
   Add after `property_id,`: `confirmed_at, preparing_at, ready_at, delivered_at, receipt_confirmed_at, receipt_auto_confirm_at,`

6. Map them in the response object (after `propertyId: data.property_id,`):

```typescript
confirmedAt: data.confirmed_at,
preparingAt: data.preparing_at,
readyAt: data.ready_at,
deliveredAt: data.delivered_at,
receiptConfirmedAt: data.receipt_confirmed_at,
receiptAutoConfirmAt: data.receipt_auto_confirm_at,
```

  </action>
  <verify>
  Verify migration columns: `mcp__supabase__execute_sql` with `SELECT column_name FROM information_schema.columns WHERE table_name = 'accom_service_orders' AND column_name IN ('confirmed_at', 'preparing_at', 'ready_at', 'delivered_at', 'receipt_confirmed_at', 'receipt_auto_confirm_at') ORDER BY column_name;` should return 6 rows.
  Verify property columns: `mcp__supabase__execute_sql` with `SELECT column_name FROM information_schema.columns WHERE table_name = 'accom_properties' AND column_name IN ('receipt_enabled', 'receipt_auto_confirm_hours');` should return 2 rows.
  Verify index: `mcp__supabase__execute_sql` with `SELECT indexname FROM pg_indexes WHERE tablename = 'accom_service_orders' AND indexname = 'idx_accom_service_orders_perf';` should return 1 row.
  TypeScript: `cd apps/backoffice && npx tsc --noEmit --pretty 2>&1 | head -30`
  Verify STATUS_TIMESTAMP_COLUMN: `grep 'STATUS_TIMESTAMP_COLUMN' apps/backoffice/lib/accommodations/helpers.ts`
  Verify timestamp recording: `grep 'timestampCol\|confirmed_at\|delivered_at' apps/backoffice/app/api/accommodations/orders/\[id\]/route.ts`
  </verify>
  <done>
  Migration 101 applied. Order status transitions record per-status timestamps. Delivered orders set receipt_auto_confirm_at when property has receipt_enabled.
  </done>
</task>

<task type="auto">
  <name>Task 2: Order performance analytics API + counters panel</name>
  <files>
    apps/backoffice/app/api/accommodations/analytics/order-performance/route.ts
    apps/backoffice/components/accommodations/OrderPerformancePanel.tsx
    apps/backoffice/components/accommodations/AccommodationAnalytics.tsx
  </files>
  <action>
**API endpoint: `order-performance/route.ts` (NEW)**

GET handler: `/api/accommodations/analytics/order-performance?propertyId=X&days=30`

Auth: Use `validateAdminApiKey(request)` from `@/lib/accommodations/helpers` (same pattern as kpis/route.ts).

Returns:

```typescript
{
  avgFulfillmentMinutes: number | null; // from created_at to delivered_at
  totalDelivered: number;
  totalCancelled: number;
  totalPending: number;
  byCategory: {
    category: string; // category_tag value
    avgMinutes: number | null;
    count: number;
  }
  [];
}
```

Implementation approach:

1. Authenticate with `validateAdminApiKey(request)`
2. Parse `propertyId` and `days` from searchParams (same pattern as kpis/route.ts)
3. Query `accom_service_orders` with a join to `accom_service_order_items` to get `category_tag`:

```typescript
const { data: orders } = await supabaseAdmin
  .from('accom_service_orders')
  .select(
    `
    id, status, created_at, delivered_at,
    items:accom_service_order_items(category_tag)
  `
  )
  .eq('property_id', propertyId)
  .gte('created_at', startStr)
  .lte('created_at', endStr);
```

4. For each order, determine primary category by majority vote of item `category_tag` values (same as `primaryCategoryTag()` in the guest PWA — pick most frequent tag, default 'general').
5. Compute metrics in JS:
   - `avgFulfillmentMinutes`: average of `(delivered_at - created_at)` in minutes for delivered orders
   - `totalDelivered/Cancelled/Pending`: count by status
   - `byCategory`: group delivered orders by their primary category_tag, compute avg minutes and count per group
6. Return JSON

**OrderPerformancePanel.tsx (NEW)**

Props:

```typescript
interface OrderPerformancePanelProps {
  propertyId: string;
  days: number;
}
```

Layout:

- Top: 4 counter cards in a 2x2 grid (Avg Fulfillment Time, Total Delivered, Total Cancelled, Pending Now)
- Bottom: Table with category breakdown (Category | Avg Time | Orders)
- Section icon: `Clock` from `@phosphor-icons/react` weight `duotone`
- Show "Not enough data" message when totalDelivered < 3
- Format time: if < 60 min show "X min", if >= 60 show "Xh Ym"
- Empty state: "Order performance metrics will appear once orders are delivered."
- Uses `fetch('/api/accommodations/analytics/order-performance?propertyId=...&days=...')` with Bearer ADMIN_API_KEY from the same pattern used by other analytics components (check AccommodationAnalytics.tsx for how it passes the API key)

**AccommodationAnalytics.tsx — Wire in OrderPerformancePanel:**

Import OrderPerformancePanel. Render it as a standalone section after the main analytics block, always visible when propertyId is set (it has its own loading/empty state):

```tsx
{
  /* Order Performance — always shown, has own loading/empty state */
}
<OrderPerformancePanel propertyId={propertyId} days={selectedDays} />;
```

Place it after the revenue breakdown section but before the closing container div.
</action>
<verify>
TypeScript compilation: `cd apps/backoffice && npx tsc --noEmit --pretty 2>&1 | head -30`
Verify API endpoint: `ls apps/backoffice/app/api/accommodations/analytics/order-performance/route.ts`
Verify panel component: `ls apps/backoffice/components/accommodations/OrderPerformancePanel.tsx`
Verify wired into analytics: `grep 'OrderPerformancePanel' apps/backoffice/components/accommodations/AccommodationAnalytics.tsx`
Verify counters (not charts): `grep -c 'LineChart\|BarChart\|Recharts' apps/backoffice/components/accommodations/OrderPerformancePanel.tsx` should return 0
</verify>
<done>
Order performance API returns avg fulfillment time segmented by category. OrderPerformancePanel shows counters and category table. Wired into AccommodationAnalytics page.
</done>
</task>

</tasks>

<verification>
1. `cd apps/backoffice && npx tsc --noEmit` -- zero errors
2. Migration 101 applied: 4 timestamp columns + 2 receipt columns on orders, 2 receipt settings on properties
3. Order PATCH records per-status timestamps (confirmed_at, preparing_at, ready_at, delivered_at)
4. Delivered orders set receipt_auto_confirm_at when property has receipt_enabled=true
5. Order performance API returns avg fulfillment time segmented by category
6. OrderPerformancePanel shows counters (NOT charts) with category table
</verification>

<success_criteria>

- Order status transitions record timestamps in confirmed_at/preparing_at/ready_at/delivered_at columns
- Backoffice analytics shows avg order-to-delivery time with counters segmented by category (not charts)
- TypeScript compiles for backoffice
  </success_criteria>

<output>
After completion, create `.planning/phases/39-polish-analytics/39-01-SUMMARY.md`
</output>
