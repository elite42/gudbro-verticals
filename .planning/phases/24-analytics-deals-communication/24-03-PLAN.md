---
phase: 24-analytics-deals-communication
plan: 03
type: execute
wave: 2
depends_on: ['24-01']
files_modified:
  - apps/accommodations/frontend/lib/email-templates.ts
  - apps/accommodations/frontend/app/api/email/booking-confirmation/route.ts
  - apps/accommodations/frontend/app/api/cron/pre-arrival-emails/route.ts
  - apps/accommodations/frontend/app/api/booking/route.ts
  - apps/accommodations/frontend/components/stay/ContactSheet.tsx
  - apps/accommodations/frontend/components/property/PropertyPage.tsx
  - apps/accommodations/frontend/vercel.json
autonomous: true

must_haves:
  truths:
    - 'Guest receives booking confirmation email with booking code, property name, dates, and price'
    - 'Guest receives pre-arrival email 1 day before check-in with QR code for In-Stay Dashboard'
    - 'Guest can contact host via WhatsApp deep-link from property page'
    - 'Guest can contact host via WhatsApp deep-link from In-Stay Dashboard'
    - 'Owner sees WhatsApp notification links for bookings, inquiries, and service orders in dashboard'
  artifacts:
    - path: 'apps/accommodations/frontend/lib/email-templates.ts'
      provides: 'HTML email templates for booking confirmation and pre-arrival'
      exports: ['buildBookingConfirmationHtml', 'buildPreArrivalHtml']
    - path: 'apps/accommodations/frontend/app/api/email/booking-confirmation/route.ts'
      provides: 'Send booking confirmation email endpoint'
      exports: ['POST']
    - path: 'apps/accommodations/frontend/app/api/cron/pre-arrival-emails/route.ts'
      provides: 'Cron endpoint for pre-arrival emails'
      exports: ['GET']
  key_links:
    - from: 'booking/route.ts'
      to: 'email/booking-confirmation/route.ts'
      via: 'fetch call after booking creation'
      pattern: 'email/booking-confirmation'
    - from: 'cron/pre-arrival-emails/route.ts'
      to: 'accom_email_logs'
      via: 'supabase insert for logging'
      pattern: 'accom_email_logs'
    - from: 'PropertyPage.tsx'
      to: 'wa.me'
      via: 'WhatsApp deep-link'
      pattern: "wa\\.me"
---

<objective>
Implement transactional email communication (booking confirmation + pre-arrival with QR code) and ensure WhatsApp deep-links are present on both the property page and In-Stay Dashboard.

Purpose: Email communication drives In-Stay Dashboard adoption (pre-arrival QR is the key touchpoint) and gives guests essential booking information. WhatsApp deep-links enable direct host-guest communication without complex messaging infrastructure.
Output: Email templates, booking confirmation trigger, pre-arrival cron job, WhatsApp deep-links on property page.
</objective>

<execution_context>
@/Users/gianfrancodagostino/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gianfrancodagostino/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/24-analytics-deals-communication/24-CONTEXT.md
@.planning/phases/24-analytics-deals-communication/24-RESEARCH.md
@.planning/phases/24-analytics-deals-communication/24-01-SUMMARY.md

Key references:

- @apps/backoffice/lib/notifications/providers/email-provider.ts (existing email sending pattern with Resend)
- @apps/accommodations/frontend/components/stay/ContactSheet.tsx (existing WhatsApp deep-link pattern)
- @apps/accommodations/frontend/components/booking/BookingConfirmation.tsx (existing WhatsApp pattern)
- @apps/accommodations/frontend/app/api/booking/route.ts (booking creation to add email trigger)
- @apps/backoffice/lib/qr-generator.ts (QR code generation pattern)
  </context>

<tasks>

<task type="auto">
  <name>Task 1: Email templates + booking confirmation trigger</name>
  <files>
    apps/accommodations/frontend/lib/email-templates.ts
    apps/accommodations/frontend/app/api/email/booking-confirmation/route.ts
    apps/accommodations/frontend/app/api/booking/route.ts
  </files>
  <action>
    1. Create email-templates.ts with two HTML template functions:

       a. buildBookingConfirmationHtml(data): generates mobile-responsive HTML email with:
          - Header: property brand color background, "Booking Confirmed" title, booking code in large text
          - Content rows: property name, check-in/check-out dates, room type, number of guests
          - Price breakdown: per-night rate x nights, cleaning fee, discounts, total
          - Payment status (confirmed/pending)
          - Property address with Google Maps link (https://maps.google.com/?q=lat,lng)
          - Host WhatsApp link button (wa.me/number?text=...)
          - Footer: "Powered by GUDBRO" subtle text
          - Params: { bookingCode, propertyName, checkIn, checkOut, roomType, guests, pricePerNight, nights, cleaningFee, discount, totalPrice, currency, paymentStatus, propertyAddress, lat, lng, hostPhone, hostName, brandColor }

       b. buildPreArrivalHtml(data): generates mobile-responsive HTML email with:
          - Header: property brand color, "Your Stay Starts Tomorrow" title
          - QR code image (base64 data URL) linking to stay dashboard
          - Check-in time, property directions/address
          - WiFi info if available (network name, password)
          - Host WhatsApp contact button
          - "Scan this QR code on arrival to access your In-Stay Dashboard"
          - Params: { propertyName, checkInTime, qrDataUrl, propertyAddress, wifiName, wifiPassword, hostPhone, hostName, brandColor }

       Both templates: use inline CSS only (email client compatibility), -apple-system font stack, max-width 600px centered, white card on light gray background.

    2. Create POST /api/email/booking-confirmation/route.ts:
       - Accept body: { bookingId }
       - Fetch booking + property + room data from Supabase
       - Build email HTML using buildBookingConfirmationHtml
       - Build plain text fallback
       - Send via Resend API (use RESEND_API_KEY env var, POST https://api.resend.com/emails)
       - Log result to accom_email_logs (email_type='booking_confirmation', status='sent'|'failed')
       - Return { success, messageId } or { error }
       - If email send fails, log error but return 200 (email is enhancement, not gate)

    3. Update booking/route.ts (POST handler):
       - After successful booking creation, fire-and-forget call to /api/email/booking-confirmation
       - Use internal fetch: fetch(`${process.env.NEXT_PUBLIC_BASE_URL || ''}/api/email/booking-confirmation`, { method: 'POST', body: JSON.stringify({ bookingId }), headers: { 'Content-Type': 'application/json' } })
       - Wrap in try/catch -- booking success is NOT dependent on email success
       - Do NOT await the email call if possible (or await but ignore errors)

  </action>
  <verify>
    - `cd apps/accommodations/frontend && npx tsc --noEmit` passes
    - email-templates.ts exports both template functions
    - booking-confirmation route exports POST
    - booking route has email trigger (grep for 'email/booking-confirmation')
  </verify>
  <done>Booking confirmation email is sent automatically after booking creation. Email contains booking code, property details, dates, price breakdown, map link, and WhatsApp contact. Failures are logged but do not block the booking flow.</done>
</task>

<task type="auto">
  <name>Task 2: Pre-arrival cron + WhatsApp deep-links</name>
  <files>
    apps/accommodations/frontend/app/api/cron/pre-arrival-emails/route.ts
    apps/accommodations/frontend/components/stay/ContactSheet.tsx
    apps/accommodations/frontend/components/property/PropertyPage.tsx
    apps/accommodations/frontend/vercel.json
  </files>
  <action>
    1. Create GET /api/cron/pre-arrival-emails/route.ts:
       - Verify cron secret: check Authorization header matches CRON_SECRET env var (Vercel Cron sends this)
       - Query bookings where check_in_date = CURRENT_DATE + INTERVAL '1 day' (tomorrow's check-ins)
       - Filter: status IN ('confirmed'), AND no existing accom_email_logs entry with email_type='pre_arrival' for this booking
       - For each booking:
         a. Generate QR code data URL using 'qrcode' library: QRCode.toDataURL(`https://stays.gudbro.com/stay/${bookingCode}`, { width: 200, margin: 2 })
         b. Fetch property details (name, address, check-in time, wifi, host phone, brand color)
         c. Build HTML using buildPreArrivalHtml
         d. Send via Resend API
         e. Log to accom_email_logs (email_type='pre_arrival', status='sent'|'failed')
       - Return { processed: N, sent: N, failed: N }
       - Handle empty result gracefully (no bookings tomorrow = success with processed: 0)

    2. Create/update vercel.json in apps/accommodations/frontend/:
       - Add cron configuration:
         ```json
         { "crons": [{ "path": "/api/cron/pre-arrival-emails", "schedule": "0 8 * * *" }] }
         ```
       - If vercel.json already exists, merge the crons array

    3. Verify/update ContactSheet.tsx (In-Stay Dashboard WhatsApp):
       - Confirm WhatsApp deep-link exists with pre-filled message including guest name and room
       - If not already present, add: `https://wa.me/${hostPhone}?text=${encodeURIComponent(`Hi, I'm ${guestName} staying in ${roomType}...`)}`
       - This component already has WhatsApp -- verify it works with current data shape

    4. Verify/update PropertyPage.tsx (public property page WhatsApp):
       - Add "Contact Host" button/link with WhatsApp deep-link if host phone is available
       - Pre-filled message: "Hi, I'm interested in staying at [PropertyName]"
       - Position: near the bottom of property info, before or after the booking form
       - Use Phosphor WhatsappLogo icon
       - Only show if property has a contact phone number
       - If PropertyPage.tsx doesn't exist as a single file, find the correct component (could be the SSR page or a client component) and add the WhatsApp link there

  </action>
  <verify>
    - `cd apps/accommodations/frontend && npx tsc --noEmit` passes
    - Pre-arrival cron route exports GET
    - vercel.json contains cron schedule
    - WhatsApp deep-links present in ContactSheet and property page component
    - grep for 'wa.me' finds links in both guest touchpoints
  </verify>
  <done>Pre-arrival emails with QR codes are sent daily via Vercel Cron to guests checking in tomorrow. WhatsApp deep-links are available on both the property page ("Contact Host") and In-Stay Dashboard ("Chat with Host"). COMM-01, COMM-02, COMM-03, COMM-04 complete.</done>
</task>

</tasks>

<verification>
- `cd apps/accommodations/frontend && npx tsc --noEmit` passes
- Email templates generate valid HTML strings
- Booking creation triggers confirmation email (fire-and-forget)
- Pre-arrival cron processes tomorrow's check-ins
- accom_email_logs tracks all email attempts
- WhatsApp deep-links on property page and In-Stay Dashboard
- vercel.json has cron configuration
</verification>

<success_criteria>

- COMM-01: Guest can contact host via WhatsApp deep-link from property page and In-Stay Dashboard
- COMM-02: Owner receives WhatsApp notifications via deep-link URLs in dashboard (already implemented in Phase 21/23, verify present)
- COMM-03: Guest receives booking confirmation email with booking code and property details
- COMM-04: Guest receives pre-arrival email with QR code 1 day before check-in
  </success_criteria>

<output>
After completion, create `.planning/phases/24-analytics-deals-communication/24-03-SUMMARY.md`
</output>
