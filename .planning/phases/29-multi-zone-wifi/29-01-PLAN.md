---
phase: 29-multi-zone-wifi
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - shared/database/migrations/schema/092-multi-zone-wifi.sql
  - apps/backoffice/app/(dashboard)/accommodations/settings/page.tsx
  - apps/backoffice/app/api/accommodations/property/route.ts
  - apps/backoffice/app/api/accommodations/rooms/route.ts
autonomous: true

must_haves:
  truths:
    - 'wifi_zones JSONB column exists on accom_properties with CHECK constraint (array type, max 8)'
    - 'wifi_ssid_override and wifi_password_override nullable columns exist on accom_rooms'
    - 'Existing wifi_network data is migrated into wifi_zones as first zone entry'
    - 'Owner can add, edit, remove, and reorder WiFi zones in the backoffice settings page'
    - 'Owner can set room-specific WiFi override fields when editing a room'
    - 'Backoffice property API GET returns wifi_zones, PUT accepts wifi_zones'
    - 'Backoffice rooms API GET returns wifi override fields, PUT/POST accepts them'
  artifacts:
    - path: 'shared/database/migrations/schema/092-multi-zone-wifi.sql'
      provides: 'wifi_zones column, room override columns, data migration, CHECK constraint'
      contains: 'wifi_zones'
    - path: 'apps/backoffice/app/(dashboard)/accommodations/settings/page.tsx'
      provides: 'WiFi zone management UI section'
      contains: 'wifiZones'
    - path: 'apps/backoffice/app/api/accommodations/property/route.ts'
      provides: 'wifi_zones in property CRUD'
      contains: 'wifi_zones'
    - path: 'apps/backoffice/app/api/accommodations/rooms/route.ts'
      provides: 'wifi override fields in rooms CRUD'
      contains: 'wifi_ssid_override'
  key_links:
    - from: 'apps/backoffice/app/(dashboard)/accommodations/settings/page.tsx'
      to: '/api/accommodations/property'
      via: 'fetch to save wifi_zones array'
      pattern: 'wifi_zones'
    - from: 'shared/database/migrations/schema/092-multi-zone-wifi.sql'
      to: 'accom_properties'
      via: 'ALTER TABLE ADD COLUMN wifi_zones JSONB'
      pattern: 'wifi_zones.*JSONB'
---

<objective>
Create the multi-zone WiFi database schema and backoffice management UI.

Purpose: Enable property owners to configure multiple WiFi networks organized by zone (room, restaurant, pool, lobby, etc.) and set room-specific WiFi overrides. This is the data foundation that the guest-facing plan (29-02) builds on.
Output: Migration 092, updated backoffice settings page with WiFi zone management, updated backoffice property and rooms API routes.
</objective>

<execution_context>
@/Users/gianfrancodagostino/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gianfrancodagostino/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/29-multi-zone-wifi/29-RESEARCH.md
@.planning/phases/29-multi-zone-wifi/29-CONTEXT.md

Key source files to read before implementing:
@apps/backoffice/app/(dashboard)/accommodations/settings/page.tsx
@apps/backoffice/app/api/accommodations/property/route.ts
@apps/backoffice/app/api/accommodations/rooms/route.ts
@shared/database/migrations/schema/091-guest-documents.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migration 092 â€” wifi_zones JSONB + room WiFi overrides</name>
  <files>shared/database/migrations/schema/092-multi-zone-wifi.sql</files>
  <action>
Create migration 092 with these operations:

1. Add `wifi_zones JSONB DEFAULT NULL` column to `accom_properties`
2. Add CHECK constraint `wifi_zones_valid`:
   - wifi_zones IS NULL OR (jsonb_typeof(wifi_zones) = 'array' AND jsonb_array_length(wifi_zones) <= 8)
3. Add `wifi_ssid_override TEXT` (nullable) to `accom_rooms`
4. Add `wifi_password_override TEXT` (nullable) to `accom_rooms`
5. Data migration: UPDATE accom_properties SET wifi_zones = jsonb_build_array(...) WHERE wifi_network IS NOT NULL AND wifi_network != ''
   - The zone entry: zone_id = gen_random_uuid()::TEXT, label = 'Property WiFi', zone_type = 'room', icon = 'WifiHigh', ssid = wifi_network, password = COALESCE(wifi_password, ''), sort_order = 0
6. Add COMMENT ON COLUMN for all 3 new columns

Use IF NOT EXISTS for ADD COLUMN. Do NOT drop the legacy wifi_network/wifi_password columns.

Reference the exact SQL from the research document's "Code Examples > Migration 092" section.
</action>
<verify>Review SQL syntax. Verify CHECK constraint covers NULL case. Verify data migration is conditional on wifi_network being non-null.</verify>
<done>Migration file exists with wifi_zones column, CHECK constraint, room override columns, and conditional data migration from legacy columns.</done>
</task>

<task type="auto">
  <name>Task 2: Backoffice WiFi zone management + API updates</name>
  <files>
    apps/backoffice/app/(dashboard)/accommodations/settings/page.tsx
    apps/backoffice/app/api/accommodations/property/route.ts
    apps/backoffice/app/api/accommodations/rooms/route.ts
  </files>
  <action>
**Property API route** (`apps/backoffice/app/api/accommodations/property/route.ts`):
- GET handler: Add `wifi_zones` to the SELECT columns list
- PUT handler: Add `wifi_zones` to the allowedFields array so it can be saved

**Rooms API route** (`apps/backoffice/app/api/accommodations/rooms/route.ts`):

- GET handler: Add `wifi_ssid_override, wifi_password_override` to SELECT
- PUT handler: Add `wifi_ssid_override, wifi_password_override` to allowedFields
- POST handler: Include wifi_ssid_override, wifi_password_override as optional fields in the insert

**Settings page** (`apps/backoffice/app/(dashboard)/accommodations/settings/page.tsx`):
Read the existing page first. Follow its exact patterns (individual useState, fetch on mount, save via PUT).

Add a new "WiFi Zones" section/card (after the existing WiFi section or replacing it). The section should:

1. State: `useState<WifiZone[]>([])` with the WifiZone interface: { zone_id: string, label: string, zone_type: string, icon: string, ssid: string, password: string, sort_order: number }
2. Load wifi_zones from the property GET response and populate state
3. Display a list of zone rows, each containing:
   - Zone type selector: `<select>` with predefined options (room/Bed, restaurant/ForkKnife, pool/SwimmingPool, lobby/Buildings, garden/Tree, rooftop/CloudSun, coworking/Laptop, custom/WifiHigh). When zone_type changes, auto-update the icon field.
   - Label input (text, pre-filled based on zone_type but editable for custom labels)
   - SSID input (text, required)
   - Password input (text with show/hide toggle)
   - Up/Down arrow buttons for reordering (ArrowUp, ArrowDown from Phosphor Icons)
   - Remove button (Trash from Phosphor Icons)
4. "Add WiFi Zone" button (disabled if 8 zones exist)
5. When adding a zone: generate zone_id via crypto.randomUUID(), set zone_type to 'custom', icon to 'WifiHigh', sort_order to current length
6. On save: include wifiZones in the PUT payload as wifi_zones (serialize the array)
7. Validation: each zone must have ssid filled. Show inline error if empty on save attempt.

For the zone type selector, map labels like: room -> "Room", restaurant -> "Restaurant", pool -> "Pool", lobby -> "Lobby", garden -> "Garden", rooftop -> "Rooftop", coworking -> "Coworking", custom -> "Other"

Also: The rooms edit form/modal (if it exists in the settings page or a separate rooms management page) should show 2 optional fields: "WiFi SSID Override" and "WiFi Password Override". Read the rooms management page to find where room editing happens and add these fields there.

Use Phosphor Icons (WifiHigh, ArrowUp, ArrowDown, Trash, Eye, EyeSlash) for all icons in this section.
</action>
<verify>
Run `npx tsc --noEmit` from the backoffice app to verify no TypeScript errors. Visually confirm: the settings page loads without crashing, WiFi zones section renders, API routes include the new fields in their SELECT/allowedFields.
</verify>
<done>
Owner can see, add, edit, remove, and reorder WiFi zones in the backoffice settings page. Property API returns and accepts wifi_zones. Rooms API returns and accepts wifi override fields. Save persists zones to database as JSONB.
</done>
</task>

</tasks>

<verification>
1. Migration 092 SQL is syntactically valid and idempotent (IF NOT EXISTS)
2. Backoffice settings page renders WiFi Zones section without errors
3. Property GET returns wifi_zones field, PUT accepts and saves it
4. Rooms GET returns wifi_ssid_override/wifi_password_override, PUT/POST accepts them
5. TypeScript compiles cleanly for the backoffice app
</verification>

<success_criteria>

- Migration 092 file exists with wifi_zones column, CHECK constraint, room override columns, data migration
- Backoffice settings page has a functional WiFi zone management section (add/edit/remove/reorder zones)
- Backoffice property and rooms API routes handle the new columns
- All existing settings page functionality remains intact (no regressions)
  </success_criteria>

<output>
After completion, create `.planning/phases/29-multi-zone-wifi/29-01-SUMMARY.md`
</output>
