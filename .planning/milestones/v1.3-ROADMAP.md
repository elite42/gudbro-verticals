# Milestone v1.3: Merchant Feedback Intelligence

**Status:** ✅ SHIPPED 2026-01-30
**Phases:** 13-17
**Total Plans:** 10

## Overview

Merchants submit feedback in any language from the backoffice; AI translates, classifies, and groups similar submissions into tasks; admins manage tasks on a kanban board with full analytics visibility.

## Phases

### Phase 13: Foundation and AI Pipeline

**Goal**: The database and AI backbone exist so submissions can be stored, translated, classified, tagged, matched to similar tasks, and aggregated — all without any UI yet
**Depends on**: Nothing (first phase of v1.3)
**Plans**: 2 plans

Plans:

- [x] 13-01-PLAN.md — Database schema (fb_submissions, fb_tasks, fb_merchant_notifications + indexes + RLS + similarity function)
- [x] 13-02-PLAN.md — AI processing service (translate, classify, tag, similarity detection, task aggregation + API route)

**Details:**

- Migration 082: fb_submissions, fb_tasks, fb_merchant_notifications tables
- pg_trgm extension for trigram similarity matching
- find_similar_tasks RPC with CTE-based scoring
- update_task_metrics trigger for denormalized counts
- RLS policies for account-based access
- OpenAI GPT-4o-mini single-call pipeline: translate → classify → tag → deduplicate
- Defensive JSON parsing with canonical tag validation

### Phase 14: Merchant Submission UI

**Goal**: Merchants can submit feedback from the backoffice in any language with screenshots and see their submission history
**Depends on**: Phase 13
**Plans**: 2 plans

Plans:

- [x] 14-01-PLAN.md — Feedback submission form (API route, upload config, page shell, form component with type selector, title, description, screenshot upload, context auto-capture)
- [x] 14-02-PLAN.md — Submission history list (history API route, history list with type/status badges, expandable detail view)

**Details:**

- Settings page at /settings/feedback
- FeedbackSubmissionManager component with Phosphor icons type selector
- Screenshot upload via existing image upload infrastructure
- Auto-context capture (vertical, module/page, merchant ID)
- Accordion-style history with colored type/status badges

### Phase 15: Merchant Notifications

**Goal**: Merchants receive and manage in-app notifications about their feedback status changes
**Depends on**: Phase 14
**Plans**: 2 plans

Plans:

- [x] 15-01-PLAN.md — Notification API routes, createFeedbackNotification utility, submit route account_id fix, AI service notification creation
- [x] 15-02-PLAN.md — useNotifications polling hook and NotificationDropdown wired to real API data

**Details:**

- GET/PATCH /api/feedback/notifications endpoints
- createFeedbackNotification utility (fire-and-forget pattern)
- notifyTaskStatusChange for kanban status changes
- useNotifications hook with 60s polling and optimistic mark-as-read
- NotificationDropdown with type-appropriate icons and visual dismiss

### Phase 16: Admin Kanban

**Goal**: Admins can manage feedback-derived tasks on a kanban board, view all linked submissions, and trigger merchant notifications on status changes
**Depends on**: Phase 15
**Plans**: 2 plans

Plans:

- [x] 16-01-PLAN.md — API routes (GET all tasks, GET single task, GET submissions, PATCH status with notification triggers) + kanban board with @dnd-kit drag-and-drop, columns, and task cards
- [x] 16-02-PLAN.md — Task detail slide-over panel with linked submissions, Radix status change confirmation dialog, full board integration

**Details:**

- 4 API routes for task CRUD and submissions
- KanbanBoard with 5 columns (New, Reviewing, In Progress, Done, Rejected)
- @dnd-kit with closestCorners collision detection
- TaskCard showing merchant count, languages, sentiment, priority
- TaskDetailPanel slide-over with linked submissions (original + translated)
- StatusChangeDialog (Radix) for terminal status confirmation

### Phase 17: Analytics Dashboard

**Goal**: Admins can view analytics about feedback volume, distribution, popular requests, and team response performance
**Depends on**: Phase 16
**Plans**: 2 plans

Plans:

- [x] 17-01-PLAN.md — Analytics API routes (volume time-series + summary with type/vertical breakdown, top features, response times)
- [x] 17-02-PLAN.md — Analytics dashboard page with Recharts charts, KPI cards, time range selector, and sidebar navigation

**Details:**

- Volume API: daily submission counts with date gap filling (date-fns eachDayOfInterval)
- Summary API: type/vertical breakdown, top features ranked by submission count, response time metrics
- JS-side aggregation (no Postgres RPC functions needed)
- Recharts LineChart (volume), BarChart (type/vertical breakdown)
- KPI MetricCard pattern with tooltip descriptions
- Time range selector (7d, 30d, 90d)
- Sidebar navigation entry at /platform/feedback-analytics

---

## Milestone Summary

**Key Decisions:**

- D-1301-1: Dedicated fb_merchant_notifications table (not reusing internal_notifications) — keeps feedback domain self-contained
- D-1301-2: CTE-based scoring in find_similar_tasks (fixed invalid HAVING pattern from research)
- D-1501-1: Fire-and-forget pattern for notification creation (never blocks main flow)
- D-1501-2: notifyTaskStatusChange designed for Phase 16 kanban handlers
- D-1502-1: merchantId derived from location?.id or brand?.id
- D-1502-2: Visual-only dismiss (filters from display, marks as read) instead of DELETE
- D-1601-1: closestCorners collision detection for multi-column kanban
- D-1602-1: Radix StatusChangeDialog replaces browser confirm()
- D-1701-1: JS-side aggregation instead of Postgres RPC functions
- D-1701-2: Two batched endpoints (volume + summary) to minimize API calls
- D-1702-1: Single AnalyticsDashboard client component
- D-1702-2: Recharts for charting (React-native, composable, SSR-safe)

**Issues Resolved:**

- None (clean milestone, no blockers encountered)

**Issues Deferred:**

- Semantic clustering via embeddings (pgvector) — deferred until >1000 submissions
- Public roadmap / voting — keep product direction team-driven
- GitHub issue sync — wait until dev workflow stabilizes
- Email notifications — future milestone

**Technical Debt Incurred:**

- None. All 5 phase verifications reported zero anti-patterns, zero stubs, zero TODOs.

---

_For current project status, see .planning/ROADMAP.md_
