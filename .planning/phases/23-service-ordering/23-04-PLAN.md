---
phase: 23-service-ordering
plan: 04
type: execute
wave: 3
depends_on: ['23-01', '23-02']
files_modified:
  - apps/backoffice/app/(dashboard)/accommodations/orders/page.tsx
  - apps/backoffice/app/api/accommodations/orders/route.ts
  - apps/backoffice/app/api/accommodations/orders/[id]/route.ts
  - apps/backoffice/components/accommodations/OrderManagement.tsx
  - apps/backoffice/components/accommodations/OrderStatusBadge.tsx
  - apps/backoffice/components/accommodations/OrderDetailPanel.tsx
  - apps/backoffice/components/layout/Sidebar.tsx
autonomous: true

must_haves:
  truths:
    - 'Owner can view filterable list of all service orders'
    - 'Owner can confirm, start preparing, mark ready, deliver, or reject orders'
    - 'Status transitions are validated server-side via state machine'
    - 'Owner sees WhatsApp deep-link for each order'
    - 'Sidebar has Services and Orders navigation entries under Accommodations'
    - 'Order detail shows guest info, room, items, timestamps'
  artifacts:
    - path: 'apps/backoffice/app/(dashboard)/accommodations/orders/page.tsx'
      provides: 'Order management page'
      min_lines: 20
    - path: 'apps/backoffice/app/api/accommodations/orders/route.ts'
      provides: 'Orders list API'
      exports: ['GET']
    - path: 'apps/backoffice/app/api/accommodations/orders/[id]/route.ts'
      provides: 'Order detail + status update API'
      exports: ['GET', 'PATCH']
    - path: 'apps/backoffice/components/accommodations/OrderManagement.tsx'
      provides: 'Order table with filters and action buttons'
      min_lines: 100
    - path: 'apps/backoffice/components/accommodations/OrderStatusBadge.tsx'
      provides: 'Colored status badge for orders'
      contains: 'ORDER_STATUS_COLORS'
  key_links:
    - from: 'apps/backoffice/app/api/accommodations/orders/[id]/route.ts'
      to: 'ORDER_VALID_TRANSITIONS'
      via: 'Server-side transition validation'
      pattern: 'isValidOrderTransition|ORDER_VALID_TRANSITIONS'
    - from: 'apps/backoffice/components/accommodations/OrderManagement.tsx'
      to: '/api/accommodations/orders'
      via: 'Fetch orders and actions'
      pattern: 'fetch.*api/accommodations/orders'
    - from: 'apps/backoffice/components/layout/Sidebar.tsx'
      to: '/accommodations/services'
      via: 'Navigation entry'
      pattern: 'accommodations/services|accommodations/orders'
---

<objective>
Build the owner-facing order management page and add sidebar navigation for Services and Orders.

Purpose: Owners need to manage incoming service orders (confirm, prepare, deliver, reject) and navigate to the new services/orders pages from the sidebar.
Output: Order management page with filterable table, status actions with state machine validation, WhatsApp links, and updated sidebar navigation.
</objective>

<execution_context>
@/Users/gianfrancodagostino/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gianfrancodagostino/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-service-ordering/23-RESEARCH.md
@.planning/phases/23-service-ordering/23-01-SUMMARY.md
@.planning/phases/23-service-ordering/23-02-SUMMARY.md

@apps/backoffice/lib/accommodations/helpers.ts
@apps/backoffice/components/accommodations/BookingStatusBadge.tsx
@apps/backoffice/app/api/accommodations/bookings/[id]/route.ts
@apps/backoffice/app/(dashboard)/accommodations/bookings/page.tsx
@apps/backoffice/components/layout/Sidebar.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Order API routes (list + detail + status update)</name>
  <files>
    apps/backoffice/app/api/accommodations/orders/route.ts
    apps/backoffice/app/api/accommodations/orders/[id]/route.ts
  </files>
  <action>
    1. Create apps/backoffice/app/api/accommodations/orders/route.ts:

       **GET handler** (list orders):
       - Call `validateAdminApiKey(request)` for auth
       - Get query params: propertyId (required), status (optional filter), search (optional), page, limit
       - Query `accom_service_orders` WHERE property_id = propertyId
       - Join: accom_service_order_items for item count, accom_bookings for guest_name and room info
       - If status filter: WHERE status = filter (support comma-separated for multiple: "pending,confirmed")
       - If search: filter by guest name or order id (ILIKE)
       - Order by created_at DESC
       - Paginate: offset = (page-1)*limit, default limit=20
       - Map to camelCase response
       - Return: `{ orders: [...], total: number, page: number, limit: number }`
       - Each order includes: id, status, guestName, roomNumber, itemCount, subtotal, total, currency, requestedTime, createdAt, updatedAt

    2. Create apps/backoffice/app/api/accommodations/orders/[id]/route.ts:

       **GET handler** (order detail):
       - validateAdminApiKey
       - Query accom_service_orders WHERE id = orderId
       - Join accom_service_order_items (full list)
       - Join accom_bookings for guest info (guest_first_name, guest_last_name, guest_email, guest_phone)
       - Join accom_rooms for room number/name (via booking)
       - Map to camelCase
       - Return full order with items, guest info, room info

       **PATCH handler** (status action):
       - validateAdminApiKey
       - Parse body: `{ action: string; reason?: string; }` (action is from ORDER_ACTION_TO_STATUS keys)
       - Fetch current order status
       - Import and use `isValidOrderTransition(currentStatus, ORDER_ACTION_TO_STATUS[action])` from helpers.ts
       - If invalid transition: return 400 with `{ error: 'invalid_transition', currentStatus, requestedAction }`
       - Update status in DB
       - If action is 'reject' and reason provided: store reason in delivery_notes (or a dedicated field if available)
       - Update updated_at timestamp
       - Return updated order

    Pattern notes:
    - Follow existing bookings/[id]/route.ts for PATCH pattern
    - Use getSupabaseAdmin() for all queries
    - Always validate ownership via property_id before any mutation

  </action>
  <verify>
    - TypeScript compiles: `cd apps/backoffice && npx tsc --noEmit --pretty 2>&1 | head -20`
    - Files exist: `ls apps/backoffice/app/api/accommodations/orders/`
  </verify>
  <done>
    Orders list API with pagination and filters. Order detail API with full guest/room info. Status update API with server-side state machine validation.
  </done>
</task>

<task type="auto">
  <name>Task 2: Order management UI + status badge + sidebar nav</name>
  <files>
    apps/backoffice/components/accommodations/OrderStatusBadge.tsx
    apps/backoffice/components/accommodations/OrderDetailPanel.tsx
    apps/backoffice/components/accommodations/OrderManagement.tsx
    apps/backoffice/app/(dashboard)/accommodations/orders/page.tsx
    apps/backoffice/components/layout/Sidebar.tsx
  </files>
  <action>
    1. Create OrderStatusBadge.tsx:
       - Follow BookingStatusBadge pattern exactly
       - Props: `{ status: string; }`
       - Import ORDER_STATUS_COLORS, ORDER_STATUS_LABELS from lib/accommodations/helpers
       - Render: `<span className={colors}>{label}</span>` as pill badge

    2. Create OrderDetailPanel.tsx:
       - 'use client' component
       - Props: `{ orderId: string; onClose: () => void; onStatusUpdate: () => void; }`
       - Fetches full order detail from GET /api/accommodations/orders/[id]
       - Layout: slide-out panel from right (fixed, z-50, w-96 on desktop, full width on mobile)
         - Header: "Order #{id.slice(0,8)}" + close button
         - Guest info: name, email, phone (with click-to-call/email)
         - Room: number and name
         - Order info: status badge, requested time, created timestamp, delivery notes
         - Items table: name, qty, unit price, total per item
         - Order total
         - Action buttons (based on current status using ORDER_VALID_TRANSITIONS):
           - pending: "Confirm" (green) + "Reject" (red, with reason prompt)
           - confirmed: "Start Preparing" (blue)
           - preparing: "Mark Ready" (green)
           - ready: "Mark Delivered" (green)
           - delivered/cancelled: no actions (read-only)
         - WhatsApp link: buildWhatsAppUrl with pre-filled message about order
       - On action click: PATCH /api/accommodations/orders/[id] with action
       - Loading/error states
       - Backdrop overlay

    3. Create OrderManagement.tsx:
       - 'use client' component
       - Props: `{ propertyId: string; }`
       - State: orders, total, page, statusFilter, search, selectedOrderId, isLoading
       - Filters row:
         - Status filter tabs/pills: All, Active (pending+confirmed+preparing+ready), Completed (delivered), Cancelled
         - Search input (searches by guest name)
       - Orders table:
         - Columns: Order # (truncated id), Guest, Room, Items (count), Total, Status (badge), Time, Actions
         - Click row to open OrderDetailPanel
         - Inline quick actions: most relevant next action button per status (e.g., "Confirm" for pending)
       - Pagination: prev/next buttons with total count
       - Auto-refresh: poll every 30s for new orders (simple setInterval)
       - WhatsApp icon button per row to quickly message guest about order
       - Empty state for each filter

    4. Create orders page:
       ```tsx
       import OrderManagement from '@/components/accommodations/OrderManagement';

       export default function OrdersPage() {
         // Get propertyId following same pattern as services/bookings pages
         return (
           <div className="p-6">
             <h1 className="text-2xl font-semibold mb-6">Service Orders</h1>
             <OrderManagement propertyId={propertyId} />
           </div>
         );
       }
       ```

    5. Update Sidebar.tsx:
       - Add two new entries under the Accommodations section children:
         - "Services" -> /accommodations/services (icon: Package or Storefront from Phosphor)
         - "Orders" -> /accommodations/orders (icon: ClipboardText or Receipt from Phosphor)
       - Place them after existing entries (Bookings, Calendar, Rooms, Settings, QR Codes)
       - Or place "Orders" right after "Bookings" (more logical) and "Services" after "Rooms"
       - Follow existing children pattern for icon imports and structure

    **Pattern notes:**
    - Follow BookingStatusBadge for OrderStatusBadge
    - Follow booking detail page patterns for OrderDetailPanel
    - Follow bookings list page patterns for OrderManagement
    - Use Phosphor SSR imports (@phosphor-icons/react/dist/ssr) for Sidebar (server component)
    - Use Phosphor client imports (@phosphor-icons/react) for client components

  </action>
  <verify>
    - TypeScript compiles: `cd apps/backoffice && npx tsc --noEmit --pretty 2>&1 | head -20`
    - Build passes: `cd apps/backoffice && npx next build 2>&1 | tail -20`
    - Sidebar updated: check for "services" and "orders" entries
    - All components exist: `ls apps/backoffice/components/accommodations/Order*.tsx`
  </verify>
  <done>
    Owner can view all orders in filterable table, drill into order detail with guest/room/items info, perform status actions (confirm/prepare/ready/deliver/reject) with server-side validation, send WhatsApp messages. Sidebar has Services and Orders navigation entries.
  </done>
</task>

</tasks>

<verification>
- Orders page renders at /accommodations/orders
- Order table shows orders with status badges
- Status filter tabs work (All, Active, Completed, Cancelled)
- Clicking order opens detail panel with full info
- Action buttons follow state machine (only valid transitions shown)
- Status update API validates transitions before applying
- WhatsApp deep-link works for each order
- Sidebar shows Services and Orders entries under Accommodations
- Build passes cleanly
</verification>

<success_criteria>

1. Owner can view paginated, filterable list of service orders
2. Owner can drill into order detail with guest info, room, items, timestamps
3. Owner can confirm, prepare, ready, deliver, or reject orders via action buttons
4. Invalid transitions are rejected by API (state machine)
5. WhatsApp deep-link available for guest communication
6. Sidebar has "Services" and "Orders" entries under Accommodations
7. OrderStatusBadge shows colored pill per status
8. TypeScript compiles and build passes
   </success_criteria>

<output>
After completion, create `.planning/phases/23-service-ordering/23-04-SUMMARY.md`
</output>
