---
phase: 29-multi-zone-wifi
plan: 02
type: execute
wave: 2
depends_on: ['29-01']
files_modified:
  - apps/accommodations/frontend/types/stay.ts
  - apps/accommodations/frontend/lib/wifi-utils.ts
  - apps/accommodations/frontend/components/stay/WifiCard.tsx
  - apps/accommodations/frontend/app/api/stay/room/[roomCode]/route.ts
  - apps/accommodations/frontend/app/api/stay/verify/route.ts
  - apps/accommodations/frontend/app/api/stay/room/[roomCode]/verify/route.ts
  - apps/accommodations/frontend/app/api/stay/[code]/property/route.ts
  - apps/accommodations/frontend/lib/email-templates.ts
autonomous: true

must_haves:
  truths:
    - 'Guest scanning room QR sees WiFi credentials organized by zone'
    - "Room-specific WiFi network (override or room-tagged zone) appears first with 'Your Room' highlight"
    - 'If only 1 WiFi zone exists, the card renders as a simple single-network card (no zone labels)'
    - 'If 2+ zones exist, all are shown in a flat list with icons and copy-password buttons'
    - 'All 4 guest API routes return consistent WifiInfo with zones array'
    - 'Legacy properties with only wifi_network/wifi_password still display correctly'
    - 'Pre-arrival email includes primary WiFi zone credentials'
  artifacts:
    - path: 'apps/accommodations/frontend/lib/wifi-utils.ts'
      provides: 'buildWifiInfo() shared helper for WiFi resolution'
      exports: ['buildWifiInfo']
    - path: 'apps/accommodations/frontend/types/stay.ts'
      provides: 'Updated WifiInfo type with optional zones, new WifiZoneInfo type'
      contains: 'WifiZoneInfo'
    - path: 'apps/accommodations/frontend/components/stay/WifiCard.tsx'
      provides: 'Multi-zone WiFi display component'
      contains: 'zones'
  key_links:
    - from: 'apps/accommodations/frontend/app/api/stay/room/[roomCode]/route.ts'
      to: 'apps/accommodations/frontend/lib/wifi-utils.ts'
      via: 'import buildWifiInfo'
      pattern: 'buildWifiInfo'
    - from: 'apps/accommodations/frontend/app/api/stay/verify/route.ts'
      to: 'apps/accommodations/frontend/lib/wifi-utils.ts'
      via: 'import buildWifiInfo'
      pattern: 'buildWifiInfo'
    - from: 'apps/accommodations/frontend/components/stay/WifiCard.tsx'
      to: 'apps/accommodations/frontend/types/stay.ts'
      via: 'import WifiInfo, WifiZoneInfo'
      pattern: 'WifiZoneInfo'
---

<objective>
Build the guest-facing multi-zone WiFi display and update all API routes with consistent WiFi resolution.

Purpose: Guests see WiFi credentials organized by zone with their room network highlighted. A shared buildWifiInfo() helper ensures all 4 API routes return consistent data. The WifiCard component handles single-zone (simple card) and multi-zone (flat list with room highlight) display modes.
Output: Updated WifiInfo types, wifi-utils.ts helper, redesigned WifiCard, 4 updated API routes, updated email template.
</objective>

<execution_context>
@/Users/gianfrancodagostino/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gianfrancodagostino/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/29-multi-zone-wifi/29-RESEARCH.md
@.planning/phases/29-multi-zone-wifi/29-CONTEXT.md
@.planning/phases/29-multi-zone-wifi/29-01-SUMMARY.md

Key source files to read before implementing:
@apps/accommodations/frontend/types/stay.ts
@apps/accommodations/frontend/components/stay/WifiCard.tsx
@apps/accommodations/frontend/app/api/stay/room/[roomCode]/route.ts
@apps/accommodations/frontend/app/api/stay/verify/route.ts
@apps/accommodations/frontend/app/api/stay/room/[roomCode]/verify/route.ts
@apps/accommodations/frontend/app/api/stay/[code]/property/route.ts
@apps/accommodations/frontend/lib/email-templates.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: WifiZoneInfo type + buildWifiInfo() helper + update 4 API routes + email template</name>
  <files>
    apps/accommodations/frontend/types/stay.ts
    apps/accommodations/frontend/lib/wifi-utils.ts
    apps/accommodations/frontend/app/api/stay/room/[roomCode]/route.ts
    apps/accommodations/frontend/app/api/stay/verify/route.ts
    apps/accommodations/frontend/app/api/stay/room/[roomCode]/verify/route.ts
    apps/accommodations/frontend/app/api/stay/[code]/property/route.ts
    apps/accommodations/frontend/lib/email-templates.ts
  </files>
  <action>
**Step 1: Update types** (`types/stay.ts`):
- Add WifiZoneInfo interface: { zoneId: string, label: string, zoneType: string, icon: string, ssid: string, password: string, sortOrder: number, isRoomNetwork?: boolean }
- Update existing WifiInfo interface: keep `network` and `password` fields (backward compat), add optional `zones?: WifiZoneInfo[]`

**Step 2: Create wifi-utils.ts** (`lib/wifi-utils.ts`):

- Create `buildWifiInfo(property, roomOverride?)` function following the exact implementation from the research document's "WiFi Resolution Helper" section.
- Resolution priority: (1) room override -> add as first entry with isRoomNetwork:true, (2) wifi_zones array -> add all zones, mark zone_type='room' as isRoomNetwork if no room override, (3) legacy fallback to wifi_network/wifi_password.
- Sort zones: room network first, then by sort_order.
- Return WifiInfo with backward-compatible network/password fields (from first zone) plus zones array.

**Step 3: Update all 4 API routes** to use buildWifiInfo():

Route 1 — `/api/stay/room/[roomCode]/route.ts` (GET, browse tier):

- Read the existing code. Find where propertyData is fetched.
- Add `wifi_zones` to the property SELECT query.
- Add `wifi_ssid_override, wifi_password_override` to the room query (or fetch room data if not already).
- Replace the inline wifi_network/wifi_password mapping with: `buildWifiInfo(propertyData, roomData)`
- Import buildWifiInfo from '@/lib/wifi-utils'

Route 2 — `/api/stay/verify/route.ts` (POST, full tier):

- Add `wifi_zones` to the rawProperty/property SELECT.
- Add room override fields to the accom_rooms join.
- Replace inline WiFi mapping with buildWifiInfo(rawProperty, roomData).

Route 3 — `/api/stay/room/[roomCode]/verify/route.ts` (POST):

- Same pattern as Route 2. Add wifi_zones to property SELECT, room overrides to room query, use buildWifiInfo().

Route 4 — `/api/stay/[code]/property/route.ts` (GET, property refresh):

- Add `wifi_zones` to the property SELECT.
- This route has NO room context (no room_id in JWT). Call buildWifiInfo(data) WITHOUT roomOverride parameter. The frontend caches the room override from the initial room resolution (routes 1-3) and merges it client-side.

**Step 4: Update email template** (`lib/email-templates.ts`):

- Find the pre-arrival email section that uses wifiName/wifiPassword.
- Change it to: if wifi_zones exists and is non-empty, use the first zone's ssid/password (or the room-tagged zone). Otherwise, fall back to legacy wifi_network/wifi_password.
- Keep it simple: emails show ONE primary WiFi network, not all zones. The full list is in the dashboard.

CRITICAL: All 4 routes MUST use buildWifiInfo() to ensure consistency. Do NOT leave any route with inline WiFi resolution.
</action>
<verify>
Run `npx tsc --noEmit` from the accommodations frontend directory to verify no TypeScript errors. Grep all 4 route files for "buildWifiInfo" to confirm all use the shared helper. Verify wifi-utils.ts exports buildWifiInfo.
</verify>
<done>
All 4 guest API routes return WifiInfo with zones array via shared buildWifiInfo() helper. WifiZoneInfo type exists. Room override resolution works in routes 1-3. Property route returns zones without room override. Email template uses primary zone.
</done>
</task>

<task type="auto">
  <name>Task 2: Multi-zone WifiCard component</name>
  <files>
    apps/accommodations/frontend/components/stay/WifiCard.tsx
  </files>
  <action>
Read the existing WifiCard.tsx first. Understand its current props, styling (gradient teal card `from-[#3D8B87] to-[#2D7A76]`), and copy-password functionality.

Redesign WifiCard to handle two display modes:

**Mode 1 — Single network** (no zones, or zones.length === 1):

- Render exactly like the current card: gradient teal background, SSID, password with show/hide toggle, copy button.
- If the single zone has a label other than the default, show it as a subtle subtitle.
- This preserves the existing look for properties that haven't configured multi-zone.

**Mode 2 — Multiple zones** (zones.length >= 2):

- The room-highlighted network (isRoomNetwork === true) renders as the gradient teal card at the top, with a "Your Room" badge (small pill/tag).
- Below it, other zones render as compact rows in a lighter card/section:
  - Each row: zone icon (from Phosphor Icons, mapped by icon field) + label + SSID + copy-password button
  - Password is hidden by default with a show/hide toggle per row
  - Use the ZONE_ICONS mapping from the research: Bed, ForkKnife, SwimmingPool, Buildings, Tree, CloudSun, Laptop, WifiHigh (generic fallback)
- All zones in a flat list (NOT accordion — per CONTEXT.md decision, WiFi should be immediately visible).

**Props interface:**

```typescript
interface WifiCardProps {
  wifi: WifiInfo; // Updated type with optional zones
}
```

**Implementation details:**

- Import zone icons from '@phosphor-icons/react': Bed, ForkKnife, SwimmingPool, Buildings, Tree, CloudSun, Laptop, WifiHigh
- Create a `getZoneIcon(iconName: string)` helper that maps icon string to Phosphor component, falling back to WifiHigh
- Copy-to-clipboard: use `navigator.clipboard.writeText()` with a brief "Copied!" feedback (existing pattern from current WifiCard)
- Password toggle: per-zone state (Map or individual state per zone)
- Responsive: mobile-first, the compact rows should stack nicely on small screens
- Keep the existing gradient styling for the highlighted/single card
- Secondary zone rows: white/light background, subtle border, smaller text

**Backward compatibility:** If wifi.zones is undefined or empty, render the card using wifi.network and wifi.password (legacy mode). This is critical — old API responses without zones must still work.
</action>
<verify>
Run `npx tsc --noEmit` from the accommodations frontend. Verify the component handles: (1) legacy WifiInfo with no zones, (2) single zone, (3) multiple zones with room highlight, (4) multiple zones with no room highlight (all shown equally). Check that Phosphor Icons are imported correctly.
</verify>
<done>
WifiCard renders single-network as current gradient card. Multi-zone renders room network as highlighted gradient card with "Your Room" badge, other zones as compact rows with icons and copy buttons. Legacy WifiInfo without zones still renders correctly.
</done>
</task>

</tasks>

<verification>
1. TypeScript compiles cleanly for accommodations frontend (`npx tsc --noEmit`)
2. All 4 API routes import and use buildWifiInfo() — no inline WiFi resolution remains
3. WifiCard handles all display modes: legacy (no zones), single zone, multi-zone with room highlight
4. Email template uses primary zone for pre-arrival email
5. WifiZoneInfo type is exported from types/stay.ts
6. wifi-utils.ts is importable and exports buildWifiInfo
</verification>

<success_criteria>

- Guest scanning room QR sees WiFi credentials organized by zone with room network highlighted
- Single-zone properties see the same simple gradient card as before (no visual regression)
- Multi-zone properties show all zones in a flat list with icons and copy buttons
- Room override appears as "Your Room" at the top when configured
- All 4 guest API routes return consistent WifiInfo via buildWifiInfo()
- Pre-arrival email includes primary WiFi zone credentials
- Legacy properties (wifi_network only, no wifi_zones) still display correctly
  </success_criteria>

<output>
After completion, create `.planning/phases/29-multi-zone-wifi/29-02-SUMMARY.md`
</output>
