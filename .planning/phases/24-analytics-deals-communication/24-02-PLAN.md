---
phase: 24-analytics-deals-communication
plan: 02
type: execute
wave: 2
depends_on: ['24-01']
files_modified:
  - apps/backoffice/app/api/accommodations/deals/route.ts
  - apps/backoffice/app/api/accommodations/deals/[id]/route.ts
  - apps/backoffice/components/accommodations/DealsManager.tsx
  - apps/backoffice/app/(dashboard)/accommodations/deals/page.tsx
  - apps/accommodations/frontend/app/api/deals/[id]/click/route.ts
  - apps/accommodations/frontend/app/api/stay/[code]/deals/route.ts
  - apps/accommodations/frontend/components/stay/LocalDeals.tsx
autonomous: true

must_haves:
  truths:
    - 'Owner can create a local deal with partner name, discount description, URL, and optional image'
    - 'Owner can edit and delete existing deals'
    - 'Owner can toggle deals active/inactive'
    - 'Guest sees active deals in In-Stay Dashboard with real data from accom_deals'
    - 'Clicking a deal link logs the click and redirects to external URL'
  artifacts:
    - path: 'apps/backoffice/app/api/accommodations/deals/route.ts'
      provides: 'GET list + POST create for deals'
      exports: ['GET', 'POST']
    - path: 'apps/backoffice/app/api/accommodations/deals/[id]/route.ts'
      provides: 'PUT update + DELETE for deals'
      exports: ['PUT', 'DELETE']
    - path: 'apps/backoffice/components/accommodations/DealsManager.tsx'
      provides: 'CRUD UI for deals management'
      min_lines: 80
    - path: 'apps/accommodations/frontend/app/api/deals/[id]/click/route.ts'
      provides: 'Click tracking redirect endpoint'
      exports: ['GET']
    - path: 'apps/accommodations/frontend/components/stay/LocalDeals.tsx'
      provides: 'Guest-facing deals display with click tracking links'
      min_lines: 30
  key_links:
    - from: 'DealsManager.tsx'
      to: '/api/accommodations/deals'
      via: 'fetch CRUD operations'
      pattern: 'fetch.*accommodations/deals'
    - from: 'LocalDeals.tsx'
      to: '/api/deals/[id]/click'
      via: 'click tracking redirect links'
      pattern: 'deals.*click'
    - from: 'stay/[code]/deals/route.ts'
      to: 'accom_deals'
      via: 'supabase query'
      pattern: 'accom_deals'
---

<objective>
Implement the full deals lifecycle: owner CRUD in backoffice, guest-facing deal display from the new accom_deals table, and click tracking with redirect.

Purpose: Local deals connect accommodation guests with nearby businesses, creating value for guests (discounts) and owners (partnership revenue). Click tracking provides measurable partner referral data.
Output: Backoffice deals management page, updated guest deals component, click tracking API.
</objective>

<execution_context>
@/Users/gianfrancodagostino/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gianfrancodagostino/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/24-analytics-deals-communication/24-CONTEXT.md
@.planning/phases/24-analytics-deals-communication/24-RESEARCH.md
@.planning/phases/24-analytics-deals-communication/24-01-SUMMARY.md

Key references:

- @apps/backoffice/app/api/accommodations/rooms/route.ts (CRUD API pattern with validateAdminApiKey)
- @apps/backoffice/components/accommodations/RoomManager.tsx (CRUD component pattern to follow)
- @apps/accommodations/frontend/components/stay/LocalDeals.tsx (existing component to update)
- @apps/accommodations/frontend/app/api/stay/[code]/deals/route.ts (existing deals API to update data source)
  </context>

<tasks>

<task type="auto">
  <name>Task 1: Deals CRUD API + backoffice UI</name>
  <files>
    apps/backoffice/app/api/accommodations/deals/route.ts
    apps/backoffice/app/api/accommodations/deals/[id]/route.ts
    apps/backoffice/components/accommodations/DealsManager.tsx
    apps/backoffice/app/(dashboard)/accommodations/deals/page.tsx
  </files>
  <action>
    1. Create GET+POST /api/accommodations/deals/route.ts:
       - GET: list deals for propertyId, ordered by display_order then created_at. Return all fields.
       - POST: create deal. Validate with zod: partner_name (required, 1-100 chars), discount_description (required, 1-200 chars), description (optional), url (optional, valid URL if provided), image_url (optional), is_active (boolean, default true), display_order (integer, default 0).
       - Both use validateAdminApiKey() for auth, supabaseAdmin for DB.

    2. Create PUT+DELETE /api/accommodations/deals/[id]/route.ts:
       - PUT: update deal. Allowlisted fields: partner_name, discount_description, description, url, image_url, is_active, display_order. Set updated_at = NOW().
       - DELETE: delete deal by id (CASCADE handles click logs).
       - Both use validateAdminApiKey().

    3. Create DealsManager.tsx following RoomManager/ChargesManager pattern:
       - List deals in cards/rows with partner name, discount, active status badge
       - "Add Deal" button opens inline form or modal with fields: partner_name, discount_description, description (textarea), url, image_url, is_active toggle
       - Edit button on each deal opens same form pre-filled
       - Delete button with confirmation dialog
       - Active/inactive toggle directly on each deal row (quick toggle via PUT)
       - Use Phosphor icons (Handshake, Link, Trash, PencilSimple, ToggleLeft/ToggleRight)
       - Fetch from /api/accommodations/deals using AUTH_HEADERS pattern

    4. Create deals/page.tsx:
       - Simple page importing DealsManager
       - Pass propertyId (same pattern as other accommodations pages)

  </action>
  <verify>
    - `cd apps/backoffice && npx tsc --noEmit` passes
    - Deals page accessible at /accommodations/deals
    - CRUD operations work (create, read, update, delete)
  </verify>
  <done>Owner can create, edit, delete, and toggle active/inactive on local deals from the backoffice dashboard. Deals page is linked from sidebar (added in Plan 01).</done>
</task>

<task type="auto">
  <name>Task 2: Guest deals data source update + click tracking</name>
  <files>
    apps/accommodations/frontend/app/api/deals/[id]/click/route.ts
    apps/accommodations/frontend/app/api/stay/[code]/deals/route.ts
    apps/accommodations/frontend/components/stay/LocalDeals.tsx
  </files>
  <action>
    1. Create /api/deals/[id]/click/route.ts:
       - GET handler: extract deal_id from params, booking_id from ?bid= query param
       - Insert into accom_deal_clicks: { deal_id, booking_id (nullable) }
       - Fetch deal URL from accom_deals where id = deal_id and is_active = true
       - If deal found and has URL: NextResponse.redirect(deal.url)
       - If no URL or not found: redirect to referrer or stay dashboard
       - No authentication required (click tracking is not sensitive)
       - Use supabaseAdmin (same pattern as other accommodations API routes)

    2. Update stay/[code]/deals/route.ts:
       - Change data source from partner_conventions to accom_deals table
       - Query: SELECT id, partner_name, discount_description, description, url, image_url FROM accom_deals WHERE property_id = ? AND is_active = true ORDER BY display_order, created_at
       - Keep existing JWT authentication pattern for stay routes

    3. Update LocalDeals.tsx:
       - Update TypeScript interface to match accom_deals shape (partner_name, discount_description, description, url, image_url)
       - Change deal links to route through click tracking: href={`/api/deals/${deal.id}/click?bid=${bookingId}`}
       - Open in new tab (target="_blank" rel="noopener")
       - Show partner name, discount badge, short description
       - Keep horizontal scroll on mobile layout
       - Handle empty state (no active deals)

  </action>
  <verify>
    - `cd apps/accommodations/frontend && npx tsc --noEmit` passes
    - Click tracking route redirects to deal URL
    - LocalDeals component renders deal cards from accom_deals table
    - Deal links go through /api/deals/[id]/click for tracking
  </verify>
  <done>Guest In-Stay Dashboard shows real deals from accom_deals table. Clicking any deal logs the click to accom_deal_clicks and redirects to the partner URL. DEAL-01, DEAL-02, DEAL-03 complete.</done>
</task>

</tasks>

<verification>
- `cd apps/backoffice && npx tsc --noEmit` passes
- `cd apps/accommodations/frontend && npx tsc --noEmit` passes
- Owner can CRUD deals in backoffice
- Guest sees deals from accom_deals in In-Stay Dashboard
- Deal clicks are logged and redirect to external URL
</verification>

<success_criteria>

- DEAL-01: Owner can manage local deals in dashboard (CRUD: partner name, discount, description, URL, image, active toggle)
- DEAL-02: Guest can view local deals in In-Stay Dashboard from real accom_deals data
- DEAL-03: Referral tracking logs when guest taps a partner deal link
  </success_criteria>

<output>
After completion, create `.planning/phases/24-analytics-deals-communication/24-02-SUMMARY.md`
</output>
