# Milestone v1.4: Accommodations v2

**Status:** SHIPPED 2026-01-31
**Phases:** 18-24
**Total Plans:** 20

## Overview

Complete the Accommodations vertical end-to-end: public property page with hybrid booking, full owner dashboard in backoffice, and configurable service ordering with cross-vertical deep-links.

## Phases

### Phase 18: Database Foundation

**Goal**: All database tables, constraints, and policies are in place so every subsequent phase builds on correct schema
**Depends on**: Nothing (first phase of v1.4)
**Plans**: 2 plans

Plans:

- [x] 18-01: SQL migration 083: table extensions, exclusion constraint, service order tables, RLS
- [x] 18-02: Stripe webhook endpoint with signature verification (stubbed handlers)

**Details:**

- Exclusion constraint preventing double bookings per room (btree_gist)
- accom_properties extended with 11 booking/pricing configuration columns
- accom_rooms extended with pricing and media fields (4 columns)
- accom_bookings extended with pricing breakdown and payment tracking (14 columns)
- accom_service_orders + accom_service_order_items tables
- RLS policies on all new tables

### Phase 19: Property Page & Booking Flow

**Goal**: Guests can discover a property via its public page and submit a booking request or get instant confirmation
**Depends on**: Phase 18
**Plans**: 3 plans

Plans:

- [x] 19-01: Dependencies, types, lib utilities, API routes (property, availability, booking)
- [x] 19-02: Client components (gallery, property sections, calendar, form, confirmation)
- [x] 19-03: Server page (SSR, SEO, JSON-LD), client orchestrator, confirmation page, CSS theming

**Details:**

- SSR property page with OG meta tags, JSON-LD structured data
- Swipeable photo gallery with fullscreen mode
- Date picker calendar with availability checking
- Price breakdown (per-night x nights + cleaning fee + discounts)
- Guest checkout (name, email, phone, dates, guest count) without account
- Hybrid booking: instant-confirm or inquiry (owner-configured)
- Inquiry auto-expiry via expires_at column

### Phase 20: Payments

**Goal**: Owners can configure accepted payment methods and guests can pay via cash, bank transfer, Stripe card, or crypto
**Depends on**: Phase 19
**Plans**: 3 plans

Plans:

- [x] 20-01: DB migration 084 (payment config columns, status extension) + TypeScript types
- [x] 20-02: Guest payment UI (PaymentMethodSelector, BankTransferInstructions, CryptoPaymentOptions) + booking API integration
- [x] 20-03: Stripe Checkout session + webhook handler + manual payment confirmation + booking page status

**Details:**

- Owner configures accepted payment methods per property
- Cash: booking confirmed immediately
- Bank transfer: booking pending until owner confirms manually
- Stripe: deposit collected via Stripe Checkout with webhook confirmation
- Crypto: deep-links via @shared/payment
- Owner manual payment confirmation in dashboard

### Phase 21: Owner Dashboard - Bookings & Property

**Goal**: Owners can manage bookings and configure their property and rooms from the backoffice
**Depends on**: Phase 19
**Plans**: 3 plans

Plans:

- [x] 21-01: API routes (bookings CRUD + rooms CRUD + property settings), shared helpers, BookingStatusBadge
- [x] 21-02: Booking list page (tab filtering, search) + booking detail page (actions, timeline, WhatsApp)
- [x] 21-03: Room management (ChargesManager pattern), property settings form, QR code generation, sidebar navigation

**Details:**

- Filterable booking list with status tabs
- Booking detail with guest info, dates, payment status, special requests
- Confirm/decline inquiry bookings, check-in/out, cancel with reason
- WhatsApp notification on new booking/inquiry
- Room CRUD (capacity, description, images)
- QR code generation for property and rooms

### Phase 22: Owner Dashboard - Calendar & Pricing

**Goal**: Owners can visually manage availability and set flexible pricing strategies
**Depends on**: Phase 21
**Plans**: 2 plans

Plans:

- [x] 22-01: SQL migration 085 (room blocks + seasonal pricing tables), calendar/blocks/pricing API routes, property PUT discount allowlist
- [x] 22-02: AvailabilityCalendar grid, CalendarDetailPanel, SeasonalPricingManager, DiscountSettings, calendar page, sidebar nav

**Details:**

- Monthly calendar with color-coded dates (booked, available, blocked)
- Block/unblock date ranges for maintenance
- Base price per room type
- Seasonal price overrides per date range
- Weekly/monthly discount percentages

### Phase 23: Service Ordering

**Goal**: Guests can browse and order services from the In-Stay Dashboard, and owners can manage service catalog and incoming orders
**Depends on**: Phase 18, Phase 21
**Plans**: 4 plans

Plans:

- [x] 23-01: Migration 086 (automation_level), TypeScript types, order state machine, guest order API routes, stay-api extension
- [x] 23-02: Owner service catalog CRUD (backoffice page, API, ServiceCatalogManager component)
- [x] 23-03: Guest catalog UI, cart, order submission, order tracking with polling
- [x] 23-04: Owner order management (filterable table, status actions, detail panel), sidebar nav, WhatsApp

**Details:**

- Service catalog organized by category with availability hours
- Cart with quantity and notes
- ASAP or time slot delivery
- Order state machine (submitted > confirmed > preparing > ready > delivered)
- Owner automation levels per category (auto-confirm, manual, WhatsApp)
- Cross-vertical deep-links (F&B, tours, wellness)
- WhatsApp notification on new orders

### Phase 24: Analytics, Deals & Communication

**Goal**: Owners have visibility into business performance, guests discover local deals, and booking communication flows automatically
**Depends on**: Phase 21, Phase 23
**Plans**: 3 plans

Plans:

- [x] 24-01: Migration 087 (deals, click tracking, email logs tables), analytics API routes, analytics dashboard with recharts
- [x] 24-02: Deals CRUD (backoffice + guest frontend update + click tracking redirect)
- [x] 24-03: Email communication (confirmation + pre-arrival cron with QR) + WhatsApp deep-links

**Details:**

- Analytics: occupancy rate, revenue by room type/month, ADR trend, service revenue breakdown
- Local deals CRUD with partner name, discount, description
- Referral click tracking
- Booking confirmation email with booking code
- Pre-arrival email (1 day before check-in) with QR code
- WhatsApp deep-links from property page and In-Stay Dashboard
- Vercel cron for daily pre-arrival emails

---

## Milestone Summary

**Key Decisions:**

- Exclusion constraint (btree_gist) for double-booking prevention at DB level
- SECURITY DEFINER functions for guest access (safer than RLS on bookings)
- INTEGER price in minor currency to avoid floating point
- BK-XXXXXX booking codes excluding 0/O/1/I/L for readability
- JWT with checkout+24h expiry for guest tokens
- Hybrid booking mode (instant or inquiry) as owner-configurable setting
- Stripe MCC 7011 for extended authorization (needs SEA validation)
- Recharts v3 Tooltip formatter typed as `any`
- Fire-and-forget email on booking creation (not awaited)
- CRON_SECRET optional for dev
- Static room type color map with gray fallback

**Issues Resolved:**

- All 64 v1.4 requirements implemented and verified
- Cross-phase integration validated (47/47 checks)
- 5 E2E flows verified (guest booking, payment, owner dashboard, service ordering, communication)

**Issues Deferred:**

- Inquiry auto-expiry cron not implemented (bookings expire via expires_at but no active cleanup)
- ADMIN_API_KEY env var auth needs migration to session-based auth
- Stripe E2E testing with live keys (QA)
- Bank transfer manual confirmation E2E testing (QA)
- Crypto deep-link testing on mobile devices (QA)
- Checkout session expiry and retry E2E testing (QA)

**Technical Debt Incurred:**

- ADMIN_API_KEY auth pattern in backoffice API routes (should be session-based)
- Inquiry expiry cleanup cron missing
- Stripe/payment E2E test coverage

---

_For current project status, see .planning/ROADMAP.md_
