generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================================================
// VENUE & USERS
// ============================================================================

model Venue {
  id          String   @id @default(uuid())
  slug        String   @unique
  name        String
  description String?
  currency    String   @default("EUR")

  // Relations
  products    Product[] // Local products owned by this venue
  venueProducts VenueProduct[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// ============================================================================
// PRODUCT CATALOG
// ============================================================================

model Product {
  id          String   @id @default(uuid())
  slug        String   @unique
  name        String   // MultiLangText (JSON)
  description String?  // MultiLangText (JSON)
  image       String?

  // Pricing
  price       Float    @default(0)
  currency    String   @default("EUR")

  // Categorization
  categoryMain String
  categorySub  String?

  // Ownership (Global vs Local)
  venueId     String?
  venue       Venue?   @relation(fields: [venueId], references: [id])

  // Venue-specific overrides/activation for Global Products
  venueData   VenueProduct[]

  // Relations
  ingredients ProductIngredient[]
  // Note: recipes relation managed via menu_items table in Supabase

  // Computed Data (JSONB for flexibility)
  computed    String?  // AutoComputationResult (JSON)

  // Customizations (JSONB)
  customizations String? // ProductCustomization[] (JSON)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([venueId])
  @@index([categoryMain])
}

// Link table for Venues using Global Products
model VenueProduct {
  id          String   @id @default(uuid())
  venueId     String
  venue       Venue    @relation(fields: [venueId], references: [id])
  productId   String
  product     Product  @relation(fields: [productId], references: [id])

  isActive    Boolean  @default(false)
  priceOverride Float?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([venueId, productId])
}

model Ingredient {
  id          String   @id @default(uuid())
  slug        String   @unique
  name        String   // MultiLangText (JSON)

  // Relations
  products    ProductIngredient[]

  // Safety Flags
  allergens   String?  // AllergenFlags (JSON)
  intolerances String? // IntoleranceFlags (JSON)
  diets       String?  // DietaryFlags (JSON)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model ProductIngredient {
  id           String     @id @default(uuid())
  productId    String
  product      Product    @relation(fields: [productId], references: [id], onDelete: Cascade)
  ingredientId String
  ingredient   Ingredient @relation(fields: [ingredientId], references: [id])

  quantity     Float?
  unit         String?
  optional     Boolean    @default(false)

  @@index([productId])
  @@index([ingredientId])
}

// ============================================================================
// RECIPES
// ============================================================================

model Recipe {
  id          String   @id @default(uuid())
  slug        String   @unique
  name        String   // MultiLangText (JSON)
  description String?  // MultiLangText (JSON)

  // Categorization
  category    String   // hot-coffee, iced-coffee, matcha, tea, smoothie, milkshake
  subcategory String?  // espresso-based, milk-based, signature, etc.
  temperature String   // hot, iced

  // Serving
  servingSize String?  // JSON { volume: number, unit: string }

  // Recipe Details (JSON)
  ingredients String?  // RecipeIngredient[] - detailed ingredients with amounts
  equipment   String?  // string[] - required equipment
  method      String?  // RecipeMethod - steps with durations and tips

  // Technical Parameters
  ratio       String?  // e.g., "1:2", "1:1:1"
  ratioExplanation String?
  parameters  String?  // JSON - pressure, temperature, extraction time, etc.

  // Nutrition (JSON)
  nutrition   String?  // calories, caffeine_mg, protein_g, etc.

  // Professional Tips
  baristaTips String?  // JSON string[] - professional tips
  variations  String?  // JSON RecipeVariation[] - alternative preparations
  latteArt    String?  // JSON - recommended patterns, difficulty

  // Metadata
  difficulty  Int      @default(2) // 1-4 skill level
  totalTime   Int?     // seconds
  origin      String?  // e.g., "Italy", "Vietnam"

  // Relations
  products    ProductRecipe[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([category])
  @@index([temperature])
}

// Link table for Menu Items using Recipes
// Note: References menu_items table (not Product) as per Supabase schema
model ProductRecipe {
  id        String   @id @default(uuid())
  productId String   // References menu_items.id in Supabase
  recipeId  String
  recipe    Recipe   @relation(fields: [recipeId], references: [id], onDelete: Cascade)

  // Override fields for product-specific variations
  notes     String?  // Product-specific preparation notes

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([productId, recipeId])
  @@index([productId])
  @@index([recipeId])
  @@map("ProductRecipe")
}
