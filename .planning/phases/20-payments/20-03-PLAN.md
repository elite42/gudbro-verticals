---
phase: 20-payments
plan: 03
type: execute
wave: 2
depends_on: ['20-01']
files_modified:
  - apps/accommodations/frontend/lib/stripe.ts
  - apps/accommodations/frontend/app/api/checkout/route.ts
  - apps/accommodations/frontend/app/api/webhooks/stripe/route.ts
  - apps/accommodations/frontend/app/api/bookings/[id]/payment/route.ts
  - apps/accommodations/frontend/app/booking/[code]/page.tsx
  - apps/accommodations/frontend/app/dashboard/bookings/page.tsx
autonomous: true
user_setup:
  - service: stripe
    why: 'Stripe Checkout for card deposit payments'
    env_vars:
      - name: STRIPE_SECRET_KEY
        source: 'Stripe Dashboard -> Developers -> API keys -> Secret key'
      - name: STRIPE_ACCOM_WEBHOOK_SECRET
        source: 'Stripe Dashboard -> Developers -> Webhooks -> Create endpoint -> Signing secret'
      - name: NEXT_PUBLIC_APP_URL
        source: 'Your deployed app URL (e.g., https://accom.gudbro.com) or http://localhost:3000 for local dev'
      - name: ADMIN_API_KEY
        source: 'Generate a secure random string for owner API authentication (e.g., openssl rand -hex 32)'
    dashboard_config:
      - task: 'Create webhook endpoint for checkout.session.completed and checkout.session.expired'
        location: 'Stripe Dashboard -> Developers -> Webhooks -> Add endpoint'

must_haves:
  truths:
    - 'Stripe Checkout creates a session with deposit amount and redirects guest to Stripe hosted page'
    - 'Webhook handler confirms booking on checkout.session.completed and reverts on checkout.session.expired'
    - 'Webhook is idempotent (processing same event twice does not double-update)'
    - 'Owner can manually confirm payment for bank transfer and crypto bookings'
    - 'Booking confirmation page shows payment status badge and Stripe payment link for card bookings'
    - 'Owner can see payment status in dashboard and confirm/reject pending bank transfer and crypto payments'
  artifacts:
    - path: 'apps/accommodations/frontend/lib/stripe.ts'
      provides: 'Stripe client singleton'
      min_lines: 8
    - path: 'apps/accommodations/frontend/app/api/checkout/route.ts'
      provides: 'POST endpoint that creates Stripe Checkout Session'
      exports: ['POST']
    - path: 'apps/accommodations/frontend/app/api/webhooks/stripe/route.ts'
      provides: 'Webhook handler for checkout.session.completed and checkout.session.expired'
      contains: 'constructEvent'
    - path: 'apps/accommodations/frontend/app/api/bookings/[id]/payment/route.ts'
      provides: 'PATCH endpoint for owner to manually confirm/reject payment'
      exports: ['PATCH']
    - path: 'apps/accommodations/frontend/app/dashboard/bookings/page.tsx'
      provides: 'Owner dashboard UI for viewing and managing booking payment status'
      contains: 'Confirm Payment'
  key_links:
    - from: 'apps/accommodations/frontend/app/api/checkout/route.ts'
      to: 'stripe.checkout.sessions.create'
      via: 'Stripe SDK'
      pattern: 'checkout.sessions.create'
    - from: 'apps/accommodations/frontend/app/api/webhooks/stripe/route.ts'
      to: 'accom_bookings update'
      via: 'supabase update on webhook event'
      pattern: 'payment_status.*paid'
    - from: 'apps/accommodations/frontend/app/api/bookings/[id]/payment/route.ts'
      to: 'accom_bookings update'
      via: 'manual payment confirmation'
      pattern: 'status.*confirmed'
    - from: 'apps/accommodations/frontend/app/dashboard/bookings/page.tsx'
      to: '/api/bookings/[id]/payment'
      via: 'fetch PATCH on confirm/reject button click'
      pattern: 'api/bookings.*payment'
---

<objective>
Implement Stripe Checkout integration, webhook handling, manual payment confirmation API, and payment status display on the booking page.

Purpose: Card payments work end-to-end via Stripe Checkout. Bank transfer and crypto bookings can be confirmed manually by the owner. The booking confirmation page reflects actual payment status.
Output: Stripe client, checkout session API, complete webhook handler, manual payment confirmation endpoint, enhanced booking page.
</objective>

<execution_context>
@/Users/gianfrancodagostino/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gianfrancodagostino/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-payments/20-RESEARCH.md
@.planning/phases/20-payments/20-01-SUMMARY.md

# Key source files

@apps/accommodations/frontend/app/api/webhooks/stripe/route.ts
@apps/accommodations/frontend/app/api/booking/route.ts
@apps/accommodations/frontend/app/booking/[code]/page.tsx
@apps/accommodations/frontend/lib/supabase.ts
@apps/accommodations/frontend/types/property.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Stripe Checkout session creation and webhook implementation</name>
  <files>
    apps/accommodations/frontend/lib/stripe.ts
    apps/accommodations/frontend/app/api/checkout/route.ts
    apps/accommodations/frontend/app/api/webhooks/stripe/route.ts
  </files>
  <action>
**lib/stripe.ts** (new file):
- Create Stripe singleton: `new Stripe(process.env.STRIPE_SECRET_KEY || '', { apiVersion: '2023-10-16' })`
- Export as `stripe`
- Guard: if no STRIPE_SECRET_KEY, log warning (same lazy pattern as supabase.ts)

**POST /api/checkout/route.ts** (new file):

- Accept JSON body: `{ bookingId: string }`
- Fetch booking with property join: `accom_bookings` join `accom_properties` to get name, deposit_percent, stripe_account_id
- Validate: booking exists, status is 'pending_payment', payment_method is 'card'
- Calculate deposit: `depositAmount = Math.round(booking.total_price * ((property.deposit_percent || 100) / 100))`
- Validate depositAmount >= 50 (Stripe minimum is ~50 cents for most currencies; if below, use total_price)
- Create Stripe Checkout Session:
  ```
  mode: 'payment'
  payment_method_types: ['card']
  customer_email: booking.guest_email
  line_items: [{
    price_data: {
      currency: booking.currency.toLowerCase(),
      product_data: { name: `Booking deposit - ${property.name}`, description: `${booking.num_nights} nights` },
      unit_amount: depositAmount
    },
    quantity: 1
  }]
  metadata: { booking_id: booking.id, property_id: property.id, deposit_percent: depositPercent.toString() }
  success_url: `${process.env.NEXT_PUBLIC_APP_URL}/booking/${booking.booking_code}?payment=success`
  cancel_url: `${process.env.NEXT_PUBLIC_APP_URL}/booking/${booking.booking_code}?payment=cancelled`
  ```
- Update booking with `stripe_checkout_session_id: session.id`
- Return `{ url: session.url }`
- Error handling: wrap in try/catch, return 500 on Stripe errors

**Implement webhook handler (extend existing stub):**

- Import `stripe` from `@/lib/stripe`
- Import `getSupabaseAdmin` from `@/lib/supabase`
- Keep existing signature verification (already correct with `request.text()`)

- `checkout.session.completed` handler:
  1. Get bookingId from `session.metadata.booking_id`
  2. Idempotency check: fetch booking, if `payment_status === 'paid'`, skip (return 200)
  3. Determine payment_status: if `session.metadata.deposit_percent === '100'` then 'paid', else 'partial'
  4. Update booking: `{ payment_status, status: 'confirmed', stripe_payment_intent_id: session.payment_intent }`
  5. Log: `Payment confirmed for booking ${bookingId}`

- `checkout.session.expired` handler:
  1. Get bookingId from metadata
  2. Update booking only if `status = 'pending_payment'` (conditional update): set `status: 'pending'` to allow retry
  3. Log: `Checkout session expired for booking ${bookingId}`

- Return `{ received: true }` for all events
  </action>
  <verify>

1. `cd /Users/gianfrancodagostino/Desktop/gudbro-verticals/apps/accommodations/frontend && npx tsc --noEmit --pretty 2>&1 | head -30`
2. Review webhook handler for idempotency (check before update) and correct request.text() usage
   </verify>
   <done>Stripe client singleton created. POST /api/checkout creates Checkout Session with deposit amount and returns redirect URL. Webhook handler confirms booking on payment success and reverts to pending on session expiry. Idempotency ensured via payment_status check.</done>
   </task>

<task type="auto">
  <name>Task 2: Manual payment confirmation API and booking page payment status</name>
  <files>
    apps/accommodations/frontend/app/api/bookings/[id]/payment/route.ts
    apps/accommodations/frontend/app/booking/[code]/page.tsx
  </files>
  <action>
**PATCH /api/bookings/[id]/payment/route.ts** (new file):
- This endpoint is for owner manual payment confirmation (bank transfer, crypto)
- Accept JSON body: `{ action: 'confirm' | 'reject' }`
- For now, use a simple API key check: require `Authorization: Bearer {ADMIN_API_KEY}` header (matches backoffice pattern)
  - If `process.env.ADMIN_API_KEY` is not set, return 401
  - Check header matches
- Fetch booking by ID
- Validate: booking exists, status is 'pending_payment'
- If action === 'confirm':
  - Update booking: `{ payment_status: 'paid', status: 'confirmed' }`
- If action === 'reject':
  - Update booking: `{ payment_status: 'failed', status: 'cancelled' }`
- Return updated booking status
- Error handling: 404 if not found, 400 if invalid action or wrong status

**Update booking page (`/booking/[code]/page.tsx`):**

- Extend BookingData interface: add `payment_method`, `payment_status`, `deposit_amount`, `deposit_percent`
- Extend fetchBooking SELECT to include these columns
- Add STATUS_STYLES entries:
  - `pending_payment`: bg amber-50, text amber-700, label "Awaiting Payment"
  - `payment_failed`: bg red-50, text red-700, label "Payment Failed"
- Add payment info section (after stay details, before WhatsApp CTA):
  - Show payment method badge (e.g., "Paid by Card", "Bank Transfer", "Crypto", "Cash")
  - Show payment status: paid/partial/unpaid
  - If status is 'pending_payment' and payment_method is 'card':
    - Show "Complete Payment" link that calls `/api/checkout` with the booking ID (as a form POST from the page, or a simple button that navigates)
    - This allows guest to retry card payment if session expired
  - If deposit_percent < 100 and deposit_amount > 0:
    - Show "Deposit: {formatPrice(deposit_amount, currency)} ({deposit_percent}%)"
    - Show "Remaining: {formatPrice(total - deposit_amount, currency)} due at check-in"
- Handle `?payment=success` and `?payment=cancelled` query params:
  - On `payment=success`: show a green banner "Payment successful! Your booking is confirmed."
  - On `payment=cancelled`: show amber banner "Payment was not completed. You can try again below."
  - These are shown temporarily via a client component or via reading searchParams in the server component

For the query param handling, since this is a server component, read searchParams and conditionally render banners. Use `searchParams` prop from Next.js page.
</action>
<verify>

1. `cd /Users/gianfrancodagostino/Desktop/gudbro-verticals/apps/accommodations/frontend && npx tsc --noEmit --pretty 2>&1 | head -30`
2. Review manual payment API for proper authorization check
3. Review booking page for correct conditional rendering of payment status and retry button
   </verify>
   <done>PATCH /api/bookings/[id]/payment endpoint allows owner to confirm or reject manual payments. Booking confirmation page shows payment status, deposit breakdown, retry link for expired card payments, and success/cancelled banners from query params.</done>
   </task>

<task type="auto">
  <name>Task 3: Owner dashboard payment management UI</name>
  <files>
    apps/accommodations/frontend/app/dashboard/bookings/page.tsx
  </files>
  <action>
**Extend the owner bookings list page (`/dashboard/bookings/page.tsx`):**

1. Add `payment_method`, `payment_status`, `deposit_amount`, `deposit_percent` to the booking list SELECT query
2. Add a "Payment" column to the bookings table showing:
   - Payment method badge (Cash, Card, Bank Transfer, Crypto) with appropriate colors
   - Payment status badge: 'paid' (green), 'partial' (amber), 'unpaid' (gray), 'failed' (red)
3. For bookings with `status === 'pending_payment'` and `payment_method` in ('bank_transfer', 'crypto'):
   - Show "Confirm Payment" and "Reject" action buttons
   - On "Confirm Payment" click: call `PATCH /api/bookings/{id}/payment` with `{ action: 'confirm' }` using the ADMIN_API_KEY from env
   - On "Reject" click: call `PATCH /api/bookings/{id}/payment` with `{ action: 'reject' }` with confirmation dialog
   - After action, refresh the bookings list
4. Use Phosphor icons: CheckCircle for confirm, XCircle for reject
5. Show deposit info on hover/tooltip: "{deposit_percent}% deposit = {formatPrice(deposit_amount, currency)}"

**Note:** This page may not exist yet. If it doesn't, check for the closest existing bookings list page in the dashboard and extend that. If no bookings page exists at all, create a minimal one that lists bookings with the payment columns and actions described above.
</action>
<verify>

1. `cd /Users/gianfrancodagostino/Desktop/gudbro-verticals/apps/accommodations/frontend && npx tsc --noEmit --pretty 2>&1 | head -30`
2. Verify confirm/reject buttons exist: `grep -n 'Confirm Payment\|action.*confirm\|action.*reject' apps/accommodations/frontend/app/dashboard/bookings/page.tsx`
   </verify>
   <done>Owner dashboard bookings page shows payment method and status columns. Owner can confirm or reject pending bank transfer and crypto payments directly from the dashboard.</done>
   </task>

</tasks>

<verification>
1. TypeScript compilation passes
2. POST /api/checkout creates valid Stripe session with correct deposit amount
3. Webhook handles checkout.session.completed and checkout.session.expired correctly
4. Webhook is idempotent (re-processing same event is safe)
5. PATCH /api/bookings/[id]/payment confirms or rejects pending payments
6. Booking page shows payment status, deposit info, and retry option
7. Query params ?payment=success and ?payment=cancelled show appropriate banners
8. Owner dashboard shows payment status column and confirm/reject actions for pending payments
</verification>

<success_criteria>

- Stripe Checkout session created with correct deposit amount and metadata
- Webhook confirms booking on successful payment
- Owner can manually confirm bank transfer and crypto payments
- Booking page reflects real-time payment status
- Guest can retry card payment if Checkout session expired
- Owner dashboard shows payment status and provides confirm/reject actions for pending payments
  </success_criteria>

<output>
After completion, create `.planning/phases/20-payments/20-03-SUMMARY.md`
</output>
