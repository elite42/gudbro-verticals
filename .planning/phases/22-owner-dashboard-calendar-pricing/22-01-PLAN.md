---
phase: 22-owner-dashboard-calendar-pricing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - shared/database/migrations/schema/085-calendar-pricing.sql
  - apps/backoffice/app/api/accommodations/calendar/route.ts
  - apps/backoffice/app/api/accommodations/room-blocks/route.ts
  - apps/backoffice/app/api/accommodations/seasonal-pricing/route.ts
  - apps/backoffice/app/api/accommodations/property/route.ts
autonomous: true

must_haves:
  truths:
    - 'Room blocks and seasonal pricing tables exist in the database with proper constraints'
    - 'Calendar API returns merged bookings, blocks, and pricing data for a given month and room'
    - 'Room blocks can be created and deleted via API with overlap validation against active bookings'
    - 'Seasonal pricing overrides can be created, updated, and deleted via API with overlap prevention'
    - 'Weekly and monthly discount percentages can be saved via the existing property PUT endpoint'
  artifacts:
    - path: 'shared/database/migrations/schema/085-calendar-pricing.sql'
      provides: 'accom_room_blocks and accom_seasonal_pricing tables with EXCLUDE constraints, indexes, RLS'
      contains: 'accom_room_blocks'
    - path: 'apps/backoffice/app/api/accommodations/calendar/route.ts'
      provides: 'Merged calendar data endpoint'
      exports: ['GET']
    - path: 'apps/backoffice/app/api/accommodations/room-blocks/route.ts'
      provides: 'Room block CRUD'
      exports: ['POST', 'DELETE']
    - path: 'apps/backoffice/app/api/accommodations/seasonal-pricing/route.ts'
      provides: 'Seasonal pricing CRUD'
      exports: ['GET', 'POST', 'PUT', 'DELETE']
  key_links:
    - from: 'apps/backoffice/app/api/accommodations/calendar/route.ts'
      to: 'supabaseAdmin'
      via: 'Parallel Promise.all fetch of bookings + blocks + pricing'
      pattern: "Promise\\.all"
    - from: 'apps/backoffice/app/api/accommodations/room-blocks/route.ts'
      to: 'accom_bookings'
      via: 'Application-level overlap check before insert'
      pattern: 'accom_bookings.*check_in_date'
---

<objective>
Create the database tables and API routes for calendar data, room blocking, seasonal pricing, and discount management.

Purpose: All backend infrastructure must exist before the calendar UI can fetch/mutate data. This plan creates the complete data layer for Phase 22.
Output: SQL migration 085 + 4 API route files (1 new merged endpoint, 2 new CRUD endpoints, 1 updated existing endpoint).
</objective>

<execution_context>
@/Users/gianfrancodagostino/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gianfrancodagostino/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-owner-dashboard-calendar-pricing/22-RESEARCH.md

# Existing API route patterns to follow:

@apps/backoffice/app/api/accommodations/rooms/route.ts
@apps/backoffice/app/api/accommodations/property/route.ts
@apps/backoffice/lib/accommodations/helpers.ts

# Existing migration for reference (EXCLUDE constraint pattern, btree_gist):

@shared/database/migrations/schema/083-accommodations-v2-foundation.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: SQL migration for room blocks and seasonal pricing tables</name>
  <files>shared/database/migrations/schema/085-calendar-pricing.sql</files>
  <action>
Create migration 085-calendar-pricing.sql with:

1. **accom_room_blocks** table:
   - id UUID PK DEFAULT gen_random_uuid()
   - room_id UUID NOT NULL REFERENCES accom_rooms(id) ON DELETE CASCADE
   - property_id UUID NOT NULL REFERENCES accom_properties(id) ON DELETE CASCADE
   - date_from DATE NOT NULL
   - date_to DATE NOT NULL
   - reason TEXT DEFAULT 'other' CHECK (reason IN ('maintenance', 'personal_use', 'other'))
   - notes TEXT
   - created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
   - CHECK (date_to > date_from)
   - EXCLUDE USING GIST (room_id WITH =, daterange(date_from, date_to, '[)') WITH &&) -- prevent overlapping blocks for same room

2. **accom_seasonal_pricing** table:
   - id UUID PK DEFAULT gen_random_uuid()
   - room_id UUID NOT NULL REFERENCES accom_rooms(id) ON DELETE CASCADE
   - property_id UUID NOT NULL REFERENCES accom_properties(id) ON DELETE CASCADE
   - date_from DATE NOT NULL
   - date_to DATE NOT NULL
   - price_per_night INTEGER NOT NULL CHECK (price_per_night > 0)
   - label TEXT -- e.g., "High Season", "New Year"
   - created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
   - updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
   - CHECK (date_to > date_from)
   - EXCLUDE USING GIST (room_id WITH =, daterange(date_from, date_to, '[)') WITH &&) -- prevent overlapping pricing for same room

3. **Indexes:**
   - idx_accom_room_blocks_room_dates ON accom_room_blocks(room_id, date_from, date_to)
   - idx_accom_room_blocks_property ON accom_room_blocks(property_id)
   - idx_accom_seasonal_pricing_room_dates ON accom_seasonal_pricing(room_id, date_from, date_to)
   - idx_accom_seasonal_pricing_property ON accom_seasonal_pricing(property_id)

4. **RLS** (same pattern as existing accom tables in 083):
   - Enable RLS on both tables
   - Owner manage policy: property_id IN (SELECT id FROM accom_properties WHERE owner_id IN (SELECT id FROM accounts WHERE auth_id = auth.uid()))
   - GRANT ALL on both tables TO authenticated

**Note:** btree_gist extension is already enabled in migration 083. Do NOT add CREATE EXTENSION again.
**Note:** Use half-open [) ranges for daterange, consistent with booking system convention.
</action>
<verify>Check SQL syntax: grep for CREATE TABLE, EXCLUDE USING GIST, CREATE INDEX, ENABLE ROW LEVEL SECURITY in the file. Verify no CREATE EXTENSION btree_gist (already exists).</verify>
<done>Migration 085 creates both tables with all constraints, indexes, and RLS policies. No syntax errors.</done>
</task>

<task type="auto">
  <name>Task 2: Calendar merged data API + room blocks CRUD + seasonal pricing CRUD</name>
  <files>
    apps/backoffice/app/api/accommodations/calendar/route.ts
    apps/backoffice/app/api/accommodations/room-blocks/route.ts
    apps/backoffice/app/api/accommodations/seasonal-pricing/route.ts
  </files>
  <action>
Create three new API route files following the exact pattern from rooms/route.ts (import supabaseAdmin, validateAdminApiKey, force-dynamic):

**1. calendar/route.ts — GET only (merged data)**

GET /api/accommodations/calendar?propertyId=X&roomId=Y&month=2026-02

- Validate admin API key
- Require propertyId and month params. roomId is optional (null = all rooms).
- Parse month string to get grid range: use date-fns parseISO, startOfMonth, endOfMonth, startOfWeek, endOfWeek, format to compute rangeStart and rangeEnd (grid boundaries including prev/next month days).
- Fetch in parallel with Promise.all:
  - accom_bookings: select id, check_in_date, check_out_date, guest_name, status, room_id. Filter: property_id=X, check_out_date >= rangeStart, check_in_date <= rangeEnd, status NOT IN ('cancelled', 'no_show').
  - accom_room_blocks: select id, room_id, date_from, date_to, reason, notes. Filter: property_id=X, date_to >= rangeStart, date_from <= rangeEnd.
  - accom_seasonal_pricing: select id, room_id, date_from, date_to, price_per_night, label. Filter: property_id=X, date_to >= rangeStart, date_from <= rangeEnd.
- If roomId provided, additionally filter all three by .eq('room_id', roomId) BEFORE the query runs (add to query chain).
- Return { bookings, blocks, seasonalPricing }.

**2. room-blocks/route.ts — POST + DELETE**

POST: Create a room block.

- Validate admin API key
- Body: { propertyId, roomId, dateFrom, dateTo, reason?, notes? }
- Validate required fields (propertyId, roomId, dateFrom, dateTo)
- **Application-level overlap check with active bookings**: Query accom_bookings where room_id=roomId AND status NOT IN ('cancelled', 'no_show') AND check_in_date < dateTo AND check_out_date > dateFrom. If any rows returned, return 409: "Cannot block dates with existing bookings: [guest_name] ([check_in_date] to [check_out_date])".
- Insert into accom_room_blocks: { room_id: roomId, property_id: propertyId, date_from: dateFrom, date_to: dateTo, reason: reason || 'other', notes }
- If DB error includes "exclusion constraint", return 409: "This block overlaps with an existing block for this room."
- Return 201 with { block: data }.

DELETE: Remove a room block.

- Validate admin API key
- Body: { id, propertyId }
- Delete from accom_room_blocks where id=id AND property_id=propertyId
- Return 200 with { success: true }.

**3. seasonal-pricing/route.ts — GET + POST + PUT + DELETE**

GET: List pricing overrides.

- Validate admin API key
- Query params: propertyId (required), roomId (optional)
- Select from accom_seasonal_pricing where property_id=propertyId, optionally filtered by roomId
- Order by date_from ascending
- Return { pricing: data }

POST: Create pricing override.

- Body: { propertyId, roomId, dateFrom, dateTo, pricePerNight, label? }
- Validate required (propertyId, roomId, dateFrom, dateTo, pricePerNight)
- Validate pricePerNight > 0
- Insert. If EXCLUDE constraint error → 409: "This pricing period overlaps with an existing one for this room."
- Return 201 with { pricing: data }

PUT: Update pricing override.

- Body: { id, propertyId, dateFrom?, dateTo?, pricePerNight?, label? }
- Allowlisted fields: date_from, date_to, price_per_night, label
- Build update object from allowed fields, mapping camelCase body keys to snake_case DB columns
- Update where id=id AND property_id=propertyId
- If EXCLUDE constraint error → 409 overlap message
- Return { pricing: data }

DELETE: Remove pricing override.

- Body: { id, propertyId }
- Delete where id=id AND property_id=propertyId
- Return { success: true }

All routes: import from '@/lib/supabase-admin' and '@/lib/accommodations/helpers'. Use `export const dynamic = 'force-dynamic'`.
</action>
<verify>
Check that all files exist and export the correct HTTP methods:

- grep "export async function GET" apps/backoffice/app/api/accommodations/calendar/route.ts
- grep "export async function POST\|DELETE" apps/backoffice/app/api/accommodations/room-blocks/route.ts
- grep "export async function GET\|POST\|PUT\|DELETE" apps/backoffice/app/api/accommodations/seasonal-pricing/route.ts
  </verify>
  <done>Three API routes created. Calendar returns merged data. Room blocks has booking overlap check. Seasonal pricing has full CRUD with EXCLUDE constraint error handling.</done>
  </task>

<task type="auto">
  <name>Task 3: Add discount fields to property PUT allowlist</name>
  <files>apps/backoffice/app/api/accommodations/property/route.ts</files>
  <action>
Update the existing property PUT route to accept discount fields:

1. Open apps/backoffice/app/api/accommodations/property/route.ts
2. Find the `allowedFields` array in the PUT function
3. Add two new entries: 'weekly_discount_percent' and 'monthly_discount_percent'
4. Also add these two columns to the GET select string so the calendar page can read current values

This is a minimal change — just add to the existing allowlist array and select string.
</action>
<verify>grep "weekly_discount_percent" apps/backoffice/app/api/accommodations/property/route.ts should match in both GET select and PUT allowedFields.</verify>
<done>Property API accepts weekly_discount_percent and monthly_discount_percent in both GET and PUT.</done>
</task>

</tasks>

<verification>
1. Migration 085 SQL file exists with both CREATE TABLE statements, EXCLUDE constraints, indexes, and RLS
2. Calendar GET endpoint fetches bookings + blocks + pricing in parallel
3. Room blocks POST validates no overlap with active bookings before insert
4. Seasonal pricing CRUD handles EXCLUDE constraint errors as 409
5. Property PUT allowlist includes discount fields
6. TypeScript compilation: run `npx tsc --noEmit -p apps/backoffice/tsconfig.json` (should pass or show only pre-existing errors)
</verification>

<success_criteria>
All 5 API endpoints work correctly (3 new route files + 1 updated). Migration SQL is syntactically valid. The UI plan (22-02) can immediately consume these APIs.
</success_criteria>

<output>
After completion, create `.planning/phases/22-owner-dashboard-calendar-pricing/22-01-SUMMARY.md`
</output>
